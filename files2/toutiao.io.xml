<?xml version="1.0" encoding="UTF-8"?>
        <rss version="2.0" xmlns:content="http://purl.org/rss/1.0/modules/content/">
            <channel>
            <title>开发者头条</title>
            <link>http://toutiao.io/</link>
            <description></description>
<item>
<guid>1b241b77409b0f9aad775cb49326e1ad</guid>
<title>2022 年来了！抓紧啦！</title>
<link>https://toutiao.io/k/rf8ezjy</link>
<content:encoded>&lt;div&gt;&lt;div&gt;&lt;div class=&quot;weui-dialog&quot;&gt;
      &lt;p class=&quot;weui-dialog__hd&quot;&gt;&lt;strong class=&quot;weui-dialog__title&quot;&gt;&quot;Top Stories&quot; is disabled&lt;/strong&gt;&lt;/p&gt;
      &lt;p class=&quot;weui-dialog__bd&quot;&gt;
        Enable &quot;Top Stories&quot; in &quot;Settings&quot; &amp;gt; &quot;General&quot; &amp;gt; &quot;Manage Discover&quot;      &lt;/p&gt;
      
    &lt;/div&gt;
  &lt;/div&gt;&lt;/div&gt;</content:encoded>
</item>
<item>
<guid>630bd5e55f475d7d879de02cef77a52d</guid>
<title>GitHub 打钱了，10 万美元！</title>
<link>https://toutiao.io/k/ndfqyy2</link>
<content:encoded>&lt;div&gt;&lt;div&gt;&lt;div class=&quot;rich_media_content &quot; id=&quot;js_content&quot;&gt;
                    

                    
                    
                    
                    &lt;section data-mpa-powered-by=&quot;yiban.io&quot;&gt;&lt;strong&gt;&lt;span&gt;点击&lt;strong&gt;&lt;span&gt;关注&lt;/span&gt;&lt;/strong&gt;公众号，&lt;span&gt;回复“&lt;/span&gt;&lt;/span&gt;&lt;/strong&gt;&lt;span&gt;&lt;strong&gt;&lt;span&gt;2T&lt;/span&gt;&lt;/strong&gt;&lt;/span&gt;&lt;strong&gt;&lt;span&gt;”获取&lt;/span&gt;&lt;/strong&gt;&lt;span&gt;&lt;strong&gt;&lt;span&gt;2TB&lt;/span&gt;&lt;/strong&gt;&lt;/span&gt;&lt;strong&gt;&lt;span&gt;学习资源！&lt;/span&gt;&lt;/strong&gt;&lt;br/&gt;&lt;/section&gt;&lt;section class=&quot;mp_profile_iframe_wrp&quot;&gt;&lt;mpprofile class=&quot;js_uneditable custom_select_card mp_profile_iframe&quot; data-pluginname=&quot;mpprofile&quot; data-id=&quot;MzI2MTIzMzY3Mw==&quot; data-headimg=&quot;http://mmbiz.qpic.cn/mmbiz_png/9mQQWOf4KRLQqYEDy2Fy5k5UxiabD5mlSicsicQCZCiaHAkibbpfiatRnCg5DYCoLYzy1KsHJiba9pT8N6uV5qOrSI9hw/0?wx_fmt=png&quot; data-nickname=&quot;互联网架构师&quot; data-alias=&quot;app-jiagou&quot; data-signature=&quot;分享最有价值的互联网技术干货文章，AI、Python、Java、Android、iOS、前端、后端等，助力您成为有思想的全栈架构师，聊架构，聊职场、聊人生！打造最有价值的架构师圈子和社区，助力你的个人提升和发展～&quot; data-from=&quot;0&quot;/&gt;&lt;/section&gt;&lt;section&gt;&lt;section&gt;&lt;span&gt;互联网架构师后台回复 &lt;/span&gt;&lt;span&gt;&lt;strong&gt;2T &lt;/strong&gt;&lt;span&gt;有特别礼包&lt;/span&gt;&lt;/span&gt;&lt;/section&gt;&lt;p&gt;&lt;a target=&quot;_blank&quot; href=&quot;https://mp.weixin.qq.com/s?__biz=MzI2MTIzMzY3Mw==&amp;amp;mid=2247487508&amp;amp;idx=1&amp;amp;sn=78cf235aa9ba5f988c6922ca98f8bfd6&amp;amp;chksm=ea5cdd72dd2b54647cf55b4a73dcafa69fc7228205ad39ecc98fe57b39cdecb21c238c6d6cb6&amp;amp;scene=21&amp;amp;token=31912529&amp;amp;lang=zh_CN#wechat_redirect&quot; textvalue=&quot;编辑：机器之心（张倩，蛋酱）转自：calebporzio.com/i-just-hit-dollar-100000yr-on-github-sponsors-heres-how-i-did-it&quot; linktype=&quot;text&quot; imgurl=&quot;&quot; imgdata=&quot;null&quot; tab=&quot;innerlink&quot; data-linktype=&quot;2&quot;&gt;&lt;span&gt;编辑：机器之心（张倩，蛋酱）&lt;/span&gt;&lt;br/&gt;&lt;/a&gt;&lt;/p&gt;&lt;p&gt;&lt;a target=&quot;_blank&quot; href=&quot;https://mp.weixin.qq.com/s?__biz=MzI2MTIzMzY3Mw==&amp;amp;mid=2247487508&amp;amp;idx=1&amp;amp;sn=78cf235aa9ba5f988c6922ca98f8bfd6&amp;amp;chksm=ea5cdd72dd2b54647cf55b4a73dcafa69fc7228205ad39ecc98fe57b39cdecb21c238c6d6cb6&amp;amp;scene=21&amp;amp;token=31912529&amp;amp;lang=zh_CN#wechat_redirect&quot; textvalue=&quot;编辑：机器之心（张倩，蛋酱）转自：calebporzio.com/i-just-hit-dollar-100000yr-on-github-sponsors-heres-how-i-did-it&quot; linktype=&quot;text&quot; imgurl=&quot;&quot; imgdata=&quot;null&quot; tab=&quot;innerlink&quot; data-linktype=&quot;2&quot;&gt;&lt;span&gt;转自：calebporzio.com/i-just-hit-dollar-100000yr-on-github-sponsors-heres-how-i-did-it&lt;/span&gt;&lt;/a&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;上一篇：&lt;a target=&quot;_blank&quot; href=&quot;http://mp.weixin.qq.com/s?__biz=MzI2MTIzMzY3Mw==&amp;amp;mid=2247517071&amp;amp;idx=1&amp;amp;sn=304e7524c4beae51d5643a14e0ddd45b&amp;amp;chksm=ea5f4ee9dd28c7ff33b61d194a84bf76ee13a72714965865153846c91b7d78efc12509315b20&amp;amp;scene=21#wechat_redirect&quot; textvalue=&quot;“阿里味” PUA 编程语言火上GitHub热榜，标星1.9K！&quot; linktype=&quot;text&quot; imgurl=&quot;&quot; imgdata=&quot;null&quot; data-itemshowtype=&quot;0&quot; tab=&quot;innerlink&quot; data-linktype=&quot;2&quot;&gt;“阿里味” PUA 编程语言火上GitHub热榜，标星1.9K！&lt;/a&gt;&lt;/span&gt;&lt;/p&gt;&lt;/section&gt;&lt;p&gt;&lt;span&gt;如何在GitHub 靠打赏谋生？可以看一下这位外国程序员是怎么做到的。&lt;br/&gt;&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;如果提到靠打赏生活的人，我们首先想到的会是主播。但现实情况是，程序员也可以。这位活成主播的程序员名叫 Caleb Porzio。&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;/p&gt;&lt;p&gt;&lt;a target=&quot;_blank&quot; href=&quot;https://mp.weixin.qq.com/s?__biz=MzI2MTIzMzY3Mw==&amp;amp;mid=2247487508&amp;amp;idx=1&amp;amp;sn=78cf235aa9ba5f988c6922ca98f8bfd6&amp;amp;chksm=ea5cdd72dd2b54647cf55b4a73dcafa69fc7228205ad39ecc98fe57b39cdecb21c238c6d6cb6&amp;amp;scene=21&amp;amp;token=31912529&amp;amp;lang=zh_CN#wechat_redirect&quot; textvalue=&quot;在过去的一年里，他靠 GitHub 项目的打赏赚到了 10 万美元。在他的自述文章中，他分享了自己靠 GitHub 项目赚钱的经历和技巧。&quot; linktype=&quot;text&quot; imgurl=&quot;&quot; imgdata=&quot;null&quot; tab=&quot;innerlink&quot; data-linktype=&quot;2&quot;&gt;&lt;span&gt;在过去的一年里，他靠 GitHub 项目的打赏赚到了 10 万美元。在他的自述文章中，他分享了自己靠 GitHub 项目赚钱的经历和技巧。&lt;/span&gt;&lt;/a&gt;&lt;span/&gt;&lt;/p&gt;&lt;p&gt;&lt;/p&gt;&lt;p&gt;&lt;img class=&quot;rich_pages wxw-img&quot; data-backh=&quot;506&quot; data-backw=&quot;578&quot; data-croporisrc=&quot;https://mmbiz.qpic.cn/mmbiz_png/R5ic1icyNBNd5ZHvVAd1xEv21Ox2tulFYtTTqWZiaya3enbL3g5G23fow6QBGLCsQQfdmQOXbrRibb0pvic7Pbg5J2A/640?wx_fmt=png&quot; data-cropx1=&quot;0&quot; data-cropx2=&quot;628&quot; data-cropy1=&quot;0&quot; data-cropy2=&quot;511.7439446366782&quot; data-galleryid=&quot;&quot; data-ratio=&quot;0.8136942675159236&quot; data-s=&quot;300,640&quot; data-src=&quot;https://mmbiz.qpic.cn/mmbiz_jpg/9mQQWOf4KRJ6GPIhGWymh60Da3mrbWWKJW8CibVCfnh4XXr1iaGK0hvbNIBsCJl5wGwwb7ZYrJYibcuSEuT53zb8Q/640?wx_fmt=jpeg&quot; data-type=&quot;jpeg&quot; data-w=&quot;628&quot;/&gt;&lt;/p&gt;&lt;p&gt;&lt;/p&gt;&lt;section&gt;&lt;span&gt;Caleb Porzio 发推庆祝自己靠 GitHub 打赏（GitHub Sponsors）赚到了 10 万美元。&lt;/span&gt;&lt;/section&gt;&lt;section&gt;&lt;br/&gt;&lt;/section&gt;&lt;section&gt;&lt;a target=&quot;_blank&quot; href=&quot;https://mp.weixin.qq.com/s?__biz=MzI2MTIzMzY3Mw==&amp;amp;mid=2247487508&amp;amp;idx=1&amp;amp;sn=78cf235aa9ba5f988c6922ca98f8bfd6&amp;amp;chksm=ea5cdd72dd2b54647cf55b4a73dcafa69fc7228205ad39ecc98fe57b39cdecb21c238c6d6cb6&amp;amp;scene=21&amp;amp;token=31912529&amp;amp;lang=zh_CN#wechat_redirect&quot; textvalue=&quot;GitHub Sponsors 是 GitHub 2019 年 5 月份推出的一个功能，允许开发者通过自己的项目获取报酬/赞赏。&quot; linktype=&quot;text&quot; imgurl=&quot;&quot; imgdata=&quot;null&quot; tab=&quot;innerlink&quot; data-linktype=&quot;2&quot;&gt;&lt;span&gt;GitHub Sponsors 是 GitHub 2019 年 5 月份推出的一个功能，允许开发者通过自己的项目获取报酬/赞赏。&lt;/span&gt;&lt;/a&gt;&lt;span/&gt;&lt;/section&gt;&lt;section&gt;&lt;br/&gt;&lt;/section&gt;&lt;section&gt;&lt;span&gt;全职开发转自由职业，是怎样一种体验？以下是 Caleb 的故事。&lt;/span&gt;&lt;span/&gt;&lt;/section&gt;&lt;p&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;&lt;strong&gt;&lt;span&gt;我要分享一下自己走上自由职业的经历。&lt;/span&gt;&lt;/strong&gt;&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;2018 年是我做全职开发的最后一年，当时我的年收入大概是 9 万美元。&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;/p&gt;&lt;p&gt;&lt;img class=&quot;rich_pages wxw-img&quot; data-croporisrc=&quot;https://mmbiz.qpic.cn/mmbiz_png/R5ic1icyNBNd5ZHvVAd1xEv21Ox2tulFYtsjG3oh64ic1EvuNAzvf88FuVo5kpQGpSpvGXiayCBZcrJC5qXwUU1JlA/640?wx_fmt=png&quot; data-cropx1=&quot;0&quot; data-cropx2=&quot;898&quot; data-cropy1=&quot;0&quot; data-cropy2=&quot;229.4741506646972&quot; data-galleryid=&quot;&quot; data-ratio=&quot;0.25501113585746105&quot; data-s=&quot;300,640&quot; data-src=&quot;https://mmbiz.qpic.cn/mmbiz_jpg/9mQQWOf4KRJ6GPIhGWymh60Da3mrbWWKyqktjgJuvZtryItnFbTLyLNIB0FQlSPwoUbI1ZUibjYR7jZrasho4FQ/640?wx_fmt=jpeg&quot; data-type=&quot;jpeg&quot; data-w=&quot;898&quot;/&gt;&lt;/p&gt;&lt;p&gt;&lt;/p&gt;&lt;section&gt;&lt;span&gt;嗯，虽然说现在开发人员的薪资水平比较疯狂，但 9 万美元对我来说也是一笔可观的收入了。再加上我妻子的收入，以及「胡子主义」生活哲学的指导，我们可以省下很多的钱。&lt;/span&gt;&lt;/section&gt;&lt;section&gt;&lt;br/&gt;&lt;/section&gt;&lt;section&gt;&lt;a target=&quot;_blank&quot; href=&quot;https://mp.weixin.qq.com/s?__biz=MzI2MTIzMzY3Mw==&amp;amp;mid=2247487508&amp;amp;idx=1&amp;amp;sn=78cf235aa9ba5f988c6922ca98f8bfd6&amp;amp;chksm=ea5cdd72dd2b54647cf55b4a73dcafa69fc7228205ad39ecc98fe57b39cdecb21c238c6d6cb6&amp;amp;scene=21&amp;amp;token=31912529&amp;amp;lang=zh_CN#wechat_redirect&quot; textvalue=&quot;2019 年 1 月 11 日，我离开原来的公司开始「休假」，想要换种心情，做自己想做的一切。几个月后，我正式开始了自由职业者的生活。「休假」期间，我读到了这篇文章：《Phoenix LiveView: Interactive, Real-Time Apps. No Need to Write JavaScript》，并从中受到启发。我发现自己也可以做出类似的成果。&quot; linktype=&quot;text&quot; imgurl=&quot;&quot; imgdata=&quot;null&quot; tab=&quot;innerlink&quot; data-linktype=&quot;2&quot;&gt;&lt;span&gt;2019 年 1 月 11 日，我离开原来的公司开始「休假」，想要换种心情，做自己想做的一切。几个月后，我正式开始了自由职业者的生活。&lt;/span&gt;&lt;/a&gt;&lt;/section&gt;&lt;section&gt;&lt;br/&gt;&lt;/section&gt;&lt;section&gt;&lt;a target=&quot;_blank&quot; href=&quot;https://mp.weixin.qq.com/s?__biz=MzI2MTIzMzY3Mw==&amp;amp;mid=2247487508&amp;amp;idx=1&amp;amp;sn=78cf235aa9ba5f988c6922ca98f8bfd6&amp;amp;chksm=ea5cdd72dd2b54647cf55b4a73dcafa69fc7228205ad39ecc98fe57b39cdecb21c238c6d6cb6&amp;amp;scene=21&amp;amp;token=31912529&amp;amp;lang=zh_CN#wechat_redirect&quot; textvalue=&quot;2019 年 1 月 11 日，我离开原来的公司开始「休假」，想要换种心情，做自己想做的一切。几个月后，我正式开始了自由职业者的生活。「休假」期间，我读到了这篇文章：《Phoenix LiveView: Interactive, Real-Time Apps. No Need to Write JavaScript》，并从中受到启发。我发现自己也可以做出类似的成果。&quot; linktype=&quot;text&quot; imgurl=&quot;&quot; imgdata=&quot;null&quot; tab=&quot;innerlink&quot; data-linktype=&quot;2&quot;&gt;&lt;span&gt;「休假」期间，我读到了这篇文章：《Phoenix LiveView: Interactive, Real-Time Apps. No Need to Write JavaScript》，并从中受到启发。我发现自己也可以做出类似的成果。&lt;/span&gt;&lt;/a&gt;&lt;/section&gt;&lt;section&gt;&lt;br/&gt;&lt;/section&gt;&lt;p&gt;&lt;span&gt;当时我还发了一条推特：&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;img class=&quot;rich_pages wxw-img&quot; data-backh=&quot;544&quot; data-backw=&quot;578&quot; data-croporisrc=&quot;https://mmbiz.qpic.cn/mmbiz_png/R5ic1icyNBNd5ZHvVAd1xEv21Ox2tulFYt9PTZtdMz1b2iaqR0SYRlo6vk0A0zeQu53gax7pqjrR48H1TzzMbY5icQ/640?wx_fmt=png&quot; data-cropx1=&quot;0&quot; data-cropx2=&quot;1080&quot; data-cropy1=&quot;0&quot; data-cropy2=&quot;937.7678571428572&quot; data-galleryid=&quot;&quot; data-ratio=&quot;0.8685185185185185&quot; data-s=&quot;300,640&quot; data-src=&quot;https://mmbiz.qpic.cn/mmbiz_jpg/9mQQWOf4KRJ6GPIhGWymh60Da3mrbWWKeESGdiceVic44DoYazUdsDMibeMw4fIvHcUjXa8xxrfW8lnGUZYslm0xg/640?wx_fmt=jpeg&quot; data-type=&quot;jpeg&quot; data-w=&quot;1080&quot;/&gt;&lt;/p&gt;&lt;p&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;「决定开发一个类似 Laravel 的东西。我感觉这可能是个重大改变。」&lt;/span&gt;&lt;/p&gt;&lt;section&gt;&lt;br/&gt;&lt;/section&gt;&lt;section&gt;&lt;span&gt;现在看来，这确实改变了我的生活。&lt;/span&gt;&lt;/section&gt;&lt;section&gt;&lt;br/&gt;&lt;/section&gt;&lt;section&gt;&lt;a target=&quot;_blank&quot; href=&quot;https://mp.weixin.qq.com/s?__biz=MzI2MTIzMzY3Mw==&amp;amp;mid=2247487508&amp;amp;idx=1&amp;amp;sn=78cf235aa9ba5f988c6922ca98f8bfd6&amp;amp;chksm=ea5cdd72dd2b54647cf55b4a73dcafa69fc7228205ad39ecc98fe57b39cdecb21c238c6d6cb6&amp;amp;scene=21&amp;amp;token=31912529&amp;amp;lang=zh_CN#wechat_redirect&quot; textvalue=&quot;也是在这一天，我的「休假期」结束了。我完全被这个后来叫做 Livewire 的项目迷住了，并开始全身心地投入于此，这种沉迷一直持续到现在。我也创建了一个非常流行的 JS 框架，叫做 AlpineJS，目前也是由我在管理和维护。但那是另外一个故事了……做开源软件不能完全养活自己，所以我也接过一些小型的代码指导方面的需求，让 2019 全年的收入维持在一个稳定的状态。&quot; linktype=&quot;text&quot; imgurl=&quot;&quot; imgdata=&quot;null&quot; tab=&quot;innerlink&quot; data-linktype=&quot;2&quot;&gt;&lt;span&gt;也是在这一天，我的「休假期」结束了。我完全被这个后来叫做 Livewire 的项目迷住了，并开始全身心地投入于此，这种沉迷一直持续到现在。&lt;/span&gt;&lt;/a&gt;&lt;/section&gt;&lt;section&gt;&lt;br/&gt;&lt;/section&gt;&lt;section&gt;&lt;a target=&quot;_blank&quot; href=&quot;https://mp.weixin.qq.com/s?__biz=MzI2MTIzMzY3Mw==&amp;amp;mid=2247487508&amp;amp;idx=1&amp;amp;sn=78cf235aa9ba5f988c6922ca98f8bfd6&amp;amp;chksm=ea5cdd72dd2b54647cf55b4a73dcafa69fc7228205ad39ecc98fe57b39cdecb21c238c6d6cb6&amp;amp;scene=21&amp;amp;token=31912529&amp;amp;lang=zh_CN#wechat_redirect&quot; textvalue=&quot;也是在这一天，我的「休假期」结束了。我完全被这个后来叫做 Livewire 的项目迷住了，并开始全身心地投入于此，这种沉迷一直持续到现在。我也创建了一个非常流行的 JS 框架，叫做 AlpineJS，目前也是由我在管理和维护。但那是另外一个故事了……做开源软件不能完全养活自己，所以我也接过一些小型的代码指导方面的需求，让 2019 全年的收入维持在一个稳定的状态。&quot; linktype=&quot;text&quot; imgurl=&quot;&quot; imgdata=&quot;null&quot; tab=&quot;innerlink&quot; data-linktype=&quot;2&quot;&gt;&lt;span&gt;我也创建了一个非常流行的 JS 框架，叫做 AlpineJS，目前也是由我在管理和维护。但那是另外一个故事了……&lt;/span&gt;&lt;/a&gt;&lt;a target=&quot;_blank&quot; href=&quot;http://mp.weixin.qq.com/s?__biz=MzI2MTIzMzY3Mw==&amp;amp;mid=2247487508&amp;amp;idx=1&amp;amp;sn=78cf235aa9ba5f988c6922ca98f8bfd6&amp;amp;chksm=ea5cdd72dd2b54647cf55b4a73dcafa69fc7228205ad39ecc98fe57b39cdecb21c238c6d6cb6&amp;amp;scene=21#wechat_redirect&quot; textvalue=&quot;card类似于Threadcard余额属性，卡号属性等类似于Treadlocal内部属性集合threadLocalscardManager类似于ThreadLocal管理类&quot; linktype=&quot;text&quot; imgurl=&quot;&quot; imgdata=&quot;null&quot; data-itemshowtype=&quot;0&quot; tab=&quot;innerlink&quot; data-linktype=&quot;2&quot; wah-hotarea=&quot;click&quot; hasload=&quot;1&quot;&gt;&lt;span&gt;搜索公众号互联网架构师回复“2T”，送你一份惊喜礼包。&lt;/span&gt;&lt;/a&gt;&lt;/section&gt;&lt;section&gt;&lt;br/&gt;&lt;/section&gt;&lt;section&gt;&lt;a target=&quot;_blank&quot; href=&quot;https://mp.weixin.qq.com/s?__biz=MzI2MTIzMzY3Mw==&amp;amp;mid=2247487508&amp;amp;idx=1&amp;amp;sn=78cf235aa9ba5f988c6922ca98f8bfd6&amp;amp;chksm=ea5cdd72dd2b54647cf55b4a73dcafa69fc7228205ad39ecc98fe57b39cdecb21c238c6d6cb6&amp;amp;scene=21&amp;amp;token=31912529&amp;amp;lang=zh_CN#wechat_redirect&quot; textvalue=&quot;也是在这一天，我的「休假期」结束了。我完全被这个后来叫做 Livewire 的项目迷住了，并开始全身心地投入于此，这种沉迷一直持续到现在。我也创建了一个非常流行的 JS 框架，叫做 AlpineJS，目前也是由我在管理和维护。但那是另外一个故事了……做开源软件不能完全养活自己，所以我也接过一些小型的代码指导方面的需求，让 2019 全年的收入维持在一个稳定的状态。&quot; linktype=&quot;text&quot; imgurl=&quot;&quot; imgdata=&quot;null&quot; tab=&quot;innerlink&quot; data-linktype=&quot;2&quot;&gt;&lt;span&gt;做开源软件不能完全养活自己，所以我也接过一些小型的代码指导方面的需求，让 2019 全年的收入维持在一个稳定的状态。&lt;/span&gt;&lt;/a&gt;&lt;span/&gt;&lt;/section&gt;&lt;section&gt;&lt;br/&gt;&lt;/section&gt;&lt;section&gt;&lt;span&gt;这张图是我 2019 年通过自由职业方式获得的收入：&lt;/span&gt;&lt;/section&gt;&lt;p&gt;&lt;/p&gt;&lt;p&gt;&lt;img class=&quot;rich_pages wxw-img&quot; data-backh=&quot;151&quot; data-backw=&quot;578&quot; data-croporisrc=&quot;https://mmbiz.qpic.cn/mmbiz_png/R5ic1icyNBNd5ZHvVAd1xEv21Ox2tulFYtQ4ibESlyO79o7zSt46fLjt10zx2mp9icxgtIib5t9DZbQ5M7JR4g6IYHg/640?wx_fmt=png&quot; data-cropx1=&quot;0&quot; data-cropx2=&quot;1080&quot; data-cropy1=&quot;0&quot; data-cropy2=&quot;222.35294117647058&quot; data-galleryid=&quot;&quot; data-ratio=&quot;0.20555555555555555&quot; data-s=&quot;300,640&quot; data-src=&quot;https://mmbiz.qpic.cn/mmbiz_jpg/9mQQWOf4KRJ6GPIhGWymh60Da3mrbWWKPfbsEWxjzpyMEsnXEJa8rs8ovZnWRmzfWXib0PBbLD9UUqRdDlddEEA/640?wx_fmt=jpeg&quot; data-type=&quot;jpeg&quot; data-w=&quot;1080&quot;/&gt;&lt;/p&gt;&lt;p&gt;&lt;/p&gt;&lt;section&gt;&lt;a target=&quot;_blank&quot; href=&quot;https://mp.weixin.qq.com/s?__biz=MzI2MTIzMzY3Mw==&amp;amp;mid=2247487508&amp;amp;idx=1&amp;amp;sn=78cf235aa9ba5f988c6922ca98f8bfd6&amp;amp;chksm=ea5cdd72dd2b54647cf55b4a73dcafa69fc7228205ad39ecc98fe57b39cdecb21c238c6d6cb6&amp;amp;scene=21&amp;amp;token=31912529&amp;amp;lang=zh_CN#wechat_redirect&quot; textvalue=&quot;我的收入减少了 7 万美元，看起来是比较冒险的举动。但我知道，如果此刻不开始做这件事，以后可能就更没有机会了。一路走来，有很多好心人联系我，询问他们是否能够提供项目上的帮助。比如这种：&quot; linktype=&quot;text&quot; imgurl=&quot;&quot; imgdata=&quot;null&quot; tab=&quot;innerlink&quot; data-linktype=&quot;2&quot;&gt;&lt;span&gt;我的收入减少了 7 万美元，看起来是比较冒险的举动。但我知道，如果此刻不开始做这件事，以后可能就更没有机会了。&lt;/span&gt;&lt;/a&gt;&lt;/section&gt;&lt;section&gt;&lt;br/&gt;&lt;/section&gt;&lt;section&gt;&lt;a target=&quot;_blank&quot; href=&quot;https://mp.weixin.qq.com/s?__biz=MzI2MTIzMzY3Mw==&amp;amp;mid=2247487508&amp;amp;idx=1&amp;amp;sn=78cf235aa9ba5f988c6922ca98f8bfd6&amp;amp;chksm=ea5cdd72dd2b54647cf55b4a73dcafa69fc7228205ad39ecc98fe57b39cdecb21c238c6d6cb6&amp;amp;scene=21&amp;amp;token=31912529&amp;amp;lang=zh_CN#wechat_redirect&quot; textvalue=&quot;我的收入减少了 7 万美元，看起来是比较冒险的举动。但我知道，如果此刻不开始做这件事，以后可能就更没有机会了。一路走来，有很多好心人联系我，询问他们是否能够提供项目上的帮助。比如这种：&quot; linktype=&quot;text&quot; imgurl=&quot;&quot; imgdata=&quot;null&quot; tab=&quot;innerlink&quot; data-linktype=&quot;2&quot;&gt;&lt;span&gt;一路走来，有很多好心人联系我，询问他们是否能够提供项目上的帮助。比如这种：&lt;/span&gt;&lt;/a&gt;&lt;/section&gt;&lt;p&gt;&lt;img class=&quot;rich_pages wxw-img&quot; data-ratio=&quot;0.13841059602649006&quot; data-src=&quot;https://mmbiz.qpic.cn/mmbiz_png/9mQQWOf4KRJ6GPIhGWymh60Da3mrbWWKOzPJDfs32PH0aOshtMQObZLlDpVBj1GOhhr8GGUUwKjRWw060jlqCw/640?wx_fmt=png&quot; data-type=&quot;png&quot; data-w=&quot;3020&quot;/&gt;&lt;/p&gt;&lt;p&gt;&lt;/p&gt;&lt;section&gt;&lt;span&gt;很长一段时间我没有更新 Patreon（一个众筹创作网站），那里会有一些人每个月给我五美元。如此也很好，但对我来说没有意义。&lt;/span&gt;&lt;/section&gt;&lt;section&gt;&lt;br/&gt;&lt;/section&gt;&lt;section&gt;&lt;a target=&quot;_blank&quot; href=&quot;https://mp.weixin.qq.com/s?__biz=MzI2MTIzMzY3Mw==&amp;amp;mid=2247487508&amp;amp;idx=1&amp;amp;sn=78cf235aa9ba5f988c6922ca98f8bfd6&amp;amp;chksm=ea5cdd72dd2b54647cf55b4a73dcafa69fc7228205ad39ecc98fe57b39cdecb21c238c6d6cb6&amp;amp;scene=21&amp;amp;token=31912529&amp;amp;lang=zh_CN#wechat_redirect&quot; textvalue=&quot;然后，我发现了 GitHub 的打赏功能，把项目直接托管在 GitHub 上即可。2019 年 12 月 12 日，我成为了 GitHub Sponsors 的一员。&quot; linktype=&quot;text&quot; imgurl=&quot;&quot; imgdata=&quot;null&quot; tab=&quot;innerlink&quot; data-linktype=&quot;2&quot;&gt;&lt;span&gt;然后，我发现了 GitHub 的打赏功能，把项目直接托管在 GitHub 上即可。2019 年 12 月 12 日，我成为了 GitHub Sponsors 的一员。&lt;/span&gt;&lt;/a&gt;&lt;/section&gt;&lt;section&gt;&lt;img class=&quot;rich_pages wxw-img&quot; data-croporisrc=&quot;https://mmbiz.qpic.cn/mmbiz_png/R5ic1icyNBNd5ZHvVAd1xEv21Ox2tulFYt1hGibV8GGlomAOx2sSpiazFk1vgb6uT3S0YicqKcib7QOB2icu9ZSUfJ3YA/640?wx_fmt=png&quot; data-cropx1=&quot;0&quot; data-cropx2=&quot;816&quot; data-cropy1=&quot;0&quot; data-cropy2=&quot;221.77843426883308&quot; data-galleryid=&quot;&quot; data-ratio=&quot;0.27205882352941174&quot; data-s=&quot;300,640&quot; data-src=&quot;https://mmbiz.qpic.cn/mmbiz_jpg/9mQQWOf4KRJ6GPIhGWymh60Da3mrbWWKW0eQnk0jECB1UXicGUZZPRBS1ChClLpaBeupMqIZ0Wrs1wJRXjH9VDg/640?wx_fmt=jpeg&quot; data-type=&quot;jpeg&quot; data-w=&quot;816&quot;/&gt;&lt;/section&gt;&lt;p&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;这是我的第一个打赏者，Brian，谢谢你！&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;迄今为止，我已经从 GitHub sponsors 那里收到了 2.5 万美元打赏金。&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;/p&gt;&lt;p&gt;&lt;img class=&quot;rich_pages wxw-img&quot; data-backh=&quot;227&quot; data-backw=&quot;578&quot; data-galleryid=&quot;&quot; data-ratio=&quot;0.39296875&quot; data-s=&quot;300,640&quot; data-src=&quot;https://mmbiz.qpic.cn/mmbiz_png/X59zibowibQMV6vZYWE55X6kCLDFMYaUxhFCd0uL6lXgprM9LVufNrnFI3nxpGAv9Uft94776crPLkQTlr8rRzNQ/640?wx_fmt=png&quot; data-type=&quot;png&quot; data-w=&quot;1280&quot;/&gt;&lt;/p&gt;&lt;p&gt;&lt;/p&gt;&lt;p&gt;&lt;a target=&quot;_blank&quot; href=&quot;https://mp.weixin.qq.com/s?__biz=MzI2MTIzMzY3Mw==&amp;amp;mid=2247487508&amp;amp;idx=1&amp;amp;sn=78cf235aa9ba5f988c6922ca98f8bfd6&amp;amp;chksm=ea5cdd72dd2b54647cf55b4a73dcafa69fc7228205ad39ecc98fe57b39cdecb21c238c6d6cb6&amp;amp;scene=21&amp;amp;token=31912529&amp;amp;lang=zh_CN#wechat_redirect&quot; textvalue=&quot;直到撰写本文时，我的 GitHub 年度打赏金额已经达到了 112680 美元。&quot; linktype=&quot;text&quot; imgurl=&quot;&quot; imgdata=&quot;null&quot; tab=&quot;innerlink&quot; data-linktype=&quot;2&quot;&gt;&lt;span&gt;直到撰写本文时，我的 GitHub 年度打赏金额已经达到了 112680 美元。&lt;/span&gt;&lt;/a&gt;&lt;/p&gt;&lt;p&gt;&lt;/p&gt;&lt;p&gt;&lt;img class=&quot;rich_pages wxw-img&quot; data-galleryid=&quot;&quot; data-ratio=&quot;0.5125&quot; data-s=&quot;300,640&quot; data-src=&quot;https://mmbiz.qpic.cn/mmbiz_png/ZBOhibcRX4vFdUxBhkHGCq07octZob7yUgOsGtonqpxJOO0qias8LeEZrRZHKibIqoxibUFFwu2Lg9GZXOyB9DWs3Q/640?wx_fmt=png&quot; data-type=&quot;png&quot; data-w=&quot;1280&quot;/&gt;&lt;/p&gt;&lt;p&gt;&lt;/p&gt;&lt;section&gt;&lt;span&gt;是运气，还是实力？我有点不敢相信我在开源社区里做开源软件，赚的钱比以往任何时候都多。&lt;a target=&quot;_blank&quot; href=&quot;http://mp.weixin.qq.com/s?__biz=MzI2MTIzMzY3Mw==&amp;amp;mid=2247487508&amp;amp;idx=1&amp;amp;sn=78cf235aa9ba5f988c6922ca98f8bfd6&amp;amp;chksm=ea5cdd72dd2b54647cf55b4a73dcafa69fc7228205ad39ecc98fe57b39cdecb21c238c6d6cb6&amp;amp;scene=21#wechat_redirect&quot; textvalue=&quot;card类似于Threadcard余额属性，卡号属性等类似于Treadlocal内部属性集合threadLocalscardManager类似于ThreadLocal管理类&quot; linktype=&quot;text&quot; imgurl=&quot;&quot; imgdata=&quot;null&quot; data-itemshowtype=&quot;0&quot; tab=&quot;innerlink&quot; data-linktype=&quot;2&quot; wah-hotarea=&quot;click&quot; hasload=&quot;1&quot;&gt;&lt;span&gt;搜索公众号互联网架构师回复“2T”，送你一份惊喜礼包。&lt;/span&gt;&lt;/a&gt;&lt;/span&gt;&lt;/section&gt;&lt;section&gt;&lt;br/&gt;&lt;/section&gt;&lt;section&gt;&lt;span&gt;掐我一下，我是在做梦吗？&lt;/span&gt;&lt;/section&gt;&lt;section&gt;&lt;br/&gt;&lt;/section&gt;&lt;section&gt;&lt;a target=&quot;_blank&quot; href=&quot;https://mp.weixin.qq.com/s?__biz=MzI2MTIzMzY3Mw==&amp;amp;mid=2247487508&amp;amp;idx=1&amp;amp;sn=78cf235aa9ba5f988c6922ca98f8bfd6&amp;amp;chksm=ea5cdd72dd2b54647cf55b4a73dcafa69fc7228205ad39ecc98fe57b39cdecb21c238c6d6cb6&amp;amp;scene=21&amp;amp;token=31912529&amp;amp;lang=zh_CN#wechat_redirect&quot; textvalue=&quot;是因为我开发的软件太过优秀？让 535 位开发者每个月都打赏我 14 美元。不管怎么说，继续努力吧！&quot; linktype=&quot;text&quot; imgurl=&quot;&quot; imgdata=&quot;null&quot; tab=&quot;innerlink&quot; data-linktype=&quot;2&quot;&gt;&lt;span&gt;是因为我开发的软件太过优秀？让 535 位开发者每个月都打赏我 14 美元。不管怎么说，继续努力吧！&lt;/span&gt;&lt;/a&gt;&lt;/section&gt;&lt;section&gt;&lt;br/&gt;&lt;/section&gt;&lt;section&gt;&lt;span&gt;接下来，我想分享一些过程中的经验，希望能帮到也想从事类似开发工作的人们。&lt;/span&gt;&lt;/section&gt;&lt;p&gt;&lt;/p&gt;&lt;section&gt;&lt;span&gt;&lt;strong&gt;&lt;span&gt;通过 GitHub 打赏赚钱的三个阶段&lt;/span&gt;&lt;/strong&gt;&lt;/span&gt;&lt;/section&gt;&lt;p&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;阶段 1：热心人士&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;/p&gt;&lt;section&gt;&lt;span&gt;最初，GitHub Sponsors 是一个让忠实粉丝能够资助他们所支持项目的平台。这些人的数量，和真正使用软件以及从中赚钱的人数比起来，并不算多。&lt;/span&gt;&lt;/section&gt;&lt;section&gt;&lt;br/&gt;&lt;/section&gt;&lt;section&gt;&lt;span&gt;基于开源的前提，人们本来就可以免费获得该软件。所有收入完全是来自那些友善热心肠的人们。&lt;/span&gt;&lt;/section&gt;&lt;p&gt;&lt;/p&gt;&lt;p&gt;&lt;img class=&quot;rich_pages wxw-img&quot; data-backh=&quot;353&quot; data-backw=&quot;578&quot; data-galleryid=&quot;&quot; data-ratio=&quot;0.61015625&quot; data-s=&quot;300,640&quot; data-src=&quot;https://mmbiz.qpic.cn/mmbiz_png/sON8N5Pc3iciaNyI2VNQUJGG4E38KUJvtBeCodozKxaUH5q5ibu5f3WEl8ia5CRcXsjI73s2naPWfAAGic99JrUMcDQ/640?wx_fmt=png&quot; data-type=&quot;png&quot; data-w=&quot;1280&quot;/&gt;&lt;/p&gt;&lt;p&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;首先，非常感谢这些人。然后我们谈谈第一个高峰是怎么到来的。&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;阶段 2：打赏软件&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;这个阶段，事情开始变得奇妙。&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;/p&gt;&lt;p&gt;&lt;img class=&quot;rich_pages wxw-img&quot; data-backh=&quot;484&quot; data-backw=&quot;578&quot; data-galleryid=&quot;&quot; data-ratio=&quot;0.8366666666666667&quot; data-s=&quot;300,640&quot; data-src=&quot;https://mmbiz.qpic.cn/mmbiz_png/iaQ9QPYlsFiaUCVQWO2AYR7yXMngDH4epbO3ujqicVhDRsTmW5l6uwEmdntyD6vIsJjDaQIp6QJibulMOTv7yP4OBA/640?wx_fmt=png&quot; data-type=&quot;png&quot; data-w=&quot;1200&quot;/&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;当时，我和我的兄弟 Daniel 录制了一期《No Plans To Merge》。在思考如何将其变现时，我们想到了一个新颖的想法：「打赏软件」。&lt;br/&gt;&lt;/span&gt;&lt;/p&gt;&lt;section&gt;&lt;br/&gt;&lt;/section&gt;&lt;section&gt;&lt;span&gt;它的工作方式如下：&lt;/span&gt;&lt;/section&gt;&lt;section&gt;&lt;br/&gt;&lt;/section&gt;&lt;ol class=&quot;list-paddingleft-2&quot;&gt;&lt;li&gt;&lt;section&gt;&lt;a target=&quot;_blank&quot; href=&quot;https://mp.weixin.qq.com/s?__biz=MzI2MTIzMzY3Mw==&amp;amp;mid=2247487508&amp;amp;idx=1&amp;amp;sn=78cf235aa9ba5f988c6922ca98f8bfd6&amp;amp;chksm=ea5cdd72dd2b54647cf55b4a73dcafa69fc7228205ad39ecc98fe57b39cdecb21c238c6d6cb6&amp;amp;scene=21&amp;amp;token=31912529&amp;amp;lang=zh_CN#wechat_redirect&quot; textvalue=&quot;创建一个很棒的软件；使其仅对打赏者开放，直到你积累了一定数量的打赏者；然后将项目开源给全世界。&quot; linktype=&quot;text&quot; imgurl=&quot;&quot; imgdata=&quot;null&quot; tab=&quot;innerlink&quot; data-linktype=&quot;2&quot;&gt;&lt;span&gt;创建一个很棒的软件；&lt;/span&gt;&lt;/a&gt;&lt;/section&gt;&lt;/li&gt;&lt;li&gt;&lt;section&gt;&lt;a target=&quot;_blank&quot; href=&quot;http://mp.weixin.qq.com/s?__biz=MzI2MTIzMzY3Mw==&amp;amp;mid=2247487508&amp;amp;idx=1&amp;amp;sn=78cf235aa9ba5f988c6922ca98f8bfd6&amp;amp;chksm=ea5cdd72dd2b54647cf55b4a73dcafa69fc7228205ad39ecc98fe57b39cdecb21c238c6d6cb6&amp;amp;scene=21#wechat_redirect&quot; textvalue=&quot;card类似于Threadcard余额属性，卡号属性等类似于Treadlocal内部属性集合threadLocalscardManager类似于ThreadLocal管理类&quot; linktype=&quot;text&quot; imgurl=&quot;&quot; imgdata=&quot;null&quot; data-itemshowtype=&quot;0&quot; tab=&quot;innerlink&quot; data-linktype=&quot;2&quot; wah-hotarea=&quot;click&quot; hasload=&quot;1&quot;&gt;&lt;span&gt;搜索公众号互联网架构师回复“2T”，送你一份惊喜礼包。&lt;/span&gt;&lt;span/&gt;&lt;/a&gt;&lt;br/&gt;&lt;/section&gt;&lt;/li&gt;&lt;li&gt;&lt;section&gt;&lt;a target=&quot;_blank&quot; href=&quot;https://mp.weixin.qq.com/s?__biz=MzI2MTIzMzY3Mw==&amp;amp;mid=2247487508&amp;amp;idx=1&amp;amp;sn=78cf235aa9ba5f988c6922ca98f8bfd6&amp;amp;chksm=ea5cdd72dd2b54647cf55b4a73dcafa69fc7228205ad39ecc98fe57b39cdecb21c238c6d6cb6&amp;amp;scene=21&amp;amp;token=31912529&amp;amp;lang=zh_CN#wechat_redirect&quot; textvalue=&quot;创建一个很棒的软件；使其仅对打赏者开放，直到你积累了一定数量的打赏者；然后将项目开源给全世界。&quot; linktype=&quot;text&quot; imgurl=&quot;&quot; imgdata=&quot;null&quot; tab=&quot;innerlink&quot; data-linktype=&quot;2&quot;&gt;&lt;span&gt;使其仅对打赏者开放，直到你积累了一定数量的打赏者；&lt;/span&gt;&lt;/a&gt;&lt;/section&gt;&lt;/li&gt;&lt;li&gt;&lt;section&gt;&lt;a target=&quot;_blank&quot; href=&quot;https://mp.weixin.qq.com/s?__biz=MzI2MTIzMzY3Mw==&amp;amp;mid=2247487508&amp;amp;idx=1&amp;amp;sn=78cf235aa9ba5f988c6922ca98f8bfd6&amp;amp;chksm=ea5cdd72dd2b54647cf55b4a73dcafa69fc7228205ad39ecc98fe57b39cdecb21c238c6d6cb6&amp;amp;scene=21&amp;amp;token=31912529&amp;amp;lang=zh_CN#wechat_redirect&quot; textvalue=&quot;创建一个很棒的软件；使其仅对打赏者开放，直到你积累了一定数量的打赏者；然后将项目开源给全世界。&quot; linktype=&quot;text&quot; imgurl=&quot;&quot; imgdata=&quot;null&quot; tab=&quot;innerlink&quot; data-linktype=&quot;2&quot;&gt;&lt;span&gt;然后将项目开源给全世界。&lt;/span&gt;&lt;/a&gt;&lt;/section&gt;&lt;/li&gt;&lt;/ol&gt;&lt;section&gt;&lt;br/&gt;&lt;/section&gt;&lt;section&gt;&lt;span&gt;这是一种双赢。效果很好，几天之内我的收入就增加了 1.1 万美元。&lt;/span&gt;&lt;/section&gt;&lt;p&gt;&lt;/p&gt;&lt;p&gt;&lt;img class=&quot;rich_pages wxw-img&quot; data-galleryid=&quot;&quot; data-ratio=&quot;0.61015625&quot; data-s=&quot;300,640&quot; data-src=&quot;https://mmbiz.qpic.cn/mmbiz_png/V2MblOqwf8j6NMx7Oh8Vo8iawAeJoQXBNacHWvWziak3ytvnt0YJtpASrRAWYfgoibrYLAgSQSkWuePibaKw1VhZww/640?wx_fmt=png&quot; data-type=&quot;png&quot; data-w=&quot;1280&quot;/&gt;&lt;/p&gt;&lt;p&gt;&lt;/p&gt;&lt;section&gt;&lt;span&gt;我另外一位朋友 Nuno Maduro 最近在他的 Pest 项目中复制了这一方法，同样取得了成功：&lt;/span&gt;&lt;span/&gt;&lt;/section&gt;&lt;p&gt;&lt;/p&gt;&lt;p&gt;&lt;img class=&quot;rich_pages wxw-img&quot; data-backh=&quot;445&quot; data-backw=&quot;578&quot; data-galleryid=&quot;&quot; data-ratio=&quot;0.77&quot; data-s=&quot;300,640&quot; data-src=&quot;https://mmbiz.qpic.cn/mmbiz_png/UgatRYCu4qpPIHIN4MHLP3k4hibYxKjA9viccQvHKBUvGQ2S1CxGYLQ13LmK9NdC4zz55fdoZ6Id9jMvlGvH7bKw/640?wx_fmt=png&quot; data-type=&quot;png&quot; data-w=&quot;1200&quot;/&gt;&lt;/p&gt;&lt;p&gt;&lt;/p&gt;&lt;section&gt;&lt;span&gt;这种方法很棒，但是需要不断地提供新的想法，所有的这些都将成为我必须持续进行的项目。长远来看，我需要更合理的东西。&lt;/span&gt;&lt;/section&gt;&lt;p&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;阶段 3：教学视频&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;我得到的大部分打赏金都是这个阶段来的：&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;/p&gt;&lt;p&gt;&lt;img class=&quot;rich_pages wxw-img&quot; data-galleryid=&quot;&quot; data-ratio=&quot;0.61015625&quot; data-s=&quot;300,640&quot; data-src=&quot;https://mmbiz.qpic.cn/mmbiz_png/4M7qqzWhpthj1hY1mM4jyiaFEic2ribu5LoO3IoiaO7zpLbSiagxYnSdiakIK6GNOTrOlRMTEE8d5ibC41hd3RFdHth3w/640?wx_fmt=png&quot; data-type=&quot;png&quot; data-w=&quot;1280&quot;/&gt;&lt;/p&gt;&lt;p&gt;&lt;/p&gt;&lt;section&gt;&lt;span&gt;这里边有什么秘诀吗？答案是：录制教学视频。&lt;/span&gt;&lt;/section&gt;&lt;section&gt;&lt;br/&gt;&lt;/section&gt;&lt;section&gt;&lt;span&gt;构建有用的软件是一回事，但教别人怎么用完全是另一回事。&lt;/span&gt;&lt;/section&gt;&lt;section&gt;&lt;br/&gt;&lt;/section&gt;&lt;section&gt;&lt;span&gt;我尽力创建高质量的文档，但总有人需要更加高级的内容。&lt;/span&gt;&lt;/section&gt;&lt;section&gt;&lt;br/&gt;&lt;/section&gt;&lt;section&gt;&lt;a target=&quot;_blank&quot; href=&quot;https://mp.weixin.qq.com/s?__biz=MzI2MTIzMzY3Mw==&amp;amp;mid=2247487508&amp;amp;idx=1&amp;amp;sn=78cf235aa9ba5f988c6922ca98f8bfd6&amp;amp;chksm=ea5cdd72dd2b54647cf55b4a73dcafa69fc7228205ad39ecc98fe57b39cdecb21c238c6d6cb6&amp;amp;scene=21&amp;amp;token=31912529&amp;amp;lang=zh_CN#wechat_redirect&quot; textvalue=&quot;为了满足这些需求，我录了一系列教学视频。在这之后的三个月里，我的总收入从 4 万美元涨到了 10 万美元以上。&quot; linktype=&quot;text&quot; imgurl=&quot;&quot; imgdata=&quot;null&quot; tab=&quot;innerlink&quot; data-linktype=&quot;2&quot;&gt;&lt;span&gt;为了满足这些需求，我录了一系列教学视频。在这之后的三个月里，我的总收入从 4 万美元涨到了 10 万美元以上。&lt;/span&gt;&lt;/a&gt;&lt;span/&gt;&lt;/section&gt;&lt;p&gt;&lt;/p&gt;&lt;p&gt;&lt;img class=&quot;rich_pages wxw-img&quot; data-galleryid=&quot;&quot; data-ratio=&quot;0.9016666666666666&quot; data-s=&quot;300,640&quot; data-src=&quot;https://mmbiz.qpic.cn/mmbiz_png/9aFGF00vU9qyReEwmAqo3kwzvsw4vNTKvkLiaE1qpC19jWGqSfaTEH15nibciaaqYJWIk5wKgzl2ZmBkHLImzH7FA/640?wx_fmt=png&quot; data-type=&quot;png&quot; data-w=&quot;1200&quot;/&gt;&lt;/p&gt;&lt;p&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;我在文档的适当位置嵌入了这些视频的链接，以帮助大家找到它们：&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;/p&gt;&lt;p&gt;&lt;img class=&quot;rich_pages wxw-img&quot; data-galleryid=&quot;&quot; data-ratio=&quot;0.25625&quot; data-s=&quot;300,640&quot; data-src=&quot;https://mmbiz.qpic.cn/mmbiz_png/IZwRSmhyN0jUBOoiad4rhibAtATMAnmhyyXicwAFNMSAC7ic7pwAbbDACXj3DGAktJlalW8CM2LM5rxvUbC0iayeOwA/640?wx_fmt=png&quot; data-type=&quot;png&quot; data-w=&quot;1280&quot;/&gt;&lt;/p&gt;&lt;p&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;几个星期之后，我又为 GitHub 打赏者专门建立了一个「私有」的视频小组：&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;/p&gt;&lt;p&gt;&lt;img class=&quot;rich_pages wxw-img&quot; data-backh=&quot;305&quot; data-backw=&quot;578&quot; data-galleryid=&quot;&quot; data-ratio=&quot;0.5265625&quot; data-s=&quot;300,640&quot; data-src=&quot;https://mmbiz.qpic.cn/mmbiz_png/6fD7ZjyUlFOYsrQ7pvgv578mjfs81rBrSrJKuhKpwarsMyfPiaRMUffYYZmkHHj9YicWtETo52h3l7V699HjrbwQ/640?wx_fmt=png&quot; data-type=&quot;png&quot; data-w=&quot;1280&quot;/&gt;&lt;/p&gt;&lt;p&gt;&lt;/p&gt;&lt;section&gt;&lt;span&gt;这就是我的秘诀（为了做到以上这些，我利用 GitHub 认证构建了一个 Laravel app 来调用 GitHub API，以验证用户是否为打赏者）。&lt;br/&gt;&lt;/span&gt;&lt;/section&gt;&lt;section&gt;&lt;br/&gt;&lt;/section&gt;&lt;section&gt;&lt;span&gt;现在，那些看免费视频的人自然会遇到这些「私有」视频，如果他们喜欢前面那些免费的内容，他们就会给我打赏来获取后面的视频。&lt;/span&gt;&lt;/section&gt;&lt;section&gt;&lt;br/&gt;&lt;/section&gt;&lt;section&gt;&lt;a target=&quot;_blank&quot; href=&quot;https://mp.weixin.qq.com/s?__biz=MzI2MTIzMzY3Mw==&amp;amp;mid=2247487508&amp;amp;idx=1&amp;amp;sn=78cf235aa9ba5f988c6922ca98f8bfd6&amp;amp;chksm=ea5cdd72dd2b54647cf55b4a73dcafa69fc7228205ad39ecc98fe57b39cdecb21c238c6d6cb6&amp;amp;scene=21&amp;amp;token=31912529&amp;amp;lang=zh_CN#wechat_redirect&quot; textvalue=&quot;每次有新特性出现，我都会放出一批新视频。此外，我还会给每位打赏者提供访问每节课源代码的入口。在 90 天的时间里，我的年收入增长了大约 8 万美元。&quot; linktype=&quot;text&quot; imgurl=&quot;&quot; imgdata=&quot;null&quot; tab=&quot;innerlink&quot; data-linktype=&quot;2&quot;&gt;&lt;span&gt;每次有新特性出现，我都会放出一批新视频。此外，我还会给每位打赏者提供访问每节课源代码的入口。&lt;/span&gt;&lt;/a&gt;&lt;a target=&quot;_blank&quot; href=&quot;http://mp.weixin.qq.com/s?__biz=MzI2MTIzMzY3Mw==&amp;amp;mid=2247487508&amp;amp;idx=1&amp;amp;sn=78cf235aa9ba5f988c6922ca98f8bfd6&amp;amp;chksm=ea5cdd72dd2b54647cf55b4a73dcafa69fc7228205ad39ecc98fe57b39cdecb21c238c6d6cb6&amp;amp;scene=21#wechat_redirect&quot; textvalue=&quot;card类似于Threadcard余额属性，卡号属性等类似于Treadlocal内部属性集合threadLocalscardManager类似于ThreadLocal管理类&quot; linktype=&quot;text&quot; imgurl=&quot;&quot; imgdata=&quot;null&quot; data-itemshowtype=&quot;0&quot; tab=&quot;innerlink&quot; data-linktype=&quot;2&quot; wah-hotarea=&quot;click&quot; hasload=&quot;1&quot;&gt;&lt;span&gt;搜索公众号互联网架构师回复“2T”，送你一份惊喜礼包。&lt;/span&gt;&lt;/a&gt;&lt;/section&gt;&lt;section&gt;&lt;br/&gt;&lt;/section&gt;&lt;section&gt;&lt;a target=&quot;_blank&quot; href=&quot;https://mp.weixin.qq.com/s?__biz=MzI2MTIzMzY3Mw==&amp;amp;mid=2247487508&amp;amp;idx=1&amp;amp;sn=78cf235aa9ba5f988c6922ca98f8bfd6&amp;amp;chksm=ea5cdd72dd2b54647cf55b4a73dcafa69fc7228205ad39ecc98fe57b39cdecb21c238c6d6cb6&amp;amp;scene=21&amp;amp;token=31912529&amp;amp;lang=zh_CN#wechat_redirect&quot; textvalue=&quot;每次有新特性出现，我都会放出一批新视频。此外，我还会给每位打赏者提供访问每节课源代码的入口。在 90 天的时间里，我的年收入增长了大约 8 万美元。&quot; linktype=&quot;text&quot; imgurl=&quot;&quot; imgdata=&quot;null&quot; tab=&quot;innerlink&quot; data-linktype=&quot;2&quot;&gt;&lt;span&gt;在 90 天的时间里，我的年收入增长了大约 8 万美元。&lt;/span&gt;&lt;/a&gt;&lt;/section&gt;&lt;section&gt;&lt;br/&gt;&lt;/section&gt;&lt;section&gt;&lt;span&gt;现在我有了连续的收入，不用再将所有时间都花在课程发布上了。我将用空出来的时间继续开发这个软件，同时放出新的视频。&lt;/span&gt;&lt;/section&gt;&lt;p&gt;&lt;/p&gt;&lt;section&gt;&lt;span&gt;&lt;strong&gt;&lt;span&gt;如何通过打赏赚更多钱？&lt;/span&gt;&lt;/strong&gt;&lt;/span&gt;&lt;/section&gt;&lt;p&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;实力是第一位的&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;/p&gt;&lt;section&gt;&lt;span&gt;要做到靠打赏谋生，首先离不开日益月累的磨练，你做的东西要真正有用才行。我把我所有的一切都投入到工作中，这点没有捷径。&lt;/span&gt;&lt;/section&gt;&lt;section&gt;&lt;br/&gt;&lt;/section&gt;&lt;section&gt;&lt;span&gt;你可以发现，我在一个开源项目中全职工作了整整一年才看到收入。能得到人们赞助的工作必须是高质量的，而且始终是排在第一位的。&lt;/span&gt;&lt;/section&gt;&lt;p&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;积极寻找用户&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;/p&gt;&lt;section&gt;&lt;span&gt;你可以在网上创建优秀的工具，但如果没有人关注，再出色的工具也无法为你带来收入。因此，找到用户是赚钱的关键。在这方面，你的 Twitter 粉丝和邮件订阅者都是潜在的挖掘对象。&lt;/span&gt;&lt;/section&gt;&lt;p&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;打赏金额设置不要太保守&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;/p&gt;&lt;section&gt;&lt;span&gt;很多 GitHub 开发者犯的最大的一个错误就是在初级打赏设置中写的钱数太少。&lt;/span&gt;&lt;/section&gt;&lt;section&gt;&lt;br/&gt;&lt;/section&gt;&lt;section&gt;&lt;span&gt;如果打赏者能选 1-5 美元 / 月，谁还会选更高的打赏金额。&lt;/span&gt;&lt;/section&gt;&lt;section&gt;&lt;br/&gt;&lt;/section&gt;&lt;section&gt;&lt;span&gt;我很早就意识到，如果我真的想做这件事，只有 5 美元的打赏肯定是不够的，所以我后来涨到了 14 美元。&lt;/span&gt;&lt;/section&gt;&lt;p&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;给打赏等级取一个好名字&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;/p&gt;&lt;section&gt;&lt;span&gt;在给打赏等级取名的时候，记得取一个能描述打赏者类型的恰当名字。&lt;/span&gt;&lt;/section&gt;&lt;section&gt;&lt;br/&gt;&lt;/section&gt;&lt;section&gt;&lt;span&gt;举个例子，对于一个高级打赏等级来说，它的标签应该是「The Agency（代理）」或其他能够暗示一个公司应该给予高级打赏的标签，而不是「Platinum（白金）」这种模糊的说法。&lt;/span&gt;&lt;/section&gt;&lt;section&gt;&lt;br/&gt;&lt;/section&gt;&lt;section&gt;&lt;span&gt;这样一来，人们看到这个标签首先想到的会是：「我的用途到底属于哪一类」，而不是：「我每个月要花多少钱」。&lt;/span&gt;&lt;/section&gt;&lt;p&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;不要羞于谈钱&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;/p&gt;&lt;section&gt;&lt;span&gt;在我的成长过程中，我一直认为谈钱是不礼貌的，但其实这是一个谎言。有一次，我一股脑涨了 1 万美元，因为一个合作者告诉我他们都赚多少钱。在得知他们的收入情况后，我对自己的要价感到心安理得。但如果他们不告诉我这个情况，什么都不会发生。&lt;/span&gt;&lt;/section&gt;&lt;section&gt;&lt;br/&gt;&lt;/section&gt;&lt;section&gt;&lt;span&gt;透明是一个健康的现象。&lt;/span&gt;&lt;/section&gt;&lt;section&gt;&lt;br/&gt;&lt;/section&gt;&lt;section&gt;&lt;span&gt;我不会隐瞒自己的收入，因为别人也不对我隐瞒他们的收入，这让我从中获利。&lt;/span&gt;&lt;/section&gt;&lt;section&gt;&lt;br/&gt;&lt;/section&gt;&lt;section&gt;&lt;span&gt;即使他们赚的比我多得多，我也不会感到心痛或想分一杯羹。相反，我只会感到激动和鼓舞。我希望其他人也能保持这种心态。&lt;/span&gt;&lt;/section&gt;&lt;section&gt;&lt;br/&gt;&lt;/section&gt;&lt;section&gt;&lt;span&gt;直接告诉别人你完全依赖这笔钱生活也没什么不礼貌的，而且这笔钱帮你打造出了人们每天都在用且从中受益的软件。&lt;/span&gt;&lt;/section&gt;&lt;p&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;不要因为赚了很多钱而感到内疚&lt;/span&gt;&lt;/p&gt;&lt;section&gt;&lt;br/&gt;&lt;/section&gt;&lt;section&gt;&lt;span&gt;我一直都在提醒自己，我不是一个开发者布道师。如果我的打赏收入超过了平均生活水准，那也不错。我经营的也不是非营利组织。&lt;/span&gt;&lt;/section&gt;&lt;section&gt;&lt;br/&gt;&lt;/section&gt;&lt;section&gt;&lt;span&gt;我的收入和我的软件所带给别人的价值成正比，这没什么问题。&lt;/span&gt;&lt;/section&gt;&lt;section&gt;&lt;br/&gt;&lt;/section&gt;&lt;section&gt;&lt;span&gt;我做的不是什么神圣的工作，那些软件是企业拿来赚钱的，他们从中牟利，所以我从中赚钱也是 OK 的。&lt;/span&gt;&lt;/section&gt;&lt;p&gt;&lt;/p&gt;&lt;section&gt;&lt;span&gt;&lt;strong&gt;&lt;span&gt;网友：我也能这么做吗？&lt;/span&gt;&lt;/strong&gt;&lt;/span&gt;&lt;/section&gt;&lt;p&gt;&lt;/p&gt;&lt;section&gt;&lt;span&gt;Caleb Porzio 的这份经历也引起了许多开发者的关注，讨论最热烈的问题是：在我的国家或者地区，这个方法行得通吗？&lt;/span&gt;&lt;/section&gt;&lt;p&gt;&lt;/p&gt;&lt;p&gt;&lt;img class=&quot;rich_pages wxw-img&quot; data-backh=&quot;189&quot; data-backw=&quot;578&quot; data-galleryid=&quot;&quot; data-ratio=&quot;0.3270300333704116&quot; data-s=&quot;300,640&quot; data-src=&quot;https://mmbiz.qpic.cn/mmbiz_png/FMhl5V2I7nuw8sULic32dYibd3BuhlvKtjibXibGpSw34XuW0TLbJ2l7naVS5DT02ST3oyaErXJJxknPPrmeUPLicFg/640?wx_fmt=png&quot; data-type=&quot;png&quot; data-w=&quot;899&quot;/&gt;&lt;/p&gt;&lt;p&gt;&lt;/p&gt;&lt;section&gt;&lt;span&gt;「看到这些，我为自己国家芬兰的法律而感到难过。我们有一项名为筹款法的法律，其中规定，要想收取捐款（即无任何回报的支付）必须获得许可。这个许可证是付费的，而且不发给个人，只授予非营利活动。」&lt;/span&gt;&lt;/section&gt;&lt;section&gt;&lt;br/&gt;&lt;/section&gt;&lt;section&gt;&lt;a target=&quot;_blank&quot; href=&quot;https://mp.weixin.qq.com/s?__biz=MzI2MTIzMzY3Mw==&amp;amp;mid=2247487508&amp;amp;idx=1&amp;amp;sn=78cf235aa9ba5f988c6922ca98f8bfd6&amp;amp;chksm=ea5cdd72dd2b54647cf55b4a73dcafa69fc7228205ad39ecc98fe57b39cdecb21c238c6d6cb6&amp;amp;scene=21&amp;amp;token=31912529&amp;amp;lang=zh_CN#wechat_redirect&quot; textvalue=&quot;这就意味着，如果你在软件项目上看到捐赠按钮，并且该笔资金流向芬兰人，这个过程是违法的。&quot; linktype=&quot;text&quot; imgurl=&quot;&quot; imgdata=&quot;null&quot; tab=&quot;innerlink&quot; data-linktype=&quot;2&quot;&gt;&lt;span&gt;这就意味着，如果你在软件项目上看到捐赠按钮，并且该笔资金流向芬兰人，这个过程是违法的。&lt;/span&gt;&lt;/a&gt;&lt;span/&gt;&lt;/section&gt;&lt;section&gt;&lt;br/&gt;&lt;/section&gt;&lt;section&gt;&lt;span&gt;所以这位芬兰的开发者表示，他自己托管了一个免费项目，为此不得不成立一家公司（独资经营）并出售一些其他的东西，以便从服务中获利。即便人们有捐赠的意愿，他也不能「合法地」接受这些钱。&lt;/span&gt;&lt;/section&gt;&lt;p&gt;&lt;/p&gt;&lt;p&gt;&lt;img class=&quot;rich_pages wxw-img&quot; data-galleryid=&quot;&quot; data-ratio=&quot;0.3311036789297659&quot; data-s=&quot;300,640&quot; data-src=&quot;https://mmbiz.qpic.cn/mmbiz_png/shVJlQk3GE1s6WgGLttYpUFTn4GBNaUKHfOGL1ic1QFrkCWuMSVtTwUJSib8xZibKibzKzwOd5OnnWaPDFLh5jvpqw/640?wx_fmt=png&quot; data-type=&quot;png&quot; data-w=&quot;598&quot;/&gt;&lt;/p&gt;&lt;p&gt;&lt;/p&gt;&lt;section&gt;&lt;span&gt;有人表示，在大多数西方国家都有类似的规定。因此，对于这些国家的人来说，自由职业虽然「自由」，但也同样需要花费更多的精力去管理琐事。&lt;/span&gt;&lt;/section&gt;&lt;p&gt;&lt;/p&gt;&lt;p&gt;&lt;img class=&quot;rich_pages wxw-img&quot; data-galleryid=&quot;&quot; data-ratio=&quot;0.453125&quot; data-s=&quot;300,640&quot; data-src=&quot;https://mmbiz.qpic.cn/mmbiz_png/yeia0iaiarHsicObEf2NzNL1VseSPCK8qxWzG0LdnHJeu3cIR8v3ibmaxly1uPnS45J0V9ZJSibMHLMaUcaLY7mNY3mg/640?wx_fmt=png&quot; data-type=&quot;png&quot; data-w=&quot;448&quot;/&gt;&lt;/p&gt;&lt;p&gt;&lt;/p&gt;&lt;section&gt;&lt;span&gt;但在美国，这种做法的门槛要低得多。「如果是在美国的话，你可以作为个人接受无偿礼品，也可以作为个体经营者接受营业收入，无需额外注册什么。与往常一样，你需要精确缴纳税费，包括预扣税。」&lt;/span&gt;&lt;/section&gt;&lt;p&gt;&lt;/p&gt;&lt;section&gt;&lt;p&gt;&lt;a target=&quot;_blank&quot; href=&quot;https://mp.weixin.qq.com/s?__biz=MzI2MTIzMzY3Mw==&amp;amp;mid=2247487508&amp;amp;idx=1&amp;amp;sn=78cf235aa9ba5f988c6922ca98f8bfd6&amp;amp;chksm=ea5cdd72dd2b54647cf55b4a73dcafa69fc7228205ad39ecc98fe57b39cdecb21c238c6d6cb6&amp;amp;scene=21&amp;amp;token=171858062&amp;amp;lang=zh_CN#wechat_redirect&quot; textvalue=&quot;https://gitee.com/baomidou/mybatis-mate-examples&quot; linktype=&quot;text&quot; imgurl=&quot;&quot; imgdata=&quot;null&quot; tab=&quot;innerlink&quot; data-linktype=&quot;2&quot;/&gt;&lt;/p&gt;&lt;/section&gt;&lt;p&gt;&lt;strong&gt;&lt;span&gt;-END-&lt;/span&gt;&lt;/strong&gt;&lt;/p&gt;&lt;p&gt;&lt;/p&gt;&lt;section data-style-type=&quot;5&quot; data-tools=&quot;新媒体排版&quot; data-id=&quot;965972&quot;&gt;&lt;span&gt;最后，关注公众号互联网架构师，在后台回复：2T，可以获取我整理的 Java 系列面试题和答案，非常齐全&lt;span&gt;。&lt;/span&gt;&lt;/span&gt;&lt;br/&gt;&lt;/section&gt;&lt;section data-tool=&quot;mdnice编辑器&quot; data-website=&quot;https://www.mdnice.com&quot;&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;/p&gt;&lt;/section&gt;&lt;section&gt;&lt;section&gt;&lt;section&gt;&lt;section&gt;&lt;section&gt;&lt;section&gt;&lt;section&gt;&lt;section&gt;&lt;section&gt;&lt;section&gt;&lt;section&gt;&lt;section&gt;&lt;section&gt;&lt;section&gt;&lt;p&gt;&lt;span&gt;正文结束&lt;/span&gt;&lt;/p&gt;&lt;/section&gt;&lt;section&gt;&lt;section&gt;&lt;br/&gt;&lt;/section&gt;&lt;/section&gt;&lt;/section&gt;&lt;/section&gt;&lt;/section&gt;&lt;/section&gt;&lt;/section&gt;&lt;/section&gt;&lt;/section&gt;&lt;/section&gt;&lt;/section&gt;&lt;/section&gt;&lt;/section&gt;&lt;/section&gt;&lt;/section&gt;&lt;section&gt;&lt;section&gt;&lt;section&gt;&lt;section&gt;&lt;section&gt;&lt;section&gt;&lt;section&gt;&lt;section&gt;&lt;span&gt;推荐阅读 ↓↓↓&lt;/span&gt;&lt;/section&gt;&lt;/section&gt;&lt;section&gt;&lt;p&gt;1.&lt;a target=&quot;_blank&quot; href=&quot;http://mp.weixin.qq.com/s?__biz=MzI2MTIzMzY3Mw==&amp;amp;mid=2247513987&amp;amp;idx=1&amp;amp;sn=05fe46b226a26aa370674a9a5a2527d4&amp;amp;chksm=ea5f7ae5dd28f3f32893dcbefae24a8a4fab3d9598cd8cc27c3344a3fd49eec6c241f035e6c6&amp;amp;scene=21#wechat_redirect&quot; textvalue=&quot;心态崩了！税前2万4，到手1万4，年终奖扣税方式1月1日起施行~&quot; linktype=&quot;text&quot; imgurl=&quot;&quot; imgdata=&quot;null&quot; data-itemshowtype=&quot;0&quot; tab=&quot;innerlink&quot; data-linktype=&quot;2&quot; wah-hotarea=&quot;click&quot; hasload=&quot;1&quot;&gt;心态崩了！税前2万4，到手1万4，年终奖扣税方式1月1日起施行~&lt;/a&gt;&lt;/p&gt;&lt;p&gt;2&lt;span&gt;.&lt;a target=&quot;_blank&quot; href=&quot;http://mp.weixin.qq.com/s?__biz=MzI2MTIzMzY3Mw==&amp;amp;mid=2247511615&amp;amp;idx=1&amp;amp;sn=39d729641ea1d5ef3b932572db456ac6&amp;amp;chksm=ea5f6359dd28ea4f677f597ce9049d9d0dc2895dba3e2a75590635c8881ed7c927f5b4f958a5&amp;amp;scene=21#wechat_redirect&quot; textvalue=&quot;深圳一普通中学老师工资单曝光，秒杀程序员，网友：敢问是哪个学校毕业的？&quot; linktype=&quot;text&quot; imgurl=&quot;&quot; imgdata=&quot;null&quot; data-itemshowtype=&quot;0&quot; tab=&quot;innerlink&quot; data-linktype=&quot;2&quot; wah-hotarea=&quot;click&quot; hasload=&quot;1&quot;&gt;深圳一普通中学老师工资单曝光，秒杀程序员，网友：敢问是哪个学校毕业的？&lt;/a&gt;&lt;/span&gt;&lt;/p&gt;&lt;p&gt;3&lt;span&gt;.&lt;a href=&quot;http://mp.weixin.qq.com/s?__biz=MzI2MTIzMzY3Mw==&amp;amp;mid=2247488035&amp;amp;idx=1&amp;amp;sn=5300893903094128bdc20ce2a5717a50&amp;amp;chksm=ea5cdf45dd2b56531ac0c3a8fb8b56b06bc546785f8772a4d02e2ca87c4e30f25b24bf21f784&amp;amp;scene=21#wechat_redirect&quot; target=&quot;_blank&quot; data-itemshowtype=&quot;0&quot; data-linktype=&quot;2&quot; hasload=&quot;1&quot; wah-hotarea=&quot;click&quot;&gt;从零开始搭建创业公司后台技术栈&lt;/a&gt;&lt;/span&gt;&lt;/p&gt;&lt;p&gt;4&lt;span&gt;.&lt;a href=&quot;http://mp.weixin.qq.com/s?__biz=MzI2MTIzMzY3Mw==&amp;amp;mid=2247488928&amp;amp;idx=1&amp;amp;sn=4c56dd675e1b32a73b698df3d5e8609f&amp;amp;chksm=ea5cd8c6dd2b51d05e6d6d715418241f471ccb3002719263b2d0e092763f68f3691249970a08&amp;amp;scene=21#wechat_redirect&quot; target=&quot;_blank&quot; data-itemshowtype=&quot;0&quot; data-linktype=&quot;2&quot; hasload=&quot;1&quot; wah-hotarea=&quot;click&quot;&gt;程序员一般可以从什么平台接私活？&lt;/a&gt;&lt;/span&gt;&lt;/p&gt;&lt;p&gt;5&lt;span&gt;.&lt;a target=&quot;_blank&quot; href=&quot;http://mp.weixin.qq.com/s?__biz=MzI2MTIzMzY3Mw==&amp;amp;mid=2247513516&amp;amp;idx=1&amp;amp;sn=8d1b8d61ed5ef47079d8054c5bec135a&amp;amp;chksm=ea5f78cadd28f1dcd35e3998996cebaaf9fe4826fec82baf521e959dd3d1575af43774ca780e&amp;amp;scene=21#wechat_redirect&quot; textvalue=&quot;清华大学：2021 元宇宙研究报告！&quot; linktype=&quot;text&quot; imgurl=&quot;&quot; imgdata=&quot;null&quot; data-itemshowtype=&quot;0&quot; tab=&quot;innerlink&quot; data-linktype=&quot;2&quot; wah-hotarea=&quot;click&quot; hasload=&quot;1&quot;&gt;清华大学：2021 元宇宙研究报告！&lt;/a&gt;&lt;/span&gt;&lt;/p&gt;&lt;p&gt;6.&lt;a target=&quot;_blank&quot; href=&quot;http://mp.weixin.qq.com/s?__biz=MzI2MTIzMzY3Mw==&amp;amp;mid=2247513283&amp;amp;idx=1&amp;amp;sn=3b3d8e893a1241cf5af2150370ae9d71&amp;amp;chksm=ea5f79a5dd28f0b3a7603b1fbdb306f77ac64223bd05c4b7f0dc0469f77a68359810c5de2a01&amp;amp;scene=21#wechat_redirect&quot; textvalue=&quot;为什么国内 996 干不过国外的 955呢？&quot; linktype=&quot;text&quot; imgurl=&quot;&quot; imgdata=&quot;null&quot; data-itemshowtype=&quot;0&quot; tab=&quot;innerlink&quot; data-linktype=&quot;2&quot; wah-hotarea=&quot;click&quot; hasload=&quot;1&quot;&gt;为什么国内 996 干不过国外的 955呢？&lt;/a&gt;&lt;/p&gt;&lt;p&gt;7&lt;span&gt;.&lt;a target=&quot;_blank&quot; href=&quot;http://mp.weixin.qq.com/s?__biz=MzI2MTIzMzY3Mw==&amp;amp;mid=2247508021&amp;amp;idx=1&amp;amp;sn=b3d1010a12e89362bce74771e6251037&amp;amp;chksm=ea5f6d53dd28e445ea5adbdc599f8ad4caa7fe50de11ea523d759b4b3adc3599f47676dd6b9c&amp;amp;scene=21#wechat_redirect&quot; data-itemshowtype=&quot;0&quot; tab=&quot;innerlink&quot; data-linktype=&quot;2&quot; wah-hotarea=&quot;click&quot; hasload=&quot;1&quot;&gt;这封“领导痛批95后下属”的邮件，句句扎心！&lt;/a&gt;&lt;/span&gt;&lt;/p&gt;&lt;p&gt;8&lt;span&gt;.&lt;a href=&quot;http://mp.weixin.qq.com/s?__biz=MzI2MTIzMzY3Mw==&amp;amp;mid=2247488564&amp;amp;idx=1&amp;amp;sn=256862239b12a1313919ee3ea6ff0d1c&amp;amp;chksm=ea5cd952dd2b50443feec88eb893233d2f6cf33f89e2ce72192c98035fd26cb0eb797a86f8f0&amp;amp;scene=21#wechat_redirect&quot; target=&quot;_blank&quot; data-itemshowtype=&quot;0&quot; data-linktype=&quot;2&quot; hasload=&quot;1&quot; wah-hotarea=&quot;click&quot;&gt;15张图看懂瞎忙和高效的区别！&lt;/a&gt;&lt;/span&gt;&lt;/p&gt;&lt;/section&gt;&lt;/section&gt;&lt;/section&gt;&lt;/section&gt;&lt;section&gt;&lt;section&gt;&lt;p&gt;&lt;strong&gt;&lt;img class=&quot;__bg_gif rich_pages wxw-img&quot; data-fileid=&quot;100030073&quot; data-ratio=&quot;0.1328125&quot; data-src=&quot;https://mmbiz.qpic.cn/mmbiz_gif/3GQek52mKtWDXtSkfViaQ2FZ2ZfSyjBcSkArjQVCMH4a7uxg6Vkibiaiciaiae2uxvzia7yib04tleLiaqcFVGUf2vcMf4A/640?wx_fmt=gif&quot; data-type=&quot;gif&quot; data-w=&quot;640&quot;/&gt;&lt;/strong&gt;&lt;/p&gt;&lt;/section&gt;&lt;/section&gt;&lt;/section&gt;&lt;/section&gt;&lt;/section&gt;
                &lt;/div&gt;

                

                



                
                &lt;/div&gt;&lt;/div&gt;</content:encoded>
</item>
<item>
<guid>2aee7020002341aaa38ee4a929ff3ab6</guid>
<title>干货 | Elasticsearch 多种跨机房灾备方案对比与实战解读</title>
<link>https://toutiao.io/k/ms517wc</link>
<content:encoded>&lt;div&gt;&lt;div&gt;&lt;section data-tool=&quot;mdnice编辑器&quot; data-website=&quot;https://www.mdnice.com&quot;&gt;&lt;h2 data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;1 引言&lt;/span&gt;&lt;/h2&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;Elasticsearch 集群的高可用，保证服务的连续性是企业最关注的需求。通常当企业达到一定规模时，不管是在云上还是线下都会有多个机房做异地灾备，确保在某个机房不可用时，还能持续对外提供业务。本文将会介绍几种 Elasticsearch 常见的灾备方案，同时提供了 Demo 案例方便大家动手体验。&lt;/span&gt;&lt;/p&gt;&lt;h2 data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;2 方案概要&lt;/span&gt;&lt;/h2&gt;&lt;section data-tool=&quot;mdnice编辑器&quot;&gt;&lt;table&gt;&lt;thead&gt;&lt;tr&gt;&lt;th&gt;&lt;span&gt;方案&lt;/span&gt;&lt;/th&gt;&lt;th&gt;&lt;span&gt;定期快照&lt;/span&gt;&lt;/th&gt;&lt;th&gt;&lt;span&gt;跨机房部署集群&lt;/span&gt;&lt;/th&gt;&lt;th&gt;&lt;span&gt;应用双写&lt;/span&gt;&lt;/th&gt;&lt;th&gt;&lt;span&gt;借助消息队列实现双写&lt;/span&gt;&lt;/th&gt;&lt;th&gt;&lt;span&gt;CCR 跨集群复制&lt;/span&gt;&lt;/th&gt;&lt;th&gt;&lt;span&gt;极限网关&lt;/span&gt;&lt;/th&gt;&lt;/tr&gt;&lt;/thead&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td&gt;&lt;span&gt;描述&lt;/span&gt;&lt;/td&gt;&lt;td&gt;&lt;span&gt;定期将索引备份到外部存储，例如 S3，HDFS。备份的数据可以在备集群中恢复。&lt;/span&gt;&lt;/td&gt;&lt;td&gt;&lt;span&gt;一个集群中的节点分布在不同的机房。&lt;/span&gt;&lt;/td&gt;&lt;td&gt;&lt;span&gt;应用程序同时将数据写入两个集群。&lt;/span&gt;&lt;/td&gt;&lt;td&gt;&lt;span&gt;应用程序先将数据写入消息队列，然后由下游的消费者消费并写入集群。&lt;/span&gt;&lt;/td&gt;&lt;td&gt;&lt;span&gt;Elasticsearch 官方的跨集群复制功能，基于文档操作实现订阅复制。&lt;/span&gt;&lt;/td&gt;&lt;td&gt;&lt;span&gt;写请求交给网关，网关实时写入主集群，然后异步写备集群。&lt;/span&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td&gt;&lt;span&gt;优点&lt;/span&gt;&lt;/td&gt;&lt;td&gt;&lt;span&gt;1.一致性高。&lt;br/&gt;2.成本低。&lt;br/&gt;3.即使主集群和备集群都崩溃，仍然通过快照将数据恢复到新集群中。&lt;/span&gt;&lt;/td&gt;&lt;td&gt;&lt;span&gt;1.部署简单。&lt;br/&gt;2.成本低。&lt;br/&gt;3.一致性高。&lt;/span&gt;&lt;/td&gt;&lt;td&gt;&lt;span&gt;1.应用端灵活可控，开发简单。&lt;/span&gt;&lt;/td&gt;&lt;td&gt;&lt;span&gt;1.数据可靠性高，不易丢失。&lt;/span&gt;&lt;/td&gt;&lt;td&gt;&lt;span&gt;1.一致性高。&lt;br/&gt;2.设置简单。&lt;br/&gt;3.延迟低。&lt;br/&gt;4.提供完善的 API ，可以监控同步进度。&lt;/span&gt;&lt;/td&gt;&lt;td&gt;&lt;span&gt;1.无缝透明，应用程序无需任何调整。&lt;br/&gt;2.网关自动处理故障情况。&lt;br/&gt;3.随时可以进行主备切换。&lt;br/&gt;4.一致性高，通过校验任务确保数据完全一致。&lt;/span&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td&gt;&lt;span&gt;缺点&lt;/span&gt;&lt;/td&gt;&lt;td&gt;&lt;span&gt;1.数据不是实时备份，通过快照恢复时，延迟可能导致数据丢失。&lt;br/&gt; 2.无法实时切换到备集群。&lt;/span&gt;&lt;/td&gt;&lt;td&gt;&lt;span&gt;1.对网络带宽和延迟要求较高，仅适用于同城灾备。&lt;br/&gt;2.可能由于机房间网络中断造成脑裂问题。&lt;/span&gt;&lt;/td&gt;&lt;td&gt;&lt;span&gt;1.一致性差。&lt;br/&gt;2.集群故障时数据会丢失。&lt;br/&gt;3.延迟高。&lt;/span&gt;&lt;/td&gt;&lt;td&gt;&lt;span&gt;1.引入额外的消息队列组件，维护成本高，开发难度大。&lt;br/&gt;2.延迟高。&lt;/span&gt;&lt;/td&gt;&lt;td&gt;&lt;span&gt;1.切换复杂，需要手动操作，并且切换的时候可能会丢数据。&lt;br/&gt;2.属于 Elastic Stack 的白金版（PLATINUM）付费功能，需要额外付费。&lt;br/&gt;3.从 Elasticsearch v6.7 版本开始才可以使用。&lt;br/&gt;4.集群之间拉取数据会增加额外的负载并影响磁盘和网络性能。&lt;/span&gt;&lt;/td&gt;&lt;td&gt;&lt;br/&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/section&gt;&lt;h2 data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;3 定期快照&lt;/span&gt;&lt;/h2&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;Elasticsearch 提供快照和恢复功能，我们可以在远程文件系统仓库（比如共享文件系统、S3、HDFS 等）中为部分索引或者整个集群创建快照。快照有以下使用场景：&lt;/span&gt;&lt;/p&gt;&lt;ul data-tool=&quot;mdnice编辑器&quot; class=&quot;list-paddingleft-2&quot;&gt;&lt;li&gt;&lt;section&gt;&lt;span&gt;&lt;strong&gt;数据灾备&lt;/strong&gt;：当发生误删索引数据的情况时，可以使用快照来还原；在主集群无法正常工作时，可以使用快照在备集群上恢复数据。&lt;/span&gt;&lt;/section&gt;&lt;/li&gt;&lt;li&gt;&lt;section&gt;&lt;span&gt;&lt;strong&gt;归档数据&lt;/strong&gt;：随着数据的积累，集群中磁盘存储的压力会越来越大，对于一些时效性高的数据，比如日志、指标，我们往往只关心最近一段时间内的数据。对于时间比较早的数据，我们可以选择以快照的形式归档，以备后续有查询的需求。从 Elasticsearch 7.10 版本开始我们还可以结合 ILM 索引生命周期管理，在 Cold 和 Frozen 数据层使用可搜索快照进一步降低存储成本。&lt;/span&gt;&lt;/section&gt;&lt;/li&gt;&lt;li&gt;&lt;section&gt;&lt;span&gt;&lt;strong&gt;迁移数据&lt;/strong&gt;：当需要将数据从一个集群迁移到另一个集群时，使用快照是一种高效的选择。&lt;/span&gt;&lt;/section&gt;&lt;/li&gt;&lt;/ul&gt;&lt;figure data-tool=&quot;mdnice编辑器&quot;&gt;&lt;img class=&quot;rich_pages wxw-img&quot; data-ratio=&quot;0.5829268292682926&quot; data-src=&quot;https://mmbiz.qpic.cn/mmbiz_png/mjl8GCpsL9auhKTS8YiaHLpE37Swaxib503hXT4sW0DH6cAWLeYre2uFQjibicazdRHRjucVvqTyeVRnSgicp5mibULQ/640?wx_fmt=png&quot; data-type=&quot;png&quot; data-w=&quot;820&quot;/&gt;&lt;/figure&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;使用快照的方式做跨机房灾备的优点如下：&lt;/span&gt;&lt;/p&gt;&lt;ul data-tool=&quot;mdnice编辑器&quot; class=&quot;list-paddingleft-2&quot;&gt;&lt;li&gt;&lt;section&gt;&lt;span&gt;1.一致性高，快照是十分可靠的集群备份方式。&lt;/span&gt;&lt;/section&gt;&lt;/li&gt;&lt;li&gt;&lt;section&gt;&lt;span&gt;2.成本低，可以使用廉价的存储来保存快照，例如在公有云上的 S3，OSS，GCS 等等。&lt;/span&gt;&lt;/section&gt;&lt;/li&gt;&lt;li&gt;&lt;section&gt;&lt;span&gt;3.只要可以访问到外部文件系统中存储的快照数据，即使在主集群和备集群都崩溃的情况下，仍然通过快照将数据恢复到新集群中。&lt;/span&gt;&lt;/section&gt;&lt;/li&gt;&lt;/ul&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;快照方法的主要缺点如下：&lt;/span&gt;&lt;/p&gt;&lt;ul data-tool=&quot;mdnice编辑器&quot; class=&quot;list-paddingleft-2&quot;&gt;&lt;li&gt;&lt;section&gt;&lt;span&gt;1.数据无法实时备份，通过快照恢复时，延迟可能导致数据丢失。例如，如果用户指定每 5 分钟执行一次快照备份，则正在备份的数据始终会延迟 5 分钟。如果在执行最后一个快照 4 分钟后集群出现故障，则这 4 分钟的数据将完全丢失。&lt;/span&gt;&lt;/section&gt;&lt;/li&gt;&lt;li&gt;&lt;section&gt;&lt;span&gt;2.快照无法实时进行恢复，当主集群不可用时，需要手动在备集群上使用快照恢复数据，在这期间将无法对外提供服务。&lt;/span&gt;&lt;/section&gt;&lt;/li&gt;&lt;/ul&gt;&lt;h2 data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;4 跨机房部署集群&lt;/span&gt;&lt;/h2&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;跨机房部署 Elasticsearch 集群的方案在实现起来比较简单，就是将集群中的节点分布在不同的机房中，这对网络带宽和延迟要求较高，仅适用于同城灾备，异地灾备通常还是使用主备集群的方式。&lt;/span&gt;&lt;/p&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;跨机房部署集群时，我们应确保同一个索引主分片和副分片分布在不同的机房中，这样当某一个机房挂掉后另外一个机房仍然保留完整的数据，数据仍然可靠。&lt;/span&gt;&lt;/p&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;在公有云上可以支持跨多可用区的集群架构部署，得益于云上网络设施的完善，网络的延迟可以做到很低。本小节的案例来自 &lt;/span&gt;&lt;span&gt;腾讯云 Elasticsearch 集群多可用区容灾实现原理及最佳实践&lt;/span&gt;&lt;span&gt;，感兴趣的同学可以点击查看详情。&lt;/span&gt;&lt;/p&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;例如下图所示，在上海地域选择了三可用区集群的部署，数据节点数量选择 6 个。Elasticsearch 会自动将 6 个数据节点均衡地分布在三个可用区中，并对每个节点标记上可用区属性，从而可以通过可用区感知功能将索引的分片自动分布在多可用区中。&lt;/span&gt;&lt;/p&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;img class=&quot;rich_pages wxw-img&quot; data-ratio=&quot;0.7591297591297591&quot; data-src=&quot;https://mmbiz.qpic.cn/mmbiz_png/mjl8GCpsL9auhKTS8YiaHLpE37Swaxib50r8YafySq1IngFCpiby7yDDVtEiakwxribw2ICe0NjauQ8nrD1IohfdiccQ/640?wx_fmt=png&quot; data-type=&quot;png&quot; data-w=&quot;1287&quot;/&gt;&lt;span&gt;客户端可以直接通过 VIP 连接集群，由于 VIP 下绑定了集群内部的所有数据节点，因此客户端所有的读写请求会均衡的分布到各个数据节点上。&lt;/span&gt;&lt;img class=&quot;rich_pages wxw-img&quot; data-ratio=&quot;0.688622754491018&quot; data-src=&quot;https://mmbiz.qpic.cn/mmbiz_png/mjl8GCpsL9auhKTS8YiaHLpE37Swaxib50kR1KmbXtqCebQLpe2NZ9JWC1IcUhUADCibNDI9VxjvdCKPe0SoM1tWg/640?wx_fmt=png&quot; data-type=&quot;png&quot; data-w=&quot;1336&quot;/&gt;&lt;span&gt;为了保障集群的稳定性和高可用性，当选择多可用区集群架构部署时，需强制设置三个专用主节点。其中专用主节点的分布机制如下：&lt;/span&gt;&lt;/p&gt;&lt;ul data-tool=&quot;mdnice编辑器&quot; class=&quot;list-paddingleft-2&quot;&gt;&lt;li&gt;&lt;section&gt;&lt;span&gt;当选择三可用区部署时，会在每个可用区部署一个专用主节点，从而保障任何一个可用区不可用时，依然能够选出 Master 节点；&lt;/span&gt;&lt;/section&gt;&lt;/li&gt;&lt;li&gt;&lt;section&gt;&lt;span&gt;当选择双可用区部署时，为了避免出现一个可用区上分布两个专用主节点且出现“该可用区不可用”导致选不出 Master 节点的情况，腾讯云 ES 会选择一个隐藏可用区用来专门部署专用主节点。&lt;/span&gt;&lt;img class=&quot;rich_pages wxw-img&quot; data-ratio=&quot;0.7031963470319634&quot; data-src=&quot;https://mmbiz.qpic.cn/mmbiz_png/mjl8GCpsL9auhKTS8YiaHLpE37Swaxib507nKmh4wYdAI1rwZdOGM7ozDxqWKY02LrA3BloKBk25FOyIJ5XDkrlA/640?wx_fmt=png&quot; data-type=&quot;png&quot; data-w=&quot;1314&quot;/&gt;&lt;/section&gt;&lt;/li&gt;&lt;/ul&gt;&lt;h2 data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;5 CCR 跨集群复制&lt;/span&gt;&lt;/h2&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;Elasticsearch 6.7 版本中引入跨集群复制（CCR,  Cross-Cluster Replication）功能，支持将指定的索引从一个 Elasticsearch 集群复制到一个或多个 Elasticsearch 集群。跨集群复制属于 Elastic Stack 的白金版（PLATINUM）付费功能，需要额外付费才可以使用，关于 Elastic Stack 订阅模式参见 &lt;/span&gt;&lt;span&gt;Elastic Stack 订阅&lt;/span&gt;&lt;span&gt;。&lt;/span&gt;&lt;/p&gt;&lt;figure data-tool=&quot;mdnice编辑器&quot;&gt;&lt;img class=&quot;rich_pages wxw-img&quot; data-ratio=&quot;0.6397449521785334&quot; data-src=&quot;https://mmbiz.qpic.cn/mmbiz_png/mjl8GCpsL9auhKTS8YiaHLpE37Swaxib50MfVmD8uNTcua5ZV8CvxzZwwNo95k9icwdy2qqVUIPJjmyJAiaKe20dOg/640?wx_fmt=png&quot; data-type=&quot;png&quot; data-w=&quot;2823&quot;/&gt;&lt;/figure&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;跨集群复制使用主动-被动模型（active-passive model），复制更改的索引称为“追随者索引”（follower Index），被复制的索引称为“领导者索引”（leader index）。当 leader index 收到写入时，follower index 会从远程集群上的 leader index 上基于文档操作实现订阅复制。当配置复制规则时，可以指定特定的索引进行复制；也可以通过 auto-follow pattern 以通配符的形式自动匹配多个索引，创建复制规则后新创建的索引也会自动匹配。&lt;/span&gt;&lt;img class=&quot;rich_pages wxw-img&quot; data-ratio=&quot;0.5548780487804879&quot; data-src=&quot;https://mmbiz.qpic.cn/mmbiz_png/mjl8GCpsL9auhKTS8YiaHLpE37Swaxib50grIjV5dRnQT1ApCYmciacAianxqIw8mHFA3pBFPlxRZ2M7Se73Sfvy1Q/640?wx_fmt=png&quot; data-type=&quot;png&quot; data-w=&quot;820&quot;/&gt;&lt;/p&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;follower index 是被动的，它可以服务于读取请求，但不能接受写入请求，只有 leader index 可以接受写入请求。当主集群发生宕机时，如果我们想让在备集群中的 follower index 接管服务，允许进行写入请求，需要依次暂停索引的复制，关闭索引，取消跟随 leader index，最后将其重新打开为普通的索引，整套操作下来非常复杂，而且无法进行回切，这也是 CCR 跨集群复制最大的一个问题。&lt;/span&gt;&lt;/p&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;针对上述问题，这里也提供了一种解决方案，那就是双向复制（CCR bi-directional replication）。如下图所示，我们可以在集群 cluster01 上创建索引 &lt;/span&gt;&lt;code&gt;&lt;span&gt;logs-cluster01&lt;/span&gt;&lt;/code&gt;&lt;span&gt;，并在集群 cluster02 上复制该索引；在集群 cluster02 上创建索引 &lt;/span&gt;&lt;code&gt;&lt;span&gt;logs-cluster02&lt;/span&gt;&lt;/code&gt;&lt;span&gt; ，并在集群 cluster01 上复制该索引。然后在两个集群上创建别名 &lt;/span&gt;&lt;code&gt;&lt;span&gt;logs&lt;/span&gt;&lt;/code&gt;&lt;span&gt;  指向索引 &lt;/span&gt;&lt;code&gt;&lt;span&gt;logs-cluster01&lt;/span&gt;&lt;/code&gt;&lt;span&gt; 和 &lt;/span&gt;&lt;code&gt;&lt;span&gt;logs-cluster02&lt;/span&gt;&lt;/code&gt;&lt;span&gt;，对外可以提供统一的索引名。别名指向的多个索引中，只能有一个索引是允许接收写入请求的，在 cluster01 将索引 &lt;/span&gt;&lt;code&gt;&lt;span&gt;logs-cluster01&lt;/span&gt;&lt;/code&gt;&lt;span&gt; 设置为可写，&lt;/span&gt;&lt;code&gt;&lt;span&gt;logs-cluster02&lt;/span&gt;&lt;/code&gt;&lt;span&gt; 索引中的数据将会通过 CCR 跨集群复制从集群 cluster02 中获取；集群 cluster02 的别名设置相反。通过以上设置，应用程序在读写的时候都往 &lt;/span&gt;&lt;code&gt;&lt;span&gt;logs&lt;/span&gt;&lt;/code&gt;&lt;span&gt;  别名发送请求，假设当集群 cluster01 不可用时，我们可以继续使用集群 cluster02，并且依然是往 &lt;/span&gt;&lt;code&gt;&lt;span&gt;logs&lt;/span&gt;&lt;/code&gt;&lt;span&gt; 别名发送请求，无需手动进行切换操作；当集群 cluster01 恢复后，会从上次记录的 checkpoint 继续从集群 cluster02 复制数据，也无需额外的切换操作。&lt;/span&gt;&lt;/p&gt;&lt;figure data-tool=&quot;mdnice编辑器&quot;&gt;&lt;img class=&quot;rich_pages wxw-img&quot; data-ratio=&quot;0.3148614609571788&quot; data-src=&quot;https://mmbiz.qpic.cn/mmbiz_png/mjl8GCpsL9auhKTS8YiaHLpE37Swaxib50QFNa9xBM3rgAHjDplmkDvrwFiaPI1OTicggvyT6LmibXRtEals38Gvtdg/640?wx_fmt=png&quot; data-type=&quot;png&quot; data-w=&quot;1588&quot;/&gt;&lt;/figure&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;下图是双机房部署的一个整体架构图，在两个机房以双活的形式各部署一套 Elasticsearch 集群，同时对外提供服务，两个 Elasticsearch 集群配置 CCR 双向复制。机房之间的网络通过专线打通，用于承载 CCR 跨集群复制以及业务应用跨机房访问 Elasticsearch 集群的流量。业务应用的读写请求优先访问本机房的 Elasticsearch 集群，当本机房的集群出现不可用时，访问备机房的 Elasticsearch 集群。在公网部署一套智能 DNS 服务，根据用户的 IP 地址将域名解析到邻近用户机房的公网 IP，当整个机房出现故障时，才将域名解析到备机房的公网 IP。&lt;/span&gt;&lt;/p&gt;&lt;figure data-tool=&quot;mdnice编辑器&quot;&gt;&lt;img class=&quot;rich_pages wxw-img&quot; data-ratio=&quot;0.5452522255192879&quot; data-src=&quot;https://mmbiz.qpic.cn/mmbiz_png/mjl8GCpsL9auhKTS8YiaHLpE37Swaxib50Tgj88jxNvZqDTpJJLzgecKql9W0gdQAiaDYibzvWGuVdpoVtLZWP4xMg/640?wx_fmt=png&quot; data-type=&quot;png&quot; data-w=&quot;2696&quot;/&gt;&lt;/figure&gt;&lt;h2 data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;6 应用双写&lt;/span&gt;&lt;/h2&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;应用双写的做法就是应用程序直接将数据同时写入两个 Elasticsearch 集群，这样做的缺点比较明显：&lt;/span&gt;&lt;/p&gt;&lt;ul data-tool=&quot;mdnice编辑器&quot; class=&quot;list-paddingleft-2&quot;&gt;&lt;li&gt;&lt;section&gt;&lt;span&gt;1.一致性差，应用双写并非原子操作，假设上海机房的 Elasticsearch 集群写成功了，然而北京机房的 Elasticsearch 集群没写成功，将造成两个集群的数据不一致。&lt;/span&gt;&lt;/section&gt;&lt;/li&gt;&lt;li&gt;&lt;section&gt;&lt;span&gt;2.假设北京机房的 Elasticsearch 集群宕机了，过一段时间集群又恢复了，在故障期间的数据将会丢失。&lt;/span&gt;&lt;/section&gt;&lt;/li&gt;&lt;li&gt;&lt;section&gt;&lt;span&gt;3.每次写入请求都要跨机房处理，将会增加网络延迟。&lt;/span&gt;&lt;/section&gt;&lt;/li&gt;&lt;/ul&gt;&lt;figure data-tool=&quot;mdnice编辑器&quot;&gt;&lt;img class=&quot;rich_pages wxw-img&quot; data-ratio=&quot;0.5791190864600326&quot; data-src=&quot;https://mmbiz.qpic.cn/mmbiz_png/mjl8GCpsL9auhKTS8YiaHLpE37Swaxib50cKxKfsScQLHic24ibEUXib7e8VpBZTzzkqWk7GVcqgBpibCYPnDHZMmzpw/640?wx_fmt=png&quot; data-type=&quot;png&quot; data-w=&quot;1839&quot;/&gt;&lt;/figure&gt;&lt;h2 data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;7 借助消息队列实现双写&lt;/span&gt;&lt;/h2&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;借助消息队列实现双写是应用双写方案的改进版，借助消息队列（例如 Kafka，Pulsar）实现双写。应用程序优先将数据写入本机房的消息队列，当本机房的消息队列不可用时，才通过专线写入备机房的消息队列；应用程序在查询数据的时候优先访问本机房的 Elasticsearch 集群，当本机房的集群不可用时，才访问备机房的 Elasticsearch 集群。两个机房消息队列间的数据通过消息队列的跨集群复制保持最终一致。在下游通过消费者程序消费本机房消息队列中的数据，然后写入 Elasticsearch 集群中，当 Elasticsearch 集群数据写入失败或者宕机时，消费者程序要有相应的重试或者异常处理机制。当消费者程序挂掉时，数据会暂停写入 Elasticsearch 集群，消息队列会有 offset 记录消费者消费的进度，当消费者程序恢复后，可以从上一次的 offset 继续消费消息。&lt;/span&gt;&lt;/p&gt;&lt;figure data-tool=&quot;mdnice编辑器&quot;&gt;&lt;img class=&quot;rich_pages wxw-img&quot; data-ratio=&quot;0.6220472440944882&quot; data-src=&quot;https://mmbiz.qpic.cn/mmbiz_png/mjl8GCpsL9auhKTS8YiaHLpE37Swaxib50YCRz8OJX5OKHjNGdJbriadGW5G7NZk4EKrSZQiaGsp6icnoOUgZbbH0aA/640?wx_fmt=png&quot; data-type=&quot;png&quot; data-w=&quot;2540&quot;/&gt;&lt;/figure&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;借助消息队列实现双写的好处就是数据可靠性高，不易丢失，诸如 Kafka，Pulsar 这类消息队列都有完善的跨集群复制方案。缺点是引入了额外的消息队列组件，增加了维护难度，消费者程序的开发也要投入额外的精力，另外在请求链路上也会带来一定的延迟。&lt;/span&gt;&lt;/p&gt;&lt;h2 data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;8 极限网关&lt;/span&gt;&lt;/h2&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;&lt;strong&gt;极限网关&lt;/strong&gt; (&lt;em&gt;INFINI Gateway&lt;/em&gt;) 是一个面向 Elasticsearch 的高性能应用网关，网关位于应用程序和  Elasticsearch 之间，应用程序将以往直接发送给 Elasticsearch 的请求都发送给网关，再由网关转发给请求到后端的 Elasticsearch 集群。网关对于应用程序而言是透明的，应用程序无需修改任何代码，就像访问 Elasticsearch 一样访问网关就可以。在网关上可以实现写入加速、查询加速、限速限流、流量监测、透明重试等一系列高级的功能。&lt;/span&gt;&lt;/p&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;我们可以使用极限网关透明处理主备集群的写入，进行无缝双写。写请求先同步写入主集群，当主集群写入成功以后，写入备集群的队列中，目前支持本地磁盘队列，未来将会支持 Kafka 作为队列。写入备集群的队列之后将会异步消费队列中的数据到备集群。当主集群不可用时，可以自动完成切换，将数据先同步写入原备集群，然后写入原主集群的队列，等待原主集群恢复后，再消费队列中的数据追加到原主集群中。&lt;/span&gt;&lt;/p&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;极限网关内置浮动 IP 功能，可以实现双机热备、故障转移的能力，提供高可用保障。当然也可以使用 F5, Nginx 等软硬件负载均衡设备下面挂多台极限网关实现高可用。相比于极限网关内置的浮动 IP 功能，使用 F5，Nginx 等负载均衡设备的方式会更加灵活，有 2 种方式实现高可用：&lt;/span&gt;&lt;/p&gt;&lt;ul data-tool=&quot;mdnice编辑器&quot; class=&quot;list-paddingleft-2&quot;&gt;&lt;li&gt;&lt;section&gt;&lt;p&gt;&lt;span&gt;1.让网关以主备的方式提供服务，正常情况下只将流量分发给其中一台网关，当网关故障时，才将流量切换到另一台。&lt;/span&gt;&lt;/p&gt;&lt;/section&gt;&lt;/li&gt;&lt;li&gt;&lt;section&gt;&lt;p&gt;&lt;span&gt;2.多台极限网关同时提供服务，提升网关的吞吐量，多台网关同时工作的情况下最好基于 URL 路由等方式确保相同索引的流量分发到同一个极限网关。&lt;/span&gt;&lt;/p&gt;&lt;/section&gt;&lt;/li&gt;&lt;/ul&gt;&lt;figure data-tool=&quot;mdnice编辑器&quot;&gt;&lt;img class=&quot;rich_pages wxw-img&quot; data-ratio=&quot;0.7486338797814208&quot; data-src=&quot;https://mmbiz.qpic.cn/mmbiz_png/mjl8GCpsL9auhKTS8YiaHLpE37Swaxib50ubqkudHyyicoHH2WqibC6DCk4rLN1u2TcxLOYTynjaRia5nLicSfnmjOwQ/640?wx_fmt=png&quot; data-type=&quot;png&quot; data-w=&quot;2013&quot;/&gt;&lt;/figure&gt;&lt;h2 data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;9 动手实验&lt;/span&gt;&lt;/h2&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;为了方便大家快速上手体验，我在 Github 上准备了 3 个 Demo 案例供大家使用。&lt;/span&gt;&lt;/p&gt;&lt;h3 data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;&lt;span&gt;9.1 克隆项目&lt;/span&gt;&lt;/span&gt;&lt;/h3&gt;&lt;pre data-tool=&quot;mdnice编辑器&quot;&gt;&lt;code&gt;&lt;span&gt;git &lt;span&gt;clone&lt;/span&gt; https://github.com/cr7258/elastic-stack-docker.git&lt;br/&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;在项目的 &lt;strong&gt;high-availability&lt;/strong&gt; 目录下有三个目录，分别对应 3 个实验项目：&lt;/span&gt;&lt;/p&gt;&lt;ul data-tool=&quot;mdnice编辑器&quot; class=&quot;list-paddingleft-2&quot;&gt;&lt;li&gt;&lt;section&gt;&lt;span&gt;ccr：跨集群复制&lt;/span&gt;&lt;/section&gt;&lt;/li&gt;&lt;li&gt;&lt;section&gt;&lt;span&gt;infini-gateway：极限网关&lt;/span&gt;&lt;/section&gt;&lt;/li&gt;&lt;li&gt;&lt;section&gt;&lt;span&gt;mq：借助消息队列实现双写&lt;/span&gt;&lt;/section&gt;&lt;/li&gt;&lt;/ul&gt;&lt;figure data-tool=&quot;mdnice编辑器&quot;&gt;&lt;img class=&quot;rich_pages wxw-img&quot; data-ratio=&quot;0.2775297619047619&quot; data-src=&quot;https://mmbiz.qpic.cn/mmbiz_png/mjl8GCpsL9auhKTS8YiaHLpE37Swaxib50FtnicAia7Iew2ugKaiaqyqSqa77rNM8fa9icLPoia8qgwCzuEQiaQoN4svdA/640?wx_fmt=png&quot; data-type=&quot;png&quot; data-w=&quot;1344&quot;/&gt;&lt;/figure&gt;&lt;h3 data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;&lt;span&gt;9.2 环境准备&lt;/span&gt;&lt;/span&gt;&lt;/h3&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;本次实验的环境使用 Docker 运行，需要先安装好 Docker 和 Docker Compose 工具。&lt;/span&gt;&lt;/p&gt;&lt;h4 data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;9.2.1 安装 Docker&lt;/span&gt;&lt;/h4&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;关于不同平台 Docker 的安装文档参见 &lt;/span&gt;&lt;span&gt;Install Docker Engine&lt;/span&gt;&lt;span&gt;。使用以下命令在 Centos 操作系统安装 Docker。&lt;/span&gt;&lt;/p&gt;&lt;pre data-tool=&quot;mdnice编辑器&quot;&gt;&lt;code&gt;&lt;span&gt;sudo yum install -y yum-utils&lt;br/&gt;sudo yum-config-manager \&lt;br/&gt;   -- add-repo \&lt;br/&gt;   http://mirrors.aliyun.com/repo/Centos-7.repo&lt;br/&gt;sudo yum-config-manager \&lt;br/&gt;    --add-repo \&lt;br/&gt;    https://download.docker.com/linux/centos/docker-ce.repo&lt;br/&gt;sudo yum -y install slirp4netns fuse-overlayfs container-selinux&lt;br/&gt;sudo yum install -y docker-ce docker-ce-cli containerd.io&lt;br/&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;使用以下命令启动 Docker 并设置开机自动启动。&lt;/span&gt;&lt;/p&gt;&lt;pre data-tool=&quot;mdnice编辑器&quot;&gt;&lt;code&gt;&lt;span&gt;systemctl start docker &lt;br/&gt;systemctl &lt;span&gt;enable&lt;/span&gt; docker&lt;br/&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;查看 Docker 进程状态。&lt;/span&gt;&lt;/p&gt;&lt;pre data-tool=&quot;mdnice编辑器&quot;&gt;&lt;code&gt;&lt;span&gt;root@ydt-net-demo01:/etc/yum.repos.d &lt;span&gt;#systemctl status docker &lt;/span&gt;&lt;br/&gt;● docker.service - Docker Application Container Engine&lt;br/&gt;   Loaded: loaded (/usr/lib/systemd/system/docker.service; enabled; vendor preset: disabled)&lt;br/&gt;   Active: active (running) since Mon 2021-12-27 10:55:20 CST; 12s ago&lt;br/&gt;     Docs: https://docs.docker.com&lt;br/&gt; Main PID: 11269 (dockerd)&lt;br/&gt;   CGroup: /system.slice/docker.service&lt;br/&gt;           └─11269 /usr/bin/dockerd -H fd:// --containerd=/run/containerd/containerd.sock&lt;br/&gt;&lt;br/&gt;Dec 27 10:55:20 ydt-net-demo01 dockerd[11269]: time=&lt;span&gt;&quot;2021-12-27T10:55:20.538010109+08:00&quot;&lt;/span&gt; level=info msg=&lt;span&gt;&quot;scheme \&quot;unix\&quot; not registered, fallback to def...dule=grpcDec 27 10:55:20 ydt-net-demo01 dockerd[11269]: time=&quot;&lt;/span&gt;2021-12-27T10:55:20.538029901+08:00&lt;span&gt;&quot; level=info msg=&quot;&lt;/span&gt;ccResolverWrapper: sending update to cc: {[{uni...dule=grpcDec 27 10:55:20 ydt-net-demo01 dockerd[11269]: time=&lt;span&gt;&quot;2021-12-27T10:55:20.538042682+08:00&quot;&lt;/span&gt; level=info msg=&lt;span&gt;&quot;ClientConn switching balancer to \&quot;pick_first\&quot;...dule=grpcDec 27 10:55:20 ydt-net-demo01 dockerd[11269]: time=&quot;&lt;/span&gt;2021-12-27T10:55:20.587575323+08:00&lt;span&gt;&quot; level=info msg=&quot;&lt;/span&gt;Loading containers: start.&lt;span&gt;&quot;&lt;br/&gt;Dec 27 10:55:20 ydt-net-demo01 dockerd[11269]: time=&quot;&lt;/span&gt;2021-12-27T10:55:20.745332083+08:00&lt;span&gt;&quot; level=info msg=&quot;&lt;/span&gt;Default bridge (docker0) is assigned with an IP... address&lt;span&gt;&quot;Dec 27 10:55:20 ydt-net-demo01 dockerd[11269]: time=&quot;&lt;/span&gt;2021-12-27T10:55:20.806689912+08:00&lt;span&gt;&quot; level=info msg=&quot;&lt;/span&gt;Loading containers: &lt;span&gt;done&lt;/span&gt;.&lt;span&gt;&quot;&lt;br/&gt;Dec 27 10:55:20 ydt-net-demo01 dockerd[11269]: time=&quot;&lt;/span&gt;2021-12-27T10:55:20.826460585+08:00&lt;span&gt;&quot; level=info msg=&quot;&lt;/span&gt;Docker daemon&lt;span&gt;&quot; commit=459d0df graphdriver(s)=ov...=20.10.12Dec 27 10:55:20 ydt-net-demo01 dockerd[11269]: time=&quot;&lt;/span&gt;2021-12-27T10:55:20.826606042+08:00&lt;span&gt;&quot; level=info msg=&quot;&lt;/span&gt;Daemon has completed initialization&lt;span&gt;&quot;&lt;br/&gt;Dec 27 10:55:20 ydt-net-demo01 systemd[1]: Started Docker Application Container Engine.&lt;br/&gt;Dec 27 10:55:20 ydt-net-demo01 dockerd[11269]: time=&quot;&lt;/span&gt;2021-12-27T10:55:20.876018043+08:00&lt;span&gt;&quot; level=info msg=&quot;&lt;/span&gt;API listen on /var/run/docker.sock&lt;span&gt;&quot;&lt;br/&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;查看 Docker 版本。&lt;/span&gt;&lt;/p&gt;&lt;pre data-tool=&quot;mdnice编辑器&quot;&gt;&lt;code&gt;&lt;span&gt;root@ydt-net-demo01:/software/elastic-stack-docker/high-availability/ccr &lt;span&gt;#docker version&lt;/span&gt;&lt;br/&gt;Client: Docker Engine - Community&lt;br/&gt; Version:           20.10.12&lt;br/&gt; API version:       1.41&lt;br/&gt; Go version:        go1.16.12&lt;br/&gt; Git commit:        e91ed57&lt;br/&gt; Built:             Mon Dec 13 11:45:41 2021&lt;br/&gt; OS/Arch:           linux/amd64&lt;br/&gt; Context:           default&lt;br/&gt; Experimental:      &lt;span&gt;true&lt;/span&gt;&lt;br/&gt;&lt;br/&gt;Server: Docker Engine - Community&lt;br/&gt; Engine:&lt;br/&gt;  Version:          20.10.12&lt;br/&gt;  API version:      1.41 (minimum version 1.12)&lt;br/&gt;  Go version:       go1.16.12&lt;br/&gt;  Git commit:       459d0df&lt;br/&gt;  Built:            Mon Dec 13 11:44:05 2021&lt;br/&gt;  OS/Arch:          linux/amd64&lt;br/&gt;  Experimental:     &lt;span&gt;false&lt;/span&gt;&lt;br/&gt; containerd:&lt;br/&gt;  Version:          1.4.12&lt;br/&gt;  GitCommit:        7b11cfaabd73bb80907dd23182b9347b4245eb5d&lt;br/&gt; runc:&lt;br/&gt;  Version:          1.0.2&lt;br/&gt;  GitCommit:        v1.0.2-0-g52b36a2&lt;br/&gt; docker-init:&lt;br/&gt;  Version:          0.19.0&lt;br/&gt;  GitCommit:        de40ad0&lt;br/&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;h4 data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;9.2.2 安装 Docker Compose&lt;/span&gt;&lt;/h4&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;关于 Docker-Compose 详细的安装文档参见 &lt;/span&gt;&lt;span&gt;Install Docker Compose&lt;/span&gt;&lt;span&gt;。使用以下命令在 Linux 系统上安装 Docker Compose。&lt;/span&gt;&lt;/p&gt;&lt;pre data-tool=&quot;mdnice编辑器&quot;&gt;&lt;code&gt;&lt;span&gt;sudo curl -L &lt;span&gt;&quot;https://github.com/docker/compose/releases/download/1.29.2/docker-compose-&lt;span&gt;$(uname -s)&lt;/span&gt;-&lt;span&gt;$(uname -m)&lt;/span&gt;&quot;&lt;/span&gt; -o /usr/&lt;span&gt;local&lt;/span&gt;/bin/docker-compose&lt;br/&gt;sudo chmod +x /usr/&lt;span&gt;local&lt;/span&gt;/bin/docker-compose&lt;br/&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;查看 Docker Compose 版本。&lt;/span&gt;&lt;/p&gt;&lt;pre data-tool=&quot;mdnice编辑器&quot;&gt;&lt;code&gt;&lt;span&gt;root@ydt-net-demo01:/etc/yum.repos.d &lt;span&gt;#docker-compose version&lt;/span&gt;&lt;br/&gt;docker-compose version 1.29.2, build 5becea4c&lt;br/&gt;docker-py version: 5.0.0&lt;br/&gt;CPython version: 3.7.10&lt;br/&gt;OpenSSL version: OpenSSL 1.1.0l  10 Sep 2019&lt;br/&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;h3 data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;&lt;span&gt;9.3 CCR 跨集群复制&lt;/span&gt;&lt;/span&gt;&lt;/h3&gt;&lt;h4 data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;9.3.1 环境准备&lt;/span&gt;&lt;/h4&gt;&lt;h5 data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;9.3.1.1 配置文件&lt;/span&gt;&lt;/h5&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;docker-compose.yml 文件如下所示。&lt;/span&gt;&lt;/p&gt;&lt;pre data-tool=&quot;mdnice编辑器&quot;&gt;&lt;code&gt;&lt;span&gt;&lt;span&gt;version:&lt;/span&gt; &lt;span&gt;&#x27;3.8&#x27;&lt;/span&gt;&lt;br/&gt;&lt;span&gt;services:&lt;/span&gt;&lt;br/&gt;  &lt;span&gt;# 集群 cluster01&lt;/span&gt;&lt;br/&gt;  &lt;span&gt;# Elasticsearch&lt;/span&gt;&lt;br/&gt;  &lt;span&gt;es01:&lt;/span&gt;&lt;br/&gt;    &lt;span&gt;image:&lt;/span&gt; &lt;span&gt;docker.elastic.co/elasticsearch/elasticsearch:7.16.2&lt;/span&gt;&lt;br/&gt;    &lt;span&gt;container_name:&lt;/span&gt; &lt;span&gt;es01&lt;/span&gt;&lt;br/&gt;    &lt;span&gt;environment:&lt;/span&gt;&lt;br/&gt;      &lt;span&gt;# 节点名&lt;/span&gt;&lt;br/&gt;      &lt;span&gt;-&lt;/span&gt; &lt;span&gt;node.name=es01&lt;/span&gt;&lt;br/&gt;      &lt;span&gt;# 集群名&lt;/span&gt;&lt;br/&gt;      &lt;span&gt;-&lt;/span&gt; &lt;span&gt;cluster.name=cluster01&lt;/span&gt;&lt;br/&gt;      &lt;span&gt;# 指定单节点启动&lt;/span&gt;&lt;br/&gt;      &lt;span&gt;-&lt;/span&gt; &lt;span&gt;discovery.type=single-node&lt;/span&gt;&lt;br/&gt;      &lt;span&gt;# 开启内存锁定&lt;/span&gt;&lt;br/&gt;      &lt;span&gt;-&lt;/span&gt; &lt;span&gt;bootstrap.memory_lock=true&lt;/span&gt;&lt;br/&gt;      &lt;span&gt;# 设置内存大小&lt;/span&gt;&lt;br/&gt;      &lt;span&gt;-&lt;/span&gt; &lt;span&gt;&quot;ES_JAVA_OPTS=-Xms2g -Xmx2g&quot;&lt;/span&gt;&lt;br/&gt;      &lt;span&gt;# 启用安全&lt;/span&gt;&lt;br/&gt;      &lt;span&gt;-&lt;/span&gt; &lt;span&gt;xpack.security.enabled=true&lt;/span&gt;&lt;br/&gt;      &lt;span&gt;# 设置 elastic 用户密码&lt;/span&gt;&lt;br/&gt;      &lt;span&gt;-&lt;/span&gt; &lt;span&gt;ELASTIC_PASSWORD=test123&lt;/span&gt;&lt;br/&gt;    &lt;span&gt;ulimits:&lt;/span&gt;&lt;br/&gt;      &lt;span&gt;memlock:&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;soft:&lt;/span&gt; &lt;span&gt;-1&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;hard:&lt;/span&gt; &lt;span&gt;-1&lt;/span&gt;&lt;br/&gt;    &lt;span&gt;# 映射到主机名的端口 宿主机端口:容器端口&lt;/span&gt;&lt;br/&gt;    &lt;span&gt;ports:&lt;/span&gt;&lt;br/&gt;      &lt;span&gt;-&lt;/span&gt; &lt;span&gt;9200&lt;/span&gt;&lt;span&gt;:9200&lt;/span&gt;&lt;br/&gt;    &lt;span&gt;volumes:&lt;/span&gt;&lt;br/&gt;      &lt;span&gt;-&lt;/span&gt; &lt;span&gt;data01:/usr/share/elasticsearch/data&lt;/span&gt;&lt;br/&gt;    &lt;span&gt;networks:&lt;/span&gt;&lt;br/&gt;      &lt;span&gt;-&lt;/span&gt; &lt;span&gt;elastic&lt;/span&gt;&lt;br/&gt;  &lt;span&gt;# Kibana&lt;/span&gt;&lt;br/&gt;  &lt;span&gt;kib01:&lt;/span&gt;&lt;br/&gt;    &lt;span&gt;image:&lt;/span&gt; &lt;span&gt;docker.elastic.co/kibana/kibana:7.16.2&lt;/span&gt;&lt;br/&gt;    &lt;span&gt;container_name:&lt;/span&gt; &lt;span&gt;kib01&lt;/span&gt;&lt;br/&gt;    &lt;span&gt;ports:&lt;/span&gt;&lt;br/&gt;      &lt;span&gt;-&lt;/span&gt; &lt;span&gt;5601&lt;/span&gt;&lt;span&gt;:5601&lt;/span&gt;&lt;br/&gt;    &lt;span&gt;environment:&lt;/span&gt;&lt;br/&gt;      &lt;span&gt;# Elasticsearch 连接信息&lt;/span&gt;&lt;br/&gt;      &lt;span&gt;ELASTICSEARCH_URL:&lt;/span&gt; &lt;span&gt;http://es01:9200&lt;/span&gt;&lt;br/&gt;      &lt;span&gt;ELASTICSEARCH_HOSTS:&lt;/span&gt; &lt;span&gt;&#x27;[&quot;http://es01:9200&quot;]&#x27;&lt;/span&gt;&lt;br/&gt;      &lt;span&gt;ELASTICSEARCH_USERNAME:&lt;/span&gt; &lt;span&gt;elastic&lt;/span&gt;&lt;br/&gt;      &lt;span&gt;ELASTICSEARCH_PASSWORD:&lt;/span&gt; &lt;span&gt;test123&lt;/span&gt;&lt;br/&gt;    &lt;span&gt;networks:&lt;/span&gt;&lt;br/&gt;      &lt;span&gt;-&lt;/span&gt; &lt;span&gt;elastic&lt;/span&gt;&lt;br/&gt;&lt;br/&gt;  &lt;span&gt;# 集群 cluster2&lt;/span&gt;&lt;br/&gt;  &lt;span&gt;es02:&lt;/span&gt;&lt;br/&gt;    &lt;span&gt;image:&lt;/span&gt; &lt;span&gt;docker.elastic.co/elasticsearch/elasticsearch:7.16.2&lt;/span&gt;&lt;br/&gt;    &lt;span&gt;container_name:&lt;/span&gt; &lt;span&gt;es02&lt;/span&gt;&lt;br/&gt;    &lt;span&gt;environment:&lt;/span&gt;&lt;br/&gt;      &lt;span&gt;-&lt;/span&gt; &lt;span&gt;node.name=es02&lt;/span&gt;&lt;br/&gt;      &lt;span&gt;-&lt;/span&gt; &lt;span&gt;cluster.name=cluster02&lt;/span&gt;&lt;br/&gt;      &lt;span&gt;-&lt;/span&gt; &lt;span&gt;discovery.type=single-node&lt;/span&gt;&lt;br/&gt;      &lt;span&gt;-&lt;/span&gt; &lt;span&gt;bootstrap.memory_lock=true&lt;/span&gt;&lt;br/&gt;      &lt;span&gt;-&lt;/span&gt; &lt;span&gt;&quot;ES_JAVA_OPTS=-Xms2g -Xmx2g&quot;&lt;/span&gt;&lt;br/&gt;      &lt;span&gt;-&lt;/span&gt; &lt;span&gt;xpack.security.enabled=true&lt;/span&gt;&lt;br/&gt;      &lt;span&gt;-&lt;/span&gt; &lt;span&gt;ELASTIC_PASSWORD=test123&lt;/span&gt;&lt;br/&gt;    &lt;span&gt;ulimits:&lt;/span&gt;&lt;br/&gt;      &lt;span&gt;memlock:&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;soft:&lt;/span&gt; &lt;span&gt;-1&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;hard:&lt;/span&gt; &lt;span&gt;-1&lt;/span&gt;&lt;br/&gt;    &lt;span&gt;ports:&lt;/span&gt;&lt;br/&gt;      &lt;span&gt;-&lt;/span&gt; &lt;span&gt;9201&lt;/span&gt;&lt;span&gt;:9200&lt;/span&gt;&lt;br/&gt;    &lt;span&gt;volumes:&lt;/span&gt;&lt;br/&gt;      &lt;span&gt;-&lt;/span&gt; &lt;span&gt;data02:/usr/share/elasticsearch/data&lt;/span&gt;&lt;br/&gt;    &lt;span&gt;networks:&lt;/span&gt;&lt;br/&gt;      &lt;span&gt;-&lt;/span&gt; &lt;span&gt;elastic&lt;/span&gt;&lt;br/&gt;&lt;br/&gt;  &lt;span&gt;kib02:&lt;/span&gt;&lt;br/&gt;    &lt;span&gt;image:&lt;/span&gt; &lt;span&gt;docker.elastic.co/kibana/kibana:7.16.2&lt;/span&gt;&lt;br/&gt;    &lt;span&gt;container_name:&lt;/span&gt; &lt;span&gt;kib02&lt;/span&gt;&lt;br/&gt;    &lt;span&gt;ports:&lt;/span&gt;&lt;br/&gt;      &lt;span&gt;-&lt;/span&gt; &lt;span&gt;5602&lt;/span&gt;&lt;span&gt;:5601&lt;/span&gt;&lt;br/&gt;    &lt;span&gt;environment:&lt;/span&gt;&lt;br/&gt;      &lt;span&gt;ELASTICSEARCH_URL:&lt;/span&gt; &lt;span&gt;http://es02:9200&lt;/span&gt;&lt;br/&gt;      &lt;span&gt;ELASTICSEARCH_HOSTS:&lt;/span&gt; &lt;span&gt;&#x27;[&quot;http://es02:9200&quot;]&#x27;&lt;/span&gt;&lt;br/&gt;      &lt;span&gt;ELASTICSEARCH_USERNAME:&lt;/span&gt; &lt;span&gt;elastic&lt;/span&gt;&lt;br/&gt;      &lt;span&gt;ELASTICSEARCH_PASSWORD:&lt;/span&gt; &lt;span&gt;test123&lt;/span&gt;&lt;br/&gt;    &lt;span&gt;networks:&lt;/span&gt;&lt;br/&gt;      &lt;span&gt;-&lt;/span&gt; &lt;span&gt;elastic&lt;/span&gt;&lt;br/&gt;&lt;br/&gt;&lt;span&gt;# 存储卷&lt;/span&gt;&lt;br/&gt;&lt;span&gt;volumes:&lt;/span&gt;&lt;br/&gt;  &lt;span&gt;data01:&lt;/span&gt;&lt;br/&gt;    &lt;span&gt;driver:&lt;/span&gt; &lt;span&gt;local&lt;/span&gt;&lt;br/&gt;  &lt;span&gt;data02:&lt;/span&gt;&lt;br/&gt;    &lt;span&gt;driver:&lt;/span&gt; &lt;span&gt;local&lt;/span&gt;&lt;br/&gt;&lt;br/&gt;&lt;span&gt;# 网络&lt;/span&gt;&lt;br/&gt;&lt;span&gt;networks:&lt;/span&gt;&lt;br/&gt;  &lt;span&gt;elastic:&lt;/span&gt;&lt;br/&gt;    &lt;span&gt;driver:&lt;/span&gt; &lt;span&gt;bridge&lt;/span&gt;&lt;br/&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;h5 data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;9.3.1.2 启动容器&lt;/span&gt;&lt;/h5&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;进入 CCR 实验目录，启动容器。&lt;/span&gt;&lt;/p&gt;&lt;pre data-tool=&quot;mdnice编辑器&quot;&gt;&lt;code&gt;&lt;span&gt;&lt;span&gt;cd&lt;/span&gt; ccr&lt;br/&gt;docker-compose up -d&lt;br/&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;查看容器状态。&lt;/span&gt;&lt;/p&gt;&lt;pre data-tool=&quot;mdnice编辑器&quot;&gt;&lt;code&gt;&lt;span&gt;$ docker-compose ps&lt;br/&gt;Name               Command               State                         Ports                       &lt;br/&gt;---------------------------------------------------------------------------------------------------&lt;br/&gt;es01    /bin/tini -- /usr/&lt;span&gt;local&lt;/span&gt;/bi ...   Up      0.0.0.0:9200-&amp;gt;9200/tcp,:::9200-&amp;gt;9200/tcp, 9300/tcp&lt;br/&gt;es02    /bin/tini -- /usr/&lt;span&gt;local&lt;/span&gt;/bi ...   Up      0.0.0.0:9201-&amp;gt;9200/tcp,:::9201-&amp;gt;9200/tcp, 9300/tcp&lt;br/&gt;kib01   /bin/tini -- /usr/&lt;span&gt;local&lt;/span&gt;/bi ...   Up      0.0.0.0:5601-&amp;gt;5601/tcp,:::5601-&amp;gt;5601/tcp          &lt;br/&gt;kib02   /bin/tini -- /usr/&lt;span&gt;local&lt;/span&gt;/bi ...   Up      0.0.0.0:5602-&amp;gt;5601/tcp,:::5602-&amp;gt;5601/tcp &lt;br/&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;浏览器分别通过 http://11.8.36.25:5601 和 http://11.8.36.25:5602 登录集群 cluster01 和集群 cluster02 的 Kibana 界面。用户名 elastic，密码 test123。&lt;/span&gt;&lt;/p&gt;&lt;figure data-tool=&quot;mdnice编辑器&quot;&gt;&lt;img class=&quot;rich_pages wxw-img&quot; data-ratio=&quot;0.4738562091503268&quot; data-src=&quot;https://mmbiz.qpic.cn/mmbiz_png/mjl8GCpsL9auhKTS8YiaHLpE37Swaxib50suppZW4ZtKPDnwapicds9MgZ1MCI4bykCkadZNy2neib1WxH3uCL59Xw/640?wx_fmt=png&quot; data-type=&quot;png&quot; data-w=&quot;1530&quot;/&gt;&lt;/figure&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;分别在 Kibana 上查看两个集群的信息。&lt;/span&gt;&lt;/p&gt;&lt;pre data-tool=&quot;mdnice编辑器&quot;&gt;&lt;code&gt;&lt;span&gt;&lt;span&gt;# 查看集群 cluster01&lt;/span&gt;&lt;br/&gt;GET /&lt;br/&gt;&lt;br/&gt;&lt;span&gt;# 返回结果&lt;/span&gt;&lt;br/&gt;{&lt;br/&gt;  &lt;span&gt;&quot;name&quot;&lt;/span&gt; : &lt;span&gt;&quot;es01&quot;&lt;/span&gt;,&lt;br/&gt;  &lt;span&gt;&quot;cluster_name&quot;&lt;/span&gt; : &lt;span&gt;&quot;cluster01&quot;&lt;/span&gt;,&lt;br/&gt;  &lt;span&gt;&quot;cluster_uuid&quot;&lt;/span&gt; : &lt;span&gt;&quot;ghl1eSfoRIegzMaVlBNSng&quot;&lt;/span&gt;,&lt;br/&gt;  &lt;span&gt;&quot;version&quot;&lt;/span&gt; : {&lt;br/&gt;    &lt;span&gt;&quot;number&quot;&lt;/span&gt; : &lt;span&gt;&quot;7.16.2&quot;&lt;/span&gt;,&lt;br/&gt;    &lt;span&gt;&quot;build_flavor&quot;&lt;/span&gt; : &lt;span&gt;&quot;default&quot;&lt;/span&gt;,&lt;br/&gt;    &lt;span&gt;&quot;build_type&quot;&lt;/span&gt; : &lt;span&gt;&quot;docker&quot;&lt;/span&gt;,&lt;br/&gt;    &lt;span&gt;&quot;build_hash&quot;&lt;/span&gt; : &lt;span&gt;&quot;2b937c44140b6559905130a8650c64dbd0879cfb&quot;&lt;/span&gt;,&lt;br/&gt;    &lt;span&gt;&quot;build_date&quot;&lt;/span&gt; : &lt;span&gt;&quot;2021-12-18T19:42:46.604893745Z&quot;&lt;/span&gt;,&lt;br/&gt;    &lt;span&gt;&quot;build_snapshot&quot;&lt;/span&gt; : &lt;span&gt;false&lt;/span&gt;,&lt;br/&gt;    &lt;span&gt;&quot;lucene_version&quot;&lt;/span&gt; : &lt;span&gt;&quot;8.10.1&quot;&lt;/span&gt;,&lt;br/&gt;    &lt;span&gt;&quot;minimum_wire_compatibility_version&quot;&lt;/span&gt; : &lt;span&gt;&quot;6.8.0&quot;&lt;/span&gt;,&lt;br/&gt;    &lt;span&gt;&quot;minimum_index_compatibility_version&quot;&lt;/span&gt; : &lt;span&gt;&quot;6.0.0-beta1&quot;&lt;/span&gt;&lt;br/&gt;  },&lt;br/&gt;  &lt;span&gt;&quot;tagline&quot;&lt;/span&gt; : &lt;span&gt;&quot;You Know, for Search&quot;&lt;/span&gt;&lt;br/&gt;}&lt;br/&gt;&lt;br/&gt;&lt;br/&gt;&lt;span&gt;# 查看集群 cluster02&lt;/span&gt;&lt;br/&gt;GET /&lt;br/&gt;&lt;br/&gt;&lt;span&gt;# 返回结果&lt;/span&gt;&lt;br/&gt;{&lt;br/&gt;  &lt;span&gt;&quot;name&quot;&lt;/span&gt; : &lt;span&gt;&quot;es02&quot;&lt;/span&gt;,&lt;br/&gt;  &lt;span&gt;&quot;cluster_name&quot;&lt;/span&gt; : &lt;span&gt;&quot;cluster02&quot;&lt;/span&gt;,&lt;br/&gt;  &lt;span&gt;&quot;cluster_uuid&quot;&lt;/span&gt; : &lt;span&gt;&quot;u0ph2Sl7TKeWQd-Nps5QyA&quot;&lt;/span&gt;,&lt;br/&gt;  &lt;span&gt;&quot;version&quot;&lt;/span&gt; : {&lt;br/&gt;    &lt;span&gt;&quot;number&quot;&lt;/span&gt; : &lt;span&gt;&quot;7.16.2&quot;&lt;/span&gt;,&lt;br/&gt;    &lt;span&gt;&quot;build_flavor&quot;&lt;/span&gt; : &lt;span&gt;&quot;default&quot;&lt;/span&gt;,&lt;br/&gt;    &lt;span&gt;&quot;build_type&quot;&lt;/span&gt; : &lt;span&gt;&quot;docker&quot;&lt;/span&gt;,&lt;br/&gt;    &lt;span&gt;&quot;build_hash&quot;&lt;/span&gt; : &lt;span&gt;&quot;2b937c44140b6559905130a8650c64dbd0879cfb&quot;&lt;/span&gt;,&lt;br/&gt;    &lt;span&gt;&quot;build_date&quot;&lt;/span&gt; : &lt;span&gt;&quot;2021-12-18T19:42:46.604893745Z&quot;&lt;/span&gt;,&lt;br/&gt;    &lt;span&gt;&quot;build_snapshot&quot;&lt;/span&gt; : &lt;span&gt;false&lt;/span&gt;,&lt;br/&gt;    &lt;span&gt;&quot;lucene_version&quot;&lt;/span&gt; : &lt;span&gt;&quot;8.10.1&quot;&lt;/span&gt;,&lt;br/&gt;    &lt;span&gt;&quot;minimum_wire_compatibility_version&quot;&lt;/span&gt; : &lt;span&gt;&quot;6.8.0&quot;&lt;/span&gt;,&lt;br/&gt;    &lt;span&gt;&quot;minimum_index_compatibility_version&quot;&lt;/span&gt; : &lt;span&gt;&quot;6.0.0-beta1&quot;&lt;/span&gt;&lt;br/&gt;  },&lt;br/&gt;  &lt;span&gt;&quot;tagline&quot;&lt;/span&gt; : &lt;span&gt;&quot;You Know, for Search&quot;&lt;/span&gt;&lt;br/&gt;}&lt;br/&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;h5 data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;9.3.1.3 激活 License&lt;/span&gt;&lt;/h5&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;CCR 是 Elastic Stack 的白金版（PLATINUM）付费功能，可以激活 30 天免费试用体验 Elastic Stack 的付费功能。点击 &lt;strong&gt;Stack Management &amp;gt; License Management &amp;gt; Start a 30-day trail&lt;/strong&gt; 开启试用。&lt;/span&gt;&lt;/p&gt;&lt;figure data-tool=&quot;mdnice编辑器&quot;&gt;&lt;img class=&quot;rich_pages wxw-img&quot; data-ratio=&quot;0.5848563968668408&quot; data-src=&quot;https://mmbiz.qpic.cn/mmbiz_png/mjl8GCpsL9auhKTS8YiaHLpE37Swaxib50wFY8tUfPjZpBib1ntMvic8m1gibulrHlTdaESTkXVE2RKAtY8RibzOHe2g/640?wx_fmt=png&quot; data-type=&quot;png&quot; data-w=&quot;1532&quot;/&gt;&lt;/figure&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;激活成功后如下图所示。&lt;/span&gt;&lt;/p&gt;&lt;figure data-tool=&quot;mdnice编辑器&quot;&gt;&lt;img class=&quot;rich_pages wxw-img&quot; data-ratio=&quot;0.5631131458469588&quot; data-src=&quot;https://mmbiz.qpic.cn/mmbiz_png/mjl8GCpsL9auhKTS8YiaHLpE37Swaxib501HLQIDgVbpZhGBOCWyZCksXPCZwfnCiaUFLGOpiaWIAU59zDU8yMKATA/640?wx_fmt=png&quot; data-type=&quot;png&quot; data-w=&quot;1529&quot;/&gt;&lt;/figure&gt;&lt;h5 data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;9.3.1.4 开启软删除（7.0 版本以前需要）&lt;/span&gt;&lt;/h5&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;跨集群复制的工作原理是：重放对 leader  index 分片执行的单个写入操作的历史记录。Elasticsearch 需要在 leader index 的分片上保留这些操作的历史记录，以便它们可以被 follower index 的分片任务拉取，用于保留这些操作的底层机制是软删除。&lt;/span&gt;&lt;/p&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;Elasticsearch 7.0+ 之后版本已默认开启，无需单独配置。早期版本需要在 elasticsearch.yml 配置文件中通过静态参数进行配置。&lt;/span&gt;&lt;/p&gt;&lt;pre data-tool=&quot;mdnice编辑器&quot;&gt;&lt;code&gt;&lt;span&gt;index.soft_deletes.enabled:&lt;span&gt;true&lt;/span&gt;&lt;br/&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;h4 data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;9.3.2 连接远程集群&lt;/span&gt;&lt;/h4&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;在集群 cluster02（备集群） 上配置连接的远程集群 cluster01（主集群）。&lt;/span&gt;&lt;/p&gt;&lt;pre data-tool=&quot;mdnice编辑器&quot;&gt;&lt;code&gt;&lt;span&gt;&lt;span&gt;PUT&lt;/span&gt; &lt;span&gt;/_cluster/settings&lt;/span&gt;&lt;br/&gt;&lt;span&gt;{&lt;/span&gt;&lt;br/&gt;  &lt;span&gt;&quot;persistent&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;{&lt;/span&gt;&lt;br/&gt;    &lt;span&gt;&quot;cluster&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;{&lt;/span&gt;&lt;br/&gt;      &lt;span&gt;&quot;remote&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;{&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;&quot;es01&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;{&lt;/span&gt;&lt;br/&gt;          &lt;span&gt;&quot;seeds&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;[&lt;/span&gt;&lt;br/&gt;            &lt;span&gt;&quot;es01:9300&quot;&lt;/span&gt; &lt;br/&gt;          &lt;span&gt;]&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;}&lt;/span&gt;&lt;br/&gt;      &lt;span&gt;}&lt;/span&gt;&lt;br/&gt;    &lt;span&gt;}&lt;/span&gt;&lt;br/&gt;  &lt;span&gt;}&lt;/span&gt;&lt;br/&gt;&lt;span&gt;}&lt;/span&gt;&lt;br/&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;在集群 cluster02 上查看远程集群连接状态。&lt;/span&gt;&lt;/p&gt;&lt;pre data-tool=&quot;mdnice编辑器&quot;&gt;&lt;code&gt;&lt;span&gt;&lt;span&gt;GET&lt;/span&gt; &lt;span&gt;/_remote/info&lt;/span&gt;&lt;br/&gt;&lt;br/&gt;&lt;span&gt;# 返回结果&lt;/span&gt;&lt;br/&gt;&lt;span&gt;{&lt;/span&gt;&lt;br/&gt;  &lt;span&gt;&quot;es01&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;{&lt;/span&gt;&lt;br/&gt;    &lt;span&gt;&quot;connected&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;true&lt;/span&gt;&lt;span&gt;,&lt;/span&gt;  &lt;span&gt;# 已连接&lt;/span&gt;&lt;br/&gt;    &lt;span&gt;&quot;mode&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;&quot;sniff&quot;,&lt;/span&gt;&lt;br/&gt;    &lt;span&gt;&quot;seeds&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;[&lt;/span&gt;&lt;br/&gt;      &lt;span&gt;&quot;es01:9300&quot;&lt;/span&gt;&lt;br/&gt;    &lt;span&gt;],&lt;/span&gt;&lt;br/&gt;    &lt;span&gt;&quot;num_nodes_connected&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;1&lt;/span&gt;&lt;span&gt;,&lt;/span&gt;&lt;br/&gt;    &lt;span&gt;&quot;max_connections_per_cluster&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;3&lt;/span&gt;&lt;span&gt;,&lt;/span&gt;&lt;br/&gt;    &lt;span&gt;&quot;initial_connect_timeout&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;&quot;30s&quot;,&lt;/span&gt;&lt;br/&gt;    &lt;span&gt;&quot;skip_unavailable&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;false&lt;/span&gt;&lt;br/&gt;  &lt;span&gt;}&lt;/span&gt;&lt;br/&gt;&lt;span&gt;}&lt;/span&gt;&lt;br/&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;在 Kibana 上查看远程集群。&lt;/span&gt;&lt;img class=&quot;rich_pages wxw-img&quot; data-ratio=&quot;0.3234880450070324&quot; data-src=&quot;https://mmbiz.qpic.cn/mmbiz_png/mjl8GCpsL9auhKTS8YiaHLpE37Swaxib503BmowNiaqF6RNCZQian0RO9GqiaVpB7nDr45W8psiaVQJHRPUCib8qJhnUg/640?wx_fmt=png&quot; data-type=&quot;png&quot; data-w=&quot;2844&quot;/&gt;&lt;/p&gt;&lt;h4 data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;9.3.3 指定索引进行复制&lt;/span&gt;&lt;/h4&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;CCR 跨集群复制可以指定特定的索引进行复制，前提是 leader index 已经在远程集群中存在。在初始化复制时，Elasticsearch 首先会将远程集群上 leader index 的 Lucence segment 文件拷贝到本地进行恢复，当恢复完成后，复制状态将会置为 Active，后续将基于文档操作进行订阅复制。&lt;/span&gt;&lt;/p&gt;&lt;h5 data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;9.3.3.1 远程集群插入文档&lt;/span&gt;&lt;/h5&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;在创建 follower index 之前先往集群 cluster01 中插入 3 条文档。&lt;/span&gt;&lt;/p&gt;&lt;pre data-tool=&quot;mdnice编辑器&quot;&gt;&lt;code&gt;&lt;span&gt;&lt;span&gt;POST&lt;/span&gt; &lt;span&gt;index-1/_bulk&lt;/span&gt;&lt;br/&gt;&lt;span&gt;{&quot;index&quot;:{}}&lt;/span&gt;&lt;br/&gt;&lt;span&gt;{&quot;name&quot;:&quot;tom&quot;,&quot;age&quot;:18}&lt;/span&gt;&lt;br/&gt;&lt;span&gt;{&quot;index&quot;:{}}&lt;/span&gt;&lt;br/&gt;&lt;span&gt;{&quot;name&quot;:&quot;jack&quot;,&quot;age&quot;:19}&lt;/span&gt;&lt;br/&gt;&lt;span&gt;{&quot;index&quot;:{}}&lt;/span&gt;&lt;br/&gt;&lt;span&gt;{&quot;name&quot;:&quot;tonny&quot;,&quot;age&quot;:20}&lt;/span&gt;&lt;br/&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;h5 data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;9.3.3.2 创建 Follower index&lt;/span&gt;&lt;/h5&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;在集群 cluster02 上创建复制规则，复制集群 cluster01 上的索引 index-1 到本地的索引 index-1-follower 中。&lt;/span&gt;&lt;/p&gt;&lt;pre data-tool=&quot;mdnice编辑器&quot;&gt;&lt;code&gt;&lt;span&gt;&lt;span&gt;PUT&lt;/span&gt; &lt;span&gt;/index-1-follower/_ccr/follow?wait_for_active_shards=1&lt;/span&gt;&lt;br/&gt;&lt;span&gt;{&lt;/span&gt;&lt;br/&gt;  &lt;span&gt;&quot;remote_cluster&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;&quot;es01&quot;,&lt;/span&gt;&lt;br/&gt;  &lt;span&gt;&quot;leader_index&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;&quot;index-1&quot;&lt;/span&gt;&lt;br/&gt;&lt;span&gt;}&lt;/span&gt;&lt;br/&gt;&lt;br/&gt;&lt;span&gt;# 返回结果&lt;/span&gt;&lt;br/&gt;&lt;span&gt;{&lt;/span&gt;&lt;br/&gt;  &lt;span&gt;&quot;follow_index_created&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;true&lt;/span&gt;&lt;span&gt;,&lt;/span&gt;&lt;br/&gt;  &lt;span&gt;&quot;follow_index_shards_acked&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;true&lt;/span&gt;&lt;span&gt;,&lt;/span&gt;&lt;br/&gt;  &lt;span&gt;&quot;index_following_started&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;true&lt;/span&gt;&lt;br/&gt;&lt;span&gt;}&lt;/span&gt;&lt;br/&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;在 Kibana 上查看 Follower index。&lt;/span&gt;&lt;img class=&quot;rich_pages wxw-img&quot; data-ratio=&quot;0.3651900941750959&quot; data-src=&quot;https://mmbiz.qpic.cn/mmbiz_png/mjl8GCpsL9auhKTS8YiaHLpE37Swaxib50XWBEtIy8p0HpZOPJALk5Fq1Oqvtgj3Vibic1AkgjibTyUL1qUUcibVkoww/640?wx_fmt=png&quot; data-type=&quot;png&quot; data-w=&quot;2867&quot;/&gt;&lt;/p&gt;&lt;h5 data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;9.3.3.3 验证同步&lt;/span&gt;&lt;/h5&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;在集群 cluster02 上查询索引 index-1-follower 的数据，可以看到此时集群 cluster02 已经完全同步了 cluster01 上索引 index-1 中的数据。&lt;/span&gt;&lt;/p&gt;&lt;pre data-tool=&quot;mdnice编辑器&quot;&gt;&lt;code&gt;&lt;span&gt;GET index-1-follower/_search&lt;br/&gt;&lt;br/&gt;&lt;span&gt;# 返回结果&lt;/span&gt;&lt;br/&gt;{&lt;br/&gt;  &lt;span&gt;&quot;took&quot;&lt;/span&gt; : 2,&lt;br/&gt;  &lt;span&gt;&quot;timed_out&quot;&lt;/span&gt; : &lt;span&gt;false&lt;/span&gt;,&lt;br/&gt;  &lt;span&gt;&quot;_shards&quot;&lt;/span&gt; : {&lt;br/&gt;    &lt;span&gt;&quot;total&quot;&lt;/span&gt; : 1,&lt;br/&gt;    &lt;span&gt;&quot;successful&quot;&lt;/span&gt; : 1,&lt;br/&gt;    &lt;span&gt;&quot;skipped&quot;&lt;/span&gt; : 0,&lt;br/&gt;    &lt;span&gt;&quot;failed&quot;&lt;/span&gt; : 0&lt;br/&gt;  },&lt;br/&gt;  &lt;span&gt;&quot;hits&quot;&lt;/span&gt; : {&lt;br/&gt;    &lt;span&gt;&quot;total&quot;&lt;/span&gt; : {&lt;br/&gt;      &lt;span&gt;&quot;value&quot;&lt;/span&gt; : 3,&lt;br/&gt;      &lt;span&gt;&quot;relation&quot;&lt;/span&gt; : &lt;span&gt;&quot;eq&quot;&lt;/span&gt;&lt;br/&gt;    },&lt;br/&gt;    &lt;span&gt;&quot;max_score&quot;&lt;/span&gt; : 1.0,&lt;br/&gt;    &lt;span&gt;&quot;hits&quot;&lt;/span&gt; : [&lt;br/&gt;      {&lt;br/&gt;        &lt;span&gt;&quot;_index&quot;&lt;/span&gt; : &lt;span&gt;&quot;index-1-follower&quot;&lt;/span&gt;,&lt;br/&gt;        &lt;span&gt;&quot;_type&quot;&lt;/span&gt; : &lt;span&gt;&quot;_doc&quot;&lt;/span&gt;,&lt;br/&gt;        &lt;span&gt;&quot;_id&quot;&lt;/span&gt; : &lt;span&gt;&quot;eipb_H0BgImMM5qOKz5h&quot;&lt;/span&gt;,&lt;br/&gt;        &lt;span&gt;&quot;_score&quot;&lt;/span&gt; : 1.0,&lt;br/&gt;        &lt;span&gt;&quot;_source&quot;&lt;/span&gt; : {&lt;br/&gt;          &lt;span&gt;&quot;name&quot;&lt;/span&gt; : &lt;span&gt;&quot;tom&quot;&lt;/span&gt;,&lt;br/&gt;          &lt;span&gt;&quot;age&quot;&lt;/span&gt; : 18&lt;br/&gt;        }&lt;br/&gt;      },&lt;br/&gt;      {&lt;br/&gt;        &lt;span&gt;&quot;_index&quot;&lt;/span&gt; : &lt;span&gt;&quot;index-1-follower&quot;&lt;/span&gt;,&lt;br/&gt;        &lt;span&gt;&quot;_type&quot;&lt;/span&gt; : &lt;span&gt;&quot;_doc&quot;&lt;/span&gt;,&lt;br/&gt;        &lt;span&gt;&quot;_id&quot;&lt;/span&gt; : &lt;span&gt;&quot;eypb_H0BgImMM5qOKz5h&quot;&lt;/span&gt;,&lt;br/&gt;        &lt;span&gt;&quot;_score&quot;&lt;/span&gt; : 1.0,&lt;br/&gt;        &lt;span&gt;&quot;_source&quot;&lt;/span&gt; : {&lt;br/&gt;          &lt;span&gt;&quot;name&quot;&lt;/span&gt; : &lt;span&gt;&quot;jack&quot;&lt;/span&gt;,&lt;br/&gt;          &lt;span&gt;&quot;age&quot;&lt;/span&gt; : 19&lt;br/&gt;        }&lt;br/&gt;      },&lt;br/&gt;      {&lt;br/&gt;        &lt;span&gt;&quot;_index&quot;&lt;/span&gt; : &lt;span&gt;&quot;index-1-follower&quot;&lt;/span&gt;,&lt;br/&gt;        &lt;span&gt;&quot;_type&quot;&lt;/span&gt; : &lt;span&gt;&quot;_doc&quot;&lt;/span&gt;,&lt;br/&gt;        &lt;span&gt;&quot;_id&quot;&lt;/span&gt; : &lt;span&gt;&quot;fCpb_H0BgImMM5qOKz5h&quot;&lt;/span&gt;,&lt;br/&gt;        &lt;span&gt;&quot;_score&quot;&lt;/span&gt; : 1.0,&lt;br/&gt;        &lt;span&gt;&quot;_source&quot;&lt;/span&gt; : {&lt;br/&gt;          &lt;span&gt;&quot;name&quot;&lt;/span&gt; : &lt;span&gt;&quot;tonny&quot;&lt;/span&gt;,&lt;br/&gt;          &lt;span&gt;&quot;age&quot;&lt;/span&gt; : 20&lt;br/&gt;        }&lt;br/&gt;      }&lt;br/&gt;    ]&lt;br/&gt;  }&lt;br/&gt;}&lt;br/&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;在集群 cluster01 上删除 name 为 tom 的文档，并插入一条新的文档。&lt;/span&gt;&lt;/p&gt;&lt;pre data-tool=&quot;mdnice编辑器&quot;&gt;&lt;code&gt;&lt;span&gt;POST index-1/_delete_by_query&lt;br/&gt;{&lt;br/&gt;  &lt;span&gt;&quot;query&quot;&lt;/span&gt;: {&lt;br/&gt;    &lt;span&gt;&quot;match&quot;&lt;/span&gt;: {&lt;br/&gt;      &lt;span&gt;&quot;name&quot;&lt;/span&gt;: &lt;span&gt;&quot;tom&quot;&lt;/span&gt;&lt;br/&gt;    }&lt;br/&gt;  }&lt;br/&gt;}&lt;br/&gt;&lt;br/&gt;POST index-1/_doc&lt;br/&gt;{&lt;br/&gt;  &lt;span&gt;&quot;name&quot;&lt;/span&gt;: &lt;span&gt;&quot;peter&quot;&lt;/span&gt;,&lt;br/&gt;  &lt;span&gt;&quot;age&quot;&lt;/span&gt;: 16&lt;br/&gt;}&lt;br/&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;在集群 cluster02 上查看文档，可以看到此时在集群 cluster02 也成功同步了刚刚的新增和删除的文档。&lt;/span&gt;&lt;/p&gt;&lt;pre data-tool=&quot;mdnice编辑器&quot;&gt;&lt;code&gt;&lt;span&gt;{&lt;br/&gt;  &lt;span&gt;&quot;took&quot;&lt;/span&gt; : &lt;span&gt;0&lt;/span&gt;,&lt;br/&gt;  &lt;span&gt;&quot;timed_out&quot;&lt;/span&gt; : &lt;span&gt;false&lt;/span&gt;,&lt;br/&gt;  &lt;span&gt;&quot;_shards&quot;&lt;/span&gt; : {&lt;br/&gt;    &lt;span&gt;&quot;total&quot;&lt;/span&gt; : &lt;span&gt;1&lt;/span&gt;,&lt;br/&gt;    &lt;span&gt;&quot;successful&quot;&lt;/span&gt; : &lt;span&gt;1&lt;/span&gt;,&lt;br/&gt;    &lt;span&gt;&quot;skipped&quot;&lt;/span&gt; : &lt;span&gt;0&lt;/span&gt;,&lt;br/&gt;    &lt;span&gt;&quot;failed&quot;&lt;/span&gt; : &lt;span&gt;0&lt;/span&gt;&lt;br/&gt;  },&lt;br/&gt;  &lt;span&gt;&quot;hits&quot;&lt;/span&gt; : {&lt;br/&gt;    &lt;span&gt;&quot;total&quot;&lt;/span&gt; : {&lt;br/&gt;      &lt;span&gt;&quot;value&quot;&lt;/span&gt; : &lt;span&gt;3&lt;/span&gt;,&lt;br/&gt;      &lt;span&gt;&quot;relation&quot;&lt;/span&gt; : &lt;span&gt;&quot;eq&quot;&lt;/span&gt;&lt;br/&gt;    },&lt;br/&gt;    &lt;span&gt;&quot;max_score&quot;&lt;/span&gt; : &lt;span&gt;1.0&lt;/span&gt;,&lt;br/&gt;    &lt;span&gt;&quot;hits&quot;&lt;/span&gt; : [&lt;br/&gt;      {&lt;br/&gt;        &lt;span&gt;&quot;_index&quot;&lt;/span&gt; : &lt;span&gt;&quot;index-1-follower&quot;&lt;/span&gt;,&lt;br/&gt;        &lt;span&gt;&quot;_type&quot;&lt;/span&gt; : &lt;span&gt;&quot;_doc&quot;&lt;/span&gt;,&lt;br/&gt;        &lt;span&gt;&quot;_id&quot;&lt;/span&gt; : &lt;span&gt;&quot;eypb_H0BgImMM5qOKz5h&quot;&lt;/span&gt;,&lt;br/&gt;        &lt;span&gt;&quot;_score&quot;&lt;/span&gt; : &lt;span&gt;1.0&lt;/span&gt;,&lt;br/&gt;        &lt;span&gt;&quot;_source&quot;&lt;/span&gt; : {&lt;br/&gt;          &lt;span&gt;&quot;name&quot;&lt;/span&gt; : &lt;span&gt;&quot;jack&quot;&lt;/span&gt;,&lt;br/&gt;          &lt;span&gt;&quot;age&quot;&lt;/span&gt; : &lt;span&gt;19&lt;/span&gt;&lt;br/&gt;        }&lt;br/&gt;      },&lt;br/&gt;      {&lt;br/&gt;        &lt;span&gt;&quot;_index&quot;&lt;/span&gt; : &lt;span&gt;&quot;index-1-follower&quot;&lt;/span&gt;,&lt;br/&gt;        &lt;span&gt;&quot;_type&quot;&lt;/span&gt; : &lt;span&gt;&quot;_doc&quot;&lt;/span&gt;,&lt;br/&gt;        &lt;span&gt;&quot;_id&quot;&lt;/span&gt; : &lt;span&gt;&quot;fCpb_H0BgImMM5qOKz5h&quot;&lt;/span&gt;,&lt;br/&gt;        &lt;span&gt;&quot;_score&quot;&lt;/span&gt; : &lt;span&gt;1.0&lt;/span&gt;,&lt;br/&gt;        &lt;span&gt;&quot;_source&quot;&lt;/span&gt; : {&lt;br/&gt;          &lt;span&gt;&quot;name&quot;&lt;/span&gt; : &lt;span&gt;&quot;tonny&quot;&lt;/span&gt;,&lt;br/&gt;          &lt;span&gt;&quot;age&quot;&lt;/span&gt; : &lt;span&gt;20&lt;/span&gt;&lt;br/&gt;        }&lt;br/&gt;      },&lt;br/&gt;      {&lt;br/&gt;        &lt;span&gt;&quot;_index&quot;&lt;/span&gt; : &lt;span&gt;&quot;index-1-follower&quot;&lt;/span&gt;,&lt;br/&gt;        &lt;span&gt;&quot;_type&quot;&lt;/span&gt; : &lt;span&gt;&quot;_doc&quot;&lt;/span&gt;,&lt;br/&gt;        &lt;span&gt;&quot;_id&quot;&lt;/span&gt; : &lt;span&gt;&quot;fSrF_30BgImMM5qObz6_&quot;&lt;/span&gt;,&lt;br/&gt;        &lt;span&gt;&quot;_score&quot;&lt;/span&gt; : &lt;span&gt;1.0&lt;/span&gt;,&lt;br/&gt;        &lt;span&gt;&quot;_source&quot;&lt;/span&gt; : {&lt;br/&gt;          &lt;span&gt;&quot;name&quot;&lt;/span&gt; : &lt;span&gt;&quot;peter&quot;&lt;/span&gt;,&lt;br/&gt;          &lt;span&gt;&quot;age&quot;&lt;/span&gt; : &lt;span&gt;16&lt;/span&gt;&lt;br/&gt;        }&lt;br/&gt;      }&lt;br/&gt;    ]&lt;br/&gt;  }&lt;br/&gt;}&lt;br/&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;在集群 cluster02 上可以通过 &lt;/span&gt;&lt;code&gt;&lt;span&gt;Get follower stats API&lt;/span&gt;&lt;/code&gt;&lt;span&gt;  来查看同步进度。&lt;/span&gt;&lt;code&gt;&lt;span&gt;leader_global_checkpoint&lt;/span&gt;&lt;/code&gt;&lt;span&gt; 和 &lt;/span&gt;&lt;code&gt;&lt;span&gt;follower_global_checkpoint&lt;/span&gt;&lt;/code&gt;&lt;span&gt; 差值表示 follower index 落后于 leader index 的程度。&lt;/span&gt;&lt;/p&gt;&lt;pre data-tool=&quot;mdnice编辑器&quot;&gt;&lt;code&gt;&lt;span&gt;GET index-1-follower/_ccr/stats&lt;br/&gt;&lt;br/&gt;&lt;span&gt;# 返回结果&lt;/span&gt;&lt;br/&gt;{&lt;br/&gt;  &lt;span&gt;&quot;indices&quot;&lt;/span&gt; : [&lt;br/&gt;    {&lt;br/&gt;      &lt;span&gt;&quot;index&quot;&lt;/span&gt; : &lt;span&gt;&quot;index-1-follower&quot;&lt;/span&gt;, &lt;br/&gt;      &lt;span&gt;&quot;shards&quot;&lt;/span&gt; : [&lt;br/&gt;        {&lt;br/&gt;          &lt;span&gt;&quot;remote_cluster&quot;&lt;/span&gt; : &lt;span&gt;&quot;es01&quot;&lt;/span&gt;, &lt;br/&gt;          &lt;span&gt;&quot;leader_index&quot;&lt;/span&gt; : &lt;span&gt;&quot;index-1&quot;&lt;/span&gt;, &lt;br/&gt;          &lt;span&gt;&quot;follower_index&quot;&lt;/span&gt; : &lt;span&gt;&quot;index-1-follower&quot;&lt;/span&gt;,  &lt;br/&gt;          &lt;span&gt;&quot;shard_id&quot;&lt;/span&gt; : 0,&lt;br/&gt;          &lt;span&gt;&quot;leader_global_checkpoint&quot;&lt;/span&gt; : 2,&lt;br/&gt;          &lt;span&gt;&quot;leader_max_seq_no&quot;&lt;/span&gt; : 2,&lt;br/&gt;          &lt;span&gt;&quot;follower_global_checkpoint&quot;&lt;/span&gt; : 2,&lt;br/&gt;          &lt;span&gt;&quot;follower_max_seq_no&quot;&lt;/span&gt; : 2, &lt;br/&gt;          &lt;span&gt;&quot;last_requested_seq_no&quot;&lt;/span&gt; : 2,&lt;br/&gt;          &lt;span&gt;&quot;outstanding_read_requests&quot;&lt;/span&gt; : 1,&lt;br/&gt;          &lt;span&gt;&quot;outstanding_write_requests&quot;&lt;/span&gt; : 0,&lt;br/&gt;          &lt;span&gt;&quot;write_buffer_operation_count&quot;&lt;/span&gt; : 0,&lt;br/&gt;          &lt;span&gt;&quot;write_buffer_size_in_bytes&quot;&lt;/span&gt; : 0,&lt;br/&gt;          &lt;span&gt;&quot;follower_mapping_version&quot;&lt;/span&gt; : 2,&lt;br/&gt;          &lt;span&gt;&quot;follower_settings_version&quot;&lt;/span&gt; : 1,&lt;br/&gt;          &lt;span&gt;&quot;follower_aliases_version&quot;&lt;/span&gt; : 1,&lt;br/&gt;          &lt;span&gt;&quot;total_read_time_millis&quot;&lt;/span&gt; : 12,&lt;br/&gt;          &lt;span&gt;&quot;total_read_remote_exec_time_millis&quot;&lt;/span&gt; : 6,&lt;br/&gt;          &lt;span&gt;&quot;successful_read_requests&quot;&lt;/span&gt; : 1,&lt;br/&gt;          &lt;span&gt;&quot;failed_read_requests&quot;&lt;/span&gt; : 0,&lt;br/&gt;          &lt;span&gt;&quot;operations_read&quot;&lt;/span&gt; : 3,&lt;br/&gt;          &lt;span&gt;&quot;bytes_read&quot;&lt;/span&gt; : 312,&lt;br/&gt;          &lt;span&gt;&quot;total_write_time_millis&quot;&lt;/span&gt; : 18,&lt;br/&gt;          &lt;span&gt;&quot;successful_write_requests&quot;&lt;/span&gt; : 1,&lt;br/&gt;          &lt;span&gt;&quot;failed_write_requests&quot;&lt;/span&gt; : 0,&lt;br/&gt;          &lt;span&gt;&quot;operations_written&quot;&lt;/span&gt; : 3,&lt;br/&gt;          &lt;span&gt;&quot;read_exceptions&quot;&lt;/span&gt; : [ ],&lt;br/&gt;          &lt;span&gt;&quot;time_since_last_read_millis&quot;&lt;/span&gt; : 13903&lt;br/&gt;        }&lt;br/&gt;      ]&lt;br/&gt;    }&lt;br/&gt;  ]&lt;br/&gt;}&lt;br/&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;由于 follower index 是被动的，只能接受查询请求，不能处理写入请求。因此在集群 cluster02 上不允许对 follower index 进行新增、修改或者删除操作。&lt;/span&gt;&lt;/p&gt;&lt;pre data-tool=&quot;mdnice编辑器&quot;&gt;&lt;code&gt;&lt;span&gt;&lt;span&gt;POST&lt;/span&gt; &lt;span&gt;index-1-follower/_doc&lt;/span&gt;&lt;br/&gt;&lt;span&gt;{&lt;/span&gt;&lt;br/&gt;  &lt;span&gt;&quot;name&quot;:&lt;/span&gt; &lt;span&gt;&quot;mary&quot;,&lt;/span&gt;&lt;br/&gt;  &lt;span&gt;&quot;age&quot;:&lt;/span&gt; &lt;span&gt;20&lt;/span&gt;&lt;br/&gt;&lt;span&gt;}&lt;/span&gt;&lt;br/&gt;&lt;br/&gt;&lt;span&gt;# 返回结果&lt;/span&gt;&lt;br/&gt;&lt;span&gt;{&lt;/span&gt;&lt;br/&gt;  &lt;span&gt;&quot;error&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;{&lt;/span&gt;&lt;br/&gt;    &lt;span&gt;&quot;root_cause&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;[&lt;/span&gt;&lt;br/&gt;      &lt;span&gt;{&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;&quot;type&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;&quot;status_exception&quot;,&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;&quot;reason&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;&quot;a following engine does not accept operations without an assigned sequence number&quot;&lt;/span&gt;&lt;br/&gt;      &lt;span&gt;}&lt;/span&gt;&lt;br/&gt;    &lt;span&gt;],&lt;/span&gt;&lt;br/&gt;    &lt;span&gt;&quot;type&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;&quot;status_exception&quot;,&lt;/span&gt;&lt;br/&gt;    &lt;span&gt;&quot;reason&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;&quot;a following engine does not accept operations without an assigned sequence number&quot;&lt;/span&gt;&lt;br/&gt;  &lt;span&gt;},&lt;/span&gt;&lt;br/&gt;  &lt;span&gt;&quot;status&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;403&lt;/span&gt;&lt;br/&gt;&lt;span&gt;}&lt;/span&gt;&lt;br/&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;如果想要在 cluster02 上对 &lt;/span&gt;&lt;code&gt;&lt;span&gt;index-1-follower&lt;/span&gt;&lt;/code&gt;&lt;span&gt;  索引做写入、更新、删除等操作，需要依次对索引进行 pause_follow、close、unfollow 操作，以停止对 leadear index 的同步。最后再 open 索引，才可以在 cluster02 上对 &lt;/span&gt;&lt;code&gt;&lt;span&gt;index-1-follower&lt;/span&gt;&lt;/code&gt;&lt;span&gt; 执行写入请求。&lt;/span&gt;&lt;/p&gt;&lt;pre data-tool=&quot;mdnice编辑器&quot;&gt;&lt;code&gt;&lt;span&gt;&lt;span&gt;# 暂停同步&lt;/span&gt;&lt;br/&gt;POST /index-1-follower/_ccr/pause_follow&lt;br/&gt;&lt;br/&gt;&lt;span&gt;# 关闭索引&lt;/span&gt;&lt;br/&gt;POST index-1-follower/_close&lt;br/&gt;&lt;br/&gt;&lt;span&gt;# 停止同步&lt;/span&gt;&lt;br/&gt;POST /index-1-follower/_ccr/unfollow&lt;br/&gt;&lt;br/&gt;&lt;span&gt;# 打开索引&lt;/span&gt;&lt;br/&gt;POST index-1-follower/_open&lt;br/&gt;&lt;br/&gt;&lt;span&gt;# 此时可以写入数据&lt;/span&gt;&lt;br/&gt;POST index-1-follower/_doc&lt;br/&gt;{&lt;br/&gt;  &lt;span&gt;&quot;name&quot;&lt;/span&gt;: &lt;span&gt;&quot;mary&quot;&lt;/span&gt;,&lt;br/&gt;  &lt;span&gt;&quot;age&quot;&lt;/span&gt;: 20&lt;br/&gt;}&lt;br/&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;但是需要特别注意的是，在关闭同步并插入新的数据以后，如果重新同步，这些新插入的数据将会丢失。&lt;/span&gt;&lt;/p&gt;&lt;h4 data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;9.3.4 通过 Auto-follow pattern 自动跟随模式进行复制&lt;/span&gt;&lt;/h4&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;除了指定特定索引进行复制以外，Elasticsearch 还支持通过 auto-follow pattern 自动跟随模式进行复制，auto-follow pattern 允许以通配符的方式匹配多个索引，这非常适合复制时间序列的索引。例如 &lt;/span&gt;&lt;code&gt;&lt;span&gt;my-app-*&lt;/span&gt;&lt;/code&gt;&lt;span&gt; 可以匹配 &lt;/span&gt;&lt;code&gt;&lt;span&gt;my-app-2021.12.30&lt;/span&gt;&lt;/code&gt;&lt;span&gt; 和 &lt;/span&gt;&lt;code&gt;&lt;span&gt;my-app-2021.12.31&lt;/span&gt;&lt;/code&gt;&lt;span&gt; 等多个索引。使用 auto-follow pattern 时，不需要主集群上已经存在 leader index，对于主集群上新创建的索引，也会自动应用复制规则。&lt;/span&gt;&lt;/p&gt;&lt;h5 data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;9.3.4.1 创建 Auto-follow pattern&lt;/span&gt;&lt;/h5&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;在集群 cluster02 上创建复制规则，复制集群 cluster01 上以 &lt;/span&gt;&lt;code&gt;&lt;span&gt;my-index-&lt;/span&gt;&lt;/code&gt;&lt;span&gt; 和 &lt;/span&gt;&lt;code&gt;&lt;span&gt;my-app-&lt;/span&gt;&lt;/code&gt;&lt;span&gt; 开头的索引，并在复制的索引名后加上 copy 字符串。&lt;/span&gt;&lt;/p&gt;&lt;pre data-tool=&quot;mdnice编辑器&quot;&gt;&lt;code&gt;&lt;span&gt;&lt;span&gt;PUT&lt;/span&gt; &lt;span&gt;/_ccr/auto_follow/my-index&lt;/span&gt;&lt;br/&gt;&lt;span&gt;{&lt;/span&gt;&lt;br/&gt;  &lt;span&gt;&quot;remote_cluster&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;&quot;es01&quot;,&lt;/span&gt;&lt;br/&gt;  &lt;span&gt;&quot;leader_index_patterns&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt;&lt;br/&gt;  &lt;span&gt;[&lt;/span&gt;&lt;br/&gt;    &lt;span&gt;&quot;my-index-*&quot;,&lt;/span&gt; &lt;br/&gt;    &lt;span&gt;&quot;my-app-*&quot;&lt;/span&gt; &lt;br/&gt;  &lt;span&gt;],&lt;/span&gt;&lt;br/&gt;  &lt;span&gt;&quot;follow_index_pattern&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;&quot;&lt;span&gt;{{leader_index}}&lt;/span&gt;-copy&quot;&lt;/span&gt; &lt;br/&gt;&lt;span&gt;}&lt;/span&gt;&lt;br/&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;查看 Auto-follow patterns 复制规则。&lt;/span&gt;&lt;img class=&quot;rich_pages wxw-img&quot; data-ratio=&quot;0.36693407743285666&quot; data-src=&quot;https://mmbiz.qpic.cn/mmbiz_png/mjl8GCpsL9auhKTS8YiaHLpE37Swaxib50SWxatG7xXEerMgfNru6h7eDibkhxsG83Kb31q2cfClhfe9tMg0icJcRw/640?wx_fmt=png&quot; data-type=&quot;png&quot; data-w=&quot;2867&quot;/&gt;&lt;/p&gt;&lt;h5 data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;9.3.4.2 远程集群插入文档&lt;/span&gt;&lt;/h5&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;在集群 cluster01 上 分别往索引 &lt;/span&gt;&lt;code&gt;&lt;span&gt;my-index-1&lt;/span&gt;&lt;/code&gt;&lt;span&gt; 和 &lt;/span&gt;&lt;code&gt;&lt;span&gt;my-app-1&lt;/span&gt;&lt;/code&gt;&lt;span&gt; 中各插入 3 条文档。&lt;/span&gt;&lt;/p&gt;&lt;pre data-tool=&quot;mdnice编辑器&quot;&gt;&lt;code&gt;&lt;span&gt;&lt;span&gt;POST&lt;/span&gt; &lt;span&gt;my-index-1/_bulk&lt;/span&gt;&lt;br/&gt;&lt;span&gt;{&quot;index&quot;:{}}&lt;/span&gt;&lt;br/&gt;&lt;span&gt;{&quot;name&quot;:&quot;tom&quot;,&quot;age&quot;:18}&lt;/span&gt;&lt;br/&gt;&lt;span&gt;{&quot;index&quot;:{}}&lt;/span&gt;&lt;br/&gt;&lt;span&gt;{&quot;name&quot;:&quot;jack&quot;,&quot;age&quot;:19}&lt;/span&gt;&lt;br/&gt;&lt;span&gt;{&quot;index&quot;:{}}&lt;/span&gt;&lt;br/&gt;&lt;span&gt;{&quot;name&quot;:&quot;tonny&quot;,&quot;age&quot;:20}&lt;/span&gt;&lt;br/&gt;&lt;br/&gt;&lt;span&gt;POST&lt;/span&gt; &lt;span&gt;my-app-1/_bulk&lt;/span&gt;&lt;br/&gt;&lt;span&gt;{&quot;index&quot;:{}}&lt;/span&gt;&lt;br/&gt;&lt;span&gt;{&quot;color&quot;:&quot;blue&quot;,&quot;price&quot;:100}&lt;/span&gt;&lt;br/&gt;&lt;span&gt;{&quot;index&quot;:{}}&lt;/span&gt;&lt;br/&gt;&lt;span&gt;{&quot;color&quot;:&quot;yellow&quot;,&quot;price&quot;:50}&lt;/span&gt;&lt;br/&gt;&lt;span&gt;{&quot;index&quot;:{}}&lt;/span&gt;&lt;br/&gt;&lt;span&gt;{&quot;color&quot;:&quot;green&quot;,&quot;price&quot;:20}&lt;/span&gt;&lt;br/&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;h5 data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;9.3.4.3 验证同步&lt;/span&gt;&lt;/h5&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;在集群 cluster02 上可以看到两个索引都已经成功复制过来了。&lt;/span&gt;&lt;/p&gt;&lt;pre data-tool=&quot;mdnice编辑器&quot;&gt;&lt;code&gt;&lt;span&gt;&lt;span&gt;GET&lt;/span&gt; &lt;span&gt;my-index-1-copy/_search&lt;/span&gt;&lt;br/&gt;&lt;br/&gt;&lt;span&gt;# 返回结果&lt;/span&gt;&lt;br/&gt;&lt;span&gt;{&lt;/span&gt;&lt;br/&gt;  &lt;span&gt;&quot;took&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;0&lt;/span&gt;&lt;span&gt;,&lt;/span&gt;&lt;br/&gt;  &lt;span&gt;&quot;timed_out&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;false&lt;/span&gt;&lt;span&gt;,&lt;/span&gt;&lt;br/&gt;  &lt;span&gt;&quot;_shards&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;{&lt;/span&gt;&lt;br/&gt;    &lt;span&gt;&quot;total&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;1&lt;/span&gt;&lt;span&gt;,&lt;/span&gt;&lt;br/&gt;    &lt;span&gt;&quot;successful&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;1&lt;/span&gt;&lt;span&gt;,&lt;/span&gt;&lt;br/&gt;    &lt;span&gt;&quot;skipped&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;0&lt;/span&gt;&lt;span&gt;,&lt;/span&gt;&lt;br/&gt;    &lt;span&gt;&quot;failed&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;0&lt;/span&gt;&lt;br/&gt;  &lt;span&gt;},&lt;/span&gt;&lt;br/&gt;  &lt;span&gt;&quot;hits&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;{&lt;/span&gt;&lt;br/&gt;    &lt;span&gt;&quot;total&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;{&lt;/span&gt;&lt;br/&gt;      &lt;span&gt;&quot;value&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;3&lt;/span&gt;&lt;span&gt;,&lt;/span&gt;&lt;br/&gt;      &lt;span&gt;&quot;relation&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;&quot;eq&quot;&lt;/span&gt;&lt;br/&gt;    &lt;span&gt;},&lt;/span&gt;&lt;br/&gt;    &lt;span&gt;&quot;max_score&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;1.0&lt;/span&gt;&lt;span&gt;,&lt;/span&gt;&lt;br/&gt;    &lt;span&gt;&quot;hits&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;[&lt;/span&gt;&lt;br/&gt;      &lt;span&gt;{&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;&quot;_index&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;&quot;my-index-1-copy&quot;,&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;&quot;_type&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;&quot;_doc&quot;,&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;&quot;_id&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;&quot;girm_30BgImMM5qO_z6h&quot;,&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;&quot;_score&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;1.0&lt;/span&gt;&lt;span&gt;,&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;&quot;_source&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;{&lt;/span&gt;&lt;br/&gt;          &lt;span&gt;&quot;name&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;&quot;tom&quot;,&lt;/span&gt;&lt;br/&gt;          &lt;span&gt;&quot;age&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;18&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;}&lt;/span&gt;&lt;br/&gt;      &lt;span&gt;},&lt;/span&gt;&lt;br/&gt;      &lt;span&gt;{&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;&quot;_index&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;&quot;my-index-1-copy&quot;,&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;&quot;_type&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;&quot;_doc&quot;,&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;&quot;_id&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;&quot;gyrm_30BgImMM5qO_z6h&quot;,&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;&quot;_score&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;1.0&lt;/span&gt;&lt;span&gt;,&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;&quot;_source&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;{&lt;/span&gt;&lt;br/&gt;          &lt;span&gt;&quot;name&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;&quot;jack&quot;,&lt;/span&gt;&lt;br/&gt;          &lt;span&gt;&quot;age&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;19&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;}&lt;/span&gt;&lt;br/&gt;      &lt;span&gt;},&lt;/span&gt;&lt;br/&gt;      &lt;span&gt;{&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;&quot;_index&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;&quot;my-index-1-copy&quot;,&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;&quot;_type&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;&quot;_doc&quot;,&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;&quot;_id&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;&quot;hCrm_30BgImMM5qO_z6h&quot;,&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;&quot;_score&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;1.0&lt;/span&gt;&lt;span&gt;,&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;&quot;_source&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;{&lt;/span&gt;&lt;br/&gt;          &lt;span&gt;&quot;name&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;&quot;tonny&quot;,&lt;/span&gt;&lt;br/&gt;          &lt;span&gt;&quot;age&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;20&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;}&lt;/span&gt;&lt;br/&gt;      &lt;span&gt;}&lt;/span&gt;&lt;br/&gt;    &lt;span&gt;]&lt;/span&gt;&lt;br/&gt;  &lt;span&gt;}&lt;/span&gt;&lt;br/&gt;&lt;span&gt;}&lt;/span&gt;&lt;br/&gt;&lt;br/&gt;&lt;br/&gt;&lt;span&gt;GET&lt;/span&gt; &lt;span&gt;my-app-1-copy/_search&lt;/span&gt;&lt;br/&gt;&lt;br/&gt;&lt;span&gt;# 返回结果&lt;/span&gt;&lt;br/&gt;&lt;span&gt;{&lt;/span&gt;&lt;br/&gt;  &lt;span&gt;&quot;took&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;0&lt;/span&gt;&lt;span&gt;,&lt;/span&gt;&lt;br/&gt;  &lt;span&gt;&quot;timed_out&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;false&lt;/span&gt;&lt;span&gt;,&lt;/span&gt;&lt;br/&gt;  &lt;span&gt;&quot;_shards&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;{&lt;/span&gt;&lt;br/&gt;    &lt;span&gt;&quot;total&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;1&lt;/span&gt;&lt;span&gt;,&lt;/span&gt;&lt;br/&gt;    &lt;span&gt;&quot;successful&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;1&lt;/span&gt;&lt;span&gt;,&lt;/span&gt;&lt;br/&gt;    &lt;span&gt;&quot;skipped&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;0&lt;/span&gt;&lt;span&gt;,&lt;/span&gt;&lt;br/&gt;    &lt;span&gt;&quot;failed&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;0&lt;/span&gt;&lt;br/&gt;  &lt;span&gt;},&lt;/span&gt;&lt;br/&gt;  &lt;span&gt;&quot;hits&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;{&lt;/span&gt;&lt;br/&gt;    &lt;span&gt;&quot;total&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;{&lt;/span&gt;&lt;br/&gt;      &lt;span&gt;&quot;value&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;3&lt;/span&gt;&lt;span&gt;,&lt;/span&gt;&lt;br/&gt;      &lt;span&gt;&quot;relation&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;&quot;eq&quot;&lt;/span&gt;&lt;br/&gt;    &lt;span&gt;},&lt;/span&gt;&lt;br/&gt;    &lt;span&gt;&quot;max_score&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;1.0&lt;/span&gt;&lt;span&gt;,&lt;/span&gt;&lt;br/&gt;    &lt;span&gt;&quot;hits&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;[&lt;/span&gt;&lt;br/&gt;      &lt;span&gt;{&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;&quot;_index&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;&quot;my-app-1-copy&quot;,&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;&quot;_type&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;&quot;_doc&quot;,&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;&quot;_id&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;&quot;hSrn_30BgImMM5qOBT5A&quot;,&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;&quot;_score&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;1.0&lt;/span&gt;&lt;span&gt;,&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;&quot;_source&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;{&lt;/span&gt;&lt;br/&gt;          &lt;span&gt;&quot;color&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;&quot;blue&quot;,&lt;/span&gt;&lt;br/&gt;          &lt;span&gt;&quot;price&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;100&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;}&lt;/span&gt;&lt;br/&gt;      &lt;span&gt;},&lt;/span&gt;&lt;br/&gt;      &lt;span&gt;{&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;&quot;_index&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;&quot;my-app-1-copy&quot;,&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;&quot;_type&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;&quot;_doc&quot;,&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;&quot;_id&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;&quot;hirn_30BgImMM5qOBT5A&quot;,&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;&quot;_score&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;1.0&lt;/span&gt;&lt;span&gt;,&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;&quot;_source&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;{&lt;/span&gt;&lt;br/&gt;          &lt;span&gt;&quot;color&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;&quot;yellow&quot;,&lt;/span&gt;&lt;br/&gt;          &lt;span&gt;&quot;price&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;50&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;}&lt;/span&gt;&lt;br/&gt;      &lt;span&gt;},&lt;/span&gt;&lt;br/&gt;      &lt;span&gt;{&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;&quot;_index&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;&quot;my-app-1-copy&quot;,&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;&quot;_type&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;&quot;_doc&quot;,&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;&quot;_id&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;&quot;hyrn_30BgImMM5qOBT5A&quot;,&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;&quot;_score&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;1.0&lt;/span&gt;&lt;span&gt;,&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;&quot;_source&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;{&lt;/span&gt;&lt;br/&gt;          &lt;span&gt;&quot;color&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;&quot;green&quot;,&lt;/span&gt;&lt;br/&gt;          &lt;span&gt;&quot;price&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;20&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;}&lt;/span&gt;&lt;br/&gt;      &lt;span&gt;}&lt;/span&gt;&lt;br/&gt;    &lt;span&gt;]&lt;/span&gt;&lt;br/&gt;  &lt;span&gt;}&lt;/span&gt;&lt;br/&gt;&lt;span&gt;}&lt;/span&gt;&lt;br/&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;h4 data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;9.3.5 双向复制&lt;/span&gt;&lt;/h4&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;通过双向复制（CCR bi-directional replication）可以做到：当 cluster01 集群不可用时，我们可以继续通过 log 别名往 cluster02 集群上读写数据，无需手动进行切换。当 cluster01 集群恢复后，会自动继续从集群 cluster02 同步数据。&lt;/span&gt;&lt;img class=&quot;rich_pages wxw-img&quot; data-ratio=&quot;0.298606502986065&quot; data-src=&quot;https://mmbiz.qpic.cn/mmbiz_png/mjl8GCpsL9auhKTS8YiaHLpE37Swaxib50g0ia0s0YEPdhdYvaicTqt3u0iasRWicHoHgmvOVssClkhLFn9yDTHNVWOg/640?wx_fmt=png&quot; data-type=&quot;png&quot; data-w=&quot;1507&quot;/&gt;&lt;/p&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;&lt;strong&gt;在 9.3.2 连接远程集群&lt;/strong&gt; 小节中我们已经在集群 cluster02 上添加了集群 cluster01 为远程集群，要启用双向复制，需要在集群 cluster01 上也添加集群 cluster02 为远程集群。&lt;/span&gt;&lt;/p&gt;&lt;pre data-tool=&quot;mdnice编辑器&quot;&gt;&lt;code&gt;&lt;span&gt;&lt;span&gt;PUT&lt;/span&gt; &lt;span&gt;/_cluster/settings&lt;/span&gt;&lt;br/&gt;&lt;span&gt;{&lt;/span&gt;&lt;br/&gt;  &lt;span&gt;&quot;persistent&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;{&lt;/span&gt;&lt;br/&gt;    &lt;span&gt;&quot;cluster&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;{&lt;/span&gt;&lt;br/&gt;      &lt;span&gt;&quot;remote&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;{&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;&quot;es02&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;{&lt;/span&gt;&lt;br/&gt;          &lt;span&gt;&quot;seeds&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;[&lt;/span&gt;&lt;br/&gt;            &lt;span&gt;&quot;es02:9300&quot;&lt;/span&gt; &lt;br/&gt;          &lt;span&gt;]&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;}&lt;/span&gt;&lt;br/&gt;      &lt;span&gt;}&lt;/span&gt;&lt;br/&gt;    &lt;span&gt;}&lt;/span&gt;&lt;br/&gt;  &lt;span&gt;}&lt;/span&gt;&lt;br/&gt;&lt;span&gt;}&lt;/span&gt;&lt;br/&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;在 Kibana 上查看 cluster01 的远程集群。&lt;/span&gt;&lt;img class=&quot;rich_pages wxw-img&quot; data-ratio=&quot;0.2863219895287958&quot; data-src=&quot;https://mmbiz.qpic.cn/mmbiz_png/mjl8GCpsL9auhKTS8YiaHLpE37Swaxib50cCAyStRjjPGfuEUC6ABia24BrLhGFmrgLyCcK56dmI5KE7VFQYunA2Q/640?wx_fmt=png&quot; data-type=&quot;png&quot; data-w=&quot;3056&quot;/&gt;&lt;/p&gt;&lt;h5 data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;9.3.5.1 创建索引&lt;/span&gt;&lt;/h5&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;在集群 cluster01 上创建索引。&lt;/span&gt;&lt;/p&gt;&lt;pre data-tool=&quot;mdnice编辑器&quot;&gt;&lt;code&gt;&lt;span&gt;&lt;span&gt;PUT&lt;/span&gt; &lt;span&gt;logs-cluster1&lt;/span&gt;&lt;br/&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;在集群 cluster02 上创建索引。&lt;/span&gt;&lt;/p&gt;&lt;pre data-tool=&quot;mdnice编辑器&quot;&gt;&lt;code&gt;&lt;span&gt;&lt;span&gt;PUT&lt;/span&gt; &lt;span&gt;logs-cluster2&lt;/span&gt;&lt;br/&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;h5 data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;9.3.5.2 创建复制规则&lt;/span&gt;&lt;/h5&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;在集群 cluster01 上创建复制规则。&lt;/span&gt;&lt;/p&gt;&lt;pre data-tool=&quot;mdnice编辑器&quot;&gt;&lt;code&gt;&lt;span&gt;&lt;span&gt;PUT&lt;/span&gt; &lt;span&gt;logs-cluster2/_ccr/follow&lt;/span&gt; &lt;br/&gt;&lt;span&gt;{&lt;/span&gt; &lt;br/&gt;  &lt;span&gt;&quot;remote_cluster&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;&quot;es02&quot;,&lt;/span&gt; &lt;br/&gt;  &lt;span&gt;&quot;leader_index&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;&quot;logs-cluster2&quot;&lt;/span&gt; &lt;br/&gt;&lt;span&gt;}&lt;/span&gt;&lt;br/&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;在集群 cluster02 上创建复制规则。&lt;/span&gt;&lt;/p&gt;&lt;pre data-tool=&quot;mdnice编辑器&quot;&gt;&lt;code&gt;&lt;span&gt;&lt;span&gt;PUT&lt;/span&gt; &lt;span&gt;logs-cluster1/_ccr/follow&lt;/span&gt; &lt;br/&gt;&lt;span&gt;{&lt;/span&gt; &lt;br/&gt;  &lt;span&gt;&quot;remote_cluster&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;&quot;es01&quot;,&lt;/span&gt; &lt;br/&gt;  &lt;span&gt;&quot;leader_index&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;&quot;logs-cluster1&quot;&lt;/span&gt; &lt;br/&gt;&lt;span&gt;}&lt;/span&gt;&lt;br/&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;h5 data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;9.3.5.3 设置别名&lt;/span&gt;&lt;/h5&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;在集群 cluster01 上设置别名。&lt;/span&gt;&lt;/p&gt;&lt;pre data-tool=&quot;mdnice编辑器&quot;&gt;&lt;code&gt;&lt;span&gt;&lt;span&gt;POST&lt;/span&gt; &lt;span&gt;_aliases&lt;/span&gt;&lt;br/&gt;&lt;span&gt;{&lt;/span&gt;&lt;br/&gt;  &lt;span&gt;&quot;actions&quot;:&lt;/span&gt; &lt;span&gt;[&lt;/span&gt;&lt;br/&gt;    &lt;span&gt;{&lt;/span&gt;&lt;br/&gt;      &lt;span&gt;&quot;add&quot;:&lt;/span&gt; &lt;span&gt;{&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;&quot;index&quot;:&lt;/span&gt; &lt;span&gt;&quot;logs-cluster1&quot;,&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;&quot;alias&quot;:&lt;/span&gt; &lt;span&gt;&quot;logs&quot;,&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;&quot;is_write_index&quot;:&lt;/span&gt; &lt;span&gt;true&lt;/span&gt;&lt;br/&gt;      &lt;span&gt;}&lt;/span&gt;&lt;br/&gt;    &lt;span&gt;}&lt;/span&gt;&lt;br/&gt;  &lt;span&gt;]&lt;/span&gt;&lt;br/&gt;&lt;span&gt;}&lt;/span&gt;&lt;br/&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;在集群 cluster02 上设置别名。&lt;/span&gt;&lt;/p&gt;&lt;pre data-tool=&quot;mdnice编辑器&quot;&gt;&lt;code&gt;&lt;span&gt;&lt;span&gt;POST&lt;/span&gt; &lt;span&gt;_aliases&lt;/span&gt;&lt;br/&gt;&lt;span&gt;{&lt;/span&gt;&lt;br/&gt;  &lt;span&gt;&quot;actions&quot;:&lt;/span&gt; &lt;span&gt;[&lt;/span&gt;&lt;br/&gt;    &lt;span&gt;{&lt;/span&gt;&lt;br/&gt;      &lt;span&gt;&quot;add&quot;:&lt;/span&gt; &lt;span&gt;{&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;&quot;index&quot;:&lt;/span&gt; &lt;span&gt;&quot;logs-cluster2&quot;,&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;&quot;alias&quot;:&lt;/span&gt; &lt;span&gt;&quot;logs&quot;,&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;&quot;is_write_index&quot;:&lt;/span&gt; &lt;span&gt;true&lt;/span&gt;&lt;br/&gt;      &lt;span&gt;}&lt;/span&gt;&lt;br/&gt;    &lt;span&gt;}&lt;/span&gt;&lt;br/&gt;  &lt;span&gt;]&lt;/span&gt;&lt;br/&gt;&lt;span&gt;}&lt;/span&gt;&lt;br/&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;稍等几秒等待别名同步完成。在集群 cluster01 上查看别名。&lt;/span&gt;&lt;/p&gt;&lt;pre data-tool=&quot;mdnice编辑器&quot;&gt;&lt;code&gt;&lt;span&gt;&lt;span&gt;GET&lt;/span&gt; &lt;span&gt;_cat/aliases/logs?v&lt;/span&gt;&lt;br/&gt;&lt;br/&gt;&lt;span&gt;# 返回结果&lt;/span&gt;&lt;br/&gt;&lt;span&gt;alias&lt;/span&gt; &lt;span&gt;index&lt;/span&gt;         &lt;span&gt;filter&lt;/span&gt; &lt;span&gt;routing.index&lt;/span&gt; &lt;span&gt;routing.search&lt;/span&gt; &lt;span&gt;is_write_index&lt;/span&gt;&lt;br/&gt;&lt;span&gt;logs&lt;/span&gt;  &lt;span&gt;logs-cluster2&lt;/span&gt; &lt;span&gt;-&lt;/span&gt;      &lt;span&gt;-&lt;/span&gt;             &lt;span&gt;-&lt;/span&gt;              &lt;span&gt;false&lt;/span&gt;&lt;br/&gt;&lt;span&gt;logs&lt;/span&gt;  &lt;span&gt;logs-cluster1&lt;/span&gt; &lt;span&gt;-&lt;/span&gt;      &lt;span&gt;-&lt;/span&gt;             &lt;span&gt;-&lt;/span&gt;              &lt;span&gt;true&lt;/span&gt;&lt;br/&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;在集群 cluster02 上查看别名。&lt;/span&gt;&lt;/p&gt;&lt;pre data-tool=&quot;mdnice编辑器&quot;&gt;&lt;code&gt;&lt;span&gt;&lt;span&gt;GET&lt;/span&gt; &lt;span&gt;_cat/aliases/logs?v&lt;/span&gt;&lt;br/&gt;&lt;br/&gt;&lt;span&gt;# 返回结果&lt;/span&gt;&lt;br/&gt;&lt;span&gt;alias&lt;/span&gt; &lt;span&gt;index&lt;/span&gt;         &lt;span&gt;filter&lt;/span&gt; &lt;span&gt;routing.index&lt;/span&gt; &lt;span&gt;routing.search&lt;/span&gt; &lt;span&gt;is_write_index&lt;/span&gt;&lt;br/&gt;&lt;span&gt;logs&lt;/span&gt;  &lt;span&gt;logs-cluster1&lt;/span&gt; &lt;span&gt;-&lt;/span&gt;      &lt;span&gt;-&lt;/span&gt;             &lt;span&gt;-&lt;/span&gt;              &lt;span&gt;false&lt;/span&gt;&lt;br/&gt;&lt;span&gt;logs&lt;/span&gt;  &lt;span&gt;logs-cluster2&lt;/span&gt; &lt;span&gt;-&lt;/span&gt;      &lt;span&gt;-&lt;/span&gt;             &lt;span&gt;-&lt;/span&gt;              &lt;span&gt;true&lt;/span&gt;&lt;br/&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;可以看到在集群 cluster01 上别名 logs 中包含两个索引，其中 logs-cluster-1 是在 cluster01 集群上可以进行写操作的，logs-cluster-2 索引只读，用于从 cluster02 集群上复制数据。集群  cluster02 上别名 logs 中也包含两个索引，和集群 cluster01 上的情况相反。&lt;/span&gt;&lt;/p&gt;&lt;h5 data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;9.3.5.4 验证同步&lt;/span&gt;&lt;/h5&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;往集群 cluster01 中插入一条文档。&lt;/span&gt;&lt;/p&gt;&lt;pre data-tool=&quot;mdnice编辑器&quot;&gt;&lt;code&gt;&lt;span&gt;&lt;span&gt;POST&lt;/span&gt; &lt;span&gt;logs/_doc&lt;/span&gt;&lt;br/&gt;&lt;span&gt;{&lt;/span&gt;&lt;br/&gt;   &lt;span&gt;&quot;message&quot;:&lt;/span&gt; &lt;span&gt;&quot;log from cluster01&quot;&lt;/span&gt;&lt;br/&gt;&lt;span&gt;}&lt;/span&gt;&lt;br/&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;往集群 cluster02 中插入一条文档。&lt;/span&gt;&lt;/p&gt;&lt;pre data-tool=&quot;mdnice编辑器&quot;&gt;&lt;code&gt;&lt;span&gt;&lt;span&gt;POST&lt;/span&gt; &lt;span&gt;logs/_doc&lt;/span&gt;&lt;br/&gt;&lt;span&gt;{&lt;/span&gt;&lt;br/&gt;   &lt;span&gt;&quot;message&quot;:&lt;/span&gt; &lt;span&gt;&quot;log from cluster02&quot;&lt;/span&gt;&lt;br/&gt;&lt;span&gt;}&lt;/span&gt;&lt;br/&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;在集群 cluster01 和集群 cluster02上都可以通过查询 log 别名找到两个文档。&lt;/span&gt;&lt;/p&gt;&lt;pre data-tool=&quot;mdnice编辑器&quot;&gt;&lt;code&gt;&lt;span&gt;&lt;span&gt;GET&lt;/span&gt; &lt;span&gt;logs/_search&lt;/span&gt;&lt;br/&gt;&lt;br/&gt;&lt;span&gt;# 返回结果&lt;/span&gt;&lt;br/&gt;&lt;span&gt;{&lt;/span&gt;&lt;br/&gt;  &lt;span&gt;&quot;took&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;695&lt;/span&gt;&lt;span&gt;,&lt;/span&gt;&lt;br/&gt;  &lt;span&gt;&quot;timed_out&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;false&lt;/span&gt;&lt;span&gt;,&lt;/span&gt;&lt;br/&gt;  &lt;span&gt;&quot;_shards&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;{&lt;/span&gt;&lt;br/&gt;    &lt;span&gt;&quot;total&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;2&lt;/span&gt;&lt;span&gt;,&lt;/span&gt;&lt;br/&gt;    &lt;span&gt;&quot;successful&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;2&lt;/span&gt;&lt;span&gt;,&lt;/span&gt;&lt;br/&gt;    &lt;span&gt;&quot;skipped&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;0&lt;/span&gt;&lt;span&gt;,&lt;/span&gt;&lt;br/&gt;    &lt;span&gt;&quot;failed&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;0&lt;/span&gt;&lt;br/&gt;  &lt;span&gt;},&lt;/span&gt;&lt;br/&gt;  &lt;span&gt;&quot;hits&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;{&lt;/span&gt;&lt;br/&gt;    &lt;span&gt;&quot;total&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;{&lt;/span&gt;&lt;br/&gt;      &lt;span&gt;&quot;value&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;2&lt;/span&gt;&lt;span&gt;,&lt;/span&gt;&lt;br/&gt;      &lt;span&gt;&quot;relation&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;&quot;eq&quot;&lt;/span&gt;&lt;br/&gt;    &lt;span&gt;},&lt;/span&gt;&lt;br/&gt;    &lt;span&gt;&quot;max_score&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;1.0&lt;/span&gt;&lt;span&gt;,&lt;/span&gt;&lt;br/&gt;    &lt;span&gt;&quot;hits&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;[&lt;/span&gt;&lt;br/&gt;      &lt;span&gt;{&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;&quot;_index&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;&quot;logs-cluster1&quot;,&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;&quot;_type&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;&quot;_doc&quot;,&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;&quot;_id&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;&quot;uyomAH4BgImMM5qO9z4z&quot;,&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;&quot;_score&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;1.0&lt;/span&gt;&lt;span&gt;,&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;&quot;_source&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;{&lt;/span&gt;&lt;br/&gt;          &lt;span&gt;&quot;message&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;&quot;log from cluster01&quot;&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;}&lt;/span&gt;&lt;br/&gt;      &lt;span&gt;},&lt;/span&gt;&lt;br/&gt;      &lt;span&gt;{&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;&quot;_index&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;&quot;logs-cluster2&quot;,&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;&quot;_type&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;&quot;_doc&quot;,&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;&quot;_id&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;&quot;tZYnAH4BzSYcxWyKEv6B&quot;,&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;&quot;_score&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;1.0&lt;/span&gt;&lt;span&gt;,&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;&quot;_source&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;{&lt;/span&gt;&lt;br/&gt;          &lt;span&gt;&quot;message&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;&quot;log from cluster02&quot;&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;}&lt;/span&gt;&lt;br/&gt;      &lt;span&gt;}&lt;/span&gt;&lt;br/&gt;    &lt;span&gt;]&lt;/span&gt;&lt;br/&gt;  &lt;span&gt;}&lt;/span&gt;&lt;br/&gt;&lt;span&gt;}&lt;/span&gt;&lt;br/&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;h4 data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;9.3.6 故障测试&lt;/span&gt;&lt;/h4&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;基于双向复制的情况下，停止 es01 容器，模拟 Elasticsearch 集群故障场景。&lt;/span&gt;&lt;/p&gt;&lt;pre data-tool=&quot;mdnice编辑器&quot;&gt;&lt;code&gt;&lt;span&gt;docker-compose stop es01&lt;br/&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;此时集群 cluster01 已经不可用。&lt;/span&gt;&lt;/p&gt;&lt;figure data-tool=&quot;mdnice编辑器&quot;&gt;&lt;img class=&quot;rich_pages wxw-img&quot; data-ratio=&quot;0.42144302090357383&quot; data-src=&quot;https://mmbiz.qpic.cn/mmbiz_png/mjl8GCpsL9auhKTS8YiaHLpE37Swaxib50qIvXr9GxP1ARUbngZl4j9o9M86IW2rAaZTpdJCQ4iajiaPSkYdkBk5cg/640?wx_fmt=png&quot; data-type=&quot;png&quot; data-w=&quot;1483&quot;/&gt;&lt;/figure&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;接着往集群 cluster02 中插入 1 条文档。&lt;/span&gt;&lt;/p&gt;&lt;pre data-tool=&quot;mdnice编辑器&quot;&gt;&lt;code&gt;&lt;span&gt;&lt;span&gt;POST&lt;/span&gt; &lt;span&gt;logs/_doc&lt;/span&gt;&lt;br/&gt;&lt;span&gt;{&lt;/span&gt;&lt;br/&gt;   &lt;span&gt;&quot;message&quot;:&lt;/span&gt; &lt;span&gt;&quot;new log from cluster02&quot;&lt;/span&gt;&lt;br/&gt;&lt;span&gt;}&lt;/span&gt;&lt;br/&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;重新启动 es01 容器。&lt;/span&gt;&lt;/p&gt;&lt;pre data-tool=&quot;mdnice编辑器&quot;&gt;&lt;code&gt;&lt;span&gt;docker-compose start es01&lt;br/&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;在集群 cluster01 上查看数据，可以看到新写入的文档也已经成功复制过来了。&lt;/span&gt;&lt;/p&gt;&lt;pre data-tool=&quot;mdnice编辑器&quot;&gt;&lt;code&gt;&lt;span&gt;&lt;span&gt;GET&lt;/span&gt; &lt;span&gt;logs/_search&lt;/span&gt;&lt;br/&gt;&lt;br/&gt;&lt;span&gt;# 返回结果&lt;/span&gt;&lt;br/&gt;&lt;span&gt;{&lt;/span&gt;&lt;br/&gt;  &lt;span&gt;&quot;took&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;9&lt;/span&gt;&lt;span&gt;,&lt;/span&gt;&lt;br/&gt;  &lt;span&gt;&quot;timed_out&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;false&lt;/span&gt;&lt;span&gt;,&lt;/span&gt;&lt;br/&gt;  &lt;span&gt;&quot;_shards&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;{&lt;/span&gt;&lt;br/&gt;    &lt;span&gt;&quot;total&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;2&lt;/span&gt;&lt;span&gt;,&lt;/span&gt;&lt;br/&gt;    &lt;span&gt;&quot;successful&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;2&lt;/span&gt;&lt;span&gt;,&lt;/span&gt;&lt;br/&gt;    &lt;span&gt;&quot;skipped&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;0&lt;/span&gt;&lt;span&gt;,&lt;/span&gt;&lt;br/&gt;    &lt;span&gt;&quot;failed&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;0&lt;/span&gt;&lt;br/&gt;  &lt;span&gt;},&lt;/span&gt;&lt;br/&gt;  &lt;span&gt;&quot;hits&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;{&lt;/span&gt;&lt;br/&gt;    &lt;span&gt;&quot;total&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;{&lt;/span&gt;&lt;br/&gt;      &lt;span&gt;&quot;value&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;3&lt;/span&gt;&lt;span&gt;,&lt;/span&gt;&lt;br/&gt;      &lt;span&gt;&quot;relation&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;&quot;eq&quot;&lt;/span&gt;&lt;br/&gt;    &lt;span&gt;},&lt;/span&gt;&lt;br/&gt;    &lt;span&gt;&quot;max_score&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;1.0&lt;/span&gt;&lt;span&gt;,&lt;/span&gt;&lt;br/&gt;    &lt;span&gt;&quot;hits&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;[&lt;/span&gt;&lt;br/&gt;      &lt;span&gt;{&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;&quot;_index&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;&quot;logs-cluster1&quot;,&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;&quot;_type&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;&quot;_doc&quot;,&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;&quot;_id&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;&quot;UnNID34BlVYq_ve0ntZy&quot;,&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;&quot;_score&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;1.0&lt;/span&gt;&lt;span&gt;,&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;&quot;_source&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;{&lt;/span&gt;&lt;br/&gt;          &lt;span&gt;&quot;message&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;&quot;log from cluster01&quot;&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;}&lt;/span&gt;&lt;br/&gt;      &lt;span&gt;},&lt;/span&gt;&lt;br/&gt;      &lt;span&gt;{&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;&quot;_index&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;&quot;logs-cluster2&quot;,&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;&quot;_type&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;&quot;_doc&quot;,&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;&quot;_id&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;&quot;d9dID34BhqtuOGGDt6wB&quot;,&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;&quot;_score&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;1.0&lt;/span&gt;&lt;span&gt;,&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;&quot;_source&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;{&lt;/span&gt;&lt;br/&gt;          &lt;span&gt;&quot;message&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;&quot;log from cluster02&quot;&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;}&lt;/span&gt;&lt;br/&gt;      &lt;span&gt;},&lt;/span&gt;&lt;br/&gt;      &lt;span&gt;{&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;&quot;_index&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;&quot;logs-cluster2&quot;,&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;&quot;_type&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;&quot;_doc&quot;,&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;&quot;_id&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;&quot;ftdLD34BhqtuOGGDRKyS&quot;,&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;&quot;_score&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;1.0&lt;/span&gt;&lt;span&gt;,&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;&quot;_source&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;{&lt;/span&gt;&lt;br/&gt;          &lt;span&gt;&quot;message&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;&quot;new log from cluster02&quot;&lt;/span&gt;  &lt;span&gt;# 新插入的文档&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;}&lt;/span&gt;&lt;br/&gt;      &lt;span&gt;}&lt;/span&gt;&lt;br/&gt;    &lt;span&gt;]&lt;/span&gt;&lt;br/&gt;  &lt;span&gt;}&lt;/span&gt;&lt;br/&gt;&lt;span&gt;}&lt;/span&gt;&lt;br/&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;h4 data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;9.3.7 清理现场&lt;/span&gt;&lt;/h4&gt;&lt;pre data-tool=&quot;mdnice编辑器&quot;&gt;&lt;code&gt;&lt;span&gt;&lt;span&gt;cd&lt;/span&gt; ccr&lt;br/&gt;&lt;span&gt;# -v 参数表示删除 volume&lt;/span&gt;&lt;br/&gt;docker-compose down -v &lt;br/&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;h3 data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;&lt;span&gt;9.4 借助消息队列实现双写&lt;/span&gt;&lt;/span&gt;&lt;/h3&gt;&lt;h4 data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;9.4.1 环境准备&lt;/span&gt;&lt;/h4&gt;&lt;h5 data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;9.4.1.1 配置文件&lt;/span&gt;&lt;/h5&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;docker-compose.yml 文件如下所示。&lt;/span&gt;&lt;/p&gt;&lt;pre data-tool=&quot;mdnice编辑器&quot;&gt;&lt;code&gt;&lt;span&gt;&lt;span&gt;version:&lt;/span&gt; &lt;span&gt;&#x27;3.8&#x27;&lt;/span&gt;&lt;br/&gt;&lt;span&gt;services:&lt;/span&gt;&lt;br/&gt;  &lt;span&gt;# 集群 cluster01&lt;/span&gt;&lt;br/&gt;  &lt;span&gt;# Elasticsearch&lt;/span&gt;&lt;br/&gt;  &lt;span&gt;es01:&lt;/span&gt;&lt;br/&gt;    &lt;span&gt;image:&lt;/span&gt; &lt;span&gt;docker.elastic.co/elasticsearch/elasticsearch:7.16.2&lt;/span&gt;&lt;br/&gt;    &lt;span&gt;container_name:&lt;/span&gt; &lt;span&gt;es01&lt;/span&gt;&lt;br/&gt;    &lt;span&gt;environment:&lt;/span&gt;&lt;br/&gt;      &lt;span&gt;# 节点名&lt;/span&gt;&lt;br/&gt;      &lt;span&gt;-&lt;/span&gt; &lt;span&gt;node.name=es01&lt;/span&gt;&lt;br/&gt;      &lt;span&gt;# 集群名&lt;/span&gt;&lt;br/&gt;      &lt;span&gt;-&lt;/span&gt; &lt;span&gt;cluster.name=cluster01&lt;/span&gt;&lt;br/&gt;      &lt;span&gt;# 指定单节点启动&lt;/span&gt;&lt;br/&gt;      &lt;span&gt;-&lt;/span&gt; &lt;span&gt;discovery.type=single-node&lt;/span&gt;&lt;br/&gt;      &lt;span&gt;# 开启内存锁定&lt;/span&gt;&lt;br/&gt;      &lt;span&gt;-&lt;/span&gt; &lt;span&gt;bootstrap.memory_lock=true&lt;/span&gt;&lt;br/&gt;      &lt;span&gt;# 设置内存大小&lt;/span&gt;&lt;br/&gt;      &lt;span&gt;-&lt;/span&gt; &lt;span&gt;&quot;ES_JAVA_OPTS=-Xms2g -Xmx2g&quot;&lt;/span&gt;&lt;br/&gt;      &lt;span&gt;# 启用安全&lt;/span&gt;&lt;br/&gt;      &lt;span&gt;-&lt;/span&gt; &lt;span&gt;xpack.security.enabled=true&lt;/span&gt;&lt;br/&gt;      &lt;span&gt;# 设置 elastic 用户密码&lt;/span&gt;&lt;br/&gt;      &lt;span&gt;-&lt;/span&gt; &lt;span&gt;ELASTIC_PASSWORD=test123&lt;/span&gt;&lt;br/&gt;    &lt;span&gt;ulimits:&lt;/span&gt;&lt;br/&gt;      &lt;span&gt;memlock:&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;soft:&lt;/span&gt; &lt;span&gt;-1&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;hard:&lt;/span&gt; &lt;span&gt;-1&lt;/span&gt;&lt;br/&gt;    &lt;span&gt;# 映射到主机名的端口 宿主机端口:容器端口&lt;/span&gt;&lt;br/&gt;    &lt;span&gt;ports:&lt;/span&gt;&lt;br/&gt;      &lt;span&gt;-&lt;/span&gt; &lt;span&gt;9200&lt;/span&gt;&lt;span&gt;:9200&lt;/span&gt;&lt;br/&gt;    &lt;span&gt;volumes:&lt;/span&gt;&lt;br/&gt;      &lt;span&gt;-&lt;/span&gt; &lt;span&gt;data01:/usr/share/elasticsearch/data&lt;/span&gt;&lt;br/&gt;    &lt;span&gt;networks:&lt;/span&gt;&lt;br/&gt;      &lt;span&gt;-&lt;/span&gt; &lt;span&gt;elastic&lt;/span&gt;&lt;br/&gt;  &lt;span&gt;# Kibana&lt;/span&gt;&lt;br/&gt;  &lt;span&gt;kib01:&lt;/span&gt;&lt;br/&gt;    &lt;span&gt;image:&lt;/span&gt; &lt;span&gt;docker.elastic.co/kibana/kibana:7.16.2&lt;/span&gt;&lt;br/&gt;    &lt;span&gt;container_name:&lt;/span&gt; &lt;span&gt;kib01&lt;/span&gt;&lt;br/&gt;    &lt;span&gt;ports:&lt;/span&gt;&lt;br/&gt;      &lt;span&gt;-&lt;/span&gt; &lt;span&gt;5601&lt;/span&gt;&lt;span&gt;:5601&lt;/span&gt;&lt;br/&gt;    &lt;span&gt;environment:&lt;/span&gt;&lt;br/&gt;      &lt;span&gt;# Elasticsearch 连接信息&lt;/span&gt;&lt;br/&gt;      &lt;span&gt;ELASTICSEARCH_URL:&lt;/span&gt; &lt;span&gt;http://es01:9200&lt;/span&gt;&lt;br/&gt;      &lt;span&gt;ELASTICSEARCH_HOSTS:&lt;/span&gt; &lt;span&gt;&#x27;[&quot;http://es01:9200&quot;]&#x27;&lt;/span&gt;&lt;br/&gt;      &lt;span&gt;ELASTICSEARCH_USERNAME:&lt;/span&gt; &lt;span&gt;elastic&lt;/span&gt;&lt;br/&gt;      &lt;span&gt;ELASTICSEARCH_PASSWORD:&lt;/span&gt; &lt;span&gt;test123&lt;/span&gt;&lt;br/&gt;    &lt;span&gt;networks:&lt;/span&gt;&lt;br/&gt;      &lt;span&gt;-&lt;/span&gt; &lt;span&gt;elastic&lt;/span&gt;&lt;br/&gt;&lt;br/&gt;  &lt;span&gt;# 集群 cluster2&lt;/span&gt;&lt;br/&gt;  &lt;span&gt;es02:&lt;/span&gt;&lt;br/&gt;    &lt;span&gt;image:&lt;/span&gt; &lt;span&gt;docker.elastic.co/elasticsearch/elasticsearch:7.16.2&lt;/span&gt;&lt;br/&gt;    &lt;span&gt;container_name:&lt;/span&gt; &lt;span&gt;es02&lt;/span&gt;&lt;br/&gt;    &lt;span&gt;environment:&lt;/span&gt;&lt;br/&gt;      &lt;span&gt;-&lt;/span&gt; &lt;span&gt;node.name=es02&lt;/span&gt;&lt;br/&gt;      &lt;span&gt;-&lt;/span&gt; &lt;span&gt;cluster.name=cluster02&lt;/span&gt;&lt;br/&gt;      &lt;span&gt;-&lt;/span&gt; &lt;span&gt;discovery.type=single-node&lt;/span&gt;&lt;br/&gt;      &lt;span&gt;-&lt;/span&gt; &lt;span&gt;bootstrap.memory_lock=true&lt;/span&gt;&lt;br/&gt;      &lt;span&gt;-&lt;/span&gt; &lt;span&gt;&quot;ES_JAVA_OPTS=-Xms2g -Xmx2g&quot;&lt;/span&gt;&lt;br/&gt;      &lt;span&gt;-&lt;/span&gt; &lt;span&gt;xpack.security.enabled=true&lt;/span&gt;&lt;br/&gt;      &lt;span&gt;-&lt;/span&gt; &lt;span&gt;ELASTIC_PASSWORD=test123&lt;/span&gt;&lt;br/&gt;    &lt;span&gt;ulimits:&lt;/span&gt;&lt;br/&gt;      &lt;span&gt;memlock:&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;soft:&lt;/span&gt; &lt;span&gt;-1&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;hard:&lt;/span&gt; &lt;span&gt;-1&lt;/span&gt;&lt;br/&gt;    &lt;span&gt;ports:&lt;/span&gt;&lt;br/&gt;      &lt;span&gt;-&lt;/span&gt; &lt;span&gt;9201&lt;/span&gt;&lt;span&gt;:9200&lt;/span&gt;&lt;br/&gt;    &lt;span&gt;volumes:&lt;/span&gt;&lt;br/&gt;      &lt;span&gt;-&lt;/span&gt; &lt;span&gt;data02:/usr/share/elasticsearch/data&lt;/span&gt;&lt;br/&gt;    &lt;span&gt;networks:&lt;/span&gt;&lt;br/&gt;      &lt;span&gt;-&lt;/span&gt; &lt;span&gt;elastic&lt;/span&gt;&lt;br/&gt;&lt;br/&gt;  &lt;span&gt;kib02:&lt;/span&gt;&lt;br/&gt;    &lt;span&gt;image:&lt;/span&gt; &lt;span&gt;docker.elastic.co/kibana/kibana:7.16.2&lt;/span&gt;&lt;br/&gt;    &lt;span&gt;container_name:&lt;/span&gt; &lt;span&gt;kib02&lt;/span&gt;&lt;br/&gt;    &lt;span&gt;ports:&lt;/span&gt;&lt;br/&gt;      &lt;span&gt;-&lt;/span&gt; &lt;span&gt;5602&lt;/span&gt;&lt;span&gt;:5601&lt;/span&gt;&lt;br/&gt;    &lt;span&gt;environment:&lt;/span&gt;&lt;br/&gt;      &lt;span&gt;ELASTICSEARCH_URL:&lt;/span&gt; &lt;span&gt;http://es02:9200&lt;/span&gt;&lt;br/&gt;      &lt;span&gt;ELASTICSEARCH_HOSTS:&lt;/span&gt; &lt;span&gt;&#x27;[&quot;http://es02:9200&quot;]&#x27;&lt;/span&gt;&lt;br/&gt;      &lt;span&gt;ELASTICSEARCH_USERNAME:&lt;/span&gt; &lt;span&gt;elastic&lt;/span&gt;&lt;br/&gt;      &lt;span&gt;ELASTICSEARCH_PASSWORD:&lt;/span&gt; &lt;span&gt;test123&lt;/span&gt;&lt;br/&gt;    &lt;span&gt;networks:&lt;/span&gt;&lt;br/&gt;      &lt;span&gt;-&lt;/span&gt; &lt;span&gt;elastic&lt;/span&gt;&lt;br/&gt;  &lt;br/&gt;  &lt;span&gt;zookeeper:&lt;/span&gt;&lt;br/&gt;    &lt;span&gt;image:&lt;/span&gt; &lt;span&gt;bitnami/zookeeper:latest&lt;/span&gt;&lt;br/&gt;    &lt;span&gt;container_name:&lt;/span&gt; &lt;span&gt;zookeeper&lt;/span&gt;&lt;br/&gt;    &lt;span&gt;user:&lt;/span&gt; &lt;span&gt;root&lt;/span&gt;&lt;br/&gt;    &lt;span&gt;ports:&lt;/span&gt;&lt;br/&gt;      &lt;span&gt;-&lt;/span&gt; &lt;span&gt;2181&lt;/span&gt;&lt;span&gt;:2181&lt;/span&gt;&lt;br/&gt;    &lt;span&gt;environment:&lt;/span&gt;&lt;br/&gt;      &lt;span&gt;-&lt;/span&gt; &lt;span&gt;ALLOW_ANONYMOUS_LOGIN=yes&lt;/span&gt;&lt;br/&gt;    &lt;span&gt;networks:&lt;/span&gt;&lt;br/&gt;      &lt;span&gt;-&lt;/span&gt; &lt;span&gt;elastic&lt;/span&gt;&lt;br/&gt;  &lt;br/&gt;  &lt;span&gt;# 消息队列&lt;/span&gt;&lt;br/&gt;  &lt;span&gt;kafka:&lt;/span&gt;&lt;br/&gt;    &lt;span&gt;image:&lt;/span&gt; &lt;span&gt;bitnami/kafka:latest&lt;/span&gt;&lt;br/&gt;    &lt;span&gt;container_name:&lt;/span&gt; &lt;span&gt;kafka&lt;/span&gt;&lt;br/&gt;    &lt;span&gt;user:&lt;/span&gt; &lt;span&gt;root&lt;/span&gt;&lt;br/&gt;    &lt;span&gt;ports:&lt;/span&gt;&lt;br/&gt;      &lt;span&gt;-&lt;/span&gt; &lt;span&gt;9092&lt;/span&gt;&lt;span&gt;:9092&lt;/span&gt;&lt;br/&gt;    &lt;span&gt;environment:&lt;/span&gt;&lt;br/&gt;      &lt;span&gt;-&lt;/span&gt; &lt;span&gt;KAFKA_BROKER_ID=1&lt;/span&gt;&lt;br/&gt;      &lt;span&gt;-&lt;/span&gt; &lt;span&gt;KAFKA_CFG_LISTENERS=PLAINTEXT://:9092&lt;/span&gt;&lt;br/&gt;      &lt;span&gt;-&lt;/span&gt; &lt;span&gt;KAFKA_CFG_ADVERTISED_LISTENERS=PLAINTEXT://kafka:9092&lt;/span&gt;&lt;br/&gt;      &lt;span&gt;-&lt;/span&gt; &lt;span&gt;KAFKA_CFG_ZOOKEEPER_CONNECT=zookeeper:2181&lt;/span&gt;&lt;br/&gt;      &lt;span&gt;-&lt;/span&gt; &lt;span&gt;ALLOW_PLAINTEXT_LISTENER=yes&lt;/span&gt;&lt;br/&gt;    &lt;span&gt;depends_on:&lt;/span&gt;&lt;br/&gt;      &lt;span&gt;-&lt;/span&gt; &lt;span&gt;zookeeper&lt;/span&gt;&lt;br/&gt;    &lt;span&gt;networks:&lt;/span&gt;&lt;br/&gt;      &lt;span&gt;-&lt;/span&gt; &lt;span&gt;elastic&lt;/span&gt;&lt;br/&gt;&lt;br/&gt;  &lt;span&gt;# 消费者&lt;/span&gt;&lt;br/&gt;  &lt;span&gt;logstash01:&lt;/span&gt;&lt;br/&gt;    &lt;span&gt;image:&lt;/span&gt; &lt;span&gt;docker.elastic.co/logstash/logstash:7.16.2&lt;/span&gt;&lt;br/&gt;    &lt;span&gt;container_name:&lt;/span&gt; &lt;span&gt;logstash01&lt;/span&gt;&lt;br/&gt;    &lt;span&gt;ports:&lt;/span&gt;&lt;br/&gt;      &lt;span&gt;-&lt;/span&gt; &lt;span&gt;9600&lt;/span&gt;&lt;span&gt;:9600&lt;/span&gt;&lt;br/&gt;    &lt;span&gt;volumes:&lt;/span&gt;&lt;br/&gt;      &lt;span&gt;-&lt;/span&gt; &lt;span&gt;./logstash-cluster01.conf:/usr/share/logstash/pipeline/logstash.conf&lt;/span&gt;&lt;br/&gt;    &lt;span&gt;networks:&lt;/span&gt;&lt;br/&gt;      &lt;span&gt;-&lt;/span&gt; &lt;span&gt;elastic&lt;/span&gt;&lt;br/&gt;   &lt;br/&gt;  &lt;span&gt;logstash02:&lt;/span&gt;&lt;br/&gt;    &lt;span&gt;image:&lt;/span&gt; &lt;span&gt;docker.elastic.co/logstash/logstash:7.16.2&lt;/span&gt;&lt;br/&gt;    &lt;span&gt;container_name:&lt;/span&gt; &lt;span&gt;logstash02&lt;/span&gt;&lt;br/&gt;    &lt;span&gt;ports:&lt;/span&gt;&lt;br/&gt;      &lt;span&gt;-&lt;/span&gt; &lt;span&gt;9601&lt;/span&gt;&lt;span&gt;:9600&lt;/span&gt;&lt;br/&gt;    &lt;span&gt;volumes:&lt;/span&gt;&lt;br/&gt;      &lt;span&gt;-&lt;/span&gt; &lt;span&gt;./logstash-cluster02.conf:/usr/share/logstash/pipeline/logstash.conf&lt;/span&gt;&lt;br/&gt;    &lt;span&gt;networks:&lt;/span&gt;&lt;br/&gt;      &lt;span&gt;-&lt;/span&gt; &lt;span&gt;elastic&lt;/span&gt;&lt;br/&gt;&lt;br/&gt;&lt;span&gt;# 存储卷&lt;/span&gt;&lt;br/&gt;&lt;span&gt;volumes:&lt;/span&gt;&lt;br/&gt;  &lt;span&gt;data01:&lt;/span&gt;&lt;br/&gt;    &lt;span&gt;driver:&lt;/span&gt; &lt;span&gt;local&lt;/span&gt;&lt;br/&gt;  &lt;span&gt;data02:&lt;/span&gt;&lt;br/&gt;    &lt;span&gt;driver:&lt;/span&gt; &lt;span&gt;local&lt;/span&gt;&lt;br/&gt;&lt;br/&gt;&lt;span&gt;# 网络&lt;/span&gt;&lt;br/&gt;&lt;span&gt;networks:&lt;/span&gt;&lt;br/&gt;  &lt;span&gt;elastic:&lt;/span&gt;&lt;br/&gt;    &lt;span&gt;driver:&lt;/span&gt; &lt;span&gt;bridge&lt;/span&gt;&lt;br/&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;这里使用 Logstash 来消费 Kafka 集群中的数据，然后写入 Elasticsearch 集群。集群 cluster01 和 cluster02 分别对应一组 Logstash，使用不同的消费者组 id。Logstash 的配置文件如下：&lt;/span&gt;&lt;/p&gt;&lt;pre data-tool=&quot;mdnice编辑器&quot;&gt;&lt;code&gt;&lt;span&gt;&lt;span&gt;input&lt;/span&gt; &lt;span&gt;{&lt;/span&gt;&lt;br/&gt;     &lt;span&gt;kafka&lt;/span&gt; &lt;span&gt;{&lt;/span&gt;&lt;br/&gt;         &lt;span&gt;codec&lt;/span&gt; &lt;span&gt;=&amp;gt;&lt;/span&gt; &lt;span&gt;&quot;json&quot;&lt;/span&gt;&lt;br/&gt;         &lt;span&gt;topics&lt;/span&gt; &lt;span&gt;=&amp;gt;&lt;/span&gt; &lt;span&gt;[&quot;index-1&quot;]&lt;/span&gt;&lt;br/&gt;         &lt;span&gt;group_id&lt;/span&gt; &lt;span&gt;=&amp;gt;&lt;/span&gt; &lt;span&gt;&quot;logstash_cluster01&quot;&lt;/span&gt;&lt;br/&gt;         &lt;span&gt;consumer_threads&lt;/span&gt; &lt;span&gt;=&amp;gt;&lt;/span&gt; &lt;span&gt;1&lt;/span&gt;&lt;br/&gt;         &lt;span&gt;bootstrap_servers&lt;/span&gt; &lt;span&gt;=&amp;gt;&lt;/span&gt; &lt;span&gt;&quot;kafka:9092&quot;&lt;/span&gt;&lt;br/&gt;    &lt;span&gt;}&lt;/span&gt;&lt;br/&gt;&lt;span&gt;}&lt;/span&gt;&lt;br/&gt;&lt;br/&gt;&lt;span&gt;output&lt;/span&gt; &lt;span&gt;{&lt;/span&gt;&lt;br/&gt;    &lt;span&gt;elasticsearch&lt;/span&gt; &lt;span&gt;{&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;hosts&lt;/span&gt; &lt;span&gt;=&amp;gt;&lt;/span&gt; &lt;span&gt;[&quot;es01:9200&quot;]&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;index&lt;/span&gt; &lt;span&gt;=&amp;gt;&lt;/span&gt; &lt;span&gt;&quot;index-1&quot;&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;user&lt;/span&gt; &lt;span&gt;=&amp;gt;&lt;/span&gt; &lt;span&gt;&quot;elastic&quot;&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;password&lt;/span&gt; &lt;span&gt;=&amp;gt;&lt;/span&gt; &lt;span&gt;&quot;test123&quot;&lt;/span&gt;&lt;br/&gt;    &lt;span&gt;}&lt;/span&gt;&lt;br/&gt;&lt;span&gt;}&lt;/span&gt;&lt;br/&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;h5 data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;9.4.1.2 启动容器&lt;/span&gt;&lt;/h5&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;进入消息队列实验目录，启动容器。&lt;/span&gt;&lt;/p&gt;&lt;pre data-tool=&quot;mdnice编辑器&quot;&gt;&lt;code&gt;&lt;span&gt;&lt;span&gt;cd&lt;/span&gt; mq&lt;br/&gt;docker-compose up -d&lt;br/&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;查看容器状态。&lt;/span&gt;&lt;/p&gt;&lt;pre data-tool=&quot;mdnice编辑器&quot;&gt;&lt;code&gt;&lt;span&gt;$ docker-compose ps&lt;br/&gt;   Name                 Command               State                                   Ports                                 &lt;br/&gt;----------------------------------------------------------------------------------------------------------------------------&lt;br/&gt;es01         /bin/tini -- /usr/&lt;span&gt;local&lt;/span&gt;/bi ...   Up      0.0.0.0:9200-&amp;gt;9200/tcp,:::9200-&amp;gt;9200/tcp, 9300/tcp                    &lt;br/&gt;es02         /bin/tini -- /usr/&lt;span&gt;local&lt;/span&gt;/bi ...   Up      0.0.0.0:9201-&amp;gt;9200/tcp,:::9201-&amp;gt;9200/tcp, 9300/tcp                    &lt;br/&gt;kafka        /opt/bitnami/scripts/kafka ...   Up      0.0.0.0:9092-&amp;gt;9092/tcp,:::9092-&amp;gt;9092/tcp                              &lt;br/&gt;kib01        /bin/tini -- /usr/&lt;span&gt;local&lt;/span&gt;/bi ...   Up      0.0.0.0:5601-&amp;gt;5601/tcp,:::5601-&amp;gt;5601/tcp                              &lt;br/&gt;kib02        /bin/tini -- /usr/&lt;span&gt;local&lt;/span&gt;/bi ...   Up      0.0.0.0:5602-&amp;gt;5601/tcp,:::5602-&amp;gt;5601/tcp                              &lt;br/&gt;logstash01   /usr/&lt;span&gt;local&lt;/span&gt;/bin/docker-entr ...   Up      5044/tcp, 0.0.0.0:9600-&amp;gt;9600/tcp,:::9600-&amp;gt;9600/tcp                    &lt;br/&gt;logstash02   /usr/&lt;span&gt;local&lt;/span&gt;/bin/docker-entr ...   Up      5044/tcp, 0.0.0.0:9601-&amp;gt;9600/tcp,:::9601-&amp;gt;9600/tcp                    &lt;br/&gt;zookeeper    /opt/bitnami/scripts/zooke ...   Up      0.0.0.0:2181-&amp;gt;2181/tcp,:::2181-&amp;gt;2181/tcp, 2888/tcp, 3888/tcp, 8080/tcp&lt;br/&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;h4 data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;9.4.2 创建 Topic&lt;/span&gt;&lt;/h4&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;使用 exec 命令进入 Kafka 容器中。&lt;/span&gt;&lt;/p&gt;&lt;pre data-tool=&quot;mdnice编辑器&quot;&gt;&lt;code&gt;&lt;span&gt;docker-compose &lt;span&gt;exec&lt;/span&gt; kafka bash&lt;br/&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;创建 Topic &lt;/span&gt;&lt;code&gt;&lt;span&gt;index-1&lt;/span&gt;&lt;/code&gt;&lt;span&gt; ，Logstash 将会消费这个 Topic 的消息并将数据写入 Elasticsearch 的 &lt;/span&gt;&lt;code&gt;&lt;span&gt;index-1&lt;/span&gt;&lt;/code&gt;&lt;span&gt; 索引中。&lt;/span&gt;&lt;/p&gt;&lt;pre data-tool=&quot;mdnice编辑器&quot;&gt;&lt;code&gt;&lt;span&gt;kafka-topics.sh --bootstrap-server 127.0.0.1:9092 \&lt;br/&gt;--create --topic index-1 --partitions 1 --replication-factor 1&lt;br/&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;查看创建的 Topic。&lt;/span&gt;&lt;/p&gt;&lt;pre data-tool=&quot;mdnice编辑器&quot;&gt;&lt;code&gt;&lt;span&gt;&lt;span&gt;# 列出 topic&lt;/span&gt;&lt;br/&gt;kafka-topics.sh --bootstrap-server 127.0.0.1:9092 --list &lt;br/&gt;&lt;br/&gt;&lt;span&gt;# 返回结果&lt;/span&gt;&lt;br/&gt;index-1&lt;br/&gt;&lt;br/&gt;&lt;span&gt;# 查看 topic index-1 分区和副本信息&lt;/span&gt;&lt;br/&gt;kafka-topics.sh --bootstrap-server 127.0.0.1:9092 \&lt;br/&gt;--describe --topic index-1&lt;br/&gt;&lt;br/&gt;&lt;span&gt;# 返回结果&lt;/span&gt;&lt;br/&gt;Topic: index-1  TopicId: ppi1f_loTn2p6BEGjM640w PartitionCount: 1       ReplicationFactor: 1    Configs: segment.bytes=1073741824&lt;br/&gt;        Topic: index-1  Partition: 0    Leader: 1       Replicas: 1     Isr: 1&lt;br/&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;h4 data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;9.4.3 验证同步&lt;/span&gt;&lt;/h4&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;往 Topic &lt;/span&gt;&lt;code&gt;&lt;span&gt;index-1&lt;/span&gt;&lt;/code&gt;&lt;span&gt; 中写入 3 条消息。&lt;/span&gt;&lt;/p&gt;&lt;pre data-tool=&quot;mdnice编辑器&quot;&gt;&lt;code&gt;&lt;span&gt;kafka-console-producer.sh --bootstrap-server 127.0.0.1:9092 \&lt;br/&gt;--topic index-1&lt;br/&gt;&lt;br/&gt;&lt;span&gt;# 输入 JSON 格式的数据&lt;/span&gt;&lt;br/&gt;&amp;gt; {&lt;span&gt;&quot;name&quot;&lt;/span&gt;:&lt;span&gt;&quot;tom&quot;&lt;/span&gt;, &lt;span&gt;&quot;age&quot;&lt;/span&gt;: 18}&lt;br/&gt;&amp;gt; {&lt;span&gt;&quot;name&quot;&lt;/span&gt;:&lt;span&gt;&quot;mike&quot;&lt;/span&gt;, &lt;span&gt;&quot;age&quot;&lt;/span&gt;: 19}&lt;br/&gt;&amp;gt; {&lt;span&gt;&quot;name&quot;&lt;/span&gt;:&lt;span&gt;&quot;lisa&quot;&lt;/span&gt;, &lt;span&gt;&quot;age&quot;&lt;/span&gt;: 20}&lt;br/&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;通过 Kibana 分别在 cluster01 和 cluster02 集群上查看索引 &lt;/span&gt;&lt;code&gt;&lt;span&gt;index-1&lt;/span&gt;&lt;/code&gt;&lt;span&gt; 的数据，可以看到 Logstash 成功从 Kafka 消费消息并写入 Elasticsearch。&lt;/span&gt;&lt;/p&gt;&lt;pre data-tool=&quot;mdnice编辑器&quot;&gt;&lt;code&gt;&lt;span&gt;&lt;span&gt;GET&lt;/span&gt; &lt;span&gt;index-1/_search&lt;/span&gt;&lt;br/&gt;&lt;br/&gt;&lt;span&gt;# 返回结果&lt;/span&gt;&lt;br/&gt;&lt;span&gt;{&lt;/span&gt;&lt;br/&gt;  &lt;span&gt;&quot;took&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;3&lt;/span&gt;&lt;span&gt;,&lt;/span&gt;&lt;br/&gt;  &lt;span&gt;&quot;timed_out&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;false&lt;/span&gt;&lt;span&gt;,&lt;/span&gt;&lt;br/&gt;  &lt;span&gt;&quot;_shards&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;{&lt;/span&gt;&lt;br/&gt;    &lt;span&gt;&quot;total&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;1&lt;/span&gt;&lt;span&gt;,&lt;/span&gt;&lt;br/&gt;    &lt;span&gt;&quot;successful&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;1&lt;/span&gt;&lt;span&gt;,&lt;/span&gt;&lt;br/&gt;    &lt;span&gt;&quot;skipped&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;0&lt;/span&gt;&lt;span&gt;,&lt;/span&gt;&lt;br/&gt;    &lt;span&gt;&quot;failed&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;0&lt;/span&gt;&lt;br/&gt;  &lt;span&gt;},&lt;/span&gt;&lt;br/&gt;  &lt;span&gt;&quot;hits&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;{&lt;/span&gt;&lt;br/&gt;    &lt;span&gt;&quot;total&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;{&lt;/span&gt;&lt;br/&gt;      &lt;span&gt;&quot;value&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;3&lt;/span&gt;&lt;span&gt;,&lt;/span&gt;&lt;br/&gt;      &lt;span&gt;&quot;relation&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;&quot;eq&quot;&lt;/span&gt;&lt;br/&gt;    &lt;span&gt;},&lt;/span&gt;&lt;br/&gt;    &lt;span&gt;&quot;max_score&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;1.0&lt;/span&gt;&lt;span&gt;,&lt;/span&gt;&lt;br/&gt;    &lt;span&gt;&quot;hits&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;[&lt;/span&gt;&lt;br/&gt;      &lt;span&gt;{&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;&quot;_index&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;&quot;index-1&quot;,&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;&quot;_type&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;&quot;_doc&quot;,&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;&quot;_id&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;&quot;Oa09CX4BZrgW9YGKOkMg&quot;,&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;&quot;_score&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;1.0&lt;/span&gt;&lt;span&gt;,&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;&quot;_source&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;{&lt;/span&gt;&lt;br/&gt;          &lt;span&gt;&quot;@version&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;&quot;1&quot;,&lt;/span&gt;&lt;br/&gt;          &lt;span&gt;&quot;@timestamp&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;&quot;2021-12-30T02:48:34.242Z&quot;,&lt;/span&gt;&lt;br/&gt;          &lt;span&gt;&quot;name&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;&quot;tom&quot;,&lt;/span&gt;&lt;br/&gt;          &lt;span&gt;&quot;age&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;18&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;}&lt;/span&gt;&lt;br/&gt;      &lt;span&gt;},&lt;/span&gt;&lt;br/&gt;      &lt;span&gt;{&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;&quot;_index&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;&quot;index-1&quot;,&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;&quot;_type&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;&quot;_doc&quot;,&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;&quot;_id&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;&quot;Oq09CX4BZrgW9YGKRkO3&quot;,&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;&quot;_score&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;1.0&lt;/span&gt;&lt;span&gt;,&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;&quot;_source&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;{&lt;/span&gt;&lt;br/&gt;          &lt;span&gt;&quot;@version&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;&quot;1&quot;,&lt;/span&gt;&lt;br/&gt;          &lt;span&gt;&quot;@timestamp&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;&quot;2021-12-30T02:48:37.708Z&quot;,&lt;/span&gt;&lt;br/&gt;          &lt;span&gt;&quot;name&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;&quot;mike&quot;,&lt;/span&gt;&lt;br/&gt;          &lt;span&gt;&quot;age&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;19&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;}&lt;/span&gt;&lt;br/&gt;      &lt;span&gt;},&lt;/span&gt;&lt;br/&gt;      &lt;span&gt;{&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;&quot;_index&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;&quot;index-1&quot;,&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;&quot;_type&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;&quot;_doc&quot;,&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;&quot;_id&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;&quot;O609CX4BZrgW9YGKWEPF&quot;,&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;&quot;_score&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;1.0&lt;/span&gt;&lt;span&gt;,&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;&quot;_source&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;{&lt;/span&gt;&lt;br/&gt;          &lt;span&gt;&quot;@version&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;&quot;1&quot;,&lt;/span&gt;&lt;br/&gt;          &lt;span&gt;&quot;@timestamp&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;&quot;2021-12-30T02:48:42.330Z&quot;,&lt;/span&gt;&lt;br/&gt;          &lt;span&gt;&quot;name&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;&quot;lisa&quot;,&lt;/span&gt;&lt;br/&gt;          &lt;span&gt;&quot;age&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;20&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;}&lt;/span&gt;&lt;br/&gt;      &lt;span&gt;}&lt;/span&gt;&lt;br/&gt;    &lt;span&gt;]&lt;/span&gt;&lt;br/&gt;  &lt;span&gt;}&lt;/span&gt;&lt;br/&gt;&lt;span&gt;}&lt;/span&gt;&lt;br/&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;h4 data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;9.4.4 故障测试&lt;/span&gt;&lt;/h4&gt;&lt;h5 data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;9.4.4.1 模拟 Elasticsearch 集群故障&lt;/span&gt;&lt;/h5&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;接下来模拟 Elasticsearch 集群故障的场景，停止 es01 容器。&lt;/span&gt;&lt;/p&gt;&lt;pre data-tool=&quot;mdnice编辑器&quot;&gt;&lt;code&gt;&lt;span&gt;docker-compose stop es01&lt;br/&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;接着继续往 Kafka 中写入 2 条消息。&lt;/span&gt;&lt;/p&gt;&lt;pre data-tool=&quot;mdnice编辑器&quot;&gt;&lt;code&gt;&lt;span&gt;kafka-console-producer.sh --bootstrap-server 127.0.0.1:9092 \&lt;br/&gt;--topic index-1&lt;br/&gt;&lt;br/&gt;&lt;span&gt;# 输入 JSON 格式的数据&lt;/span&gt;&lt;br/&gt;&amp;gt; {&lt;span&gt;&quot;name&quot;&lt;/span&gt;:&lt;span&gt;&quot;peter&quot;&lt;/span&gt;, &lt;span&gt;&quot;age&quot;&lt;/span&gt;: 18}&lt;br/&gt;&amp;gt; {&lt;span&gt;&quot;name&quot;&lt;/span&gt;:&lt;span&gt;&quot;frank&quot;&lt;/span&gt;, &lt;span&gt;&quot;age&quot;&lt;/span&gt;: 19}&lt;br/&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;此时 es01 已经无法正常访问。&lt;/span&gt;&lt;/p&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;img class=&quot;rich_pages wxw-img&quot; data-ratio=&quot;0.4099415204678363&quot; data-src=&quot;https://mmbiz.qpic.cn/mmbiz_png/mjl8GCpsL9auhKTS8YiaHLpE37Swaxib50IuOhKQMfWPGFtibe4oRmCAiaSQOk7ltOp8nFKxBu3zI8HB5LehcTnMGw/640?wx_fmt=png&quot; data-type=&quot;png&quot; data-w=&quot;1710&quot;/&gt;&lt;span&gt;此时查看 logstash01 的日志，可以看到连接 es01 报错的信息。&lt;/span&gt;&lt;/p&gt;&lt;pre data-tool=&quot;mdnice编辑器&quot;&gt;&lt;code&gt;&lt;span&gt;$ docker-compose logs logstash01&lt;br/&gt;logstash01    | [2021-12-30T03:03:26,075][WARN ][logstash.outputs.elasticsearch][main] Attempted to resurrect connection to dead ES instance, but got an error {:url=&amp;gt;&lt;span&gt;&quot;http://elastic:xxxxxx@es01:9200/&quot;&lt;/span&gt;, :exception=&amp;gt;LogStash::Outputs::ElasticSearch::HttpClient::Pool::HostUnreachableError, :message=&amp;gt;&lt;span&gt;&quot;Elasticsearch Unreachable: [http://elastic:xxxxxx@es01:9200/][Manticore::SocketException] Connect to es01:9200 [es01/192.168.32.4] failed: Connection refused (Connection refused)&quot;&lt;/span&gt;}&lt;br/&gt;logstash01    | [2021-12-30T03:03:26,959][ERROR][logstash.outputs.elasticsearchmonitoring][.monitoring-logstash][d1482d954dd93478867963ea3f24534a09f4484fd64cc67ae3933128a42d4838] Attempted to send a bulk request but there are no living connections &lt;span&gt;in&lt;/span&gt; the pool (perhaps Elasticsearch is unreachable or down?) {:message=&amp;gt;&lt;span&gt;&quot;No Available connections&quot;&lt;/span&gt;, :exception=&amp;gt;LogStash::Outputs::ElasticSearch::HttpClient::Pool::NoConnectionAvailableError, :will_retry_in_seconds=&amp;gt;64}&lt;br/&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;查询集群 cluster02 可以看到数据可以正常写入，不受影响。&lt;/span&gt;&lt;/p&gt;&lt;pre data-tool=&quot;mdnice编辑器&quot;&gt;&lt;code&gt;&lt;span&gt;&lt;span&gt;{&lt;/span&gt;&lt;br/&gt;  &lt;span&gt;&quot;took&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;694&lt;/span&gt;&lt;span&gt;,&lt;/span&gt;&lt;br/&gt;  &lt;span&gt;&quot;timed_out&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;false&lt;/span&gt;&lt;span&gt;,&lt;/span&gt;&lt;br/&gt;  &lt;span&gt;&quot;_shards&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;{&lt;/span&gt;&lt;br/&gt;    &lt;span&gt;&quot;total&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;1&lt;/span&gt;&lt;span&gt;,&lt;/span&gt;&lt;br/&gt;    &lt;span&gt;&quot;successful&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;1&lt;/span&gt;&lt;span&gt;,&lt;/span&gt;&lt;br/&gt;    &lt;span&gt;&quot;skipped&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;0&lt;/span&gt;&lt;span&gt;,&lt;/span&gt;&lt;br/&gt;    &lt;span&gt;&quot;failed&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;0&lt;/span&gt;&lt;br/&gt;  &lt;span&gt;},&lt;/span&gt;&lt;br/&gt;  &lt;span&gt;&quot;hits&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;{&lt;/span&gt;&lt;br/&gt;    &lt;span&gt;&quot;total&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;{&lt;/span&gt;&lt;br/&gt;      &lt;span&gt;&quot;value&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;5&lt;/span&gt;&lt;span&gt;,&lt;/span&gt;&lt;br/&gt;      &lt;span&gt;&quot;relation&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;&quot;eq&quot;&lt;/span&gt;&lt;br/&gt;    &lt;span&gt;},&lt;/span&gt;&lt;br/&gt;    &lt;span&gt;&quot;max_score&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;1.0&lt;/span&gt;&lt;span&gt;,&lt;/span&gt;&lt;br/&gt;    &lt;span&gt;&quot;hits&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;[&lt;/span&gt;&lt;br/&gt;      &lt;span&gt;{&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;&quot;_index&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;&quot;index-1&quot;,&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;&quot;_type&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;&quot;_doc&quot;,&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;&quot;_id&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;&quot;Oa09CX4BZrgW9YGKOkMg&quot;,&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;&quot;_score&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;1.0&lt;/span&gt;&lt;span&gt;,&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;&quot;_source&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;{&lt;/span&gt;&lt;br/&gt;          &lt;span&gt;&quot;@version&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;&quot;1&quot;,&lt;/span&gt;&lt;br/&gt;          &lt;span&gt;&quot;@timestamp&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;&quot;2021-12-30T02:48:34.242Z&quot;,&lt;/span&gt;&lt;br/&gt;          &lt;span&gt;&quot;name&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;&quot;tom&quot;,&lt;/span&gt;&lt;br/&gt;          &lt;span&gt;&quot;age&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;18&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;}&lt;/span&gt;&lt;br/&gt;      &lt;span&gt;},&lt;/span&gt;&lt;br/&gt;      &lt;span&gt;{&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;&quot;_index&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;&quot;index-1&quot;,&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;&quot;_type&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;&quot;_doc&quot;,&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;&quot;_id&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;&quot;Oq09CX4BZrgW9YGKRkO3&quot;,&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;&quot;_score&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;1.0&lt;/span&gt;&lt;span&gt;,&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;&quot;_source&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;{&lt;/span&gt;&lt;br/&gt;          &lt;span&gt;&quot;@version&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;&quot;1&quot;,&lt;/span&gt;&lt;br/&gt;          &lt;span&gt;&quot;@timestamp&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;&quot;2021-12-30T02:48:37.708Z&quot;,&lt;/span&gt;&lt;br/&gt;          &lt;span&gt;&quot;name&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;&quot;mike&quot;,&lt;/span&gt;&lt;br/&gt;          &lt;span&gt;&quot;age&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;19&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;}&lt;/span&gt;&lt;br/&gt;      &lt;span&gt;},&lt;/span&gt;&lt;br/&gt;      &lt;span&gt;{&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;&quot;_index&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;&quot;index-1&quot;,&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;&quot;_type&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;&quot;_doc&quot;,&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;&quot;_id&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;&quot;O609CX4BZrgW9YGKWEPF&quot;,&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;&quot;_score&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;1.0&lt;/span&gt;&lt;span&gt;,&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;&quot;_source&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;{&lt;/span&gt;&lt;br/&gt;          &lt;span&gt;&quot;@version&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;&quot;1&quot;,&lt;/span&gt;&lt;br/&gt;          &lt;span&gt;&quot;@timestamp&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;&quot;2021-12-30T02:48:42.330Z&quot;,&lt;/span&gt;&lt;br/&gt;          &lt;span&gt;&quot;name&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;&quot;lisa&quot;,&lt;/span&gt;&lt;br/&gt;          &lt;span&gt;&quot;age&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;20&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;}&lt;/span&gt;&lt;br/&gt;      &lt;span&gt;},&lt;/span&gt;&lt;br/&gt;      &lt;span&gt;{&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;&quot;_index&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;&quot;index-1&quot;,&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;&quot;_type&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;&quot;_doc&quot;,&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;&quot;_id&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;&quot;Pa1GCX4BZrgW9YGK2UOd&quot;,&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;&quot;_score&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;1.0&lt;/span&gt;&lt;span&gt;,&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;&quot;_source&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;{&lt;/span&gt;&lt;br/&gt;          &lt;span&gt;&quot;@version&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;&quot;1&quot;,&lt;/span&gt;&lt;br/&gt;          &lt;span&gt;&quot;@timestamp&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;&quot;2021-12-30T02:59:05.139Z&quot;,&lt;/span&gt;&lt;br/&gt;          &lt;span&gt;&quot;name&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;&quot;peter&quot;,&lt;/span&gt;&lt;br/&gt;          &lt;span&gt;&quot;age&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;18&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;}&lt;/span&gt;&lt;br/&gt;      &lt;span&gt;},&lt;/span&gt;&lt;br/&gt;      &lt;span&gt;{&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;&quot;_index&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;&quot;index-1&quot;,&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;&quot;_type&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;&quot;_doc&quot;,&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;&quot;_id&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;&quot;Pq1GCX4BZrgW9YGK7EMI&quot;,&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;&quot;_score&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;1.0&lt;/span&gt;&lt;span&gt;,&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;&quot;_source&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;{&lt;/span&gt;&lt;br/&gt;          &lt;span&gt;&quot;@version&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;&quot;1&quot;,&lt;/span&gt;&lt;br/&gt;          &lt;span&gt;&quot;@timestamp&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;&quot;2021-12-30T02:59:09.854Z&quot;,&lt;/span&gt;&lt;br/&gt;          &lt;span&gt;&quot;name&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;&quot;frank&quot;,&lt;/span&gt;&lt;br/&gt;          &lt;span&gt;&quot;age&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;19&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;}&lt;/span&gt;&lt;br/&gt;      &lt;span&gt;}&lt;/span&gt;&lt;br/&gt;    &lt;span&gt;]&lt;/span&gt;&lt;br/&gt;  &lt;span&gt;}&lt;/span&gt;&lt;br/&gt;&lt;span&gt;}&lt;/span&gt;&lt;br/&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;现在我们重新启动 es01，logstash01 将会重试之前写入 es01 失败的数据。&lt;/span&gt;&lt;/p&gt;&lt;pre data-tool=&quot;mdnice编辑器&quot;&gt;&lt;code&gt;&lt;span&gt;docker-compose start es01&lt;br/&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;在集群 cluster01 上查询数据，可以看到在集群宕机期间产生的 2 条数据也成功追加进来了。&lt;/span&gt;&lt;/p&gt;&lt;pre data-tool=&quot;mdnice编辑器&quot;&gt;&lt;code&gt;&lt;span&gt;{&lt;br/&gt;  &lt;span&gt;&quot;took&quot;&lt;/span&gt; : 1,&lt;br/&gt;  &lt;span&gt;&quot;timed_out&quot;&lt;/span&gt; : &lt;span&gt;false&lt;/span&gt;,&lt;br/&gt;  &lt;span&gt;&quot;_shards&quot;&lt;/span&gt; : {&lt;br/&gt;    &lt;span&gt;&quot;total&quot;&lt;/span&gt; : 1,&lt;br/&gt;    &lt;span&gt;&quot;successful&quot;&lt;/span&gt; : 1,&lt;br/&gt;    &lt;span&gt;&quot;skipped&quot;&lt;/span&gt; : 0,&lt;br/&gt;    &lt;span&gt;&quot;failed&quot;&lt;/span&gt; : 0&lt;br/&gt;  },&lt;br/&gt;  &lt;span&gt;&quot;hits&quot;&lt;/span&gt; : {&lt;br/&gt;    &lt;span&gt;&quot;total&quot;&lt;/span&gt; : {&lt;br/&gt;      &lt;span&gt;&quot;value&quot;&lt;/span&gt; : 6,&lt;br/&gt;      &lt;span&gt;&quot;relation&quot;&lt;/span&gt; : &lt;span&gt;&quot;eq&quot;&lt;/span&gt;&lt;br/&gt;    },&lt;br/&gt;    &lt;span&gt;&quot;max_score&quot;&lt;/span&gt; : 1.0,&lt;br/&gt;    &lt;span&gt;&quot;hits&quot;&lt;/span&gt; : [&lt;br/&gt;      {&lt;br/&gt;        &lt;span&gt;&quot;_index&quot;&lt;/span&gt; : &lt;span&gt;&quot;index-1&quot;&lt;/span&gt;,&lt;br/&gt;        &lt;span&gt;&quot;_type&quot;&lt;/span&gt; : &lt;span&gt;&quot;_doc&quot;&lt;/span&gt;,&lt;br/&gt;        &lt;span&gt;&quot;_id&quot;&lt;/span&gt; : &lt;span&gt;&quot;lrROCX4BVL35GcLwNcG1&quot;&lt;/span&gt;,&lt;br/&gt;        &lt;span&gt;&quot;_score&quot;&lt;/span&gt; : 1.0,&lt;br/&gt;        &lt;span&gt;&quot;_source&quot;&lt;/span&gt; : {&lt;br/&gt;          &lt;span&gt;&quot;age&quot;&lt;/span&gt; : 19,&lt;br/&gt;          &lt;span&gt;&quot;@version&quot;&lt;/span&gt; : &lt;span&gt;&quot;1&quot;&lt;/span&gt;,&lt;br/&gt;          &lt;span&gt;&quot;name&quot;&lt;/span&gt; : &lt;span&gt;&quot;frank&quot;&lt;/span&gt;,&lt;br/&gt;          &lt;span&gt;&quot;@timestamp&quot;&lt;/span&gt; : &lt;span&gt;&quot;2021-12-30T03:07:07.466Z&quot;&lt;/span&gt;&lt;br/&gt;        }&lt;br/&gt;      },&lt;br/&gt;      {&lt;br/&gt;        &lt;span&gt;&quot;_index&quot;&lt;/span&gt; : &lt;span&gt;&quot;index-1&quot;&lt;/span&gt;,&lt;br/&gt;        &lt;span&gt;&quot;_type&quot;&lt;/span&gt; : &lt;span&gt;&quot;_doc&quot;&lt;/span&gt;,&lt;br/&gt;        &lt;span&gt;&quot;_id&quot;&lt;/span&gt; : &lt;span&gt;&quot;lLRLCX4BVL35GcLws8Hi&quot;&lt;/span&gt;,&lt;br/&gt;        &lt;span&gt;&quot;_score&quot;&lt;/span&gt; : 1.0,&lt;br/&gt;        &lt;span&gt;&quot;_source&quot;&lt;/span&gt; : {&lt;br/&gt;          &lt;span&gt;&quot;age&quot;&lt;/span&gt; : 18,&lt;br/&gt;          &lt;span&gt;&quot;@version&quot;&lt;/span&gt; : &lt;span&gt;&quot;1&quot;&lt;/span&gt;,&lt;br/&gt;          &lt;span&gt;&quot;name&quot;&lt;/span&gt; : &lt;span&gt;&quot;peter&quot;&lt;/span&gt;,&lt;br/&gt;          &lt;span&gt;&quot;@timestamp&quot;&lt;/span&gt; : &lt;span&gt;&quot;2021-12-30T02:59:05.139Z&quot;&lt;/span&gt;&lt;br/&gt;        }&lt;br/&gt;      },&lt;br/&gt;      {&lt;br/&gt;        &lt;span&gt;&quot;_index&quot;&lt;/span&gt; : &lt;span&gt;&quot;index-1&quot;&lt;/span&gt;,&lt;br/&gt;        &lt;span&gt;&quot;_type&quot;&lt;/span&gt; : &lt;span&gt;&quot;_doc&quot;&lt;/span&gt;,&lt;br/&gt;        &lt;span&gt;&quot;_id&quot;&lt;/span&gt; : &lt;span&gt;&quot;tv49CX4BAcbk4YbwWMvF&quot;&lt;/span&gt;,&lt;br/&gt;        &lt;span&gt;&quot;_score&quot;&lt;/span&gt; : 1.0,&lt;br/&gt;        &lt;span&gt;&quot;_source&quot;&lt;/span&gt; : {&lt;br/&gt;          &lt;span&gt;&quot;age&quot;&lt;/span&gt; : 20,&lt;br/&gt;          &lt;span&gt;&quot;@version&quot;&lt;/span&gt; : &lt;span&gt;&quot;1&quot;&lt;/span&gt;,&lt;br/&gt;          &lt;span&gt;&quot;name&quot;&lt;/span&gt; : &lt;span&gt;&quot;lisa&quot;&lt;/span&gt;,&lt;br/&gt;          &lt;span&gt;&quot;@timestamp&quot;&lt;/span&gt; : &lt;span&gt;&quot;2021-12-30T02:48:42.330Z&quot;&lt;/span&gt;&lt;br/&gt;        }&lt;br/&gt;      },&lt;br/&gt;      {&lt;br/&gt;        &lt;span&gt;&quot;_index&quot;&lt;/span&gt; : &lt;span&gt;&quot;index-1&quot;&lt;/span&gt;,&lt;br/&gt;        &lt;span&gt;&quot;_type&quot;&lt;/span&gt; : &lt;span&gt;&quot;_doc&quot;&lt;/span&gt;,&lt;br/&gt;        &lt;span&gt;&quot;_id&quot;&lt;/span&gt; : &lt;span&gt;&quot;tf49CX4BAcbk4YbwRsu4&quot;&lt;/span&gt;,&lt;br/&gt;        &lt;span&gt;&quot;_score&quot;&lt;/span&gt; : 1.0,&lt;br/&gt;        &lt;span&gt;&quot;_source&quot;&lt;/span&gt; : {&lt;br/&gt;          &lt;span&gt;&quot;age&quot;&lt;/span&gt; : 19,&lt;br/&gt;          &lt;span&gt;&quot;@version&quot;&lt;/span&gt; : &lt;span&gt;&quot;1&quot;&lt;/span&gt;,&lt;br/&gt;          &lt;span&gt;&quot;name&quot;&lt;/span&gt; : &lt;span&gt;&quot;mike&quot;&lt;/span&gt;,&lt;br/&gt;          &lt;span&gt;&quot;@timestamp&quot;&lt;/span&gt; : &lt;span&gt;&quot;2021-12-30T02:48:37.708Z&quot;&lt;/span&gt;&lt;br/&gt;        }&lt;br/&gt;      },&lt;br/&gt;      {&lt;br/&gt;        &lt;span&gt;&quot;_index&quot;&lt;/span&gt; : &lt;span&gt;&quot;index-1&quot;&lt;/span&gt;,&lt;br/&gt;        &lt;span&gt;&quot;_type&quot;&lt;/span&gt; : &lt;span&gt;&quot;_doc&quot;&lt;/span&gt;,&lt;br/&gt;        &lt;span&gt;&quot;_id&quot;&lt;/span&gt; : &lt;span&gt;&quot;tP49CX4BAcbk4YbwOsse&quot;&lt;/span&gt;,&lt;br/&gt;        &lt;span&gt;&quot;_score&quot;&lt;/span&gt; : 1.0,&lt;br/&gt;        &lt;span&gt;&quot;_source&quot;&lt;/span&gt; : {&lt;br/&gt;          &lt;span&gt;&quot;age&quot;&lt;/span&gt; : 18,&lt;br/&gt;          &lt;span&gt;&quot;@version&quot;&lt;/span&gt; : &lt;span&gt;&quot;1&quot;&lt;/span&gt;,&lt;br/&gt;          &lt;span&gt;&quot;name&quot;&lt;/span&gt; : &lt;span&gt;&quot;tom&quot;&lt;/span&gt;,&lt;br/&gt;          &lt;span&gt;&quot;@timestamp&quot;&lt;/span&gt; : &lt;span&gt;&quot;2021-12-30T02:48:34.243Z&quot;&lt;/span&gt;&lt;br/&gt;        }&lt;br/&gt;      }&lt;br/&gt;    ]&lt;br/&gt;  }&lt;br/&gt;}&lt;br/&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;h5 data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;9.4.4.2 模拟消费者故障&lt;/span&gt;&lt;/h5&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;为了方便我们观察，先清空 cluster01 和 cluster02 集群上 &lt;/span&gt;&lt;code&gt;&lt;span&gt;index-1&lt;/span&gt;&lt;/code&gt;&lt;span&gt;  索引中的数据。&lt;/span&gt;&lt;/p&gt;&lt;pre data-tool=&quot;mdnice编辑器&quot;&gt;&lt;code&gt;&lt;span&gt;POST index-1/_delete_by_query&lt;br/&gt;{&lt;br/&gt;  &lt;span&gt;&quot;query&quot;&lt;/span&gt;: {&lt;br/&gt;     &lt;span&gt;&quot;match_all&quot;&lt;/span&gt;: {}&lt;br/&gt;  }&lt;br/&gt;}&lt;br/&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;接下来模拟消费者故障的场景，停止 logstash01。&lt;/span&gt;&lt;/p&gt;&lt;pre data-tool=&quot;mdnice编辑器&quot;&gt;&lt;code&gt;&lt;span&gt;docker-compose stop logstash01&lt;br/&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;往 Kafka 中写入 3 条消息。&lt;/span&gt;&lt;/p&gt;&lt;pre data-tool=&quot;mdnice编辑器&quot;&gt;&lt;code&gt;&lt;span&gt;kafka-console-producer.sh --bootstrap-server 127.0.0.1:9092 \&lt;br/&gt;--topic index-1&lt;br/&gt;&lt;br/&gt;&lt;span&gt;# 输入 JSON 格式的数据&lt;/span&gt;&lt;br/&gt;&amp;gt; {&lt;span&gt;&quot;name&quot;&lt;/span&gt;:&lt;span&gt;&quot;cris&quot;&lt;/span&gt;, &lt;span&gt;&quot;age&quot;&lt;/span&gt;: 16}&lt;br/&gt;&amp;gt; {&lt;span&gt;&quot;name&quot;&lt;/span&gt;:&lt;span&gt;&quot;james&quot;&lt;/span&gt;, &lt;span&gt;&quot;age&quot;&lt;/span&gt;: 17}&lt;br/&gt;&amp;gt; {&lt;span&gt;&quot;name&quot;&lt;/span&gt;:&lt;span&gt;&quot;kavin&quot;&lt;/span&gt;, &lt;span&gt;&quot;age&quot;&lt;/span&gt;: 18}&lt;br/&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;此时查询 cluster01 集群的索引 &lt;/span&gt;&lt;code&gt;&lt;span&gt;index-1&lt;/span&gt;&lt;/code&gt;&lt;span&gt; 是没有数据的，因为 logstash01 已经停止工作。&lt;/span&gt;&lt;/p&gt;&lt;pre data-tool=&quot;mdnice编辑器&quot;&gt;&lt;code&gt;&lt;span&gt;GET index-1/_search&lt;br/&gt;&lt;br/&gt;&lt;span&gt;# 返回结果&lt;/span&gt;&lt;br/&gt;{&lt;br/&gt;  &lt;span&gt;&quot;took&quot;&lt;/span&gt; : 1,&lt;br/&gt;  &lt;span&gt;&quot;timed_out&quot;&lt;/span&gt; : &lt;span&gt;false&lt;/span&gt;,&lt;br/&gt;  &lt;span&gt;&quot;_shards&quot;&lt;/span&gt; : {&lt;br/&gt;    &lt;span&gt;&quot;total&quot;&lt;/span&gt; : 1,&lt;br/&gt;    &lt;span&gt;&quot;successful&quot;&lt;/span&gt; : 1,&lt;br/&gt;    &lt;span&gt;&quot;skipped&quot;&lt;/span&gt; : 0,&lt;br/&gt;    &lt;span&gt;&quot;failed&quot;&lt;/span&gt; : 0&lt;br/&gt;  },&lt;br/&gt;  &lt;span&gt;&quot;hits&quot;&lt;/span&gt; : {&lt;br/&gt;    &lt;span&gt;&quot;total&quot;&lt;/span&gt; : {&lt;br/&gt;      &lt;span&gt;&quot;value&quot;&lt;/span&gt; : 0,&lt;br/&gt;      &lt;span&gt;&quot;relation&quot;&lt;/span&gt; : &lt;span&gt;&quot;eq&quot;&lt;/span&gt;&lt;br/&gt;    },&lt;br/&gt;    &lt;span&gt;&quot;max_score&quot;&lt;/span&gt; : null,&lt;br/&gt;    &lt;span&gt;&quot;hits&quot;&lt;/span&gt; : [ ]&lt;br/&gt;  }&lt;br/&gt;}&lt;br/&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;cluster02 集群上的索引 &lt;/span&gt;&lt;code&gt;&lt;span&gt;index-1&lt;/span&gt;&lt;/code&gt;&lt;span&gt;  数据正常写入。&lt;/span&gt;&lt;/p&gt;&lt;pre data-tool=&quot;mdnice编辑器&quot;&gt;&lt;code&gt;&lt;span&gt;&lt;span&gt;GET&lt;/span&gt; &lt;span&gt;index-1/_search&lt;/span&gt;&lt;br/&gt;&lt;br/&gt;&lt;span&gt;# 返回结果&lt;/span&gt;&lt;br/&gt;&lt;span&gt;{&lt;/span&gt;&lt;br/&gt;  &lt;span&gt;&quot;took&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;2&lt;/span&gt;&lt;span&gt;,&lt;/span&gt;&lt;br/&gt;  &lt;span&gt;&quot;timed_out&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;false&lt;/span&gt;&lt;span&gt;,&lt;/span&gt;&lt;br/&gt;  &lt;span&gt;&quot;_shards&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;{&lt;/span&gt;&lt;br/&gt;    &lt;span&gt;&quot;total&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;1&lt;/span&gt;&lt;span&gt;,&lt;/span&gt;&lt;br/&gt;    &lt;span&gt;&quot;successful&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;1&lt;/span&gt;&lt;span&gt;,&lt;/span&gt;&lt;br/&gt;    &lt;span&gt;&quot;skipped&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;0&lt;/span&gt;&lt;span&gt;,&lt;/span&gt;&lt;br/&gt;    &lt;span&gt;&quot;failed&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;0&lt;/span&gt;&lt;br/&gt;  &lt;span&gt;},&lt;/span&gt;&lt;br/&gt;  &lt;span&gt;&quot;hits&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;{&lt;/span&gt;&lt;br/&gt;    &lt;span&gt;&quot;total&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;{&lt;/span&gt;&lt;br/&gt;      &lt;span&gt;&quot;value&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;3&lt;/span&gt;&lt;span&gt;,&lt;/span&gt;&lt;br/&gt;      &lt;span&gt;&quot;relation&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;&quot;eq&quot;&lt;/span&gt;&lt;br/&gt;    &lt;span&gt;},&lt;/span&gt;&lt;br/&gt;    &lt;span&gt;&quot;max_score&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;1.0&lt;/span&gt;&lt;span&gt;,&lt;/span&gt;&lt;br/&gt;    &lt;span&gt;&quot;hits&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;[&lt;/span&gt;&lt;br/&gt;      &lt;span&gt;{&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;&quot;_index&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;&quot;index-1&quot;,&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;&quot;_type&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;&quot;_doc&quot;,&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;&quot;_id&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;&quot;Qq11CX4BZrgW9YGKTUNS&quot;,&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;&quot;_score&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;1.0&lt;/span&gt;&lt;span&gt;,&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;&quot;_source&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;{&lt;/span&gt;&lt;br/&gt;          &lt;span&gt;&quot;@version&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;&quot;1&quot;,&lt;/span&gt;&lt;br/&gt;          &lt;span&gt;&quot;@timestamp&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;&quot;2021-12-30T03:49:49.228Z&quot;,&lt;/span&gt;&lt;br/&gt;          &lt;span&gt;&quot;name&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;&quot;cris&quot;,&lt;/span&gt;&lt;br/&gt;          &lt;span&gt;&quot;age&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;16&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;}&lt;/span&gt;&lt;br/&gt;      &lt;span&gt;},&lt;/span&gt;&lt;br/&gt;      &lt;span&gt;{&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;&quot;_index&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;&quot;index-1&quot;,&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;&quot;_type&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;&quot;_doc&quot;,&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;&quot;_id&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;&quot;Q611CX4BZrgW9YGKX0O_&quot;,&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;&quot;_score&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;1.0&lt;/span&gt;&lt;span&gt;,&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;&quot;_source&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;{&lt;/span&gt;&lt;br/&gt;          &lt;span&gt;&quot;@version&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;&quot;1&quot;,&lt;/span&gt;&lt;br/&gt;          &lt;span&gt;&quot;@timestamp&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;&quot;2021-12-30T03:49:54.135Z&quot;,&lt;/span&gt;&lt;br/&gt;          &lt;span&gt;&quot;name&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;&quot;james&quot;,&lt;/span&gt;&lt;br/&gt;          &lt;span&gt;&quot;age&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;17&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;}&lt;/span&gt;&lt;br/&gt;      &lt;span&gt;},&lt;/span&gt;&lt;br/&gt;      &lt;span&gt;{&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;&quot;_index&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;&quot;index-1&quot;,&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;&quot;_type&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;&quot;_doc&quot;,&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;&quot;_id&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;&quot;RK11CX4BZrgW9YGKb0N_&quot;,&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;&quot;_score&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;1.0&lt;/span&gt;&lt;span&gt;,&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;&quot;_source&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;{&lt;/span&gt;&lt;br/&gt;          &lt;span&gt;&quot;@version&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;&quot;1&quot;,&lt;/span&gt;&lt;br/&gt;          &lt;span&gt;&quot;@timestamp&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;&quot;2021-12-30T03:49:58.166Z&quot;,&lt;/span&gt;&lt;br/&gt;          &lt;span&gt;&quot;name&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;&quot;kavin&quot;,&lt;/span&gt;&lt;br/&gt;          &lt;span&gt;&quot;age&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;18&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;}&lt;/span&gt;&lt;br/&gt;      &lt;span&gt;}&lt;/span&gt;&lt;br/&gt;    &lt;span&gt;]&lt;/span&gt;&lt;br/&gt;  &lt;span&gt;}&lt;/span&gt;&lt;br/&gt;&lt;span&gt;}&lt;/span&gt;&lt;br/&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;此时分别查看 logstash01 和 logstash02 在 Kafka 上的消费情况。logstash01 所属的消费者组 logstash_cluster01 中已经没有活跃的成员了，并且剩余未消费的消息数（LAG）为 3，这 3 条就是我们在停止 logstash01 后写入的 3 条消息；logstash_cluster02 消费者组已经成功消费了所有的消息。&lt;/span&gt;&lt;/p&gt;&lt;pre data-tool=&quot;mdnice编辑器&quot;&gt;&lt;code&gt;&lt;span&gt;&lt;span&gt;# 进入 Kafka 容器&lt;/span&gt;&lt;br/&gt;$ docker-compose &lt;span&gt;exec&lt;/span&gt; kafka bash&lt;br/&gt;&lt;br/&gt;&lt;span&gt;# 查看消费者组&lt;/span&gt;&lt;br/&gt;root@e23acd56e9e2:/&lt;span&gt;#  kafka-consumer-groups.sh --bootstrap-server 127.0.0.1:9092 --list&lt;/span&gt;&lt;br/&gt;&lt;span&gt;# 两个 logstash 分别属于不同的消费者组&lt;/span&gt;&lt;br/&gt;logstash_cluster01&lt;br/&gt;logstash_cluster02&lt;br/&gt;&lt;br/&gt;&lt;span&gt;# 查看 logstash01 的消费情况&lt;/span&gt;&lt;br/&gt;root@e23acd56e9e2:/&lt;span&gt;# kafka-consumer-groups.sh --bootstrap-server 127.0.0.1:9092 --describe --group logstash_cluster01&lt;/span&gt;&lt;br/&gt;&lt;br/&gt;Consumer group &lt;span&gt;&#x27;logstash_cluster01&#x27;&lt;/span&gt; has no active members.&lt;br/&gt;&lt;br/&gt;GROUP              TOPIC           PARTITION  CURRENT-OFFSET  LOG-END-OFFSET  LAG             CONSUMER-ID     HOST            CLIENT-ID&lt;br/&gt;logstash_cluster01 index-1         0          5               8              3               -               -               -&lt;br/&gt;&lt;br/&gt;&lt;span&gt;# 查看 logstash02 的消费情况&lt;/span&gt;&lt;br/&gt;root@e23acd56e9e2:/&lt;span&gt;# kafka-consumer-groups.sh --bootstrap-server 127.0.0.1:9092 --describe --group logstash_cluster02&lt;/span&gt;&lt;br/&gt;&lt;br/&gt;GROUP              TOPIC           PARTITION  CURRENT-OFFSET  LOG-END-OFFSET  LAG             CONSUMER-ID                                     HOST            CLIENT-ID&lt;br/&gt;logstash_cluster02 index-1         0          8              8              0               logstash-0-0925ce14-66c9-42a8-ae19-5d8186afada3 /192.168.32.5   logstash-0&lt;br/&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;现在我们重新启动 logstash01，logstash01 会根据在 Kafka 中消费的 offset 继续消费消息 。&lt;/span&gt;&lt;/p&gt;&lt;pre data-tool=&quot;mdnice编辑器&quot;&gt;&lt;code&gt;&lt;span&gt;docker-compose start logstash01&lt;br/&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;查看 cluster01 上的数据，可以看到 logstash01 已经将这剩余的 3 条数据写入 Elasticsearch 中了。&lt;/span&gt;&lt;/p&gt;&lt;pre data-tool=&quot;mdnice编辑器&quot;&gt;&lt;code&gt;&lt;span&gt;&lt;span&gt;{&lt;/span&gt;&lt;br/&gt;  &lt;span&gt;&quot;took&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;1&lt;/span&gt;&lt;span&gt;,&lt;/span&gt;&lt;br/&gt;  &lt;span&gt;&quot;timed_out&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;false&lt;/span&gt;&lt;span&gt;,&lt;/span&gt;&lt;br/&gt;  &lt;span&gt;&quot;_shards&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;{&lt;/span&gt;&lt;br/&gt;    &lt;span&gt;&quot;total&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;1&lt;/span&gt;&lt;span&gt;,&lt;/span&gt;&lt;br/&gt;    &lt;span&gt;&quot;successful&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;1&lt;/span&gt;&lt;span&gt;,&lt;/span&gt;&lt;br/&gt;    &lt;span&gt;&quot;skipped&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;0&lt;/span&gt;&lt;span&gt;,&lt;/span&gt;&lt;br/&gt;    &lt;span&gt;&quot;failed&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;0&lt;/span&gt;&lt;br/&gt;  &lt;span&gt;},&lt;/span&gt;&lt;br/&gt;  &lt;span&gt;&quot;hits&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;{&lt;/span&gt;&lt;br/&gt;    &lt;span&gt;&quot;total&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;{&lt;/span&gt;&lt;br/&gt;      &lt;span&gt;&quot;value&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;3&lt;/span&gt;&lt;span&gt;,&lt;/span&gt;&lt;br/&gt;      &lt;span&gt;&quot;relation&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;&quot;eq&quot;&lt;/span&gt;&lt;br/&gt;    &lt;span&gt;},&lt;/span&gt;&lt;br/&gt;    &lt;span&gt;&quot;max_score&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;1.0&lt;/span&gt;&lt;span&gt;,&lt;/span&gt;&lt;br/&gt;    &lt;span&gt;&quot;hits&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;[&lt;/span&gt;&lt;br/&gt;      &lt;span&gt;{&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;&quot;_index&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;&quot;index-1&quot;,&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;&quot;_type&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;&quot;_doc&quot;,&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;&quot;_id&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;&quot;N6WCCX4BEydPylz69S3g&quot;,&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;&quot;_score&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;1.0&lt;/span&gt;&lt;span&gt;,&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;&quot;_source&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;{&lt;/span&gt;&lt;br/&gt;          &lt;span&gt;&quot;age&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;16&lt;/span&gt;&lt;span&gt;,&lt;/span&gt;&lt;br/&gt;          &lt;span&gt;&quot;name&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;&quot;cris&quot;,&lt;/span&gt;&lt;br/&gt;          &lt;span&gt;&quot;@version&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;&quot;1&quot;,&lt;/span&gt;&lt;br/&gt;          &lt;span&gt;&quot;@timestamp&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;&quot;2021-12-30T04:04:44.503Z&quot;&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;}&lt;/span&gt;&lt;br/&gt;      &lt;span&gt;},&lt;/span&gt;&lt;br/&gt;      &lt;span&gt;{&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;&quot;_index&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;&quot;index-1&quot;,&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;&quot;_type&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;&quot;_doc&quot;,&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;&quot;_id&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;&quot;NaWCCX4BEydPylz69S3f&quot;,&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;&quot;_score&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;1.0&lt;/span&gt;&lt;span&gt;,&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;&quot;_source&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;{&lt;/span&gt;&lt;br/&gt;          &lt;span&gt;&quot;age&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;18&lt;/span&gt;&lt;span&gt;,&lt;/span&gt;&lt;br/&gt;          &lt;span&gt;&quot;name&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;&quot;kavin&quot;,&lt;/span&gt;&lt;br/&gt;          &lt;span&gt;&quot;@version&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;&quot;1&quot;,&lt;/span&gt;&lt;br/&gt;          &lt;span&gt;&quot;@timestamp&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;&quot;2021-12-30T04:04:44.527Z&quot;&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;}&lt;/span&gt;&lt;br/&gt;      &lt;span&gt;},&lt;/span&gt;&lt;br/&gt;      &lt;span&gt;{&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;&quot;_index&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;&quot;index-1&quot;,&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;&quot;_type&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;&quot;_doc&quot;,&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;&quot;_id&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;&quot;NqWCCX4BEydPylz69S3g&quot;,&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;&quot;_score&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;1.0&lt;/span&gt;&lt;span&gt;,&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;&quot;_source&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;{&lt;/span&gt;&lt;br/&gt;          &lt;span&gt;&quot;age&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;17&lt;/span&gt;&lt;span&gt;,&lt;/span&gt;&lt;br/&gt;          &lt;span&gt;&quot;name&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;&quot;james&quot;,&lt;/span&gt;&lt;br/&gt;          &lt;span&gt;&quot;@version&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;&quot;1&quot;,&lt;/span&gt;&lt;br/&gt;          &lt;span&gt;&quot;@timestamp&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;&quot;2021-12-30T04:04:44.526Z&quot;&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;}&lt;/span&gt;&lt;br/&gt;      &lt;span&gt;}&lt;/span&gt;&lt;br/&gt;    &lt;span&gt;]&lt;/span&gt;&lt;br/&gt;  &lt;span&gt;}&lt;/span&gt;&lt;br/&gt;&lt;span&gt;}&lt;/span&gt;&lt;br/&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;h4 data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;9.4.5 清理现场&lt;/span&gt;&lt;/h4&gt;&lt;pre data-tool=&quot;mdnice编辑器&quot;&gt;&lt;code&gt;&lt;span&gt;&lt;span&gt;cd&lt;/span&gt; mq&lt;br/&gt;&lt;span&gt;# -v 参数表示删除 volume&lt;/span&gt;&lt;br/&gt;docker-compose down -v &lt;br/&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;h3 data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;&lt;span&gt;9.5 极限网关&lt;/span&gt;&lt;/span&gt;&lt;/h3&gt;&lt;h4 data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;9.5.1 环境准备&lt;/span&gt;&lt;/h4&gt;&lt;h5 data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;9.5.1.1 配置文件&lt;/span&gt;&lt;/h5&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;docker-compose.yml 文件如下所示。&lt;/span&gt;&lt;/p&gt;&lt;pre data-tool=&quot;mdnice编辑器&quot;&gt;&lt;code&gt;&lt;span&gt;&lt;span&gt;version:&lt;/span&gt; &lt;span&gt;&#x27;3.8&#x27;&lt;/span&gt;&lt;br/&gt;&lt;span&gt;services:&lt;/span&gt;&lt;br/&gt;  &lt;span&gt;# 集群 cluster01&lt;/span&gt;&lt;br/&gt;  &lt;span&gt;# Elasticsearch&lt;/span&gt;&lt;br/&gt;  &lt;span&gt;es01:&lt;/span&gt;&lt;br/&gt;    &lt;span&gt;image:&lt;/span&gt; &lt;span&gt;docker.elastic.co/elasticsearch/elasticsearch:7.16.2&lt;/span&gt;&lt;br/&gt;    &lt;span&gt;container_name:&lt;/span&gt; &lt;span&gt;es01&lt;/span&gt;&lt;br/&gt;    &lt;span&gt;environment:&lt;/span&gt;&lt;br/&gt;      &lt;span&gt;# 节点名&lt;/span&gt;&lt;br/&gt;      &lt;span&gt;-&lt;/span&gt; &lt;span&gt;node.name=es01&lt;/span&gt;&lt;br/&gt;      &lt;span&gt;# 集群名&lt;/span&gt;&lt;br/&gt;      &lt;span&gt;-&lt;/span&gt; &lt;span&gt;cluster.name=cluster01&lt;/span&gt;&lt;br/&gt;      &lt;span&gt;# 指定单节点启动&lt;/span&gt;&lt;br/&gt;      &lt;span&gt;-&lt;/span&gt; &lt;span&gt;discovery.type=single-node&lt;/span&gt;&lt;br/&gt;      &lt;span&gt;# 开启内存锁定&lt;/span&gt;&lt;br/&gt;      &lt;span&gt;-&lt;/span&gt; &lt;span&gt;bootstrap.memory_lock=true&lt;/span&gt;&lt;br/&gt;      &lt;span&gt;# 设置内存大小&lt;/span&gt;&lt;br/&gt;      &lt;span&gt;-&lt;/span&gt; &lt;span&gt;&quot;ES_JAVA_OPTS=-Xms2g -Xmx2g&quot;&lt;/span&gt;&lt;br/&gt;      &lt;span&gt;# 启用安全&lt;/span&gt;&lt;br/&gt;      &lt;span&gt;-&lt;/span&gt; &lt;span&gt;xpack.security.enabled=true&lt;/span&gt;&lt;br/&gt;      &lt;span&gt;# 设置 elastic 用户密码&lt;/span&gt;&lt;br/&gt;      &lt;span&gt;-&lt;/span&gt; &lt;span&gt;ELASTIC_PASSWORD=test123&lt;/span&gt;&lt;br/&gt;    &lt;span&gt;ulimits:&lt;/span&gt;&lt;br/&gt;      &lt;span&gt;memlock:&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;soft:&lt;/span&gt; &lt;span&gt;-1&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;hard:&lt;/span&gt; &lt;span&gt;-1&lt;/span&gt;&lt;br/&gt;    &lt;span&gt;# 映射到主机名的端口 宿主机端口:容器端口&lt;/span&gt;&lt;br/&gt;    &lt;span&gt;ports:&lt;/span&gt;&lt;br/&gt;      &lt;span&gt;-&lt;/span&gt; &lt;span&gt;9200&lt;/span&gt;&lt;span&gt;:9200&lt;/span&gt;&lt;br/&gt;    &lt;span&gt;volumes:&lt;/span&gt;&lt;br/&gt;      &lt;span&gt;-&lt;/span&gt; &lt;span&gt;data01:/usr/share/elasticsearch/data&lt;/span&gt;&lt;br/&gt;    &lt;span&gt;networks:&lt;/span&gt;&lt;br/&gt;      &lt;span&gt;-&lt;/span&gt; &lt;span&gt;elastic&lt;/span&gt;&lt;br/&gt;  &lt;span&gt;# Kibana&lt;/span&gt;&lt;br/&gt;  &lt;span&gt;kib01:&lt;/span&gt;&lt;br/&gt;    &lt;span&gt;image:&lt;/span&gt; &lt;span&gt;docker.elastic.co/kibana/kibana:7.16.2&lt;/span&gt;&lt;br/&gt;    &lt;span&gt;container_name:&lt;/span&gt; &lt;span&gt;kib01&lt;/span&gt;&lt;br/&gt;    &lt;span&gt;ports:&lt;/span&gt;&lt;br/&gt;      &lt;span&gt;-&lt;/span&gt; &lt;span&gt;5601&lt;/span&gt;&lt;span&gt;:5601&lt;/span&gt;&lt;br/&gt;    &lt;span&gt;environment:&lt;/span&gt;&lt;br/&gt;      &lt;span&gt;# Elasticsearch 连接信息&lt;/span&gt;&lt;br/&gt;      &lt;span&gt;ELASTICSEARCH_URL:&lt;/span&gt; &lt;span&gt;http://es01:9200&lt;/span&gt;&lt;br/&gt;      &lt;span&gt;ELASTICSEARCH_HOSTS:&lt;/span&gt; &lt;span&gt;&#x27;[&quot;http://es01:9200&quot;]&#x27;&lt;/span&gt;&lt;br/&gt;      &lt;span&gt;ELASTICSEARCH_USERNAME:&lt;/span&gt; &lt;span&gt;elastic&lt;/span&gt;&lt;br/&gt;      &lt;span&gt;ELASTICSEARCH_PASSWORD:&lt;/span&gt; &lt;span&gt;test123&lt;/span&gt;&lt;br/&gt;    &lt;span&gt;networks:&lt;/span&gt;&lt;br/&gt;      &lt;span&gt;-&lt;/span&gt; &lt;span&gt;elastic&lt;/span&gt;&lt;br/&gt;&lt;br/&gt;  &lt;span&gt;# 集群 cluster02&lt;/span&gt;&lt;br/&gt;  &lt;span&gt;es02:&lt;/span&gt;&lt;br/&gt;    &lt;span&gt;image:&lt;/span&gt; &lt;span&gt;docker.elastic.co/elasticsearch/elasticsearch:7.16.2&lt;/span&gt;&lt;br/&gt;    &lt;span&gt;container_name:&lt;/span&gt; &lt;span&gt;es02&lt;/span&gt;&lt;br/&gt;    &lt;span&gt;environment:&lt;/span&gt;&lt;br/&gt;      &lt;span&gt;-&lt;/span&gt; &lt;span&gt;node.name=es02&lt;/span&gt;&lt;br/&gt;      &lt;span&gt;-&lt;/span&gt; &lt;span&gt;cluster.name=cluster02&lt;/span&gt;&lt;br/&gt;      &lt;span&gt;-&lt;/span&gt; &lt;span&gt;discovery.type=single-node&lt;/span&gt;&lt;br/&gt;      &lt;span&gt;-&lt;/span&gt; &lt;span&gt;bootstrap.memory_lock=true&lt;/span&gt;&lt;br/&gt;      &lt;span&gt;-&lt;/span&gt; &lt;span&gt;&quot;ES_JAVA_OPTS=-Xms2g -Xmx2g&quot;&lt;/span&gt;&lt;br/&gt;      &lt;span&gt;-&lt;/span&gt; &lt;span&gt;xpack.security.enabled=true&lt;/span&gt;&lt;br/&gt;      &lt;span&gt;-&lt;/span&gt; &lt;span&gt;ELASTIC_PASSWORD=test123&lt;/span&gt;&lt;br/&gt;    &lt;span&gt;ulimits:&lt;/span&gt;&lt;br/&gt;      &lt;span&gt;memlock:&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;soft:&lt;/span&gt; &lt;span&gt;-1&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;hard:&lt;/span&gt; &lt;span&gt;-1&lt;/span&gt;&lt;br/&gt;    &lt;span&gt;ports:&lt;/span&gt;&lt;br/&gt;      &lt;span&gt;-&lt;/span&gt; &lt;span&gt;9201&lt;/span&gt;&lt;span&gt;:9200&lt;/span&gt;&lt;br/&gt;    &lt;span&gt;volumes:&lt;/span&gt;&lt;br/&gt;      &lt;span&gt;-&lt;/span&gt; &lt;span&gt;data02:/usr/share/elasticsearch/data&lt;/span&gt;&lt;br/&gt;    &lt;span&gt;networks:&lt;/span&gt;&lt;br/&gt;      &lt;span&gt;-&lt;/span&gt; &lt;span&gt;elastic&lt;/span&gt;&lt;br/&gt;&lt;br/&gt;  &lt;span&gt;kib02:&lt;/span&gt;&lt;br/&gt;    &lt;span&gt;image:&lt;/span&gt; &lt;span&gt;docker.elastic.co/kibana/kibana:7.16.2&lt;/span&gt;&lt;br/&gt;    &lt;span&gt;container_name:&lt;/span&gt; &lt;span&gt;kib02&lt;/span&gt;&lt;br/&gt;    &lt;span&gt;ports:&lt;/span&gt;&lt;br/&gt;      &lt;span&gt;-&lt;/span&gt; &lt;span&gt;5602&lt;/span&gt;&lt;span&gt;:5601&lt;/span&gt;&lt;br/&gt;    &lt;span&gt;environment:&lt;/span&gt;&lt;br/&gt;      &lt;span&gt;ELASTICSEARCH_URL:&lt;/span&gt; &lt;span&gt;http://es02:9200&lt;/span&gt;&lt;br/&gt;      &lt;span&gt;ELASTICSEARCH_HOSTS:&lt;/span&gt; &lt;span&gt;&#x27;[&quot;http://es02:9200&quot;]&#x27;&lt;/span&gt;&lt;br/&gt;      &lt;span&gt;ELASTICSEARCH_USERNAME:&lt;/span&gt; &lt;span&gt;elastic&lt;/span&gt;&lt;br/&gt;      &lt;span&gt;ELASTICSEARCH_PASSWORD:&lt;/span&gt; &lt;span&gt;test123&lt;/span&gt;&lt;br/&gt;    &lt;span&gt;networks:&lt;/span&gt;&lt;br/&gt;      &lt;span&gt;-&lt;/span&gt; &lt;span&gt;elastic&lt;/span&gt;&lt;br/&gt;  &lt;span&gt;# 极限网关&lt;/span&gt;&lt;br/&gt;  &lt;span&gt;infini-gateway:&lt;/span&gt;&lt;br/&gt;    &lt;span&gt;image:&lt;/span&gt; &lt;span&gt;infinilabs/gateway:latest&lt;/span&gt;&lt;br/&gt;    &lt;span&gt;container_name:&lt;/span&gt; &lt;span&gt;infini-gateway&lt;/span&gt;&lt;br/&gt;    &lt;span&gt;ports:&lt;/span&gt;&lt;br/&gt;      &lt;span&gt;-&lt;/span&gt; &lt;span&gt;2900&lt;/span&gt;&lt;span&gt;:2900&lt;/span&gt;&lt;br/&gt;      &lt;span&gt;-&lt;/span&gt; &lt;span&gt;8000&lt;/span&gt;&lt;span&gt;:8000&lt;/span&gt;&lt;br/&gt;      &lt;span&gt;-&lt;/span&gt; &lt;span&gt;8001&lt;/span&gt;&lt;span&gt;:8001&lt;/span&gt;&lt;br/&gt;      &lt;span&gt;-&lt;/span&gt; &lt;span&gt;8002&lt;/span&gt;&lt;span&gt;:8002&lt;/span&gt;&lt;br/&gt;    &lt;span&gt;volumes:&lt;/span&gt;&lt;br/&gt;      &lt;span&gt;-&lt;/span&gt; &lt;span&gt;./gateway.yml:/gateway.yml&lt;/span&gt;    &lt;br/&gt;      &lt;span&gt;-&lt;/span&gt; &lt;span&gt;data03:/software/infini-gateway&lt;/span&gt;    &lt;br/&gt;    &lt;span&gt;networks:&lt;/span&gt;&lt;br/&gt;      &lt;span&gt;-&lt;/span&gt; &lt;span&gt;elastic&lt;/span&gt;&lt;br/&gt;&lt;br/&gt;&lt;span&gt;# 存储卷&lt;/span&gt;&lt;br/&gt;&lt;span&gt;volumes:&lt;/span&gt;&lt;br/&gt;  &lt;span&gt;data01:&lt;/span&gt;&lt;br/&gt;    &lt;span&gt;driver:&lt;/span&gt; &lt;span&gt;local&lt;/span&gt;&lt;br/&gt;  &lt;span&gt;data02:&lt;/span&gt;&lt;br/&gt;    &lt;span&gt;driver:&lt;/span&gt; &lt;span&gt;local&lt;/span&gt;&lt;br/&gt;  &lt;span&gt;data03:&lt;/span&gt;&lt;br/&gt;    &lt;span&gt;driver:&lt;/span&gt; &lt;span&gt;local&lt;/span&gt;&lt;br/&gt;&lt;br/&gt;&lt;span&gt;# 网络&lt;/span&gt;&lt;br/&gt;&lt;span&gt;networks:&lt;/span&gt;&lt;br/&gt;  &lt;span&gt;elastic:&lt;/span&gt;&lt;br/&gt;    &lt;span&gt;driver:&lt;/span&gt; &lt;span&gt;bridge&lt;/span&gt;&lt;br/&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;极限网关的配置文件 gateway.yml 如下所示。&lt;/span&gt;&lt;/p&gt;&lt;pre data-tool=&quot;mdnice编辑器&quot;&gt;&lt;code&gt;&lt;span&gt;&lt;span&gt;# 数据路径&lt;/span&gt;&lt;br/&gt;&lt;span&gt;path.data:&lt;/span&gt; &lt;span&gt;/software/infini-gateway/data&lt;/span&gt;&lt;br/&gt;&lt;span&gt;# 日志路径&lt;/span&gt;&lt;br/&gt;&lt;span&gt;path.logs:&lt;/span&gt; &lt;span&gt;/software/infini-gateway/log&lt;/span&gt;&lt;br/&gt;&lt;br/&gt;&lt;span&gt;# 定义 Elasticsearch 集群地址&lt;/span&gt;&lt;br/&gt;&lt;span&gt;elasticsearch:&lt;/span&gt;&lt;br/&gt;&lt;span&gt;# cluster01 集群&lt;/span&gt;&lt;br/&gt;&lt;span&gt;-&lt;/span&gt; &lt;span&gt;name:&lt;/span&gt; &lt;span&gt;cluster01&lt;/span&gt;&lt;br/&gt;  &lt;span&gt;enabled:&lt;/span&gt; &lt;span&gt;true&lt;/span&gt;&lt;br/&gt;  &lt;span&gt;endpoint:&lt;/span&gt; &lt;span&gt;http://es01:9200&lt;/span&gt;&lt;br/&gt;  &lt;span&gt;basic_auth:&lt;/span&gt;&lt;br/&gt;    &lt;span&gt;username:&lt;/span&gt; &lt;span&gt;elastic&lt;/span&gt;&lt;br/&gt;    &lt;span&gt;password:&lt;/span&gt; &lt;span&gt;test123&lt;/span&gt;&lt;br/&gt;&lt;span&gt;# cluster02 集群&lt;/span&gt;&lt;br/&gt;&lt;span&gt;-&lt;/span&gt; &lt;span&gt;name:&lt;/span&gt; &lt;span&gt;cluster02&lt;/span&gt;&lt;br/&gt;  &lt;span&gt;enabled:&lt;/span&gt; &lt;span&gt;true&lt;/span&gt;&lt;br/&gt;  &lt;span&gt;endpoint:&lt;/span&gt; &lt;span&gt;http://es02:9200&lt;/span&gt;&lt;br/&gt;  &lt;span&gt;basic_auth:&lt;/span&gt;&lt;br/&gt;    &lt;span&gt;username:&lt;/span&gt; &lt;span&gt;elastic&lt;/span&gt;&lt;br/&gt;    &lt;span&gt;password:&lt;/span&gt; &lt;span&gt;test123&lt;/span&gt;&lt;br/&gt;&lt;br/&gt;&lt;span&gt;# 定义网关入口&lt;/span&gt;&lt;br/&gt;&lt;span&gt;entry:&lt;/span&gt;&lt;br/&gt;  &lt;span&gt;-&lt;/span&gt; &lt;span&gt;name:&lt;/span&gt; &lt;span&gt;my_es_entry&lt;/span&gt;&lt;br/&gt;    &lt;span&gt;enabled:&lt;/span&gt; &lt;span&gt;true&lt;/span&gt;&lt;br/&gt;    &lt;span&gt;router:&lt;/span&gt; &lt;span&gt;my_router&lt;/span&gt;&lt;br/&gt;    &lt;span&gt;network:&lt;/span&gt;&lt;br/&gt;      &lt;span&gt;binding:&lt;/span&gt; &lt;span&gt;0.0.0.0&lt;/span&gt;&lt;span&gt;:8000&lt;/span&gt;&lt;br/&gt;&lt;br/&gt;&lt;span&gt;# 定义工作流&lt;/span&gt;&lt;br/&gt;&lt;span&gt;flow:&lt;/span&gt;&lt;br/&gt; &lt;span&gt;# 写请求优先发给主集群, 当主集群不可用时发给备集群&lt;/span&gt;&lt;br/&gt; &lt;span&gt;# 当主集群数据写入成功时，记录到队列中，异步消费写入备集群&lt;/span&gt;&lt;br/&gt;  &lt;span&gt;-&lt;/span&gt; &lt;span&gt;name:&lt;/span&gt; &lt;span&gt;write-flow&lt;/span&gt;&lt;br/&gt;    &lt;span&gt;filter:&lt;/span&gt;&lt;br/&gt;      &lt;span&gt;-&lt;/span&gt; &lt;span&gt;if:&lt;/span&gt;&lt;br/&gt;      &lt;span&gt;# 当主集群可用时&lt;/span&gt;&lt;br/&gt;          &lt;span&gt;cluster_available:&lt;/span&gt; &lt;span&gt;[&quot;cluster01&quot;]&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;then:&lt;/span&gt;&lt;br/&gt;          &lt;span&gt;# 先将数据写入主集群&lt;/span&gt;&lt;br/&gt;          &lt;span&gt;-&lt;/span&gt; &lt;span&gt;elasticsearch:&lt;/span&gt;&lt;br/&gt;              &lt;span&gt;elasticsearch:&lt;/span&gt; &lt;span&gt;&quot;cluster01&quot;&lt;/span&gt;&lt;br/&gt;            &lt;span&gt;# 写入消息队列,等待 pipeline 异步消费到备集群&lt;/span&gt;&lt;br/&gt;          &lt;span&gt;-&lt;/span&gt; &lt;span&gt;queue:&lt;/span&gt;&lt;br/&gt;              &lt;span&gt;queue_name:&lt;/span&gt; &lt;span&gt;&quot;cluster02-queue&quot;&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;else:&lt;/span&gt;&lt;br/&gt;          &lt;span&gt;-&lt;/span&gt; &lt;span&gt;elasticsearch:&lt;/span&gt;&lt;br/&gt;              &lt;span&gt;elasticsearch:&lt;/span&gt; &lt;span&gt;&quot;cluster02&quot;&lt;/span&gt;&lt;br/&gt;          &lt;span&gt;-&lt;/span&gt; &lt;span&gt;queue:&lt;/span&gt;&lt;br/&gt;              &lt;span&gt;queue_name:&lt;/span&gt; &lt;span&gt;&quot;cluster01-queue&quot;&lt;/span&gt;&lt;br/&gt;  &lt;span&gt;# 读请求优先发给主集群, 当主集群不可用时发给备集群&lt;/span&gt;&lt;br/&gt;  &lt;span&gt;-&lt;/span&gt; &lt;span&gt;name:&lt;/span&gt; &lt;span&gt;read-flow&lt;/span&gt;&lt;br/&gt;    &lt;span&gt;filter:&lt;/span&gt;&lt;br/&gt;      &lt;span&gt;-&lt;/span&gt; &lt;span&gt;if:&lt;/span&gt;&lt;br/&gt;          &lt;span&gt;cluster_available:&lt;/span&gt; &lt;span&gt;[&quot;cluster01&quot;]&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;then:&lt;/span&gt;&lt;br/&gt;          &lt;span&gt;-&lt;/span&gt; &lt;span&gt;elasticsearch:&lt;/span&gt;&lt;br/&gt;              &lt;span&gt;elasticsearch:&lt;/span&gt; &lt;span&gt;&quot;cluster01&quot;&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;else:&lt;/span&gt;&lt;br/&gt;          &lt;span&gt;-&lt;/span&gt; &lt;span&gt;elasticsearch:&lt;/span&gt;&lt;br/&gt;              &lt;span&gt;elasticsearch:&lt;/span&gt; &lt;span&gt;&quot;cluster02&quot;&lt;/span&gt;&lt;br/&gt;&lt;br/&gt;&lt;span&gt;# 路由规则&lt;/span&gt;&lt;br/&gt;&lt;span&gt;router:&lt;/span&gt;&lt;br/&gt;  &lt;span&gt;-&lt;/span&gt; &lt;span&gt;name:&lt;/span&gt; &lt;span&gt;my_router&lt;/span&gt;&lt;br/&gt;    &lt;span&gt;# 默认路由&lt;/span&gt;&lt;br/&gt;    &lt;span&gt;default_flow:&lt;/span&gt; &lt;span&gt;write-flow&lt;/span&gt;&lt;br/&gt;    &lt;span&gt;# 读请求路由&lt;/span&gt;&lt;br/&gt;    &lt;span&gt;rules:&lt;/span&gt;&lt;br/&gt;      &lt;span&gt;-&lt;/span&gt; &lt;span&gt;method:&lt;/span&gt;&lt;br/&gt;          &lt;span&gt;-&lt;/span&gt; &lt;span&gt;&quot;GET&quot;&lt;/span&gt;&lt;br/&gt;          &lt;span&gt;-&lt;/span&gt; &lt;span&gt;&quot;HEAD&quot;&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;pattern:&lt;/span&gt;&lt;br/&gt;          &lt;span&gt;-&lt;/span&gt; &lt;span&gt;&quot;/{any:*}&quot;&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;flow:&lt;/span&gt;&lt;br/&gt;          &lt;span&gt;-&lt;/span&gt; &lt;span&gt;read-flow&lt;/span&gt;&lt;br/&gt;      &lt;span&gt;-&lt;/span&gt; &lt;span&gt;method:&lt;/span&gt;&lt;br/&gt;          &lt;span&gt;-&lt;/span&gt; &lt;span&gt;&quot;POST&quot;&lt;/span&gt;&lt;br/&gt;          &lt;span&gt;-&lt;/span&gt; &lt;span&gt;&quot;GET&quot;&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;pattern:&lt;/span&gt;&lt;br/&gt;          &lt;span&gt;-&lt;/span&gt; &lt;span&gt;&quot;/_refresh&quot;&lt;/span&gt;&lt;br/&gt;          &lt;span&gt;-&lt;/span&gt; &lt;span&gt;&quot;/_count&quot;&lt;/span&gt;&lt;br/&gt;          &lt;span&gt;-&lt;/span&gt; &lt;span&gt;&quot;/_search&quot;&lt;/span&gt;&lt;br/&gt;          &lt;span&gt;-&lt;/span&gt; &lt;span&gt;&quot;/_msearch&quot;&lt;/span&gt;&lt;br/&gt;          &lt;span&gt;-&lt;/span&gt; &lt;span&gt;&quot;/_mget&quot;&lt;/span&gt;&lt;br/&gt;          &lt;span&gt;-&lt;/span&gt; &lt;span&gt;&quot;/{any_index}/_count&quot;&lt;/span&gt;&lt;br/&gt;          &lt;span&gt;-&lt;/span&gt; &lt;span&gt;&quot;/{any_index}/_search&quot;&lt;/span&gt;&lt;br/&gt;          &lt;span&gt;-&lt;/span&gt; &lt;span&gt;&quot;/{any_index}/_msearch&quot;&lt;/span&gt;&lt;br/&gt;          &lt;span&gt;-&lt;/span&gt; &lt;span&gt;&quot;/{any_index}/_mget&quot;&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;flow:&lt;/span&gt;&lt;br/&gt;          &lt;span&gt;-&lt;/span&gt; &lt;span&gt;read-flow&lt;/span&gt;&lt;br/&gt;&lt;br/&gt;&lt;span&gt;# 定义管道, 异步将数据写入备集群&lt;/span&gt;&lt;br/&gt;&lt;span&gt;pipeline:&lt;/span&gt;&lt;br/&gt;  &lt;span&gt;-&lt;/span&gt; &lt;span&gt;name:&lt;/span&gt; &lt;span&gt;cluster01-consumer&lt;/span&gt;&lt;br/&gt;    &lt;span&gt;auto_start:&lt;/span&gt; &lt;span&gt;true&lt;/span&gt;&lt;br/&gt;    &lt;span&gt;keep_running:&lt;/span&gt; &lt;span&gt;true&lt;/span&gt;&lt;br/&gt;    &lt;span&gt;processor:&lt;/span&gt;&lt;br/&gt;      &lt;span&gt;-&lt;/span&gt; &lt;span&gt;queue_consumer:&lt;/span&gt;&lt;br/&gt;          &lt;span&gt;input_queue:&lt;/span&gt; &lt;span&gt;&quot;cluster01-queue&quot;&lt;/span&gt; &lt;br/&gt;          &lt;span&gt;elasticsearch:&lt;/span&gt; &lt;span&gt;&quot;cluster01&quot;&lt;/span&gt;&lt;br/&gt;          &lt;span&gt;when:&lt;/span&gt;&lt;br/&gt;            &lt;span&gt;cluster_available:&lt;/span&gt; &lt;span&gt;[&quot;cluster01&quot;]&lt;/span&gt; &lt;span&gt;# 当集群可用时，才消费队列中的数据&lt;/span&gt;&lt;br/&gt;  &lt;span&gt;-&lt;/span&gt; &lt;span&gt;name:&lt;/span&gt; &lt;span&gt;cluster02-consumer&lt;/span&gt;&lt;br/&gt;    &lt;span&gt;auto_start:&lt;/span&gt; &lt;span&gt;true&lt;/span&gt;&lt;br/&gt;    &lt;span&gt;keep_running:&lt;/span&gt; &lt;span&gt;true&lt;/span&gt;&lt;br/&gt;    &lt;span&gt;processor:&lt;/span&gt;&lt;br/&gt;      &lt;span&gt;-&lt;/span&gt; &lt;span&gt;queue_consumer:&lt;/span&gt;&lt;br/&gt;          &lt;span&gt;input_queue:&lt;/span&gt; &lt;span&gt;&quot;cluster02-queue&quot;&lt;/span&gt;&lt;br/&gt;          &lt;span&gt;elasticsearch:&lt;/span&gt; &lt;span&gt;&quot;cluster02&quot;&lt;/span&gt;&lt;br/&gt;          &lt;span&gt;when:&lt;/span&gt;&lt;br/&gt;            &lt;span&gt;cluster_available:&lt;/span&gt; &lt;span&gt;[&quot;cluster02&quot;]&lt;/span&gt;&lt;br/&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;h5 data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;9.5.1.2 启动容器&lt;/span&gt;&lt;/h5&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;进入极限网关实验目录，启动容器。&lt;/span&gt;&lt;/p&gt;&lt;pre data-tool=&quot;mdnice编辑器&quot;&gt;&lt;code&gt;&lt;span&gt;&lt;span&gt;cd&lt;/span&gt; infini-gateway&lt;br/&gt;docker-compose up -d&lt;br/&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;查看容器状态。&lt;/span&gt;&lt;/p&gt;&lt;pre data-tool=&quot;mdnice编辑器&quot;&gt;&lt;code&gt;&lt;span&gt;$ docker-compose ps&lt;br/&gt;     Name                   Command               State                                        Ports                                     &lt;br/&gt;-----------------------------------------------------------------------------------------------------------------------------------------&lt;br/&gt;es01             /bin/tini -- /usr/&lt;span&gt;local&lt;/span&gt;/bi ...   Up      0.0.0.0:9200-&amp;gt;9200/tcp,:::9200-&amp;gt;9200/tcp, 9300/tcp                             &lt;br/&gt;es02             /bin/tini -- /usr/&lt;span&gt;local&lt;/span&gt;/bi ...   Up      0.0.0.0:9201-&amp;gt;9200/tcp,:::9201-&amp;gt;9200/tcp, 9300/tcp                             &lt;br/&gt;infini-gateway   /gateway                         Up      0.0.0.0:2900-&amp;gt;2900/tcp,:::2900-&amp;gt;2900/tcp,                                      &lt;br/&gt;                                                          0.0.0.0:8000-&amp;gt;8000/tcp,:::8000-&amp;gt;8000/tcp,                                      &lt;br/&gt;                                                          0.0.0.0:8001-&amp;gt;8001/tcp,:::8001-&amp;gt;8001/tcp,                                      &lt;br/&gt;                                                          0.0.0.0:8002-&amp;gt;8002/tcp,:::8002-&amp;gt;8002/tcp                                       &lt;br/&gt;kib01            /bin/tini -- /usr/&lt;span&gt;local&lt;/span&gt;/bi ...   Up      0.0.0.0:5601-&amp;gt;5601/tcp,:::5601-&amp;gt;5601/tcp                                       &lt;br/&gt;kib02            /bin/tini -- /usr/&lt;span&gt;local&lt;/span&gt;/bi ...   Up      0.0.0.0:5602-&amp;gt;5601/tcp,:::5602-&amp;gt;5601/tcp &lt;br/&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;查看极限网关日志，可以看到此时极限网关已经成功连接到集群 cluster01 和 cluster02。&lt;/span&gt;&lt;/p&gt;&lt;pre data-tool=&quot;mdnice编辑器&quot;&gt;&lt;code&gt;&lt;span&gt;$ docker-compose logs -f infini-gateway&lt;br/&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;figure data-tool=&quot;mdnice编辑器&quot;&gt;&lt;img class=&quot;rich_pages wxw-img&quot; data-ratio=&quot;0.4802065404475043&quot; data-src=&quot;https://mmbiz.qpic.cn/mmbiz_png/mjl8GCpsL9auhKTS8YiaHLpE37Swaxib50GEpvqGEZVubm80qWHiaMTCjrx14oicPicPjnzIOyELYHbvPEqmqV6M43A/640?wx_fmt=png&quot; data-type=&quot;png&quot; data-w=&quot;1162&quot;/&gt;&lt;/figure&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;当两个集群都正常时，cluster01 是主集群，通过极限网关查看集群将返回集群 cluster01 的信息。&lt;/span&gt;&lt;/p&gt;&lt;pre data-tool=&quot;mdnice编辑器&quot;&gt;&lt;code&gt;&lt;span&gt;$ curl -u elastic:test123  http://11.8.36.25:8000&lt;br/&gt;{&lt;br/&gt;  &lt;span&gt;&quot;name&quot;&lt;/span&gt; : &lt;span&gt;&quot;es01&quot;&lt;/span&gt;,&lt;br/&gt;  &lt;span&gt;&quot;cluster_name&quot;&lt;/span&gt; : &lt;span&gt;&quot;cluster01&quot;&lt;/span&gt;,&lt;br/&gt;  &lt;span&gt;&quot;cluster_uuid&quot;&lt;/span&gt; : &lt;span&gt;&quot;0Fj2oq0LRxyNfMbTX2TqZA&quot;&lt;/span&gt;,&lt;br/&gt;  &lt;span&gt;&quot;version&quot;&lt;/span&gt; : {&lt;br/&gt;    &lt;span&gt;&quot;number&quot;&lt;/span&gt; : &lt;span&gt;&quot;7.16.2&quot;&lt;/span&gt;,&lt;br/&gt;    &lt;span&gt;&quot;build_flavor&quot;&lt;/span&gt; : &lt;span&gt;&quot;default&quot;&lt;/span&gt;,&lt;br/&gt;    &lt;span&gt;&quot;build_type&quot;&lt;/span&gt; : &lt;span&gt;&quot;docker&quot;&lt;/span&gt;,&lt;br/&gt;    &lt;span&gt;&quot;build_hash&quot;&lt;/span&gt; : &lt;span&gt;&quot;2b937c44140b6559905130a8650c64dbd0879cfb&quot;&lt;/span&gt;,&lt;br/&gt;    &lt;span&gt;&quot;build_date&quot;&lt;/span&gt; : &lt;span&gt;&quot;2021-12-18T19:42:46.604893745Z&quot;&lt;/span&gt;,&lt;br/&gt;    &lt;span&gt;&quot;build_snapshot&quot;&lt;/span&gt; : &lt;span&gt;false&lt;/span&gt;,&lt;br/&gt;    &lt;span&gt;&quot;lucene_version&quot;&lt;/span&gt; : &lt;span&gt;&quot;8.10.1&quot;&lt;/span&gt;,&lt;br/&gt;    &lt;span&gt;&quot;minimum_wire_compatibility_version&quot;&lt;/span&gt; : &lt;span&gt;&quot;6.8.0&quot;&lt;/span&gt;,&lt;br/&gt;    &lt;span&gt;&quot;minimum_index_compatibility_version&quot;&lt;/span&gt; : &lt;span&gt;&quot;6.0.0-beta1&quot;&lt;/span&gt;&lt;br/&gt;  },&lt;br/&gt;  &lt;span&gt;&quot;tagline&quot;&lt;/span&gt; : &lt;span&gt;&quot;You Know, for Search&quot;&lt;/span&gt;&lt;br/&gt;}&lt;br/&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;h4 data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;9.5.2 验证同步&lt;/span&gt;&lt;/h4&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;插入 3 条数据。&lt;/span&gt;&lt;/p&gt;&lt;pre data-tool=&quot;mdnice编辑器&quot;&gt;&lt;code&gt;&lt;span&gt;&lt;span&gt;for&lt;/span&gt; &lt;span&gt;i&lt;/span&gt; &lt;span&gt;in&lt;/span&gt; &lt;span&gt;{1..3};do&lt;/span&gt; &lt;br/&gt;&lt;span&gt;curl&lt;/span&gt; &lt;span&gt;-XPUT&lt;/span&gt; &lt;span&gt;-u&lt;/span&gt; &lt;span&gt;elastic:test123&lt;/span&gt; &lt;span&gt;-H&lt;/span&gt; &lt;span&gt;&quot;Content-Type: Application/json&quot;&lt;/span&gt; &lt;span&gt;\&lt;/span&gt;&lt;br/&gt;&lt;span&gt;http://11.8.36.25:8000/index-1/_doc/$i&lt;/span&gt; &lt;span&gt;\&lt;/span&gt;&lt;br/&gt;&lt;span&gt;-d&lt;/span&gt; &lt;span&gt;&quot;{\&quot;name\&quot;:\&quot;tom_$i\&quot;,\&quot;age\&quot;:\&quot;$i\&quot;}&quot;;done&lt;/span&gt;&lt;br/&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;在集群 cluster01 和 cluster02 分别查询索引 index-1，可以查到相同的数据。&lt;/span&gt;&lt;/p&gt;&lt;pre data-tool=&quot;mdnice编辑器&quot;&gt;&lt;code&gt;&lt;span&gt;&lt;span&gt;GET&lt;/span&gt; &lt;span&gt;index-1/_search&lt;/span&gt;&lt;br/&gt;&lt;br/&gt;&lt;span&gt;# 返回结果&lt;/span&gt;&lt;br/&gt;&lt;span&gt;{&lt;/span&gt;&lt;br/&gt;  &lt;span&gt;&quot;took&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;3&lt;/span&gt;&lt;span&gt;,&lt;/span&gt;&lt;br/&gt;  &lt;span&gt;&quot;timed_out&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;false&lt;/span&gt;&lt;span&gt;,&lt;/span&gt;&lt;br/&gt;  &lt;span&gt;&quot;_shards&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;{&lt;/span&gt;&lt;br/&gt;    &lt;span&gt;&quot;total&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;1&lt;/span&gt;&lt;span&gt;,&lt;/span&gt;&lt;br/&gt;    &lt;span&gt;&quot;successful&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;1&lt;/span&gt;&lt;span&gt;,&lt;/span&gt;&lt;br/&gt;    &lt;span&gt;&quot;skipped&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;0&lt;/span&gt;&lt;span&gt;,&lt;/span&gt;&lt;br/&gt;    &lt;span&gt;&quot;failed&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;0&lt;/span&gt;&lt;br/&gt;  &lt;span&gt;},&lt;/span&gt;&lt;br/&gt;  &lt;span&gt;&quot;hits&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;{&lt;/span&gt;&lt;br/&gt;    &lt;span&gt;&quot;total&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;{&lt;/span&gt;&lt;br/&gt;      &lt;span&gt;&quot;value&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;3&lt;/span&gt;&lt;span&gt;,&lt;/span&gt;&lt;br/&gt;      &lt;span&gt;&quot;relation&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;&quot;eq&quot;&lt;/span&gt;&lt;br/&gt;    &lt;span&gt;},&lt;/span&gt;&lt;br/&gt;    &lt;span&gt;&quot;max_score&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;1.0&lt;/span&gt;&lt;span&gt;,&lt;/span&gt;&lt;br/&gt;    &lt;span&gt;&quot;hits&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;[&lt;/span&gt;&lt;br/&gt;      &lt;span&gt;{&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;&quot;_index&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;&quot;index-1&quot;,&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;&quot;_type&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;&quot;_doc&quot;,&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;&quot;_id&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;&quot;1&quot;,&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;&quot;_score&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;1.0&lt;/span&gt;&lt;span&gt;,&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;&quot;_source&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;{&lt;/span&gt;&lt;br/&gt;          &lt;span&gt;&quot;name&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;&quot;tom_1&quot;,&lt;/span&gt;&lt;br/&gt;          &lt;span&gt;&quot;age&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;&quot;1&quot;&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;}&lt;/span&gt;&lt;br/&gt;      &lt;span&gt;},&lt;/span&gt;&lt;br/&gt;      &lt;span&gt;{&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;&quot;_index&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;&quot;index-1&quot;,&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;&quot;_type&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;&quot;_doc&quot;,&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;&quot;_id&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;&quot;2&quot;,&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;&quot;_score&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;1.0&lt;/span&gt;&lt;span&gt;,&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;&quot;_source&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;{&lt;/span&gt;&lt;br/&gt;          &lt;span&gt;&quot;name&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;&quot;tom_2&quot;,&lt;/span&gt;&lt;br/&gt;          &lt;span&gt;&quot;age&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;&quot;2&quot;&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;}&lt;/span&gt;&lt;br/&gt;      &lt;span&gt;},&lt;/span&gt;&lt;br/&gt;      &lt;span&gt;{&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;&quot;_index&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;&quot;index-1&quot;,&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;&quot;_type&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;&quot;_doc&quot;,&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;&quot;_id&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;&quot;3&quot;,&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;&quot;_score&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;1.0&lt;/span&gt;&lt;span&gt;,&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;&quot;_source&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;{&lt;/span&gt;&lt;br/&gt;          &lt;span&gt;&quot;name&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;&quot;tom_3&quot;,&lt;/span&gt;&lt;br/&gt;          &lt;span&gt;&quot;age&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;&quot;3&quot;&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;}&lt;/span&gt;&lt;br/&gt;      &lt;span&gt;}&lt;/span&gt;&lt;br/&gt;    &lt;span&gt;]&lt;/span&gt;&lt;br/&gt;  &lt;span&gt;}&lt;/span&gt;&lt;br/&gt;&lt;span&gt;}&lt;/span&gt;&lt;br/&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;修改 id 为 2 的数据。&lt;/span&gt;&lt;/p&gt;&lt;pre data-tool=&quot;mdnice编辑器&quot;&gt;&lt;code&gt;&lt;span&gt;curl -XPUT -u elastic:test123 -H &lt;span&gt;&quot;Content-Type: Application/json&quot;&lt;/span&gt; \&lt;br/&gt;http://11.8.36.25:8000/index-1/_doc/2 \&lt;br/&gt;-d &lt;span&gt;&#x27;{&quot;name&quot;:&quot;jack_2&quot;,&quot;age&quot;:&quot;100&quot;}&#x27;&lt;/span&gt;&lt;br/&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;再次查询，可以看到两个集群上 id 为 2 的文档都已经修改成功。&lt;/span&gt;&lt;/p&gt;&lt;pre data-tool=&quot;mdnice编辑器&quot;&gt;&lt;code&gt;&lt;span&gt;&lt;span&gt;GET&lt;/span&gt; &lt;span&gt;index-1/_doc/2&lt;/span&gt;&lt;br/&gt;&lt;br/&gt;&lt;span&gt;# 返回结果&lt;/span&gt;&lt;br/&gt;&lt;span&gt;{&lt;/span&gt;&lt;br/&gt;  &lt;span&gt;&quot;_index&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;&quot;index-1&quot;,&lt;/span&gt;&lt;br/&gt;  &lt;span&gt;&quot;_type&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;&quot;_doc&quot;,&lt;/span&gt;&lt;br/&gt;  &lt;span&gt;&quot;_id&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;&quot;2&quot;,&lt;/span&gt;&lt;br/&gt;  &lt;span&gt;&quot;_version&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;2&lt;/span&gt;&lt;span&gt;,&lt;/span&gt;&lt;br/&gt;  &lt;span&gt;&quot;_seq_no&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;3&lt;/span&gt;&lt;span&gt;,&lt;/span&gt;&lt;br/&gt;  &lt;span&gt;&quot;_primary_term&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;1&lt;/span&gt;&lt;span&gt;,&lt;/span&gt;&lt;br/&gt;  &lt;span&gt;&quot;found&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;true&lt;/span&gt;&lt;span&gt;,&lt;/span&gt;&lt;br/&gt;  &lt;span&gt;&quot;_source&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;{&lt;/span&gt;&lt;br/&gt;    &lt;span&gt;&quot;name&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;&quot;jack_2&quot;,&lt;/span&gt;&lt;br/&gt;    &lt;span&gt;&quot;age&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;&quot;100&quot;&lt;/span&gt;&lt;br/&gt;  &lt;span&gt;}&lt;/span&gt;&lt;br/&gt;&lt;span&gt;}&lt;/span&gt;&lt;br/&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;删除 id 为 1 的数据。&lt;/span&gt;&lt;/p&gt;&lt;pre data-tool=&quot;mdnice编辑器&quot;&gt;&lt;code&gt;&lt;span&gt;curl -XDELETE -u elastic:test123 \&lt;br/&gt;http://11.8.36.25:8000/index-1/_doc/1&lt;br/&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;查询索引 index-1 ，此时两个集群上 id 为 1 的文档都已经删除。&lt;/span&gt;&lt;/p&gt;&lt;pre data-tool=&quot;mdnice编辑器&quot;&gt;&lt;code&gt;&lt;span&gt;&lt;span&gt;GET&lt;/span&gt; &lt;span&gt;index-1/_search&lt;/span&gt;&lt;br/&gt;&lt;br/&gt;&lt;span&gt;# 返回结果&lt;/span&gt;&lt;br/&gt;&lt;span&gt;{&lt;/span&gt;&lt;br/&gt;  &lt;span&gt;&quot;took&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;795&lt;/span&gt;&lt;span&gt;,&lt;/span&gt;&lt;br/&gt;  &lt;span&gt;&quot;timed_out&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;false&lt;/span&gt;&lt;span&gt;,&lt;/span&gt;&lt;br/&gt;  &lt;span&gt;&quot;_shards&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;{&lt;/span&gt;&lt;br/&gt;    &lt;span&gt;&quot;total&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;1&lt;/span&gt;&lt;span&gt;,&lt;/span&gt;&lt;br/&gt;    &lt;span&gt;&quot;successful&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;1&lt;/span&gt;&lt;span&gt;,&lt;/span&gt;&lt;br/&gt;    &lt;span&gt;&quot;skipped&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;0&lt;/span&gt;&lt;span&gt;,&lt;/span&gt;&lt;br/&gt;    &lt;span&gt;&quot;failed&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;0&lt;/span&gt;&lt;br/&gt;  &lt;span&gt;},&lt;/span&gt;&lt;br/&gt;  &lt;span&gt;&quot;hits&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;{&lt;/span&gt;&lt;br/&gt;    &lt;span&gt;&quot;total&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;{&lt;/span&gt;&lt;br/&gt;      &lt;span&gt;&quot;value&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;2&lt;/span&gt;&lt;span&gt;,&lt;/span&gt;&lt;br/&gt;      &lt;span&gt;&quot;relation&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;&quot;eq&quot;&lt;/span&gt;&lt;br/&gt;    &lt;span&gt;},&lt;/span&gt;&lt;br/&gt;    &lt;span&gt;&quot;max_score&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;1.0&lt;/span&gt;&lt;span&gt;,&lt;/span&gt;&lt;br/&gt;    &lt;span&gt;&quot;hits&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;[&lt;/span&gt;&lt;br/&gt;      &lt;span&gt;{&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;&quot;_index&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;&quot;index-1&quot;,&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;&quot;_type&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;&quot;_doc&quot;,&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;&quot;_id&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;&quot;3&quot;,&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;&quot;_score&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;1.0&lt;/span&gt;&lt;span&gt;,&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;&quot;_source&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;{&lt;/span&gt;&lt;br/&gt;          &lt;span&gt;&quot;name&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;&quot;tom_3&quot;,&lt;/span&gt;&lt;br/&gt;          &lt;span&gt;&quot;age&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;&quot;3&quot;&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;}&lt;/span&gt;&lt;br/&gt;      &lt;span&gt;},&lt;/span&gt;&lt;br/&gt;      &lt;span&gt;{&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;&quot;_index&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;&quot;index-1&quot;,&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;&quot;_type&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;&quot;_doc&quot;,&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;&quot;_id&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;&quot;2&quot;,&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;&quot;_score&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;1.0&lt;/span&gt;&lt;span&gt;,&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;&quot;_source&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;{&lt;/span&gt;&lt;br/&gt;          &lt;span&gt;&quot;name&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;&quot;jack_2&quot;,&lt;/span&gt;&lt;br/&gt;          &lt;span&gt;&quot;age&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;&quot;100&quot;&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;}&lt;/span&gt;&lt;br/&gt;      &lt;span&gt;}&lt;/span&gt;&lt;br/&gt;    &lt;span&gt;]&lt;/span&gt;&lt;br/&gt;  &lt;span&gt;}&lt;/span&gt;&lt;br/&gt;&lt;span&gt;}&lt;/span&gt;&lt;br/&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;在网关上对数据进行查询，也是可以正确得到结果的。&lt;/span&gt;&lt;/p&gt;&lt;pre data-tool=&quot;mdnice编辑器&quot;&gt;&lt;code&gt;&lt;span&gt;curl -XGET -u elastic:test123 \&lt;br/&gt;http://11.8.36.25:8000/index-1/_search?pretty&lt;br/&gt;&lt;br/&gt;&lt;span&gt;# 返回结果&lt;/span&gt;&lt;br/&gt;{&lt;br/&gt;  &lt;span&gt;&quot;took&quot;&lt;/span&gt; : 3,&lt;br/&gt;  &lt;span&gt;&quot;timed_out&quot;&lt;/span&gt; : &lt;span&gt;false&lt;/span&gt;,&lt;br/&gt;  &lt;span&gt;&quot;_shards&quot;&lt;/span&gt; : {&lt;br/&gt;    &lt;span&gt;&quot;total&quot;&lt;/span&gt; : 1,&lt;br/&gt;    &lt;span&gt;&quot;successful&quot;&lt;/span&gt; : 1,&lt;br/&gt;    &lt;span&gt;&quot;skipped&quot;&lt;/span&gt; : 0,&lt;br/&gt;    &lt;span&gt;&quot;failed&quot;&lt;/span&gt; : 0&lt;br/&gt;  },&lt;br/&gt;  &lt;span&gt;&quot;hits&quot;&lt;/span&gt; : {&lt;br/&gt;    &lt;span&gt;&quot;total&quot;&lt;/span&gt; : {&lt;br/&gt;      &lt;span&gt;&quot;value&quot;&lt;/span&gt; : 2,&lt;br/&gt;      &lt;span&gt;&quot;relation&quot;&lt;/span&gt; : &lt;span&gt;&quot;eq&quot;&lt;/span&gt;&lt;br/&gt;    },&lt;br/&gt;    &lt;span&gt;&quot;max_score&quot;&lt;/span&gt; : 1.0,&lt;br/&gt;    &lt;span&gt;&quot;hits&quot;&lt;/span&gt; : [&lt;br/&gt;      {&lt;br/&gt;        &lt;span&gt;&quot;_index&quot;&lt;/span&gt; : &lt;span&gt;&quot;index-1&quot;&lt;/span&gt;,&lt;br/&gt;        &lt;span&gt;&quot;_type&quot;&lt;/span&gt; : &lt;span&gt;&quot;_doc&quot;&lt;/span&gt;,&lt;br/&gt;        &lt;span&gt;&quot;_id&quot;&lt;/span&gt; : &lt;span&gt;&quot;3&quot;&lt;/span&gt;,&lt;br/&gt;        &lt;span&gt;&quot;_score&quot;&lt;/span&gt; : 1.0,&lt;br/&gt;        &lt;span&gt;&quot;_source&quot;&lt;/span&gt; : {&lt;br/&gt;          &lt;span&gt;&quot;name&quot;&lt;/span&gt; : &lt;span&gt;&quot;tom_3&quot;&lt;/span&gt;,&lt;br/&gt;          &lt;span&gt;&quot;age&quot;&lt;/span&gt; : &lt;span&gt;&quot;3&quot;&lt;/span&gt;&lt;br/&gt;        }&lt;br/&gt;      },&lt;br/&gt;      {&lt;br/&gt;        &lt;span&gt;&quot;_index&quot;&lt;/span&gt; : &lt;span&gt;&quot;index-1&quot;&lt;/span&gt;,&lt;br/&gt;        &lt;span&gt;&quot;_type&quot;&lt;/span&gt; : &lt;span&gt;&quot;_doc&quot;&lt;/span&gt;,&lt;br/&gt;        &lt;span&gt;&quot;_id&quot;&lt;/span&gt; : &lt;span&gt;&quot;2&quot;&lt;/span&gt;,&lt;br/&gt;        &lt;span&gt;&quot;_score&quot;&lt;/span&gt; : 1.0,&lt;br/&gt;        &lt;span&gt;&quot;_source&quot;&lt;/span&gt; : {&lt;br/&gt;          &lt;span&gt;&quot;name&quot;&lt;/span&gt; : &lt;span&gt;&quot;jack_2&quot;&lt;/span&gt;,&lt;br/&gt;          &lt;span&gt;&quot;age&quot;&lt;/span&gt; : &lt;span&gt;&quot;100&quot;&lt;/span&gt;&lt;br/&gt;        }&lt;br/&gt;      }&lt;br/&gt;    ]&lt;br/&gt;  }&lt;br/&gt;}&lt;br/&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;h4 data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;9.5.3 故障测试&lt;/span&gt;&lt;/h4&gt;&lt;h5 data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;9.5.3.1 模拟备集群（cluster02）故障&lt;/span&gt;&lt;/h5&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;停止 cluster02 集群。&lt;/span&gt;&lt;/p&gt;&lt;pre data-tool=&quot;mdnice编辑器&quot;&gt;&lt;code&gt;&lt;span&gt;docker-compose stop es02&lt;br/&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;此时 es02 已经无法正常访问。&lt;/span&gt;&lt;/p&gt;&lt;figure data-tool=&quot;mdnice编辑器&quot;&gt;&lt;img class=&quot;rich_pages wxw-img&quot; data-ratio=&quot;0.4497751124437781&quot; data-src=&quot;https://mmbiz.qpic.cn/mmbiz_png/mjl8GCpsL9auhKTS8YiaHLpE37Swaxib502XPOg9bxSbEe8FRxziaLvMzaXa58trXvb76IjicY0Kicia4kKBE6vsNJYA/640?wx_fmt=png&quot; data-type=&quot;png&quot; data-w=&quot;1334&quot;/&gt;&lt;/figure&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;此时在极限网关上可以看到报错说集群 cluster02 不可用。&lt;/span&gt;&lt;/p&gt;&lt;pre data-tool=&quot;mdnice编辑器&quot;&gt;&lt;code&gt;&lt;span&gt;$ docker-compose logs -f infini-gateway&lt;br/&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;figure data-tool=&quot;mdnice编辑器&quot;&gt;&lt;img class=&quot;rich_pages wxw-img&quot; data-ratio=&quot;0.1282051282051282&quot; data-src=&quot;https://mmbiz.qpic.cn/mmbiz_png/mjl8GCpsL9auhKTS8YiaHLpE37Swaxib50Kib5lK2ElRuc7tp1nYUg92tN34Jhgs0o3iaEYeQzm8l4PicEKc1Med4Hw/640?wx_fmt=png&quot; data-type=&quot;png&quot; data-w=&quot;1521&quot;/&gt;&lt;/figure&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;接下来继续往索引 index-1 中插入 2 条数据。&lt;/span&gt;&lt;/p&gt;&lt;pre data-tool=&quot;mdnice编辑器&quot;&gt;&lt;code&gt;&lt;span&gt;&lt;span&gt;for&lt;/span&gt; i &lt;span&gt;in&lt;/span&gt; {4..5};&lt;span&gt;do&lt;/span&gt; &lt;br/&gt;curl -XPUT -u elastic:test123 -H &lt;span&gt;&quot;Content-Type: Application/json&quot;&lt;/span&gt; \&lt;br/&gt;http://11.8.36.25:8000/index-1/_doc/&lt;span&gt;$i&lt;/span&gt; \&lt;br/&gt;-d &lt;span&gt;&quot;{\&quot;name\&quot;:\&quot;tom_&lt;span&gt;$i&lt;/span&gt;\&quot;,\&quot;age\&quot;:\&quot;&lt;span&gt;$i&lt;/span&gt;\&quot;}&quot;&lt;/span&gt;;&lt;span&gt;done&lt;/span&gt;&lt;br/&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;查看集群 cluster01 发现新的 2 条数据插入成功。&lt;/span&gt;&lt;/p&gt;&lt;pre data-tool=&quot;mdnice编辑器&quot;&gt;&lt;code&gt;&lt;span&gt;&lt;span&gt;GET&lt;/span&gt; &lt;span&gt;index-1/_search&lt;/span&gt;&lt;br/&gt;&lt;br/&gt;&lt;span&gt;# 返回结果&lt;/span&gt;&lt;br/&gt;&lt;span&gt;{&lt;/span&gt;&lt;br/&gt;  &lt;span&gt;&quot;took&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;399&lt;/span&gt;&lt;span&gt;,&lt;/span&gt;&lt;br/&gt;  &lt;span&gt;&quot;timed_out&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;false&lt;/span&gt;&lt;span&gt;,&lt;/span&gt;&lt;br/&gt;  &lt;span&gt;&quot;_shards&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;{&lt;/span&gt;&lt;br/&gt;    &lt;span&gt;&quot;total&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;1&lt;/span&gt;&lt;span&gt;,&lt;/span&gt;&lt;br/&gt;    &lt;span&gt;&quot;successful&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;1&lt;/span&gt;&lt;span&gt;,&lt;/span&gt;&lt;br/&gt;    &lt;span&gt;&quot;skipped&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;0&lt;/span&gt;&lt;span&gt;,&lt;/span&gt;&lt;br/&gt;    &lt;span&gt;&quot;failed&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;0&lt;/span&gt;&lt;br/&gt;  &lt;span&gt;},&lt;/span&gt;&lt;br/&gt;  &lt;span&gt;&quot;hits&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;{&lt;/span&gt;&lt;br/&gt;    &lt;span&gt;&quot;total&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;{&lt;/span&gt;&lt;br/&gt;      &lt;span&gt;&quot;value&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;4&lt;/span&gt;&lt;span&gt;,&lt;/span&gt;&lt;br/&gt;      &lt;span&gt;&quot;relation&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;&quot;eq&quot;&lt;/span&gt;&lt;br/&gt;    &lt;span&gt;},&lt;/span&gt;&lt;br/&gt;    &lt;span&gt;&quot;max_score&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;1.0&lt;/span&gt;&lt;span&gt;,&lt;/span&gt;&lt;br/&gt;    &lt;span&gt;&quot;hits&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;[&lt;/span&gt;&lt;br/&gt;      &lt;span&gt;{&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;&quot;_index&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;&quot;index-1&quot;,&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;&quot;_type&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;&quot;_doc&quot;,&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;&quot;_id&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;&quot;3&quot;,&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;&quot;_score&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;1.0&lt;/span&gt;&lt;span&gt;,&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;&quot;_source&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;{&lt;/span&gt;&lt;br/&gt;          &lt;span&gt;&quot;name&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;&quot;tom_3&quot;,&lt;/span&gt;&lt;br/&gt;          &lt;span&gt;&quot;age&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;&quot;3&quot;&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;}&lt;/span&gt;&lt;br/&gt;      &lt;span&gt;},&lt;/span&gt;&lt;br/&gt;      &lt;span&gt;{&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;&quot;_index&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;&quot;index-1&quot;,&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;&quot;_type&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;&quot;_doc&quot;,&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;&quot;_id&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;&quot;2&quot;,&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;&quot;_score&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;1.0&lt;/span&gt;&lt;span&gt;,&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;&quot;_source&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;{&lt;/span&gt;&lt;br/&gt;          &lt;span&gt;&quot;name&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;&quot;jack_2&quot;,&lt;/span&gt;&lt;br/&gt;          &lt;span&gt;&quot;age&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;&quot;100&quot;&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;}&lt;/span&gt;&lt;br/&gt;      &lt;span&gt;},&lt;/span&gt;&lt;br/&gt;      &lt;span&gt;# 新插入的 2 条数据&lt;/span&gt;&lt;br/&gt;      &lt;span&gt;{&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;&quot;_index&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;&quot;index-1&quot;,&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;&quot;_type&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;&quot;_doc&quot;,&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;&quot;_id&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;&quot;4&quot;,&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;&quot;_score&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;1.0&lt;/span&gt;&lt;span&gt;,&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;&quot;_source&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;{&lt;/span&gt;&lt;br/&gt;          &lt;span&gt;&quot;name&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;&quot;tom_4&quot;,&lt;/span&gt;&lt;br/&gt;          &lt;span&gt;&quot;age&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;&quot;4&quot;&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;}&lt;/span&gt;&lt;br/&gt;      &lt;span&gt;},&lt;/span&gt;&lt;br/&gt;      &lt;span&gt;{&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;&quot;_index&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;&quot;index-1&quot;,&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;&quot;_type&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;&quot;_doc&quot;,&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;&quot;_id&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;&quot;5&quot;,&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;&quot;_score&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;1.0&lt;/span&gt;&lt;span&gt;,&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;&quot;_source&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;{&lt;/span&gt;&lt;br/&gt;          &lt;span&gt;&quot;name&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;&quot;tom_5&quot;,&lt;/span&gt;&lt;br/&gt;          &lt;span&gt;&quot;age&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;&quot;5&quot;&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;}&lt;/span&gt;&lt;br/&gt;      &lt;span&gt;}&lt;/span&gt;&lt;br/&gt;    &lt;span&gt;]&lt;/span&gt;&lt;br/&gt;  &lt;span&gt;}&lt;/span&gt;&lt;br/&gt;&lt;span&gt;}&lt;/span&gt;&lt;br/&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;访问极限网关的 API 接口查看本地队列状态，由于集群 cluster02 当前不可用，因此刚刚插入的 2 条消息保存在队列中，待集群 cluster02 恢复后再尝试消费。&lt;/span&gt;&lt;/p&gt;&lt;pre data-tool=&quot;mdnice编辑器&quot;&gt;&lt;code&gt;&lt;span&gt;&lt;span&gt;$&lt;/span&gt; &lt;span&gt;curl&lt;/span&gt; &lt;span&gt;http://11.8.36.25:2900/queue/stats&lt;/span&gt;&lt;br/&gt;&lt;br/&gt;&lt;span&gt;# 返回结果&lt;/span&gt;&lt;br/&gt;&lt;span&gt;{&lt;/span&gt;&lt;br/&gt;  &lt;span&gt;&quot;queue&quot;:&lt;/span&gt; &lt;span&gt;{&lt;/span&gt;&lt;br/&gt;    &lt;span&gt;&quot;disk&quot;:&lt;/span&gt; &lt;span&gt;{&lt;/span&gt;&lt;br/&gt;      &lt;span&gt;&quot;cluster01-queue&quot;:&lt;/span&gt; &lt;span&gt;{&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;&quot;depth&quot;:&lt;/span&gt; &lt;span&gt;0&lt;/span&gt;&lt;span&gt;,&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;&quot;metadata&quot;:&lt;/span&gt; &lt;span&gt;{&lt;/span&gt;&lt;br/&gt;          &lt;span&gt;&quot;source&quot;:&lt;/span&gt; &lt;span&gt;&quot;dynamic&quot;,&lt;/span&gt;&lt;br/&gt;          &lt;span&gt;&quot;id&quot;:&lt;/span&gt; &lt;span&gt;&quot;c79eq49r8oo0golornmg&quot;,&lt;/span&gt;&lt;br/&gt;          &lt;span&gt;&quot;name&quot;:&lt;/span&gt; &lt;span&gt;&quot;cluster01-queue&quot;,&lt;/span&gt;&lt;br/&gt;          &lt;span&gt;&quot;label&quot;:&lt;/span&gt; &lt;span&gt;null&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;}&lt;/span&gt;&lt;br/&gt;      &lt;span&gt;},&lt;/span&gt;&lt;br/&gt;      &lt;span&gt;&quot;cluster02-queue&quot;:&lt;/span&gt; &lt;span&gt;{&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;&quot;depth&quot;:&lt;/span&gt; &lt;span&gt;2&lt;/span&gt;&lt;span&gt;,&lt;/span&gt; &lt;span&gt;# 未成功异步写入集群 cluster02 的 2 条消息&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;&quot;metadata&quot;:&lt;/span&gt; &lt;span&gt;{&lt;/span&gt;&lt;br/&gt;          &lt;span&gt;&quot;source&quot;:&lt;/span&gt; &lt;span&gt;&quot;dynamic&quot;,&lt;/span&gt;&lt;br/&gt;          &lt;span&gt;&quot;id&quot;:&lt;/span&gt; &lt;span&gt;&quot;c79eq6pr8oo0golornt0&quot;,&lt;/span&gt;&lt;br/&gt;          &lt;span&gt;&quot;name&quot;:&lt;/span&gt; &lt;span&gt;&quot;cluster02-queue&quot;,&lt;/span&gt;&lt;br/&gt;          &lt;span&gt;&quot;label&quot;:&lt;/span&gt; &lt;span&gt;null&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;}&lt;/span&gt;&lt;br/&gt;      &lt;span&gt;},&lt;/span&gt;&lt;br/&gt;      &lt;span&gt;&quot;cluster_state_change&quot;:&lt;/span&gt; &lt;span&gt;{&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;&quot;depth&quot;:&lt;/span&gt; &lt;span&gt;8&lt;/span&gt;&lt;span&gt;,&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;&quot;metadata&quot;:&lt;/span&gt; &lt;span&gt;{&lt;/span&gt;&lt;br/&gt;          &lt;span&gt;&quot;source&quot;:&lt;/span&gt; &lt;span&gt;&quot;dynamic&quot;,&lt;/span&gt;&lt;br/&gt;          &lt;span&gt;&quot;id&quot;:&lt;/span&gt; &lt;span&gt;&quot;c79eq6pr8oo0golorns0&quot;,&lt;/span&gt;&lt;br/&gt;          &lt;span&gt;&quot;name&quot;:&lt;/span&gt; &lt;span&gt;&quot;cluster_state_change&quot;,&lt;/span&gt;&lt;br/&gt;          &lt;span&gt;&quot;label&quot;:&lt;/span&gt; &lt;span&gt;null&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;}&lt;/span&gt;&lt;br/&gt;      &lt;span&gt;}&lt;/span&gt;&lt;br/&gt;    &lt;span&gt;}&lt;/span&gt;&lt;br/&gt;  &lt;span&gt;}&lt;/span&gt;&lt;br/&gt;&lt;span&gt;}&lt;/span&gt;&lt;br/&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;恢复 es02。&lt;/span&gt;&lt;/p&gt;&lt;pre data-tool=&quot;mdnice编辑器&quot;&gt;&lt;code&gt;&lt;span&gt;&lt;span&gt;docker-compose&lt;/span&gt; &lt;span&gt;start&lt;/span&gt; &lt;span&gt;es02&lt;/span&gt;&lt;br/&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;查看网关日志可以看到集群 cluster02 恢复的信息。&lt;/span&gt;&lt;/p&gt;&lt;pre data-tool=&quot;mdnice编辑器&quot;&gt;&lt;code&gt;&lt;span&gt;$ docker-compose logs -f infini-gateway&lt;br/&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;figure data-tool=&quot;mdnice编辑器&quot;&gt;&lt;img class=&quot;rich_pages wxw-img&quot; data-ratio=&quot;0.24618447246184472&quot; data-src=&quot;https://mmbiz.qpic.cn/mmbiz_png/mjl8GCpsL9auhKTS8YiaHLpE37Swaxib50bicQXmQyxyBJTDtd79APJWRj5SEfXa4NYnoORajqibo2oPrhlmOibcmJQ/640?wx_fmt=png&quot; data-type=&quot;png&quot; data-w=&quot;1507&quot;/&gt;&lt;/figure&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;查询集群 cluster02 的数据，可以在 es02 停止期间的数据已经成功写入。&lt;/span&gt;&lt;/p&gt;&lt;pre data-tool=&quot;mdnice编辑器&quot;&gt;&lt;code&gt;&lt;span&gt;&lt;span&gt;GET&lt;/span&gt; &lt;span&gt;index-1/_search&lt;/span&gt;&lt;br/&gt;&lt;br/&gt;&lt;span&gt;# 返回结果&lt;/span&gt;&lt;br/&gt;&lt;span&gt;{&lt;/span&gt;&lt;br/&gt;  &lt;span&gt;&quot;took&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;3&lt;/span&gt;&lt;span&gt;,&lt;/span&gt;&lt;br/&gt;  &lt;span&gt;&quot;timed_out&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;false&lt;/span&gt;&lt;span&gt;,&lt;/span&gt;&lt;br/&gt;  &lt;span&gt;&quot;_shards&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;{&lt;/span&gt;&lt;br/&gt;    &lt;span&gt;&quot;total&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;1&lt;/span&gt;&lt;span&gt;,&lt;/span&gt;&lt;br/&gt;    &lt;span&gt;&quot;successful&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;1&lt;/span&gt;&lt;span&gt;,&lt;/span&gt;&lt;br/&gt;    &lt;span&gt;&quot;skipped&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;0&lt;/span&gt;&lt;span&gt;,&lt;/span&gt;&lt;br/&gt;    &lt;span&gt;&quot;failed&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;0&lt;/span&gt;&lt;br/&gt;  &lt;span&gt;},&lt;/span&gt;&lt;br/&gt;  &lt;span&gt;&quot;hits&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;{&lt;/span&gt;&lt;br/&gt;    &lt;span&gt;&quot;total&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;{&lt;/span&gt;&lt;br/&gt;      &lt;span&gt;&quot;value&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;4&lt;/span&gt;&lt;span&gt;,&lt;/span&gt;&lt;br/&gt;      &lt;span&gt;&quot;relation&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;&quot;eq&quot;&lt;/span&gt;&lt;br/&gt;    &lt;span&gt;},&lt;/span&gt;&lt;br/&gt;    &lt;span&gt;&quot;max_score&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;1.0&lt;/span&gt;&lt;span&gt;,&lt;/span&gt;&lt;br/&gt;    &lt;span&gt;&quot;hits&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;[&lt;/span&gt;&lt;br/&gt;    &lt;span&gt;# 新插入的 2 条数据&lt;/span&gt;&lt;br/&gt;      &lt;span&gt;{&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;&quot;_index&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;&quot;index-1&quot;,&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;&quot;_type&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;&quot;_doc&quot;,&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;&quot;_id&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;&quot;4&quot;,&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;&quot;_score&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;1.0&lt;/span&gt;&lt;span&gt;,&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;&quot;_source&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;{&lt;/span&gt;&lt;br/&gt;          &lt;span&gt;&quot;name&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;&quot;tom_4&quot;,&lt;/span&gt;&lt;br/&gt;          &lt;span&gt;&quot;age&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;&quot;4&quot;&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;}&lt;/span&gt;&lt;br/&gt;      &lt;span&gt;},&lt;/span&gt;&lt;br/&gt;      &lt;span&gt;{&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;&quot;_index&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;&quot;index-1&quot;,&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;&quot;_type&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;&quot;_doc&quot;,&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;&quot;_id&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;&quot;5&quot;,&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;&quot;_score&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;1.0&lt;/span&gt;&lt;span&gt;,&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;&quot;_source&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;{&lt;/span&gt;&lt;br/&gt;          &lt;span&gt;&quot;name&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;&quot;tom_5&quot;,&lt;/span&gt;&lt;br/&gt;          &lt;span&gt;&quot;age&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;&quot;5&quot;&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;}&lt;/span&gt;&lt;br/&gt;      &lt;span&gt;},&lt;/span&gt;&lt;br/&gt;      &lt;span&gt;{&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;&quot;_index&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;&quot;index-1&quot;,&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;&quot;_type&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;&quot;_doc&quot;,&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;&quot;_id&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;&quot;2&quot;,&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;&quot;_score&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;1.0&lt;/span&gt;&lt;span&gt;,&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;&quot;_source&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;{&lt;/span&gt;&lt;br/&gt;          &lt;span&gt;&quot;name&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;&quot;jack_2&quot;,&lt;/span&gt;&lt;br/&gt;          &lt;span&gt;&quot;age&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;&quot;100&quot;&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;}&lt;/span&gt;&lt;br/&gt;      &lt;span&gt;},&lt;/span&gt;&lt;br/&gt;      &lt;span&gt;{&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;&quot;_index&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;&quot;index-1&quot;,&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;&quot;_type&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;&quot;_doc&quot;,&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;&quot;_id&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;&quot;3&quot;,&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;&quot;_score&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;1.0&lt;/span&gt;&lt;span&gt;,&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;&quot;_source&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;{&lt;/span&gt;&lt;br/&gt;          &lt;span&gt;&quot;name&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;&quot;tom_3&quot;,&lt;/span&gt;&lt;br/&gt;          &lt;span&gt;&quot;age&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;&quot;3&quot;&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;}&lt;/span&gt;&lt;br/&gt;      &lt;span&gt;}&lt;/span&gt;&lt;br/&gt;    &lt;span&gt;]&lt;/span&gt;&lt;br/&gt;  &lt;span&gt;}&lt;/span&gt;&lt;br/&gt;&lt;span&gt;}&lt;/span&gt;&lt;br/&gt;&lt;br/&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;此时查看队列状态，&lt;/span&gt;&lt;code&gt;&lt;span&gt;cluster02-queue&lt;/span&gt;&lt;/code&gt;&lt;span&gt;  中的消息已经消费完毕。&lt;/span&gt;&lt;/p&gt;&lt;pre data-tool=&quot;mdnice编辑器&quot;&gt;&lt;code&gt;&lt;span&gt;&lt;span&gt;$&lt;/span&gt; &lt;span&gt;curl&lt;/span&gt; &lt;span&gt;http://11.8.36.25:2900/queue/stats&lt;/span&gt;&lt;br/&gt;&lt;br/&gt;&lt;span&gt;# 返回结果&lt;/span&gt;&lt;br/&gt;&lt;span&gt;{&lt;/span&gt;&lt;br/&gt;  &lt;span&gt;&quot;queue&quot;:&lt;/span&gt; &lt;span&gt;{&lt;/span&gt;&lt;br/&gt;    &lt;span&gt;&quot;disk&quot;:&lt;/span&gt; &lt;span&gt;{&lt;/span&gt;&lt;br/&gt;      &lt;span&gt;&quot;cluster01-queue&quot;:&lt;/span&gt; &lt;span&gt;{&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;&quot;depth&quot;:&lt;/span&gt; &lt;span&gt;0&lt;/span&gt;&lt;span&gt;,&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;&quot;metadata&quot;:&lt;/span&gt; &lt;span&gt;{&lt;/span&gt;&lt;br/&gt;          &lt;span&gt;&quot;source&quot;:&lt;/span&gt; &lt;span&gt;&quot;dynamic&quot;,&lt;/span&gt;&lt;br/&gt;          &lt;span&gt;&quot;id&quot;:&lt;/span&gt; &lt;span&gt;&quot;c79eq49r8oo0golornmg&quot;,&lt;/span&gt;&lt;br/&gt;          &lt;span&gt;&quot;name&quot;:&lt;/span&gt; &lt;span&gt;&quot;cluster01-queue&quot;,&lt;/span&gt;&lt;br/&gt;          &lt;span&gt;&quot;label&quot;:&lt;/span&gt; &lt;span&gt;null&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;}&lt;/span&gt;&lt;br/&gt;      &lt;span&gt;},&lt;/span&gt;&lt;br/&gt;      &lt;span&gt;&quot;cluster02-queue&quot;:&lt;/span&gt; &lt;span&gt;{&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;&quot;depth&quot;:&lt;/span&gt; &lt;span&gt;0&lt;/span&gt;&lt;span&gt;,&lt;/span&gt; &lt;span&gt;# 消费完毕&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;&quot;metadata&quot;:&lt;/span&gt; &lt;span&gt;{&lt;/span&gt;&lt;br/&gt;          &lt;span&gt;&quot;source&quot;:&lt;/span&gt; &lt;span&gt;&quot;dynamic&quot;,&lt;/span&gt;&lt;br/&gt;          &lt;span&gt;&quot;id&quot;:&lt;/span&gt; &lt;span&gt;&quot;c79eq6pr8oo0golornt0&quot;,&lt;/span&gt;&lt;br/&gt;          &lt;span&gt;&quot;name&quot;:&lt;/span&gt; &lt;span&gt;&quot;cluster02-queue&quot;,&lt;/span&gt;&lt;br/&gt;          &lt;span&gt;&quot;label&quot;:&lt;/span&gt; &lt;span&gt;null&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;}&lt;/span&gt;&lt;br/&gt;      &lt;span&gt;},&lt;/span&gt;&lt;br/&gt;      &lt;span&gt;&quot;cluster_state_change&quot;:&lt;/span&gt; &lt;span&gt;{&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;&quot;depth&quot;:&lt;/span&gt; &lt;span&gt;10&lt;/span&gt;&lt;span&gt;,&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;&quot;metadata&quot;:&lt;/span&gt; &lt;span&gt;{&lt;/span&gt;&lt;br/&gt;          &lt;span&gt;&quot;source&quot;:&lt;/span&gt; &lt;span&gt;&quot;dynamic&quot;,&lt;/span&gt;&lt;br/&gt;          &lt;span&gt;&quot;id&quot;:&lt;/span&gt; &lt;span&gt;&quot;c79eq6pr8oo0golorns0&quot;,&lt;/span&gt;&lt;br/&gt;          &lt;span&gt;&quot;name&quot;:&lt;/span&gt; &lt;span&gt;&quot;cluster_state_change&quot;,&lt;/span&gt;&lt;br/&gt;          &lt;span&gt;&quot;label&quot;:&lt;/span&gt; &lt;span&gt;null&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;}&lt;/span&gt;&lt;br/&gt;      &lt;span&gt;}&lt;/span&gt;&lt;br/&gt;    &lt;span&gt;}&lt;/span&gt;&lt;br/&gt;  &lt;span&gt;}&lt;/span&gt;&lt;br/&gt;&lt;span&gt;}&lt;/span&gt;&lt;br/&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;h5 data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;9.5.3.2 模拟主集群（cluster01）故障&lt;/span&gt;&lt;/h5&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;停止 cluster01 集群。&lt;/span&gt;&lt;/p&gt;&lt;pre data-tool=&quot;mdnice编辑器&quot;&gt;&lt;code&gt;&lt;span&gt;docker-compose stop es01&lt;br/&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;此时 es01 已经无法正常访问。&lt;/span&gt;&lt;/p&gt;&lt;figure data-tool=&quot;mdnice编辑器&quot;&gt;&lt;img class=&quot;rich_pages wxw-img&quot; data-ratio=&quot;0.4694589877835951&quot; data-src=&quot;https://mmbiz.qpic.cn/mmbiz_png/mjl8GCpsL9auhKTS8YiaHLpE37Swaxib50gzLdial0z41reQxbfy8jmcoFuZXdiar397dibMomhswtlicncQ4GK3NJsQ/640?wx_fmt=png&quot; data-type=&quot;png&quot; data-w=&quot;573&quot;/&gt;&lt;/figure&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;此时在极限网关上可以看到报错说 cluster01 集群不可用。&lt;/span&gt;&lt;/p&gt;&lt;pre data-tool=&quot;mdnice编辑器&quot;&gt;&lt;code&gt;&lt;span&gt;docker-compose logs -f infini-gateway&lt;br/&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;figure data-tool=&quot;mdnice编辑器&quot;&gt;&lt;img class=&quot;rich_pages wxw-img&quot; data-ratio=&quot;0.2145214521452145&quot; data-src=&quot;https://mmbiz.qpic.cn/mmbiz_png/mjl8GCpsL9auhKTS8YiaHLpE37Swaxib50T5tTwRPn4mHbmYwIlSlmxeRic23SHto3GICyOz1umPlXsxEYLMpiaswQ/640?wx_fmt=png&quot; data-type=&quot;png&quot; data-w=&quot;1515&quot;/&gt;&lt;/figure&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;接下来继续往 index-1 索引中插入 2 条数据。&lt;/span&gt;&lt;/p&gt;&lt;pre data-tool=&quot;mdnice编辑器&quot;&gt;&lt;code&gt;&lt;span&gt;&lt;span&gt;for&lt;/span&gt; i &lt;span&gt;in&lt;/span&gt; {6..7};&lt;span&gt;do&lt;/span&gt; &lt;br/&gt;curl -XPUT -u elastic:test123 -H &lt;span&gt;&quot;Content-Type: Application/json&quot;&lt;/span&gt; \&lt;br/&gt;http://11.8.36.25:8000/index-1/_doc/&lt;span&gt;$i&lt;/span&gt; \&lt;br/&gt;-d &lt;span&gt;&quot;{\&quot;name\&quot;:\&quot;tom_&lt;span&gt;$i&lt;/span&gt;\&quot;,\&quot;age\&quot;:\&quot;&lt;span&gt;$i&lt;/span&gt;\&quot;}&quot;&lt;/span&gt;;&lt;span&gt;done&lt;/span&gt;&lt;br/&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;查看集群 cluster02 发现新的 2 条数据插入成功。&lt;/span&gt;&lt;/p&gt;&lt;pre data-tool=&quot;mdnice编辑器&quot;&gt;&lt;code&gt;&lt;span&gt;&lt;span&gt;GET&lt;/span&gt; &lt;span&gt;index-1/_search&lt;/span&gt;&lt;br/&gt;&lt;br/&gt;&lt;span&gt;# 返回结果&lt;/span&gt;&lt;br/&gt;&lt;span&gt;{&lt;/span&gt;&lt;br/&gt;  &lt;span&gt;&quot;took&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;3&lt;/span&gt;&lt;span&gt;,&lt;/span&gt;&lt;br/&gt;  &lt;span&gt;&quot;timed_out&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;false&lt;/span&gt;&lt;span&gt;,&lt;/span&gt;&lt;br/&gt;  &lt;span&gt;&quot;_shards&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;{&lt;/span&gt;&lt;br/&gt;    &lt;span&gt;&quot;total&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;1&lt;/span&gt;&lt;span&gt;,&lt;/span&gt;&lt;br/&gt;    &lt;span&gt;&quot;successful&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;1&lt;/span&gt;&lt;span&gt;,&lt;/span&gt;&lt;br/&gt;    &lt;span&gt;&quot;skipped&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;0&lt;/span&gt;&lt;span&gt;,&lt;/span&gt;&lt;br/&gt;    &lt;span&gt;&quot;failed&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;0&lt;/span&gt;&lt;br/&gt;  &lt;span&gt;},&lt;/span&gt;&lt;br/&gt;  &lt;span&gt;&quot;hits&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;{&lt;/span&gt;&lt;br/&gt;    &lt;span&gt;&quot;total&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;{&lt;/span&gt;&lt;br/&gt;      &lt;span&gt;&quot;value&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;6&lt;/span&gt;&lt;span&gt;,&lt;/span&gt;&lt;br/&gt;      &lt;span&gt;&quot;relation&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;&quot;eq&quot;&lt;/span&gt;&lt;br/&gt;    &lt;span&gt;},&lt;/span&gt;&lt;br/&gt;    &lt;span&gt;&quot;max_score&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;1.0&lt;/span&gt;&lt;span&gt;,&lt;/span&gt;&lt;br/&gt;    &lt;span&gt;&quot;hits&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;[&lt;/span&gt;&lt;br/&gt;      &lt;span&gt;{&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;&quot;_index&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;&quot;index-1&quot;,&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;&quot;_type&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;&quot;_doc&quot;,&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;&quot;_id&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;&quot;4&quot;,&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;&quot;_score&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;1.0&lt;/span&gt;&lt;span&gt;,&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;&quot;_source&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;{&lt;/span&gt;&lt;br/&gt;          &lt;span&gt;&quot;name&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;&quot;tom_4&quot;,&lt;/span&gt;&lt;br/&gt;          &lt;span&gt;&quot;age&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;&quot;4&quot;&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;}&lt;/span&gt;&lt;br/&gt;      &lt;span&gt;},&lt;/span&gt;&lt;br/&gt;      &lt;span&gt;{&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;&quot;_index&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;&quot;index-1&quot;,&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;&quot;_type&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;&quot;_doc&quot;,&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;&quot;_id&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;&quot;5&quot;,&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;&quot;_score&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;1.0&lt;/span&gt;&lt;span&gt;,&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;&quot;_source&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;{&lt;/span&gt;&lt;br/&gt;          &lt;span&gt;&quot;name&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;&quot;tom_5&quot;,&lt;/span&gt;&lt;br/&gt;          &lt;span&gt;&quot;age&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;&quot;5&quot;&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;}&lt;/span&gt;&lt;br/&gt;      &lt;span&gt;},&lt;/span&gt;&lt;br/&gt;      &lt;span&gt;{&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;&quot;_index&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;&quot;index-1&quot;,&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;&quot;_type&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;&quot;_doc&quot;,&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;&quot;_id&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;&quot;2&quot;,&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;&quot;_score&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;1.0&lt;/span&gt;&lt;span&gt;,&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;&quot;_source&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;{&lt;/span&gt;&lt;br/&gt;          &lt;span&gt;&quot;name&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;&quot;jack_2&quot;,&lt;/span&gt;&lt;br/&gt;          &lt;span&gt;&quot;age&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;&quot;100&quot;&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;}&lt;/span&gt;&lt;br/&gt;      &lt;span&gt;},&lt;/span&gt;&lt;br/&gt;      &lt;span&gt;{&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;&quot;_index&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;&quot;index-1&quot;,&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;&quot;_type&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;&quot;_doc&quot;,&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;&quot;_id&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;&quot;3&quot;,&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;&quot;_score&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;1.0&lt;/span&gt;&lt;span&gt;,&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;&quot;_source&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;{&lt;/span&gt;&lt;br/&gt;          &lt;span&gt;&quot;name&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;&quot;tom_3&quot;,&lt;/span&gt;&lt;br/&gt;          &lt;span&gt;&quot;age&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;&quot;3&quot;&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;}&lt;/span&gt;&lt;br/&gt;      &lt;span&gt;},&lt;/span&gt;&lt;br/&gt;     &lt;span&gt;# 新插入的 2 条数据&lt;/span&gt;&lt;br/&gt;      &lt;span&gt;{&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;&quot;_index&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;&quot;index-1&quot;,&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;&quot;_type&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;&quot;_doc&quot;,&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;&quot;_id&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;&quot;6&quot;,&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;&quot;_score&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;1.0&lt;/span&gt;&lt;span&gt;,&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;&quot;_source&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;{&lt;/span&gt;&lt;br/&gt;          &lt;span&gt;&quot;name&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;&quot;tom_6&quot;,&lt;/span&gt;&lt;br/&gt;          &lt;span&gt;&quot;age&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;&quot;6&quot;&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;}&lt;/span&gt;&lt;br/&gt;      &lt;span&gt;},&lt;/span&gt;&lt;br/&gt;      &lt;span&gt;{&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;&quot;_index&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;&quot;index-1&quot;,&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;&quot;_type&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;&quot;_doc&quot;,&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;&quot;_id&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;&quot;7&quot;,&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;&quot;_score&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;1.0&lt;/span&gt;&lt;span&gt;,&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;&quot;_source&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;{&lt;/span&gt;&lt;br/&gt;          &lt;span&gt;&quot;name&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;&quot;tom_7&quot;,&lt;/span&gt;&lt;br/&gt;          &lt;span&gt;&quot;age&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;&quot;7&quot;&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;}&lt;/span&gt;&lt;br/&gt;      &lt;span&gt;}&lt;/span&gt;&lt;br/&gt;    &lt;span&gt;]&lt;/span&gt;&lt;br/&gt;  &lt;span&gt;}&lt;/span&gt;&lt;br/&gt;&lt;span&gt;}&lt;/span&gt;&lt;br/&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;访问极限网关的 API 接口查看本地队列状态，由于集群 cluster01 当前不可用，因此刚刚插入的 2 条消息保存在队列中，待集群 cluster01 恢复后再尝试消费。&lt;/span&gt;&lt;/p&gt;&lt;pre data-tool=&quot;mdnice编辑器&quot;&gt;&lt;code&gt;&lt;span&gt;&lt;span&gt;$&lt;/span&gt; &lt;span&gt;curl&lt;/span&gt; &lt;span&gt;http://11.8.36.25:2900/queue/stats&lt;/span&gt;&lt;br/&gt;&lt;br/&gt;&lt;span&gt;# 返回结果&lt;/span&gt;&lt;br/&gt;&lt;span&gt;{&lt;/span&gt;&lt;br/&gt;  &lt;span&gt;&quot;queue&quot;:&lt;/span&gt; &lt;span&gt;{&lt;/span&gt;&lt;br/&gt;    &lt;span&gt;&quot;disk&quot;:&lt;/span&gt; &lt;span&gt;{&lt;/span&gt;&lt;br/&gt;      &lt;span&gt;&quot;cluster01-queue&quot;:&lt;/span&gt; &lt;span&gt;{&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;&quot;depth&quot;:&lt;/span&gt; &lt;span&gt;2&lt;/span&gt;&lt;span&gt;,&lt;/span&gt; &lt;span&gt;# 未成功异步写入集群 cluster01 的 2 条消息&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;&quot;metadata&quot;:&lt;/span&gt; &lt;span&gt;{&lt;/span&gt;&lt;br/&gt;          &lt;span&gt;&quot;source&quot;:&lt;/span&gt; &lt;span&gt;&quot;dynamic&quot;,&lt;/span&gt;&lt;br/&gt;          &lt;span&gt;&quot;id&quot;:&lt;/span&gt; &lt;span&gt;&quot;c79eq49r8oo0golornmg&quot;,&lt;/span&gt;&lt;br/&gt;          &lt;span&gt;&quot;name&quot;:&lt;/span&gt; &lt;span&gt;&quot;cluster01-queue&quot;,&lt;/span&gt;&lt;br/&gt;          &lt;span&gt;&quot;label&quot;:&lt;/span&gt; &lt;span&gt;null&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;}&lt;/span&gt;&lt;br/&gt;      &lt;span&gt;},&lt;/span&gt;&lt;br/&gt;      &lt;span&gt;&quot;cluster02-queue&quot;:&lt;/span&gt; &lt;span&gt;{&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;&quot;depth&quot;:&lt;/span&gt; &lt;span&gt;0&lt;/span&gt;&lt;span&gt;,&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;&quot;metadata&quot;:&lt;/span&gt; &lt;span&gt;{&lt;/span&gt;&lt;br/&gt;          &lt;span&gt;&quot;source&quot;:&lt;/span&gt; &lt;span&gt;&quot;dynamic&quot;,&lt;/span&gt;&lt;br/&gt;          &lt;span&gt;&quot;id&quot;:&lt;/span&gt; &lt;span&gt;&quot;c79eq6pr8oo0golornt0&quot;,&lt;/span&gt;&lt;br/&gt;          &lt;span&gt;&quot;name&quot;:&lt;/span&gt; &lt;span&gt;&quot;cluster02-queue&quot;,&lt;/span&gt;&lt;br/&gt;          &lt;span&gt;&quot;label&quot;:&lt;/span&gt; &lt;span&gt;null&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;}&lt;/span&gt;&lt;br/&gt;      &lt;span&gt;},&lt;/span&gt;&lt;br/&gt;      &lt;span&gt;&quot;cluster_state_change&quot;:&lt;/span&gt; &lt;span&gt;{&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;&quot;depth&quot;:&lt;/span&gt; &lt;span&gt;10&lt;/span&gt;&lt;span&gt;,&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;&quot;metadata&quot;:&lt;/span&gt; &lt;span&gt;{&lt;/span&gt;&lt;br/&gt;          &lt;span&gt;&quot;source&quot;:&lt;/span&gt; &lt;span&gt;&quot;dynamic&quot;,&lt;/span&gt;&lt;br/&gt;          &lt;span&gt;&quot;id&quot;:&lt;/span&gt; &lt;span&gt;&quot;c79eq6pr8oo0golorns0&quot;,&lt;/span&gt;&lt;br/&gt;          &lt;span&gt;&quot;name&quot;:&lt;/span&gt; &lt;span&gt;&quot;cluster_state_change&quot;,&lt;/span&gt;&lt;br/&gt;          &lt;span&gt;&quot;label&quot;:&lt;/span&gt; &lt;span&gt;null&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;}&lt;/span&gt;&lt;br/&gt;      &lt;span&gt;}&lt;/span&gt;&lt;br/&gt;    &lt;span&gt;}&lt;/span&gt;&lt;br/&gt;  &lt;span&gt;}&lt;/span&gt;&lt;br/&gt;&lt;span&gt;}&lt;/span&gt;&lt;br/&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;恢复 es01。&lt;/span&gt;&lt;/p&gt;&lt;pre data-tool=&quot;mdnice编辑器&quot;&gt;&lt;code&gt;&lt;span&gt;&lt;span&gt;docker-compose&lt;/span&gt; &lt;span&gt;start&lt;/span&gt; &lt;span&gt;es01&lt;/span&gt;&lt;br/&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;查看网关日志可以看到集群 cluster01 恢复的信息。&lt;/span&gt;&lt;/p&gt;&lt;pre data-tool=&quot;mdnice编辑器&quot;&gt;&lt;code&gt;&lt;span&gt;docker-compose logs -f infini-gateway&lt;br/&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;figure data-tool=&quot;mdnice编辑器&quot;&gt;&lt;img class=&quot;rich_pages wxw-img&quot; data-ratio=&quot;0.13364993215739485&quot; data-src=&quot;https://mmbiz.qpic.cn/mmbiz_png/mjl8GCpsL9auhKTS8YiaHLpE37Swaxib50QhU6CQEH8tTrulS39m8bCQHGj0RFFN3wic0FW5bnYbrF1E4rbDqE5xg/640?wx_fmt=png&quot; data-type=&quot;png&quot; data-w=&quot;1474&quot;/&gt;&lt;/figure&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;查询集群 cluster01 的数据，可以在 es01 停止期间的数据已经成功写入。&lt;/span&gt;&lt;/p&gt;&lt;pre data-tool=&quot;mdnice编辑器&quot;&gt;&lt;code&gt;&lt;span&gt;&lt;span&gt;GET&lt;/span&gt; &lt;span&gt;index-1/_search&lt;/span&gt;&lt;br/&gt;&lt;br/&gt;&lt;span&gt;# 返回结果&lt;/span&gt;&lt;br/&gt;&lt;span&gt;{&lt;/span&gt;&lt;br/&gt;  &lt;span&gt;&quot;took&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;3&lt;/span&gt;&lt;span&gt;,&lt;/span&gt;&lt;br/&gt;  &lt;span&gt;&quot;timed_out&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;false&lt;/span&gt;&lt;span&gt;,&lt;/span&gt;&lt;br/&gt;  &lt;span&gt;&quot;_shards&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;{&lt;/span&gt;&lt;br/&gt;    &lt;span&gt;&quot;total&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;1&lt;/span&gt;&lt;span&gt;,&lt;/span&gt;&lt;br/&gt;    &lt;span&gt;&quot;successful&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;1&lt;/span&gt;&lt;span&gt;,&lt;/span&gt;&lt;br/&gt;    &lt;span&gt;&quot;skipped&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;0&lt;/span&gt;&lt;span&gt;,&lt;/span&gt;&lt;br/&gt;    &lt;span&gt;&quot;failed&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;0&lt;/span&gt;&lt;br/&gt;  &lt;span&gt;},&lt;/span&gt;&lt;br/&gt;  &lt;span&gt;&quot;hits&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;{&lt;/span&gt;&lt;br/&gt;    &lt;span&gt;&quot;total&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;{&lt;/span&gt;&lt;br/&gt;      &lt;span&gt;&quot;value&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;6&lt;/span&gt;&lt;span&gt;,&lt;/span&gt;&lt;br/&gt;      &lt;span&gt;&quot;relation&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;&quot;eq&quot;&lt;/span&gt;&lt;br/&gt;    &lt;span&gt;},&lt;/span&gt;&lt;br/&gt;    &lt;span&gt;&quot;max_score&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;1.0&lt;/span&gt;&lt;span&gt;,&lt;/span&gt;&lt;br/&gt;    &lt;span&gt;&quot;hits&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;[&lt;/span&gt;&lt;br/&gt;      &lt;span&gt;{&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;&quot;_index&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;&quot;index-1&quot;,&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;&quot;_type&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;&quot;_doc&quot;,&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;&quot;_id&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;&quot;3&quot;,&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;&quot;_score&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;1.0&lt;/span&gt;&lt;span&gt;,&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;&quot;_source&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;{&lt;/span&gt;&lt;br/&gt;          &lt;span&gt;&quot;name&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;&quot;tom_3&quot;,&lt;/span&gt;&lt;br/&gt;          &lt;span&gt;&quot;age&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;&quot;3&quot;&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;}&lt;/span&gt;&lt;br/&gt;      &lt;span&gt;},&lt;/span&gt;&lt;br/&gt;      &lt;span&gt;{&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;&quot;_index&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;&quot;index-1&quot;,&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;&quot;_type&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;&quot;_doc&quot;,&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;&quot;_id&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;&quot;2&quot;,&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;&quot;_score&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;1.0&lt;/span&gt;&lt;span&gt;,&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;&quot;_source&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;{&lt;/span&gt;&lt;br/&gt;          &lt;span&gt;&quot;name&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;&quot;jack_2&quot;,&lt;/span&gt;&lt;br/&gt;          &lt;span&gt;&quot;age&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;&quot;100&quot;&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;}&lt;/span&gt;&lt;br/&gt;      &lt;span&gt;},&lt;/span&gt;&lt;br/&gt;      &lt;span&gt;{&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;&quot;_index&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;&quot;index-1&quot;,&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;&quot;_type&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;&quot;_doc&quot;,&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;&quot;_id&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;&quot;4&quot;,&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;&quot;_score&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;1.0&lt;/span&gt;&lt;span&gt;,&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;&quot;_source&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;{&lt;/span&gt;&lt;br/&gt;          &lt;span&gt;&quot;name&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;&quot;tom_4&quot;,&lt;/span&gt;&lt;br/&gt;          &lt;span&gt;&quot;age&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;&quot;4&quot;&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;}&lt;/span&gt;&lt;br/&gt;      &lt;span&gt;},&lt;/span&gt;&lt;br/&gt;      &lt;span&gt;{&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;&quot;_index&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;&quot;index-1&quot;,&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;&quot;_type&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;&quot;_doc&quot;,&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;&quot;_id&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;&quot;5&quot;,&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;&quot;_score&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;1.0&lt;/span&gt;&lt;span&gt;,&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;&quot;_source&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;{&lt;/span&gt;&lt;br/&gt;          &lt;span&gt;&quot;name&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;&quot;tom_5&quot;,&lt;/span&gt;&lt;br/&gt;          &lt;span&gt;&quot;age&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;&quot;5&quot;&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;}&lt;/span&gt;&lt;br/&gt;      &lt;span&gt;},&lt;/span&gt;&lt;br/&gt;      &lt;span&gt;# 新插入的 2 条数据&lt;/span&gt;&lt;br/&gt;      &lt;span&gt;{&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;&quot;_index&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;&quot;index-1&quot;,&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;&quot;_type&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;&quot;_doc&quot;,&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;&quot;_id&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;&quot;6&quot;,&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;&quot;_score&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;1.0&lt;/span&gt;&lt;span&gt;,&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;&quot;_source&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;{&lt;/span&gt;&lt;br/&gt;          &lt;span&gt;&quot;name&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;&quot;tom_6&quot;,&lt;/span&gt;&lt;br/&gt;          &lt;span&gt;&quot;age&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;&quot;6&quot;&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;}&lt;/span&gt;&lt;br/&gt;      &lt;span&gt;},&lt;/span&gt;&lt;br/&gt;      &lt;span&gt;{&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;&quot;_index&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;&quot;index-1&quot;,&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;&quot;_type&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;&quot;_doc&quot;,&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;&quot;_id&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;&quot;7&quot;,&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;&quot;_score&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;1.0&lt;/span&gt;&lt;span&gt;,&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;&quot;_source&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;{&lt;/span&gt;&lt;br/&gt;          &lt;span&gt;&quot;name&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;&quot;tom_7&quot;,&lt;/span&gt;&lt;br/&gt;          &lt;span&gt;&quot;age&quot;&lt;/span&gt; &lt;span&gt;:&lt;/span&gt; &lt;span&gt;&quot;7&quot;&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;}&lt;/span&gt;&lt;br/&gt;      &lt;span&gt;}&lt;/span&gt;&lt;br/&gt;    &lt;span&gt;]&lt;/span&gt;&lt;br/&gt;  &lt;span&gt;}&lt;/span&gt;&lt;br/&gt;&lt;span&gt;}&lt;/span&gt;&lt;br/&gt;&lt;br/&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;此时查看队列状态，&lt;/span&gt;&lt;code&gt;&lt;span&gt;cluster01-queue&lt;/span&gt;&lt;/code&gt;&lt;span&gt;  中的消息已经消费完毕。&lt;/span&gt;&lt;/p&gt;&lt;pre data-tool=&quot;mdnice编辑器&quot;&gt;&lt;code&gt;&lt;span&gt;&lt;span&gt;$&lt;/span&gt; &lt;span&gt;curl&lt;/span&gt; &lt;span&gt;http://11.8.36.25:2900/queue/stats&lt;/span&gt;&lt;br/&gt;&lt;br/&gt;&lt;span&gt;# 返回结果&lt;/span&gt;&lt;br/&gt;&lt;span&gt;{&lt;/span&gt;&lt;br/&gt;  &lt;span&gt;&quot;queue&quot;:&lt;/span&gt; &lt;span&gt;{&lt;/span&gt;&lt;br/&gt;    &lt;span&gt;&quot;disk&quot;:&lt;/span&gt; &lt;span&gt;{&lt;/span&gt;&lt;br/&gt;      &lt;span&gt;&quot;cluster01-queue&quot;:&lt;/span&gt; &lt;span&gt;{&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;&quot;depth&quot;:&lt;/span&gt; &lt;span&gt;0&lt;/span&gt;&lt;span&gt;,&lt;/span&gt; &lt;span&gt;# 消费完毕&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;&quot;metadata&quot;:&lt;/span&gt; &lt;span&gt;{&lt;/span&gt;&lt;br/&gt;          &lt;span&gt;&quot;source&quot;:&lt;/span&gt; &lt;span&gt;&quot;dynamic&quot;,&lt;/span&gt;&lt;br/&gt;          &lt;span&gt;&quot;id&quot;:&lt;/span&gt; &lt;span&gt;&quot;c79eq49r8oo0golornmg&quot;,&lt;/span&gt;&lt;br/&gt;          &lt;span&gt;&quot;name&quot;:&lt;/span&gt; &lt;span&gt;&quot;cluster01-queue&quot;,&lt;/span&gt;&lt;br/&gt;          &lt;span&gt;&quot;label&quot;:&lt;/span&gt; &lt;span&gt;null&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;}&lt;/span&gt;&lt;br/&gt;      &lt;span&gt;},&lt;/span&gt;&lt;br/&gt;      &lt;span&gt;&quot;cluster02-queue&quot;:&lt;/span&gt; &lt;span&gt;{&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;&quot;depth&quot;:&lt;/span&gt; &lt;span&gt;0&lt;/span&gt;&lt;span&gt;,&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;&quot;metadata&quot;:&lt;/span&gt; &lt;span&gt;{&lt;/span&gt;&lt;br/&gt;          &lt;span&gt;&quot;source&quot;:&lt;/span&gt; &lt;span&gt;&quot;dynamic&quot;,&lt;/span&gt;&lt;br/&gt;          &lt;span&gt;&quot;id&quot;:&lt;/span&gt; &lt;span&gt;&quot;c79eq6pr8oo0golornt0&quot;,&lt;/span&gt;&lt;br/&gt;          &lt;span&gt;&quot;name&quot;:&lt;/span&gt; &lt;span&gt;&quot;cluster02-queue&quot;,&lt;/span&gt;&lt;br/&gt;          &lt;span&gt;&quot;label&quot;:&lt;/span&gt; &lt;span&gt;null&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;}&lt;/span&gt;&lt;br/&gt;      &lt;span&gt;},&lt;/span&gt;&lt;br/&gt;      &lt;span&gt;&quot;cluster_state_change&quot;:&lt;/span&gt; &lt;span&gt;{&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;&quot;depth&quot;:&lt;/span&gt; &lt;span&gt;12&lt;/span&gt;&lt;span&gt;,&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;&quot;metadata&quot;:&lt;/span&gt; &lt;span&gt;{&lt;/span&gt;&lt;br/&gt;          &lt;span&gt;&quot;source&quot;:&lt;/span&gt; &lt;span&gt;&quot;dynamic&quot;,&lt;/span&gt;&lt;br/&gt;          &lt;span&gt;&quot;id&quot;:&lt;/span&gt; &lt;span&gt;&quot;c79eq6pr8oo0golorns0&quot;,&lt;/span&gt;&lt;br/&gt;          &lt;span&gt;&quot;name&quot;:&lt;/span&gt; &lt;span&gt;&quot;cluster_state_change&quot;,&lt;/span&gt;&lt;br/&gt;          &lt;span&gt;&quot;label&quot;:&lt;/span&gt; &lt;span&gt;null&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;}&lt;/span&gt;&lt;br/&gt;      &lt;span&gt;}&lt;/span&gt;&lt;br/&gt;    &lt;span&gt;}&lt;/span&gt;&lt;br/&gt;  &lt;span&gt;}&lt;/span&gt;&lt;br/&gt;&lt;span&gt;}&lt;/span&gt;&lt;br/&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;h4 data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;9.5.4 清理现场&lt;/span&gt;&lt;/h4&gt;&lt;pre data-tool=&quot;mdnice编辑器&quot;&gt;&lt;code&gt;&lt;span&gt;&lt;span&gt;cd&lt;/span&gt; infini-gateway&lt;br/&gt;&lt;span&gt;# -v 参数表示删除 volume&lt;/span&gt;&lt;br/&gt;docker-compose down -v &lt;br/&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;h2 data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;10 总结&lt;/span&gt;&lt;/h2&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;本文分析对比了定期快照，跨机房部署集群，应用双写，借助消息队列实现双写，CCR 跨集群复制，极限网关&lt;/span&gt;&lt;span&gt; 6 种&lt;/span&gt;&lt;span&gt; Elasticsearch 跨机房灾备的方案。同时准备了 Demo 案例方便大家动手体验，希望本文对你有所帮助。&lt;/span&gt;&lt;/p&gt;&lt;h2 data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;11 作者介绍&lt;/span&gt;&lt;/h2&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;&lt;strong&gt;作者：Se7en&lt;/strong&gt;，熟悉 Elastic 和云原生相关技术栈，Elastic 认证工程师，CKA，CKS 认证工程师。&lt;/span&gt;&lt;/p&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;审稿人：铭毅天下，Elastic 认证工程师，Elastic中国合作培训讲师，阿里云MVP，Elastic 相关博文全网累计阅读量 1000万+（含转载）。&lt;/span&gt;&lt;/p&gt;&lt;h2 data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;12 参考资料&lt;/span&gt;&lt;/h2&gt;&lt;ul data-tool=&quot;mdnice编辑器&quot; class=&quot;list-paddingleft-2&quot;&gt;&lt;li&gt;&lt;p&gt;&lt;span&gt;Cross-cluster replication(https://www.elastic.co/guide/en/elasticsearch/reference/current/xpack-ccr.html)&lt;/span&gt;&lt;/p&gt;&lt;/li&gt;&lt;li&gt;&lt;p&gt;&lt;span&gt;Bi-directional replication with Elasticsearch cross-cluster replication (CCR)(https://www.elastic.co/cn/blog/bi-directional-replication-with-elasticsearch-cross-cluster-replication-ccr)&lt;/span&gt;&lt;/p&gt;&lt;/li&gt;&lt;li&gt;&lt;p&gt;&lt;span&gt; 追随领导者：Elasticsearch 中的跨集群复制简介(https://www.elastic.co/cn/blog/follow-the-leader-an-introduction-to-cross-cluster-replication-in-elasticsearch)&lt;/span&gt;&lt;/p&gt;&lt;/li&gt;&lt;li&gt;&lt;p&gt;&lt;span&gt; Elasticsearch 主从同步之跨集群复制(https://mp.weixin.qq.com/s/alHHxXont6XFm_m9PfsGfw)&lt;/span&gt;&lt;/p&gt;&lt;/li&gt;&lt;li&gt;&lt;p&gt;&lt;span&gt; 使用 Elasticsearch 跨集群复制进行跨数据中心复制(https://www.elastic.co/cn/blog/cross-datacenter-replication-with-elasticsearch-cross-cluster-replication)&lt;/span&gt;&lt;/p&gt;&lt;/li&gt;&lt;li&gt;&lt;p&gt;&lt;span&gt;ES异地双活方案(https://www.cnblogs.com/yjmyzz/p/14586637.html)&lt;/span&gt;&lt;/p&gt;&lt;/li&gt;&lt;li&gt;&lt;p&gt;&lt;span&gt;Elasticsearch数据迁移与集群容灾(https://www.jianshu.com/p/ea8922ce7d29)&lt;/span&gt;&lt;/p&gt;&lt;/li&gt;&lt;li&gt;&lt;p&gt;&lt;span&gt;Elasticsearch 数据迁移与容灾实践，看这一篇就够了！(https://mp.weixin.qq.com/s?__biz=MzA4Nzg5Nzc5OA==&amp;amp;mid=2651700132&amp;amp;idx=1&amp;amp;sn=45f83e481f45ee5020153ca2953d2cc3)&lt;/span&gt;&lt;/p&gt;&lt;/li&gt;&lt;li&gt;&lt;p&gt;&lt;span&gt;日均 5 亿查询量的京东订单中心，为什么舍 MySQL 用 ES?(https://www.infoq.cn/article/YhlbWcJ3WQw2vE5mhfD1?utm_source=related_read_bottom&amp;amp;utm_medium=article)&lt;/span&gt;&lt;/p&gt;&lt;/li&gt;&lt;li&gt;&lt;p&gt;&lt;span&gt;Running the Elastic Stack on Docker(https://www.elastic.co/guide/en/elastic-stack-get-started/current/get-started-docker.html)&lt;/span&gt;&lt;/p&gt;&lt;/li&gt;&lt;li&gt;&lt;p&gt;&lt;span&gt;ES容灾技术探讨和测试(https://mp.weixin.qq.com/s/oypIQJZwmxoUnLzPPs2DwA)&lt;/span&gt;&lt;/p&gt;&lt;/li&gt;&lt;li&gt;&lt;p&gt;&lt;span&gt;使用极限网关来实现 Elasticsearch 多写(https://mp.weixin.qq.com/s/sI5CN3jgx4gvS0eUCFU6kg)&lt;/span&gt;&lt;/p&gt;&lt;/li&gt;&lt;li&gt;&lt;p&gt;&lt;span&gt;Elasticsearch异地容灾方案(https://www.bilibili.com/video/BV1qQ4y1v7YH/)&lt;/span&gt;&lt;/p&gt;&lt;/li&gt;&lt;li&gt;&lt;p&gt;&lt;span&gt;Control startup and shutdown order in Compose(https://docs.docker.com/compose/startup-order/)&lt;/span&gt;&lt;/p&gt;&lt;/li&gt;&lt;li&gt;&lt;p&gt;&lt;span&gt;Dead letter queues (DLQ)(https://www.elastic.co/guide/en/logstash/current/dead-letter-queues.html)&lt;/span&gt;&lt;/p&gt;&lt;/li&gt;&lt;li&gt;&lt;p&gt;&lt;span&gt;Elasticsearch output plugin(https://www.elastic.co/guide/en/logstash/current/plugins-outputs-elasticsearch.html)&lt;/span&gt;&lt;/p&gt;&lt;/li&gt;&lt;li&gt;&lt;p&gt;&lt;span&gt;High Availability in Elasticsearch – Cross Cluster Replication and Alternatives(https://opster.com/blogs/elasticsearch-cross-cluster-replication-overview/)&lt;/span&gt;&lt;/p&gt;&lt;/li&gt;&lt;li&gt;&lt;p&gt;&lt;span&gt;Elasticsearch数据迁移与集群容灾(https://cloud.tencent.com/developer/article/1529651)&lt;/span&gt;&lt;/p&gt;&lt;/li&gt;&lt;li&gt;&lt;p&gt;&lt;span&gt;Elasticsearch 跨机房灾备建设(https://zhuanlan.zhihu.com/p/53007240)&lt;/span&gt;&lt;/p&gt;&lt;/li&gt;&lt;li&gt;&lt;p&gt;&lt;span&gt;腾讯云 Elasticsearch 集群多可用区容灾实现原理及最佳实践(https://www.infoq.cn/article/x5z9il06a21gv7vy8bee)&lt;/span&gt;&lt;/p&gt;&lt;/li&gt;&lt;li&gt;&lt;p&gt;&lt;span&gt;Clustering Across Multiple Data Centers(https://www.elastic.co/cn/blog/clustering_across_multiple_data_centers)&lt;/span&gt;&lt;/p&gt;&lt;/li&gt;&lt;li&gt;&lt;p&gt;&lt;span&gt;Snapshot and restore(https://www.elastic.co/guide/en/elasticsearch/reference/current/snapshot-restore.html)&lt;/span&gt;&lt;/p&gt;&lt;/li&gt;&lt;li&gt;&lt;p&gt;&lt;span&gt;Elasticsearch snapshot 备份的使用方法(https://segmentfault.com/a/1190000015125088)&lt;/span&gt;&lt;/p&gt;&lt;/li&gt;&lt;li&gt;&lt;p&gt;&lt;span&gt;Elasticsearch可搜索快照技术原理及最佳实践(https://cloud.tencent.com/developer/article/1907148)&lt;/span&gt;&lt;/p&gt;&lt;/li&gt;&lt;li&gt;&lt;p&gt;&lt;span&gt;极限网关 浮动 IP(https://xn--d6q905cs0q16u.com/v1.5.0/docs/references/modules/floating_ip/)&lt;/span&gt;&lt;/p&gt;&lt;/li&gt;&lt;/ul&gt;&lt;/section&gt;&lt;/div&gt;&lt;/div&gt;</content:encoded>
</item>
<item>
<guid>feb48e6fe9f6641582ec270326b39eab</guid>
<title>线上FGC调优案例三则</title>
<link>https://toutiao.io/k/n1oq782</link>
<content:encoded>&lt;div&gt;&lt;div&gt;&lt;div class=&quot;rich_media_content &quot; id=&quot;js_content&quot;&gt;
                    

                    
                    
                    
                    &lt;h2 data-mpa-powered-by=&quot;yiban.io&quot;&gt;&lt;span&gt;&lt;strong&gt;前言&lt;/strong&gt;&lt;/span&gt;&lt;/h2&gt;&lt;p&gt;&lt;span&gt;闲鱼服务端应用广泛使用 Java 技术栈，基于JVM提供的托管式堆内存管理，开发者无需过多关心对象创建/回收时的内存分配/释放动作，垃圾回收器（Garbage Collector）会在需要的时候自动清理堆内不再使用的对象，保证有可用空间用于新对象分配。&lt;br/&gt;开发者在享受到自动内存管理的便利时，也不可避免的需要承担垃圾回收器在进行死亡对象清理时的一些开销，例如机器资源利用率上升，应用线程被短暂暂停等。根据JVM使用的垃圾回收算法的不同以及回收的堆区域的不同，GC过程中用户线程的暂停时间、完成一次GC的耗时、也有所不同。&lt;br/&gt;其中，全堆内存清理（Full GC，下称FGC）会扫描整个堆空间，清理掉所有死亡对象，而FGC是Stop the world（下文简称STW）的，也就是意味着会暂停全部的用户线程直到GC结束。一趟FGC的停顿时长视堆空间大小和存活对象数量多少而定，通常从几秒到几十秒不等。在这期间，应用无法对外提供任何服务，表现为接口超时，成功率下降，上游依赖线程池打满等，十分影响用户体验，甚至可能出现访问压力转移到其他健康机器上，使得健康机器对象分配压力增大，最终产生FGC而导致集群雪崩。&lt;br/&gt;对于前台业务应用而言，正常承接业务流量的过程中产生的对象大部分都为朝生夕灭的对象，理论绝大部分对象上应该能通过新生代GC（YGC）被清理掉；而大部分GC算法，都是在老年代占用空间超过一定阈值时，才会触发FGC。因此，一旦出现了FGC，通常意味着这个应用的对象分配或垃圾回收相关的JVM参数存在问题，是业务运行时的重大隐患，需要尽快排查并根治。&lt;br/&gt;本文通过三则前台应用FGC调优案例，分别介绍了由于JVM参数、中间件配置、业务代码层面引起的FGC的现象、分析过程及对应解法。希望能起到抛砖引玉的作用，以及给有同样疑惑的读者朋友们带来一些启发。&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;&lt;br/&gt;&lt;/span&gt;&lt;/p&gt;&lt;h2&gt;&lt;span&gt;&lt;strong&gt;商品域核心应用发布及运行时FGC&lt;/strong&gt;&lt;/span&gt;&lt;/h2&gt;&lt;h2/&gt;&lt;h2&gt;&lt;span&gt;现象&lt;/span&gt;&lt;/h2&gt;&lt;p&gt;&lt;span&gt;闲鱼商品域某核心应用，在正常承接业务流量时，集群不时有少量FGC出现，引起接口RT毛刺及成功率略微下跌。在应用发布过程中，集群FGC次数明显上升，接口抖动明显，且大部分FGC出现在未在发布批次的机器上。&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;此应用承接了对闲鱼商品增删改查操作的绝大部分流量。集群运行时的FGC不仅会影响用户体验，成为以后业务发展过程中的重大隐患，而且发布时的抖动会使得代码万一出问题时没办法快速回退到上一个版本，是安全生产的重大风险，需要尽快解决。&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;/p&gt;&lt;h2&gt;&lt;span&gt;分析&lt;/span&gt;&lt;/h2&gt;&lt;p&gt;&lt;span&gt;选择一台发生了FGC的机器，查看其JVM信息监控，如下图所示：&lt;br/&gt;&lt;/span&gt;&lt;img class=&quot;rich_pages wxw-img&quot; data-backh=&quot;346&quot; data-backw=&quot;578&quot; data-ratio=&quot;0.5991379310344828&quot; data-src=&quot;https://mmbiz.qpic.cn/mmbiz_png/DUwiayJ0Mj1HVybZicDayOdK1MmyK6wJWoXwlvVqDyRDxCVFQFUKs10n24c5gvhoBa7HKZMYRFgJZmDOmTQdWzDA/640?wx_fmt=png&quot; data-type=&quot;png&quot; data-w=&quot;1856&quot;/&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;图中不难得出大量有用的信息：&lt;/span&gt;&lt;/p&gt;&lt;ol class=&quot;list-paddingleft-2&quot;&gt;&lt;li&gt;&lt;p&gt;&lt;span&gt;应用采用 ParNew + CMS组合。&lt;/span&gt;&lt;/p&gt;&lt;/li&gt;&lt;/ol&gt;&lt;ol start=&quot;2&quot; class=&quot;list-paddingleft-2&quot;&gt;&lt;li&gt;&lt;p&gt;&lt;span&gt;老年代到达1.7G左右占用时，触发CMS Old Gen GC。【1.7G可能是一个固定的Old Gen回收阈值】&lt;/span&gt;&lt;/p&gt;&lt;/li&gt;&lt;/ol&gt;&lt;ol start=&quot;3&quot; class=&quot;list-paddingleft-2&quot;&gt;&lt;li&gt;&lt;p&gt;&lt;span&gt;老年代占用会随着时间的推移缓慢升高，逐渐触顶。【Survivor空间可能不够用】&lt;/span&gt;&lt;/p&gt;&lt;/li&gt;&lt;li&gt;&lt;p&gt;&lt;span&gt;Old Gen GC 一次回收大约200MB，水位回落到 1.5G，单次回收收益不明显。【老年代存在不少固定占用的大对象】&lt;/span&gt;&lt;/p&gt;&lt;/li&gt;&lt;/ol&gt;&lt;ol start=&quot;4&quot; class=&quot;list-paddingleft-2&quot;/&gt;&lt;p&gt;&lt;span&gt;从监控上看，这是一种非常明显的因为担保分配，使得一些最终会死亡的对象进入到老年代，老年代触到CMS回收阈值产生CMS Old Gen GC的表象。但是在没有充分的证据之前，并不能盲目的下结论，还需要继续小心谨慎地求证上述假设，从而根据深层次的原因制定能根治FGC现象的解决方案。&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;针对假设1和2，查看应用JVM参数配置：&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;&lt;img class=&quot;rich_pages wxw-img&quot; data-backh=&quot;267&quot; data-backw=&quot;578&quot; data-ratio=&quot;0.46136363636363636&quot; data-src=&quot;https://mmbiz.qpic.cn/mmbiz_png/DUwiayJ0Mj1HVybZicDayOdK1MmyK6wJWo2NCb7KGxtmUyhGkw8cSvtLJBjED0iaDaL8lcvAVkCRiaxNNbcDCZiavFQ/640?wx_fmt=png&quot; data-type=&quot;png&quot; data-w=&quot;880&quot;/&gt;&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;可以看到，应用确实是使用CMS作为垃圾回收器，堆大小被配置为4G，Young区2G，Old区2G，CMSInitiatingOccupancyFraction参数被配置为80%，这意味着老年代占用超过80%时触发CMS Old Gen回收，2G*0.8 = 1.6G，差不多就是监控中体现的1.7G左右开始回收，然后老年代占用回落。&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;另外还可以顺便得到：SurvivorRatio=10，单个Survivor区 2048 * /(10+1+1) = 174762K左右这一结论，能够为接下来的分析提供帮助。&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;对于假设3，监控系统上以分钟为粒度聚合的折线图就不太能满足需求了，需要通过GC日志，对机器每次GC回收结束后，各个区域的堆空间占用进行分析，看是否存在一次YGC结束后，Survivor区占用较高的情况。一段非常有代表性的GC日志如下图所示：&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;&lt;img class=&quot;rich_pages wxw-img&quot; data-ratio=&quot;0.07395833333333333&quot; data-src=&quot;https://mmbiz.qpic.cn/mmbiz_png/DUwiayJ0Mj1HVybZicDayOdK1MmyK6wJWo1F1wS4eeMswIwx6L0sSica7yicGRwWZldicoCwo2icajrSGz7qIje8RygQ/640?wx_fmt=png&quot; data-type=&quot;png&quot; data-w=&quot;960&quot;/&gt;&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;注意到ParNew是STW的算法，不存在回收过程中对象分配的可能。而一次ParNew回收前后的堆空间变化可以用下图来表示：&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;img class=&quot;rich_pages wxw-img&quot; data-ratio=&quot;0.225&quot; data-src=&quot;https://mmbiz.qpic.cn/mmbiz_png/DUwiayJ0Mj1HVybZicDayOdK1MmyK6wJWo55s186rnslWB0u4ibRsZn03gtdmqBAczDpjIGQvGdJAiaP8H4xemMoRQ/640?wx_fmt=png&quot; data-type=&quot;png&quot; data-w=&quot;440&quot;/&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;计算GC日志中各个区域的存活对象占用空间变化：&lt;br/&gt;第一次回收: Young区 40225K存活，全堆1697070K存活，Old区1697070-40225=1656845K&lt;br/&gt;第二次回收: Young区174720K存活，全堆1859440K存活，Old区1859440-174720=1684720K&lt;br/&gt;Old区占用上涨约27875K&lt;br/&gt;而先前通过JVM参数，可以知道单个Survivor区大小约为174762K，第二次回收极有可能出现了担保分配。Survivor区可能在某些回收中，显得不够用。&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;对于假设4，可以随机找一台线上机器，将流量切走后执行带FGC的Heap dump，目的是拿到FGC过后的堆对象集合。查看支配树，如下图所示：&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;&lt;img class=&quot;rich_pages wxw-img&quot; data-ratio=&quot;0.12770339855818744&quot; data-src=&quot;https://mmbiz.qpic.cn/mmbiz_png/DUwiayJ0Mj1HVybZicDayOdK1MmyK6wJWosxrjfDB8AlWjbKy74E5ENSWHa8icYHcUJP3uUOIZrrJyYC0iaa959iaHg/640?wx_fmt=png&quot; data-type=&quot;png&quot; data-w=&quot;1942&quot;/&gt;&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;可以看到排前4的对象已经占用了老年代约 687MB的空间，整体约1.3G的对象常驻老年代空间。且这4个对象对于业务而言都是十分重要的对象，初步来看并没有太大的优化空间。&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;分析到这里，该应用FGC的根因就呼之欲出了。&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;&lt;br/&gt;&lt;/span&gt;&lt;/p&gt;&lt;h3&gt;&lt;span&gt;根因&lt;/span&gt;&lt;/h3&gt;&lt;p&gt;&lt;span&gt;偶现Survivor不够用的担保分配(可能还有晋升) -&amp;gt; Old Gen占用上涨 -&amp;gt; Old Gen 距离回收阈值仅有约200M的余量 -&amp;gt; 频繁 CMS Old Gen GC。&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;在应用发布过程中，又因为正在启动的应用，RPC、HTTP服务等没有上线，或者是处于小流量预热阶段，整个集群的流量就会倾斜到不在发布流程中的机器，使得每台机器需要承受的QPS升高，对象分配压力增大，YGC次数增多，通过担保分配晋升老年代的速率加快，导致老年代更快的触顶，出现频繁&lt;/span&gt;FGC。&lt;/p&gt;&lt;p&gt;&lt;/p&gt;&lt;h3&gt;&lt;span&gt;解法&lt;/span&gt;&lt;/h3&gt;&lt;p&gt;&lt;span&gt;虽然该应用的FGC成因并不难分析，但是为其制定一个能根治FGC的解法却还是需要一些考量。&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;商品业务经过长时间的发展，该应用代码量非常大，业务逻辑错综复杂，且依赖了大量中间件、二方服务，很难去搞清楚这些业务对象的存活周期。要想解决这个应用的FGC现象，最好的办法就是：&lt;strong&gt;在不触发FGC的前提下清理掉担保到Old Gen的Young区存活对象。&lt;/strong&gt;&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;该应用之前使用CMS回收器，但是通过后续分析发现，很难在CMS上达成上述目标。主要是因为存在以下几点困难：&lt;/span&gt;&lt;/p&gt;&lt;ol class=&quot;list-paddingleft-2&quot;&gt;&lt;li&gt;&lt;p&gt;&lt;span&gt;Survivor 存在不够用现象。然而业务复杂，很难给出一个一定够用的数字。盲目调大，挤占了Young区的空间，导致YGC频繁，可能存在&lt;strong&gt;吞吐下降，RT升高&lt;/strong&gt;的风险。&lt;/span&gt;&lt;/p&gt;&lt;/li&gt;&lt;/ol&gt;&lt;ol start=&quot;2&quot; class=&quot;list-paddingleft-2&quot;&gt;&lt;li&gt;&lt;p&gt;&lt;span&gt;Old Gen 常驻大对象多？考虑大对象治理。依赖的服务未必有治理方案、升级回归存在成本。&lt;/span&gt;&lt;/p&gt;&lt;/li&gt;&lt;/ol&gt;&lt;ol start=&quot;3&quot; class=&quot;list-paddingleft-2&quot;&gt;&lt;li&gt;&lt;p&gt;&lt;span&gt;Old Gen固定阈值产生CMS Old Gen GC？&lt;br/&gt;调高阈值？有担保分配失败，回退到全堆STW FGC的风险。&lt;br/&gt;调大Old Gen？全堆大小不变的话挤占Young区，风险同1。&lt;br/&gt;增大全堆大小？应用容器内存吃紧，有容器OOM进程被杀的风险，以及这么做只是减少了Old Gen FGC的次数，没法根治。 且存在Old区变大，CMS Old Gen GC耗时变长的风险。&lt;/span&gt;&lt;/p&gt;&lt;/li&gt;&lt;/ol&gt;&lt;p&gt;&lt;span&gt;最终决定更换垃圾回收器为G1GC，因为G1GC默认晋升代数15代，可以使得更少的对象晋升到老年代，且支持Mixed GC增量式回收老年代垃圾。因此通过担保分配、晋升到Old区的垃圾可以通过Mixed GC清理。Mixed GC发生在YGC中，而G1的YGC又是能并发回收的，与ParNew相比具有更好的用户体验。&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;在G1GC默认的参数基础上，使用 G1NewSizePercent 参数固定Eden下限30%，设置 InitiatingHeapOccupancyPercent 为60%，保证Eden区不会过于小影响吞吐量，留10%的余量给Mixed GC时的并发分配动作；设置 MaxGCPauseMillis 为 120ms，期望稍微牺牲停顿时间换取更大吞吐量，以及Region大小4MB：期望GC能更精细的分配及标记Region，减少空间浪费。&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;&lt;br/&gt;&lt;/span&gt;&lt;/p&gt;&lt;h3&gt;&lt;span&gt;成效&lt;/span&gt;&lt;/h3&gt;&lt;p&gt;&lt;span&gt;最终该应用发布抖动消失，FGC消失，GC耗时相比优化前（CMS）总体下降近一半。业务高峰期对象分配压力极大的时候，仍能控制在一分钟GC总耗时不超过500ms的水平下清理老年区所有死亡对象。FGC现象被彻底根治。&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;img class=&quot;rich_pages wxw-img&quot; data-ratio=&quot;0.2949609035621199&quot; data-src=&quot;https://mmbiz.qpic.cn/mmbiz_png/DUwiayJ0Mj1HVybZicDayOdK1MmyK6wJWoXtyriaMstnAAR3qSxs1Mee95bd7cMEAYM9I0csMFRJLmmRibrMVDDQsQ/640?wx_fmt=png&quot; data-type=&quot;png&quot; data-w=&quot;2302&quot;/&gt;&lt;/p&gt;&lt;p&gt;&lt;/p&gt;&lt;h2&gt;&lt;span&gt;&lt;strong&gt;首页应用发布FGC&lt;/strong&gt;&lt;/span&gt;&lt;/h2&gt;&lt;h3&gt;&lt;br/&gt;&lt;/h3&gt;&lt;h3&gt;&lt;span&gt;现象&lt;/span&gt;&lt;/h3&gt;&lt;p&gt;&lt;span&gt;闲鱼首页应用，在发布过程中每次都会存在一小批机器，在应用启动后陷入FGC，必须手动重启才能恢复；每次陷入FGC的机器IP均不重复，通过置换容器也无法解决问题。与上文提及的商品域应用不同的是，首页应用在正常运行时不会出现FGC，正常机器的JVM堆监控及GC日志显示内存分配压力不算太大，且该应用已经在使用G1GC。&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;/p&gt;&lt;h3&gt;&lt;span&gt;分析&lt;/span&gt;&lt;/h3&gt;&lt;p&gt;&lt;span&gt;查看发生FGC机器的JVM监控：&lt;/span&gt;&lt;img class=&quot;rich_pages wxw-img&quot; data-ratio=&quot;0.5912762520193862&quot; data-src=&quot;https://mmbiz.qpic.cn/mmbiz_png/DUwiayJ0Mj1HVybZicDayOdK1MmyK6wJWo6UVXmuYAxjLX1fIszGlpbGFQ1eciaIKIfqngVvf9qOfMMMWupNmBl2w/640?wx_fmt=png&quot; data-type=&quot;png&quot; data-w=&quot;1857&quot;/&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;可以看到，从发布开始之后，有问题的机器老年代空间持续上涨，随后出现大量的FGC。从图中的GC耗时来看，一分钟有44.4s在FGC，7.9s在YGC。总计有52.3s处于GC状态。应用基本上没法响应外界请求。&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;从监控上看，也不难得知这是比较典型的堆内存泄漏。一般有两种情况：无用对象不释放，或者是对象存活周期由于某些原因而显著变长，导致堆里面存在大量存活对象，空间不够用。对于这种情况，通常需要借助Heap dump来观察堆里面究竟是什么对象大量占用空间。&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;img class=&quot;rich_pages wxw-img&quot; data-ratio=&quot;0.4351811436054125&quot; data-src=&quot;https://mmbiz.qpic.cn/mmbiz_png/DUwiayJ0Mj1HVybZicDayOdK1MmyK6wJWoCnLRicqd9CqfqsiceiaoHCVE9v4rJJUYLpa5H4rhmCDSAX8axIvbNHmHw/640?wx_fmt=png&quot; data-type=&quot;png&quot; data-w=&quot;2291&quot;/&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;从Heap dump结果中，发现堆里面存在大量的Log4j RingBufferLogEvent，也就是说，堆里有大量的Log4j异步线程没来得及消费的日志请求。而且最大的消息体竟然能到1.4M左右的大小。&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;通过对消息体内部的字符串分析，发现这是线上某个接口的出入参日志。通过对线上请求的抓包分析，发现该接口返回的内容确实较多，平均在1M以上。而这些接口出入参，又确实需要通过打日志的方式，上报到日志平台保存起来，供排查问题使用。这种出入参记录方式在闲鱼被广泛使用，通过review打日志的代码，发现并没有什么明显的问题。因此，问题基本上与应用的代码没太大相关性。唯一值得注意的点是日志体较大，考虑从日志产生到落盘的整个流程入手分析，看整个过程是否存在性能瓶颈。&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;闲鱼服务端应用为了提升打日志性能，降低同步调用打日志时出现IO Hang的风险，开启了Log4j的异步日志打印功能。这也是Log4j官网比较推荐的一种性能优化方式。具体原理如下图所示：&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;img class=&quot;rich_pages wxw-img&quot; data-ratio=&quot;0.46676737160120846&quot; data-src=&quot;https://mmbiz.qpic.cn/mmbiz_png/DUwiayJ0Mj1HVybZicDayOdK1MmyK6wJWo86XPXVxeymBfsgvwI8ztq6BAPjz4Gojr3UOZSnib5U8FXib2YCEMEFZA/640?wx_fmt=png&quot; data-type=&quot;png&quot; data-w=&quot;662&quot;/&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;在正常情况下，应用代码调用日志输出方法后，传入的日志文本会被封装成一个Event，投递到Log4j内部的一个环形队列中（由 disruptor 提供，这是一种无锁跨线程通信的库，能够提供比队列更高的吞吐和更低的延迟）就立即返回。由Log4j的后台线程不断消费环形队列中的Event，将日志输出到文件上。&lt;/span&gt;&lt;/p&gt;&lt;section&gt;&lt;span&gt;而 disruptor 中，环形队列的容量是以slot为单位组织的。在正常情况下是一个应用全局共享 262144 个slot。每个Event在RingBuffer中占用一个slot，一个slot里的&lt;/span&gt;&lt;span&gt;Event占用空间大小则不做限制。&lt;/span&gt;&lt;/section&gt;&lt;section&gt;&lt;span&gt;RingBufferSize 其实有两种取值，如果打开了 ThreadLocals RingBuffer&lt;br/&gt;条件是：&lt;/span&gt;&lt;code&gt;&lt;span&gt;!IS_WEB_APP &amp;amp;&amp;amp; PropertiesUtil.getProperties().getBooleanProperty(&quot;log4j2.enable.threadlocals&quot;, true)&lt;/span&gt;&lt;/code&gt;&lt;span&gt;如果条件为真，那么每个线程一个buffer，每个buffer有 4096个 Slot。否则，整个应用共享 262144 个 Slot。&lt;br/&gt;这个考量其实不难理解，因为WEB APP肯定有很多处理请求的线程，如果每个线程单独维护一组slot，这会导致整个应用里面有极大量的、互相独立的RingBuffer，有概率导致严重的内存占用。&lt;/span&gt;&lt;/section&gt;&lt;section&gt;&lt;span&gt;这就有可能出现以下的情况：&lt;strong&gt;应用有可能打出很大的日志，这就可能出现，Slot占用并不多，但是每个Slot的Event都很大，内存消耗非常可观。&lt;/strong&gt;&lt;/span&gt;&lt;/section&gt;&lt;section&gt;&lt;span&gt;另外，注意到应用使用的 Log4j 版本为 2.8.2，在官方的Jira上有一个issue: &lt;/span&gt;&lt;span&gt;LOG4J2-2031&lt;/span&gt;&lt;span&gt;。此issue记载在某些情况下会出现日志乱序以及日志打印无响应的情况。原因是因为 2.8.2 中默认的 AsyncQueueFullPolicy 为 SYNCHRONOUS，此策略会在RingBuffer满的时候绕过RingBuffer，直接向文件输出日志内容，导致日志乱序。&lt;/span&gt;&lt;/section&gt;&lt;section&gt;&lt;span&gt;此外，还发现日志输出过程中，会把日志message复制2遍，第一遍在&lt;/span&gt;&lt;code&gt;&lt;span&gt;org.apache.logging.log4j.core.layout.PatternLayout#encode&lt;/span&gt;&lt;/code&gt;&lt;span&gt;里toText调用，把日志内容复制到自己维护的一个放在ThreadLocal的StringBuffer里面。第二次是&lt;/span&gt;&lt;code&gt;&lt;span&gt;encoder.encode(text, destination);&lt;/span&gt;&lt;/code&gt;&lt;span&gt;调用，会把StringBuffer的内容拷进RollingRandomAccessFileManager内部的ByteBuffer里。所以，对于一个日志写入调用，峰值可能产生3倍内存占用。如果日志体很大的话，瞬时的堆占用将非常可观。可能出现来不及消费的日志Event挤占新生代空间，导致频繁YGC，吞吐量下降及日志Event对象晋升到老年代，进而出现FGC，由于FGC是STW的，会把Log4j后台写日志的线程也暂停掉，进一步影响了后台日志消费线程的执行，导致情况进一步恶化。&lt;/span&gt;&lt;/section&gt;&lt;section&gt;&lt;span&gt;对比2.8.2及2.14.1的源码，其中一处变化是修改了默认的异步队列满策略：2.14.1判断了当前日志写入线程是不是Log4j的回写线程，如果不是，就让当前线程等待RingBuffer消费出Slot。实践证明，这样的策略是更加合理的。&lt;/span&gt;&lt;/section&gt;&lt;section&gt;&lt;span&gt;在日志体较大的情况下，还有一个细节值得注意：有一个叫做 MessagePatternConverter 的 Converter。这个Converter是会搜索整个日志文件，把&lt;/span&gt;&lt;code&gt;&lt;span&gt;${}&lt;/span&gt;&lt;/code&gt;&lt;span&gt;占位符替换成真实值。具体实现是用了一个for循环的方法搜索形如&lt;/span&gt;&lt;code&gt;&lt;span&gt;${&lt;/span&gt;&lt;/code&gt;&lt;span&gt;的连续字符并加以处理。对于刚才那种上MB大小、且根本没有&lt;/span&gt;&lt;code&gt;&lt;span&gt;${}&lt;/span&gt;&lt;/code&gt;&lt;span&gt;占位符需要替换的的请求日志，此特性只能是浪费计算资源，影响日志消费速度。&lt;/span&gt;&lt;/section&gt;&lt;section class=&quot;code-snippet__fix code-snippet__js&quot;&gt;&lt;pre class=&quot;code-snippet__js&quot; data-lang=&quot;java&quot;&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span class=&quot;code-snippet__function&quot;&gt;&lt;span class=&quot;code-snippet__keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-snippet__keyword&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;code-snippet__title&quot;&gt;format&lt;/span&gt;&lt;span class=&quot;code-snippet__params&quot;&gt;(&lt;span class=&quot;code-snippet__keyword&quot;&gt;final&lt;/span&gt; LogEvent event, &lt;span class=&quot;code-snippet__keyword&quot;&gt;final&lt;/span&gt; StringBuilder toAppendTo)&lt;/span&gt; &lt;/span&gt;{&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;    &lt;span class=&quot;code-snippet__keyword&quot;&gt;final&lt;/span&gt; Message msg = event.getMessage();&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;    &lt;span class=&quot;code-snippet__keyword&quot;&gt;if&lt;/span&gt; (msg &lt;span class=&quot;code-snippet__keyword&quot;&gt;instanceof&lt;/span&gt; StringBuilderFormattable) {&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;br/&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;        &lt;span class=&quot;code-snippet__keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;code-snippet__keyword&quot;&gt;boolean&lt;/span&gt; doRender = textRenderer != &lt;span class=&quot;code-snippet__keyword&quot;&gt;null&lt;/span&gt;;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;        &lt;span class=&quot;code-snippet__keyword&quot;&gt;final&lt;/span&gt; StringBuilder workingBuilder = doRender ? &lt;span class=&quot;code-snippet__keyword&quot;&gt;new&lt;/span&gt; StringBuilder(&lt;span class=&quot;code-snippet__number&quot;&gt;80&lt;/span&gt;) : toAppendTo;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;br/&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;        &lt;span class=&quot;code-snippet__keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;code-snippet__keyword&quot;&gt;int&lt;/span&gt; offset = workingBuilder.length();&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;        &lt;span class=&quot;code-snippet__keyword&quot;&gt;if&lt;/span&gt; (msg &lt;span class=&quot;code-snippet__keyword&quot;&gt;instanceof&lt;/span&gt; MultiFormatStringBuilderFormattable) {&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;            ((MultiFormatStringBuilderFormattable) msg).formatTo(formats, workingBuilder);&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;        } &lt;span class=&quot;code-snippet__keyword&quot;&gt;else&lt;/span&gt; {&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;            ((StringBuilderFormattable) msg).formatTo(workingBuilder);&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;        }&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;br/&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;        &lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;      &lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;        &lt;span class=&quot;code-snippet__keyword&quot;&gt;if&lt;/span&gt; (config != &lt;span class=&quot;code-snippet__keyword&quot;&gt;null&lt;/span&gt; &amp;amp;&amp;amp; !noLookups) {&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;            &lt;span class=&quot;code-snippet__keyword&quot;&gt;for&lt;/span&gt; (&lt;span class=&quot;code-snippet__keyword&quot;&gt;int&lt;/span&gt; i = offset; i &amp;lt; workingBuilder.length() - &lt;span class=&quot;code-snippet__number&quot;&gt;1&lt;/span&gt;; i++) {&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;                &lt;span class=&quot;code-snippet__keyword&quot;&gt;if&lt;/span&gt; (workingBuilder.charAt(i) == &lt;span class=&quot;code-snippet__string&quot;&gt;&#x27;$&#x27;&lt;/span&gt; &amp;amp;&amp;amp; workingBuilder.charAt(i + &lt;span class=&quot;code-snippet__number&quot;&gt;1&lt;/span&gt;) == &lt;span class=&quot;code-snippet__string&quot;&gt;&#x27;{&#x27;&lt;/span&gt;) {&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;                    &lt;span class=&quot;code-snippet__keyword&quot;&gt;final&lt;/span&gt; String value = workingBuilder.substring(offset, workingBuilder.length());&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;                    workingBuilder.setLength(offset);&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;                    workingBuilder.append(config.getStrSubstitutor().replace(event, value));&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;                }&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;            }&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;        }&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;        &lt;span class=&quot;code-snippet__keyword&quot;&gt;if&lt;/span&gt; (doRender) {&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;            textRenderer.render(workingBuilder, toAppendTo);&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;        }&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;        &lt;span class=&quot;code-snippet__keyword&quot;&gt;return&lt;/span&gt;;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;    }&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;    &lt;span class=&quot;code-snippet__keyword&quot;&gt;if&lt;/span&gt; (msg != &lt;span class=&quot;code-snippet__keyword&quot;&gt;null&lt;/span&gt;) {&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;        String result;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;        &lt;span class=&quot;code-snippet__keyword&quot;&gt;if&lt;/span&gt; (msg &lt;span class=&quot;code-snippet__keyword&quot;&gt;instanceof&lt;/span&gt; MultiformatMessage) {&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;            result = ((MultiformatMessage) msg).getFormattedMessage(formats);&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;        } &lt;span class=&quot;code-snippet__keyword&quot;&gt;else&lt;/span&gt; {&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;            result = msg.getFormattedMessage();&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;        }&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;        &lt;span class=&quot;code-snippet__keyword&quot;&gt;if&lt;/span&gt; (result != &lt;span class=&quot;code-snippet__keyword&quot;&gt;null&lt;/span&gt;) {&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;            toAppendTo.append(config != &lt;span class=&quot;code-snippet__keyword&quot;&gt;null&lt;/span&gt; &amp;amp;&amp;amp; result.contains(&lt;span class=&quot;code-snippet__string&quot;&gt;&quot;${&quot;&lt;/span&gt;)&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;                    ? config.getStrSubstitutor().replace(event, result) : result);&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;        } &lt;span class=&quot;code-snippet__keyword&quot;&gt;else&lt;/span&gt; {&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;            toAppendTo.append(&lt;span class=&quot;code-snippet__string&quot;&gt;&quot;null&quot;&lt;/span&gt;);&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;        }&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;    }&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/section&gt;&lt;section&gt;&lt;span/&gt;&lt;/section&gt;&lt;h3&gt;&lt;span&gt;根因&lt;/span&gt;&lt;/h3&gt;&lt;p&gt;&lt;span&gt;最终，我们认为导致此现象发生的原因是：冷 JVM 涌入大量大日志打印请求 -&amp;gt; RingBuffer 大量占用堆内存 + 日志消费跟不上速度 -&amp;gt; 触发YGC，甚至是STW FGC -&amp;gt; STW FGC暂停Log4j消费写盘线程 -&amp;gt; 恶性循环，应用雪崩。&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;在问题排查过程中 ，还发现首页应用使用的新版 AliJDK 在使用新版协程支持来处理线程间切换以及阻塞、唤醒调用时，存在极小概率出现调度器死循环，部分/全部线程失去响应，JVM僵死的情况。不排除协程调度器死循环可能影响Log4j日志消费线程的情况。该场景极难复现，出现时Thread dump工具、JVM Agent等诊断工具均无法连接上JVM，看不到现场，排查难度高。&lt;br/&gt;此外，全协程模型带来的性能提升感知不强。因此，为了保险起见，处理此问题时，顺便也关闭了新版协程，使得JVM回退到传统的线程模型运行代码。&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;/p&gt;&lt;h3&gt;&lt;span&gt;解法&lt;/span&gt;&lt;/h3&gt;&lt;p&gt;&lt;span&gt;对于该应用的FGC问题，采取4步走策略，逐个击破：&lt;/span&gt;&lt;/p&gt;&lt;ol class=&quot;list-paddingleft-2&quot;&gt;&lt;li&gt;&lt;p&gt;&lt;span&gt;RingBuffer大量占用堆内存: 通过限制RingBuffer Slot数为一个合理值，保证应用中最大的LogEvent填满RingBuffer时也不至于把堆撑爆。本应用设置的是2048。&lt;/span&gt;&lt;/p&gt;&lt;/li&gt;&lt;/ol&gt;&lt;p&gt;&lt;span&gt;一般情况下，该值不需要调整。因为通常情况下极少有应用会产生超大日志体。如确实需要调整此参数，需要结合应用的日志使用场景，分情况评估。&lt;/span&gt;&lt;/p&gt;&lt;ol start=&quot;2&quot; class=&quot;list-paddingleft-2&quot;&gt;&lt;li&gt;&lt;p&gt;&lt;span&gt;JVM过冷：延长新启动机器小流量预热时长。&lt;/span&gt;&lt;/p&gt;&lt;/li&gt;&lt;/ol&gt;&lt;ol start=&quot;3&quot; class=&quot;list-paddingleft-2&quot;&gt;&lt;li&gt;&lt;p&gt;&lt;span&gt;Log4j 队列满时内存占用过大：升级Log4j到2.14.1。使用新版队列满策略，同步等待队列消费出slot。&lt;/span&gt;&lt;/p&gt;&lt;/li&gt;&lt;/ol&gt;&lt;ol start=&quot;4&quot; class=&quot;list-paddingleft-2&quot;&gt;&lt;li&gt;&lt;p&gt;&lt;span&gt;Log消费过程存在无意义的计算：对于不需要占位符替换的场景关闭占位符替换特性，提高消费速度。&lt;/span&gt;&lt;/p&gt;&lt;/li&gt;&lt;/ol&gt;&lt;p&gt;&lt;/p&gt;&lt;h3&gt;&lt;span&gt;成效&lt;/span&gt;&lt;/h3&gt;&lt;p&gt;&lt;span&gt;应用上述策略后，发布参数调整的修复分支。效果立竿见影，此分支发布过程中无任何FGC发生。回访应用负责人，此后所有的发布均不再出现上文提及的FGC。&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;img class=&quot;rich_pages wxw-img&quot; data-ratio=&quot;0.5174363807728558&quot; data-src=&quot;https://mmbiz.qpic.cn/mmbiz_png/DUwiayJ0Mj1HVybZicDayOdK1MmyK6wJWoEx4axtl2zJ6jp3bJrqkyhh5bl3FGic7QHkVZcPh31zKNyvCxJY7iaV5A/640?wx_fmt=png&quot; data-type=&quot;png&quot; data-w=&quot;2122&quot;/&gt;&lt;/p&gt;&lt;p&gt;&lt;/p&gt;&lt;h2&gt;&lt;span&gt;&lt;strong&gt;玩家业务应用运行时FGC&lt;/strong&gt;&lt;/span&gt;&lt;/h2&gt;&lt;p&gt;&lt;/p&gt;&lt;h3&gt;&lt;span&gt;现象&lt;/span&gt;&lt;/h3&gt;&lt;p&gt;&lt;span&gt;某玩家业务应用，使用G1GC垃圾回收器，平时集群正常承接业务流量，没有FGC，对象分配压力并不大。但是有一天集群突然出现FGC，且随着时间的推移FGC的频率越来越高。机器重启无法解决问题。&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;img class=&quot;rich_pages wxw-img&quot; data-backh=&quot;324&quot; data-backw=&quot;578&quot; data-ratio=&quot;0.5602836879432624&quot; data-src=&quot;https://mmbiz.qpic.cn/mmbiz_png/DUwiayJ0Mj1HVybZicDayOdK1MmyK6wJWoiaDaOxiby0PID99PgscNU4CPjBEUu3MLC8TRhAFmBdMhts4miafQjIpUA/640?wx_fmt=png&quot; data-type=&quot;png&quot; data-w=&quot;2820&quot;/&gt;&lt;/p&gt;&lt;h3&gt;&lt;span&gt;&lt;br/&gt;&lt;/span&gt;&lt;/h3&gt;&lt;h3&gt;&lt;span&gt;分析&lt;/span&gt;&lt;/h3&gt;&lt;p&gt;&lt;span&gt;查看发生FGC机器的JVM监控，可惜监控并没能给到太多有用的信息：&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;/p&gt;&lt;p&gt;&lt;img class=&quot;rich_pages wxw-img&quot; data-ratio=&quot;0.5938177874186551&quot; data-src=&quot;https://mmbiz.qpic.cn/mmbiz_png/DUwiayJ0Mj1HVybZicDayOdK1MmyK6wJWoMccsfibQyWOpDkJoibWVXe7g9RaWykBcxb0y41WhiaS6ldRQmv243iaqMQ/640?wx_fmt=png&quot; data-type=&quot;png&quot; data-w=&quot;1844&quot;/&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;从监控上看，堆使用率、YGC次数等都比较正常，机器运行过程中老年代基本上保持在相对稳定的水位，偶尔出现FGC时，也能迅速清理掉堆中死亡对象，使得占用迅速回落到正常水位。因此基本可以排除内存泄漏、担保分配、晋升等原因而出现的缓慢上升的老年代占用。&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;从接口QPS、RT、Load等指标看，这些指标也非常平稳，可以排除有瞬时大流量冲击机器导致爆发式业务压力产生的FGC。多次FGC之间间隔并不规律；排查过定时任务调度平台，也可以排除由于某些内存压力较大的定时任务产生的FGC。&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;分析到这里，没有更好的办法，把目光转向FGC发生时的gc日志、应用日志，期望从日志中得到有价值的信息。&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;查看gc日志，发现在若干次正常的YGC后，存在一次to-space exhausted：&lt;/span&gt;&lt;img class=&quot;rich_pages wxw-img&quot; data-ratio=&quot;0.11334120425029516&quot; data-src=&quot;https://mmbiz.qpic.cn/mmbiz_png/DUwiayJ0Mj1HVybZicDayOdK1MmyK6wJWot3W8FcwaYL26BgMcOrIxQbw9N9vynjPcHNKDMicicDRNhncO8icADpvZQ/640?wx_fmt=png&quot; data-type=&quot;png&quot; data-w=&quot;3388&quot;/&gt;&lt;span&gt;这是一次因为Eden区空间不够而产生的YGC，而在这次YGC中Survivor区也不够用。一般情况下G1GC因为会根据新生代对象存活率自适应调整Survivor区大小，基本上极少出现to-space exhausted。随后日志显示Old区占用上涨了数百MB。显然，这预示着业务中有超大对象分配。&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;一旦知道有”超大对象”分配，方向就变得明朗了起来。G1认为占用了超过Region大小一半的连续堆空间的对象是大对象。&lt;/span&gt;&lt;span&gt;且在大对象分配时，会给出大对象分配的调用栈。&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;该应用中配置的Region大小为32M，一半则为16M。&lt;/span&gt;&lt;span/&gt;&lt;/p&gt;&lt;p&gt;&lt;img class=&quot;rich_pages wxw-img&quot; data-backh=&quot;214&quot; data-backw=&quot;578&quot; data-ratio=&quot;0.37093153759820424&quot; data-src=&quot;https://mmbiz.qpic.cn/mmbiz_png/DUwiayJ0Mj1HVybZicDayOdK1MmyK6wJWof25xau0kbGibtZliacTibZtj5CbMMIY9BpwTAOo5LAgCvRFibMjDbcQwrA/640?wx_fmt=png&quot; data-type=&quot;png&quot; data-w=&quot;3564&quot;/&gt;&lt;/p&gt;&lt;p&gt;&lt;/p&gt;&lt;h3&gt;&lt;span&gt;根因&lt;/span&gt;&lt;/h3&gt;&lt;p&gt;&lt;span&gt;通过排查上述调用栈的代码，发现是一句日志打印的代码引发的血案。具体现场如下代码段所示：&lt;/span&gt;&lt;/p&gt;&lt;section class=&quot;code-snippet__fix code-snippet__js&quot;&gt;&lt;pre class=&quot;code-snippet__js&quot; data-lang=&quot;cpp&quot;&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;/&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;br/&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;@Data&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span class=&quot;code-snippet__keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-snippet__class&quot;&gt;&lt;span class=&quot;code-snippet__keyword&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;code-snippet__title&quot;&gt;MapWrapper&lt;/span&gt; {&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;  &lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;    &lt;span class=&quot;code-snippet__keyword&quot;&gt;public&lt;/span&gt; Map&amp;lt;Key, Value&amp;gt; manyEntryMap;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;  &lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;/&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;br/&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;MapWrapper instance = xxx;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span class=&quot;code-snippet__built_in&quot;&gt;log&lt;/span&gt;.info(&lt;span class=&quot;code-snippet__string&quot;&gt;&quot;print some log with plus concation! obj: &quot;&lt;/span&gt; + instance);&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;/&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;/&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/section&gt;&lt;p&gt;&lt;span&gt;一个类实例里面封装着一个有非常多的Entry的Map，这个类又因为有@Data注解，lombok会为其隐式实现toString方法。而在打印日志过程中，使用 + 操作符连接字符串和对象，会默认调用对象的toString方法，将对象转化成字符串形式。&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;该对象在没转换成字符串的时候，虽然里面的Map有非常多的Entry，但是都是分散在堆的各处的，不是连续的内存。体现为MapWrapper的支配堆空间可能很大，但是本体占用十分小。&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;一旦调用toString方法，将对象转换成字符串形式时，就会把Map里面每个entry都转化成字符串形式保存在一个字符串里；而字符串本体需要一段连续的内存来保存char信息，因此需要一段连续的堆空间来存储这个字符串。如果Map的Entry很多，那么最终出来的字符串就会很大，当超过了一半Region大小时，G1会认为这是一个大对象，直接分配到老年代。&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;更要命的是，底层在使用StringBuilder来append字符串，当StringBuilder需要扩容时，会创建一个新的&lt;/span&gt;&lt;code&gt;char[]&lt;/code&gt;&lt;span&gt;数组，并把原来的内容复制到新的char[]数组里面。如果原来的&lt;/span&gt;&lt;code&gt;char[]&lt;/code&gt;&lt;span&gt;数组已经是分配到老年代的大对象了，那新的char[]数组也会被分配到老年代，最终一次toString可能产生好几个驻留在老年代的大对象，尽管它们已经死亡。&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;反映到gc日志上，即为老年代激增数百MB。&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;可能有读者好奇，理论上一个日志对象这么大，应该能在磁盘利用率，磁盘写入IO量等指标上有所反映。而该应用设置的线上环境日志等级为WARN，这个产生了大对象分配的日志打印等级为INFO。所以这个大对象不会打到磁盘上。因此，一条根本不会被打印到磁盘上的日志，就因为一个小小的 &lt;/span&gt;&lt;code&gt;+&lt;/code&gt;&lt;span&gt;，就多出了大量的计算工作、内存分配，甚至导致了线上FGC的发生。&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;/p&gt;&lt;h3&gt;&lt;span&gt;解法&lt;/span&gt;&lt;/h3&gt;&lt;p&gt;&lt;span&gt;看上去复杂的问题，解法有时候反而非常简单：可以通过修改代码，使用&quot;{}&quot;占位符来拼接对象；也可以直接优化掉这句日志打印。&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;/p&gt;&lt;h3&gt;&lt;span&gt;成效&lt;/span&gt;&lt;/h3&gt;&lt;p&gt;&lt;span&gt;负责此业务的同学优化掉了上述日志、排查了大Map产生的业务场景并做了相关优化。修复上线后，FGC消失。&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;/p&gt;&lt;article tabindex=&quot;0&quot;&gt;&lt;h2&gt;&lt;span&gt;&lt;strong&gt;总结&lt;/strong&gt;&lt;/span&gt;&lt;/h2&gt;&lt;p&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;本文介绍的三则前台应用FGC问题，分别是由JVM参数、中间件配置、业务代码层面引起。三则案例监控表象、分析过程、解决方法不尽相同。但是给开发同学们的启发却是相通的。&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;从工程层面：开发同学在写每一行代码的时候，都应该清楚这行代码的行为、包括时间、空间复杂度，以及一些极端情况下会产生的后果；开发功能时，应该充分了解业务特点，设计合适的数据结构；使用中间件，框架时，应该熟悉中间件提供的特性，遵循中间件的推荐用法，避免日后埋坑。&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;从问题分析层面：要培养透过现象看本质的思考方式，熟悉各种监控指标的作用以及监测的对象，在出现问题的时候能够快速通过各项指标定位问题点，为快速止血及后续的修复提供方向。&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;从技术层面：借用一句Oracle官方文档对G1回收器调优参数介绍时的总结：&quot;When you evaluate or tune any garbage collection, there is always a latency versus throughput trade-off&quot;。GC调优的根本难点在于：找到回收吞吐量和停顿时间的平衡点。应用的平均GC吞吐量 = sum(每次GC回收的堆空间) / sum(GC运行时间)。目前市面上有很多“并发式”垃圾回收算法，允许用户线程和垃圾回收线程同时运行，以便获得更短的停顿时间。然而，&lt;strong&gt;停顿时间并不等于GC运行时间&lt;/strong&gt;，如果一个GC算法虽然停顿时间很短，但是总体运行时间较长；在GC完成前，被死亡对象占用的堆空间可能是无法完全释放的，与GC线程并发运行的用户线程在这个时间段仍然会继续分配新对象，如果堆剩余空间不足以坚持到GC执行完成，就有可能因为堆空间不足，回退到STW的FGC，反而得不偿失。因此，在配置垃圾回收器的相关参数时，也需要综合考虑应用的对象分配特点，模拟线上真实业务负载，找到最合适的参数值，从而保证业务运行稳定。&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;/p&gt;&lt;p&gt;&lt;img class=&quot;rich_pages wxw-img&quot; data-backh=&quot;2324&quot; data-backw=&quot;562&quot; data-ratio=&quot;4.13570487483531&quot; data-src=&quot;https://mmbiz.qpic.cn/mmbiz_png/DUwiayJ0Mj1GLZDqvPfwuIUEJjtdPx4lYwPx0p9E4T3D1f164CCr18n4ms26HtWsUVrsLf8Szwb4Us8MuhOCe3g/640?wx_fmt=png&quot; data-type=&quot;png&quot; data-w=&quot;759&quot;/&gt;&lt;/p&gt;&lt;/article&gt;
                &lt;/div&gt;

                

                



                
                &lt;/div&gt;&lt;/div&gt;</content:encoded>
</item>
<item>
<guid>ac4287898e35639de97c62ad74290a42</guid>
<title>之家云API网关的前世今生</title>
<link>https://toutiao.io/k/16je6kb</link>
<content:encoded>&lt;div&gt;&lt;div&gt;&lt;div class=&quot;rich_media_content &quot; id=&quot;js_content&quot;&gt;
                    

                    
                    
                    
                    &lt;p&gt;&lt;img class=&quot;rich_pages wxw-img&quot; data-backh=&quot;57&quot; data-backw=&quot;578&quot; data-ratio=&quot;0.0984375&quot; data-s=&quot;300,640&quot; data-src=&quot;https://mmbiz.qpic.cn/mmbiz_gif/UPBmkBoiaVwuh8DEJlYXXvEjNrISejeXSt7knYYiaGantXAsgOvXvxAOog7a4L9yEicM1biao6MGia2Ob4I3B77Z6Vg/640?wx_fmt=gif&quot; data-type=&quot;gif&quot; data-w=&quot;640&quot;/&gt;&lt;/p&gt;&lt;p&gt;&lt;strong&gt;&lt;span&gt;总篇126篇 2022年第1篇&lt;/span&gt;&lt;/strong&gt;&lt;/p&gt;&lt;section&gt;&lt;section powered-by=&quot;xiumi.us&quot;&gt;&lt;section&gt;&lt;section powered-by=&quot;xiumi.us&quot;&gt;&lt;section&gt;&lt;section&gt;&lt;section powered-by=&quot;xiumi.us&quot;&gt;&lt;section powered-by=&quot;xiumi.us&quot;&gt;&lt;section&gt;&lt;p&gt;&lt;strong&gt;前言&lt;/strong&gt;&lt;/p&gt;&lt;/section&gt;&lt;/section&gt;&lt;/section&gt;&lt;section powered-by=&quot;xiumi.us&quot;&gt;&lt;section&gt;&lt;section&gt;&lt;svg viewbox=&quot;0 0 1 1&quot;/&gt;&lt;/section&gt;&lt;/section&gt;&lt;/section&gt;&lt;/section&gt;&lt;/section&gt;&lt;/section&gt;&lt;section powered-by=&quot;xiumi.us&quot;&gt;&lt;p&gt;&lt;span&gt;从用户层API网关是服务的统一入口，是各种协议的中转站，是对上游服务的保护，是对API全生命周期的管理，是对东西流量和南北流量的集中治理。从集群层API网关属与分布式集群可横向扩展来处理高并发的请求，从服务层API属于源站的保护伞，路由器，防火墙，对访问服务的流量进行分发，治理和转换。&lt;/span&gt;&lt;/p&gt;&lt;/section&gt;&lt;/section&gt;&lt;/section&gt;&lt;/section&gt;&lt;section&gt;&lt;br/&gt;&lt;/section&gt;&lt;section&gt;&lt;section powered-by=&quot;xiumi.us&quot;&gt;&lt;section&gt;&lt;section powered-by=&quot;xiumi.us&quot;&gt;&lt;section&gt;&lt;section&gt;&lt;section powered-by=&quot;xiumi.us&quot;&gt;&lt;section&gt;&lt;p&gt;&lt;strong&gt;01&lt;/strong&gt;&lt;/p&gt;&lt;/section&gt;&lt;/section&gt;&lt;/section&gt;&lt;section&gt;&lt;section powered-by=&quot;xiumi.us&quot;&gt;&lt;section&gt;&lt;p&gt;&lt;span&gt;&lt;strong&gt;历程&lt;/strong&gt;&lt;/span&gt;&lt;/p&gt;&lt;/section&gt;&lt;/section&gt;&lt;section powered-by=&quot;xiumi.us&quot;&gt;&lt;section&gt;&lt;br/&gt;&lt;/section&gt;&lt;/section&gt;&lt;/section&gt;&lt;/section&gt;&lt;/section&gt;&lt;/section&gt;&lt;/section&gt;&lt;/section&gt;&lt;p&gt;&lt;span&gt;如&lt;/span&gt;&lt;span&gt;何从0到1，如何从1到100的构建API网关，下面讲述下整体的历程。&lt;/span&gt;&lt;span/&gt;&lt;/p&gt;&lt;section&gt;&lt;strong&gt;&lt;span&gt;第一阶段需求/痛点：&lt;/span&gt;&lt;/strong&gt;&lt;span/&gt;&lt;/section&gt;&lt;section&gt;&lt;span&gt;1.多个服务端无法提供统一的服务，客户端需逐一加在；&lt;/span&gt;&lt;/section&gt;&lt;section&gt;&lt;span&gt;2.无法提供统一API的认证功能，服务提供者各自为战，功能参差不齐；&lt;/span&gt;&lt;/section&gt;&lt;section&gt;&lt;span&gt;3.对API无任何统一的管理，上线/下线/治理等功能无从谈起。&lt;/span&gt;&lt;/section&gt;&lt;section&gt;&lt;strong&gt;&lt;span&gt;第二阶段调研/选型：&lt;/span&gt;&lt;/strong&gt;&lt;span/&gt;&lt;/section&gt;&lt;section&gt;&lt;span&gt;&lt;img class=&quot;rich_pages wxw-img&quot; data-backh=&quot;330&quot; data-backw=&quot;562&quot; data-ratio=&quot;0.5866425992779783&quot; data-src=&quot;https://mmbiz.qpic.cn/mmbiz_png/UPBmkBoiaVwu6IV1CHN4EiaZ1bZk2L3E75XkFh8UBVicf0ej8CoOibEzbZp7DBvmT0GeVK3zoSYRvONtR0f9pm0kbw/640?wx_fmt=png&quot; data-type=&quot;png&quot; data-w=&quot;554&quot;/&gt;&lt;/span&gt;&lt;/section&gt;&lt;p&gt;&lt;span&gt;从开源协议和部署方式综合考虑选型为KONG,之家云网关在2019年6月上线，当时APISIX还未开源（2019 年 10 月份在Apache 开源），不与做对比。&lt;/span&gt;&lt;/p&gt;&lt;section&gt;&lt;strong&gt;&lt;span&gt;第三阶段平台定位：&lt;/span&gt;&lt;/strong&gt;&lt;span&gt;&lt;span/&gt;&lt;span&gt;API的定义，注册，管控，注销的全生命周期管理平台。&lt;/span&gt;&lt;/span&gt;&lt;/section&gt;&lt;section&gt;&lt;strong&gt;&lt;span&gt;第四阶段1.0版本&lt;/span&gt;&lt;/strong&gt;&lt;span&gt;&lt;span&gt;：&lt;/span&gt;&lt;span&gt;API的即插即用，业务接入。&lt;/span&gt;&lt;/span&gt;&lt;/section&gt;&lt;section&gt;&lt;strong&gt;&lt;span&gt;第五阶段2.0版本&lt;/span&gt;&lt;/strong&gt;&lt;span&gt;&lt;span&gt;：&lt;/span&gt;&lt;span&gt;API的管控，承接公司818全球车展活动。&lt;/span&gt;&lt;/span&gt;&lt;/section&gt;&lt;section&gt;&lt;section powered-by=&quot;xiumi.us&quot;&gt;&lt;section&gt;&lt;section powered-by=&quot;xiumi.us&quot;&gt;&lt;section&gt;&lt;section&gt;&lt;section powered-by=&quot;xiumi.us&quot;&gt;&lt;section&gt;&lt;p&gt;&lt;strong&gt;02&lt;/strong&gt;&lt;/p&gt;&lt;/section&gt;&lt;/section&gt;&lt;/section&gt;&lt;section&gt;&lt;section powered-by=&quot;xiumi.us&quot;&gt;&lt;section&gt;&lt;p&gt;&lt;span&gt;&lt;strong&gt;架构&lt;/strong&gt;&lt;/span&gt;&lt;/p&gt;&lt;/section&gt;&lt;/section&gt;&lt;section powered-by=&quot;xiumi.us&quot;&gt;&lt;section&gt;&lt;br/&gt;&lt;/section&gt;&lt;/section&gt;&lt;/section&gt;&lt;/section&gt;&lt;/section&gt;&lt;/section&gt;&lt;/section&gt;&lt;/section&gt;&lt;section&gt;&lt;strong&gt;&lt;span&gt;平台架构&lt;/span&gt;&lt;/strong&gt;&lt;br/&gt;&lt;/section&gt;&lt;p&gt;&lt;img class=&quot;rich_pages wxw-img js_insertlocalimg&quot; data-backh=&quot;269&quot; data-backw=&quot;380&quot; data-ratio=&quot;0.7074074074074074&quot; data-s=&quot;300,640&quot; data-src=&quot;https://mmbiz.qpic.cn/mmbiz_png/UPBmkBoiaVwu6IV1CHN4EiaZ1bZk2L3E759vZte3s0icgZmHupzH5ERV2Gw0ot7pUmSFicwcHETicLNS2TbibZWTKLibA/640?wx_fmt=png&quot; data-type=&quot;png&quot; data-w=&quot;1080&quot;/&gt;&lt;/p&gt;&lt;section&gt;&lt;span&gt;通过组集合API，可以管理对应的环境和域名的访问模式，API是核心所在可以注册，发布，授权，销毁全阶段管理API,API 使用期间可以监控，告警，编辑，日志，记录，调试等操作，策略管理集成插件的功能主要有：&lt;/span&gt;&lt;/section&gt;&lt;p&gt;&lt;strong&gt;&lt;span&gt;     1)MOCK：&lt;/span&gt;&lt;/strong&gt;&lt;span&gt;&lt;span/&gt;&lt;span&gt;不请求源站，从网关层返回http状态码,http 头,http数据。&lt;/span&gt;&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;&lt;strong&gt;     2)跨域：&lt;/strong&gt;&lt;/span&gt;&lt;span&gt;描述：可在网关开发跨域功能，解决前端到服务端的同源策略&lt;/span&gt;&lt;span&gt;，&lt;/span&gt;&lt;span&gt;字段：&lt;/span&gt;&lt;span/&gt;&lt;/p&gt;&lt;ul class=&quot;list-paddingleft-2&quot;&gt;&lt;li&gt;&lt;section&gt;&lt;span&gt;&lt;span&gt;允许的域：Access-Control-Allow-Origin的值（多个以逗号分隔）,值可以是字符串或者PCRE的正则表达式。&lt;/span&gt;&lt;/span&gt;&lt;span&gt;如果希望允许所有源, 请将 * 作为单个值添加到此配置字段中。&lt;/span&gt;&lt;/section&gt;&lt;/li&gt;&lt;li&gt;&lt;section&gt;&lt;span&gt;请求方法&lt;/span&gt;：&lt;span&gt;Access-Control-Allow-Methods的值（以逗号分隔的字符串）。GET, HEAD, PUT, PATCH, POST中的一个或者多个。&lt;/span&gt;&lt;/section&gt;&lt;/li&gt;&lt;li&gt;&lt;section&gt;&lt;span&gt;请求头：&lt;/span&gt;&lt;span&gt;Access-Control-Request-Headers&lt;/span&gt;&lt;span&gt;的值（以逗号分隔的字符串）。&lt;/span&gt;&lt;span&gt;例如: Origin, Authorization。&lt;/span&gt;&lt;/section&gt;&lt;/li&gt;&lt;li&gt;&lt;section&gt;&lt;span&gt;响应头：&lt;/span&gt;&lt;span&gt;Access-Control-Expose-H&lt;/span&gt;&lt;span&gt;eaders的值（以逗号分隔的字符串）。&lt;/span&gt;&lt;/section&gt;&lt;/li&gt;&lt;li&gt;&lt;section&gt;&lt;span&gt;缓存时间：&lt;/span&gt;&lt;span&gt;设置preflight request结果缓存的时间，须为大于零的整数。&lt;/span&gt;&lt;/section&gt;&lt;/li&gt;&lt;li&gt;&lt;section&gt;&lt;span&gt;响&lt;/span&gt;&lt;span&gt;应凭据：&lt;/span&gt;&lt;span&gt;控制Access-Control-Allow-Credentials头，是否以true作为此header的值。&lt;/span&gt;&lt;/section&gt;&lt;/li&gt;&lt;li&gt;&lt;section&gt;&lt;span/&gt;&lt;span&gt;预检请求：&lt;/span&gt;&lt;span&gt;是否将OPTIONS代理信息发送给后端源服务器。&lt;/span&gt;&lt;/section&gt;&lt;/li&gt;&lt;/ul&gt;&lt;section&gt;&lt;span&gt;  &lt;/span&gt;&lt;strong&gt;&lt;span&gt;&lt;span&gt;   3)限流：&lt;/span&gt;&lt;/span&gt;&lt;/strong&gt;&lt;span&gt;&lt;span/&gt;&lt;span&gt;限制单位时间内此IP访问次数，超过的访问返回限流信息(http code 429)&lt;/span&gt;&lt;/span&gt;&lt;/section&gt;&lt;section&gt;&lt;strong&gt;&lt;span&gt;&lt;span&gt;     4)缓存：&lt;/span&gt;&lt;/span&gt;&lt;/strong&gt;&lt;span&gt;&lt;span/&gt;&lt;span&gt;为本地缓存，自己设置缓存时间和缓存类型访问为HIT视为命中。&lt;/span&gt;&lt;/span&gt;&lt;/section&gt;&lt;section&gt;&lt;span&gt;&lt;span&gt;    &lt;strong&gt; 5)黑白名单：&lt;/strong&gt;&lt;/span&gt;&lt;span&gt;设置ip黑白名单，限制访问用户返回(http code 403)&lt;/span&gt;&lt;/span&gt;&lt;/section&gt;&lt;section&gt;&lt;span&gt;&lt;span&gt;  &lt;strong&gt;   6)并发：&lt;/strong&gt;&lt;/span&gt;&lt;span&gt;用户1秒内访问超过设置的并发数值后返回托底数据和504状态码或跳转到服务内部的URL。&lt;/span&gt;&lt;/span&gt;&lt;/section&gt;&lt;section&gt;&lt;span&gt;&lt;br/&gt;&lt;/span&gt;&lt;/section&gt;&lt;section&gt;&lt;span&gt;  &lt;strong&gt; &lt;/strong&gt;&lt;/span&gt;&lt;span&gt;&lt;strong&gt;  系统架构&lt;/strong&gt;&lt;/span&gt;&lt;span&gt;&lt;br/&gt;&lt;/span&gt;&lt;/section&gt;&lt;section&gt;&lt;span&gt;&lt;img class=&quot;rich_pages wxw-img&quot; data-backh=&quot;441&quot; data-backw=&quot;562&quot; data-cropselx1=&quot;0&quot; data-cropselx2=&quot;562&quot; data-cropsely1=&quot;0&quot; data-cropsely2=&quot;441&quot; data-ratio=&quot;0.7849829351535836&quot; data-src=&quot;https://mmbiz.qpic.cn/mmbiz_png/UPBmkBoiaVwu6IV1CHN4EiaZ1bZk2L3E755V90za1ZluGdzRCFpYdYy2FZRSSiauKStJPA5wVLpichfLBaKOszias0w/640?wx_fmt=png&quot; data-type=&quot;png&quot; data-w=&quot;2344&quot;/&gt;&lt;/span&gt;&lt;/section&gt;&lt;section&gt;&lt;span&gt;整体的访问消耗平均在1到5毫秒之间，插件开的过多会影响访问的性能，每个插件的功能不同影响的时间不定，最多不超过5毫秒，网关的访问消耗几乎可以忽略不计。单台48核，128G的实体机25000QPS完全没有问题。&lt;/span&gt;&lt;/section&gt;&lt;section&gt;&lt;span&gt;&lt;br/&gt;&lt;/span&gt;&lt;/section&gt;&lt;section&gt;&lt;span&gt;&lt;strong&gt;&lt;span/&gt;&lt;/strong&gt;&lt;/span&gt;&lt;/section&gt;&lt;section&gt;&lt;section powered-by=&quot;xiumi.us&quot;&gt;&lt;section&gt;&lt;section powered-by=&quot;xiumi.us&quot;&gt;&lt;section&gt;&lt;section&gt;&lt;section powered-by=&quot;xiumi.us&quot;&gt;&lt;section&gt;&lt;p&gt;&lt;strong&gt;03&lt;/strong&gt;&lt;/p&gt;&lt;/section&gt;&lt;/section&gt;&lt;/section&gt;&lt;section&gt;&lt;section powered-by=&quot;xiumi.us&quot;&gt;&lt;section&gt;&lt;p&gt;&lt;span&gt;&lt;strong&gt;核心技术&lt;/strong&gt;&lt;/span&gt;&lt;/p&gt;&lt;/section&gt;&lt;/section&gt;&lt;section powered-by=&quot;xiumi.us&quot;&gt;&lt;section&gt;&lt;section&gt;&lt;svg viewbox=&quot;0 0 1 1&quot;/&gt;&lt;/section&gt;&lt;/section&gt;&lt;/section&gt;&lt;/section&gt;&lt;/section&gt;&lt;/section&gt;&lt;/section&gt;&lt;/section&gt;&lt;/section&gt;&lt;section&gt;&lt;strong&gt;&lt;span&gt;Routes（路径)&lt;/span&gt;&lt;/strong&gt;&lt;br/&gt;&lt;/section&gt;&lt;section&gt;&lt;span&gt;路由实体定义规则以匹配客户端的请求。每个 Route 与一个 Service 相关联，一个服务可能有多个与之关联的路由。与给定路由匹配的每个请求都将代理到其关联的 Service 上。可以配置的字段有:hosts，paths，methods，Service 和 Route 的组合（以及它们之间的关注点分离）提供了一种强大的路由机制，通过它可以在 Kong 中定义细粒度的入口点，从而使基础架构路由到不同上游服务。&lt;/span&gt;&lt;/section&gt;&lt;section&gt;&lt;span&gt;&lt;br/&gt;&lt;/span&gt;&lt;/section&gt;&lt;section&gt;&lt;strong&gt;&lt;span&gt;Services（服务)&lt;/span&gt;&lt;/strong&gt;&lt;br/&gt;&lt;/section&gt;&lt;section&gt;&lt;span&gt;服务实体是每个上游服务的抽象。服务的示例是数据转换微服务，计费API等。服务的主要属性是它的 URL（其中，Kong 应该代理流量），其可以被设置为单个串或通过指定其 protocol， host，port 和path。服务与路由相关联（服务可以有许多与之关联的路由）。路由是 Kong 的入口点，并定义匹配客户端请求的规则。一旦匹配路由，Kong 就会将请求代理到其关联的服务。&lt;/span&gt;&lt;/section&gt;&lt;section&gt;&lt;span&gt;&lt;br/&gt;&lt;/span&gt;&lt;/section&gt;&lt;section&gt;&lt;strong&gt;&lt;span&gt;Plugins(插件)&lt;/span&gt;&lt;/strong&gt;&lt;br/&gt;&lt;/section&gt;&lt;section&gt;&lt;span&gt;插件实体表示将在 HTTP请求/响应生命周期 期间执行的插件配置。它是为在 Kong 后面运行的服务添加功能的，例如身份验证或速率限制。将插件配置添加到服务时，客户端向该服务发出的每个请求都将运行所述插件。如果某个特定消费者需要将插件调整为不同的值，你可以通过创建一个单独的插件实例，通过 service 和 consumer 字段指定服务和消费者。&lt;/span&gt;&lt;/section&gt;&lt;section&gt;&lt;span&gt;&lt;br/&gt;&lt;/span&gt;&lt;/section&gt;&lt;section&gt;&lt;strong&gt;&lt;span&gt;Authentication(认证)&lt;/span&gt;&lt;/strong&gt;&lt;br/&gt;&lt;/section&gt;&lt;section&gt;&lt;span&gt;网关的认证方式配合Consumer和ACL 使用，主要有BasicAuth,HMAC,OAuth2等方式。&lt;/span&gt;&lt;/section&gt;&lt;p&gt;&lt;strong&gt;&lt;span&gt;1)BasicAuth：&lt;/span&gt;&lt;/strong&gt;&lt;span/&gt;&lt;span&gt;使用用户名和密码，为你的apis接口集增加基本认证。该插件通过header头中的Authorization信息，校验用户有效认证信息。首先，将用户名密码已 username:password 的格式进行base64加密，例如：用户名为devtest密码为devtest，则加密后的字符串为 base64(devtest:devtest) = ZGV2dGVzdDpkZXZ0ZXN0然后，将加密后的账号信息加到HTTP请求头中进行访问，Header头信息为Authorization: Basic ZGV2dGVzdDpkZXZ0ZXN0&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;strong&gt;&lt;span&gt;2)HMAC：&lt;/span&gt;&lt;/strong&gt;&lt;span/&gt;&lt;span&gt;hmac是Hashing for Message Authentication的简写，可以用来保证数据的完整，客户端把内容通过散列/哈希算法算出一个摘要，并把算法和内容以及摘要传送给服务端，服务端按照这个算法也算一遍，和摘要比一下如果一样就认为内容是完整的，如果不一样就认为内容被篡改了。首先，拿到自己的hmac公钥私钥，然后，通过指定算法计算生成签名最后，将签名及当前时间（GMT格式）分别加入到请求头中，发起请求及签名算法，如下面所示 X-Date: Thu, 06 Dec 2018 11:51:06 GMT Authorization:hmac username=&quot;test&quot;,algorithm=&quot;hmac-sha256&quot;,headers=&quot;X-Date&quot;,signature=&quot;bwksn8/MV6UMhwWv9vD546sUQVxphopgOqoPHVLWBm4=&quot;。&lt;/span&gt;&lt;/p&gt;&lt;section&gt;&lt;span&gt;&lt;br/&gt;&lt;/span&gt;&lt;/section&gt;&lt;section&gt;&lt;span&gt;&lt;strong&gt;&lt;span&gt;代码片段：&lt;/span&gt;&lt;/strong&gt;&lt;/span&gt;&lt;/section&gt;&lt;section class=&quot;code-snippet__fix code-snippet__js&quot;&gt;&lt;pre class=&quot;code-snippet__js&quot; data-lang=&quot;typescript&quot;&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span class=&quot;code-snippet__keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-snippet__keyword&quot;&gt;class&lt;/span&gt; Main {&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt; &lt;span class=&quot;code-snippet__keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-snippet__keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;code-snippet__built_in&quot;&gt;void&lt;/span&gt; main(&lt;span class=&quot;code-snippet__built_in&quot;&gt;String&lt;/span&gt;[] arg) throws Exception {&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;  &lt;span class=&quot;code-snippet__built_in&quot;&gt;String&lt;/span&gt; url = &lt;span class=&quot;code-snippet__string&quot;&gt;&quot;http://dev.test.com&quot;&lt;/span&gt;;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;        &lt;span class=&quot;code-snippet__built_in&quot;&gt;String&lt;/span&gt; username = &lt;span class=&quot;code-snippet__string&quot;&gt;&quot;dev_test&quot;&lt;/span&gt;;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;        &lt;span class=&quot;code-snippet__built_in&quot;&gt;String&lt;/span&gt; secret = &lt;span class=&quot;code-snippet__string&quot;&gt;&quot;dev_test&quot;&lt;/span&gt;;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;        &lt;span class=&quot;code-snippet__built_in&quot;&gt;String&lt;/span&gt; auth = &lt;span class=&quot;code-snippet__string&quot;&gt;&quot;hmac username=\&quot;{1}\&quot;, algorithm=\&quot;hmac-sha256\&quot;, headers=\&quot;X-Date\&quot;, signature=\&quot;{2}\&quot;&quot;&lt;/span&gt;;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;        &lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;  DateFormat dateFormat = &lt;span class=&quot;code-snippet__keyword&quot;&gt;new&lt;/span&gt; SimpleDateFormat(&lt;span class=&quot;code-snippet__string&quot;&gt;&quot;EEE, dd MMM yyyy HH:mm:ss &#x27;GMT&#x27;&quot;&lt;/span&gt;, Locale.US);&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;        dateFormat.setTimeZone(TimeZone.getTimeZone(&lt;span class=&quot;code-snippet__string&quot;&gt;&quot;GMT&quot;&lt;/span&gt;));&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;        &lt;span class=&quot;code-snippet__built_in&quot;&gt;String&lt;/span&gt; now = dateFormat.format(Calendar.getInstance().getTime());&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;        System.out.println(now);&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;   &lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;  &lt;span class=&quot;code-snippet__built_in&quot;&gt;String&lt;/span&gt; hash_string=&lt;span class=&quot;code-snippet__string&quot;&gt;&quot;X-Date: &quot;&lt;/span&gt; + now;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;        &lt;span class=&quot;code-snippet__built_in&quot;&gt;String&lt;/span&gt; signature = Base64.getEncoder().encodeToString(sha256_HMAC(hash_string,secret));&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;        System.out.println(signature);&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;        &lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;  auth = auth.replace(&lt;span class=&quot;code-snippet__string&quot;&gt;&quot;{1}&quot;&lt;/span&gt;,username).replace(&lt;span class=&quot;code-snippet__string&quot;&gt;&quot;{2}&quot;&lt;/span&gt;,signature);&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;        Map&amp;lt;&lt;span class=&quot;code-snippet__built_in&quot;&gt;String&lt;/span&gt;,&lt;span class=&quot;code-snippet__built_in&quot;&gt;String&lt;/span&gt;&amp;gt; headers = &lt;span class=&quot;code-snippet__keyword&quot;&gt;new&lt;/span&gt; HashMap&amp;lt;&amp;gt;();&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;        headers.put(&lt;span class=&quot;code-snippet__string&quot;&gt;&quot;X-Date&quot;&lt;/span&gt;,now);&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;        headers.put(&lt;span class=&quot;code-snippet__string&quot;&gt;&quot;Authorization&quot;&lt;/span&gt;,auth);&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;        &lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;  &lt;span class=&quot;code-snippet__built_in&quot;&gt;String&lt;/span&gt; ret = sendGet(url,&lt;span class=&quot;code-snippet__string&quot;&gt;&quot;&quot;&lt;/span&gt;,headers);   &lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;        System.out.println(ret);&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;    }&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt; &lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;/&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;/&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;/&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;/&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;/&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt; &lt;span class=&quot;code-snippet__keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;code-snippet__keyword&quot;&gt;static&lt;/span&gt; byte[] sha256_HMAC(&lt;span class=&quot;code-snippet__built_in&quot;&gt;String&lt;/span&gt; message, &lt;span class=&quot;code-snippet__built_in&quot;&gt;String&lt;/span&gt; secret) {&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;  &lt;span class=&quot;code-snippet__keyword&quot;&gt;try&lt;/span&gt; {&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;  Mac sha256_HMAC = Mac.getInstance(&lt;span class=&quot;code-snippet__string&quot;&gt;&quot;HmacSHA256&quot;&lt;/span&gt;);&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;            SecretKeySpec secret_key = &lt;span class=&quot;code-snippet__keyword&quot;&gt;new&lt;/span&gt; SecretKeySpec(secret.getBytes(), &lt;span class=&quot;code-snippet__string&quot;&gt;&quot;HmacSHA256&quot;&lt;/span&gt;);&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;            sha256_HMAC.init(secret_key);&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;            &lt;span class=&quot;code-snippet__keyword&quot;&gt;return&lt;/span&gt; sha256_HMAC.doFinal(message.getBytes());&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;          } &lt;span class=&quot;code-snippet__keyword&quot;&gt;catch&lt;/span&gt; (Exception e) {&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;  System.out.println(&lt;span class=&quot;code-snippet__string&quot;&gt;&quot;Error HmacSHA256 ===========&quot;&lt;/span&gt; + e.getMessage());&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;      }&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;  &lt;span class=&quot;code-snippet__keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-snippet__keyword&quot;&gt;new&lt;/span&gt; byte[&lt;span class=&quot;code-snippet__number&quot;&gt;0&lt;/span&gt;];&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;    }&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/section&gt;&lt;section&gt;&lt;span&gt;&lt;strong&gt;3)OAuth2：&lt;/strong&gt;&lt;/span&gt;&lt;span&gt;规定了四种获得令牌的流程。你可以选择最适合自己的那一种，向第三方应用颁发令牌。下面就是这四种授权方式：&lt;/span&gt;&lt;span&gt;&lt;br/&gt;&lt;/span&gt;&lt;/section&gt;&lt;section&gt;&lt;span/&gt;&lt;/section&gt;&lt;ul class=&quot;list-paddingleft-2&quot;&gt;&lt;li&gt;&lt;section&gt;&lt;span&gt;授权码（authorization-code）&lt;/span&gt;&lt;/section&gt;&lt;/li&gt;&lt;li&gt;&lt;section&gt;&lt;span&gt;隐藏式（implicit）&lt;br/&gt;&lt;/span&gt;&lt;/section&gt;&lt;/li&gt;&lt;li&gt;&lt;section&gt;&lt;span&gt;密码式（password）&lt;/span&gt;&lt;/section&gt;&lt;/li&gt;&lt;li&gt;&lt;section&gt;&lt;span&gt;客户端凭证（client credentials）&lt;/span&gt;&lt;/section&gt;&lt;/li&gt;&lt;/ul&gt;&lt;section&gt;&lt;span&gt;注意，不管哪一种授权方式，第三方应用申请令牌之前，都必须先到系统备案，说明自己的身份，然后会拿到两个身份识别码：客户端 ID（client ID）和客户端密钥（client secret）。这是为了防止令牌被滥用，没有备案过的第三方应用，是不会拿到令牌的。&lt;/span&gt;&lt;/section&gt;&lt;section&gt;&lt;span&gt;&lt;br/&gt;&lt;/span&gt;&lt;/section&gt;&lt;section&gt;&lt;strong&gt;&lt;span&gt;Consumer(消费者)&lt;/span&gt;&lt;/strong&gt;&lt;span/&gt;&lt;/section&gt;&lt;section&gt;&lt;span&gt;Consumer 对象表示服务的使用者或者用户。你可以依靠 Kong 作为主数据库存储，也可以将使用者列表与数据库映射，以保持Kong 与现有的主数据存储之间的一致性。&lt;/span&gt;&lt;/section&gt;&lt;section&gt;&lt;span&gt;&lt;br/&gt;&lt;/span&gt;&lt;/section&gt;&lt;section&gt;&lt;strong&gt;&lt;span&gt;Certificate(证书)&lt;/span&gt;&lt;/strong&gt;&lt;span/&gt;&lt;br/&gt;&lt;/section&gt;&lt;section&gt;&lt;span&gt;网关的https证书，一个证书对象代表一个公共证书，可以选择与相应的私钥配对。Kong 使用这些对象来处理加密请求的 SSL/TLS 终止，或在验证客户端/服务的对等证书时用作受信任的 CA 存储。证书可选择与 SNI 对象相关联，以将证书/密钥对绑定到一个或多个主机名。证书既可以被标记，也可以被标记过滤。&lt;/span&gt;&lt;/section&gt;&lt;section&gt;&lt;span&gt;&lt;br/&gt;&lt;/span&gt;&lt;/section&gt;&lt;section&gt;&lt;strong&gt;&lt;span&gt;Upstream(上游)&lt;/span&gt;&lt;/strong&gt;&lt;span/&gt;&lt;br/&gt;&lt;/section&gt;&lt;section&gt;&lt;span&gt;Upstream 对象表示虚拟主机名，可用于通过多个服务（目标）对传入请求进行负载均衡。例如：service.v1.xyz 为 Service 对象命名的上游 Host 是 service.v1.xyz 对此服务的请求将代理到上游定义的目标。&lt;/span&gt;&lt;/section&gt;&lt;section&gt;&lt;span&gt;&lt;br/&gt;&lt;/span&gt;&lt;/section&gt;&lt;section&gt;&lt;strong&gt;&lt;span&gt;Targets(目标)&lt;/span&gt;&lt;/strong&gt;&lt;span/&gt;&lt;br/&gt;&lt;/section&gt;&lt;section&gt;&lt;span&gt;目标 IP地址/主机名，其端口表示后端服务的实例。每个上游都可以有多个 Target，并且可以动态添加 Target。由于上游维护 Target 的更改历史记录，因此无法删除或者修改 Target。要禁用目标，请发布一个新的 Targer weight=0，或者使用 DELETE 来完成相同的操作。&lt;/span&gt;&lt;/section&gt;&lt;section&gt;&lt;span&gt;&lt;br/&gt;&lt;/span&gt;&lt;/section&gt;&lt;section&gt;&lt;strong&gt;&lt;span&gt;Tags(标签)&lt;/span&gt;&lt;/strong&gt;&lt;span/&gt;&lt;br/&gt;&lt;/section&gt;&lt;section&gt;&lt;span&gt;标签是与 Kong 中的实体相关联的字符串。标签几乎可以包含所有 UTF-8 字符，不允许使用不可打印的 ASCII（例如，空格字符）。大多数核心实体可以在创建或编辑时通过它们的属性进行标记tags。&lt;/span&gt;&lt;/section&gt;&lt;section&gt;&lt;span&gt;&lt;br/&gt;&lt;/span&gt;&lt;/section&gt;&lt;section&gt;&lt;section powered-by=&quot;xiumi.us&quot;&gt;&lt;section&gt;&lt;section powered-by=&quot;xiumi.us&quot;&gt;&lt;section&gt;&lt;section&gt;&lt;section powered-by=&quot;xiumi.us&quot;&gt;&lt;section&gt;&lt;p&gt;&lt;strong&gt;04&lt;/strong&gt;&lt;/p&gt;&lt;/section&gt;&lt;/section&gt;&lt;/section&gt;&lt;section&gt;&lt;section powered-by=&quot;xiumi.us&quot;&gt;&lt;section&gt;&lt;p&gt;&lt;strong&gt;818实战&lt;/strong&gt;&lt;/p&gt;&lt;/section&gt;&lt;/section&gt;&lt;section powered-by=&quot;xiumi.us&quot;&gt;&lt;section&gt;&lt;br/&gt;&lt;/section&gt;&lt;/section&gt;&lt;/section&gt;&lt;/section&gt;&lt;/section&gt;&lt;/section&gt;&lt;/section&gt;&lt;/section&gt;&lt;p&gt;&lt;span&gt;&lt;strong&gt;&lt;span&gt;背景：&lt;/span&gt;&lt;/strong&gt;&lt;/span&gt;&lt;span&gt;之家云需承接公司活动期间百万以上的QPS。&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;strong&gt;&lt;span&gt;挑战：&lt;/span&gt;&lt;/strong&gt;&lt;span&gt;大并发的情况，如何保证服务的高可用，面对突增流量如何处理，面对恶意流量如何清洗，等等问题。&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;strong&gt;&lt;span&gt;数据：&lt;/span&gt;&lt;/strong&gt;&lt;span&gt;活动期间大约10W的 QPS，压测需要达到100W。&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;strong&gt;&lt;span&gt;网关支持:&lt;/span&gt;&lt;/strong&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;1.根据单台20000QPS的指标横行扩容机器，如果机器从足的情况建议多加;&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;2.增加备份节点，随时加入集群处理突发情况和流量转移;&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;3.访问API接口尽量配置限速功能，避免源站被打崩；&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;4.数据更新要求实时性不高的增加缓存；&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;5.24小时备战随时处理问题（为了公司拼了）。&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;strong&gt;&lt;span&gt;压测：&lt;/span&gt;&lt;/strong&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;1.共持续了十轮，包括内网和外网压测，对与网关来说是不通集群（建议内网和外网分开搭建物理隔离);&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;2.实测最高QPS近100万，在用户访问不高的时候开发压测;&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;3.遇到的问题：&lt;/span&gt;&lt;/p&gt;&lt;ul class=&quot;list-paddingleft-2&quot;&gt;&lt;li&gt;&lt;section&gt;&lt;span&gt;BODY过大导致数据落盘影响访问数据（解决：增大运行BODY 大小，调整到合理数据，不易过大);&lt;/span&gt;&lt;/section&gt;&lt;/li&gt;&lt;li&gt;&lt;section&gt;&lt;span&gt;日志采集延迟（解决：分集群采集，集中资源处理流量大的接口)；&lt;/span&gt;&lt;/section&gt;&lt;/li&gt;&lt;li&gt;&lt;section&gt;&lt;span&gt;突发流量（解决：随时增加备份机器，开启限流，流量分发，缓存等网关功能);&lt;/span&gt;&lt;/section&gt;&lt;p&gt;&lt;span/&gt;&lt;/p&gt;&lt;p&gt;&lt;span/&gt;&lt;/p&gt;&lt;/li&gt;&lt;/ul&gt;&lt;section&gt;&lt;span/&gt;&lt;strong&gt;&lt;span&gt;活动：&lt;/span&gt;&lt;/strong&gt;&lt;span&gt;近3个小时的活动期间，实测最高QPS近11万，网关层在压测近100万的QPS对与这11万QPS无任何压力，完美的支持了公司活动。&lt;/span&gt;&lt;/section&gt;&lt;section&gt;&lt;span&gt;&lt;br/&gt;&lt;/span&gt;&lt;/section&gt;&lt;section&gt;&lt;section powered-by=&quot;xiumi.us&quot;&gt;&lt;section&gt;&lt;section powered-by=&quot;xiumi.us&quot;&gt;&lt;section&gt;&lt;section&gt;&lt;section powered-by=&quot;xiumi.us&quot;&gt;&lt;section&gt;&lt;p&gt;&lt;strong&gt;05&lt;/strong&gt;&lt;/p&gt;&lt;/section&gt;&lt;/section&gt;&lt;/section&gt;&lt;section&gt;&lt;section powered-by=&quot;xiumi.us&quot;&gt;&lt;section&gt;&lt;p&gt;&lt;strong&gt;后续&lt;/strong&gt;&lt;/p&gt;&lt;/section&gt;&lt;/section&gt;&lt;section powered-by=&quot;xiumi.us&quot;&gt;&lt;section&gt;&lt;br/&gt;&lt;/section&gt;&lt;/section&gt;&lt;/section&gt;&lt;/section&gt;&lt;/section&gt;&lt;/section&gt;&lt;/section&gt;&lt;/section&gt;&lt;section&gt;&lt;span&gt;网关的趋势逐步向服务网关方向发展，目前比较火的像ISTIO, kong也开源了自己的kong mesh.网关对接微服务的需求已经越来越强烈，目前之家云网关通过自研已支持服务发现功能，任重道远继续努力。&lt;/span&gt;&lt;/section&gt;&lt;section&gt;&lt;span&gt;&lt;br/&gt;&lt;/span&gt;&lt;/section&gt;&lt;section&gt;&lt;span&gt;&lt;strong&gt;&lt;span&gt;作者简介&lt;/span&gt;&lt;/strong&gt;&lt;/span&gt;&lt;span/&gt;&lt;/section&gt;&lt;section&gt;&lt;section powered-by=&quot;xiumi.us&quot;&gt;&lt;section&gt;&lt;section powered-by=&quot;xiumi.us&quot;&gt;&lt;section&gt;&lt;section&gt;&lt;section powered-by=&quot;xiumi.us&quot;&gt;&lt;section&gt;&lt;section powered-by=&quot;xiumi.us&quot;&gt;&lt;p&gt;&lt;/p&gt;&lt;/section&gt;&lt;/section&gt;&lt;/section&gt;&lt;/section&gt;&lt;section&gt;&lt;section powered-by=&quot;xiumi.us&quot;&gt;&lt;p&gt;&lt;strong&gt;杨宏岩&lt;/strong&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;任职于云平台部、云开发团队、云开发工程师&lt;/span&gt;&lt;/p&gt;&lt;/section&gt;&lt;/section&gt;&lt;/section&gt;&lt;/section&gt;&lt;/section&gt;&lt;/section&gt;&lt;/section&gt;&lt;section&gt;&lt;span/&gt;&lt;br/&gt;&lt;/section&gt;&lt;p&gt;&lt;img class=&quot;rich_pages wxw-img&quot; data-backh=&quot;70&quot; data-backw=&quot;578&quot; data-galleryid=&quot;&quot; data-ratio=&quot;0.12205882352941176&quot; data-s=&quot;300,640&quot; data-src=&quot;https://mmbiz.qpic.cn/mmbiz_png/UPBmkBoiaVwuibWR4I0wsRej6oayib3BCqcI2rbicKPm5zxJX7LyHpRTdtMu4wYnV2ibopLHc5U095yaj9Jo6avZicFA/640?wx_fmt=png&quot; data-type=&quot;png&quot; data-w=&quot;680&quot;/&gt;&lt;/p&gt;&lt;p&gt;&lt;strong&gt;&lt;span&gt;&lt;br/&gt;&lt;/span&gt;&lt;/strong&gt;&lt;/p&gt;&lt;p&gt;&lt;strong&gt;&lt;span&gt;阅读更多&lt;/span&gt;&lt;/strong&gt;&lt;/p&gt;&lt;p&gt;&lt;/p&gt;&lt;p&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;▼ 关注「&lt;/span&gt;&lt;span&gt;&lt;strong&gt;&lt;span&gt;之家技术&lt;/span&gt;&lt;/strong&gt;&lt;/span&gt;&lt;span&gt;」，获取更多技术干货 &lt;span&gt;▼&lt;/span&gt;&lt;/span&gt;&lt;/p&gt;&lt;section class=&quot;mp_profile_iframe_wrp&quot;&gt;&lt;mpprofile class=&quot;js_uneditable custom_select_card mp_profile_iframe&quot; data-pluginname=&quot;mpprofile&quot; data-id=&quot;MzUyMzg4ODk2NQ==&quot; data-headimg=&quot;http://mmbiz.qpic.cn/mmbiz_png/UPBmkBoiaVwtJNk3Ud6C3Tia5lxlIGA1qXuTib0HZ7jxMRibNJdKMFPdUTtcE9tvDFfp167USdrSzHSlayIQtUtQJA/0?wx_fmt=png&quot; data-nickname=&quot;之家技术&quot; data-alias=&quot;Autohometech&quot; data-signature=&quot;之家技术分享&quot; data-from=&quot;0&quot;/&gt;&lt;/section&gt;&lt;p&gt;&lt;/p&gt;&lt;p&gt;&lt;img class=&quot;rich_pages wxw-img&quot; data-backh=&quot;50&quot; data-backw=&quot;424&quot; data-galleryid=&quot;&quot; data-ratio=&quot;0.11764705882352941&quot; data-s=&quot;300,640&quot; data-src=&quot;https://mmbiz.qpic.cn/mmbiz_png/UPBmkBoiaVwtv7t2blMLl9CXGF5WtibaW8ryFq7fmvc2j7eiaenCCvEoOJaushVjwQIwa8KWPAM6p41I4W5R1Hd5w/640?wx_fmt=png&quot; data-type=&quot;png&quot; data-w=&quot;425&quot;/&gt;&lt;/p&gt;
                &lt;/div&gt;

                

                



                
                &lt;/div&gt;&lt;/div&gt;</content:encoded>
</item>
</channel></rss>