<?xml version="1.0" encoding="UTF-8"?>
        <rss version="2.0" xmlns:content="http://purl.org/rss/1.0/modules/content/">
            <channel>
            <title>开发者头条</title>
            <link>http://toutiao.io/</link>
            <description></description>
<item>
<guid>29933b397fc6852d6515c6824f94755c</guid>
<title>又一个大数据相关项目成为顶级项目</title>
<link>https://toutiao.io/k/pcnig17</link>
<content:encoded>&lt;div&gt;&lt;div&gt;&lt;div class=&quot;rich_media_content &quot; id=&quot;js_content&quot;&gt;
                    

                    

                    
                    
                    &lt;p data-mpa-powered-by=&quot;yiban.io&quot;&gt;2021年01月21日，Apache 官方博客宣布 项目 Apache® Superset™ 成为顶级项目。&lt;/p&gt;&lt;p&gt;&lt;img class=&quot;rich_pages&quot; data-ratio=&quot;0.6006066734074823&quot; data-s=&quot;300,640&quot; data-src=&quot;https://mmbiz.qpic.cn/mmbiz_png/0yBD9iarX0nsaDiaibul7jeGlAdyGmqkUTZHSPoS2VNICT4xTGMFRBYaGxfJkVlEulcZkOMoXYPLpO5Aiczvk6PKPA/640?wx_fmt=png&quot; data-type=&quot;png&quot; data-w=&quot;989&quot;/&gt;&lt;/p&gt;&lt;p&gt;Apache® Superset™ 是一个现代化的大数据探索和可视化平台，它允许用户使用简单的无代码可视化构建器和最先进的 SQL 编辑器轻松快速地构建仪表盘（dashboards）。该项目于2015年在 Airbnb 启动，并于2017年5月进入 Apache 孵化器。说白了，其实 Apache Superset 算是一个大数据相关的 BI 可视化工具。&lt;/p&gt;&lt;p&gt;Apache Superset 主要有以下功能：&lt;/p&gt;&lt;p&gt;&lt;span&gt;&lt;span&gt;•&lt;/span&gt;开箱即用的丰富数据可视化工具；&lt;/span&gt;&lt;span&gt;&lt;span&gt;•&lt;/span&gt;一个易于使用的界面，用于探索和可视化数据；&lt;/span&gt;&lt;span&gt;&lt;span&gt;•&lt;/span&gt;创建和共享仪表盘；&lt;/span&gt;&lt;span&gt;&lt;span&gt;•&lt;/span&gt;与主要身份验证提供商集成的企业级身份验证；&lt;/span&gt;&lt;span&gt;&lt;span&gt;•&lt;/span&gt;一个可扩展的、高粒度的安全/权限模型，允许对任何人进行访问单个特性和数据集制定复杂的控制；&lt;/span&gt;&lt;span&gt;&lt;span&gt;•&lt;/span&gt;一个简单的语义层，允许用户通过定义哪些字段应该显示在哪个下拉列表中，以及向用户提供聚合和功能度量等功能；&lt;/span&gt;&lt;span&gt;&lt;span&gt;•&lt;/span&gt;通过 SQLAlchemy 与绝大多数 RDBMS 集成；&lt;/span&gt;&lt;span&gt;&lt;span&gt;•&lt;/span&gt;和 Druid.io 进行深度整合。&lt;/span&gt;&lt;/p&gt;&lt;p&gt;Superset 是云原生的，具有高可用性。它被设计成可扩展到大型的分布式环境中，并且支持在容器中工作。Apache Superset 支持以下多种数据库：&lt;/p&gt;&lt;p&gt;&lt;img data-src=&quot;https://mmbiz.qpic.cn/mmbiz_jpg/0yBD9iarX0nsaDiaibul7jeGlAdyGmqkUTZaHxl6nibHksK5RfDz8FWfU4sKIdmxAM0C307VBIcMUdY75odvibRjuhQ/640?wx_fmt=jpeg&quot; data-type=&quot;jpeg&quot; data-ratio=&quot;0.3563777994157741&quot; data-w=&quot;1027&quot;/&gt;&lt;/p&gt;&lt;p&gt;Apache Superset 目前在 Airbnb、Netflix、Twitter、Yahoo! 以及国内的去哪儿网、bilibili、快手、豆瓣、VIPKID。完整列表可以参见 &lt;span&gt;Superset Users in the Wild&lt;sup&gt;[2]&lt;/sup&gt;&lt;/span&gt;。&lt;/p&gt;&lt;p&gt;下面是 &lt;span&gt;Apache Superset&lt;/span&gt; 的几张界面图。&lt;/p&gt;&lt;p&gt;&lt;img class=&quot;rich_pages js_insertlocalimg&quot; data-ratio=&quot;0.6125&quot; data-s=&quot;300,640&quot; data-src=&quot;https://mmbiz.qpic.cn/mmbiz_png/0yBD9iarX0nsaDiaibul7jeGlAdyGmqkUTZjISYian3icMOTZm4hia17zDpuQTUfWIkDWCIIdP8ZYEMknsvhBkjxk5eg/640?wx_fmt=png&quot; data-type=&quot;png&quot; data-w=&quot;1280&quot;/&gt;&lt;/p&gt;&lt;p&gt;&lt;/p&gt;&lt;p&gt;&lt;img class=&quot;rich_pages js_insertlocalimg&quot; data-ratio=&quot;0.659375&quot; data-s=&quot;300,640&quot; data-src=&quot;https://mmbiz.qpic.cn/mmbiz_png/0yBD9iarX0nsaDiaibul7jeGlAdyGmqkUTZaxGIMVqVNG8HJtWVPzjv9lC3mkTictzxaVVpPicLooW6drH04DANX5VQ/640?wx_fmt=png&quot; data-type=&quot;png&quot; data-w=&quot;1280&quot;/&gt;&lt;/p&gt;&lt;p&gt;&lt;img class=&quot;rich_pages js_insertlocalimg&quot; data-ratio=&quot;0.66953125&quot; data-s=&quot;300,640&quot; data-src=&quot;https://mmbiz.qpic.cn/mmbiz_png/0yBD9iarX0nsaDiaibul7jeGlAdyGmqkUTZkGIFiaVlkIaD2icJ7Mc3dZWBC8qQmZ8pYtNUZjwkOQMSpTgWPnPsaNTg/640?wx_fmt=png&quot; data-type=&quot;png&quot; data-w=&quot;1280&quot;/&gt;&lt;/p&gt;&lt;p&gt;&lt;img class=&quot;rich_pages js_insertlocalimg&quot; data-ratio=&quot;0.63046875&quot; data-s=&quot;300,640&quot; data-src=&quot;https://mmbiz.qpic.cn/mmbiz_png/0yBD9iarX0nsaDiaibul7jeGlAdyGmqkUTZewgiceIAJTMLln0TdfnuQzOtWAYTwOCVkRb9FLVMSIw7EJSQ9WiaJxUQ/640?wx_fmt=png&quot; data-type=&quot;png&quot; data-w=&quot;1280&quot;/&gt;&lt;/p&gt;&lt;p&gt;更多关于 Apache Superset 可以参见其官方博客：https://superset.apache.org/&lt;/p&gt;&lt;h4&gt;引用链接&lt;/h4&gt;&lt;p&gt;&lt;code&gt;[1]&lt;/code&gt; Apache® Superset™ 成为顶级项目: &lt;em&gt;https://blogs.apache.org/foundation/entry/the-apache-software-foundation-announces70&lt;/em&gt;&lt;br/&gt;&lt;code&gt;[2]&lt;/code&gt; Superset Users in the Wild: &lt;em&gt;https://github.com/apache/superset/blob/master/INTHEWILD.md&lt;/em&gt;&lt;/p&gt;&lt;p&gt;&lt;em&gt;&lt;br/&gt;&lt;/em&gt;&lt;/p&gt;&lt;section&gt;&lt;section&gt;&lt;section&gt;&lt;p&gt;&lt;span&gt;&lt;strong&gt;Java与大数据架构&lt;/strong&gt;&lt;/span&gt;&lt;/p&gt;&lt;/section&gt;&lt;/section&gt;&lt;section&gt;&lt;p&gt;&lt;/p&gt;&lt;/section&gt;&lt;/section&gt;&lt;p&gt;&lt;/p&gt;&lt;section&gt;&lt;section&gt;&lt;section&gt;&lt;section&gt;&lt;p&gt;&lt;span&gt;    7年老码农，10W+关注者。【Java与大数据架构】全面分享Java编程、Spark、Flink、Kafka、Elasticsearch、数据湖等干货。欢迎扫码关注！&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;img data-backh=&quot;53&quot; data-backw=&quot;53&quot; data-cropselx1=&quot;0&quot; data-cropselx2=&quot;261&quot; data-cropsely1=&quot;0&quot; data-cropsely2=&quot;261&quot; data-ratio=&quot;1&quot; data-s=&quot;300,640&quot; data-type=&quot;jpeg&quot; data-w=&quot;258&quot; data-src=&quot;https://mmbiz.qpic.cn/mmbiz_jpg/DicvpKIBbiaxdvguk5d6BgaNvk9mvMnmtickzXEXDx2LanlKMT1GKtSM3PXGXFGBjanYt4pGFT4OF9aQC35ok7nOQ/640?wx_fmt=jpeg&quot;/&gt;&lt;/p&gt;&lt;/section&gt;&lt;/section&gt;&lt;/section&gt;&lt;/section&gt;
                &lt;/div&gt;

                

                



                
                &lt;div class=&quot;reward_qrcode_area reward_area tc&quot; id=&quot;js_reward_qrcode&quot;&gt;
                                &lt;p class=&quot;tips_global&quot;&gt;Long-press QR code to transfer me a reward&lt;/p&gt;
                                                                &lt;p class=&quot;reward_tips&quot;/&gt;
                                &lt;span class=&quot;reward_qrcode_img_wrp&quot;&gt;&lt;img class=&quot;reward_qrcode_img&quot; id=&quot;js_reward_qrcode_img&quot;/&gt;&lt;/span&gt;
                                &lt;p class=&quot;tips_global&quot;&gt;As required by Apple&#x27;s new policy, the Reward feature has been disabled on Weixin for iOS. You can still reward an Official Account by transferring money via QR code.&lt;/p&gt;
                            &lt;/div&gt;
                                                                            
                              
            &lt;/div&gt;&lt;/div&gt;</content:encoded>
</item>
<item>
<guid>949c124a65531f129955049f09614032</guid>
<title>阿里面试官：接口的幂等性怎么设计？</title>
<link>https://toutiao.io/k/411ns26</link>
<content:encoded>&lt;div&gt;&lt;div&gt;&lt;div class=&quot;rich_media_content &quot; id=&quot;js_content&quot;&gt;
                    

                    

                    
                    
                    &lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;点上面👆 &lt;/span&gt;&lt;span&gt;蓝色字体&lt;/span&gt;&lt;span&gt; 关注我呀&lt;/span&gt;&lt;/p&gt;&lt;section data-tool=&quot;mdnice编辑器&quot; data-website=&quot;https://www.mdnice.com&quot;&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;大家好，我是狂聊。&lt;/p&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;自己最近负责的几个接口，都涉及到了幂等性的操作，抽空总结了一下，这也是面试官比较爱问的问题。&lt;/p&gt;&lt;h2 data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span/&gt;&lt;span&gt;一、什么是幂等？&lt;/span&gt;&lt;/h2&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;看一下维基百科怎么说的：&lt;/p&gt;&lt;figure data-tool=&quot;mdnice编辑器&quot;&gt;&lt;img data-ratio=&quot;0.17543859649122806&quot; data-src=&quot;https://mmbiz.qpic.cn/mmbiz_png/RM9eAwLoEFDPRfcekR0DyibxR5rvibL7EEpicqEjz7IQTLteKVtXEbQtFfrTsW6AD2Vh5btetREMWu2CPYibKBj6IA/640?wx_fmt=png&quot; data-type=&quot;png&quot; data-w=&quot;1596&quot;/&gt;&lt;/figure&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;strong&gt;幂等性：&lt;/strong&gt;多次调用方法或者接口不会改变业务状态，可以保证重复调用的结果和单次调用的结果一致。&lt;/p&gt;&lt;h2 data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span/&gt;&lt;span&gt;二、使用幂等的场景&lt;/span&gt;&lt;/h2&gt;&lt;h3 data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span/&gt;&lt;span/&gt;&lt;span&gt;1、前端重复提交&lt;/span&gt;&lt;span/&gt;&lt;/h3&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;用户注册，用户创建商品等操作，前端都会提交一些数据给后台服务，后台需要根据用户提交的数据在数据库中创建记录。如果用户不小心多点了几次，后端收到了好几次提交，这时就会在数据库中重复创建了多条记录。这就是接口没有幂等性带来的 bug。&lt;/p&gt;&lt;h3 data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span/&gt;&lt;span/&gt;&lt;span&gt;2、接口超时重试&lt;/span&gt;&lt;span/&gt;&lt;/h3&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;对于给第三方调用的接口，有可能会因为网络原因而调用失败，这时，一般在设计的时候会对接口调用加上失败重试的机制。如果第一次调用已经执行了一半时，发生了网络异常。这时再次调用时就会因为脏数据的存在而出现调用异常。&lt;/p&gt;&lt;h3 data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span/&gt;&lt;span/&gt;&lt;span&gt;3、消息重复消费&lt;/span&gt;&lt;span/&gt;&lt;/h3&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;在使用消息中间件来处理消息队列，且手动 ack 确认消息被正常消费时。如果消费者突然断开连接，那么已经执行了一半的消息会重新放回队列。&lt;/p&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;当消息被其他消费者重新消费时，如果没有幂等性，就会导致消息重复消费时结果异常，如数据库重复数据，数据库数据冲突，资源重复等。&lt;/p&gt;&lt;h2 data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span/&gt;&lt;span&gt;三、解决方案&lt;/span&gt;&lt;/h2&gt;&lt;h3 data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span/&gt;&lt;span/&gt;&lt;span&gt;1、token 机制实现&lt;/span&gt;&lt;span/&gt;&lt;/h3&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;通过token 机制实现接口的幂等性,这是一种比较通用性的实现方法。&lt;/p&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;示意图如下：&lt;/p&gt;&lt;figure data-tool=&quot;mdnice编辑器&quot;&gt;&lt;img data-ratio=&quot;0.7366946778711485&quot; data-src=&quot;https://mmbiz.qpic.cn/mmbiz_png/RM9eAwLoEFDPRfcekR0DyibxR5rvibL7EEA2lOicfdKOGZdjYBPBmkbIoWoictibiavaALJrn6jCu0LzCibSibgTicBqe0w/640?wx_fmt=png&quot; data-type=&quot;png&quot; data-w=&quot;1428&quot;/&gt;&lt;/figure&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;具体流程步骤：&lt;/p&gt;&lt;ol data-tool=&quot;mdnice编辑器&quot; class=&quot;list-paddingleft-2&quot;&gt;&lt;li&gt;&lt;section&gt;客户端会先发送一个请求去获取 token，服务端会生成一个全局唯一的 ID 作为 token 保存在 redis 中，同时把这个 ID 返回给客户端&lt;/section&gt;&lt;/li&gt;&lt;li&gt;&lt;section&gt;客户端第二次调用业务请求的时候必须携带这个 token&lt;/section&gt;&lt;/li&gt;&lt;li&gt;&lt;section&gt;服务端会校验这个 token，如果校验成功，则执行业务，并删除 redis 中的 token&lt;/section&gt;&lt;/li&gt;&lt;li&gt;&lt;section&gt;如果校验失败，说明 redis 中已经没有对应的 token，则表示重复操作，直接返回指定的结果给客户端&lt;/section&gt;&lt;/li&gt;&lt;/ol&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;注意：&lt;/p&gt;&lt;ol data-tool=&quot;mdnice编辑器&quot; class=&quot;list-paddingleft-2&quot;&gt;&lt;li&gt;&lt;section&gt;对 redis 中是否存在 token 以及删除的代码逻辑建议用 Lua 脚本实现，保证原子性&lt;/section&gt;&lt;/li&gt;&lt;li&gt;&lt;section&gt;全局唯一 ID 可以用百度的 uid-generator、美团的 Leaf 去生成&lt;/section&gt;&lt;/li&gt;&lt;/ol&gt;&lt;h3 data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span/&gt;&lt;span/&gt;&lt;span&gt;2、基于 mysql 实现&lt;/span&gt;&lt;span/&gt;&lt;/h3&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;这种实现方式是利用 mysql 唯一索引的特性。&lt;/p&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;示意图如下：&lt;/p&gt;&lt;figure data-tool=&quot;mdnice编辑器&quot;&gt;&lt;img data-ratio=&quot;0.45917001338688085&quot; data-src=&quot;https://mmbiz.qpic.cn/mmbiz_png/RM9eAwLoEFDPRfcekR0DyibxR5rvibL7EEG0ia0ukcWXHbKX7gVScGVibawJXgFh9FWjJWg89jFgYjCbrwy8An9OTw/640?wx_fmt=png&quot; data-type=&quot;png&quot; data-w=&quot;1494&quot;/&gt;&lt;/figure&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;具体流程步骤：&lt;/p&gt;&lt;ol data-tool=&quot;mdnice编辑器&quot; class=&quot;list-paddingleft-2&quot;&gt;&lt;li&gt;&lt;section&gt;建立一张去重表，其中某个字段需要建立唯一索引&lt;/section&gt;&lt;/li&gt;&lt;li&gt;&lt;section&gt;客户端去请求服务端，服务端会将这次请求的一些信息插入这张去重表中&lt;/section&gt;&lt;/li&gt;&lt;li&gt;&lt;section&gt;因为表中某个字段带有唯一索引，如果插入成功，证明表中没有这次请求的信息，则执行后续的业务逻辑&lt;/section&gt;&lt;/li&gt;&lt;li&gt;&lt;section&gt;如果插入失败，则代表已经执行过当前请求，直接返回&lt;/section&gt;&lt;/li&gt;&lt;/ol&gt;&lt;h3 data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span/&gt;&lt;span/&gt;&lt;span&gt;3、基于 redis 实现&lt;/span&gt;&lt;span/&gt;&lt;/h3&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;这种实现方式是基于 SETNX 命令实现的&lt;/p&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;SETNX key value：将 key 的值设为 value ，当且仅当 key 不存在。若给定的 key 已经存在，则 SETNX 不做任何动作。&lt;/p&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;该命令在设置成功时返回 1，设置失败时返回 0。&lt;/p&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;示意图如下：&lt;/p&gt;&lt;figure data-tool=&quot;mdnice编辑器&quot;&gt;&lt;img data-ratio=&quot;0.4375821287779238&quot; data-src=&quot;https://mmbiz.qpic.cn/mmbiz_png/RM9eAwLoEFDPRfcekR0DyibxR5rvibL7EEPVHpU4KoEBYul9O6CiaUsb3KASGW5SdiaaPebibuygTOBYo03ha5GCxgA/640?wx_fmt=png&quot; data-type=&quot;png&quot; data-w=&quot;1522&quot;/&gt;&lt;/figure&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;具体流程步骤：&lt;/p&gt;&lt;ol data-tool=&quot;mdnice编辑器&quot; class=&quot;list-paddingleft-2&quot;&gt;&lt;li&gt;&lt;section&gt;客户端先请求服务端，会拿到一个能代表这次请求业务的唯一字段&lt;/section&gt;&lt;/li&gt;&lt;li&gt;&lt;section&gt;将该字段以 SETNX 的方式存入 redis 中，并根据业务设置相应的超时时间&lt;/section&gt;&lt;/li&gt;&lt;li&gt;&lt;section&gt;如果设置成功，证明这是第一次请求，则执行后续的业务逻辑&lt;/section&gt;&lt;/li&gt;&lt;li&gt;&lt;section&gt;如果设置失败，则代表已经执行过当前请求，直接返回&lt;/section&gt;&lt;/li&gt;&lt;/ol&gt;&lt;h2 data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span/&gt;&lt;span&gt;总结&lt;/span&gt;&lt;/h2&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;这几种实现幂等的方式其实都是大同小异的，类似的还有使用状态机、悲观锁、乐观锁的方式来实现，都是比较简单的。&lt;/p&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;总之，当你去设计一个接口的时候，幂等都是首要考虑的问题，特别是当你负责设计转账、支付这种涉及到 money 的接口，你要格外注意喽！&lt;/p&gt;&lt;hr data-tool=&quot;mdnice编辑器&quot;/&gt;&lt;blockquote data-tool=&quot;mdnice编辑器&quot;&gt;&lt;p&gt;关注公众号回复 &lt;strong&gt;666&lt;/strong&gt;,领取最新面试资料&lt;/p&gt;&lt;/blockquote&gt;&lt;/section&gt;&lt;section data-support=&quot;96编辑器&quot; data-style-id=&quot;457&quot;&gt;&lt;section data-support=&quot;96编辑器&quot; data-style-id=&quot;24243&quot;&gt;&lt;section&gt;&lt;p data-width=&quot;30%&quot;&gt;&lt;/p&gt;&lt;/section&gt;&lt;/section&gt;&lt;section data-support=&quot;96编辑器&quot; data-style-id=&quot;13029&quot;&gt;&lt;section&gt;&lt;section&gt;&lt;section&gt;&lt;section data-width=&quot;95%&quot;&gt;&lt;section&gt;&lt;section&gt;&lt;section&gt;&lt;section&gt;&lt;br/&gt;&lt;/section&gt;&lt;section&gt;&lt;p&gt;往期精选&lt;/p&gt;&lt;/section&gt;&lt;section&gt;&lt;br/&gt;&lt;/section&gt;&lt;/section&gt;&lt;/section&gt;&lt;/section&gt;&lt;section&gt;&lt;section&gt;&lt;section&gt;&lt;p&gt;&lt;/p&gt;&lt;/section&gt;&lt;/section&gt;&lt;/section&gt;&lt;section&gt;&lt;section&gt;&lt;section data-width=&quot;100%&quot;&gt;&lt;section&gt;&lt;section data-width=&quot;100%&quot;&gt;&lt;section data-width=&quot;18%&quot;&gt;&lt;section&gt;&lt;section&gt;&lt;section&gt;&lt;p&gt;围观&lt;/p&gt;&lt;/section&gt;&lt;/section&gt;&lt;/section&gt;&lt;/section&gt;&lt;section data-width=&quot;67.86%&quot;&gt;&lt;section&gt;&lt;section&gt;&lt;section&gt;&lt;p&gt;&lt;img data-ratio=&quot;1&quot; data-src=&quot;https://mmbiz.qpic.cn/mmbiz_gif/cZkI8M0nbCkKcYoKu5U7GymlsRG3pCttlxO2OZ8v8ze2O1jndGXs7xqBHQwc2Y30uibqtvnCd28f91XCNEUhKew/640?wx_fmt=gif&quot; data-type=&quot;gif&quot; data-w=&quot;100&quot;/&gt;&lt;/p&gt;&lt;p&gt;&lt;a target=&quot;_blank&quot; href=&quot;http://mp.weixin.qq.com/s?__biz=Mzg2NjU1NjE2Ng==&amp;amp;mid=2247484354&amp;amp;idx=1&amp;amp;sn=a0f44d030e29c3ab379d9b08478812dd&amp;amp;chksm=ce4843abf93fcabd2b1ed2234d2d1c3805adc95811196814b69893d0f5806dec68e53a5c3a5c&amp;amp;scene=21#wechat_redirect&quot; textvalue=&quot;我的舍友去面试字节跳动啦&quot; data-itemshowtype=&quot;0&quot; tab=&quot;innerlink&quot; data-linktype=&quot;2&quot;&gt;我的舍友去面试字节跳动啦！&lt;/a&gt;&lt;/p&gt;&lt;/section&gt;&lt;/section&gt;&lt;/section&gt;&lt;/section&gt;&lt;section data-width=&quot;16%&quot;&gt;&lt;section&gt;&lt;section&gt;&lt;section&gt;&lt;p&gt;&lt;/p&gt;&lt;/section&gt;&lt;/section&gt;&lt;/section&gt;&lt;/section&gt;&lt;/section&gt;&lt;/section&gt;&lt;section&gt;&lt;section data-width=&quot;100%&quot;&gt;&lt;section data-width=&quot;18%&quot;&gt;&lt;section&gt;&lt;section&gt;&lt;section&gt;&lt;p&gt;热文&lt;/p&gt;&lt;/section&gt;&lt;/section&gt;&lt;/section&gt;&lt;/section&gt;&lt;section data-width=&quot;67.86%&quot;&gt;&lt;section&gt;&lt;section&gt;&lt;section&gt;&lt;p&gt;&lt;a target=&quot;_blank&quot; href=&quot;http://mp.weixin.qq.com/s?__biz=Mzg2NjU1NjE2Ng==&amp;amp;mid=2247484268&amp;amp;idx=1&amp;amp;sn=b8611f83292077654938b34ae6ee4ebc&amp;amp;chksm=ce484305f93fca13a4ab32362bd6d2e1f64c9268d5961a990ef0103ea3b18380ee9f9b2c3edf&amp;amp;scene=21#wechat_redirect&quot; textvalue=&quot;万字的java垃圾回收，看完必会&quot; data-itemshowtype=&quot;0&quot; tab=&quot;innerlink&quot; data-linktype=&quot;2&quot;&gt;万字的java垃圾回收，看完必会！&lt;/a&gt;&lt;/p&gt;&lt;/section&gt;&lt;/section&gt;&lt;/section&gt;&lt;/section&gt;&lt;section data-width=&quot;14.14%&quot;&gt;&lt;section&gt;&lt;section&gt;&lt;section&gt;&lt;p&gt;&lt;/p&gt;&lt;/section&gt;&lt;/section&gt;&lt;/section&gt;&lt;/section&gt;&lt;/section&gt;&lt;/section&gt;&lt;section&gt;&lt;section data-width=&quot;100%&quot;&gt;&lt;section data-width=&quot;18%&quot;&gt;&lt;section&gt;&lt;section&gt;&lt;section&gt;&lt;p&gt;热文&lt;/p&gt;&lt;/section&gt;&lt;/section&gt;&lt;/section&gt;&lt;/section&gt;&lt;section data-width=&quot;67.86%&quot;&gt;&lt;section&gt;&lt;section&gt;&lt;section&gt;&lt;p&gt;&lt;a target=&quot;_blank&quot; href=&quot;http://mp.weixin.qq.com/s?__biz=Mzg2NjU1NjE2Ng==&amp;amp;mid=2247484286&amp;amp;idx=1&amp;amp;sn=af59f6573a750b6bae3fb2900bfb8d74&amp;amp;chksm=ce484317f93fca01a6606ba119dab9b25c8e1f5e24ee8686c12c7ef54b58d302fd447ebe8284&amp;amp;scene=21#wechat_redirect&quot; textvalue=&quot;Mysql缓存池原理&quot; data-itemshowtype=&quot;0&quot; tab=&quot;innerlink&quot; data-linktype=&quot;2&quot;&gt;面试官：说一说Mysql缓存池原理！&lt;/a&gt;&lt;/p&gt;&lt;/section&gt;&lt;/section&gt;&lt;/section&gt;&lt;/section&gt;&lt;section data-width=&quot;14.14%&quot;&gt;&lt;section&gt;&lt;section&gt;&lt;section&gt;&lt;p&gt;&lt;/p&gt;&lt;/section&gt;&lt;/section&gt;&lt;/section&gt;&lt;/section&gt;&lt;/section&gt;&lt;/section&gt;&lt;section&gt;&lt;section data-width=&quot;100%&quot;&gt;&lt;section data-width=&quot;18%&quot;&gt;&lt;section&gt;&lt;section&gt;&lt;section&gt;&lt;p&gt;热文&lt;/p&gt;&lt;/section&gt;&lt;/section&gt;&lt;/section&gt;&lt;/section&gt;&lt;section data-width=&quot;67.86%&quot;&gt;&lt;section&gt;&lt;section&gt;&lt;section&gt;&lt;p&gt;&lt;a target=&quot;_blank&quot; href=&quot;http://mp.weixin.qq.com/s?__biz=Mzg2NjU1NjE2Ng==&amp;amp;mid=2247483936&amp;amp;idx=1&amp;amp;sn=b4bb5e73e0b97c85453adf0aa93bdcab&amp;amp;chksm=ce484249f93fcb5f6d7de36c8f10569481f3bcc26c000e931800a5eb47123d4f2d01e5f9624c&amp;amp;scene=21#wechat_redirect&quot; textvalue=&quot;jvm基础、类加载机制&quot; data-itemshowtype=&quot;0&quot; tab=&quot;innerlink&quot; data-linktype=&quot;2&quot;&gt;jvm基础、类加载机，还记得吗？&lt;/a&gt;&lt;/p&gt;&lt;/section&gt;&lt;/section&gt;&lt;/section&gt;&lt;/section&gt;&lt;section data-width=&quot;14.14%&quot;&gt;&lt;section&gt;&lt;section&gt;&lt;section&gt;&lt;p&gt;&lt;/p&gt;&lt;/section&gt;&lt;/section&gt;&lt;/section&gt;&lt;/section&gt;&lt;/section&gt;&lt;/section&gt;&lt;/section&gt;&lt;/section&gt;&lt;/section&gt;&lt;/section&gt;&lt;/section&gt;&lt;/section&gt;&lt;/section&gt;&lt;/section&gt;&lt;/section&gt;&lt;section data-support=&quot;96编辑器&quot; data-style-id=&quot;25026&quot;&gt;&lt;section&gt;&lt;section&gt;&lt;section&gt;&lt;section&gt;&lt;section&gt;&lt;section data-width=&quot;30%&quot;&gt;&lt;section&gt;&lt;img data-ratio=&quot;1&quot; data-src=&quot;https://mmbiz.qpic.cn/mmbiz_jpg/RM9eAwLoEFB3DlhpNEm66dUvKr2bNXUrCYvXH9eaF93RF84ZMLvh7L8g2Sndlbywg3aVtlK3XoxfRgHe1Nd0VA/640?wx_fmt=jpeg&quot; data-type=&quot;jpeg&quot; data-w=&quot;258&quot;/&gt;&lt;/section&gt;&lt;/section&gt;&lt;section data-width=&quot;60%&quot;&gt;&lt;p&gt;&lt;span&gt;长按二维码关注我&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;有趣的灵魂在等你&lt;/span&gt;&lt;/p&gt;&lt;section&gt;&lt;p&gt;&lt;span&gt;一个爱看球的程序员&lt;/span&gt;&lt;/p&gt;&lt;/section&gt;&lt;/section&gt;&lt;/section&gt;&lt;/section&gt;&lt;/section&gt;&lt;/section&gt;&lt;/section&gt;&lt;/section&gt;&lt;p&gt;&lt;/p&gt;
                &lt;/div&gt;

                

                



                
                &lt;/div&gt;&lt;/div&gt;</content:encoded>
</item>
<item>
<guid>15e4d92a1faea6f9b2562d7757209405</guid>
<title>来，一起品品 Google 的 Code Review 规范</title>
<link>https://toutiao.io/k/tz4h6d7</link>
<content:encoded>&lt;div&gt;&lt;div&gt;&lt;div class=&quot;rich_media_content &quot; id=&quot;js_content&quot;&gt;
                    

                    

                    
                    
                    &lt;section data-mpa-powered-by=&quot;yiban.io&quot;&gt;&lt;img class=&quot;rich_pages js_insertlocalimg&quot; data-backh=&quot;385&quot; data-backw=&quot;578&quot; data-ratio=&quot;0.66640625&quot; data-s=&quot;300,640&quot; data-src=&quot;https://mmbiz.qpic.cn/mmbiz_jpg/la8s6uvJibdShT7XZDibHsNBQyEp3cVcmp7icgqImlNBbP9ya28E2YBEQeY4wicVtk9ZXI4KyEZichkzt9ggjnzRumA/640?wx_fmt=jpeg&quot; data-type=&quot;jpeg&quot; data-w=&quot;1280&quot;/&gt;&lt;/section&gt;&lt;p&gt;&lt;span&gt;Photo by &lt;/span&gt;&lt;span&gt;Charles Deluvio &lt;/span&gt;&lt;span&gt;on &lt;/span&gt;&lt;span&gt;Unsplash&lt;/span&gt;&lt;/p&gt;&lt;section&gt;&lt;span&gt;说起&lt;/span&gt;&lt;span&gt; Code Review&lt;/span&gt;&lt;span&gt;，即代码评审，从事开发的同学应该不会陌生。我们希望通过代码审查，&lt;span&gt;尽可能在上线前发现潜在的 &lt;/span&gt;&lt;span&gt;bug&lt;/span&gt;&lt;span&gt;，同时让代码更优雅，让项目更易维护。&lt;/span&gt;&lt;/span&gt;&lt;/section&gt;&lt;section&gt;&lt;span&gt;但要做好 &lt;/span&gt;&lt;span&gt;Code Review&lt;/span&gt;&lt;span&gt; 这件事情，是很不容易的。大公司可能会好一些，但其实内部各个团队执行得也是各有千秋。而对于小创业公司，进行 &lt;/span&gt;&lt;span&gt;Code Review&lt;/span&gt;&lt;span&gt;，虽然初衷也是好的，但执行起来往往会心有余而力不足。原因有很多：项目时间赶，团队整体技术实力不够，开发流程不规范，怕 &lt;/span&gt;&lt;span&gt;review &lt;/span&gt;&lt;span&gt;过的代码上线后出 &lt;/span&gt;&lt;span&gt;bug &lt;/span&gt;&lt;span&gt;后&lt;/span&gt;&lt;span&gt;背锅，等等。&lt;/span&gt;&lt;/section&gt;&lt;section&gt;&lt;span&gt;在做 &lt;/span&gt;&lt;span&gt;Code Review &lt;/span&gt;&lt;span&gt;这件事情上，我踩过的坑一个也没有少。后来，不断矫正后，我们也慢慢有了一些规范，如：&lt;/span&gt;&lt;/section&gt;&lt;section&gt;&lt;span&gt;1. &lt;/span&gt;&lt;span&gt;建立 &lt;/span&gt;&lt;span&gt;master&lt;/span&gt;&lt;span&gt; 分支和 &lt;/span&gt;&lt;span&gt;dev&lt;/span&gt;&lt;span&gt; 分支：&lt;/span&gt;&lt;span&gt;master&lt;/span&gt;&lt;span&gt; 用来上线，&lt;/span&gt;&lt;span&gt;dev&lt;/span&gt;&lt;span&gt; 用来做稳定的测试分支；&lt;/span&gt;&lt;/section&gt;&lt;p&gt;&lt;span/&gt;&lt;span&gt;2. &lt;/span&gt;&lt;span&gt;做&lt;/span&gt;&lt;span&gt;新功能，&lt;/span&gt;&lt;span&gt;要新&lt;/span&gt;&lt;span&gt;开 &lt;/span&gt;&lt;span&gt;feature&lt;/span&gt;&lt;span&gt; 分支&lt;/span&gt;&lt;span&gt;；&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;span/&gt;&lt;span&gt;3&lt;/span&gt;&lt;span&gt;. &lt;/span&gt;&lt;span&gt;提交 &lt;/span&gt;&lt;span&gt;PR&lt;/span&gt;&lt;span&gt; 前，先通过代码规范的静态检查和功能点的单元测试；&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;span/&gt;&lt;span&gt;4. &lt;/span&gt;&lt;span&gt;每次提交 &lt;/span&gt;&lt;span&gt;PR &lt;/span&gt;&lt;span&gt;涉及改动的&lt;/span&gt;&lt;span&gt;代码行数要尽量少；&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;5.&lt;/span&gt;&lt;span&gt; 如果 &lt;/span&gt;&lt;span&gt;review &lt;/span&gt;&lt;span&gt;后的代码上线后有 &lt;/span&gt;&lt;span&gt;bug&lt;/span&gt;&lt;span&gt;，责任由团队承担；&lt;br/&gt;&lt;/span&gt;&lt;/p&gt;&lt;section&gt;&lt;span&gt;6. &lt;/span&gt;&lt;span&gt;周报中各写一段自己认为项目中的好代码和烂代码。&lt;/span&gt;&lt;/section&gt;&lt;p&gt;&lt;span&gt;但这些远算不上好的规范。权当抛砖引玉。&lt;/span&gt;&lt;span&gt;我们来看看 &lt;/span&gt;&lt;span&gt;Google&lt;/span&gt;&lt;span&gt; 的 &lt;/span&gt;&lt;span&gt;Code Review&lt;/span&gt;&lt;span&gt; 规范。全文较多，我概括了主要的 &lt;/span&gt;&lt;span&gt;10&lt;/span&gt;&lt;span&gt; 点。&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;以下， &lt;/span&gt;&lt;span&gt;Enjoy&lt;/span&gt;&lt;span&gt; ~&lt;/span&gt;&lt;/p&gt;&lt;section data-mpa-template=&quot;t&quot; mpa-from-tpl=&quot;t&quot;&gt;&lt;section data-mid=&quot;&quot; mpa-from-tpl=&quot;t&quot;&gt;&lt;section data-mid=&quot;&quot; mpa-from-tpl=&quot;t&quot;&gt;&lt;section data-mid=&quot;&quot; mpa-from-tpl=&quot;t&quot;&gt;&lt;img data-backh=&quot;36&quot; data-backw=&quot;258&quot; data-ratio=&quot;0.13953488372093023&quot; data-src=&quot;https://mmbiz.qpic.cn/mmbiz_png/lYDNMgmFjur6mfkPywZNgKZYXia5C4lA8Kd6CUYOibay3HbIfxBnNXH3v6jQZf6QquSL5dt6qYMrtQGh7go67FZg/640?wx_fmt=png&quot; data-type=&quot;png&quot; data-w=&quot;516&quot;/&gt;&lt;/section&gt;&lt;/section&gt;&lt;/section&gt;&lt;/section&gt;&lt;p&gt;&lt;br mpa-from-tpl=&quot;t&quot;/&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;在 &lt;/span&gt;&lt;span&gt;Google&lt;/span&gt;&lt;span&gt;，“&lt;/span&gt;&lt;span&gt;&lt;span&gt;代码审查的主要目的是确保 &lt;/span&gt;&lt;span&gt;Google &lt;/span&gt;&lt;span&gt;代码库的整体代码健康状况随着时间的推移而不断改善。&lt;/span&gt;&lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt;&lt;/p&gt;&lt;section&gt;&lt;span&gt;&lt;span&gt;The primary purpose of code review is to make sure that the overall code health of Google’s code base is improving over time.&lt;/span&gt;&lt;/span&gt;&lt;/section&gt;&lt;p&gt;&lt;strong&gt;&lt;span&gt;1&lt;/span&gt;&lt;span&gt;. 快&lt;/span&gt;&lt;span&gt;速评&lt;/span&gt;&lt;span&gt;审，快速&lt;/span&gt;&lt;span&gt;反馈&lt;/span&gt;&lt;/strong&gt;&lt;/p&gt;&lt;section&gt;&lt;span/&gt;&lt;/section&gt;&lt;section&gt;&lt;section&gt;&lt;span&gt;不要期待完美的代码，只有更好的代码。只要改动的地方&lt;span&gt;确实能够改善&lt;/span&gt;&lt;span&gt;现有系统&lt;/span&gt;，就允许通过。快速响应 &lt;/span&gt;&lt;span&gt;PR&lt;/span&gt;&lt;span&gt;，最迟不要超过 &lt;/span&gt;&lt;span&gt;1 &lt;/span&gt;&lt;span&gt;天。&lt;/span&gt;&lt;/section&gt;&lt;p data-selectable-paragraph=&quot;&quot;&gt;&lt;strong&gt;&lt;span&gt;2. 遵循代码规范&lt;/span&gt;&lt;/strong&gt;&lt;span/&gt;&lt;/p&gt;&lt;p data-selectable-paragraph=&quot;&quot;&gt;&lt;span&gt;变量的命名，注释的格式，制表符和空格的使用等，要满足特定的语言规范。比如 &lt;/span&gt;&lt;span&gt;Java&lt;/span&gt;&lt;span&gt;，&lt;/span&gt;&lt;span&gt;可以参考 &lt;/span&gt;&lt;span&gt;Google&lt;/span&gt;&lt;span&gt; 的 “&lt;/span&gt;&lt;span&gt;Java&lt;/span&gt;&lt;span&gt; 编码最佳实践简要”。国内的可以参考 &lt;/span&gt;&lt;span&gt;Alibaba&lt;/span&gt;&lt;span&gt; 的 “&lt;/span&gt;&lt;span&gt;Java &lt;/span&gt;&lt;span&gt;开发手册”。&lt;/span&gt;&lt;/p&gt;&lt;p data-selectable-paragraph=&quot;&quot;&gt;&lt;strong&gt;&lt;span&gt;3. 合理解决评审中的冲突&lt;/span&gt;&lt;/strong&gt;&lt;span/&gt;&lt;/p&gt;&lt;p data-selectable-paragraph=&quot;&quot;&gt;&lt;span&gt;因为技术背景和认知的差异，代码提交者和评审者难免会对一些改动点产生分歧。这时候就更需要来一次面对面的讨论或视频会议，而不是仅仅通过代码评审注释来解决冲突。&lt;/span&gt;&lt;/p&gt;&lt;p data-selectable-paragraph=&quot;&quot;&gt;&lt;span&gt;如果还不能解决问题，最常见的解决方法就是升级。在一个更大的范围中讨论，让技术主管或更资深的人士参与进来，以寻求决策。&lt;/span&gt;&lt;/p&gt;&lt;p data-selectable-paragraph=&quot;&quot;&gt;&lt;span&gt;原则是：不要因为&lt;span&gt;代码提交者和评审者&lt;/span&gt;不能达成一致，而让一个 &lt;/span&gt;&lt;span&gt;PR &lt;/span&gt;&lt;span&gt;闲坐着。&lt;/span&gt;&lt;/p&gt;&lt;p data-selectable-paragraph=&quot;&quot;&gt;&lt;strong&gt;&lt;span&gt;4.  涉及 &lt;/span&gt;&lt;span&gt;UI&lt;/span&gt;&lt;span&gt; 的改动，要有演示&lt;/span&gt;&lt;/strong&gt;&lt;/p&gt;&lt;p data-selectable-paragraph=&quot;&quot;&gt;&lt;span&gt;如果提交的改动涉及前端 &lt;/span&gt;&lt;span&gt;UI , &lt;/span&gt;&lt;span&gt; 除了进行代码评审之外，还必须进行演示，&lt;/span&gt;&lt;span&gt;以确保所有的视觉效果都符合预期。&lt;/span&gt;&lt;span/&gt;&lt;/p&gt;&lt;p data-selectable-paragraph=&quot;&quot;&gt;&lt;strong&gt;&lt;span&gt;5. 确保每次改动都伴有单元测试&lt;/span&gt;&lt;/strong&gt;&lt;/p&gt;&lt;section&gt;每次 &lt;span&gt;PR&lt;/span&gt; 都应该伴随单元测试，测试用例要设计合理，覆盖周全。&lt;span/&gt;&lt;/section&gt;&lt;section&gt;没有单元测试的代码，无疑是很危险的。如下图所示，一个简单的判断写成了赋值语句，如果没有测试出来，那就出人命了。&lt;/section&gt;&lt;p&gt;&lt;img class=&quot;rich_pages js_insertlocalimg&quot; data-backh=&quot;415&quot; data-backw=&quot;578&quot; data-ratio=&quot;0.7185714285714285&quot; data-s=&quot;300,640&quot; data-src=&quot;https://mmbiz.qpic.cn/mmbiz_jpg/la8s6uvJibdQMxaMccfyAiaSc9quFvfjf5UoF63SpR2xibCcQHqhEgNo7uh5VxagdYZs6mc7bJrk9enbABuxuu27A/640?wx_fmt=jpeg&quot; data-type=&quot;jpeg&quot; data-w=&quot;700&quot;/&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;Test saves lives, From: &lt;/span&gt;&lt;span&gt;Ethan Vincent&lt;/span&gt;&lt;/p&gt;&lt;p data-selectable-paragraph=&quot;&quot;&gt;&lt;strong&gt;&lt;span&gt;6.  当你专注做其他事情的时候，不要打断自己去做代码评审&lt;/span&gt;&lt;/strong&gt;&lt;/p&gt;&lt;p&gt;如果你正在专注于做某一项任务，不要打断自己。因为被打断后可能需要很长时间才能想起被打断前的细节，有时甚至需要重新开始思考。&lt;/p&gt;&lt;p&gt;所以对于评审者而言，专注于在做的事情，可以在某一个 “番茄钟” 后去做代码评审。&lt;/p&gt;&lt;section&gt;&lt;img class=&quot;rich_pages js_insertlocalimg&quot; data-backh=&quot;618&quot; data-backw=&quot;578&quot; data-ratio=&quot;1.0685714285714285&quot; data-s=&quot;300,640&quot; data-src=&quot;https://mmbiz.qpic.cn/mmbiz_png/la8s6uvJibdQMxaMccfyAiaSc9quFvfjf5iaDnfLGn2mr0VicreKPULj6vjgfRqu8nPsyOZ8QEicw8dnajiaDhxEib1Eg/640?wx_fmt=png&quot; data-type=&quot;png&quot; data-w=&quot;700&quot;/&gt;&lt;/section&gt;&lt;p data-selectable-paragraph=&quot;&quot;&gt;&lt;strong&gt;&lt;span&gt;7.  R&lt;/span&gt;&lt;/strong&gt;&lt;strong&gt;&lt;span&gt;eview&lt;/span&gt;&lt;/strong&gt;&lt;strong&gt;&lt;span&gt; 每一行代码，不做假设&lt;/span&gt;&lt;/strong&gt;&lt;/p&gt;&lt;section&gt;检查改动的每一行代码。不要对人工编写的类和方法做任何假设，确保理解每一行代码的作用。&lt;/section&gt;&lt;p&gt;&lt;img class=&quot;rich_pages js_insertlocalimg&quot; data-backh=&quot;373&quot; data-backw=&quot;578&quot; data-ratio=&quot;0.6457142857142857&quot; data-s=&quot;300,640&quot; data-src=&quot;https://mmbiz.qpic.cn/mmbiz_jpg/la8s6uvJibdQMxaMccfyAiaSc9quFvfjf5v3etwqrVGO2L2g4uGmXfu4hoAr0Quey1epe8ticDTGkq4fcmHcy438g/640?wx_fmt=jpeg&quot; data-type=&quot;jpeg&quot; data-w=&quot;700&quot;/&gt;&lt;/p&gt;&lt;section&gt; &lt;span&gt;Don’t make assumptions. From：&lt;/span&gt;&lt;span&gt;MANU&lt;/span&gt;&lt;/section&gt;&lt;section&gt;如果你没有完全理解，那就需要向提交者问清楚。&lt;/section&gt;&lt;section&gt;如果你理解代码，但你觉得不够格做某些部分的评审，确保有合格的评审人员进行评审，特别是对于复杂的问题，如安全性、并发性、可访问性、国际化等。&lt;/section&gt;&lt;p data-selectable-paragraph=&quot;&quot;&gt;&lt;strong&gt;&lt;span&gt;8.  考虑对整体架构的影响&lt;/span&gt;&lt;/strong&gt;&lt;/p&gt;&lt;section&gt;通常，代码审查工具只会显示被更改部分的几行代码。有时，评审者必须查看整个文件，以确保更改确实有意义。比如，你可能只看到添加了 &lt;span&gt;4&lt;/span&gt; 个新行，但当你查看整个文件时，你会看到这 &lt;span&gt;4&lt;/span&gt; 行位于一个 &lt;span&gt;50 &lt;/span&gt;行的方法中，现在确实需要将其分解为更小的方法。&lt;/section&gt;&lt;section&gt;同时还需要考虑提交的改动对整体架构的影响。这个改动是改善了系统的代码健康状况，还是使其更加复杂？不要接受会降低系统代码运行状况的改动。&lt;/section&gt;&lt;section&gt;&lt;span&gt;每一次好的改动，&lt;/span&gt;一点点累积起来，就会产生一个具有最少 &lt;span&gt;bug &lt;/span&gt;数量的优秀产品。同样，随着时间的推移，每次轻微的代码退化，终将导致难以&lt;span&gt;维&lt;/span&gt;&lt;span&gt;护&lt;/span&gt;和难以扩展的代码。&lt;/section&gt;&lt;p data-selectable-paragraph=&quot;&quot;&gt;&lt;strong&gt;&lt;span&gt;9.  遇到好的代码，请不吝赞美&lt;/span&gt;&lt;/strong&gt;&lt;/p&gt;&lt;p data-selectable-paragraph=&quot;&quot;&gt;通常，代码评审只关注错误。但是，&lt;span&gt;代&lt;/span&gt;&lt;span&gt;码评审&lt;/span&gt;的目的不仅仅是发现错误，还应该鼓励和指导开发人员所做的出色工作。&lt;/p&gt;&lt;p data-selectable-paragraph=&quot;&quot;&gt;就指导而言，有时候告诉开发人员他们做对了什么，比告诉他们做错了什么更有价值。&lt;/p&gt;&lt;p data-selectable-paragraph=&quot;&quot;&gt;&lt;strong&gt;&lt;span&gt;10. 保持谦逊，客观&lt;/span&gt;&lt;/strong&gt;&lt;/p&gt;&lt;p data-selectable-paragraph=&quot;&quot;&gt;在代码评审过程中，要清晰、礼貌、尊重他人，同时也要对提交者有帮助。&lt;/p&gt;&lt;p data-selectable-paragraph=&quot;&quot;&gt;在审查代码时，确保是对代码而不是开发人员进行审查，不要用一些攻击性的词。&lt;/p&gt;&lt;p&gt;永远不要说“你”。注释总是可以用 “我们” 作为主题，或者以一种中立的方式用代码作为主题。例如：&lt;/p&gt;&lt;/section&gt;&lt;p&gt;&lt;br mpa-from-tpl=&quot;t&quot;/&gt;&lt;/p&gt;&lt;section data-mpa-template=&quot;t&quot; mpa-from-tpl=&quot;t&quot;&gt;&lt;section data-mid=&quot;&quot; mpa-from-tpl=&quot;t&quot;&gt;&lt;section data-mid=&quot;&quot; mpa-from-tpl=&quot;t&quot;&gt;&lt;section data-mid=&quot;&quot; mpa-from-tpl=&quot;t&quot;&gt;&lt;img data-backh=&quot;37&quot; data-backw=&quot;39&quot; data-ratio=&quot;0.9487179487179487&quot; data-src=&quot;https://mmbiz.qpic.cn/mmbiz_png/TgbFLsELTg9VsY5UyL1tpibPYFCGk06KlL0FYt2yJVEwTtTpTYgicyWUKicbhBVhBbomcwoBa1icbbaKpD6fIhtQ4A/640?wx_fmt=png&quot; data-type=&quot;png&quot; data-w=&quot;78&quot;/&gt;&lt;/section&gt;&lt;/section&gt;&lt;/section&gt;&lt;/section&gt;&lt;p&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;参考文献：&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;https://google.github.io/eng-practices/review/reviewer/looking-for.html&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;https://google.github.io/eng-practices/review/reviewer/standard.html&lt;/span&gt;&lt;/p&gt;
                &lt;/div&gt;

                

                



                
                &lt;/div&gt;&lt;/div&gt;</content:encoded>
</item>
<item>
<guid>a0efd08c78a9f18ab144deab98644739</guid>
<title>Go：基于 GORM 获取当前请求所执行的 SQL 信息</title>
<link>https://toutiao.io/k/a5tn1ue</link>
<content:encoded>&lt;div&gt;&lt;div&gt;&lt;div class=&quot;rich_media_content &quot; id=&quot;js_content&quot;&gt;
                    

                    

                    
                    
                    &lt;section data-tool=&quot;mdnice编辑器&quot; data-website=&quot;https://www.mdnice.com&quot; data-mpa-powered-by=&quot;yiban.io&quot;&gt;&lt;h2 data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span/&gt;&lt;span&gt;前言&lt;/span&gt;&lt;/h2&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;为了便于精准排查问题，需要将当前的请求信息与当前执行的 SQL 信息设置对应关系记录下来，记录的 SQL 信息包括：&lt;/p&gt;&lt;ul data-tool=&quot;mdnice编辑器&quot; class=&quot;list-paddingleft-2&quot;&gt;&lt;li&gt;&lt;section&gt;执行 SQL 的当前时间；&lt;/section&gt;&lt;/li&gt;&lt;li&gt;&lt;section&gt;执行 SQL 的文件地址和行号；&lt;/section&gt;&lt;/li&gt;&lt;li&gt;&lt;section&gt;执行 SQL 的花费时长；&lt;/section&gt;&lt;/li&gt;&lt;li&gt;&lt;section&gt;执行 SQL 的影响行数；&lt;/section&gt;&lt;/li&gt;&lt;li&gt;&lt;section&gt;执行的 SQL 语句；&lt;/section&gt;&lt;/li&gt;&lt;/ul&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;数据库组件使用的是 &lt;code&gt;GORM&lt;/code&gt;。&lt;/p&gt;&lt;h2 data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span/&gt;&lt;span&gt;思路&lt;/span&gt;&lt;/h2&gt;&lt;ul data-tool=&quot;mdnice编辑器&quot; class=&quot;list-paddingleft-2&quot;&gt;&lt;li&gt;&lt;section&gt;1、在执行 SQL 前，设置开始执行时间（计算执行时长会用到）；&lt;/section&gt;&lt;/li&gt;&lt;li&gt;&lt;section&gt;2、在执行 SQL 后，第一，获取当前请求的上下文，为什么获取上下文，因为需要从上下文中获取本次请求信息，第二，获取 SQL 执行前的时间，用来计算执行时长，第三，获取执行的 SQL 信息，然后将数据设置到 &lt;code&gt;Trace&lt;/code&gt; 中，&lt;code&gt;Trace&lt;/code&gt; 是项目中链路包，后面文章会对其介绍；&lt;/section&gt;&lt;/li&gt;&lt;/ul&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;上面需要用到 &lt;code&gt;GORM&lt;/code&gt; 两个 知识点  &lt;code&gt;Callbacks&lt;/code&gt; 和 &lt;code&gt;Context&lt;/code&gt;，这两个是在 &lt;code&gt;GORM V2&lt;/code&gt; 才有的，需要 import 的包为 &lt;code&gt;gorm.io/gorm&lt;/code&gt;。&lt;/p&gt;&lt;h2 data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span/&gt;&lt;span&gt;演示代码&lt;/span&gt;&lt;/h2&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;code&gt;Context&lt;/code&gt; 的传递需要使用 &lt;code&gt;GORM V2&lt;/code&gt; 提供的 &lt;code&gt;WithContext()&lt;/code&gt; 方法。&lt;/p&gt;&lt;pre data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span/&gt;&lt;code&gt;func (u *userRepo) getUserByID(ctx core.Context, id uint) (*user_model.UserDemo, error) {&lt;br/&gt; data := new(user_model.UserDemo)&lt;br/&gt; err := u.db.GetDbR().WithContext(ctx).First(data, id).Error&lt;br/&gt; &lt;span&gt;if&lt;/span&gt; err != nil {&lt;br/&gt;  &lt;span&gt;return&lt;/span&gt; nil, errors.Wrap(err, &lt;span&gt;&quot;[user_demo] get user data err&quot;&lt;/span&gt;)&lt;br/&gt; }&lt;br/&gt; &lt;span&gt;return&lt;/span&gt; data, nil&lt;br/&gt;}&lt;br/&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;编写 &lt;code&gt;CallBacks&lt;/code&gt; 插件代码，GORM 的 Plugin 接口的编写非常简单，只需要实现两个方法即可。&lt;/p&gt;&lt;pre data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span/&gt;&lt;code&gt;// Plugin GORM plugin interface&lt;br/&gt;&lt;span&gt;type&lt;/span&gt; Plugin interface {&lt;br/&gt; Name() string&lt;br/&gt; Initialize(*DB) error&lt;br/&gt;}&lt;br/&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;下面是我写的插件代码：&lt;/p&gt;&lt;pre data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span/&gt;&lt;code&gt;&lt;span&gt;type&lt;/span&gt; TracePlugin struct{}&lt;br/&gt;&lt;br/&gt;func (op *TracePlugin) Name() string {&lt;br/&gt; &lt;span&gt;return&lt;/span&gt; &lt;span&gt;&quot;tracePlugin&quot;&lt;/span&gt;&lt;br/&gt;}&lt;br/&gt;&lt;br/&gt;func (op *TracePlugin) Initialize(db *gorm.DB) (err error) {&lt;br/&gt; // 开始前&lt;br/&gt; _ = db.Callback().Create().Before(&lt;span&gt;&quot;gorm:before_create&quot;&lt;/span&gt;).Register(callBackBeforeName, before)&lt;br/&gt; _ = db.Callback().Query().Before(&lt;span&gt;&quot;gorm:query&quot;&lt;/span&gt;).Register(callBackBeforeName, before)&lt;br/&gt; _ = db.Callback().Delete().Before(&lt;span&gt;&quot;gorm:before_delete&quot;&lt;/span&gt;).Register(callBackBeforeName, before)&lt;br/&gt; _ = db.Callback().Update().Before(&lt;span&gt;&quot;gorm:setup_reflect_value&quot;&lt;/span&gt;).Register(callBackBeforeName, before)&lt;br/&gt; _ = db.Callback().Row().Before(&lt;span&gt;&quot;gorm:row&quot;&lt;/span&gt;).Register(callBackBeforeName, before)&lt;br/&gt; _ = db.Callback().Raw().Before(&lt;span&gt;&quot;gorm:raw&quot;&lt;/span&gt;).Register(callBackBeforeName, before)&lt;br/&gt;&lt;br/&gt; // 结束后&lt;br/&gt; _ = db.Callback().Create().After(&lt;span&gt;&quot;gorm:after_create&quot;&lt;/span&gt;).Register(callBackAfterName, after)&lt;br/&gt; _ = db.Callback().Query().After(&lt;span&gt;&quot;gorm:after_query&quot;&lt;/span&gt;).Register(callBackAfterName, after)&lt;br/&gt; _ = db.Callback().Delete().After(&lt;span&gt;&quot;gorm:after_delete&quot;&lt;/span&gt;).Register(callBackAfterName, after)&lt;br/&gt; _ = db.Callback().Update().After(&lt;span&gt;&quot;gorm:after_update&quot;&lt;/span&gt;).Register(callBackAfterName, after)&lt;br/&gt; _ = db.Callback().Row().After(&lt;span&gt;&quot;gorm:row&quot;&lt;/span&gt;).Register(callBackAfterName, after)&lt;br/&gt; _ = db.Callback().Raw().After(&lt;span&gt;&quot;gorm:raw&quot;&lt;/span&gt;).Register(callBackAfterName, after)&lt;br/&gt; &lt;span&gt;return&lt;/span&gt;&lt;br/&gt;}&lt;br/&gt;&lt;br/&gt;var _ gorm.Plugin = &amp;amp;TracePlugin{}&lt;br/&gt;&lt;br/&gt;func before(db *gorm.DB) {&lt;br/&gt; db.InstanceSet(startTime, time.Now())&lt;br/&gt; &lt;span&gt;return&lt;/span&gt;&lt;br/&gt;}&lt;br/&gt;&lt;br/&gt;func after(db *gorm.DB) {&lt;br/&gt; _ctx := db.Statement.Context&lt;br/&gt; ctx, ok := _ctx.(core.Context)&lt;br/&gt; &lt;span&gt;if&lt;/span&gt; !ok {&lt;br/&gt;  &lt;span&gt;return&lt;/span&gt;&lt;br/&gt; }&lt;br/&gt;&lt;br/&gt; _ts, isExist := db.InstanceGet(startTime)&lt;br/&gt; &lt;span&gt;if&lt;/span&gt; !isExist {&lt;br/&gt;  &lt;span&gt;return&lt;/span&gt;&lt;br/&gt; }&lt;br/&gt;&lt;br/&gt; ts, ok := _ts.(time.Time)&lt;br/&gt; &lt;span&gt;if&lt;/span&gt; !ok {&lt;br/&gt;  &lt;span&gt;return&lt;/span&gt;&lt;br/&gt; }&lt;br/&gt;&lt;br/&gt; sql := db.Dialector.Explain(db.Statement.SQL.String(), db.Statement.Vars...)&lt;br/&gt;&lt;br/&gt; sqlInfo := new(trace.SQL)&lt;br/&gt; sqlInfo.Timestamp = time_parse.CSTLayoutString()&lt;br/&gt; sqlInfo.SQL = sql&lt;br/&gt; sqlInfo.Stack = utils.FileWithLineNum()&lt;br/&gt; sqlInfo.Rows = db.Statement.RowsAffected&lt;br/&gt; sqlInfo.CostSeconds = time.Since(ts).Seconds()&lt;br/&gt; ctx.Trace().AppendSQL(sqlInfo)&lt;br/&gt;&lt;br/&gt; &lt;span&gt;return&lt;/span&gt;&lt;br/&gt;}&lt;br/&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;最后，在 db 连接的时候使用这个插件：&lt;/p&gt;&lt;pre data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span/&gt;&lt;code&gt;// 使用插件&lt;br/&gt;db.Use(&amp;amp;TracePlugin{})&lt;br/&gt;&lt;/code&gt;&lt;/pre&gt;&lt;h2 data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span/&gt;&lt;span&gt;效果&lt;/span&gt;&lt;/h2&gt;&lt;p&gt;&lt;img class=&quot;rich_pages js_insertlocalimg&quot; data-ratio=&quot;0.73671875&quot; data-s=&quot;300,640&quot; data-src=&quot;https://mmbiz.qpic.cn/sz_mmbiz_png/go9jpG3BuhRAwFPhA4o0tzpH6A8B1qwAJqhgWJSzrxeToB4VmibhGvwaqnG8jm32sKDVCYVAhgiclOysXdePZRlw/640?wx_fmt=png&quot; data-type=&quot;png&quot; data-w=&quot;1280&quot;/&gt;&lt;/p&gt;&lt;h2 data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span/&gt;&lt;span&gt;小结&lt;/span&gt;&lt;/h2&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;这是编写的 &lt;code&gt;trace&lt;/code&gt; 包的一部分，这个包可以记录这些信息（JSON 格式）：&lt;/p&gt;&lt;ul data-tool=&quot;mdnice编辑器&quot; class=&quot;list-paddingleft-2&quot;&gt;&lt;li&gt;&lt;section&gt;支持设置 trace_id&lt;/section&gt;&lt;/li&gt;&lt;li&gt;&lt;section&gt;支持设置 request 信息&lt;/section&gt;&lt;/li&gt;&lt;li&gt;&lt;section&gt;支持设置 response 信息&lt;/section&gt;&lt;/li&gt;&lt;li&gt;&lt;section&gt;支持设置 third_party_requests 三方请求信息&lt;/section&gt;&lt;/li&gt;&lt;li&gt;&lt;section&gt;支持设置 debugs 打印调试信息&lt;/section&gt;&lt;/li&gt;&lt;li&gt;&lt;section&gt;支持设置 sqls 执行 SQL 信息&lt;/section&gt;&lt;/li&gt;&lt;li&gt;&lt;section&gt;可记录 cost_seconds 执行时长&lt;/section&gt;&lt;/li&gt;&lt;/ul&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;以上代码在 go-gin-api 项目中，地址：&lt;/p&gt;&lt;section&gt;github.com/xinliangnote/go-gin-api&lt;/section&gt;&lt;/section&gt;&lt;p&gt;&lt;img class=&quot;rich_pages&quot; data-ratio=&quot;0.3649122807017544&quot; data-s=&quot;300,640&quot; data-src=&quot;https://mmbiz.qpic.cn/sz_mmbiz_png/go9jpG3BuhSgPWaHKyJBicNNsuF8w3M8icxO4FapeT1fHQIicegugNFQeaXIn78Sld4zmbvbWHCK0DmqXj1rS5LibA/640?wx_fmt=png&quot; data-type=&quot;png&quot; data-w=&quot;1710&quot;/&gt;&lt;/p&gt;&lt;p&gt;&lt;/p&gt;
                &lt;/div&gt;

                

                



                
                &lt;div class=&quot;reward_qrcode_area reward_area tc&quot; id=&quot;js_reward_qrcode&quot;&gt;
                                &lt;p class=&quot;tips_global&quot;&gt;Long-press QR code to transfer me a reward&lt;/p&gt;
                                                                &lt;p class=&quot;reward_tips&quot;/&gt;
                                &lt;span class=&quot;reward_qrcode_img_wrp&quot;&gt;&lt;img class=&quot;reward_qrcode_img&quot; id=&quot;js_reward_qrcode_img&quot;/&gt;&lt;/span&gt;
                                &lt;p class=&quot;tips_global&quot;&gt;As required by Apple&#x27;s new policy, the Reward feature has been disabled on Weixin for iOS. You can still reward an Official Account by transferring money via QR code.&lt;/p&gt;
                            &lt;/div&gt;
                                                                            
                              
            &lt;/div&gt;&lt;/div&gt;</content:encoded>
</item>
<item>
<guid>736a84544aa8f150e1f559cf634f80c3</guid>
<title>漫画：理解了 TCP 连接的实现以后，客户端的并发也爆发了</title>
<link>https://toutiao.io/k/zvcfkca</link>
<content:encoded>&lt;div&gt;&lt;div&gt;&lt;section data-tool=&quot;mdnice编辑器&quot; data-website=&quot;https://www.mdnice.com&quot; data-mpa-powered-by=&quot;yiban.io&quot;&gt;&lt;p&gt;&lt;img class=&quot;rich_pages js_insertlocalimg&quot; data-ratio=&quot;1.660569105691057&quot; data-s=&quot;300,640&quot; data-src=&quot;https://mmbiz.qpic.cn/mmbiz_png/BBjAFF4hcwo2tuK205q4P1oP54ibPcic4w1YsrKR3kQRdricIiaiaocj2vXVR1OICEeeH2QDLoc1WkJMnUcpufDJNwA/640?wx_fmt=png&quot; data-type=&quot;png&quot; data-w=&quot;492&quot;/&gt;&lt;/p&gt;&lt;pre data-tool=&quot;mdnice编辑器&quot;&gt;&lt;code&gt;&lt;span&gt;echo&lt;/span&gt; &lt;span&gt;&quot;5000 65000&quot;&lt;/span&gt; &amp;gt; /proc/sys/net/ipv4/ip_local_port_range&lt;br/&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;&lt;img class=&quot;rich_pages js_insertlocalimg&quot; data-ratio=&quot;0.6382113821138211&quot; data-s=&quot;300,640&quot; data-src=&quot;https://mmbiz.qpic.cn/mmbiz_png/BBjAFF4hcwo2tuK205q4P1oP54ibPcic4wB2RboLqD9ZSlVEC3Az3EtJNic3hRXicPjJnGq11xNAcmvicJQbuxJ8S3Q/640?wx_fmt=png&quot; data-type=&quot;png&quot; data-w=&quot;492&quot;/&gt;&lt;/p&gt;&lt;ul data-tool=&quot;mdnice编辑器&quot; class=&quot;list-paddingleft-2&quot;&gt;&lt;li&gt;&lt;section&gt;连接1：192.168.1.101 5000 192.168.1.100 8090&lt;/section&gt;&lt;/li&gt;&lt;li&gt;&lt;section&gt;连接2：192.168.1.101 5001 192.168.1.100 8090&lt;/section&gt;&lt;/li&gt;&lt;li&gt;&lt;section&gt;连接N：192.168.1.101 ...  192.168.1.100 8090&lt;/section&gt;&lt;/li&gt;&lt;li&gt;&lt;section&gt;连接6W：192.168.1.101 65000 192.168.1.100 8090&lt;/section&gt;&lt;section&gt;&lt;br/&gt;&lt;/section&gt;&lt;/li&gt;&lt;/ul&gt;&lt;p&gt;&lt;img class=&quot;rich_pages js_insertlocalimg&quot; data-ratio=&quot;0.5630081300813008&quot; data-s=&quot;300,640&quot; data-src=&quot;https://mmbiz.qpic.cn/mmbiz_png/BBjAFF4hcwo2tuK205q4P1oP54ibPcic4wPoBTicLFQwdicQV0S3cicz3LZkXJcfGW0icKlIr61iaIPQXw2FHkR2lxo3A/640?wx_fmt=png&quot; data-type=&quot;png&quot; data-w=&quot;492&quot;/&gt;&lt;/p&gt;&lt;p&gt;&lt;img class=&quot;rich_pages js_insertlocalimg&quot; data-ratio=&quot;0.7987804878048781&quot; data-s=&quot;300,640&quot; data-src=&quot;https://mmbiz.qpic.cn/mmbiz_png/BBjAFF4hcwo2tuK205q4P1oP54ibPcic4w2KxWM3uhXrSZH02ykJRyDyK8JddOoTo9REEbfQl1YCrMx6skXfasSA/640?wx_fmt=png&quot; data-type=&quot;png&quot; data-w=&quot;492&quot;/&gt;&lt;/p&gt;&lt;pre data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span/&gt;&lt;code&gt;//修改整个系统能打开的文件描述符为20W&lt;br/&gt;&lt;span&gt;echo&lt;/span&gt; 200000 &amp;gt; /proc/sys/fs/file-max&lt;br/&gt;&lt;br/&gt;&lt;br/&gt;//修改所有用户每个进程可打开文件描述符为20W&lt;br/&gt;&lt;span&gt;#vi /etc/sysctl.conf&lt;/span&gt;&lt;br/&gt;fs.nr_open=210000&lt;br/&gt;&lt;span&gt;#sysctl -p&lt;/span&gt;&lt;br/&gt;&lt;span&gt;#vi /etc/security/limits.conf&lt;/span&gt;&lt;br/&gt;*  soft  nofile  200000&lt;br/&gt;*  hard  nofile  200000&lt;br/&gt;&lt;/code&gt;&lt;/pre&gt;&lt;blockquote data-tool=&quot;mdnice编辑器&quot;&gt;&lt;p&gt;注意: limits中的hard limit不能超过nr_open, 所以要先改nr_open。而且最好是在sysctl.conf中改。避免重启的时候 hard limit生效了，nr_open不生效导致启动问题。&lt;/p&gt;&lt;/blockquote&gt;&lt;p&gt;&lt;img class=&quot;rich_pages js_insertlocalimg&quot; data-ratio=&quot;1.7656565656565657&quot; data-s=&quot;300,640&quot; data-src=&quot;https://mmbiz.qpic.cn/mmbiz_png/BBjAFF4hcwo2tuK205q4P1oP54ibPcic4wtxezuuponhiaarx0HcNtHyqiahUoNdzfqZH3VQ3dUjL7YyFZNWibEXbfw/640?wx_fmt=png&quot; data-type=&quot;png&quot; data-w=&quot;495&quot;/&gt;&lt;/p&gt;&lt;p&gt;&lt;/p&gt;&lt;p&gt;&lt;/p&gt;&lt;p&gt;&lt;img class=&quot;rich_pages js_insertlocalimg&quot; data-ratio=&quot;1.8988095238095237&quot; data-s=&quot;300,640&quot; data-src=&quot;https://mmbiz.qpic.cn/mmbiz_png/BBjAFF4hcwo2tuK205q4P1oP54ibPcic4w56hIr5oiaicKjoxYapiaRtUzbstDMCOmJkACzRQbtvbrPZeicX9f7F91Yw/640?wx_fmt=png&quot; data-type=&quot;png&quot; data-w=&quot;504&quot;/&gt;&lt;/p&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;“socket中有一个主要的数据结构sock_common，在它里面有两个联合体。”&lt;/p&gt;&lt;pre data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span/&gt;&lt;code&gt;&lt;span&gt;// file: include/net/sock.h&lt;/span&gt;&lt;br/&gt;&lt;span&gt;&lt;span&gt;struct&lt;/span&gt; &lt;span&gt;sock_common&lt;/span&gt; {&lt;/span&gt;&lt;br/&gt; &lt;span&gt;union&lt;/span&gt; {&lt;br/&gt;  __addrpair skc_addrpair; &lt;span&gt;//TCP连接IP对儿 &lt;/span&gt;&lt;br/&gt;  &lt;span&gt;&lt;span&gt;struct&lt;/span&gt; {&lt;/span&gt;&lt;br/&gt;   __be32 skc_daddr;&lt;br/&gt;   __be32 skc_rcv_saddr;&lt;br/&gt;  };&lt;br/&gt; }; &lt;br/&gt; &lt;span&gt;union&lt;/span&gt; {&lt;br/&gt;  __portpair skc_portpair; &lt;span&gt;//TCP连接端口对儿&lt;/span&gt;&lt;br/&gt;  &lt;span&gt;&lt;span&gt;struct&lt;/span&gt; {&lt;/span&gt;&lt;br/&gt;   __be16 skc_dport;&lt;br/&gt;   __u16 skc_num;&lt;br/&gt;  };&lt;br/&gt; };&lt;br/&gt; ......&lt;br/&gt;}&lt;br/&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;“其中skc_addrpair记录的是TCP连接里的IP对儿，skc_portpair记录的是端口对儿。”&lt;/p&gt;&lt;p&gt;&lt;img class=&quot;rich_pages js_insertlocalimg&quot; data-ratio=&quot;0.9899396378269618&quot; data-s=&quot;300,640&quot; data-src=&quot;https://mmbiz.qpic.cn/mmbiz_png/BBjAFF4hcwo2tuK205q4P1oP54ibPcic4wCAic89GSP4NJDX9RnRQxzQQzX9dwe9ic51OJznhiaPtrqKlibxPgKOGdbA/640?wx_fmt=png&quot; data-type=&quot;png&quot; data-w=&quot;497&quot;/&gt;&lt;/p&gt;&lt;p&gt;&lt;img class=&quot;rich_pages js_insertlocalimg&quot; data-cropselx1=&quot;20&quot; data-cropselx2=&quot;507&quot; data-cropsely1=&quot;0&quot; data-cropsely2=&quot;252&quot; data-ratio=&quot;0.4782051282051282&quot; data-s=&quot;300,640&quot; data-src=&quot;https://mmbiz.qpic.cn/mmbiz_png/BBjAFF4hcwo2tuK205q4P1oP54ibPcic4wY2OlI34yDWmVTP7QKVMC3WVRAW2h3aOyRibTEiaEcASy5wzPEbBm8Vuw/640?wx_fmt=png&quot; data-type=&quot;png&quot; data-w=&quot;1560&quot;/&gt;&lt;/p&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;“在网络包到达网卡之后，依次经历DMA、硬中断、软中断等处理，最后被送到socket的接收队列中了。”&lt;/p&gt;&lt;p&gt;&lt;img class=&quot;rich_pages js_insertlocalimg&quot; data-ratio=&quot;0.5174537987679672&quot; data-s=&quot;300,640&quot; data-src=&quot;https://mmbiz.qpic.cn/mmbiz_png/BBjAFF4hcwo2tuK205q4P1oP54ibPcic4w3PRQibX9sxx0S9szM2c4sYXZl1spNHkIlrWz6gveEZibGkU64mvhQCsQ/640?wx_fmt=png&quot; data-type=&quot;png&quot; data-w=&quot;487&quot;/&gt;&lt;/p&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;“对于TCP协议来说，协议处理的入口函数是tcp_v4_rcv。我们看一下它的代码”&lt;/p&gt;&lt;pre data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span/&gt;&lt;code&gt;&lt;span&gt;// file: net/ipv4/tcp_ipv4.c&lt;/span&gt;&lt;br/&gt;&lt;span&gt;&lt;span&gt;int&lt;/span&gt; &lt;span&gt;tcp_v4_rcv&lt;/span&gt;&lt;span&gt;(struct sk_buff *skb)&lt;/span&gt;&lt;br/&gt;&lt;/span&gt;{&lt;br/&gt; ......&lt;br/&gt; th = tcp_hdr(skb); &lt;span&gt;//获取tcp header&lt;/span&gt;&lt;br/&gt; iph = ip_hdr(skb); &lt;span&gt;//获取ip header&lt;/span&gt;&lt;br/&gt;&lt;br/&gt; sk = __inet_lookup_skb(&amp;amp;tcp_hashinfo, skb, th-&amp;gt;source, th-&amp;gt;dest);&lt;br/&gt; ......&lt;br/&gt;}&lt;br/&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;&lt;img class=&quot;rich_pages js_insertlocalimg&quot; data-ratio=&quot;0.33059548254620125&quot; data-s=&quot;300,640&quot; data-src=&quot;https://mmbiz.qpic.cn/mmbiz_png/BBjAFF4hcwo2tuK205q4P1oP54ibPcic4w0ueWaLTHEfSJZx5fCwxr4rJ6qbVMX3hJMCyydcgDE8sbicRxzxSkTsg/640?wx_fmt=png&quot; data-type=&quot;png&quot; data-w=&quot;487&quot;/&gt;&lt;/p&gt;&lt;pre data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span/&gt;&lt;code&gt;&lt;span&gt;// file: include/net/inet_hashtables.h&lt;/span&gt;&lt;br/&gt;&lt;span&gt;static&lt;/span&gt; &lt;span&gt;inline&lt;/span&gt; &lt;span&gt;&lt;span&gt;struct&lt;/span&gt; &lt;span&gt;sock&lt;/span&gt; *__&lt;span&gt;inet_lookup&lt;/span&gt;(&lt;span&gt;struct&lt;/span&gt; &lt;span&gt;net&lt;/span&gt; *&lt;span&gt;net&lt;/span&gt;,&lt;br/&gt;      &lt;span&gt;struct&lt;/span&gt; &lt;span&gt;inet_hashinfo&lt;/span&gt; *&lt;span&gt;hashinfo&lt;/span&gt;,&lt;br/&gt;      &lt;span&gt;const&lt;/span&gt; __&lt;span&gt;be32&lt;/span&gt; &lt;span&gt;saddr&lt;/span&gt;, &lt;span&gt;const&lt;/span&gt; __&lt;span&gt;be16&lt;/span&gt; &lt;span&gt;sport&lt;/span&gt;,&lt;br/&gt;      &lt;span&gt;const&lt;/span&gt; __&lt;span&gt;be32&lt;/span&gt; &lt;span&gt;daddr&lt;/span&gt;, &lt;span&gt;const&lt;/span&gt; __&lt;span&gt;be16&lt;/span&gt; &lt;span&gt;dport&lt;/span&gt;,&lt;br/&gt;      &lt;span&gt;const&lt;/span&gt; &lt;span&gt;int&lt;/span&gt; &lt;span&gt;dif&lt;/span&gt;)&lt;br/&gt;{&lt;/span&gt;&lt;br/&gt; u16 hnum = ntohs(dport);&lt;br/&gt; &lt;span&gt;&lt;span&gt;struct&lt;/span&gt; &lt;span&gt;sock&lt;/span&gt; *&lt;span&gt;sk&lt;/span&gt; = __&lt;span&gt;inet_lookup_established&lt;/span&gt;(&lt;span&gt;net&lt;/span&gt;, &lt;span&gt;hashinfo&lt;/span&gt;,&lt;br/&gt;    &lt;span&gt;saddr&lt;/span&gt;, &lt;span&gt;sport&lt;/span&gt;, &lt;span&gt;daddr&lt;/span&gt;, &lt;span&gt;hnum&lt;/span&gt;, &lt;span&gt;dif&lt;/span&gt;);&lt;/span&gt;&lt;br/&gt;&lt;br/&gt; &lt;span&gt;return&lt;/span&gt; sk ? : __inet_lookup_listener(net, hashinfo, saddr, sport,&lt;br/&gt;          daddr, hnum, dif);&lt;br/&gt;}&lt;br/&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;“先判断有没有连接状态的socket，这会走到__inet_lookup_established函数中”&lt;/p&gt;&lt;pre data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span/&gt;&lt;code&gt;&lt;span&gt;&lt;span&gt;struct&lt;/span&gt; &lt;span&gt;sock&lt;/span&gt; *__&lt;span&gt;inet_lookup_established&lt;/span&gt;(&lt;span&gt;struct&lt;/span&gt; &lt;span&gt;net&lt;/span&gt; *&lt;span&gt;net&lt;/span&gt;,&lt;br/&gt;      &lt;span&gt;struct&lt;/span&gt; &lt;span&gt;inet_hashinfo&lt;/span&gt; *&lt;span&gt;hashinfo&lt;/span&gt;,&lt;br/&gt;      &lt;span&gt;const&lt;/span&gt; __&lt;span&gt;be32&lt;/span&gt; &lt;span&gt;saddr&lt;/span&gt;, &lt;span&gt;const&lt;/span&gt; __&lt;span&gt;be16&lt;/span&gt; &lt;span&gt;sport&lt;/span&gt;,&lt;br/&gt;      &lt;span&gt;const&lt;/span&gt; __&lt;span&gt;be32&lt;/span&gt; &lt;span&gt;daddr&lt;/span&gt;, &lt;span&gt;const&lt;/span&gt; &lt;span&gt;u16&lt;/span&gt; &lt;span&gt;hnum&lt;/span&gt;,&lt;br/&gt;      &lt;span&gt;const&lt;/span&gt; &lt;span&gt;int&lt;/span&gt; &lt;span&gt;dif&lt;/span&gt;)&lt;br/&gt;{&lt;/span&gt;&lt;br/&gt; &lt;span&gt;//将源端口、目的端口拼成一个32位int整数&lt;/span&gt;&lt;br/&gt; &lt;span&gt;const&lt;/span&gt; __portpair ports = INET_COMBINED_PORTS(sport, hnum); &lt;br/&gt; ......&lt;br/&gt;&lt;br/&gt; &lt;span&gt;//内核用hash的方法加速socket的查找&lt;/span&gt;&lt;br/&gt; &lt;span&gt;unsigned&lt;/span&gt; &lt;span&gt;int&lt;/span&gt; hash = inet_ehashfn(net, daddr, hnum, saddr, sport); &lt;br/&gt; &lt;span&gt;unsigned&lt;/span&gt; &lt;span&gt;int&lt;/span&gt; slot = hash &amp;amp; hashinfo-&amp;gt;ehash_mask;&lt;br/&gt; &lt;span&gt;&lt;span&gt;struct&lt;/span&gt; &lt;span&gt;inet_ehash_bucket&lt;/span&gt; *&lt;span&gt;head&lt;/span&gt; = &amp;amp;&lt;span&gt;hashinfo&lt;/span&gt;-&amp;gt;&lt;span&gt;ehash&lt;/span&gt;[&lt;span&gt;slot&lt;/span&gt;];&lt;/span&gt;&lt;br/&gt;&lt;br/&gt;begin:&lt;br/&gt; &lt;span&gt;//遍历链表，逐个对比直到找到&lt;/span&gt;&lt;br/&gt; sk_nulls_for_each_rcu(sk, node, &amp;amp;head-&amp;gt;chain) {&lt;br/&gt;  &lt;span&gt;if&lt;/span&gt; (sk-&amp;gt;sk_hash != hash)&lt;br/&gt;   &lt;span&gt;continue&lt;/span&gt;;&lt;br/&gt;  &lt;span&gt;if&lt;/span&gt; (likely(INET_MATCH(sk, net, acookie,&lt;br/&gt;          saddr, daddr, ports, dif))) {&lt;br/&gt;   &lt;span&gt;if&lt;/span&gt; (unlikely(!atomic_inc_not_zero(&amp;amp;sk-&amp;gt;sk_refcnt)))&lt;br/&gt;    &lt;span&gt;goto&lt;/span&gt; begintw;&lt;br/&gt;   &lt;span&gt;if&lt;/span&gt; (unlikely(!INET_MATCH(sk, net, acookie,&lt;br/&gt;       saddr, daddr, ports, dif))) {&lt;br/&gt;    sock_put(sk);&lt;br/&gt;    &lt;span&gt;goto&lt;/span&gt; begin;&lt;br/&gt;   }&lt;br/&gt;   &lt;span&gt;goto&lt;/span&gt; out;&lt;br/&gt;  }&lt;br/&gt; }&lt;br/&gt;}&lt;br/&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;&lt;img class=&quot;rich_pages js_insertlocalimg&quot; data-cropselx1=&quot;0&quot; data-cropselx2=&quot;487&quot; data-cropsely1=&quot;0&quot; data-cropsely2=&quot;241&quot; data-ratio=&quot;0.4948665297741273&quot; data-s=&quot;300,640&quot; data-src=&quot;https://mmbiz.qpic.cn/mmbiz_png/BBjAFF4hcwo2tuK205q4P1oP54ibPcic4wqZJjg15BNOnAmV87cWCwOKuTnKibSpXicKuc49CZWj8gtcxVTM33Oib7A/640?wx_fmt=png&quot; data-type=&quot;png&quot; data-w=&quot;487&quot;/&gt;&lt;/p&gt;&lt;pre data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span/&gt;&lt;code&gt;&lt;span&gt;// include/net/inet_hashtables.h&lt;/span&gt;&lt;br/&gt;&lt;span&gt;#&lt;span&gt;define&lt;/span&gt; INET_MATCH(__sk, __net, __cookie, __saddr, __daddr, __ports, __dif) \&lt;br/&gt; ((inet_sk(__sk)-&amp;gt;inet_portpair == (__ports)) &amp;amp;&amp;amp;  \&lt;br/&gt;  (inet_sk(__sk)-&amp;gt;inet_daddr == (__saddr)) &amp;amp;&amp;amp;  \&lt;br/&gt;  (inet_sk(__sk)-&amp;gt;inet_rcv_saddr == (__daddr)) &amp;amp;&amp;amp;  \&lt;br/&gt;  (!(__sk)-&amp;gt;sk_bound_dev_if ||    \&lt;br/&gt;    ((__sk)-&amp;gt;sk_bound_dev_if == (__dif)))  &amp;amp;&amp;amp;  \&lt;br/&gt;  net_eq(sock_net(__sk), (__net)))&lt;/span&gt;&lt;br/&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;“在INET_MATCH中将网络包tcp header中的__saddr、__daddr、__ports和Linux中的socket中inet_portpair、inet_daddr、inet_rcv_saddr进行对比。如果匹配socket就找到了。当然除了ip和端口，INET_MATCH还比较了其它一些东东，所以TCP还有五元组、七元组之类的说法。”&lt;/p&gt;&lt;p&gt;&lt;/p&gt;&lt;p&gt;&lt;img class=&quot;rich_pages js_insertlocalimg&quot; data-ratio=&quot;2.83030303030303&quot; data-s=&quot;300,640&quot; data-src=&quot;https://mmbiz.qpic.cn/mmbiz_png/BBjAFF4hcwo2tuK205q4P1oP54ibPcic4w3bE0aANmtUKfKxqsWqesnNssj239RYIRPOrH4XqEnTGgLRKsIgoqRg/640?wx_fmt=png&quot; data-type=&quot;png&quot; data-w=&quot;495&quot;/&gt;&lt;/p&gt;&lt;pre data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span/&gt;&lt;code&gt;&lt;span&gt;# cat /etc/redhat-release&lt;/span&gt;&lt;br/&gt;Red Hat Enterprise Linux Server release 6.2 (Santiago)&lt;br/&gt;&lt;br/&gt;&lt;span&gt;# ss -ant | grep ESTAB |wc -l&lt;/span&gt;&lt;br/&gt;1000013&lt;br/&gt;&lt;br/&gt;&lt;span&gt;# cat /proc/meminfo&lt;/span&gt;&lt;br/&gt;MemTotal:        3925408 kB&lt;br/&gt;MemFree:           97748 kB&lt;br/&gt;Buffers:           35412 kB&lt;br/&gt;Cached:           119600 kB&lt;br/&gt;......&lt;br/&gt;Slab:            3241528 kB&lt;br/&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;&lt;img class=&quot;rich_pages js_insertlocalimg&quot; data-cropselx1=&quot;42&quot; data-cropselx2=&quot;537&quot; data-cropsely1=&quot;0&quot; data-cropsely2=&quot;1401&quot; data-ratio=&quot;0.4188679245283019&quot; data-s=&quot;300,640&quot; data-src=&quot;https://mmbiz.qpic.cn/mmbiz_png/BBjAFF4hcwo2tuK205q4P1oP54ibPcic4w2CJPquFrLD9t10ll5P3yb7cibjbra5WLZFDzgOFTdO9OyRJhcJZdTiaw/640?wx_fmt=png&quot; data-type=&quot;png&quot; data-w=&quot;795&quot;/&gt;&lt;/p&gt;&lt;p&gt;&lt;/p&gt;&lt;p&gt;&lt;img class=&quot;rich_pages js_insertlocalimg&quot; data-ratio=&quot;0.503030303030303&quot; data-s=&quot;300,640&quot; data-src=&quot;https://mmbiz.qpic.cn/mmbiz_png/BBjAFF4hcwo2tuK205q4P1oP54ibPcic4wcwJSevTl1BCk8S0th51z9hq8GeesiaaGYJWsdTzibYgWofRUkwH3X7PQ/640?wx_fmt=png&quot; data-type=&quot;png&quot; data-w=&quot;495&quot;/&gt;&lt;/p&gt;&lt;p&gt;&lt;/p&gt;&lt;p&gt;&lt;/p&gt;&lt;h2 data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span/&gt;&lt;span&gt;总结&lt;/span&gt;&lt;br/&gt;&lt;/h2&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;客户端每建立一个连接就要消耗一个端口，所以很多同学当看到客户端机器上连接数一旦超过3W、5W就紧张的不行，总觉得机器要出问题了。&lt;/p&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;这篇文章的第一版也是很早就写出来了，不过飞哥又打磨了好长时间才算满意。在文中我们展示了一下 TCP socket的部分内核代码。通过源码来看：&lt;/p&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;strong&gt;TCP连接就是在客户机、服务器上的一对儿的socket。它们都在各自内核对象上记录了双方的ip对儿、端口对儿（也就是我们常说的四元组），通过这个在通信时找到对方。&lt;/strong&gt;&lt;/p&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;TCP连接发送方在发送网络包的时候，会把这份信息复制到IP Header上。网络包带着这份信物穿过互联网，到达目的服务器。目的服务器内核会按照 IP 包 header 中携带的信物（四元组）去匹配找到正确的socket(连接)。&lt;/p&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;在这个过程里我们可以看到，客户端的端口只是这个四元组里的一元而已。哪怕两条连接用的是同一个端口号，只要客户端ip不一样，或者是服务器不一样都不影响内核正确寻找到对应的连接，而不会串线！&lt;/p&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;所以在客户端增加TCP最大并发能力有两个方法。第一个办法，为客户端配置多个ip。第二个办法，连接多个不同的server。&lt;/p&gt;&lt;blockquote data-tool=&quot;mdnice编辑器&quot;&gt;&lt;p&gt;不过这两个办法最好不要混用。因为使用多 IP 时，客户端需要bind。一旦bind之后，内核建立连接的时候就不会选择用过的端口了。bind函数会改变内核选择端口的策略~~&lt;/p&gt;&lt;/blockquote&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;最后我们亲手实验证明了客户端也可以突破百万的并发量级。相信读过此文的你，以后再也不用再惧怕65535这个数字了。&lt;/p&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;/p&gt;&lt;/section&gt;&lt;/div&gt;&lt;/div&gt;</content:encoded>
</item>
</channel></rss>