<?xml version="1.0" encoding="UTF-8"?>
        <rss version="2.0" xmlns:content="http://purl.org/rss/1.0/modules/content/">
            <channel>
            <title>开发者头条</title>
            <link>http://toutiao.io/</link>
            <description></description>
<item>
<guid>a4f521b7114859d90000b85d25539d6c</guid>
<title>Kubernetes CKA 证书备考笔记</title>
<link>https://toutiao.io/k/0iresk6</link>
<content:encoded>&lt;div&gt;&lt;div&gt;&lt;div class=&quot;rich_media_content &quot; id=&quot;js_content&quot;&gt;
                    

                    
                    
                    
                    &lt;figure&gt;&lt;span&gt;Kubernetes 使用有好几年了，但在今年 5 月才完成 CKA 的考试。虽说用了几年，还是提前刷了部分题熟悉下。&lt;/span&gt;&lt;br/&gt;&lt;/figure&gt;&lt;p&gt;绝大部分题都是有在 minikube 的环境上操作过，只有部分比如升级集群受限于环境问题没有实地操作。&lt;/p&gt;&lt;h2&gt;写在最前&lt;/h2&gt;&lt;p&gt;&lt;span&gt;&lt;span&gt;1.&lt;/span&gt;保存常用文档进书签，如果有 Alfred 启用浏览器书签 workflow。效果见下图&lt;/span&gt;&lt;span&gt;&lt;span&gt;2.&lt;/span&gt;kubectl 自动补全 &lt;code&gt;echo &quot;source &amp;lt;(kubectl completion bash)&quot; &amp;gt;&amp;gt; ~/.bashrc; source ~/.bashrc&lt;/code&gt;&lt;/span&gt;&lt;span&gt;&lt;span&gt;3.&lt;/span&gt;每道题开始前要切换 context 和 namespace，直接复制题目里的命令即可&lt;/span&gt;&lt;span&gt;&lt;span&gt;4.&lt;/span&gt;必要的 alias&lt;/span&gt;&lt;span&gt;&lt;span&gt;5.&lt;/span&gt;善用 &lt;code&gt;--dry-run=client -o yaml&lt;/code&gt; 避免手动敲太多&lt;/span&gt;&lt;span&gt;&lt;span&gt;6.&lt;/span&gt;善用 &lt;code&gt;kubectl explain [resource[.field]]&lt;/code&gt;&lt;/span&gt;&lt;span&gt;&lt;span&gt;7.&lt;/span&gt;看懂题目最重要，输出正确的结果更重要（重要的事讲三遍）&lt;/span&gt;&lt;span&gt;&lt;span&gt;8.&lt;/span&gt;看懂题目最重要，输出正确的结果更重要（重要的事讲三遍）&lt;/span&gt;&lt;span&gt;&lt;span&gt;9.&lt;/span&gt;看懂题目最重要，输出正确的结果更重要（重要的事讲三遍）&lt;/span&gt;&lt;/p&gt;&lt;p&gt;书签地址：&lt;span&gt;K8s-CKA-CAKD-Bookmarks.html&lt;sup&gt;[1]&lt;/sup&gt;&lt;/span&gt;&lt;/p&gt;&lt;figure&gt;&lt;img data-ratio=&quot;0.4895666131621188&quot; data-src=&quot;https://mmbiz.qpic.cn/mmbiz_png/tMghG0NOfxePhCYHSQbXMWDL5RIdib1Xnm6plbEd3dyxLFNricXQxa4gjvicyxJuyicFKia7PrCibl6QQgYjcpgD4vuA/640?wx_fmt=png&quot; data-type=&quot;png&quot; data-w=&quot;623&quot; title=&quot;null&quot;/&gt;&lt;figcaption&gt;alfred-bookmarks-workflow&lt;/figcaption&gt;&lt;/figure&gt;&lt;h2&gt;安全：RBAC&lt;/h2&gt;&lt;blockquote&gt;&lt;p&gt;在默认命名空间中创建一个名为 dev-sa 的服务帐户，dev-sa 可以在 dev 命名空间中创建以下组件： &lt;code&gt;Deployment&lt;/code&gt;、&lt;code&gt;StatefulSet&lt;/code&gt;、&lt;code&gt;DaemonSet&lt;/code&gt;&lt;/p&gt;&lt;/blockquote&gt;&lt;h3&gt;知识点&lt;/h3&gt;&lt;p&gt;&lt;span&gt;&lt;span&gt;•&lt;/span&gt;role&lt;/span&gt;&lt;span&gt;&lt;span&gt;•&lt;/span&gt;sa&lt;/span&gt;&lt;span&gt;&lt;span&gt;•&lt;/span&gt;rolebinding&lt;/span&gt;&lt;span&gt;&lt;span&gt;•&lt;/span&gt;auth can-i&lt;/span&gt;&lt;/p&gt;&lt;p&gt;参考文档： https://kubernetes.io/docs/reference/access-authn-authz/rbac/#command-line-utilities&lt;/p&gt;&lt;h3&gt;解题思路&lt;/h3&gt;&lt;section class=&quot;code-snippet__github&quot;&gt;&lt;pre data-lang=&quot;shell&quot;&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;$ kubectl create sa dev&lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;sa&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;$ kubectl create role dev&lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;role &lt;/span&gt;&lt;span&gt;--&lt;/span&gt;&lt;span&gt;verb&lt;/span&gt;&lt;span&gt;=&lt;/span&gt;&lt;span&gt;create &lt;/span&gt;&lt;span&gt;--&lt;/span&gt;&lt;span&gt;resource&lt;/span&gt;&lt;span&gt;=&lt;/span&gt;&lt;span&gt;deployment&lt;/span&gt;&lt;span&gt;,&lt;/span&gt;&lt;span&gt;statefulset&lt;/span&gt;&lt;span&gt;,&lt;/span&gt;&lt;span&gt;daemonset&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;#检查&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;$ kubectl describe role dev&lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;role&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;Name&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;span&gt;         dev&lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;role&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;Labels&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;span&gt;       &lt;/span&gt;&lt;span&gt;&amp;lt;none&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;Annotations&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;span&gt;  &lt;/span&gt;&lt;span&gt;&amp;lt;none&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;PolicyRule&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;  &lt;/span&gt;&lt;span&gt;Resources&lt;/span&gt;&lt;span&gt;          &lt;/span&gt;&lt;span&gt;Non&lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;Resource&lt;/span&gt;&lt;span&gt; &lt;/span&gt;&lt;span&gt;URLs&lt;/span&gt;&lt;span&gt;  &lt;/span&gt;&lt;span&gt;Resource&lt;/span&gt;&lt;span&gt; &lt;/span&gt;&lt;span&gt;Names&lt;/span&gt;&lt;span&gt;  &lt;/span&gt;&lt;span&gt;Verbs&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;  &lt;/span&gt;&lt;span&gt;---------&lt;/span&gt;&lt;span&gt;          &lt;/span&gt;&lt;span&gt;-----------------&lt;/span&gt;&lt;span&gt;  &lt;/span&gt;&lt;span&gt;--------------&lt;/span&gt;&lt;span&gt;  &lt;/span&gt;&lt;span&gt;-----&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;  daemonsets&lt;/span&gt;&lt;span&gt;.&lt;/span&gt;&lt;span&gt;apps    &lt;/span&gt;&lt;span&gt;[]&lt;/span&gt;&lt;span&gt;                 &lt;/span&gt;&lt;span&gt;[]&lt;/span&gt;&lt;span&gt;              &lt;/span&gt;&lt;span&gt;[&lt;/span&gt;&lt;span&gt;create&lt;/span&gt;&lt;span&gt;]&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;  deployments&lt;/span&gt;&lt;span&gt;.&lt;/span&gt;&lt;span&gt;apps   &lt;/span&gt;&lt;span&gt;[]&lt;/span&gt;&lt;span&gt;                 &lt;/span&gt;&lt;span&gt;[]&lt;/span&gt;&lt;span&gt;              &lt;/span&gt;&lt;span&gt;[&lt;/span&gt;&lt;span&gt;create&lt;/span&gt;&lt;span&gt;]&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;  statefulsets&lt;/span&gt;&lt;span&gt;.&lt;/span&gt;&lt;span&gt;apps  &lt;/span&gt;&lt;span&gt;[]&lt;/span&gt;&lt;span&gt;                 &lt;/span&gt;&lt;span&gt;[]&lt;/span&gt;&lt;span&gt;              &lt;/span&gt;&lt;span&gt;[&lt;/span&gt;&lt;span&gt;create&lt;/span&gt;&lt;span&gt;]&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code/&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;$ kubectl create rolebinding dev &lt;/span&gt;&lt;span&gt;--&lt;/span&gt;&lt;span&gt;serviceaccount &lt;/span&gt;&lt;span&gt;default&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;span&gt;dev&lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;sa &lt;/span&gt;&lt;span&gt;--&lt;/span&gt;&lt;span&gt;role dev&lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;role&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code/&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;#检查&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;$ kubectl auth can&lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;i create deployment &lt;/span&gt;&lt;span&gt;--&lt;/span&gt;&lt;span&gt;as&lt;/span&gt;&lt;span&gt; system&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;span&gt;serviceaccount&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;span&gt;default&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;span&gt;dev&lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;sa&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;yes&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;$ kubectl auth can&lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;i create statefulset &lt;/span&gt;&lt;span&gt;--&lt;/span&gt;&lt;span&gt;as&lt;/span&gt;&lt;span&gt; system&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;span&gt;serviceaccount&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;span&gt;default&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;span&gt;dev&lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;sa&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;yes&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;$ kubectl auth can&lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;i create daemonset &lt;/span&gt;&lt;span&gt;--&lt;/span&gt;&lt;span&gt;as&lt;/span&gt;&lt;span&gt; system&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;span&gt;serviceaccount&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;span&gt;default&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;span&gt;dev&lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;sa&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;yes&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;$ kubectl auth can&lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;i create pod &lt;/span&gt;&lt;span&gt;--&lt;/span&gt;&lt;span&gt;as&lt;/span&gt;&lt;span&gt; system&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;span&gt;serviceaccount&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;span&gt;default&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;span&gt;dev&lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;sa&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;no&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/section&gt;&lt;h2&gt;多容器 Pod&lt;/h2&gt;&lt;blockquote&gt;&lt;p&gt;创建一个pod名称日志，容器名称 &lt;code&gt;log-pro&lt;/code&gt; 使用image &lt;code&gt;busybox&lt;/code&gt;，在 &lt;code&gt;/log/data/output.log&lt;/code&gt; 输出重要信息。然后另一个容器名称 &lt;code&gt;log-cus&lt;/code&gt; 使用 image &lt;code&gt;busybox&lt;/code&gt;，在 &lt;code&gt;/log/data/output.log&lt;/code&gt; 加载 &lt;code&gt;output.log&lt;/code&gt; 并打印它。 请注意，此日志文件只能在 pod 内共享。&lt;/p&gt;&lt;/blockquote&gt;&lt;h3&gt;知识点&lt;/h3&gt;&lt;p&gt;&lt;span&gt;&lt;span&gt;•&lt;/span&gt;pod&lt;/span&gt;&lt;span&gt;&lt;span&gt;•&lt;/span&gt;volume: emptyDir&lt;/span&gt;&lt;/p&gt;&lt;p&gt;参考文档： https://kubernetes.io/docs/concepts/storage/volumes/#emptydir&lt;/p&gt;&lt;h3&gt;解题思路&lt;/h3&gt;&lt;section class=&quot;code-snippet__github&quot;&gt;&lt;pre data-lang=&quot;shell&quot;&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;kubectl run log &lt;/span&gt;&lt;span&gt;--&lt;/span&gt;&lt;span&gt;image busybox &lt;/span&gt;&lt;span&gt;--&lt;/span&gt;&lt;span&gt;dry&lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;run&lt;/span&gt;&lt;span&gt;=&lt;/span&gt;&lt;span&gt;client &lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;o yaml &lt;/span&gt;&lt;span&gt;&amp;gt;&lt;/span&gt;&lt;span&gt; log&lt;/span&gt;&lt;span&gt;.&lt;/span&gt;&lt;span&gt;yaml&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/section&gt;&lt;p&gt;修改 log.yaml&lt;/p&gt;&lt;section class=&quot;code-snippet__github&quot;&gt;&lt;pre data-lang=&quot;yaml&quot;&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;apiVersion&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;span&gt; v1&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;kind&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;span&gt; &lt;/span&gt;&lt;span&gt;Pod&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;metadata&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;  creationTimestamp&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;span&gt; &lt;/span&gt;&lt;span&gt;null&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;  labels&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;    run&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;span&gt; log&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;  name&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;span&gt; log&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;spec&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;  containers&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;  &lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt; command&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;    &lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt; sh&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;    &lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt; &lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;c&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;    &lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt; echo important information &lt;/span&gt;&lt;span&gt;&amp;gt;&lt;/span&gt;&lt;span&gt; &lt;/span&gt;&lt;span&gt;/log/&lt;/span&gt;&lt;span&gt;data&lt;/span&gt;&lt;span&gt;/&lt;/span&gt;&lt;span&gt;output&lt;/span&gt;&lt;span&gt;.&lt;/span&gt;&lt;span&gt;log&lt;/span&gt;&lt;span&gt;;&lt;/span&gt;&lt;span&gt; sleep &lt;/span&gt;&lt;span&gt;1d&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;    image&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;span&gt; busybox&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;    name&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;span&gt; log&lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;pro&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;    resources&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;span&gt; &lt;/span&gt;&lt;span&gt;{}&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;    imagePullPolicy&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;span&gt; &lt;/span&gt;&lt;span&gt;IfNotPresent&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;    volumeMounts&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;    &lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt; mountPath&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;span&gt; &lt;/span&gt;&lt;span&gt;/log/&lt;/span&gt;&lt;span&gt;data&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;      name&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;span&gt; log&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;  &lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt; command&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;    &lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt; sh&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;    &lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt; &lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;c&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;    &lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt; tail &lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;f &lt;/span&gt;&lt;span&gt;/&lt;/span&gt;&lt;span&gt;log&lt;/span&gt;&lt;span&gt;/&lt;/span&gt;&lt;span&gt;data&lt;/span&gt;&lt;span&gt;/&lt;/span&gt;&lt;span&gt;output&lt;/span&gt;&lt;span&gt;.&lt;/span&gt;&lt;span&gt;log&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;    image&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;span&gt; busybox&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;    name&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;span&gt; log&lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;cus&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;    imagePullPolicy&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;span&gt; &lt;/span&gt;&lt;span&gt;IfNotPresent&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;    volumeMounts&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;    &lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt; mountPath&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;span&gt; &lt;/span&gt;&lt;span&gt;/log/&lt;/span&gt;&lt;span&gt;data&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;      name&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;span&gt; log&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;  dnsPolicy&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;span&gt; &lt;/span&gt;&lt;span&gt;ClusterFirst&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;  restartPolicy&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;span&gt; &lt;/span&gt;&lt;span&gt;Always&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;  volumes&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;  &lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt; name&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;span&gt; log&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;    emptyDir&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;span&gt; &lt;/span&gt;&lt;span&gt;{}&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;status&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;span&gt; &lt;/span&gt;&lt;span&gt;{}&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/section&gt;&lt;p&gt;执行创建 &lt;code&gt;kubectl apply -f log.yaml&lt;/code&gt;&lt;/p&gt;&lt;p&gt;检查&lt;/p&gt;&lt;section class=&quot;code-snippet__github&quot;&gt;&lt;pre data-lang=&quot;shell&quot;&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;$ kubectl logs log &lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;c log&lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;cus&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;important information&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/section&gt;&lt;h2&gt;安全：网络策略 NetworkPolicy&lt;/h2&gt;&lt;blockquote&gt;&lt;p&gt;只有命名空间 &lt;code&gt;mysql&lt;/code&gt; 的 pod 只能被另一个命名空间 &lt;code&gt;internal&lt;/code&gt; 的 pod 通过 8080 端口进行访问&lt;/p&gt;&lt;/blockquote&gt;&lt;h3&gt;知识点&lt;/h3&gt;&lt;p&gt;&lt;span&gt;&lt;span&gt;•&lt;/span&gt;NetworkPolicy&lt;/span&gt;&lt;span&gt;&lt;span&gt;•&lt;/span&gt;Ingress&lt;/span&gt;&lt;/p&gt;&lt;p&gt;参考文档： https://kubernetes.io/docs/concepts/services-networking/network-policies/#the-networkpolicy-resource&lt;/p&gt;&lt;h3&gt;解题思路&lt;/h3&gt;&lt;section class=&quot;code-snippet__github&quot;&gt;&lt;pre data-lang=&quot;yaml&quot;&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;apiVersion&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;span&gt; networking&lt;/span&gt;&lt;span&gt;.&lt;/span&gt;&lt;span&gt;k8s&lt;/span&gt;&lt;span&gt;.&lt;/span&gt;&lt;span&gt;io&lt;/span&gt;&lt;span&gt;/&lt;/span&gt;&lt;span&gt;v1&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;kind&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;span&gt; &lt;/span&gt;&lt;span&gt;NetworkPolicy&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;metadata&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;  name&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;span&gt; cka&lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;network&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;  &lt;/span&gt;&lt;span&gt;namespace&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;span&gt; target &lt;/span&gt;&lt;span&gt;#目的命名空间&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;spec&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;  podSelector&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;span&gt; &lt;/span&gt;&lt;span&gt;{}&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;  policyTypes&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;  &lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt; &lt;/span&gt;&lt;span&gt;Ingress&lt;/span&gt;&lt;span&gt; &lt;/span&gt;&lt;span&gt;#策略影响入栈流量&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;  ingress&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;  &lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt; &lt;/span&gt;&lt;span&gt;from&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;span&gt; &lt;/span&gt;&lt;span&gt;#允许流量的来源&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;    &lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt; namespaceSelector&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;        matchLabels&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;          ns&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;span&gt; source &lt;/span&gt;&lt;span&gt;#源命名空间的 label&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;    ports&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;    &lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt; protocol&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;span&gt; TCP&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;      port&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;span&gt; &lt;/span&gt;&lt;span&gt;8080&lt;/span&gt;&lt;span&gt; &lt;/span&gt;&lt;span&gt;#允许访问的端口&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code/&gt;&lt;/pre&gt;&lt;/section&gt;&lt;h2&gt;节点状态及污点&lt;/h2&gt;&lt;blockquote&gt;&lt;p&gt;统计这个集群中没有污染的就绪节点，并输出到文件 &lt;code&gt;/root/cka/readyNode.txt&lt;/code&gt;。&lt;/p&gt;&lt;/blockquote&gt;&lt;h3&gt;知识点&lt;/h3&gt;&lt;p&gt;&lt;span&gt;&lt;span&gt;•&lt;/span&gt;Node&lt;/span&gt;&lt;span&gt;&lt;span&gt;•&lt;/span&gt;Taint（污点）&lt;/span&gt;&lt;/p&gt;&lt;p&gt;参考文档：https://kubernetes.io/docs/concepts/scheduling-eviction/taint-and-toleration/&lt;/p&gt;&lt;h3&gt;解题思路&lt;/h3&gt;&lt;section class=&quot;code-snippet__github&quot;&gt;&lt;pre data-lang=&quot;shell&quot;&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;# Ready 状态的数量&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;$ kubectl &lt;/span&gt;&lt;span&gt;get&lt;/span&gt;&lt;span&gt; node &lt;/span&gt;&lt;span&gt;|&lt;/span&gt;&lt;span&gt; grep &lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;w &lt;/span&gt;&lt;span&gt;Ready&lt;/span&gt;&lt;span&gt; &lt;/span&gt;&lt;span&gt;|&lt;/span&gt;&lt;span&gt; wc &lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;l&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;# 查看含有 Taint 的数量，需要排除掉这些&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;$ kubectl describe node &lt;/span&gt;&lt;span&gt;|&lt;/span&gt;&lt;span&gt; grep &lt;/span&gt;&lt;span&gt;Taints&lt;/span&gt;&lt;span&gt; &lt;/span&gt;&lt;span&gt;|&lt;/span&gt;&lt;span&gt; grep &lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;i &lt;/span&gt;&lt;span&gt;NoSchedule&lt;/span&gt;&lt;span&gt; &lt;/span&gt;&lt;span&gt;|&lt;/span&gt;&lt;span&gt; wc &lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;l&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/section&gt;&lt;h2&gt;资源&lt;/h2&gt;&lt;blockquote&gt;&lt;p&gt;将占用CPU资源最多的pod名称输出到文件 &lt;code&gt;/root/cka/name.txt&lt;/code&gt;&lt;/p&gt;&lt;/blockquote&gt;&lt;h3&gt;知识点&lt;/h3&gt;&lt;p&gt;&lt;span&gt;&lt;span&gt;•&lt;/span&gt;kubectl top 命令&lt;/span&gt;&lt;span&gt;&lt;span&gt;•&lt;/span&gt;metrics&lt;/span&gt;&lt;/p&gt;&lt;h3&gt;解题思路&lt;/h3&gt;&lt;p&gt;如果是 minikube 环境，报错 &lt;code&gt;error: Metrics API not available&lt;/code&gt;，可以执行 &lt;code&gt;minikube addons enable metrics-server&lt;/code&gt; 命令开启 metrics server。&lt;/p&gt;&lt;p&gt;通过 &lt;code&gt;kubectl top&lt;/code&gt; 命令找到 cpu 最高的 pod，将其名字写入 &lt;code&gt;/root/cka/name.txt&lt;/code&gt;。&lt;/p&gt;&lt;section class=&quot;code-snippet__github&quot;&gt;&lt;pre data-lang=&quot;shell&quot;&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;$ kubectl top pod&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;# 或者&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;$ kubectl top pod &lt;/span&gt;&lt;span&gt;|&lt;/span&gt;&lt;span&gt; sort &lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;k &lt;/span&gt;&lt;span&gt;2&lt;/span&gt;&lt;span&gt; &lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;n&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/section&gt;&lt;h2&gt;网络：DNS&lt;/h2&gt;&lt;blockquote&gt;&lt;p&gt;有 pod 名称 &lt;code&gt;pod-nginx&lt;/code&gt;，创建服务名称 &lt;code&gt;service-nginx&lt;/code&gt;，使用 &lt;code&gt;nodePort&lt;/code&gt; 暴露pod。 然后创建一个 pod 使用 image &lt;code&gt;busybox&lt;/code&gt; 来 &lt;code&gt;nslookup&lt;/code&gt; pod &lt;code&gt;pod-nginx&lt;/code&gt; 和 service &lt;code&gt;service-nginx&lt;/code&gt;。&lt;/p&gt;&lt;/blockquote&gt;&lt;h3&gt;知识点&lt;/h3&gt;&lt;p&gt;&lt;span&gt;&lt;span&gt;•&lt;/span&gt;service with nodePort&lt;/span&gt;&lt;span&gt;&lt;span&gt;•&lt;/span&gt;kubectl expose&lt;/span&gt;&lt;span&gt;&lt;span&gt;•&lt;/span&gt;kubectl run&lt;/span&gt;&lt;/p&gt;&lt;p&gt;参考文档：https://kubernetes.io/docs/concepts/services-networking/dns-pod-service/&lt;/p&gt;&lt;h3&gt;解题思路&lt;/h3&gt;&lt;p&gt;使用 &lt;code&gt;kubectl expose&lt;/code&gt; 创建 service。&lt;/p&gt;&lt;section class=&quot;code-snippet__github&quot;&gt;&lt;pre data-lang=&quot;shell&quot;&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;# 创建 service&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;kubectl expose pod pod&lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;nginx &lt;/span&gt;&lt;span&gt;--&lt;/span&gt;&lt;span&gt;name service&lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;nginx &lt;/span&gt;&lt;span&gt;--&lt;/span&gt;&lt;span&gt;type &lt;/span&gt;&lt;span&gt;NodePort&lt;/span&gt;&lt;span&gt; &lt;/span&gt;&lt;span&gt;--&lt;/span&gt;&lt;span&gt;target&lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;port &lt;/span&gt;&lt;span&gt;80&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;# 创建 pod&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;kubectl run busybox &lt;/span&gt;&lt;span&gt;--&lt;/span&gt;&lt;span&gt;image busybox&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;span&gt;latest &lt;/span&gt;&lt;span&gt;--&lt;/span&gt;&lt;span&gt;command sleep &lt;/span&gt;&lt;span&gt;1h&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/section&gt;&lt;p&gt;获取 pod 的 ip 地址，pod 的 dns lookup 需要用用到 ip。&lt;/p&gt;&lt;section class=&quot;code-snippet__github&quot;&gt;&lt;pre data-lang=&quot;shell&quot;&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;$ kubectl &lt;/span&gt;&lt;span&gt;get&lt;/span&gt;&lt;span&gt; po &lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;o wide&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;NAME        READY   STATUS    RESTARTS   AGE     IP           NODE   NOMINATED NODE   READINESS GATES&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;busybox     &lt;/span&gt;&lt;span&gt;1&lt;/span&gt;&lt;span&gt;/&lt;/span&gt;&lt;span&gt;1&lt;/span&gt;&lt;span&gt;     &lt;/span&gt;&lt;span&gt;Running&lt;/span&gt;&lt;span&gt;   &lt;/span&gt;&lt;span&gt;0&lt;/span&gt;&lt;span&gt;          &lt;/span&gt;&lt;span&gt;2m17s&lt;/span&gt;&lt;span&gt;   &lt;/span&gt;&lt;span&gt;172.17&lt;/span&gt;&lt;span&gt;.&lt;/span&gt;&lt;span&gt;0.5&lt;/span&gt;&lt;span&gt;   cka    &lt;/span&gt;&lt;span&gt;&amp;lt;none&amp;gt;&lt;/span&gt;&lt;span&gt;           &lt;/span&gt;&lt;span&gt;&amp;lt;none&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;pod&lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;nginx   &lt;/span&gt;&lt;span&gt;1&lt;/span&gt;&lt;span&gt;/&lt;/span&gt;&lt;span&gt;1&lt;/span&gt;&lt;span&gt;     &lt;/span&gt;&lt;span&gt;Running&lt;/span&gt;&lt;span&gt;   &lt;/span&gt;&lt;span&gt;0&lt;/span&gt;&lt;span&gt;          &lt;/span&gt;&lt;span&gt;59m&lt;/span&gt;&lt;span&gt;     &lt;/span&gt;&lt;span&gt;172.17&lt;/span&gt;&lt;span&gt;.&lt;/span&gt;&lt;span&gt;0.4&lt;/span&gt;&lt;span&gt;   cka    &lt;/span&gt;&lt;span&gt;&amp;lt;none&amp;gt;&lt;/span&gt;&lt;span&gt;           &lt;/span&gt;&lt;span&gt;&amp;lt;none&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/section&gt;&lt;p&gt;执行 nslookup&lt;/p&gt;&lt;section class=&quot;code-snippet__github&quot;&gt;&lt;pre data-lang=&quot;shell&quot;&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;$ kubectl &lt;/span&gt;&lt;span&gt;exec&lt;/span&gt;&lt;span&gt; busybox &lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;it &lt;/span&gt;&lt;span&gt;--&lt;/span&gt;&lt;span&gt; nslookup &lt;/span&gt;&lt;span&gt;172.17&lt;/span&gt;&lt;span&gt;.&lt;/span&gt;&lt;span&gt;0.4&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;4.0&lt;/span&gt;&lt;span&gt;.&lt;/span&gt;&lt;span&gt;17.172&lt;/span&gt;&lt;span&gt;.&lt;/span&gt;&lt;span&gt;in&lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;addr&lt;/span&gt;&lt;span&gt;.&lt;/span&gt;&lt;span&gt;arpa    name &lt;/span&gt;&lt;span&gt;=&lt;/span&gt;&lt;span&gt; &lt;/span&gt;&lt;span&gt;172&lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;17&lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;0&lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;4.service&lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;nginx&lt;/span&gt;&lt;span&gt;.&lt;/span&gt;&lt;span&gt;default&lt;/span&gt;&lt;span&gt;.&lt;/span&gt;&lt;span&gt;svc&lt;/span&gt;&lt;span&gt;.&lt;/span&gt;&lt;span&gt;cluster&lt;/span&gt;&lt;span&gt;.&lt;/span&gt;&lt;span&gt;local&lt;/span&gt;&lt;span&gt;.&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code/&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;$ kubectl &lt;/span&gt;&lt;span&gt;exec&lt;/span&gt;&lt;span&gt; busybox &lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;it &lt;/span&gt;&lt;span&gt;--&lt;/span&gt;&lt;span&gt; nslookup service&lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;nginx&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;Server&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;span&gt;        &lt;/span&gt;&lt;span&gt;10.96&lt;/span&gt;&lt;span&gt;.&lt;/span&gt;&lt;span&gt;0.10&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;Address&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;span&gt;    &lt;/span&gt;&lt;span&gt;10.96&lt;/span&gt;&lt;span&gt;.&lt;/span&gt;&lt;span&gt;0.10&lt;/span&gt;&lt;span&gt;#53&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code/&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;Name&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;span&gt;    service&lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;nginx&lt;/span&gt;&lt;span&gt;.&lt;/span&gt;&lt;span&gt;default&lt;/span&gt;&lt;span&gt;.&lt;/span&gt;&lt;span&gt;svc&lt;/span&gt;&lt;span&gt;.&lt;/span&gt;&lt;span&gt;cluster&lt;/span&gt;&lt;span&gt;.&lt;/span&gt;&lt;span&gt;local&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;Address&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;span&gt; &lt;/span&gt;&lt;span&gt;10.110&lt;/span&gt;&lt;span&gt;.&lt;/span&gt;&lt;span&gt;253.70&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/section&gt;&lt;h2&gt;工作负载：扩容&lt;/h2&gt;&lt;blockquote&gt;&lt;p&gt;将命名空间 &lt;code&gt;dev&lt;/code&gt; 中的 Deployment &lt;code&gt;scale-deploy&lt;/code&gt; 缩放到三个 pod 并记录下来。&lt;/p&gt;&lt;/blockquote&gt;&lt;p&gt;参考文档：https://kubernetes.io/docs/concepts/workloads/controllers/deployment/#scaling-a-deployment&lt;/p&gt;&lt;h3&gt;知识点&lt;/h3&gt;&lt;p&gt;&lt;span&gt;&lt;span&gt;•&lt;/span&gt;deployment scale up&lt;/span&gt;&lt;span&gt;&lt;span&gt;•&lt;/span&gt;kubectl scale&lt;/span&gt;&lt;/p&gt;&lt;h3&gt;解题思路&lt;/h3&gt;&lt;p&gt;&lt;code&gt;kubectl scale&lt;/code&gt; 的使用，需要参数 &lt;code&gt;--record&lt;/code&gt; 进行记录（将操作命令记录到 deployment 的 &lt;code&gt;kubernetes.io/change-cause&lt;/code&gt; annotation 中）。&lt;/p&gt;&lt;section class=&quot;code-snippet__github&quot;&gt;&lt;pre data-lang=&quot;shell&quot;&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;$ kubectl scale deployment scale&lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;deploy &lt;/span&gt;&lt;span&gt;--&lt;/span&gt;&lt;span&gt;replicas &lt;/span&gt;&lt;span&gt;3&lt;/span&gt;&lt;span&gt; &lt;/span&gt;&lt;span&gt;--&lt;/span&gt;&lt;span&gt;record&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/section&gt;&lt;h2&gt;集群备份及恢复&lt;/h2&gt;&lt;blockquote&gt;&lt;p&gt;备份 etcd 并将其保存在主节点上的 &lt;code&gt;/root/cka/etcd-backup.db&lt;/code&gt;。&lt;/p&gt;&lt;/blockquote&gt;&lt;blockquote&gt;&lt;p&gt;最后恢复备份。&lt;/p&gt;&lt;/blockquote&gt;&lt;h3&gt;知识点&lt;/h3&gt;&lt;p&gt;&lt;span&gt;&lt;span&gt;•&lt;/span&gt;etcd 的备份及恢复&lt;/span&gt;&lt;/p&gt;&lt;p&gt;参考文档：https://kubernetes.io/docs/tasks/administer-cluster/configure-upgrade-etcd/#backing-up-an-etcd-cluster&lt;/p&gt;&lt;h3&gt;解题思路&lt;/h3&gt;&lt;p&gt;Kubernetes 的所有数据都记录在 etcd 中，对 etcd 进行备份就是对集群进行备份。&lt;/p&gt;&lt;p&gt;连接 etcd 需要证书，证书可以从 apiserver 获取，因为 apiserver 需要连接 etcd。新版本的 apiserver 都是以 static pod 的方式运行，证书是通过 volume 挂载到 pod 中的。&lt;/p&gt;&lt;p&gt;比如 minikube 环境，证书是从 node 节点的 &lt;code&gt;/var/lib/minikube/certs&lt;/code&gt; 挂载进去的。&lt;/p&gt;&lt;p&gt;要先 ssh 到 master 节点上。命令的执行非常快，如果长时间没结束，那就说名有问题了。&lt;/p&gt;&lt;section class=&quot;code-snippet__github&quot;&gt;&lt;pre data-lang=&quot;shell&quot;&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;#备份&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;$ ETCDCTL_API&lt;/span&gt;&lt;span&gt;=&lt;/span&gt;&lt;span&gt;3&lt;/span&gt;&lt;span&gt; etcdctl snapshot save &lt;/span&gt;&lt;span&gt;/&lt;/span&gt;&lt;span&gt;root&lt;/span&gt;&lt;span&gt;/&lt;/span&gt;&lt;span&gt;cka&lt;/span&gt;&lt;span&gt;/&lt;/span&gt;&lt;span&gt;etcd&lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;backup&lt;/span&gt;&lt;span&gt;.&lt;/span&gt;&lt;span&gt;db \&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;--&lt;/span&gt;&lt;span&gt;endpoints&lt;/span&gt;&lt;span&gt;=&lt;/span&gt;&lt;span&gt;https&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;span&gt;//127.0.0.1:2379 \&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;--&lt;/span&gt;&lt;span&gt;cacert&lt;/span&gt;&lt;span&gt;=&lt;/span&gt;&lt;span&gt;/var/&lt;/span&gt;&lt;span&gt;lib&lt;/span&gt;&lt;span&gt;/&lt;/span&gt;&lt;span&gt;minikube&lt;/span&gt;&lt;span&gt;/&lt;/span&gt;&lt;span&gt;certs&lt;/span&gt;&lt;span&gt;/&lt;/span&gt;&lt;span&gt;etcd&lt;/span&gt;&lt;span&gt;/&lt;/span&gt;&lt;span&gt;ca&lt;/span&gt;&lt;span&gt;.&lt;/span&gt;&lt;span&gt;crt \&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;--&lt;/span&gt;&lt;span&gt;cert&lt;/span&gt;&lt;span&gt;=&lt;/span&gt;&lt;span&gt;/var/&lt;/span&gt;&lt;span&gt;lib&lt;/span&gt;&lt;span&gt;/&lt;/span&gt;&lt;span&gt;minikube&lt;/span&gt;&lt;span&gt;/&lt;/span&gt;&lt;span&gt;certs&lt;/span&gt;&lt;span&gt;/&lt;/span&gt;&lt;span&gt;apiserver&lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;etcd&lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;client&lt;/span&gt;&lt;span&gt;.&lt;/span&gt;&lt;span&gt;crt \&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;--&lt;/span&gt;&lt;span&gt;key&lt;/span&gt;&lt;span&gt;=&lt;/span&gt;&lt;span&gt;/var/&lt;/span&gt;&lt;span&gt;lib&lt;/span&gt;&lt;span&gt;/&lt;/span&gt;&lt;span&gt;minikube&lt;/span&gt;&lt;span&gt;/&lt;/span&gt;&lt;span&gt;certs&lt;/span&gt;&lt;span&gt;/&lt;/span&gt;&lt;span&gt;apiserver&lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;etcd&lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;client&lt;/span&gt;&lt;span&gt;.&lt;/span&gt;&lt;span&gt;key&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/section&gt;&lt;p&gt;由于只说了 restore，所以就执行 restore 的命令，默认会恢复到当前目录的 &lt;code&gt;default.etcd&lt;/code&gt; 下。&lt;/p&gt;&lt;section class=&quot;code-snippet__github&quot;&gt;&lt;pre data-lang=&quot;shell&quot;&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;#恢复&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;$ ETCDCTL_API&lt;/span&gt;&lt;span&gt;=&lt;/span&gt;&lt;span&gt;3&lt;/span&gt;&lt;span&gt; etcdctl snapshot restore &lt;/span&gt;&lt;span&gt;/&lt;/span&gt;&lt;span&gt;root&lt;/span&gt;&lt;span&gt;/&lt;/span&gt;&lt;span&gt;cka&lt;/span&gt;&lt;span&gt;/&lt;/span&gt;&lt;span&gt;etcd&lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;backup&lt;/span&gt;&lt;span&gt;.&lt;/span&gt;&lt;span&gt;db \&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;--&lt;/span&gt;&lt;span&gt;endpoints&lt;/span&gt;&lt;span&gt;=&lt;/span&gt;&lt;span&gt;https&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;span&gt;//127.0.0.1:2379 \&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;--&lt;/span&gt;&lt;span&gt;cacert&lt;/span&gt;&lt;span&gt;=&lt;/span&gt;&lt;span&gt;/var/&lt;/span&gt;&lt;span&gt;lib&lt;/span&gt;&lt;span&gt;/&lt;/span&gt;&lt;span&gt;minikube&lt;/span&gt;&lt;span&gt;/&lt;/span&gt;&lt;span&gt;certs&lt;/span&gt;&lt;span&gt;/&lt;/span&gt;&lt;span&gt;etcd&lt;/span&gt;&lt;span&gt;/&lt;/span&gt;&lt;span&gt;ca&lt;/span&gt;&lt;span&gt;.&lt;/span&gt;&lt;span&gt;crt \&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;--&lt;/span&gt;&lt;span&gt;cert&lt;/span&gt;&lt;span&gt;=&lt;/span&gt;&lt;span&gt;/var/&lt;/span&gt;&lt;span&gt;lib&lt;/span&gt;&lt;span&gt;/&lt;/span&gt;&lt;span&gt;minikube&lt;/span&gt;&lt;span&gt;/&lt;/span&gt;&lt;span&gt;certs&lt;/span&gt;&lt;span&gt;/&lt;/span&gt;&lt;span&gt;apiserver&lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;etcd&lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;client&lt;/span&gt;&lt;span&gt;.&lt;/span&gt;&lt;span&gt;crt \&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;--&lt;/span&gt;&lt;span&gt;key&lt;/span&gt;&lt;span&gt;=&lt;/span&gt;&lt;span&gt;/var/&lt;/span&gt;&lt;span&gt;lib&lt;/span&gt;&lt;span&gt;/&lt;/span&gt;&lt;span&gt;minikube&lt;/span&gt;&lt;span&gt;/&lt;/span&gt;&lt;span&gt;certs&lt;/span&gt;&lt;span&gt;/&lt;/span&gt;&lt;span&gt;apiserver&lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;etcd&lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;client&lt;/span&gt;&lt;span&gt;.&lt;/span&gt;&lt;span&gt;key&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/section&gt;&lt;h2&gt;集群节点升级&lt;/h2&gt;&lt;blockquote&gt;&lt;p&gt;将master节点版本从 1.20.0 升级到 1.21.0，确保 master 节点上的 pod 重新调度到其他节点，升级完成后，使 master 节点可用。&lt;/p&gt;&lt;/blockquote&gt;&lt;h3&gt;知识点&lt;/h3&gt;&lt;p&gt;&lt;span&gt;&lt;span&gt;•&lt;/span&gt;drain&lt;/span&gt;&lt;span&gt;&lt;span&gt;•&lt;/span&gt;cordon&lt;/span&gt;&lt;/p&gt;&lt;p&gt;参考文档：https://kubernetes.io/docs/tasks/administer-cluster/kubeadm/kubeadm-upgrade/#upgrading-control-plane-nodes&lt;/p&gt;&lt;h3&gt;解题思路&lt;/h3&gt;&lt;p&gt;受限于环境，没有实地操作。&lt;/p&gt;&lt;section class=&quot;code-snippet__github&quot;&gt;&lt;pre data-lang=&quot;shell&quot;&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;# 将节点设置为不可调度&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;$ kubectl cordon master&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;# 驱逐 master 节点上的 pod&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;$ kubectl drain master &lt;/span&gt;&lt;span&gt;--&lt;/span&gt;&lt;span&gt;ignore&lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;daemonsets&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code/&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;# 进行升级&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;$ apt&lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;mark unhold kubelet kubectl &lt;/span&gt;&lt;span&gt;&amp;amp;&amp;amp;&lt;/span&gt;&lt;span&gt; \&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;apt&lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;get&lt;/span&gt;&lt;span&gt; update &lt;/span&gt;&lt;span&gt;&amp;amp;&amp;amp;&lt;/span&gt;&lt;span&gt; apt&lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;get&lt;/span&gt;&lt;span&gt; install &lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;y kubelet&lt;/span&gt;&lt;span&gt;=&lt;/span&gt;&lt;span&gt;1.21&lt;/span&gt;&lt;span&gt;.&lt;/span&gt;&lt;span&gt;0&lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;00&lt;/span&gt;&lt;span&gt; kubectl&lt;/span&gt;&lt;span&gt;=&lt;/span&gt;&lt;span&gt;1.21&lt;/span&gt;&lt;span&gt;.&lt;/span&gt;&lt;span&gt;0&lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;00&lt;/span&gt;&lt;span&gt; &lt;/span&gt;&lt;span&gt;&amp;amp;&amp;amp;&lt;/span&gt;&lt;span&gt; \&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;apt&lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;mark hold kubelet kubectl&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;# 重新启动kubelet&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;$ systemctl daemon&lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;reload&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;$ systemctl restart kubelet&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code/&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;# 将节点设置为可调度&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;$ kubectl uncordon master&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/section&gt;&lt;h2&gt;集群：节点故障排查&lt;/h2&gt;&lt;blockquote&gt;&lt;p&gt;现在 node01 还没有准备好，请找出根本原因并使其准备好，然后创建一个确保它在 node01 上运行的 pod。&lt;/p&gt;&lt;/blockquote&gt;&lt;h3&gt;知识点&lt;/h3&gt;&lt;p&gt;&lt;span&gt;&lt;span&gt;•&lt;/span&gt;节点故障排查&lt;/span&gt;&lt;/p&gt;&lt;h3&gt;解题思路&lt;/h3&gt;&lt;p&gt;这种问题大概率问题出在 kubelet 上&lt;/p&gt;&lt;section class=&quot;code-snippet__github&quot;&gt;&lt;pre data-lang=&quot;shell&quot;&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;ssh node01&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;systemctl status kubelet&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;systemctl restart kubelet&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;# 再检查node状态&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/section&gt;&lt;p&gt;插播一个故障，本地安装 2 个节点的 minikube 集群时，第二个节点持续 &lt;code&gt;NotReady&lt;/code&gt;。使用 &lt;code&gt;systemctl status kubelet&lt;/code&gt; 看到 &lt;code&gt;unable to update cni config: no networks found in /etc/cni/net.mk&lt;/code&gt;。&lt;/p&gt;&lt;p&gt;检查该目录确实没有文件，从 master 节点复制到该节点后重启 kubelet 解决。&lt;/p&gt;&lt;h2&gt;存储：持久化卷&lt;/h2&gt;&lt;blockquote&gt;&lt;p&gt;集群中有一个持久卷名称 &lt;code&gt;dev-pv&lt;/code&gt;，创建一个持久卷声明名称 &lt;code&gt;dev-pvc&lt;/code&gt;，确保这个持久卷声明会绑定持久卷，然后创建一个 pod 名称 &lt;code&gt;test-pvc&lt;/code&gt;，将这个 pvc 挂载到 path &lt;code&gt;/tmp/data&lt;/code&gt;，使用 nginx 镜像。&lt;/p&gt;&lt;/blockquote&gt;&lt;h3&gt;知识点&lt;/h3&gt;&lt;p&gt;&lt;span&gt;&lt;span&gt;•&lt;/span&gt;PersistentVolume&lt;/span&gt;&lt;span&gt;&lt;span&gt;•&lt;/span&gt;PersistentVolumeClaim&lt;/span&gt;&lt;span&gt;&lt;span&gt;•&lt;/span&gt;Mount Volume&lt;/span&gt;&lt;/p&gt;&lt;p&gt;参考文档：https://kubernetes.io/docs/tasks/configure-pod-container/configure-persistent-volume-storage/#create-a-persistentvolume&lt;/p&gt;&lt;h3&gt;解题思路&lt;/h3&gt;&lt;p&gt;创建 pvc 前先获取 pv的信息&lt;/p&gt;&lt;section class=&quot;code-snippet__github&quot;&gt;&lt;pre data-lang=&quot;shell&quot;&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;$ kubectl &lt;/span&gt;&lt;span&gt;get&lt;/span&gt;&lt;span&gt; pv dev&lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;pv &lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;o yaml&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/section&gt;&lt;p&gt;创建 pv&lt;/p&gt;&lt;section class=&quot;code-snippet__github&quot;&gt;&lt;pre data-lang=&quot;shell&quot;&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;$ cat &lt;/span&gt;&lt;span&gt;&amp;gt;&lt;/span&gt;&lt;span&gt; pvc&lt;/span&gt;&lt;span&gt;.&lt;/span&gt;&lt;span&gt;yaml &lt;/span&gt;&lt;span&gt;&amp;lt;&amp;lt;&lt;/span&gt;&lt;span&gt;EOF&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;apiVersion&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;span&gt; v1&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;kind&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;span&gt; &lt;/span&gt;&lt;span&gt;PersistentVolumeClaim&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;metadata&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;  name&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;span&gt; dev&lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;pvc&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;spec&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;  accessModes&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;    &lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt; &lt;/span&gt;&lt;span&gt;ReadWriteOnce&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;  resources&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;    requests&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;      storage&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;span&gt; &lt;/span&gt;&lt;span&gt;1Gi&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;EOF&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code/&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;$ kubectl apply &lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;f pvc&lt;/span&gt;&lt;span&gt;.&lt;/span&gt;&lt;span&gt;yaml&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/section&gt;&lt;p&gt;创建 pod 的 manifest，记得使用 &lt;code&gt;kubectl run --dry-run=client -o yaml&lt;/code&gt;&lt;/p&gt;&lt;section class=&quot;code-snippet__github&quot;&gt;&lt;pre data-lang=&quot;shell&quot;&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;kubectl run test&lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;pvc &lt;/span&gt;&lt;span&gt;--&lt;/span&gt;&lt;span&gt;image nginx &lt;/span&gt;&lt;span&gt;--&lt;/span&gt;&lt;span&gt;dry&lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;run&lt;/span&gt;&lt;span&gt;=&lt;/span&gt;&lt;span&gt;client &lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;o yaml &lt;/span&gt;&lt;span&gt;&amp;gt;&lt;/span&gt;&lt;span&gt; test&lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;pvc&lt;/span&gt;&lt;span&gt;.&lt;/span&gt;&lt;span&gt;yaml&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/section&gt;&lt;p&gt;修改之后得到最终的 pod yaml&lt;/p&gt;&lt;section class=&quot;code-snippet__github&quot;&gt;&lt;pre data-lang=&quot;yaml&quot;&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;apiVersion&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;span&gt; v1&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;kind&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;span&gt; &lt;/span&gt;&lt;span&gt;Pod&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;metadata&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;  creationTimestamp&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;span&gt; &lt;/span&gt;&lt;span&gt;null&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;  labels&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;    run&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;span&gt; test&lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;pvc&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;  name&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;span&gt; test&lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;pvc&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;spec&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;  volumes&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;    &lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt; name&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;span&gt; data&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;      persistentVolumeClaim&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;        claimName&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;span&gt; dev&lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;pvc&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;  containers&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;  &lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt; image&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;span&gt; nginx&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;    name&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;span&gt; test&lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;pvc&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;    resources&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;span&gt; &lt;/span&gt;&lt;span&gt;{}&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;    volumeMounts&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;      &lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt; name&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;span&gt; data&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;        mountPath&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;span&gt; &lt;/span&gt;&lt;span&gt;/tmp/&lt;/span&gt;&lt;span&gt;data&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;  dnsPolicy&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;span&gt; &lt;/span&gt;&lt;span&gt;ClusterFirst&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;  restartPolicy&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;span&gt; &lt;/span&gt;&lt;span&gt;Always&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/section&gt;&lt;p&gt;理论上只要 pod 能运行，就说明成功。也可以进一步确认挂载是否成功，在 pod 的 &lt;code&gt;/tmp/data&lt;/code&gt; 中 touch 个文件，然后到节点的目录中查看是有该文件。&lt;/p&gt;&lt;h2&gt;工作负载：多容器的 Deployment&lt;/h2&gt;&lt;blockquote&gt;&lt;p&gt;创建一个名为 &lt;code&gt;deploy-important&lt;/code&gt; 的 Deployment，标签为 &lt;code&gt;id=very-important&lt;/code&gt;（pod 也应该有这个标签）和命名空间 dev 中的 3 个副本。 它应该包含两个容器，第一个名为 &lt;code&gt;container1&lt;/code&gt; 并带有镜像，第二个名为 container2 的图像为 &lt;code&gt;kubernetes/pause&lt;/code&gt;。&lt;/p&gt;&lt;/blockquote&gt;&lt;blockquote&gt;&lt;p&gt;在一个工作节点上应该只运行该部署的一个 Pod。 我们有两个工作节点：&lt;code&gt;cluster1-worker1&lt;/code&gt; 和 &lt;code&gt;cluster1-worker2&lt;/code&gt;。 因为 Deployment 有三个副本，所以结果应该是在两个节点上都有一个 Pod 正在运行。 不会调度第三个 Pod，除非添加新的工作节点。&lt;/p&gt;&lt;/blockquote&gt;&lt;h3&gt;知识点&lt;/h3&gt;&lt;p&gt;&lt;span&gt;&lt;span&gt;•&lt;/span&gt;deployment&lt;/span&gt;&lt;span&gt;&lt;span&gt;•&lt;/span&gt;pod label&lt;/span&gt;&lt;span&gt;&lt;span&gt;•&lt;/span&gt;replicas&lt;/span&gt;&lt;span&gt;&lt;span&gt;•&lt;/span&gt;multi container pod&lt;/span&gt;&lt;span&gt;&lt;span&gt;•&lt;/span&gt;pod anti affinity&lt;/span&gt;&lt;/p&gt;&lt;p&gt;官方文档参考：https://kubernetes.io/docs/concepts/scheduling-eviction/assign-pod-node/#never-co-located-in-the-same-node&lt;/p&gt;&lt;h3&gt;解题思路&lt;/h3&gt;&lt;p&gt;先创建模板&lt;/p&gt;&lt;section class=&quot;code-snippet__github&quot;&gt;&lt;pre data-lang=&quot;shell&quot;&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;$ kubectl create deployment deploy&lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;important &lt;/span&gt;&lt;span&gt;--&lt;/span&gt;&lt;span&gt;image nginx &lt;/span&gt;&lt;span&gt;--&lt;/span&gt;&lt;span&gt;replicas &lt;/span&gt;&lt;span&gt;3&lt;/span&gt;&lt;span&gt; &lt;/span&gt;&lt;span&gt;--&lt;/span&gt;&lt;span&gt;dry&lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;run&lt;/span&gt;&lt;span&gt;=&lt;/span&gt;&lt;span&gt;client &lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;o yaml &lt;/span&gt;&lt;span&gt;&amp;gt;&lt;/span&gt;&lt;span&gt; deploy&lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;important&lt;/span&gt;&lt;span&gt;.&lt;/span&gt;&lt;span&gt;yaml&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/section&gt;&lt;p&gt;修改后的 yaml&lt;/p&gt;&lt;section class=&quot;code-snippet__github&quot;&gt;&lt;pre data-lang=&quot;yaml&quot;&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;apiVersion&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;span&gt; apps&lt;/span&gt;&lt;span&gt;/&lt;/span&gt;&lt;span&gt;v1&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;kind&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;span&gt; &lt;/span&gt;&lt;span&gt;Deployment&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;metadata&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;  creationTimestamp&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;span&gt; &lt;/span&gt;&lt;span&gt;null&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;  labels&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;    app&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;span&gt; deploy&lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;important&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;    id&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;span&gt; very&lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;important&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;  name&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;span&gt; deploy&lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;important&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;spec&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;  replicas&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;span&gt; &lt;/span&gt;&lt;span&gt;3&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;  selector&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;    matchLabels&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;      app&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;span&gt; deploy&lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;important&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;      id&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;span&gt; very&lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;important&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;  strategy&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;span&gt; &lt;/span&gt;&lt;span&gt;{}&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;  &lt;/span&gt;&lt;span&gt;template&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;    metadata&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;      creationTimestamp&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;span&gt; &lt;/span&gt;&lt;span&gt;null&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;      labels&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;        app&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;span&gt; deploy&lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;important&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;        id&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;span&gt; very&lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;important&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;    spec&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;      affinity&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;        podAntiAffinity&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;          requiredDuringSchedulingIgnoredDuringExecution&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;          &lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt; labelSelector&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;              matchExpressions&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;              &lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt; key&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;span&gt; id&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;                &lt;/span&gt;&lt;span&gt;operator&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;span&gt; &lt;/span&gt;&lt;span&gt;In&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;                values&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;                &lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt; very&lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;important&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;            topologyKey&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;span&gt; kubernetes&lt;/span&gt;&lt;span&gt;.&lt;/span&gt;&lt;span&gt;io&lt;/span&gt;&lt;span&gt;/&lt;/span&gt;&lt;span&gt;hostname&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;      containers&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;      &lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt; image&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;span&gt; nginx&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;        name&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;span&gt; container1&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;        resources&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;span&gt; &lt;/span&gt;&lt;span&gt;{}&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;      &lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt; image&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;span&gt; kubernetes&lt;/span&gt;&lt;span&gt;/&lt;/span&gt;&lt;span&gt;pause&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;        name&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;span&gt; container2&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;status&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;span&gt; &lt;/span&gt;&lt;span&gt;{}&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/section&gt;&lt;p&gt;minikube 上测试只能调度一个 pod，符合预期&lt;/p&gt;&lt;section class=&quot;code-snippet__github&quot;&gt;&lt;pre data-lang=&quot;shell&quot;&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;$ kgpo&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;NAME                                READY   STATUS    RESTARTS   AGE&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;deploy&lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;important&lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;659d54fc47&lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;6cp8r&lt;/span&gt;&lt;span&gt;   &lt;/span&gt;&lt;span&gt;0&lt;/span&gt;&lt;span&gt;/&lt;/span&gt;&lt;span&gt;2&lt;/span&gt;&lt;span&gt;     &lt;/span&gt;&lt;span&gt;Pending&lt;/span&gt;&lt;span&gt;   &lt;/span&gt;&lt;span&gt;0&lt;/span&gt;&lt;span&gt;          &lt;/span&gt;&lt;span&gt;3h10m&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;deploy&lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;important&lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;659d54fc47&lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;92z4d&lt;/span&gt;&lt;span&gt;   &lt;/span&gt;&lt;span&gt;2&lt;/span&gt;&lt;span&gt;/&lt;/span&gt;&lt;span&gt;2&lt;/span&gt;&lt;span&gt;     &lt;/span&gt;&lt;span&gt;Running&lt;/span&gt;&lt;span&gt;   &lt;/span&gt;&lt;span&gt;0&lt;/span&gt;&lt;span&gt;          &lt;/span&gt;&lt;span&gt;3h10m&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;deploy&lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;important&lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;659d54fc47&lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;c6llc   &lt;/span&gt;&lt;span&gt;0&lt;/span&gt;&lt;span&gt;/&lt;/span&gt;&lt;span&gt;2&lt;/span&gt;&lt;span&gt;     &lt;/span&gt;&lt;span&gt;Pending&lt;/span&gt;&lt;span&gt;   &lt;/span&gt;&lt;span&gt;0&lt;/span&gt;&lt;span&gt;          &lt;/span&gt;&lt;span&gt;3h10m&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/section&gt;&lt;h2&gt;存储：Secret的使用&lt;/h2&gt;&lt;blockquote&gt;&lt;p&gt;在 &lt;code&gt;secret&lt;/code&gt; 命名空间下，使用镜像 &lt;code&gt;busybox:1.31.1&lt;/code&gt; 创建一个名为 &lt;code&gt;secret-pod&lt;/code&gt; 的 pod，并保证 pod 运行一段时间&lt;/p&gt;&lt;/blockquote&gt;&lt;blockquote&gt;&lt;p&gt;有个名为 &lt;code&gt;sercret1.yaml&lt;/code&gt; 的 Secret 文件，在 &lt;code&gt;secret&lt;/code&gt; 命名空间下创建 Secret，并以只读的方式挂在到 Pod 的 &lt;code&gt;/tmp/secret1&lt;/code&gt; 目录 创建一个新的 Secret &lt;code&gt;secret2&lt;/code&gt; 包含 &lt;code&gt;user=user1&lt;/code&gt; 和 &lt;code&gt;pass=1234&lt;/code&gt;，分别以缓解变量 &lt;code&gt;APP_USER&lt;/code&gt; 和 &lt;code&gt;APP_PASS&lt;/code&gt; 输入到 Pod 中&lt;/p&gt;&lt;/blockquote&gt;&lt;h3&gt;知识点&lt;/h3&gt;&lt;p&gt;&lt;span&gt;&lt;span&gt;•&lt;/span&gt;secret&lt;/span&gt;&lt;span&gt;&lt;span&gt;•&lt;/span&gt;toleration&lt;/span&gt;&lt;span&gt;&lt;span&gt;•&lt;/span&gt;taints&lt;/span&gt;&lt;/p&gt;&lt;p&gt;参考文档： https://kubernetes.io/docs/concepts/configuration/secret/#using-secrets https://kubernetes.io/docs/concepts/configuration/secret/#using-secrets-as-environment-variables&lt;/p&gt;&lt;h3&gt;解题思路&lt;/h3&gt;&lt;p&gt;创建 namespace&lt;/p&gt;&lt;section class=&quot;code-snippet__github&quot;&gt;&lt;pre data-lang=&quot;shell&quot;&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;$ kubectl create ns secret&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/section&gt;&lt;p&gt;创建 pod 模板&lt;/p&gt;&lt;section class=&quot;code-snippet__github&quot;&gt;&lt;pre data-lang=&quot;$&quot;&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;$ kubectl run secret&lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;pod &lt;/span&gt;&lt;span&gt;--&lt;/span&gt;&lt;span&gt;image busybox&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;span&gt;1.31&lt;/span&gt;&lt;span&gt;.&lt;/span&gt;&lt;span&gt;1&lt;/span&gt;&lt;span&gt; &lt;/span&gt;&lt;span&gt;--&lt;/span&gt;&lt;span&gt;dry&lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;run&lt;/span&gt;&lt;span&gt;=&lt;/span&gt;&lt;span&gt;client &lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;o yaml &lt;/span&gt;&lt;span&gt;--&lt;/span&gt;&lt;span&gt;command &lt;/span&gt;&lt;span&gt;--&lt;/span&gt;&lt;span&gt; sleep &lt;/span&gt;&lt;span&gt;1d&lt;/span&gt;&lt;span&gt; &lt;/span&gt;&lt;span&gt;&amp;gt;&lt;/span&gt;&lt;span&gt; secret&lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;pod&lt;/span&gt;&lt;span&gt;.&lt;/span&gt;&lt;span&gt;yaml&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/section&gt;&lt;p&gt;修改 secret1.yaml，使用 secret namespace&lt;/p&gt;&lt;section class=&quot;code-snippet__github&quot;&gt;&lt;pre data-lang=&quot;yaml&quot;&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;apiVersion&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;span&gt; v1&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;data&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;  halt&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;span&gt; &lt;/span&gt;&lt;span&gt;IyEvYmluL2Jhc2g&lt;/span&gt;&lt;span&gt;=&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;kind&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;span&gt; &lt;/span&gt;&lt;span&gt;Secret&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;metadata&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;  creationTimestamp&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;span&gt; &lt;/span&gt;&lt;span&gt;&quot;2021-05-15T07:48:02Z&quot;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;  name&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;span&gt; secret1&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;  &lt;/span&gt;&lt;span&gt;namespace&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;span&gt; secret&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;type&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;span&gt; &lt;/span&gt;&lt;span&gt;Opaque&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/section&gt;&lt;p&gt;创建 secret2&lt;/p&gt;&lt;section class=&quot;code-snippet__github&quot;&gt;&lt;pre data-lang=&quot;shell&quot;&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;$ kubectl create secret generic secret2 &lt;/span&gt;&lt;span&gt;--&lt;/span&gt;&lt;span&gt;from&lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;literal user&lt;/span&gt;&lt;span&gt;=&lt;/span&gt;&lt;span&gt;user1 &lt;/span&gt;&lt;span&gt;--&lt;/span&gt;&lt;span&gt;from&lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;literal &lt;/span&gt;&lt;span&gt;pass&lt;/span&gt;&lt;span&gt;=&lt;/span&gt;&lt;span&gt;1234&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/section&gt;&lt;p&gt;修改模板&lt;/p&gt;&lt;section class=&quot;code-snippet__github&quot;&gt;&lt;pre data-lang=&quot;yaml&quot;&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;apiVersion&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;span&gt; v1&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;kind&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;span&gt; &lt;/span&gt;&lt;span&gt;Pod&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;metadata&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;  creationTimestamp&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;span&gt; &lt;/span&gt;&lt;span&gt;null&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;  labels&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;    run&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;span&gt; secret&lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;pod&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;  name&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;span&gt; secret&lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;pod&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;spec&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;  containers&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;  &lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt; command&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;    &lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt; sleep&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;    &lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt; &lt;/span&gt;&lt;span&gt;1d&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;    image&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;span&gt; busybox&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;span&gt;1.31&lt;/span&gt;&lt;span&gt;.&lt;/span&gt;&lt;span&gt;1&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;    name&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;span&gt; secret&lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;pod&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;    env&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;    &lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt; name&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;span&gt; APP_USER&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;      valueFrom&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;        secretKeyRef&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;          name&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;span&gt; secret2&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;          key&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;span&gt; user&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;    &lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt; name&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;span&gt; APP_PASS&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;      valueFrom&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;        secretKeyRef&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;          name&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;span&gt; secret2&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;          key&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;span&gt; &lt;/span&gt;&lt;span&gt;pass&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;    resources&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;span&gt; &lt;/span&gt;&lt;span&gt;{}&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;    volumeMounts&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;    &lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt; mountPath&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;span&gt; &lt;/span&gt;&lt;span&gt;/tmp/&lt;/span&gt;&lt;span&gt;secret1&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;      name&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;span&gt; sec&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;  dnsPolicy&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;span&gt; &lt;/span&gt;&lt;span&gt;ClusterFirst&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;  restartPolicy&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;span&gt; &lt;/span&gt;&lt;span&gt;Always&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;  volumes&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;  &lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt; name&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;span&gt; sec&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;    secret&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;      secretName&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;span&gt; secret1&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;status&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;span&gt; &lt;/span&gt;&lt;span&gt;{}&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/section&gt;&lt;p&gt;检查结果：&lt;/p&gt;&lt;section class=&quot;code-snippet__github&quot;&gt;&lt;pre data-lang=&quot;shell&quot;&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;$ kubectl &lt;/span&gt;&lt;span&gt;exec&lt;/span&gt;&lt;span&gt; secret&lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;pod &lt;/span&gt;&lt;span&gt;--&lt;/span&gt;&lt;span&gt; cat &lt;/span&gt;&lt;span&gt;/&lt;/span&gt;&lt;span&gt;tmp&lt;/span&gt;&lt;span&gt;/&lt;/span&gt;&lt;span&gt;secret1&lt;/span&gt;&lt;span&gt;/&lt;/span&gt;&lt;span&gt;halt&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;#!/bin/bash&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code/&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;$ kubectl &lt;/span&gt;&lt;span&gt;exec&lt;/span&gt;&lt;span&gt; secret&lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;pod &lt;/span&gt;&lt;span&gt;--&lt;/span&gt;&lt;span&gt; env &lt;/span&gt;&lt;span&gt;|&lt;/span&gt;&lt;span&gt; grep &lt;/span&gt;&lt;span&gt;&#x27;APP_&#x27;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;APP_USER&lt;/span&gt;&lt;span&gt;=&lt;/span&gt;&lt;span&gt;user1&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;APP_PASS&lt;/span&gt;&lt;span&gt;=&lt;/span&gt;&lt;span&gt;1234&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/section&gt;&lt;h2&gt;工作负载：静态 Pod&lt;/h2&gt;&lt;blockquote&gt;&lt;p&gt;在 &lt;code&gt;cluster3-master1&lt;/code&gt; 上的 &lt;code&gt;default&lt;/code&gt; 命名空间中创建一个名为 &lt;code&gt;my-static-pod&lt;/code&gt; 的静态 Pod。 使用镜像 &lt;code&gt;nginx:1.16-alpine&lt;/code&gt; 并分配 10m CPU 和 20Mi 内存的资源。&lt;/p&gt;&lt;/blockquote&gt;&lt;blockquote&gt;&lt;p&gt;Then create a NodePort Service named static-pod-service which exposes that static Pod on port 80 and check if it has Endpoints and if its reachable through the cluster3-master1 internal IP address. You can connect to the internal node IPs from your main terminal. 然后创建一个名为&lt;code&gt;static-pod-service&lt;/code&gt; 的 NodePort Service，该服务在端口 80 上公开该静态 Pod，并检查它是否具有端点以及是否可以通过 &lt;code&gt;cluster3-master1&lt;/code&gt; 内部 IP 地址访问它。&lt;/p&gt;&lt;/blockquote&gt;&lt;h3&gt;知识点&lt;/h3&gt;&lt;p&gt;&lt;span&gt;&lt;span&gt;•&lt;/span&gt;static pod&lt;/span&gt;&lt;span&gt;&lt;span&gt;•&lt;/span&gt;resource&lt;/span&gt;&lt;span&gt;&lt;span&gt;•&lt;/span&gt;nodeport service&lt;/span&gt;&lt;span&gt;&lt;span&gt;•&lt;/span&gt;endpoints&lt;/span&gt;&lt;/p&gt;&lt;p&gt;参考文档：&lt;/p&gt;&lt;p&gt;&lt;span&gt;&lt;span&gt;•&lt;/span&gt;https://kubernetes.io/docs/tasks/configure-pod-container/static-pod/&lt;/span&gt;&lt;span&gt;&lt;span&gt;•&lt;/span&gt;https://kubernetes.io/docs/concepts/configuration/manage-resources-containers/#meaning-of-memory&lt;/span&gt;&lt;/p&gt;&lt;h3&gt;解题思路&lt;/h3&gt;&lt;p&gt;创建pod模板&lt;/p&gt;&lt;section class=&quot;code-snippet__github&quot;&gt;&lt;pre data-lang=&quot;shell&quot;&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;$ kubectl run &lt;/span&gt;&lt;span&gt;my&lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;static&lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;pod &lt;/span&gt;&lt;span&gt;--&lt;/span&gt;&lt;span&gt;image nginx&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;span&gt;1.16&lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;alpine &lt;/span&gt;&lt;span&gt;--&lt;/span&gt;&lt;span&gt;dry&lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;run&lt;/span&gt;&lt;span&gt;=&lt;/span&gt;&lt;span&gt;client &lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;o yaml &lt;/span&gt;&lt;span&gt;&amp;gt;&lt;/span&gt;&lt;span&gt; &lt;/span&gt;&lt;span&gt;static&lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;pod&lt;/span&gt;&lt;span&gt;.&lt;/span&gt;&lt;span&gt;yaml&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/section&gt;&lt;p&gt;修改模板，增加资源配置&lt;/p&gt;&lt;section class=&quot;code-snippet__github&quot;&gt;&lt;pre data-lang=&quot;yaml&quot;&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;apiVersion&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;span&gt; v1&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;kind&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;span&gt; &lt;/span&gt;&lt;span&gt;Pod&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;metadata&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;  creationTimestamp&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;span&gt; &lt;/span&gt;&lt;span&gt;null&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;  labels&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;    run&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;span&gt; &lt;/span&gt;&lt;span&gt;my&lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;static&lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;pod&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;  name&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;span&gt; &lt;/span&gt;&lt;span&gt;my&lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;static&lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;pod&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;spec&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;  containers&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;  &lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt; image&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;span&gt; nginx&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;span&gt;1.16&lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;alpine&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;    name&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;span&gt; &lt;/span&gt;&lt;span&gt;my&lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;static&lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;pod&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;    resources&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;      requests&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;        cpu&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;span&gt; &lt;/span&gt;&lt;span&gt;&quot;10m&quot;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;        memory&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;span&gt; &lt;/span&gt;&lt;span&gt;&quot;20Mi&quot;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;  dnsPolicy&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;span&gt; &lt;/span&gt;&lt;span&gt;ClusterFirst&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;  restartPolicy&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;span&gt; &lt;/span&gt;&lt;span&gt;Always&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;status&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;span&gt; &lt;/span&gt;&lt;span&gt;{}&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/section&gt;&lt;p&gt;ssh 到主机，找到 kubelet 配置文件的位置 &lt;code&gt;ps -ef | grep kubelet&lt;/code&gt;&lt;/p&gt;&lt;p&gt;查看配置文件（minikube：/var/lib/kubelet/config.yaml）中 &lt;code&gt;staticPodPath&lt;/code&gt; 配置的就是静态 pod 的 manifest 的位置（minikube：/etc/kubernetes/manifests）&lt;/p&gt;&lt;p&gt;将 &lt;code&gt;static-pod.yaml&lt;/code&gt; 放到正确的文件夹中，然后重启 kubelet&lt;/p&gt;&lt;section class=&quot;code-snippet__github&quot;&gt;&lt;pre data-lang=&quot;shell&quot;&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;$ systemctl restart kubelet&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/section&gt;&lt;p&gt;检查pod是否正确运行&lt;/p&gt;&lt;p&gt;创建 node port&lt;/p&gt;&lt;section class=&quot;code-snippet__github&quot;&gt;&lt;pre data-lang=&quot;shell&quot;&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;$ kubectl expose pod &lt;/span&gt;&lt;span&gt;my&lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;static&lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;pod &lt;/span&gt;&lt;span&gt;--&lt;/span&gt;&lt;span&gt;name &lt;/span&gt;&lt;span&gt;static&lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;pod&lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;service &lt;/span&gt;&lt;span&gt;--&lt;/span&gt;&lt;span&gt;type &lt;/span&gt;&lt;span&gt;NodePort&lt;/span&gt;&lt;span&gt; &lt;/span&gt;&lt;span&gt;--&lt;/span&gt;&lt;span&gt;port &lt;/span&gt;&lt;span&gt;80&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/section&gt;&lt;p&gt;检查是否创建成功&lt;/p&gt;&lt;section class=&quot;code-snippet__github&quot;&gt;&lt;pre data-lang=&quot;shell&quot;&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;$ kubectl &lt;/span&gt;&lt;span&gt;get&lt;/span&gt;&lt;span&gt; svc&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;NAME                 TYPE        CLUSTER&lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;IP     EXTERNAL&lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;IP   PORT&lt;/span&gt;&lt;span&gt;(&lt;/span&gt;&lt;span&gt;S&lt;/span&gt;&lt;span&gt;)&lt;/span&gt;&lt;span&gt;        AGE&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;static&lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;pod&lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;service   &lt;/span&gt;&lt;span&gt;NodePort&lt;/span&gt;&lt;span&gt;    &lt;/span&gt;&lt;span&gt;10.97&lt;/span&gt;&lt;span&gt;.&lt;/span&gt;&lt;span&gt;248.99&lt;/span&gt;&lt;span&gt;   &lt;/span&gt;&lt;span&gt;&amp;lt;none&amp;gt;&lt;/span&gt;&lt;span&gt;        &lt;/span&gt;&lt;span&gt;80&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;span&gt;31938&lt;/span&gt;&lt;span&gt;/&lt;/span&gt;&lt;span&gt;TCP   &lt;/span&gt;&lt;span&gt;68s&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/section&gt;&lt;p&gt;获取 node 的 ip&lt;/p&gt;&lt;section class=&quot;code-snippet__github&quot;&gt;&lt;pre data-lang=&quot;shell&quot;&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;$ kubectl &lt;/span&gt;&lt;span&gt;get&lt;/span&gt;&lt;span&gt; node &lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;o wide&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;NAME   STATUS   ROLES    AGE   VERSION   INTERNAL&lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;IP    EXTERNAL&lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;IP   OS&lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;IMAGE               KERNEL&lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;VERSION   CONTAINER&lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;RUNTIME&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;cka    &lt;/span&gt;&lt;span&gt;Ready&lt;/span&gt;&lt;span&gt;    master   &lt;/span&gt;&lt;span&gt;10h&lt;/span&gt;&lt;span&gt;   v1&lt;/span&gt;&lt;span&gt;.&lt;/span&gt;&lt;span&gt;18.8&lt;/span&gt;&lt;span&gt;   &lt;/span&gt;&lt;span&gt;192.168&lt;/span&gt;&lt;span&gt;.&lt;/span&gt;&lt;span&gt;64.3&lt;/span&gt;&lt;span&gt;   &lt;/span&gt;&lt;span&gt;&amp;lt;none&amp;gt;&lt;/span&gt;&lt;span&gt;        &lt;/span&gt;&lt;span&gt;Buildroot&lt;/span&gt;&lt;span&gt; &lt;/span&gt;&lt;span&gt;2020.02&lt;/span&gt;&lt;span&gt;.&lt;/span&gt;&lt;span&gt;10&lt;/span&gt;&lt;span&gt;   &lt;/span&gt;&lt;span&gt;4.19&lt;/span&gt;&lt;span&gt;.&lt;/span&gt;&lt;span&gt;171&lt;/span&gt;&lt;span&gt;         docker&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;span&gt;//20.10.4&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/section&gt;&lt;p&gt;在 minikube 的环境下可直接通过 &lt;code&gt;minikube ip&lt;/code&gt; 获取&lt;/p&gt;&lt;p&gt;测试&lt;/p&gt;&lt;section class=&quot;code-snippet__github&quot;&gt;&lt;pre data-lang=&quot;shell&quot;&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;$ http &lt;/span&gt;&lt;span&gt;192.168&lt;/span&gt;&lt;span&gt;.&lt;/span&gt;&lt;span&gt;64.3&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;span&gt;31938&lt;/span&gt;&lt;span&gt; &lt;/span&gt;&lt;span&gt;--&lt;/span&gt;&lt;span&gt;headers&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;HTTP&lt;/span&gt;&lt;span&gt;/&lt;/span&gt;&lt;span&gt;1.1&lt;/span&gt;&lt;span&gt; &lt;/span&gt;&lt;span&gt;200&lt;/span&gt;&lt;span&gt; OK&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;Accept&lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;Ranges&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;span&gt; bytes&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;Connection&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;span&gt; keep&lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;alive&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;Content&lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;Length&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;span&gt; &lt;/span&gt;&lt;span&gt;612&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;Content&lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;Type&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;span&gt; text&lt;/span&gt;&lt;span&gt;/&lt;/span&gt;&lt;span&gt;html&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;Date&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;span&gt; &lt;/span&gt;&lt;span&gt;Sat&lt;/span&gt;&lt;span&gt;,&lt;/span&gt;&lt;span&gt; &lt;/span&gt;&lt;span&gt;15&lt;/span&gt;&lt;span&gt; &lt;/span&gt;&lt;span&gt;May&lt;/span&gt;&lt;span&gt; &lt;/span&gt;&lt;span&gt;2021&lt;/span&gt;&lt;span&gt; &lt;/span&gt;&lt;span&gt;08&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;span&gt;35&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;span&gt;11&lt;/span&gt;&lt;span&gt; GMT&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;ETag&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;span&gt; &lt;/span&gt;&lt;span&gt;&quot;5d52db33-264&quot;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;Last&lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;Modified&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;span&gt; &lt;/span&gt;&lt;span&gt;Tue&lt;/span&gt;&lt;span&gt;,&lt;/span&gt;&lt;span&gt; &lt;/span&gt;&lt;span&gt;13&lt;/span&gt;&lt;span&gt; &lt;/span&gt;&lt;span&gt;Aug&lt;/span&gt;&lt;span&gt; &lt;/span&gt;&lt;span&gt;2019&lt;/span&gt;&lt;span&gt; &lt;/span&gt;&lt;span&gt;15&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;span&gt;45&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;span&gt;55&lt;/span&gt;&lt;span&gt; GMT&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;Server&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;span&gt; nginx&lt;/span&gt;&lt;span&gt;/&lt;/span&gt;&lt;span&gt;1.16&lt;/span&gt;&lt;span&gt;.&lt;/span&gt;&lt;span&gt;1&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/section&gt;&lt;h2&gt;调度：污点和容忍度&lt;/h2&gt;&lt;blockquote&gt;&lt;p&gt;在命名空间 &lt;code&gt;default&lt;/code&gt; 中创建图像 &lt;code&gt;httpd:2.4.41-alpine&lt;/code&gt; 的单个 Pod。Pod 应命名为 &lt;code&gt;pod1&lt;/code&gt;，容器名为 &lt;code&gt;pod1-container&lt;/code&gt;。在不给任何节点添加新标签的前提下，将该 pod 调度到主节点上。&lt;/p&gt;&lt;/blockquote&gt;&lt;h3&gt;知识点&lt;/h3&gt;&lt;p&gt;&lt;span&gt;&lt;span&gt;•&lt;/span&gt;Taint&lt;/span&gt;&lt;span&gt;&lt;span&gt;•&lt;/span&gt;Label&lt;/span&gt;&lt;span&gt;&lt;span&gt;•&lt;/span&gt;Tolerance&lt;/span&gt;&lt;/p&gt;&lt;p&gt;参考文档：https://kubernetes.io/docs/concepts/scheduling-eviction/taint-and-toleration/&lt;/p&gt;&lt;h3&gt;解题思路&lt;/h3&gt;&lt;section class=&quot;code-snippet__github&quot;&gt;&lt;pre data-lang=&quot;&quot;&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;#找出master节点（一般考试只有一个节点）&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;$ kubectl &lt;/span&gt;&lt;span&gt;get&lt;/span&gt;&lt;span&gt; node&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;#找到 master 节点的 taints，需要在 pod 的 .spec.tolerations 排除掉&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;$ kubectl describe node xxxx &lt;/span&gt;&lt;span&gt;|&lt;/span&gt;&lt;span&gt; grep &lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;w &lt;/span&gt;&lt;span&gt;Taints&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;#找到 master 节点的 labels&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;$ kubectl describe node xxxx &lt;/span&gt;&lt;span&gt;|&lt;/span&gt;&lt;span&gt; grep &lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;w &lt;/span&gt;&lt;span&gt;Labels&lt;/span&gt;&lt;span&gt; &lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;A10&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/section&gt;&lt;p&gt;创建pod模板&lt;/p&gt;&lt;section class=&quot;code-snippet__github&quot;&gt;&lt;pre data-lang=&quot;shell&quot;&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;$ kubectl run pod1 &lt;/span&gt;&lt;span&gt;--&lt;/span&gt;&lt;span&gt;image httpd&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;span&gt;2.4&lt;/span&gt;&lt;span&gt;.&lt;/span&gt;&lt;span&gt;41&lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;alpine &lt;/span&gt;&lt;span&gt;--&lt;/span&gt;&lt;span&gt;dry&lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;run&lt;/span&gt;&lt;span&gt;=&lt;/span&gt;&lt;span&gt;client &lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;o yaml &lt;/span&gt;&lt;span&gt;&amp;gt;&lt;/span&gt;&lt;span&gt; pod1&lt;/span&gt;&lt;span&gt;.&lt;/span&gt;&lt;span&gt;yaml&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/section&gt;&lt;p&gt;修改模板： 这里假设主节点的 Taint 为 &lt;code&gt;node-role.kubernetes.io/master=:NoSchedule&lt;/code&gt;&lt;/p&gt;&lt;section class=&quot;code-snippet__github&quot;&gt;&lt;pre data-lang=&quot;shell&quot;&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;# minikube 集群名为 cka，主节点同名&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;$ kubectl describe node cka &lt;/span&gt;&lt;span&gt;|&lt;/span&gt;&lt;span&gt; grep &lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;i taint&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;Taints&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;span&gt;             node&lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;role&lt;/span&gt;&lt;span&gt;.&lt;/span&gt;&lt;span&gt;kubernetes&lt;/span&gt;&lt;span&gt;.&lt;/span&gt;&lt;span&gt;io&lt;/span&gt;&lt;span&gt;/&lt;/span&gt;&lt;span&gt;master&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;span&gt;NoSchedule&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/section&gt;&lt;p&gt;最终的 pod 如下&lt;/p&gt;&lt;section class=&quot;code-snippet__github&quot;&gt;&lt;pre data-lang=&quot;yaml&quot;&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;apiVersion&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;span&gt; v1&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;kind&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;span&gt; &lt;/span&gt;&lt;span&gt;Pod&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;metadata&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;  creationTimestamp&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;span&gt; &lt;/span&gt;&lt;span&gt;null&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;  labels&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;    run&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;span&gt; pod1&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;  name&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;span&gt; pod1&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;spec&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;  containers&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;  &lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt; image&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;span&gt; httpd&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;span&gt;2.4&lt;/span&gt;&lt;span&gt;.&lt;/span&gt;&lt;span&gt;41&lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;alpine&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;    name&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;span&gt; pod1&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;    resources&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;span&gt; &lt;/span&gt;&lt;span&gt;{}&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;  dnsPolicy&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;span&gt; &lt;/span&gt;&lt;span&gt;ClusterFirst&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;  tolerations&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;  &lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt; key&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;span&gt; node&lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;role&lt;/span&gt;&lt;span&gt;.&lt;/span&gt;&lt;span&gt;kubernetes&lt;/span&gt;&lt;span&gt;.&lt;/span&gt;&lt;span&gt;io&lt;/span&gt;&lt;span&gt;/&lt;/span&gt;&lt;span&gt;master&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;    effect&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;span&gt; &lt;/span&gt;&lt;span&gt;NoSchedule&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;  nodeSelector&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;    node&lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;role&lt;/span&gt;&lt;span&gt;.&lt;/span&gt;&lt;span&gt;kubernetes&lt;/span&gt;&lt;span&gt;.&lt;/span&gt;&lt;span&gt;io&lt;/span&gt;&lt;span&gt;/&lt;/span&gt;&lt;span&gt;master&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;span&gt; &lt;/span&gt;&lt;span&gt;&quot;&quot;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;  restartPolicy&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;span&gt; &lt;/span&gt;&lt;span&gt;Always&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;status&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;span&gt; &lt;/span&gt;&lt;span&gt;{}&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/section&gt;&lt;p&gt;最后检查下是否调度到主节点上：&lt;/p&gt;&lt;section class=&quot;code-snippet__github&quot;&gt;&lt;pre data-lang=&quot;shell&quot;&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;$ kubectl &lt;/span&gt;&lt;span&gt;get&lt;/span&gt;&lt;span&gt; pod &lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;o wide&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;NAME   READY   STATUS    RESTARTS   AGE    IP           NODE   NOMINATED NODE   READINESS GATES&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;pod1   &lt;/span&gt;&lt;span&gt;1&lt;/span&gt;&lt;span&gt;/&lt;/span&gt;&lt;span&gt;1&lt;/span&gt;&lt;span&gt;     &lt;/span&gt;&lt;span&gt;Running&lt;/span&gt;&lt;span&gt;   &lt;/span&gt;&lt;span&gt;0&lt;/span&gt;&lt;span&gt;          &lt;/span&gt;&lt;span&gt;102s&lt;/span&gt;&lt;span&gt;   &lt;/span&gt;&lt;span&gt;10.244&lt;/span&gt;&lt;span&gt;.&lt;/span&gt;&lt;span&gt;0.3&lt;/span&gt;&lt;span&gt;   cka    &lt;/span&gt;&lt;span&gt;&amp;lt;none&amp;gt;&lt;/span&gt;&lt;span&gt;           &lt;/span&gt;&lt;span&gt;&amp;lt;none&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/section&gt;&lt;h2&gt;kubectl 命令和排序&lt;/h2&gt;&lt;blockquote&gt;&lt;p&gt;所有命名空间中都有各种 Pod。 将命令写入 /opt/course/5/find_pods.sh，其中列出所有按 AGE 排序的 Pod（metadata.creationTimestamp）。&lt;/p&gt;&lt;/blockquote&gt;&lt;blockquote&gt;&lt;p&gt;将第二个命令写入 /opt/course/5/find_pods_uid.sh，其中列出按字段 metadata.uid 排序的所有 Pod。对这两个命令都使用 kubectl 排序。&lt;/p&gt;&lt;/blockquote&gt;&lt;h3&gt;知识点&lt;/h3&gt;&lt;p&gt;&lt;span&gt;&lt;span&gt;•&lt;/span&gt;kubectl 命令的使用，主要是 &lt;code&gt;--all-namespaces&lt;/code&gt; （缩写 &lt;code&gt;-A&lt;/code&gt;） 和 &lt;code&gt;--sort-by&lt;/code&gt;&lt;/span&gt;&lt;/p&gt;&lt;h3&gt;解题思路&lt;/h3&gt;&lt;section class=&quot;code-snippet__github&quot;&gt;&lt;pre data-lang=&quot;shell&quot;&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;$ cat &lt;/span&gt;&lt;span&gt;&amp;gt;&lt;/span&gt;&lt;span&gt; &lt;/span&gt;&lt;span&gt;/opt/&lt;/span&gt;&lt;span&gt;course&lt;/span&gt;&lt;span&gt;/&lt;/span&gt;&lt;span&gt;5&lt;/span&gt;&lt;span&gt;/&lt;/span&gt;&lt;span&gt;find_pods&lt;/span&gt;&lt;span&gt;.&lt;/span&gt;&lt;span&gt;sh &lt;/span&gt;&lt;span&gt;&amp;lt;&amp;lt;&lt;/span&gt;&lt;span&gt;EOF&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;kubectl &lt;/span&gt;&lt;span&gt;get&lt;/span&gt;&lt;span&gt; pod &lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;A &lt;/span&gt;&lt;span&gt;--&lt;/span&gt;&lt;span&gt;sort&lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;by&lt;/span&gt;&lt;span&gt; &lt;/span&gt;&lt;span&gt;&#x27;.metadata.creationTimestamp&#x27;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;EOF&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/section&gt;&lt;section class=&quot;code-snippet__github&quot;&gt;&lt;pre data-lang=&quot;shell&quot;&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;$ cat &lt;/span&gt;&lt;span&gt;&amp;gt;&lt;/span&gt;&lt;span&gt; &lt;/span&gt;&lt;span&gt;/opt/&lt;/span&gt;&lt;span&gt;course&lt;/span&gt;&lt;span&gt;/&lt;/span&gt;&lt;span&gt;5&lt;/span&gt;&lt;span&gt;/&lt;/span&gt;&lt;span&gt;find_pods_uid&lt;/span&gt;&lt;span&gt;.&lt;/span&gt;&lt;span&gt;sh &lt;/span&gt;&lt;span&gt;&amp;lt;&amp;lt;&lt;/span&gt;&lt;span&gt;EOF&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;kubectl &lt;/span&gt;&lt;span&gt;get&lt;/span&gt;&lt;span&gt; pod &lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;A &lt;/span&gt;&lt;span&gt;--&lt;/span&gt;&lt;span&gt;sort&lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;by&lt;/span&gt;&lt;span&gt; &lt;/span&gt;&lt;span&gt;&#x27;.metadata.uid&#x27;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;EOF &lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/section&gt;&lt;h2&gt;存储：持久化卷和挂载&lt;/h2&gt;&lt;blockquote&gt;&lt;p&gt;创建一个名为 &lt;code&gt;safari-pv&lt;/code&gt; 的新 &lt;code&gt;PersistentVolume&lt;/code&gt;。它应该具有 2Gi 的容量、&lt;code&gt;accessMode&lt;/code&gt; &lt;code&gt;ReadWriteOnce&lt;/code&gt;、&lt;code&gt;hostPath&lt;/code&gt; &lt;code&gt;/Volumes/Data&lt;/code&gt; 并且没有定义 &lt;code&gt;storageClassName&lt;/code&gt;。&lt;/p&gt;&lt;/blockquote&gt;&lt;blockquote&gt;&lt;p&gt;接下来在命名空间 &lt;code&gt;project-tiger&lt;/code&gt; 中创建一个名为 &lt;code&gt;safari-pvc&lt;/code&gt; 的新 &lt;code&gt;PersistentVolumeClaim&lt;/code&gt;。 它应该请求 2Gi 存储，&lt;code&gt;accessMode&lt;/code&gt; &lt;code&gt;ReadWriteOnce&lt;/code&gt; 并且不应定义 &lt;code&gt;storageClassName&lt;/code&gt;。 PVC 应该正确绑定到 PV。&lt;/p&gt;&lt;/blockquote&gt;&lt;blockquote&gt;&lt;p&gt;最后在命名空间 &lt;code&gt;project-tiger&lt;/code&gt; 中创建一个新的 Deployment &lt;code&gt;safari&lt;/code&gt;，它将该卷挂载到 &lt;code&gt;/tmp/safari-data&lt;/code&gt;。该 Deployment 的 Pod 应该是镜像 httpd:2.4.41-alpine。&lt;/p&gt;&lt;/blockquote&gt;&lt;h3&gt;知识点&lt;/h3&gt;&lt;p&gt;&lt;span&gt;&lt;span&gt;•&lt;/span&gt;pv&lt;/span&gt;&lt;span&gt;&lt;span&gt;•&lt;/span&gt;pvc&lt;/span&gt;&lt;span&gt;&lt;span&gt;•&lt;/span&gt;pod 使用 pvc&lt;/span&gt;&lt;span&gt;&lt;span&gt;•&lt;/span&gt;deployment&lt;/span&gt;&lt;span&gt;&lt;span&gt;•&lt;/span&gt;mount PVC volume&lt;/span&gt;&lt;/p&gt;&lt;p&gt;参考文档：&lt;/p&gt;&lt;p&gt;&lt;span&gt;&lt;span&gt;•&lt;/span&gt;https://kubernetes.io/docs/tasks/configure-pod-container/configure-persistent-volume-storage/#create-a-persistentvolume&lt;/span&gt;&lt;span&gt;&lt;span&gt;•&lt;/span&gt;https://kubernetes.io/docs/tasks/configure-pod-container/configure-persistent-volume-storage/#create-a-persistentvolumeclaim&lt;/span&gt;&lt;span&gt;&lt;span&gt;•&lt;/span&gt;https://kubernetes.io/docs/concepts/storage/persistent-volumes/#claims-as-volumes&lt;/span&gt;&lt;/p&gt;&lt;h3&gt;解题思路&lt;/h3&gt;&lt;p&gt;创建 pv&lt;/p&gt;&lt;section class=&quot;code-snippet__github&quot;&gt;&lt;pre data-lang=&quot;yaml&quot;&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;apiVersion&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;span&gt; v1&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;kind&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;span&gt; &lt;/span&gt;&lt;span&gt;PersistentVolume&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;metadata&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;  name&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;span&gt; safari&lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;pv&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;  labels&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;    type&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;span&gt; &lt;/span&gt;&lt;span&gt;local&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;spec&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;  capacity&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;    storage&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;span&gt; &lt;/span&gt;&lt;span&gt;2Gi&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;  accessModes&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;    &lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt; &lt;/span&gt;&lt;span&gt;ReadWriteOnce&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;  hostPath&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;    path&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;span&gt; &lt;/span&gt;&lt;span&gt;&quot;/Volumes/Data&quot;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/section&gt;&lt;p&gt;创建 pvc&lt;/p&gt;&lt;section class=&quot;code-snippet__github&quot;&gt;&lt;pre data-lang=&quot;yaml&quot;&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;apiVersion&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;span&gt; v1&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;kind&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;span&gt; &lt;/span&gt;&lt;span&gt;PersistentVolumeClaim&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;metadata&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;  name&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;span&gt; safari&lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;pvc&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;spec&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;  accessModes&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;    &lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt; &lt;/span&gt;&lt;span&gt;ReadWriteOnce&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;  resources&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;    requests&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;      storage&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;span&gt; &lt;/span&gt;&lt;span&gt;2Gi&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/section&gt;&lt;p&gt;检查是否绑定成功&lt;/p&gt;&lt;section class=&quot;code-snippet__github&quot;&gt;&lt;pre data-lang=&quot;shell&quot;&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;$ kubectl &lt;/span&gt;&lt;span&gt;get&lt;/span&gt;&lt;span&gt; pvc&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;NAME         STATUS   VOLUME                                     CAPACITY   ACCESS MODES   STORAGECLASS   AGE&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;safari&lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;pvc   &lt;/span&gt;&lt;span&gt;Bound&lt;/span&gt;&lt;span&gt;    pvc&lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;d4c15825&lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;2de3&lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;470f&lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;8ed0&lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;9519cacaad21&lt;/span&gt;&lt;span&gt;   &lt;/span&gt;&lt;span&gt;2Gi&lt;/span&gt;&lt;span&gt;        RWO            standard       &lt;/span&gt;&lt;span&gt;24s&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/section&gt;&lt;p&gt;创建 deployment 模板&lt;/p&gt;&lt;section class=&quot;code-snippet__github&quot;&gt;&lt;pre data-lang=&quot;shell&quot;&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;$ kubectl create deployment safari &lt;/span&gt;&lt;span&gt;--&lt;/span&gt;&lt;span&gt;image httpd&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;span&gt;2.4&lt;/span&gt;&lt;span&gt;.&lt;/span&gt;&lt;span&gt;41&lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;alpine &lt;/span&gt;&lt;span&gt;--&lt;/span&gt;&lt;span&gt;dry&lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;run&lt;/span&gt;&lt;span&gt;=&lt;/span&gt;&lt;span&gt;client &lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;o yaml&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/section&gt;&lt;p&gt;最终的yaml&lt;/p&gt;&lt;section class=&quot;code-snippet__github&quot;&gt;&lt;pre data-lang=&quot;yaml&quot;&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;apiVersion&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;span&gt; apps&lt;/span&gt;&lt;span&gt;/&lt;/span&gt;&lt;span&gt;v1&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;kind&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;span&gt; &lt;/span&gt;&lt;span&gt;Deployment&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;metadata&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;  creationTimestamp&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;span&gt; &lt;/span&gt;&lt;span&gt;null&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;  labels&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;    app&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;span&gt; safari&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;  name&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;span&gt; safari&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;spec&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;  replicas&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;span&gt; &lt;/span&gt;&lt;span&gt;1&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;  selector&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;    matchLabels&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;      app&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;span&gt; safari&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;  strategy&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;span&gt; &lt;/span&gt;&lt;span&gt;{}&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;  &lt;/span&gt;&lt;span&gt;template&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;    metadata&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;      creationTimestamp&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;span&gt; &lt;/span&gt;&lt;span&gt;null&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;      labels&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;        app&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;span&gt; safari&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;    spec&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;      containers&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;      &lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt; image&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;span&gt; httpd&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;span&gt;2.4&lt;/span&gt;&lt;span&gt;.&lt;/span&gt;&lt;span&gt;41&lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;alpine&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;        name&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;span&gt; httpd&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;        resources&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;span&gt; &lt;/span&gt;&lt;span&gt;{}&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;        volumeMounts&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;        &lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt; mountPath&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;span&gt; &lt;/span&gt;&lt;span&gt;/tmp/&lt;/span&gt;&lt;span&gt;safari&lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;data&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;          name&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;span&gt; data&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;      volumes&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;      &lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt; name&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;span&gt; data&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;        persistentVolumeClaim&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;          claimName&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;span&gt; safari&lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;pvc&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;status&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;span&gt; &lt;/span&gt;&lt;span&gt;{}&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/section&gt;&lt;h2&gt;kubectl 命令和 context&lt;/h2&gt;&lt;blockquote&gt;&lt;p&gt;可以通过 kubectl 上下文从主终端访问多个集群。将所有这些上下文名称写入 /opt/course/1/contexts。&lt;/p&gt;&lt;/blockquote&gt;&lt;blockquote&gt;&lt;p&gt;接下来在 /opt/course/1/context_default_kubectl.sh 中写一个显示当前上下文的命令，该命令应该使用kubectl。&lt;/p&gt;&lt;/blockquote&gt;&lt;blockquote&gt;&lt;p&gt;最后在 /opt/course/1/context_default_no_kubectl.sh 中写入第二个执行相同操作的命令，但不使用 kubectl。&lt;/p&gt;&lt;/blockquote&gt;&lt;h3&gt;知识点&lt;/h3&gt;&lt;p&gt;kubectl config 相关命令的使用&lt;/p&gt;&lt;h3&gt;解题思路&lt;/h3&gt;&lt;section class=&quot;code-snippet__github&quot;&gt;&lt;pre data-lang=&quot;shell&quot;&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;kubectl config &lt;/span&gt;&lt;span&gt;get&lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;contexts &lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;o name &lt;/span&gt;&lt;span&gt;&amp;gt;&lt;/span&gt;&lt;span&gt; &lt;/span&gt;&lt;span&gt;/opt/&lt;/span&gt;&lt;span&gt;course&lt;/span&gt;&lt;span&gt;/&lt;/span&gt;&lt;span&gt;1&lt;/span&gt;&lt;span&gt;/&lt;/span&gt;&lt;span&gt;contexts&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/section&gt;&lt;section class=&quot;code-snippet__github&quot;&gt;&lt;pre data-lang=&quot;shell&quot;&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;cat &lt;/span&gt;&lt;span&gt;&amp;gt;&lt;/span&gt;&lt;span&gt; &lt;/span&gt;&lt;span&gt;/opt/&lt;/span&gt;&lt;span&gt;course&lt;/span&gt;&lt;span&gt;/&lt;/span&gt;&lt;span&gt;1&lt;/span&gt;&lt;span&gt;/&lt;/span&gt;&lt;span&gt;context_default_kubectl&lt;/span&gt;&lt;span&gt;.&lt;/span&gt;&lt;span&gt;sh &lt;/span&gt;&lt;span&gt;&amp;lt;&amp;lt;&lt;/span&gt;&lt;span&gt;EOF&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;kubectl config current&lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;context&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;EOF&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code/&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;chmod &lt;/span&gt;&lt;span&gt;+&lt;/span&gt;&lt;span&gt;x &lt;/span&gt;&lt;span&gt;/&lt;/span&gt;&lt;span&gt;opt&lt;/span&gt;&lt;span&gt;/&lt;/span&gt;&lt;span&gt;course&lt;/span&gt;&lt;span&gt;/&lt;/span&gt;&lt;span&gt;1&lt;/span&gt;&lt;span&gt;/&lt;/span&gt;&lt;span&gt;context_default_kubectl&lt;/span&gt;&lt;span&gt;.&lt;/span&gt;&lt;span&gt;sh&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/section&gt;&lt;section class=&quot;code-snippet__github&quot;&gt;&lt;pre data-lang=&quot;shell&quot;&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;cat &lt;/span&gt;&lt;span&gt;~&lt;/span&gt;&lt;span&gt;/.kube/&lt;/span&gt;&lt;span&gt;config &lt;/span&gt;&lt;span&gt;|&lt;/span&gt;&lt;span&gt; grep current&lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;context &lt;/span&gt;&lt;span&gt;|&lt;/span&gt;&lt;span&gt; awk &lt;/span&gt;&lt;span&gt;&#x27;{print $2}&#x27;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/section&gt;&lt;h2&gt;工作负载：缩容&lt;/h2&gt;&lt;blockquote&gt;&lt;p&gt;命名空间 &lt;code&gt;project-c13&lt;/code&gt; 中有两个名为 &lt;code&gt;o3db-*&lt;/code&gt; 的 Pod。 C13 管理层要求将 Pod 缩减为一个副本以节省资源。 记录动作。&lt;/p&gt;&lt;/blockquote&gt;&lt;h3&gt;知识点&lt;/h3&gt;&lt;p&gt;&lt;span&gt;&lt;span&gt;•&lt;/span&gt;scale&lt;/span&gt;&lt;span&gt;&lt;span&gt;•&lt;/span&gt;deploy&lt;/span&gt;&lt;span&gt;&lt;span&gt;•&lt;/span&gt;statefulset&lt;/span&gt;&lt;/p&gt;&lt;p&gt;参考文档： https://kubernetes.io/zh/docs/tasks/run-application/scale-stateful-set/ https://kubernetes.io/zh/docs/concepts/workloads/controllers/deployment/#scaling-a-deployment&lt;/p&gt;&lt;h3&gt;解题思路&lt;/h3&gt;&lt;section class=&quot;code-snippet__github&quot;&gt;&lt;pre data-lang=&quot;shell&quot;&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;kubectl scale &lt;/span&gt;&lt;span&gt;&amp;lt;resource&amp;gt;&lt;/span&gt;&lt;span&gt; xxx &lt;/span&gt;&lt;span&gt;--&lt;/span&gt;&lt;span&gt;replicas&lt;/span&gt;&lt;span&gt;=&lt;/span&gt;&lt;span&gt;1&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/section&gt;&lt;p&gt;scale 命令需要确认资源类型：deployment/statefulset&lt;/p&gt;&lt;h2&gt;应用就绪和探活&lt;/h2&gt;&lt;blockquote&gt;&lt;p&gt;在命名空间 &lt;code&gt;default&lt;/code&gt; 中执行以下操作。为 &lt;code&gt;nginx:1.16.1-alpine&lt;/code&gt; 创建一个名为 &lt;code&gt;ready-if-service-ready&lt;/code&gt; 的 Pod。配置一个 &lt;code&gt;LivenessProbe&lt;/code&gt;，它只是运行 &lt;code&gt;true&lt;/code&gt;。还要配置一个 &lt;code&gt;ReadinessProbe&lt;/code&gt; 来检查 &lt;code&gt;url&lt;/code&gt; &lt;code&gt;http://service-am-i-ready:80&lt;/code&gt; 是否可达，可以使用 &lt;code&gt;wget -T2 -O- http://service-am-i-ready:80&lt;/code&gt;。 启动 Pod 并确认它因为 &lt;code&gt;ReadinessProbe&lt;/code&gt; 而没有准备好。&lt;/p&gt;&lt;/blockquote&gt;&lt;blockquote&gt;&lt;p&gt;创建第二个名为 &lt;code&gt;am-i-ready&lt;/code&gt; 的 Pod 镜像 &lt;code&gt;nginx:1.16.1-alpine&lt;/code&gt;，标签 &lt;code&gt;id:cross-server-ready&lt;/code&gt;。已经存在的服务 &lt;code&gt;service-am-i-ready&lt;/code&gt; 现在应该有第二个 Pod 作为端点。&lt;/p&gt;&lt;/blockquote&gt;&lt;h3&gt;知识点&lt;/h3&gt;&lt;p&gt;&lt;span&gt;&lt;span&gt;•&lt;/span&gt;probe&lt;/span&gt;&lt;span&gt;&lt;span&gt;•&lt;/span&gt;pod&lt;/span&gt;&lt;/p&gt;&lt;p&gt;参考文档： https://kubernetes.io/docs/tasks/configure-pod-container/configure-liveness-readiness-startup-probes/&lt;/p&gt;&lt;h3&gt;解题思路&lt;/h3&gt;&lt;section class=&quot;code-snippet__github&quot;&gt;&lt;pre data-lang=&quot;&quot;&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;kubectl run ready&lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;if&lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;service&lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;ready &lt;/span&gt;&lt;span&gt;--&lt;/span&gt;&lt;span&gt;image nginx&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;span&gt;1.16&lt;/span&gt;&lt;span&gt;.&lt;/span&gt;&lt;span&gt;1&lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;alpine &lt;/span&gt;&lt;span&gt;--&lt;/span&gt;&lt;span&gt;dry&lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;run&lt;/span&gt;&lt;span&gt;=&lt;/span&gt;&lt;span&gt;client &lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;o yaml &lt;/span&gt;&lt;span&gt;&amp;gt;&lt;/span&gt;&lt;span&gt; ready&lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;if&lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;service&lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;ready&lt;/span&gt;&lt;span&gt;.&lt;/span&gt;&lt;span&gt;yaml&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code/&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;kubectl run am&lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;i&lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;ready &lt;/span&gt;&lt;span&gt;--&lt;/span&gt;&lt;span&gt;image nginx&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;span&gt;1.16&lt;/span&gt;&lt;span&gt;.&lt;/span&gt;&lt;span&gt;1&lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;alpine &lt;/span&gt;&lt;span&gt;--&lt;/span&gt;&lt;span&gt;labels id&lt;/span&gt;&lt;span&gt;=&lt;/span&gt;&lt;span&gt;cross&lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;server&lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;ready &lt;/span&gt;&lt;span&gt;--&lt;/span&gt;&lt;span&gt;dry&lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;run&lt;/span&gt;&lt;span&gt;=&lt;/span&gt;&lt;span&gt;client &lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;o yaml &lt;/span&gt;&lt;span&gt;&amp;gt;&lt;/span&gt;&lt;span&gt; am&lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;i&lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;ready&lt;/span&gt;&lt;span&gt;.&lt;/span&gt;&lt;span&gt;yaml&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/section&gt;&lt;p&gt;添加 probes&lt;/p&gt;&lt;section class=&quot;code-snippet__github&quot;&gt;&lt;pre data-lang=&quot;yaml&quot;&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;apiVersion&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;span&gt; v1&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;kind&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;span&gt; &lt;/span&gt;&lt;span&gt;Pod&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;metadata&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;  creationTimestamp&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;span&gt; &lt;/span&gt;&lt;span&gt;null&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;  labels&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;    run&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;span&gt; ready&lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;if&lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;service&lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;ready&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;  name&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;span&gt; ready&lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;if&lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;service&lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;ready&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;spec&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;  containers&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;  &lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt; image&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;span&gt; nginx&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;span&gt;1.16&lt;/span&gt;&lt;span&gt;.&lt;/span&gt;&lt;span&gt;1&lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;alpine&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;    name&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;span&gt; ready&lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;if&lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;service&lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;ready&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;    resources&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;span&gt; &lt;/span&gt;&lt;span&gt;{}&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;    livenessProbe&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;      &lt;/span&gt;&lt;span&gt;exec&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;        command&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;          &lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt; echo&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;          &lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt; hi&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;    readinessProbe&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;      &lt;/span&gt;&lt;span&gt;exec&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;        command&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;          &lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt; wget&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;          &lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt; &lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;T2&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;          &lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt; &lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;O&lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;          &lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt; http&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;span&gt;//service-am-i-ready:80&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;  dnsPolicy&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;span&gt; &lt;/span&gt;&lt;span&gt;ClusterFirst&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;  restartPolicy&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;span&gt; &lt;/span&gt;&lt;span&gt;Always&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;status&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;span&gt; &lt;/span&gt;&lt;span&gt;{}&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/section&gt;&lt;h2&gt;集群：控制平面&lt;/h2&gt;&lt;blockquote&gt;&lt;p&gt;使用 &lt;code&gt;ssh cluster1-master1&lt;/code&gt; ssh 进入主节点。检查 master 组件 kubelet、kube-apiserver、kube-scheduler、kube-controller-manager 和 etcd 如何在 master 节点上启动/安装。还要找出 DNS 应用的名称以及它是如何在主节点上启动/安装的。&lt;/p&gt;&lt;/blockquote&gt;&lt;blockquote&gt;&lt;p&gt;将结果写入文件 /opt/course/8/master-components.txt。该文件的结构应如下所示：&lt;/p&gt;&lt;/blockquote&gt;&lt;blockquote&gt;&lt;section class=&quot;code-snippet__github&quot;&gt;&lt;p&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;# /opt/course/8/master-components.txt&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;kubelet&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;span&gt; &lt;/span&gt;&lt;span&gt;[&lt;/span&gt;&lt;span&gt;TYPE&lt;/span&gt;&lt;span&gt;]&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;kube&lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;apiserver&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;span&gt; &lt;/span&gt;&lt;span&gt;[&lt;/span&gt;&lt;span&gt;TYPE&lt;/span&gt;&lt;span&gt;]&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;kube&lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;scheduler&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;span&gt; &lt;/span&gt;&lt;span&gt;[&lt;/span&gt;&lt;span&gt;TYPE&lt;/span&gt;&lt;span&gt;]&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;kube&lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;controller&lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;manager&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;span&gt; &lt;/span&gt;&lt;span&gt;[&lt;/span&gt;&lt;span&gt;TYPE&lt;/span&gt;&lt;span&gt;]&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;etcd&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;span&gt; &lt;/span&gt;&lt;span&gt;[&lt;/span&gt;&lt;span&gt;TYPE&lt;/span&gt;&lt;span&gt;]&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;dns&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;span&gt; &lt;/span&gt;&lt;span&gt;[&lt;/span&gt;&lt;span&gt;TYPE&lt;/span&gt;&lt;span&gt;]&lt;/span&gt;&lt;span&gt; &lt;/span&gt;&lt;span&gt;[&lt;/span&gt;&lt;span&gt;NAME&lt;/span&gt;&lt;span&gt;]&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/p&gt;&lt;/section&gt;&lt;/blockquote&gt;&lt;blockquote&gt;&lt;p&gt;Choices of [TYPE] are: not-installed, process, static-pod, pod&lt;/p&gt;&lt;/blockquote&gt;&lt;h3&gt;知识点&lt;/h3&gt;&lt;p&gt;Kubernetes components 的安装方式&lt;/p&gt;&lt;h3&gt;解题思路&lt;/h3&gt;&lt;p&gt;当前比较的组件都是以static pod的形式运行的，而 static pod 都是由 Kubelet 管理的，所以从 kubelet 处入手。&lt;/p&gt;&lt;p&gt;以 minikube 为例：&lt;/p&gt;&lt;section class=&quot;code-snippet__github&quot;&gt;&lt;pre data-lang=&quot;shell&quot;&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;$ ps &lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;ef &lt;/span&gt;&lt;span&gt;|&lt;/span&gt;&lt;span&gt; grep &lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;w kubelet&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;root      &lt;/span&gt;&lt;span&gt;140597&lt;/span&gt;&lt;span&gt;       &lt;/span&gt;&lt;span&gt;1&lt;/span&gt;&lt;span&gt;  &lt;/span&gt;&lt;span&gt;2&lt;/span&gt;&lt;span&gt; &lt;/span&gt;&lt;span&gt;May15&lt;/span&gt;&lt;span&gt; &lt;/span&gt;&lt;span&gt;?&lt;/span&gt;&lt;span&gt;        &lt;/span&gt;&lt;span&gt;00&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;span&gt;36&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;span&gt;00&lt;/span&gt;&lt;span&gt; &lt;/span&gt;&lt;span&gt;/&lt;/span&gt;&lt;span&gt;var&lt;/span&gt;&lt;span&gt;/&lt;/span&gt;&lt;span&gt;lib&lt;/span&gt;&lt;span&gt;/&lt;/span&gt;&lt;span&gt;minikube&lt;/span&gt;&lt;span&gt;/&lt;/span&gt;&lt;span&gt;binaries&lt;/span&gt;&lt;span&gt;/&lt;/span&gt;&lt;span&gt;v1&lt;/span&gt;&lt;span&gt;.&lt;/span&gt;&lt;span&gt;18.8&lt;/span&gt;&lt;span&gt;/&lt;/span&gt;&lt;span&gt;kubelet &lt;/span&gt;&lt;span&gt;--&lt;/span&gt;&lt;span&gt;bootstrap&lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;kubeconfig&lt;/span&gt;&lt;span&gt;=&lt;/span&gt;&lt;span&gt;/etc/&lt;/span&gt;&lt;span&gt;kubernetes&lt;/span&gt;&lt;span&gt;/&lt;/span&gt;&lt;span&gt;bootstrap&lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;kubelet&lt;/span&gt;&lt;span&gt;.&lt;/span&gt;&lt;span&gt;conf &lt;/span&gt;&lt;span&gt;--&lt;/span&gt;&lt;span&gt;config&lt;/span&gt;&lt;span&gt;=&lt;/span&gt;&lt;span&gt;/var/&lt;/span&gt;&lt;span&gt;lib&lt;/span&gt;&lt;span&gt;/&lt;/span&gt;&lt;span&gt;kubelet&lt;/span&gt;&lt;span&gt;/&lt;/span&gt;&lt;span&gt;config&lt;/span&gt;&lt;span&gt;.&lt;/span&gt;&lt;span&gt;yaml &lt;/span&gt;&lt;span&gt;--&lt;/span&gt;&lt;span&gt;container&lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;runtime&lt;/span&gt;&lt;span&gt;=&lt;/span&gt;&lt;span&gt;docker &lt;/span&gt;&lt;span&gt;--&lt;/span&gt;&lt;span&gt;hostname&lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;override&lt;/span&gt;&lt;span&gt;=&lt;/span&gt;&lt;span&gt;cka &lt;/span&gt;&lt;span&gt;--&lt;/span&gt;&lt;span&gt;kubeconfig&lt;/span&gt;&lt;span&gt;=&lt;/span&gt;&lt;span&gt;/etc/&lt;/span&gt;&lt;span&gt;kubernetes&lt;/span&gt;&lt;span&gt;/&lt;/span&gt;&lt;span&gt;kubelet&lt;/span&gt;&lt;span&gt;.&lt;/span&gt;&lt;span&gt;conf &lt;/span&gt;&lt;span&gt;--&lt;/span&gt;&lt;span&gt;node&lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;ip&lt;/span&gt;&lt;span&gt;=&lt;/span&gt;&lt;span&gt;192.168&lt;/span&gt;&lt;span&gt;.&lt;/span&gt;&lt;span&gt;64.3&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code/&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;$ systemctl &lt;/span&gt;&lt;span&gt;is&lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;active kubelet&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;active&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;#kubelet: process&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/section&gt;&lt;p&gt;根据前面进程中的信息，查看 &lt;code&gt;/var/lib/kubelet/config.yaml&lt;/code&gt;中的内容。可以得到：&lt;/p&gt;&lt;p&gt;etcd: static-pod kube-apiserver: static-pod kube-controller-manager: static-pod&lt;/p&gt;&lt;section class=&quot;code-snippet__github&quot;&gt;&lt;pre data-lang=&quot;shell&quot;&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;$ cat &lt;/span&gt;&lt;span&gt;/&lt;/span&gt;&lt;span&gt;var&lt;/span&gt;&lt;span&gt;/&lt;/span&gt;&lt;span&gt;lib&lt;/span&gt;&lt;span&gt;/&lt;/span&gt;&lt;span&gt;kubelet&lt;/span&gt;&lt;span&gt;/&lt;/span&gt;&lt;span&gt;config&lt;/span&gt;&lt;span&gt;.&lt;/span&gt;&lt;span&gt;yaml &lt;/span&gt;&lt;span&gt;|&lt;/span&gt;&lt;span&gt; grep &lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;i staticpod&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;staticPodPath&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;span&gt; &lt;/span&gt;&lt;span&gt;/etc/&lt;/span&gt;&lt;span&gt;kubernetes&lt;/span&gt;&lt;span&gt;/&lt;/span&gt;&lt;span&gt;manifests&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code/&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;ls &lt;/span&gt;&lt;span&gt;/&lt;/span&gt;&lt;span&gt;etc&lt;/span&gt;&lt;span&gt;/&lt;/span&gt;&lt;span&gt;kubernetes&lt;/span&gt;&lt;span&gt;/&lt;/span&gt;&lt;span&gt;manifests&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;etcd&lt;/span&gt;&lt;span&gt;.&lt;/span&gt;&lt;span&gt;yaml  kube&lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;apiserver&lt;/span&gt;&lt;span&gt;.&lt;/span&gt;&lt;span&gt;yaml    kube&lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;controller&lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;manager&lt;/span&gt;&lt;span&gt;.&lt;/span&gt;&lt;span&gt;yaml  kube&lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;scheduler&lt;/span&gt;&lt;span&gt;.&lt;/span&gt;&lt;span&gt;yaml&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/section&gt;&lt;p&gt;最后上下dns，查看下pod，得知 dns: pod&lt;/p&gt;&lt;section class=&quot;code-snippet__github&quot;&gt;&lt;pre data-lang=&quot;shell&quot;&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;$ kubectl &lt;/span&gt;&lt;span&gt;get&lt;/span&gt;&lt;span&gt; pod &lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;A &lt;/span&gt;&lt;span&gt;|&lt;/span&gt;&lt;span&gt; grep dns&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;kube&lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;system   coredns&lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;66bff467f8&lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;6k2br&lt;/span&gt;&lt;span&gt;      &lt;/span&gt;&lt;span&gt;1&lt;/span&gt;&lt;span&gt;/&lt;/span&gt;&lt;span&gt;1&lt;/span&gt;&lt;span&gt;     &lt;/span&gt;&lt;span&gt;Running&lt;/span&gt;&lt;span&gt;   &lt;/span&gt;&lt;span&gt;0&lt;/span&gt;&lt;span&gt;          &lt;/span&gt;&lt;span&gt;32h&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/section&gt;&lt;p&gt;最后将上面的结果写入到 &lt;code&gt;/opt/course/8/master-components.txt&lt;/code&gt;，不能前功尽弃。&lt;/p&gt;&lt;h2&gt;集群：Pod 调度&lt;/h2&gt;&lt;blockquote&gt;&lt;p&gt;使用 &lt;code&gt;ssh cluster2-master1&lt;/code&gt; ssh 进入主节点。暂时停止 &lt;code&gt;kube-scheduler&lt;/code&gt;，这意味着可以在之后再次启动它。&lt;/p&gt;&lt;/blockquote&gt;&lt;blockquote&gt;&lt;p&gt;为镜像 &lt;code&gt;httpd:2.4-alpine&lt;/code&gt; 创建一个名为 &lt;code&gt;manual-schedule&lt;/code&gt; 的 Pod，确认它已启动但未在任何节点上调度。&lt;/p&gt;&lt;/blockquote&gt;&lt;blockquote&gt;&lt;p&gt;现在您是调度程序并拥有所有权力，在节点 &lt;code&gt;cluster2-master1&lt;/code&gt; 上手动调度该 Pod。 确保它正在运行。&lt;/p&gt;&lt;/blockquote&gt;&lt;blockquote&gt;&lt;p&gt;再次启动 &lt;code&gt;kube-scheduler&lt;/code&gt; 并通过在镜像 &lt;code&gt;httpd:2.4-alpine&lt;/code&gt; 创建第二个名为 &lt;code&gt;manual-schedule2&lt;/code&gt; 的 Pod 并检查它是否在 &lt;code&gt;cluster2-worker1&lt;/code&gt; 上运行来确认其运行正常。&lt;/p&gt;&lt;/blockquote&gt;&lt;h3&gt;知识点&lt;/h3&gt;&lt;p&gt;&lt;span&gt;&lt;span&gt;•&lt;/span&gt;kubernetes 组件的运行方式&lt;/span&gt;&lt;span&gt;&lt;span&gt;•&lt;/span&gt;创建 pod&lt;/span&gt;&lt;span&gt;&lt;span&gt;•&lt;/span&gt;pod 调度&lt;/span&gt;&lt;/p&gt;&lt;h3&gt;解题思路&lt;/h3&gt;&lt;p&gt;kube-scheduler 是以 static pod 的方式运行，因此我们需要 ssh 到节点上，将 scheduler 的 yaml 移出（记住不要删掉，还要还原回去），重启 kubelet&lt;/p&gt;&lt;section class=&quot;code-snippet__github&quot;&gt;&lt;pre data-lang=&quot;shell&quot;&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;$ ps &lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;ef &lt;/span&gt;&lt;span&gt;|&lt;/span&gt;&lt;span&gt; grep &lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;w kubelet&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;root      &lt;/span&gt;&lt;span&gt;140597&lt;/span&gt;&lt;span&gt;       &lt;/span&gt;&lt;span&gt;1&lt;/span&gt;&lt;span&gt;  &lt;/span&gt;&lt;span&gt;2&lt;/span&gt;&lt;span&gt; &lt;/span&gt;&lt;span&gt;May15&lt;/span&gt;&lt;span&gt; &lt;/span&gt;&lt;span&gt;?&lt;/span&gt;&lt;span&gt;        &lt;/span&gt;&lt;span&gt;00&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;span&gt;36&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;span&gt;00&lt;/span&gt;&lt;span&gt; &lt;/span&gt;&lt;span&gt;/&lt;/span&gt;&lt;span&gt;var&lt;/span&gt;&lt;span&gt;/&lt;/span&gt;&lt;span&gt;lib&lt;/span&gt;&lt;span&gt;/&lt;/span&gt;&lt;span&gt;minikube&lt;/span&gt;&lt;span&gt;/&lt;/span&gt;&lt;span&gt;binaries&lt;/span&gt;&lt;span&gt;/&lt;/span&gt;&lt;span&gt;v1&lt;/span&gt;&lt;span&gt;.&lt;/span&gt;&lt;span&gt;18.8&lt;/span&gt;&lt;span&gt;/&lt;/span&gt;&lt;span&gt;kubelet &lt;/span&gt;&lt;span&gt;--&lt;/span&gt;&lt;span&gt;bootstrap&lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;kubeconfig&lt;/span&gt;&lt;span&gt;=&lt;/span&gt;&lt;span&gt;/etc/&lt;/span&gt;&lt;span&gt;kubernetes&lt;/span&gt;&lt;span&gt;/&lt;/span&gt;&lt;span&gt;bootstrap&lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;kubelet&lt;/span&gt;&lt;span&gt;.&lt;/span&gt;&lt;span&gt;conf &lt;/span&gt;&lt;span&gt;--&lt;/span&gt;&lt;span&gt;config&lt;/span&gt;&lt;span&gt;=&lt;/span&gt;&lt;span&gt;/var/&lt;/span&gt;&lt;span&gt;lib&lt;/span&gt;&lt;span&gt;/&lt;/span&gt;&lt;span&gt;kubelet&lt;/span&gt;&lt;span&gt;/&lt;/span&gt;&lt;span&gt;config&lt;/span&gt;&lt;span&gt;.&lt;/span&gt;&lt;span&gt;yaml &lt;/span&gt;&lt;span&gt;--&lt;/span&gt;&lt;span&gt;container&lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;runtime&lt;/span&gt;&lt;span&gt;=&lt;/span&gt;&lt;span&gt;docker &lt;/span&gt;&lt;span&gt;--&lt;/span&gt;&lt;span&gt;hostname&lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;override&lt;/span&gt;&lt;span&gt;=&lt;/span&gt;&lt;span&gt;cka &lt;/span&gt;&lt;span&gt;--&lt;/span&gt;&lt;span&gt;kubeconfig&lt;/span&gt;&lt;span&gt;=&lt;/span&gt;&lt;span&gt;/etc/&lt;/span&gt;&lt;span&gt;kubernetes&lt;/span&gt;&lt;span&gt;/&lt;/span&gt;&lt;span&gt;kubelet&lt;/span&gt;&lt;span&gt;.&lt;/span&gt;&lt;span&gt;conf &lt;/span&gt;&lt;span&gt;--&lt;/span&gt;&lt;span&gt;node&lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;ip&lt;/span&gt;&lt;span&gt;=&lt;/span&gt;&lt;span&gt;192.168&lt;/span&gt;&lt;span&gt;.&lt;/span&gt;&lt;span&gt;64.3&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code/&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;$ cat &lt;/span&gt;&lt;span&gt;/&lt;/span&gt;&lt;span&gt;var&lt;/span&gt;&lt;span&gt;/&lt;/span&gt;&lt;span&gt;lib&lt;/span&gt;&lt;span&gt;/&lt;/span&gt;&lt;span&gt;kubelet&lt;/span&gt;&lt;span&gt;/&lt;/span&gt;&lt;span&gt;config&lt;/span&gt;&lt;span&gt;.&lt;/span&gt;&lt;span&gt;yaml &lt;/span&gt;&lt;span&gt;|&lt;/span&gt;&lt;span&gt; grep &lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;i staticpod&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;staticPodPath&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;span&gt; &lt;/span&gt;&lt;span&gt;/etc/&lt;/span&gt;&lt;span&gt;kubernetes&lt;/span&gt;&lt;span&gt;/&lt;/span&gt;&lt;span&gt;manifests&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code/&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;$ ls &lt;/span&gt;&lt;span&gt;/&lt;/span&gt;&lt;span&gt;etc&lt;/span&gt;&lt;span&gt;/&lt;/span&gt;&lt;span&gt;kubernetes&lt;/span&gt;&lt;span&gt;/&lt;/span&gt;&lt;span&gt;manifests&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;etcd&lt;/span&gt;&lt;span&gt;.&lt;/span&gt;&lt;span&gt;yaml  kube&lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;apiserver&lt;/span&gt;&lt;span&gt;.&lt;/span&gt;&lt;span&gt;yaml    kube&lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;controller&lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;manager&lt;/span&gt;&lt;span&gt;.&lt;/span&gt;&lt;span&gt;yaml  kube&lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;scheduler&lt;/span&gt;&lt;span&gt;.&lt;/span&gt;&lt;span&gt;yaml&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code/&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;$ mv &lt;/span&gt;&lt;span&gt;/&lt;/span&gt;&lt;span&gt;etc&lt;/span&gt;&lt;span&gt;/&lt;/span&gt;&lt;span&gt;kubernetes&lt;/span&gt;&lt;span&gt;/&lt;/span&gt;&lt;span&gt;manifests&lt;/span&gt;&lt;span&gt;/&lt;/span&gt;&lt;span&gt;kube&lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;scheduler&lt;/span&gt;&lt;span&gt;.&lt;/span&gt;&lt;span&gt;yaml &lt;/span&gt;&lt;span&gt;/&lt;/span&gt;&lt;span&gt;etc&lt;/span&gt;&lt;span&gt;/&lt;/span&gt;&lt;span&gt;kubernetes&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code/&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;$ systemctl restart kubelet&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/section&gt;&lt;p&gt;检查下 schedule pod 没有运行，然后尝试创建 pod，并查看 pod 处于 pending 状态，即没有 kube-scheduler 为其调度。&lt;/p&gt;&lt;section class=&quot;code-snippet__github&quot;&gt;&lt;pre data-lang=&quot;shell&quot;&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;$ kubectl run manual&lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;schedule &lt;/span&gt;&lt;span&gt;--&lt;/span&gt;&lt;span&gt;image httpd&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;span&gt;2.4&lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;alpine&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code/&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;$ kubectl &lt;/span&gt;&lt;span&gt;get&lt;/span&gt;&lt;span&gt; pod &lt;/span&gt;&lt;span&gt;|&lt;/span&gt;&lt;span&gt; grep manual&lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;schedule&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;manual&lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;schedule          &lt;/span&gt;&lt;span&gt;0&lt;/span&gt;&lt;span&gt;/&lt;/span&gt;&lt;span&gt;1&lt;/span&gt;&lt;span&gt;     &lt;/span&gt;&lt;span&gt;Pending&lt;/span&gt;&lt;span&gt;   &lt;/span&gt;&lt;span&gt;0&lt;/span&gt;&lt;span&gt;          &lt;/span&gt;&lt;span&gt;16s&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/section&gt;&lt;p&gt;手动调度，即为 pod 指定一个 &lt;code&gt;nodeName&lt;/code&gt;，我的 minikube 只有一个 node 名为 cka，修改pod：&lt;/p&gt;&lt;section class=&quot;code-snippet__github&quot;&gt;&lt;pre data-lang=&quot;shell&quot;&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;$ kubectl &lt;/span&gt;&lt;span&gt;get&lt;/span&gt;&lt;span&gt; pod manual&lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;schedule &lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;o yaml &lt;/span&gt;&lt;span&gt;&amp;gt;&lt;/span&gt;&lt;span&gt; manual&lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;schedule&lt;/span&gt;&lt;span&gt;.&lt;/span&gt;&lt;span&gt;yaml&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/section&gt;&lt;p&gt;添加 nodeName 之后&lt;/p&gt;&lt;section class=&quot;code-snippet__github&quot;&gt;&lt;pre data-lang=&quot;yaml&quot;&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;apiVersion&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;span&gt; v1&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;kind&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;span&gt; &lt;/span&gt;&lt;span&gt;Pod&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;metadata&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;  creationTimestamp&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;span&gt; &lt;/span&gt;&lt;span&gt;&quot;2021-05-16T07:27:16Z&quot;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;  labels&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;    run&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;span&gt; manual&lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;schedule&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;  name&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;span&gt; manual&lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;schedule&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;  &lt;/span&gt;&lt;span&gt;namespace&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;span&gt; dev&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;  resourceVersion&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;span&gt; &lt;/span&gt;&lt;span&gt;&quot;84805&quot;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;  selfLink&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;span&gt; &lt;/span&gt;&lt;span&gt;/api/&lt;/span&gt;&lt;span&gt;v1&lt;/span&gt;&lt;span&gt;/&lt;/span&gt;&lt;span&gt;namespaces&lt;/span&gt;&lt;span&gt;/&lt;/span&gt;&lt;span&gt;dev&lt;/span&gt;&lt;span&gt;/&lt;/span&gt;&lt;span&gt;pods&lt;/span&gt;&lt;span&gt;/&lt;/span&gt;&lt;span&gt;manual&lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;schedule&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;  uid&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;span&gt; c4b592f6&lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;1e07&lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;4911&lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;a7fe&lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;867d813c7a55&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;spec&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;  containers&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;  &lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt; image&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;span&gt; httpd&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;span&gt;2.4&lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;alpine&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;    imagePullPolicy&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;span&gt; &lt;/span&gt;&lt;span&gt;IfNotPresent&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;    name&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;span&gt; manual&lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;schedule&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;    resources&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;span&gt; &lt;/span&gt;&lt;span&gt;{}&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;    terminationMessagePath&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;span&gt; &lt;/span&gt;&lt;span&gt;/dev/&lt;/span&gt;&lt;span&gt;termination&lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;log&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;    terminationMessagePolicy&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;span&gt; &lt;/span&gt;&lt;span&gt;File&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;    volumeMounts&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;    &lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt; mountPath&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;span&gt; &lt;/span&gt;&lt;span&gt;/var/&lt;/span&gt;&lt;span&gt;run&lt;/span&gt;&lt;span&gt;/&lt;/span&gt;&lt;span&gt;secrets&lt;/span&gt;&lt;span&gt;/&lt;/span&gt;&lt;span&gt;kubernetes&lt;/span&gt;&lt;span&gt;.&lt;/span&gt;&lt;span&gt;io&lt;/span&gt;&lt;span&gt;/&lt;/span&gt;&lt;span&gt;serviceaccount&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;      name&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;span&gt; &lt;/span&gt;&lt;span&gt;default&lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;token&lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;v7f28&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;      readOnly&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;span&gt; &lt;/span&gt;&lt;span&gt;true&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;  dnsPolicy&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;span&gt; &lt;/span&gt;&lt;span&gt;ClusterFirst&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;  nodeName&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;span&gt; cka &lt;/span&gt;&lt;span&gt;#node name here&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;  enableServiceLinks&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;span&gt; &lt;/span&gt;&lt;span&gt;true&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;  priority&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;span&gt; &lt;/span&gt;&lt;span&gt;0&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;  restartPolicy&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;span&gt; &lt;/span&gt;&lt;span&gt;Always&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;  schedulerName&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;span&gt; &lt;/span&gt;&lt;span&gt;default&lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;scheduler&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;  securityContext&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;span&gt; &lt;/span&gt;&lt;span&gt;{}&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;  serviceAccount&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;span&gt; &lt;/span&gt;&lt;span&gt;default&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;  serviceAccountName&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;span&gt; &lt;/span&gt;&lt;span&gt;default&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;  terminationGracePeriodSeconds&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;span&gt; &lt;/span&gt;&lt;span&gt;30&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;  tolerations&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;  &lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt; effect&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;span&gt; &lt;/span&gt;&lt;span&gt;NoExecute&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;    key&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;span&gt; node&lt;/span&gt;&lt;span&gt;.&lt;/span&gt;&lt;span&gt;kubernetes&lt;/span&gt;&lt;span&gt;.&lt;/span&gt;&lt;span&gt;io&lt;/span&gt;&lt;span&gt;/&lt;/span&gt;&lt;span&gt;not&lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;ready&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;    &lt;/span&gt;&lt;span&gt;operator&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;span&gt; &lt;/span&gt;&lt;span&gt;Exists&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;    tolerationSeconds&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;span&gt; &lt;/span&gt;&lt;span&gt;300&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;  &lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt; effect&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;span&gt; &lt;/span&gt;&lt;span&gt;NoExecute&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;    key&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;span&gt; node&lt;/span&gt;&lt;span&gt;.&lt;/span&gt;&lt;span&gt;kubernetes&lt;/span&gt;&lt;span&gt;.&lt;/span&gt;&lt;span&gt;io&lt;/span&gt;&lt;span&gt;/&lt;/span&gt;&lt;span&gt;unreachable&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;    &lt;/span&gt;&lt;span&gt;operator&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;span&gt; &lt;/span&gt;&lt;span&gt;Exists&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;    tolerationSeconds&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;span&gt; &lt;/span&gt;&lt;span&gt;300&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;  volumes&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;  &lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt; name&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;span&gt; &lt;/span&gt;&lt;span&gt;default&lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;token&lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;v7f28&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;    secret&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;      defaultMode&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;span&gt; &lt;/span&gt;&lt;span&gt;420&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;      secretName&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;span&gt; &lt;/span&gt;&lt;span&gt;default&lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;token&lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;v7f28&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;status&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;  phase&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;span&gt; &lt;/span&gt;&lt;span&gt;Pending&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;  qosClass&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;span&gt; &lt;/span&gt;&lt;span&gt;BestEffort&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/section&gt;&lt;p&gt;强制更新 pod（运行时只能修改部分内容）：&lt;/p&gt;&lt;section class=&quot;code-snippet__github&quot;&gt;&lt;pre data-lang=&quot;shell&quot;&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;$ kubectl replace &lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;f manual&lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;schedule&lt;/span&gt;&lt;span&gt;.&lt;/span&gt;&lt;span&gt;yaml &lt;/span&gt;&lt;span&gt;--&lt;/span&gt;&lt;span&gt;force&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;pod &lt;/span&gt;&lt;span&gt;&quot;manual-schedule&quot;&lt;/span&gt;&lt;span&gt; deleted&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;pod&lt;/span&gt;&lt;span&gt;/&lt;/span&gt;&lt;span&gt;manual&lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;schedule replaced&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/section&gt;&lt;p&gt;再次检查&lt;/p&gt;&lt;section class=&quot;code-snippet__github&quot;&gt;&lt;pre data-lang=&quot;shell&quot;&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;$ kubectl &lt;/span&gt;&lt;span&gt;get&lt;/span&gt;&lt;span&gt; pod &lt;/span&gt;&lt;span&gt;|&lt;/span&gt;&lt;span&gt; grep manual&lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;schedule&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;manual&lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;schedule          &lt;/span&gt;&lt;span&gt;1&lt;/span&gt;&lt;span&gt;/&lt;/span&gt;&lt;span&gt;1&lt;/span&gt;&lt;span&gt;     &lt;/span&gt;&lt;span&gt;Running&lt;/span&gt;&lt;span&gt;   &lt;/span&gt;&lt;span&gt;0&lt;/span&gt;&lt;span&gt;          &lt;/span&gt;&lt;span&gt;15s&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/section&gt;&lt;p&gt;恢复 kube-scheduler 的运行：&lt;/p&gt;&lt;section class=&quot;code-snippet__github&quot;&gt;&lt;pre data-lang=&quot;shell&quot;&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;$ mv &lt;/span&gt;&lt;span&gt;/&lt;/span&gt;&lt;span&gt;etc&lt;/span&gt;&lt;span&gt;/&lt;/span&gt;&lt;span&gt;kubernetes&lt;/span&gt;&lt;span&gt;/&lt;/span&gt;&lt;span&gt;kube&lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;scheduler&lt;/span&gt;&lt;span&gt;.&lt;/span&gt;&lt;span&gt;yaml &lt;/span&gt;&lt;span&gt;/&lt;/span&gt;&lt;span&gt;etc&lt;/span&gt;&lt;span&gt;/&lt;/span&gt;&lt;span&gt;kubernetes&lt;/span&gt;&lt;span&gt;/&lt;/span&gt;&lt;span&gt;manifests&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;$ systemctl restart kubelet&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/section&gt;&lt;p&gt;检查是否运行&lt;/p&gt;&lt;section class=&quot;code-snippet__github&quot;&gt;&lt;pre data-lang=&quot;shell&quot;&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;$ kubectl &lt;/span&gt;&lt;span&gt;get&lt;/span&gt;&lt;span&gt; pod &lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;A &lt;/span&gt;&lt;span&gt;|&lt;/span&gt;&lt;span&gt; grep kube&lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;scheduler&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;kube&lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;system   kube&lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;scheduler&lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;cka            &lt;/span&gt;&lt;span&gt;1&lt;/span&gt;&lt;span&gt;/&lt;/span&gt;&lt;span&gt;1&lt;/span&gt;&lt;span&gt;     &lt;/span&gt;&lt;span&gt;Running&lt;/span&gt;&lt;span&gt;   &lt;/span&gt;&lt;span&gt;0&lt;/span&gt;&lt;span&gt;          &lt;/span&gt;&lt;span&gt;66s&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/section&gt;&lt;p&gt;创建第二个pod，并检查是否在运行（running）状态&lt;/p&gt;&lt;section class=&quot;code-snippet__github&quot;&gt;&lt;pre data-lang=&quot;shell&quot;&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;$ kubectl run manual&lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;schedule2 &lt;/span&gt;&lt;span&gt;--&lt;/span&gt;&lt;span&gt;image httpd&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;span&gt;2.4&lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;alpine&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;pod&lt;/span&gt;&lt;span&gt;/&lt;/span&gt;&lt;span&gt;manual&lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;schedule2 created&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code/&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;kubectl &lt;/span&gt;&lt;span&gt;get&lt;/span&gt;&lt;span&gt; pod manual&lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;schedule2&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;NAME               READY   STATUS    RESTARTS   AGE&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;manual&lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;schedule2   &lt;/span&gt;&lt;span&gt;1&lt;/span&gt;&lt;span&gt;/&lt;/span&gt;&lt;span&gt;1&lt;/span&gt;&lt;span&gt;     &lt;/span&gt;&lt;span&gt;Running&lt;/span&gt;&lt;span&gt;   &lt;/span&gt;&lt;span&gt;0&lt;/span&gt;&lt;span&gt;          &lt;/span&gt;&lt;span&gt;6s&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/section&gt;&lt;h2&gt;集群：备份及恢复&lt;/h2&gt;&lt;blockquote&gt;&lt;p&gt;对在 &lt;code&gt;cluster3-master1&lt;/code&gt; 上运行的 etcd 进行备份，并将其保存在主节点上的 &lt;code&gt;/tmp/etcd-backup.db&lt;/code&gt;。&lt;/p&gt;&lt;/blockquote&gt;&lt;blockquote&gt;&lt;p&gt;然后在集群中创建一个你喜欢的 Pod。&lt;/p&gt;&lt;/blockquote&gt;&lt;blockquote&gt;&lt;p&gt;最后恢复备份，确认集群仍在工作并且创建的 Pod 不再与我们在一起。&lt;/p&gt;&lt;/blockquote&gt;&lt;h3&gt;知识点&lt;/h3&gt;&lt;p&gt;&lt;span&gt;&lt;span&gt;•&lt;/span&gt;etc 的作用：存储集群的状态信息，包括 pod 信息&lt;/span&gt;&lt;span&gt;&lt;span&gt;•&lt;/span&gt;etc 的备份和恢复&lt;/span&gt;&lt;/p&gt;&lt;p&gt;参考文档： https://kubernetes.io/docs/tasks/administer-cluster/configure-upgrade-etcd/#backing-up-an-etcd-cluster&lt;/p&gt;&lt;h3&gt;解题思路&lt;/h3&gt;&lt;p&gt;etcd的命令执行，记得设置API的版本 &lt;code&gt;ETCDCTL_API=3&lt;/code&gt;&lt;/p&gt;&lt;p&gt;操作 etcd 需要 &lt;code&gt;endpoints&lt;/code&gt;、&lt;code&gt;cacert&lt;/code&gt;、&lt;code&gt;cert&lt;/code&gt;、&lt;code&gt;key&lt;/code&gt;。Kubernetes 的所有组件与 etcd 的数据交互都是通过 api-server 完成的，我只需要找到 api-server 的运行命令就行，两种方式：到 master 主机查看 api-server 的进程；或者去 api-server 的 pod 查看 &lt;code&gt;.spec.containers[].command&lt;/code&gt;&lt;/p&gt;&lt;section class=&quot;code-snippet__github&quot;&gt;&lt;pre data-lang=&quot;shell&quot;&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;#ssh to master&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;$ ps &lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;ef &lt;/span&gt;&lt;span&gt;|&lt;/span&gt;&lt;span&gt; grep kube&lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;apiserver&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code/&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;$ kubectl &lt;/span&gt;&lt;span&gt;get&lt;/span&gt;&lt;span&gt; pod &lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;n kube&lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;system kube&lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;apiserver&lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;cka &lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;o jsonpath&lt;/span&gt;&lt;span&gt;=&lt;/span&gt;&lt;span&gt;&#x27;{.spec.containers[].command}&#x27;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/section&gt;&lt;p&gt;etcd 备份，命令直接从 Kubernetes 官方文档复制再修改&lt;/p&gt;&lt;section class=&quot;code-snippet__github&quot;&gt;&lt;pre data-lang=&quot;shell&quot;&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;#ssh to master&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code/&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;$ETCDCTL_API&lt;/span&gt;&lt;span&gt;=&lt;/span&gt;&lt;span&gt;3&lt;/span&gt;&lt;span&gt; etcdctl &lt;/span&gt;&lt;span&gt;--&lt;/span&gt;&lt;span&gt;endpoints&lt;/span&gt;&lt;span&gt;=&lt;/span&gt;&lt;span&gt;https&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;span&gt;//127.0.0.1:2379 \&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;  &lt;/span&gt;&lt;span&gt;--&lt;/span&gt;&lt;span&gt;cacert&lt;/span&gt;&lt;span&gt;=&lt;/span&gt;&lt;span&gt;/var/&lt;/span&gt;&lt;span&gt;lib&lt;/span&gt;&lt;span&gt;/&lt;/span&gt;&lt;span&gt;minikube&lt;/span&gt;&lt;span&gt;/&lt;/span&gt;&lt;span&gt;certs&lt;/span&gt;&lt;span&gt;/&lt;/span&gt;&lt;span&gt;etcd&lt;/span&gt;&lt;span&gt;/&lt;/span&gt;&lt;span&gt;ca&lt;/span&gt;&lt;span&gt;.&lt;/span&gt;&lt;span&gt;crt &lt;/span&gt;&lt;span&gt;--&lt;/span&gt;&lt;span&gt;cert&lt;/span&gt;&lt;span&gt;=&lt;/span&gt;&lt;span&gt;/var/&lt;/span&gt;&lt;span&gt;lib&lt;/span&gt;&lt;span&gt;/&lt;/span&gt;&lt;span&gt;minikube&lt;/span&gt;&lt;span&gt;/&lt;/span&gt;&lt;span&gt;certs&lt;/span&gt;&lt;span&gt;/&lt;/span&gt;&lt;span&gt;apiserver&lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;etcd&lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;client&lt;/span&gt;&lt;span&gt;.&lt;/span&gt;&lt;span&gt;crt &lt;/span&gt;&lt;span&gt;--&lt;/span&gt;&lt;span&gt;key&lt;/span&gt;&lt;span&gt;=&lt;/span&gt;&lt;span&gt;/var/&lt;/span&gt;&lt;span&gt;lib&lt;/span&gt;&lt;span&gt;/&lt;/span&gt;&lt;span&gt;minikube&lt;/span&gt;&lt;span&gt;/&lt;/span&gt;&lt;span&gt;certs&lt;/span&gt;&lt;span&gt;/&lt;/span&gt;&lt;span&gt;apiserver&lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;etcd&lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;client&lt;/span&gt;&lt;span&gt;.&lt;/span&gt;&lt;span&gt;key \&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;  snapshot save &lt;/span&gt;&lt;span&gt;/&lt;/span&gt;&lt;span&gt;tmp&lt;/span&gt;&lt;span&gt;/&lt;/span&gt;&lt;span&gt;etcd&lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;backup&lt;/span&gt;&lt;span&gt;.&lt;/span&gt;&lt;span&gt;db&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;Snapshot&lt;/span&gt;&lt;span&gt; saved at &lt;/span&gt;&lt;span&gt;/&lt;/span&gt;&lt;span&gt;tmp&lt;/span&gt;&lt;span&gt;/&lt;/span&gt;&lt;span&gt;etcd&lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;backup&lt;/span&gt;&lt;span&gt;.&lt;/span&gt;&lt;span&gt;db&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/section&gt;&lt;p&gt;创建 pod&lt;/p&gt;&lt;section class=&quot;code-snippet__github&quot;&gt;&lt;pre data-lang=&quot;shell&quot;&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;$ kubectl run sleep1d &lt;/span&gt;&lt;span&gt;--&lt;/span&gt;&lt;span&gt;image busybox &lt;/span&gt;&lt;span&gt;--&lt;/span&gt;&lt;span&gt;command &lt;/span&gt;&lt;span&gt;--&lt;/span&gt;&lt;span&gt; sleep &lt;/span&gt;&lt;span&gt;1d&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;#检查 pod 运行情况&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;$ kubectl &lt;/span&gt;&lt;span&gt;get&lt;/span&gt;&lt;span&gt; pod&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;NAME      READY   STATUS    RESTARTS   AGE&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;sleep1d   &lt;/span&gt;&lt;span&gt;1&lt;/span&gt;&lt;span&gt;/&lt;/span&gt;&lt;span&gt;1&lt;/span&gt;&lt;span&gt;     &lt;/span&gt;&lt;span&gt;Running&lt;/span&gt;&lt;span&gt;   &lt;/span&gt;&lt;span&gt;0&lt;/span&gt;&lt;span&gt;          &lt;/span&gt;&lt;span&gt;10s&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/section&gt;&lt;p&gt;恢复 etcd 的备份，复制前面的命令并修改，恢复备份到 &lt;code&gt;/var/lib/etcd-backup&lt;/code&gt;&lt;/p&gt;&lt;section class=&quot;code-snippet__github&quot;&gt;&lt;pre data-lang=&quot;shell&quot;&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;$ ETCDCTL_API&lt;/span&gt;&lt;span&gt;=&lt;/span&gt;&lt;span&gt;3&lt;/span&gt;&lt;span&gt; etcdctl &lt;/span&gt;&lt;span&gt;--&lt;/span&gt;&lt;span&gt;endpoints&lt;/span&gt;&lt;span&gt;=&lt;/span&gt;&lt;span&gt;https&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;span&gt;//127.0.0.1:2379 --cacert=/var/lib/minikube/certs/etcd/ca.crt --cert=/var/lib/minikube/certs/apiserver-etcd-client.crt --key=/var/lib/minikube/certs/apiserver-etcd-client.key snapshot restore /tmp/etcd-backup.db --data-dir /var/lib/etcd-backup&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;2021&lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;05&lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;16&lt;/span&gt;&lt;span&gt; &lt;/span&gt;&lt;span&gt;08&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;span&gt;09&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;span&gt;17.797061&lt;/span&gt;&lt;span&gt; I &lt;/span&gt;&lt;span&gt;|&lt;/span&gt;&lt;span&gt; mvcc&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;span&gt; restore compact to &lt;/span&gt;&lt;span&gt;85347&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;2021&lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;05&lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;16&lt;/span&gt;&lt;span&gt; &lt;/span&gt;&lt;span&gt;08&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;span&gt;09&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;span&gt;17.803208&lt;/span&gt;&lt;span&gt; I &lt;/span&gt;&lt;span&gt;|&lt;/span&gt;&lt;span&gt; etcdserver&lt;/span&gt;&lt;span&gt;/&lt;/span&gt;&lt;span&gt;membership&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;span&gt; added member &lt;/span&gt;&lt;span&gt;8e9e05c52164694d&lt;/span&gt;&lt;span&gt; &lt;/span&gt;&lt;span&gt;[&lt;/span&gt;&lt;span&gt;http&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;span&gt;//localhost:2380] to cluster cdf818194e3a8c32&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/section&gt;&lt;p&gt;修改 etcd 的配置， &lt;code&gt;/etc/kubernetes/manifests/etcd.yaml&lt;/code&gt;&lt;/p&gt;&lt;section class=&quot;code-snippet__github&quot;&gt;&lt;pre data-lang=&quot;yaml&quot;&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;  volumes&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;  &lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt; hostPath&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;      path&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;span&gt; &lt;/span&gt;&lt;span&gt;/var/&lt;/span&gt;&lt;span&gt;lib&lt;/span&gt;&lt;span&gt;/&lt;/span&gt;&lt;span&gt;minikube&lt;/span&gt;&lt;span&gt;/&lt;/span&gt;&lt;span&gt;certs&lt;/span&gt;&lt;span&gt;/&lt;/span&gt;&lt;span&gt;etcd&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;      type&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;span&gt; &lt;/span&gt;&lt;span&gt;DirectoryOrCreate&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;    name&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;span&gt; etcd&lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;certs&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;  &lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt; hostPath&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;      path&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;span&gt; &lt;/span&gt;&lt;span&gt;/var/&lt;/span&gt;&lt;span&gt;lib&lt;/span&gt;&lt;span&gt;/&lt;/span&gt;&lt;span&gt;etcd&lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;backup  &lt;/span&gt;&lt;span&gt;#原来是/var/lib/minikube/etcd&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;      type&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;span&gt; &lt;/span&gt;&lt;span&gt;DirectoryOrCreate&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;    name&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;span&gt; etcd&lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;data&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;status&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;span&gt; &lt;/span&gt;&lt;span&gt;{}&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/section&gt;&lt;p&gt;保存后重启kubelet&lt;/p&gt;&lt;section class=&quot;code-snippet__github&quot;&gt;&lt;pre data-lang=&quot;shell&quot;&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;$ systemctl restart kubelet&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/section&gt;&lt;p&gt;检查pod是否存在：&lt;/p&gt;&lt;section class=&quot;code-snippet__github&quot;&gt;&lt;pre data-lang=&quot;shell&quot;&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;$ kubectl &lt;/span&gt;&lt;span&gt;get&lt;/span&gt;&lt;span&gt; pod sleep1d&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;Error&lt;/span&gt;&lt;span&gt; &lt;/span&gt;&lt;span&gt;from&lt;/span&gt;&lt;span&gt; server &lt;/span&gt;&lt;span&gt;(&lt;/span&gt;&lt;span&gt;NotFound&lt;/span&gt;&lt;span&gt;):&lt;/span&gt;&lt;span&gt; pods &lt;/span&gt;&lt;span&gt;&quot;sleep1d&quot;&lt;/span&gt;&lt;span&gt; &lt;/span&gt;&lt;span&gt;not&lt;/span&gt;&lt;span&gt; found&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/section&gt;&lt;h2&gt;安全：网络策略&lt;/h2&gt;&lt;blockquote&gt;&lt;p&gt;发生了一起安全事件，入侵者能够从一个被黑的后端 Pod 访问整个集群。&lt;/p&gt;&lt;/blockquote&gt;&lt;blockquote&gt;&lt;p&gt;为了防止这种情况，在命名空间 &lt;code&gt;project-snake&lt;/code&gt; 中创建一个名为 &lt;code&gt;np-backend&lt;/code&gt; 的 &lt;code&gt;NetworkPolicy&lt;/code&gt;。它应该只允许 &lt;code&gt;backend-*&lt;/code&gt; Pods：&lt;/p&gt;&lt;/blockquote&gt;&lt;blockquote&gt;&lt;p&gt;连接到端口 &lt;code&gt;1111&lt;/code&gt; 上的 &lt;code&gt;db1-*&lt;/code&gt; Pod 连接到端口 &lt;code&gt;2222&lt;/code&gt; 上的 &lt;code&gt;db2-*&lt;/code&gt; Pod 在策略中使用 Pod 的应用程序标签。&lt;/p&gt;&lt;/blockquote&gt;&lt;blockquote&gt;&lt;p&gt;实施后，例如，端口 3333 上从 &lt;code&gt;backend-*&lt;/code&gt; Pod 到 &lt;code&gt;vault-*&lt;/code&gt; Pod 的连接应该不再有效。&lt;/p&gt;&lt;/blockquote&gt;&lt;h3&gt;知识点&lt;/h3&gt;&lt;p&gt;&lt;span&gt;&lt;span&gt;•&lt;/span&gt;NetworkPolicy&lt;/span&gt;&lt;/p&gt;&lt;p&gt;参考文档： https://kubernetes.io/docs/concepts/services-networking/network-policies&lt;/p&gt;&lt;h3&gt;解题思路&lt;/h3&gt;&lt;p&gt;为 backend-* pod 设置 egress 的 NetworkPolicy，只允许其访问 db1-* 的 1111 端口和 db2-* 的 2222 端口，策略中使用 app label 来进行匹配。&lt;/p&gt;&lt;p&gt;从 Kubernetes 官网文档中复制一段yaml配置进行修改。&lt;/p&gt;&lt;section class=&quot;code-snippet__github&quot;&gt;&lt;pre data-lang=&quot;yaml&quot;&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;apiVersion&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;span&gt; networking&lt;/span&gt;&lt;span&gt;.&lt;/span&gt;&lt;span&gt;k8s&lt;/span&gt;&lt;span&gt;.&lt;/span&gt;&lt;span&gt;io&lt;/span&gt;&lt;span&gt;/&lt;/span&gt;&lt;span&gt;v1&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;kind&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;span&gt; &lt;/span&gt;&lt;span&gt;NetworkPolicy&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;metadata&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;  name&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;span&gt; np&lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;backend&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;  &lt;/span&gt;&lt;span&gt;namespace&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;span&gt; project&lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;snake&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;spec&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;  podSelector&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;    matchLabels&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;      app&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;span&gt; backend&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;  policyTypes&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;  &lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt; &lt;/span&gt;&lt;span&gt;Egress&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;  egress&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;  &lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt; to&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;    &lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt; podSelector&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;        matchLabels&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;          app&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;span&gt; db1&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;    ports&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;    &lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt; protocol&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;span&gt; TCP&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;      port&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;span&gt; &lt;/span&gt;&lt;span&gt;1111&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;  &lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt; to&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;span&gt;                &lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;    &lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt; podSelector&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;        matchLabels&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;          app&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;span&gt; db2          &lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;    ports&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;    &lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt; protocol&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;span&gt; TCP&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;      port&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;span&gt; &lt;/span&gt;&lt;span&gt;2222&lt;/span&gt;&lt;span&gt;      &lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/section&gt;&lt;p&gt;假设 backend pod 的 app label 为 backend，db1 的 为 db1，db2 的为 db2。&lt;/p&gt;&lt;p&gt;创建环境：&lt;/p&gt;&lt;section class=&quot;code-snippet__github&quot;&gt;&lt;pre data-lang=&quot;shell&quot;&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;$ kubectl run backend &lt;/span&gt;&lt;span&gt;--&lt;/span&gt;&lt;span&gt;image nginx &lt;/span&gt;&lt;span&gt;--&lt;/span&gt;&lt;span&gt;labels app&lt;/span&gt;&lt;span&gt;=&lt;/span&gt;&lt;span&gt;backend&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;$ kubectl run db1 &lt;/span&gt;&lt;span&gt;--&lt;/span&gt;&lt;span&gt;image nginx &lt;/span&gt;&lt;span&gt;--&lt;/span&gt;&lt;span&gt;labels app&lt;/span&gt;&lt;span&gt;=&lt;/span&gt;&lt;span&gt;db1&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;$ kubectl run db2 &lt;/span&gt;&lt;span&gt;--&lt;/span&gt;&lt;span&gt;image nginx &lt;/span&gt;&lt;span&gt;--&lt;/span&gt;&lt;span&gt;labels app&lt;/span&gt;&lt;span&gt;=&lt;/span&gt;&lt;span&gt;db2&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;$ kubectl run vault &lt;/span&gt;&lt;span&gt;--&lt;/span&gt;&lt;span&gt;image nginx &lt;/span&gt;&lt;span&gt;--&lt;/span&gt;&lt;span&gt;labels app&lt;/span&gt;&lt;span&gt;=&lt;/span&gt;&lt;span&gt;vault&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code/&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;$ kubectl &lt;/span&gt;&lt;span&gt;get&lt;/span&gt;&lt;span&gt; pod &lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;L app&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;NAME      READY   STATUS              RESTARTS   AGE   APP&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;backend   &lt;/span&gt;&lt;span&gt;1&lt;/span&gt;&lt;span&gt;/&lt;/span&gt;&lt;span&gt;1&lt;/span&gt;&lt;span&gt;     &lt;/span&gt;&lt;span&gt;Running&lt;/span&gt;&lt;span&gt;   &lt;/span&gt;&lt;span&gt;0&lt;/span&gt;&lt;span&gt;          &lt;/span&gt;&lt;span&gt;13s&lt;/span&gt;&lt;span&gt;   backend&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;db1       &lt;/span&gt;&lt;span&gt;1&lt;/span&gt;&lt;span&gt;/&lt;/span&gt;&lt;span&gt;1&lt;/span&gt;&lt;span&gt;     &lt;/span&gt;&lt;span&gt;Running&lt;/span&gt;&lt;span&gt;             &lt;/span&gt;&lt;span&gt;0&lt;/span&gt;&lt;span&gt;          &lt;/span&gt;&lt;span&gt;66s&lt;/span&gt;&lt;span&gt;   db1&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;db2       &lt;/span&gt;&lt;span&gt;1&lt;/span&gt;&lt;span&gt;/&lt;/span&gt;&lt;span&gt;1&lt;/span&gt;&lt;span&gt;     &lt;/span&gt;&lt;span&gt;Running&lt;/span&gt;&lt;span&gt;             &lt;/span&gt;&lt;span&gt;0&lt;/span&gt;&lt;span&gt;          &lt;/span&gt;&lt;span&gt;71s&lt;/span&gt;&lt;span&gt;   db2&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;vault     &lt;/span&gt;&lt;span&gt;1&lt;/span&gt;&lt;span&gt;/&lt;/span&gt;&lt;span&gt;1&lt;/span&gt;&lt;span&gt;     &lt;/span&gt;&lt;span&gt;Running&lt;/span&gt;&lt;span&gt;             &lt;/span&gt;&lt;span&gt;0&lt;/span&gt;&lt;span&gt;          &lt;/span&gt;&lt;span&gt;79s&lt;/span&gt;&lt;span&gt;   vault&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/section&gt;&lt;p&gt;由于我们用的 nginx 镜像，将前面的 NetworkPolicy 端口修改一下：&lt;/p&gt;&lt;section class=&quot;code-snippet__github&quot;&gt;&lt;pre data-lang=&quot;yaml&quot;&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;apiVersion&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;span&gt; networking&lt;/span&gt;&lt;span&gt;.&lt;/span&gt;&lt;span&gt;k8s&lt;/span&gt;&lt;span&gt;.&lt;/span&gt;&lt;span&gt;io&lt;/span&gt;&lt;span&gt;/&lt;/span&gt;&lt;span&gt;v1&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;kind&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;span&gt; &lt;/span&gt;&lt;span&gt;NetworkPolicy&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;metadata&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;  name&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;span&gt; np&lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;backend&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;spec&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;  podSelector&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;    matchLabels&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;      app&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;span&gt; backend&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;  policyTypes&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;  &lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt; &lt;/span&gt;&lt;span&gt;Egress&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;  egress&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;  &lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt; to&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;    &lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt; podSelector&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;        matchLabels&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;          app&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;span&gt; db1&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;    ports&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;    &lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt; protocol&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;span&gt; TCP&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;      port&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;span&gt; &lt;/span&gt;&lt;span&gt;80&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;  &lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt; to&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;span&gt;                &lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;    &lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt; podSelector&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;        matchLabels&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;          app&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;span&gt; db2          &lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;    ports&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;    &lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt; protocol&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;span&gt; TCP&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;      port&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;span&gt; &lt;/span&gt;&lt;span&gt;80&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/section&gt;&lt;p&gt;检查一下：&lt;/p&gt;&lt;section class=&quot;code-snippet__github&quot;&gt;&lt;pre data-lang=&quot;shell&quot;&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;$ kubectl &lt;/span&gt;&lt;span&gt;get&lt;/span&gt;&lt;span&gt; networkpolicy&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;NAME         POD&lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;SELECTOR   AGE&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;np&lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;backend   app&lt;/span&gt;&lt;span&gt;=&lt;/span&gt;&lt;span&gt;backend    &lt;/span&gt;&lt;span&gt;31s&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/section&gt;&lt;p&gt;测试下网络：&lt;/p&gt;&lt;section class=&quot;code-snippet__github&quot;&gt;&lt;pre data-lang=&quot;shell&quot;&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;#获取pod ip&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;$ kubectl &lt;/span&gt;&lt;span&gt;get&lt;/span&gt;&lt;span&gt; pod &lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;o wide&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;NAME      READY   STATUS    RESTARTS   AGE     IP           NODE   NOMINATED NODE   READINESS GATES&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;backend   &lt;/span&gt;&lt;span&gt;1&lt;/span&gt;&lt;span&gt;/&lt;/span&gt;&lt;span&gt;1&lt;/span&gt;&lt;span&gt;     &lt;/span&gt;&lt;span&gt;Running&lt;/span&gt;&lt;span&gt;   &lt;/span&gt;&lt;span&gt;0&lt;/span&gt;&lt;span&gt;          &lt;/span&gt;&lt;span&gt;3m15s&lt;/span&gt;&lt;span&gt;   &lt;/span&gt;&lt;span&gt;172.17&lt;/span&gt;&lt;span&gt;.&lt;/span&gt;&lt;span&gt;0.7&lt;/span&gt;&lt;span&gt;   cka    &lt;/span&gt;&lt;span&gt;&amp;lt;none&amp;gt;&lt;/span&gt;&lt;span&gt;           &lt;/span&gt;&lt;span&gt;&amp;lt;none&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;db1       &lt;/span&gt;&lt;span&gt;1&lt;/span&gt;&lt;span&gt;/&lt;/span&gt;&lt;span&gt;1&lt;/span&gt;&lt;span&gt;     &lt;/span&gt;&lt;span&gt;Running&lt;/span&gt;&lt;span&gt;   &lt;/span&gt;&lt;span&gt;0&lt;/span&gt;&lt;span&gt;          &lt;/span&gt;&lt;span&gt;4m8s&lt;/span&gt;&lt;span&gt;    &lt;/span&gt;&lt;span&gt;172.17&lt;/span&gt;&lt;span&gt;.&lt;/span&gt;&lt;span&gt;0.6&lt;/span&gt;&lt;span&gt;   cka    &lt;/span&gt;&lt;span&gt;&amp;lt;none&amp;gt;&lt;/span&gt;&lt;span&gt;           &lt;/span&gt;&lt;span&gt;&amp;lt;none&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;db2       &lt;/span&gt;&lt;span&gt;1&lt;/span&gt;&lt;span&gt;/&lt;/span&gt;&lt;span&gt;1&lt;/span&gt;&lt;span&gt;     &lt;/span&gt;&lt;span&gt;Running&lt;/span&gt;&lt;span&gt;   &lt;/span&gt;&lt;span&gt;0&lt;/span&gt;&lt;span&gt;          &lt;/span&gt;&lt;span&gt;4m13s&lt;/span&gt;&lt;span&gt;   &lt;/span&gt;&lt;span&gt;172.17&lt;/span&gt;&lt;span&gt;.&lt;/span&gt;&lt;span&gt;0.3&lt;/span&gt;&lt;span&gt;   cka    &lt;/span&gt;&lt;span&gt;&amp;lt;none&amp;gt;&lt;/span&gt;&lt;span&gt;           &lt;/span&gt;&lt;span&gt;&amp;lt;none&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;vault     &lt;/span&gt;&lt;span&gt;1&lt;/span&gt;&lt;span&gt;/&lt;/span&gt;&lt;span&gt;1&lt;/span&gt;&lt;span&gt;     &lt;/span&gt;&lt;span&gt;Running&lt;/span&gt;&lt;span&gt;   &lt;/span&gt;&lt;span&gt;0&lt;/span&gt;&lt;span&gt;          &lt;/span&gt;&lt;span&gt;4m21s&lt;/span&gt;&lt;span&gt;   &lt;/span&gt;&lt;span&gt;172.17&lt;/span&gt;&lt;span&gt;.&lt;/span&gt;&lt;span&gt;0.4&lt;/span&gt;&lt;span&gt;   cka    &lt;/span&gt;&lt;span&gt;&amp;lt;none&amp;gt;&lt;/span&gt;&lt;span&gt;           &lt;/span&gt;&lt;span&gt;&amp;lt;none&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code/&gt;&lt;/pre&gt;&lt;/section&gt;&lt;h2&gt;集群：kubelet 启动方式&lt;/h2&gt;&lt;blockquote&gt;&lt;p&gt;节点 &lt;code&gt;cluster2-worker1&lt;/code&gt; 已使用 kubeadm 和 TLS 引导添加到集群中。 找到 &lt;code&gt;cluster2-worker1&lt;/code&gt; 的 “Issuer” 和 “Extended Key Usage” 值： kubelet 客户端证书，用于向外连接到 kube-apiserver 的证书。 kubelet 服务器证书，用于来自 kube-apiserver 的传入连接。 将信息写入文件 &lt;code&gt;/opt/course/23/certificate-info.txt&lt;/code&gt;。&lt;/p&gt;&lt;/blockquote&gt;&lt;h2&gt;知识点&lt;/h2&gt;&lt;p&gt;&lt;span&gt;&lt;span&gt;•&lt;/span&gt;kubelet 的功能：连接 api-server；接受来自 api-server 的响应。两种情况都需要 TLS&lt;/span&gt;&lt;/p&gt;&lt;h3&gt;解题思路&lt;/h3&gt;&lt;p&gt;kubelet 连接 apiserver 的方式在配置文件中，先找出配置文件的保存位置。&lt;/p&gt;&lt;section class=&quot;code-snippet__github&quot;&gt;&lt;pre data-lang=&quot;shell&quot;&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;# ssh 到节点上，查看 kubelet 的启动命令&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;$ ps &lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;ef &lt;/span&gt;&lt;span&gt;|&lt;/span&gt;&lt;span&gt; grep kubelet&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;root        &lt;/span&gt;&lt;span&gt;3935&lt;/span&gt;&lt;span&gt;       &lt;/span&gt;&lt;span&gt;1&lt;/span&gt;&lt;span&gt;  &lt;/span&gt;&lt;span&gt;1&lt;/span&gt;&lt;span&gt; &lt;/span&gt;&lt;span&gt;12&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;span&gt;54&lt;/span&gt;&lt;span&gt; &lt;/span&gt;&lt;span&gt;?&lt;/span&gt;&lt;span&gt;        &lt;/span&gt;&lt;span&gt;00&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;span&gt;00&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;span&gt;23&lt;/span&gt;&lt;span&gt; &lt;/span&gt;&lt;span&gt;/&lt;/span&gt;&lt;span&gt;var&lt;/span&gt;&lt;span&gt;/&lt;/span&gt;&lt;span&gt;lib&lt;/span&gt;&lt;span&gt;/&lt;/span&gt;&lt;span&gt;minikube&lt;/span&gt;&lt;span&gt;/&lt;/span&gt;&lt;span&gt;binaries&lt;/span&gt;&lt;span&gt;/&lt;/span&gt;&lt;span&gt;v1&lt;/span&gt;&lt;span&gt;.&lt;/span&gt;&lt;span&gt;20.0&lt;/span&gt;&lt;span&gt;/&lt;/span&gt;&lt;span&gt;kubelet &lt;/span&gt;&lt;span&gt;--&lt;/span&gt;&lt;span&gt;bootstrap&lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;kubeconfig&lt;/span&gt;&lt;span&gt;=&lt;/span&gt;&lt;span&gt;/etc/&lt;/span&gt;&lt;span&gt;kubernetes&lt;/span&gt;&lt;span&gt;/&lt;/span&gt;&lt;span&gt;bootstrap&lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;kubelet&lt;/span&gt;&lt;span&gt;.&lt;/span&gt;&lt;span&gt;conf &lt;/span&gt;&lt;span&gt;--&lt;/span&gt;&lt;span&gt;cni&lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;conf&lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;dir&lt;/span&gt;&lt;span&gt;=&lt;/span&gt;&lt;span&gt;/etc/&lt;/span&gt;&lt;span&gt;cni&lt;/span&gt;&lt;span&gt;/&lt;/span&gt;&lt;span&gt;net&lt;/span&gt;&lt;span&gt;.&lt;/span&gt;&lt;span&gt;mk &lt;/span&gt;&lt;span&gt;--&lt;/span&gt;&lt;span&gt;config&lt;/span&gt;&lt;span&gt;=&lt;/span&gt;&lt;span&gt;/var/&lt;/span&gt;&lt;span&gt;lib&lt;/span&gt;&lt;span&gt;/&lt;/span&gt;&lt;span&gt;kubelet&lt;/span&gt;&lt;span&gt;/&lt;/span&gt;&lt;span&gt;config&lt;/span&gt;&lt;span&gt;.&lt;/span&gt;&lt;span&gt;yaml &lt;/span&gt;&lt;span&gt;--&lt;/span&gt;&lt;span&gt;container&lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;runtime&lt;/span&gt;&lt;span&gt;=&lt;/span&gt;&lt;span&gt;docker &lt;/span&gt;&lt;span&gt;--&lt;/span&gt;&lt;span&gt;hostname&lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;override&lt;/span&gt;&lt;span&gt;=&lt;/span&gt;&lt;span&gt;cka&lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;m02 &lt;/span&gt;&lt;span&gt;--&lt;/span&gt;&lt;span&gt;kubeconfig&lt;/span&gt;&lt;span&gt;=&lt;/span&gt;&lt;span&gt;/etc/&lt;/span&gt;&lt;span&gt;kubernetes&lt;/span&gt;&lt;span&gt;/&lt;/span&gt;&lt;span&gt;kubelet&lt;/span&gt;&lt;span&gt;.&lt;/span&gt;&lt;span&gt;conf &lt;/span&gt;&lt;span&gt;--&lt;/span&gt;&lt;span&gt;network&lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;plugin&lt;/span&gt;&lt;span&gt;=&lt;/span&gt;&lt;span&gt;cni &lt;/span&gt;&lt;span&gt;--&lt;/span&gt;&lt;span&gt;node&lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;ip&lt;/span&gt;&lt;span&gt;=&lt;/span&gt;&lt;span&gt;192.168&lt;/span&gt;&lt;span&gt;.&lt;/span&gt;&lt;span&gt;64.9&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;docker     &lt;/span&gt;&lt;span&gt;13653&lt;/span&gt;&lt;span&gt;   &lt;/span&gt;&lt;span&gt;13616&lt;/span&gt;&lt;span&gt;  &lt;/span&gt;&lt;span&gt;0&lt;/span&gt;&lt;span&gt; &lt;/span&gt;&lt;span&gt;13&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;span&gt;22&lt;/span&gt;&lt;span&gt; pts&lt;/span&gt;&lt;span&gt;/&lt;/span&gt;&lt;span&gt;0&lt;/span&gt;&lt;span&gt;    &lt;/span&gt;&lt;span&gt;00&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;span&gt;00&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;span&gt;00&lt;/span&gt;&lt;span&gt; grep kubelet&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/section&gt;&lt;section class=&quot;code-snippet__github&quot;&gt;&lt;pre data-lang=&quot;shell&quot;&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;#kubelet 连接 api server 的信息， client cert 的配置所在 /var/lib/kubelet/pki/kubelet-client-current.pem&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;cat &lt;/span&gt;&lt;span&gt;/&lt;/span&gt;&lt;span&gt;var&lt;/span&gt;&lt;span&gt;/&lt;/span&gt;&lt;span&gt;lib&lt;/span&gt;&lt;span&gt;/&lt;/span&gt;&lt;span&gt;kubelet&lt;/span&gt;&lt;span&gt;/&lt;/span&gt;&lt;span&gt;config&lt;/span&gt;&lt;span&gt;.&lt;/span&gt;&lt;span&gt;yaml &lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;#kubelet 的启动信息， servert cert 的配置所在 /var/lib/minikube/certs/ca.crt&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;cat &lt;/span&gt;&lt;span&gt;/&lt;/span&gt;&lt;span&gt;etc&lt;/span&gt;&lt;span&gt;/&lt;/span&gt;&lt;span&gt;kubernetes&lt;/span&gt;&lt;span&gt;/&lt;/span&gt;&lt;span&gt;kubelet&lt;/span&gt;&lt;span&gt;.&lt;/span&gt;&lt;span&gt;conf &lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/section&gt;&lt;section class=&quot;code-snippet__github&quot;&gt;&lt;pre data-lang=&quot;shell&quot;&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;$ openssl x509 &lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;noout &lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;text &lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;in&lt;/span&gt;&lt;span&gt; &lt;/span&gt;&lt;span&gt;/&lt;/span&gt;&lt;span&gt;var&lt;/span&gt;&lt;span&gt;/&lt;/span&gt;&lt;span&gt;lib&lt;/span&gt;&lt;span&gt;/&lt;/span&gt;&lt;span&gt;kubelet&lt;/span&gt;&lt;span&gt;/&lt;/span&gt;&lt;span&gt;pki&lt;/span&gt;&lt;span&gt;/&lt;/span&gt;&lt;span&gt;kubelet&lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;client&lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;current&lt;/span&gt;&lt;span&gt;.&lt;/span&gt;&lt;span&gt;pem &lt;/span&gt;&lt;span&gt;|&lt;/span&gt;&lt;span&gt; grep &lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;i issuer&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;        &lt;/span&gt;&lt;span&gt;Issuer&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;span&gt; CN &lt;/span&gt;&lt;span&gt;=&lt;/span&gt;&lt;span&gt; minikubeCA&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;$ openssl x509 &lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;noout &lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;text &lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;in&lt;/span&gt;&lt;span&gt; &lt;/span&gt;&lt;span&gt;/&lt;/span&gt;&lt;span&gt;var&lt;/span&gt;&lt;span&gt;/&lt;/span&gt;&lt;span&gt;lib&lt;/span&gt;&lt;span&gt;/&lt;/span&gt;&lt;span&gt;kubelet&lt;/span&gt;&lt;span&gt;/&lt;/span&gt;&lt;span&gt;pki&lt;/span&gt;&lt;span&gt;/&lt;/span&gt;&lt;span&gt;kubelet&lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;client&lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;current&lt;/span&gt;&lt;span&gt;.&lt;/span&gt;&lt;span&gt;pem &lt;/span&gt;&lt;span&gt;|&lt;/span&gt;&lt;span&gt; grep &lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;i &lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;A1 extended&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;            X509v3 &lt;/span&gt;&lt;span&gt;Extended&lt;/span&gt;&lt;span&gt; &lt;/span&gt;&lt;span&gt;Key&lt;/span&gt;&lt;span&gt; &lt;/span&gt;&lt;span&gt;Usage&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;                TLS &lt;/span&gt;&lt;span&gt;Web&lt;/span&gt;&lt;span&gt; &lt;/span&gt;&lt;span&gt;Client&lt;/span&gt;&lt;span&gt; &lt;/span&gt;&lt;span&gt;Authentication&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code/&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;$ openssl x509 &lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;noout &lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;text &lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;in&lt;/span&gt;&lt;span&gt; &lt;/span&gt;&lt;span&gt;/&lt;/span&gt;&lt;span&gt;var&lt;/span&gt;&lt;span&gt;/&lt;/span&gt;&lt;span&gt;lib&lt;/span&gt;&lt;span&gt;/&lt;/span&gt;&lt;span&gt;minikube&lt;/span&gt;&lt;span&gt;/&lt;/span&gt;&lt;span&gt;certs&lt;/span&gt;&lt;span&gt;/&lt;/span&gt;&lt;span&gt;ca&lt;/span&gt;&lt;span&gt;.&lt;/span&gt;&lt;span&gt;crt &lt;/span&gt;&lt;span&gt;|&lt;/span&gt;&lt;span&gt; grep &lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;i issuer&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;        &lt;/span&gt;&lt;span&gt;Issuer&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;span&gt; CN &lt;/span&gt;&lt;span&gt;=&lt;/span&gt;&lt;span&gt; minikubeCA&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;$ openssl x509 &lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;noout &lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;text &lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;in&lt;/span&gt;&lt;span&gt; &lt;/span&gt;&lt;span&gt;/&lt;/span&gt;&lt;span&gt;var&lt;/span&gt;&lt;span&gt;/&lt;/span&gt;&lt;span&gt;lib&lt;/span&gt;&lt;span&gt;/&lt;/span&gt;&lt;span&gt;minikube&lt;/span&gt;&lt;span&gt;/&lt;/span&gt;&lt;span&gt;certs&lt;/span&gt;&lt;span&gt;/&lt;/span&gt;&lt;span&gt;ca&lt;/span&gt;&lt;span&gt;.&lt;/span&gt;&lt;span&gt;crt &lt;/span&gt;&lt;span&gt;|&lt;/span&gt;&lt;span&gt; grep &lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;i &lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;A1 extended&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;            X509v3 &lt;/span&gt;&lt;span&gt;Extended&lt;/span&gt;&lt;span&gt; &lt;/span&gt;&lt;span&gt;Key&lt;/span&gt;&lt;span&gt; &lt;/span&gt;&lt;span&gt;Usage&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;                TLS &lt;/span&gt;&lt;span&gt;Web&lt;/span&gt;&lt;span&gt; &lt;/span&gt;&lt;span&gt;Client&lt;/span&gt;&lt;span&gt; &lt;/span&gt;&lt;span&gt;Authentication&lt;/span&gt;&lt;span&gt;,&lt;/span&gt;&lt;span&gt; TLS &lt;/span&gt;&lt;span&gt;Web&lt;/span&gt;&lt;span&gt; &lt;/span&gt;&lt;span&gt;Server&lt;/span&gt;&lt;span&gt; &lt;/span&gt;&lt;span&gt;Authentication&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/section&gt;&lt;p&gt;最后记得将信息写入到 &lt;code&gt;/opt/course/23/certificate-info.txt&lt;/code&gt;&lt;/p&gt;&lt;h2&gt;集群：证书&lt;/h2&gt;&lt;blockquote&gt;&lt;p&gt;检查 kube-apiserver 服务器证书在 &lt;code&gt;cluster2-master1&lt;/code&gt; 上的有效期。使用 openssl 或 cfssl 执行此操作。将到期日期写入 &lt;code&gt;/opt/course/22/expiration&lt;/code&gt;。&lt;/p&gt;&lt;/blockquote&gt;&lt;blockquote&gt;&lt;p&gt;同时运行正确的 kubeadm 命令以列出到期日期并确认两种方法显示相同的日期。&lt;/p&gt;&lt;/blockquote&gt;&lt;blockquote&gt;&lt;p&gt;将更新 apiserver 服务器证书的正确 kubeadm 命令写入 &lt;code&gt;/opt/course/22/kubeadm-renew-certs.sh&lt;/code&gt;。&lt;/p&gt;&lt;/blockquote&gt;&lt;h3&gt;知识点&lt;/h3&gt;&lt;p&gt;&lt;span&gt;&lt;span&gt;•&lt;/span&gt;api-server&lt;/span&gt;&lt;span&gt;&lt;span&gt;•&lt;/span&gt;openssl&lt;/span&gt;&lt;span&gt;&lt;span&gt;•&lt;/span&gt;kubeadm&lt;/span&gt;&lt;/p&gt;&lt;p&gt;参考文档：https://kubernetes.io/docs/tasks/administer-cluster/kubeadm/kubeadm-certs/#check-certificate-expiration&lt;/p&gt;&lt;h3&gt;解题思路&lt;/h3&gt;&lt;p&gt;通过 kube-apiserver pod 的启动命令，或者 ssh 到 master 来查看命令参数，&lt;code&gt;tls-cert-file=/var/lib/minikube/certs/apiserver.crt&lt;/code&gt;&lt;/p&gt;&lt;section class=&quot;code-snippet__github&quot;&gt;&lt;pre data-lang=&quot;shell&quot;&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;$ openssl x509 &lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;noout &lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;text &lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;in&lt;/span&gt;&lt;span&gt; &lt;/span&gt;&lt;span&gt;/&lt;/span&gt;&lt;span&gt;var&lt;/span&gt;&lt;span&gt;/&lt;/span&gt;&lt;span&gt;lib&lt;/span&gt;&lt;span&gt;/&lt;/span&gt;&lt;span&gt;minikube&lt;/span&gt;&lt;span&gt;/&lt;/span&gt;&lt;span&gt;certs&lt;/span&gt;&lt;span&gt;/&lt;/span&gt;&lt;span&gt;apiserver&lt;/span&gt;&lt;span&gt;.&lt;/span&gt;&lt;span&gt;crt &lt;/span&gt;&lt;span&gt;|&lt;/span&gt;&lt;span&gt; grep &lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;i valid &lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;A2&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;        &lt;/span&gt;&lt;span&gt;Validity&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;            &lt;/span&gt;&lt;span&gt;Not&lt;/span&gt;&lt;span&gt; &lt;/span&gt;&lt;span&gt;Before&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;span&gt; &lt;/span&gt;&lt;span&gt;May&lt;/span&gt;&lt;span&gt; &lt;/span&gt;&lt;span&gt;13&lt;/span&gt;&lt;span&gt; &lt;/span&gt;&lt;span&gt;22&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;span&gt;33&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;span&gt;43&lt;/span&gt;&lt;span&gt; &lt;/span&gt;&lt;span&gt;2021&lt;/span&gt;&lt;span&gt; GMT&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;            &lt;/span&gt;&lt;span&gt;Not&lt;/span&gt;&lt;span&gt; &lt;/span&gt;&lt;span&gt;After&lt;/span&gt;&lt;span&gt; &lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;span&gt; &lt;/span&gt;&lt;span&gt;May&lt;/span&gt;&lt;span&gt; &lt;/span&gt;&lt;span&gt;14&lt;/span&gt;&lt;span&gt; &lt;/span&gt;&lt;span&gt;22&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;span&gt;33&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;span&gt;43&lt;/span&gt;&lt;span&gt; &lt;/span&gt;&lt;span&gt;2022&lt;/span&gt;&lt;span&gt; GMT&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/section&gt;&lt;p&gt;将 &lt;code&gt;May 14 22:33:43 2022 GMT&lt;/code&gt; 写入 &lt;code&gt;/opt/course/22/expiration&lt;/code&gt;&lt;/p&gt;&lt;p&gt;通过 kubeadm 来检查&lt;/p&gt;&lt;section class=&quot;code-snippet__github&quot;&gt;&lt;pre data-lang=&quot;&quot;&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;$ kubeadm certs check&lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;expiration &lt;/span&gt;&lt;span&gt;|&lt;/span&gt;&lt;span&gt; grep &lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;i apiserver&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;#macos 无法安装 kubeadm&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;#minikube 无法使用 kubeadm 检查&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/section&gt;&lt;p&gt;将 &lt;code&gt;kubeadm certs renew apiserver&lt;/code&gt; 写入 /opt/course/22/kubeadm-renew-certs.sh&lt;/p&gt;&lt;h2&gt;集群：升级节点&lt;/h2&gt;&lt;blockquote&gt;&lt;p&gt;你的同事说节点 &lt;code&gt;cluster3-worker2&lt;/code&gt; 运行的是较旧的 Kubernetes 版本，甚至不属于集群的一部分。将 kubectl 和 kubeadm 更新为在 &lt;code&gt;cluster3-master1&lt;/code&gt; 上运行的确切版本。然后将此节点添加到集群中，您可以为此使用kubeadm。&lt;/p&gt;&lt;/blockquote&gt;&lt;h3&gt;知识点&lt;/h3&gt;&lt;p&gt;&lt;span&gt;&lt;span&gt;•&lt;/span&gt;kubeadm 升级集群&lt;/span&gt;&lt;/p&gt;&lt;p&gt;参考文档：&lt;/p&gt;&lt;h3&gt;解题思路&lt;/h3&gt;&lt;p&gt;检查node&lt;/p&gt;&lt;section class=&quot;code-snippet__github&quot;&gt;&lt;pre data-lang=&quot;shell&quot;&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;$ kubectl &lt;/span&gt;&lt;span&gt;get&lt;/span&gt;&lt;span&gt; nodes&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/section&gt;&lt;p&gt;检查当前组件版本&lt;/p&gt;&lt;section class=&quot;code-snippet__github&quot;&gt;&lt;pre data-lang=&quot;shell&quot;&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;$ ssh cluster3&lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;worker2&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code/&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;$ kubeadm version&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;$ kubectl version &lt;/span&gt;&lt;span&gt;--&lt;/span&gt;&lt;span&gt;short&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;Client&lt;/span&gt;&lt;span&gt; &lt;/span&gt;&lt;span&gt;Version&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;span&gt; vx&lt;/span&gt;&lt;span&gt;.&lt;/span&gt;&lt;span&gt;xx&lt;/span&gt;&lt;span&gt;.&lt;/span&gt;&lt;span&gt;x&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;Server&lt;/span&gt;&lt;span&gt; &lt;/span&gt;&lt;span&gt;Version&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;span&gt; vx&lt;/span&gt;&lt;span&gt;.&lt;/span&gt;&lt;span&gt;xx&lt;/span&gt;&lt;span&gt;.&lt;/span&gt;&lt;span&gt;x&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code/&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;$ kubelet &lt;/span&gt;&lt;span&gt;--&lt;/span&gt;&lt;span&gt;version&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/section&gt;&lt;section class=&quot;code-snippet__github&quot;&gt;&lt;pre data-lang=&quot;&quot;&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;#使用命令并升级各个组件，并重启 kubelet&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;#如果启动失败，一般是需要token连接到api-server，需要ssh到master上运行 kubeadm create token --print-join-command&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;#再ssh到 node上，执行打印的命令，重启kubelet并检查装填&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;#最后检查node是否成功加入集群&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/section&gt;&lt;h2&gt;Docker 命令&lt;/h2&gt;&lt;blockquote&gt;&lt;p&gt;在命名空间 &lt;code&gt;project-tiger&lt;/code&gt; 中创建一个名为 &lt;code&gt;Tigers-reunite&lt;/code&gt; 的 Pod 镜像 &lt;code&gt;httpd:2.4.41-alpine&lt;/code&gt;，标签为 &lt;code&gt;pod=container&lt;/code&gt; 和 &lt;code&gt;container=pod&lt;/code&gt;。找出 Pod 被安排在哪个节点上。ssh 进入该节点并找到属于该 Pod 的 docker 容器。&lt;/p&gt;&lt;/blockquote&gt;&lt;blockquote&gt;&lt;p&gt;将容器的 docker ID 和这些正在运行的进程/命令写入 &lt;code&gt;/opt/course/17/pod-container.txt&lt;/code&gt;。&lt;/p&gt;&lt;/blockquote&gt;&lt;blockquote&gt;&lt;p&gt;最后，使用 docker 命令将主 Docker 容器（来自 yaml 中指定的那个）的日志写入 &lt;code&gt;/opt/course/17/pod-container.log&lt;/code&gt;。&lt;/p&gt;&lt;/blockquote&gt;&lt;h3&gt;知识点&lt;/h3&gt;&lt;p&gt;&lt;span&gt;&lt;span&gt;•&lt;/span&gt;docker 命令：ps、logs、inspect&lt;/span&gt;&lt;/p&gt;&lt;h3&gt;解题思路&lt;/h3&gt;&lt;p&gt;创建 pod&lt;/p&gt;&lt;section class=&quot;code-snippet__github&quot;&gt;&lt;pre data-lang=&quot;shell&quot;&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;$ kubectl run tigers&lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;reunite &lt;/span&gt;&lt;span&gt;--&lt;/span&gt;&lt;span&gt;image httpd&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;span&gt;2.4&lt;/span&gt;&lt;span&gt;.&lt;/span&gt;&lt;span&gt;41&lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;alpine &lt;/span&gt;&lt;span&gt;--&lt;/span&gt;&lt;span&gt;labels pod&lt;/span&gt;&lt;span&gt;=&lt;/span&gt;&lt;span&gt;container&lt;/span&gt;&lt;span&gt;,&lt;/span&gt;&lt;span&gt;container&lt;/span&gt;&lt;span&gt;=&lt;/span&gt;&lt;span&gt;pod&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/section&gt;&lt;p&gt;检查 pod 的信息&lt;/p&gt;&lt;section class=&quot;code-snippet__github&quot;&gt;&lt;pre data-lang=&quot;shell&quot;&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;$ kubectl &lt;/span&gt;&lt;span&gt;get&lt;/span&gt;&lt;span&gt; pods &lt;/span&gt;&lt;span&gt;--&lt;/span&gt;&lt;span&gt;show&lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;labels&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;NAME             READY   STATUS    RESTARTS   AGE   LABELS&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;tigers&lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;reunite   &lt;/span&gt;&lt;span&gt;1&lt;/span&gt;&lt;span&gt;/&lt;/span&gt;&lt;span&gt;1&lt;/span&gt;&lt;span&gt;     &lt;/span&gt;&lt;span&gt;Running&lt;/span&gt;&lt;span&gt;   &lt;/span&gt;&lt;span&gt;0&lt;/span&gt;&lt;span&gt;          &lt;/span&gt;&lt;span&gt;34s&lt;/span&gt;&lt;span&gt;   container&lt;/span&gt;&lt;span&gt;=&lt;/span&gt;&lt;span&gt;pod&lt;/span&gt;&lt;span&gt;,&lt;/span&gt;&lt;span&gt;pod&lt;/span&gt;&lt;span&gt;=&lt;/span&gt;&lt;span&gt;container&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/section&gt;&lt;p&gt;获取pod所在的节点&lt;/p&gt;&lt;section class=&quot;code-snippet__github&quot;&gt;&lt;pre data-lang=&quot;shell&quot;&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;$ kubectl &lt;/span&gt;&lt;span&gt;get&lt;/span&gt;&lt;span&gt; pod tigers&lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;reunite &lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;o jsonpath&lt;/span&gt;&lt;span&gt;=&lt;/span&gt;&lt;span&gt;&#x27;{.spec.nodeName}&#x27;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;cka&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/section&gt;&lt;p&gt;ssh到节点上&lt;/p&gt;&lt;section class=&quot;code-snippet__github&quot;&gt;&lt;pre data-lang=&quot;shell&quot;&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;docker ps &lt;/span&gt;&lt;span&gt;|&lt;/span&gt;&lt;span&gt; grep tigers&lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;reunite&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;e6ff69b437bc   &lt;/span&gt;&lt;span&gt;54b0995a6305&lt;/span&gt;&lt;span&gt;           &lt;/span&gt;&lt;span&gt;&quot;httpd-foreground&quot;&lt;/span&gt;&lt;span&gt;       &lt;/span&gt;&lt;span&gt;About&lt;/span&gt;&lt;span&gt; a minute ago   &lt;/span&gt;&lt;span&gt;Up&lt;/span&gt;&lt;span&gt; &lt;/span&gt;&lt;span&gt;About&lt;/span&gt;&lt;span&gt; a minute             k8s_tigers&lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;reunite_tigers&lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;reunite_dev_53391212&lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;911d&lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;4275&lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;a19d&lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;e8f8b0f85a98_0&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;06d3ca65eb08&lt;/span&gt;&lt;span&gt;   k8s&lt;/span&gt;&lt;span&gt;.&lt;/span&gt;&lt;span&gt;gcr&lt;/span&gt;&lt;span&gt;.&lt;/span&gt;&lt;span&gt;io&lt;/span&gt;&lt;span&gt;/&lt;/span&gt;&lt;span&gt;pause&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;span&gt;3.2&lt;/span&gt;&lt;span&gt;   &lt;/span&gt;&lt;span&gt;&quot;/pause&quot;&lt;/span&gt;&lt;span&gt;                 &lt;/span&gt;&lt;span&gt;About&lt;/span&gt;&lt;span&gt; a minute ago   &lt;/span&gt;&lt;span&gt;Up&lt;/span&gt;&lt;span&gt; &lt;/span&gt;&lt;span&gt;About&lt;/span&gt;&lt;span&gt; a minute             k8s_POD_tigers&lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;reunite_dev_53391212&lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;911d&lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;4275&lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;a19d&lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;e8f8b0f85a98_0&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code/&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;#使用docker inspect 或者 进入容器直接查看进程&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;$ docker inspect e6ff69b437bc &lt;/span&gt;&lt;span&gt;|&lt;/span&gt;&lt;span&gt; grep &lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;i &lt;/span&gt;&lt;span&gt;&#x27;cmd\|entrypoint&#x27;&lt;/span&gt;&lt;span&gt; &lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;A1&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;            &lt;/span&gt;&lt;span&gt;&quot;Cmd&quot;&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;span&gt; &lt;/span&gt;&lt;span&gt;[&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;                &lt;/span&gt;&lt;span&gt;&quot;httpd-foreground&quot;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;--&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;            &lt;/span&gt;&lt;span&gt;&quot;Entrypoint&quot;&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;span&gt; &lt;/span&gt;&lt;span&gt;null&lt;/span&gt;&lt;span&gt;,&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;            &lt;/span&gt;&lt;span&gt;&quot;OnBuild&quot;&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;span&gt; &lt;/span&gt;&lt;span&gt;null&lt;/span&gt;&lt;span&gt;,&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code/&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;$ docker inspect &lt;/span&gt;&lt;span&gt;06d3ca65eb08&lt;/span&gt;&lt;span&gt; &lt;/span&gt;&lt;span&gt;|&lt;/span&gt;&lt;span&gt; grep &lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;i &lt;/span&gt;&lt;span&gt;&#x27;cmd\|entrypoint&#x27;&lt;/span&gt;&lt;span&gt; &lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;A1&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;            &lt;/span&gt;&lt;span&gt;&quot;Cmd&quot;&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;span&gt; &lt;/span&gt;&lt;span&gt;null&lt;/span&gt;&lt;span&gt;,&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;            &lt;/span&gt;&lt;span&gt;&quot;Image&quot;&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;span&gt; &lt;/span&gt;&lt;span&gt;&quot;k8s.gcr.io/pause:3.2&quot;&lt;/span&gt;&lt;span&gt;,&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;--&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;            &lt;/span&gt;&lt;span&gt;&quot;Entrypoint&quot;&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;span&gt; &lt;/span&gt;&lt;span&gt;[&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;                &lt;/span&gt;&lt;span&gt;&quot;/pause&quot;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/section&gt;&lt;p&gt;结果写入文件&lt;/p&gt;&lt;section class=&quot;code-snippet__github&quot;&gt;&lt;pre data-lang=&quot;log&quot;&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;e6ff69b437bc httpd&lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;foreground&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;06d3ca65eb08&lt;/span&gt;&lt;span&gt; pause&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/section&gt;&lt;p&gt;写日志到文件&lt;/p&gt;&lt;section class=&quot;code-snippet__github&quot;&gt;&lt;pre data-lang=&quot;yaml&quot;&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span&gt;docker logs e6ff69b437bc &lt;/span&gt;&lt;span&gt;&amp;gt;&lt;/span&gt;&lt;span&gt; &lt;/span&gt;&lt;span&gt;/opt/&lt;/span&gt;&lt;span&gt;course&lt;/span&gt;&lt;span&gt;/&lt;/span&gt;&lt;span&gt;17&lt;/span&gt;&lt;span&gt;/&lt;/span&gt;&lt;span&gt;pod&lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;container&lt;/span&gt;&lt;span&gt;.&lt;/span&gt;&lt;span&gt;log&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/section&gt;&lt;h4&gt;引用链接&lt;/h4&gt;&lt;p&gt;&lt;code&gt;[1]&lt;/code&gt; K8s-CKA-CAKD-Bookmarks.html: &lt;em&gt;https://gist.github.com/addozhang/3ca950ce9b38930abfe7c5fb067e74de&lt;/em&gt;&lt;/p&gt;&lt;p&gt;&lt;/p&gt;
                &lt;/div&gt;

                

                



                
                &lt;/div&gt;&lt;/div&gt;</content:encoded>
</item>
<item>
<guid>a80aa83c0b934e80d25e6283323894c0</guid>
<title>gRPC 安全认证机制：Token 认证和自定义认证</title>
<link>https://toutiao.io/k/vj4k9qm</link>
<content:encoded>&lt;div&gt;&lt;div&gt;&lt;section data-tool=&quot;mdnice编辑器&quot; data-website=&quot;https://www.mdnice.com&quot;&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;Go gRPC 系列：&lt;/span&gt;&lt;/p&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;a href=&quot;https://mp.weixin.qq.com/s?__biz=MzIzNDcwNjQxMg==&amp;amp;mid=2247484803&amp;amp;idx=1&amp;amp;sn=d17bb418c760ddab08644f503fc5d607&amp;amp;chksm=e8f30100df848816270ac5ddbdbd75f599328a96a7cc78528427d6e49292c32efdfa786ad746&amp;amp;token=88172775&amp;amp;lang=zh_CN&amp;amp;scene=21#wechat_redirect&quot; data-linktype=&quot;2&quot;&gt;&lt;strong&gt;跟我一起学 Go 系列：gRPC 安全认证机制-SSL/TLS 认证&lt;/strong&gt;&lt;/a&gt;&lt;/p&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;a href=&quot;https://mp.weixin.qq.com/s?__biz=MzIzNDcwNjQxMg==&amp;amp;mid=2247484798&amp;amp;idx=1&amp;amp;sn=40a4818a4351b45fb573698f22a7b312&amp;amp;chksm=e8f301fddf8488ebc823ae4e9fbea6c993025d613d678bf1f019fb5e8b82c84f90764d2632bb&amp;amp;token=1767131876&amp;amp;lang=zh_CN&amp;amp;scene=21#wechat_redirect&quot; data-linktype=&quot;2&quot;&gt;&lt;strong&gt;跟我一起学 Go 系列：gRPC 拦截器使用&lt;/strong&gt;&lt;/a&gt;&lt;/p&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;a href=&quot;https://mp.weixin.qq.com/s?__biz=MzIzNDcwNjQxMg==&amp;amp;mid=2247484792&amp;amp;idx=1&amp;amp;sn=1d1d83b54d6617200de7f14eb97e9518&amp;amp;chksm=e8f301fbdf8488ed66556942694961c1e15231826f8058d332901d81c6354994fba99f41ae39&amp;amp;token=1767131876&amp;amp;lang=zh_CN&amp;amp;scene=21#wechat_redirect&quot; data-linktype=&quot;2&quot;&gt;&lt;strong&gt;跟我一起学 Go 系列：gRPC 入门必备&lt;/strong&gt;&lt;/a&gt;&lt;/p&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;接上一篇继续讲 gRPC 认证，本篇内容主要是 Token 认证和自定义认证方式的使用。&lt;/span&gt;&lt;/p&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;说 Token 认证就不得不提 Session。做 Web 端开发的同学应该都了解 Session 和 Token 机制。&lt;/span&gt;&lt;/p&gt;&lt;section data-tools=&quot;135编辑器&quot; data-id=&quot;104446&quot;&gt;&lt;section&gt;&lt;section data-width=&quot;100%&quot;&gt;&lt;br/&gt;&lt;/section&gt;&lt;section&gt;&lt;section hm_fix=&quot;265:351&quot;&gt;&lt;section&gt;&lt;img data-ratio=&quot;1&quot; data-src=&quot;https://mmbiz.qpic.cn/mmbiz_png/K7IVueebAHmibbyIuZLlsTnSiaiaMOjm87ibvzGoaYlPPyYLuIriavoskaHGG3EJPFvMDc8icjia0MibiacsAmwO0Hm6Kcg/640?wx_fmt=png&quot; data-type=&quot;png&quot; data-w=&quot;23&quot; data-width=&quot;100%&quot;/&gt;&lt;/section&gt;&lt;section data-brushtype=&quot;text&quot;&gt;Token校验&lt;/section&gt;&lt;section&gt;&lt;img data-ratio=&quot;0.9565217391304348&quot; data-src=&quot;https://mmbiz.qpic.cn/mmbiz_png/K7IVueebAHmibbyIuZLlsTnSiaiaMOjm87ibzZ6JKrPOR6JGwJTA9nGchSbmqPsOmIBhLjLtWcO7llIUNyiaXvTXia7w/640?wx_fmt=png&quot; data-type=&quot;png&quot; data-w=&quot;23&quot; data-width=&quot;100%&quot;/&gt;&lt;/section&gt;&lt;/section&gt;&lt;/section&gt;&lt;/section&gt;&lt;/section&gt;&lt;h5 data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;基于 Session 的身份校验机制&lt;/span&gt;&lt;/h5&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;Session 一般由服务端存储，用户通过用户名和密码登录之后服务端会在服务器开辟一块 Session 内存空间存入用户信息，同时服务器会在 cookie 信息中写入一个 Session_id 值，用于标识这一块内存空间。下次用户再来请求的时候会由 cookie 中带过来这个 Session_id，服务端拿着这个 Session_id 去寻找对应的 Session，如果能找到说明用户已经登录过，不用重新走授权的逻辑。&lt;/span&gt;&lt;/p&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;使用 Session 存在问题在哪里：&lt;/span&gt;&lt;/p&gt;&lt;section data-role=&quot;list&quot;&gt;&lt;ol data-tool=&quot;mdnice编辑器&quot; class=&quot;list-paddingleft-2&quot;&gt;&lt;li&gt;&lt;section&gt;&lt;span&gt;&lt;strong&gt;服务端存储压力过大，当用户量大的时候，所有用户都会在内存中保存 Session 信息，可想而知需要很大的内存空间。&lt;/strong&gt;&lt;/span&gt;&lt;/section&gt;&lt;/li&gt;&lt;li&gt;&lt;section&gt;&lt;span&gt;&lt;strong&gt;分布式应用下 Session 共享问题会耗费更多的存储。&lt;/strong&gt;&lt;/span&gt;&lt;/section&gt;&lt;/li&gt;&lt;li&gt;&lt;section&gt;&lt;span&gt;&lt;strong&gt;Session 机制是基于 cookie 的，cookie 如果被截取用户很容易受到 CSFR(跨站伪造请求攻击)。&lt;/strong&gt;&lt;/span&gt;&lt;/section&gt;&lt;/li&gt;&lt;li&gt;&lt;section&gt;&lt;span&gt;&lt;strong&gt;另外使用 cookie 的另一个弊端就是不支持跨域，当然对于跨域的处理现在已经不是什么问题。&lt;/strong&gt;&lt;/span&gt;&lt;/section&gt;&lt;/li&gt;&lt;/ol&gt;&lt;/section&gt;&lt;h5 data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;基于 Token 的身份校验机制&lt;/span&gt;&lt;/h5&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;再来说说 Token 机制。token 即令牌的意思，令牌的生成规则是我们自定义的，用户第一次登录后服务端生成一个令牌返回给客户端，以后客户端在令牌过期内只需要带上这个令牌以及生成令牌必要的参数，服务端通过生成规则能生成一样的令牌即表示校验通过。&lt;/span&gt;&lt;/p&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;原理很简单但是带来的效果却是翻倍提升的：&lt;/span&gt;&lt;/p&gt;&lt;section data-role=&quot;list&quot;&gt;&lt;ol data-tool=&quot;mdnice编辑器&quot; class=&quot;list-paddingleft-2&quot;&gt;&lt;li&gt;&lt;section&gt;&lt;span&gt;&lt;strong&gt;采用生成规则校验，服务端无需存储 token 数据，没有内存压力，同样服务端做负载均衡的时候也无需像 session 那样需要考虑分布式存储问题。&lt;/strong&gt;&lt;/span&gt;&lt;/section&gt;&lt;/li&gt;&lt;li&gt;&lt;section&gt;&lt;span&gt;&lt;strong&gt;支持跨域，将 token 置于请求头中即可。&lt;/strong&gt;&lt;/span&gt;&lt;/section&gt;&lt;/li&gt;&lt;li&gt;&lt;section&gt;&lt;span&gt;&lt;strong&gt;对于移动端这种不支持 cookie 的应用场景来说 token 是更有效的验证手段。&lt;/strong&gt;&lt;/span&gt;&lt;/section&gt;&lt;/li&gt;&lt;/ol&gt;&lt;/section&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;Token 形式多种多样，其中，&lt;span&gt;&lt;strong&gt;JSON Web Token&lt;/strong&gt;&lt;/span&gt;&lt;sup&gt;&lt;strong&gt;[1]&lt;/strong&gt;&lt;/sup&gt; 是一种比较受欢迎的 Token 规范，其实就是规范 token 该怎么生成的方式。&lt;/span&gt;&lt;/p&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;JWT 中的 Token 分为 3 部分，Header、Payload 与 Signature，例如：&lt;/span&gt;&lt;/p&gt;&lt;pre data-tool=&quot;mdnice编辑器&quot;/&gt;&lt;section class=&quot;code-snippet__fix code-snippet__js&quot;&gt;&lt;pre class=&quot;code-snippet__js&quot; data-lang=&quot;css&quot;&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span class=&quot;code-snippet__selector-tag&quot;&gt;eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9&lt;/span&gt;&lt;span class=&quot;code-snippet__selector-class&quot;&gt;.eyJhdWQiOiJsb3JhLWFwcC1zZXJ2ZXIiLCJleHAiOjE2MjUzMjgyOTYsImlzcyI6ImxvcmEtYXBwLXNlcnZlciIsIm5iZiI6MTYyNTMyNDY5Niwic3ViIjoidXNlciIsInVzZXJuYW1lIjoieGlhb21pbmcifQ&lt;/span&gt;&lt;span class=&quot;code-snippet__selector-class&quot;&gt;.vAeStAhbRa15rhKsTET3_nphRaxr2yVMLd2fGXHnDwY&lt;/span&gt; &lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/section&gt;&lt;pre data-tool=&quot;mdnice编辑器&quot;&gt;&lt;br/&gt;&lt;/pre&gt;&lt;pre data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;两个.字符隔开三部分，即：&lt;/span&gt;&lt;br/&gt;&lt;/pre&gt;&lt;pre data-tool=&quot;mdnice编辑器&quot;&gt;&lt;br/&gt;&lt;/pre&gt;&lt;pre data-tool=&quot;mdnice编辑器&quot;/&gt;&lt;section class=&quot;code-snippet__fix code-snippet__js&quot;&gt;&lt;pre class=&quot;code-snippet__js&quot; data-lang=&quot;css&quot;&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span class=&quot;code-snippet__selector-tag&quot;&gt;Header&lt;/span&gt;&lt;span class=&quot;code-snippet__selector-class&quot;&gt;.Payload&lt;/span&gt;&lt;span class=&quot;code-snippet__selector-class&quot;&gt;.Signature&lt;/span&gt; &lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/section&gt;&lt;pre data-tool=&quot;mdnice编辑器&quot;&gt;&lt;br/&gt;&lt;/pre&gt;&lt;pre data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;含义上，Header表示 Token 相关的基本元信息，如 Token 类型、加密方式（算法）等，&lt;/span&gt;&lt;/pre&gt;&lt;pre data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;具体如下（alg是必填的，其余都可选）：&lt;br/&gt;&lt;/span&gt;&lt;/pre&gt;&lt;section data-role=&quot;list&quot;&gt;&lt;ul data-tool=&quot;mdnice编辑器&quot; class=&quot;list-paddingleft-2&quot;&gt;&lt;li&gt;&lt;section&gt;&lt;code&gt;&lt;strong&gt;typ&lt;/strong&gt;&lt;/code&gt;&lt;span&gt;&lt;strong&gt;：Token type&lt;/strong&gt;&lt;/span&gt;&lt;/section&gt;&lt;/li&gt;&lt;li&gt;&lt;section&gt;&lt;code&gt;&lt;strong&gt;cty&lt;/strong&gt;&lt;/code&gt;&lt;span&gt;&lt;strong&gt;：Content type&lt;/strong&gt;&lt;/span&gt;&lt;/section&gt;&lt;/li&gt;&lt;li&gt;&lt;section&gt;&lt;code&gt;&lt;strong&gt;alg&lt;/strong&gt;&lt;/code&gt;&lt;span&gt;&lt;strong&gt;：Message authentication code algorithm&lt;/strong&gt;&lt;/span&gt;&lt;/section&gt;&lt;/li&gt;&lt;/ul&gt;&lt;/section&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;&lt;em&gt;Payload&lt;/em&gt;表示 Token 携带的数据及其它 Token 元信息，规范定义的标准字段如下：&lt;/span&gt;&lt;/p&gt;&lt;section data-role=&quot;list&quot;&gt;&lt;ul data-tool=&quot;mdnice编辑器&quot; class=&quot;list-paddingleft-2&quot;&gt;&lt;li&gt;&lt;section&gt;&lt;code&gt;&lt;strong&gt;iss&lt;/strong&gt;&lt;/code&gt;&lt;span&gt;&lt;strong&gt;：Issuer，签发方&lt;/strong&gt;&lt;/span&gt;&lt;/section&gt;&lt;/li&gt;&lt;li&gt;&lt;section&gt;&lt;code&gt;&lt;strong&gt;sub&lt;/strong&gt;&lt;/code&gt;&lt;span&gt;&lt;strong&gt;：Subject，Token 信息主题（Sub identifies the party that this JWT carries information about）&lt;/strong&gt;&lt;/span&gt;&lt;/section&gt;&lt;/li&gt;&lt;li&gt;&lt;section&gt;&lt;code&gt;&lt;strong&gt;aud&lt;/strong&gt;&lt;/code&gt;&lt;span&gt;&lt;strong&gt;：Audience，接收方&lt;/strong&gt;&lt;/span&gt;&lt;/section&gt;&lt;/li&gt;&lt;li&gt;&lt;section&gt;&lt;code&gt;&lt;strong&gt;exp&lt;/strong&gt;&lt;/code&gt;&lt;span&gt;&lt;strong&gt;：Expiration Time，过期时间&lt;/strong&gt;&lt;/span&gt;&lt;/section&gt;&lt;/li&gt;&lt;li&gt;&lt;section&gt;&lt;code&gt;&lt;strong&gt;nbf&lt;/strong&gt;&lt;/code&gt;&lt;span&gt;&lt;strong&gt;：Not (valid) Before，生效时间&lt;/strong&gt;&lt;/span&gt;&lt;/section&gt;&lt;/li&gt;&lt;li&gt;&lt;section&gt;&lt;code&gt;&lt;strong&gt;iat&lt;/strong&gt;&lt;/code&gt;&lt;span&gt;&lt;strong&gt;：Issued at，生成时间&lt;/strong&gt;&lt;/span&gt;&lt;/section&gt;&lt;/li&gt;&lt;li&gt;&lt;section&gt;&lt;code&gt;&lt;strong&gt;jti&lt;/strong&gt;&lt;/code&gt;&lt;span&gt;&lt;strong&gt;：JWT ID，唯一标识&lt;/strong&gt;&lt;/span&gt;&lt;/section&gt;&lt;/li&gt;&lt;/ul&gt;&lt;/section&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;这些字段都是可选的，Payload 只要是合法 JSON 即可。生成之后的三部分又做了一次加密处理：&lt;/span&gt;&lt;/p&gt;&lt;pre data-tool=&quot;mdnice编辑器&quot;/&gt;&lt;section class=&quot;code-snippet__fix code-snippet__js&quot;&gt;&lt;pre class=&quot;code-snippet__js&quot; data-lang=&quot;css&quot;&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span class=&quot;code-snippet__selector-tag&quot;&gt;Base64&lt;/span&gt;编码的&lt;span class=&quot;code-snippet__selector-tag&quot;&gt;Header&lt;/span&gt;&lt;span class=&quot;code-snippet__selector-class&quot;&gt;.Base64&lt;/span&gt;编码的&lt;span class=&quot;code-snippet__selector-tag&quot;&gt;Payload&lt;/span&gt;.对前两部分按指定算法加密的结果 &lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/section&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;关于 JWT 规范的 Token 生成暂时就先说这么多，我们接下来就看看在 gRPC 中如何应用 Token 机制。gRPC 本身不提供 Token 认证机制，而是通过插件机制支持第三方认证，本示例使用了第三方 jwt 包：&lt;/span&gt;&lt;/p&gt;&lt;pre data-tool=&quot;mdnice编辑器&quot;/&gt;&lt;section class=&quot;code-snippet__fix code-snippet__js&quot;&gt;&lt;pre class=&quot;code-snippet__js&quot; data-lang=&quot;go&quot;&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;github.com/dgrijalva/jwt-&lt;span class=&quot;code-snippet__keyword&quot;&gt;go&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/section&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;通过该包我们就不用自己去写 jwt 规范下的这一套加密方式。&lt;/span&gt;&lt;/p&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;基于 JWT 规范的 Token 认证机制代码位于 &lt;span&gt;&lt;strong&gt;Gitbub 仓库&lt;/strong&gt;&lt;/span&gt;&lt;sup&gt;&lt;strong&gt;[2]&lt;/strong&gt;&lt;/sup&gt;，大家自行查看。&lt;/span&gt;&lt;/p&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;首先我们创建一个新的测试 API，token.proto：&lt;/span&gt;&lt;/p&gt;&lt;section class=&quot;code-snippet__fix code-snippet__js&quot;&gt;&lt;pre class=&quot;code-snippet__js&quot; data-lang=&quot;nginx&quot;&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span class=&quot;code-snippet__attribute&quot;&gt;syntax&lt;/span&gt; = &lt;span class=&quot;code-snippet__string&quot;&gt;&quot;proto3&quot;&lt;/span&gt;;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span class=&quot;code-snippet__attribute&quot;&gt;option&lt;/span&gt; go_package = &lt;span class=&quot;code-snippet__string&quot;&gt;&quot;/&quot;&lt;/span&gt;;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;br/&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span class=&quot;code-snippet__attribute&quot;&gt;package&lt;/span&gt; test.grpcTest.tokenTls;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;br/&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;br/&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span class=&quot;code-snippet__attribute&quot;&gt;service&lt;/span&gt; TokenService {&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;  &lt;span class=&quot;code-snippet__attribute&quot;&gt;rpc&lt;/span&gt; Login (LoginRequest) returns (LoginResp) {}&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;  &lt;span class=&quot;code-snippet__attribute&quot;&gt;rpc&lt;/span&gt; SayHello(PingMessage) returns (PingMessage) {}&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;br/&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span class=&quot;code-snippet__attribute&quot;&gt;message&lt;/span&gt; LoginRequest{&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;  &lt;span class=&quot;code-snippet__attribute&quot;&gt;string&lt;/span&gt; username = &lt;span class=&quot;code-snippet__number&quot;&gt;1&lt;/span&gt;;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;  &lt;span class=&quot;code-snippet__attribute&quot;&gt;string&lt;/span&gt; password = &lt;span class=&quot;code-snippet__number&quot;&gt;2&lt;/span&gt;;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span class=&quot;code-snippet__attribute&quot;&gt;message&lt;/span&gt; LoginResp{&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;  &lt;span class=&quot;code-snippet__attribute&quot;&gt;string&lt;/span&gt; status = &lt;span class=&quot;code-snippet__number&quot;&gt;1&lt;/span&gt;;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;  &lt;span class=&quot;code-snippet__attribute&quot;&gt;string&lt;/span&gt; token = &lt;span class=&quot;code-snippet__number&quot;&gt;2&lt;/span&gt;;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;br/&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;br/&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span class=&quot;code-snippet__attribute&quot;&gt;message&lt;/span&gt; PingMessage {&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;  &lt;span class=&quot;code-snippet__attribute&quot;&gt;string&lt;/span&gt; greeting = &lt;span class=&quot;code-snippet__number&quot;&gt;1&lt;/span&gt;;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/section&gt; &lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;一个方法是登录的时候获取服务端 token，一个方法模拟拿到服务端 token 之后是否能用 token 通过校验。&lt;/span&gt;&lt;/p&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;接下来我们定义 token 的生成方式以及校验方式，这里使用了 第三方 JWT 组件：&lt;/span&gt;&lt;/p&gt;&lt;section class=&quot;code-snippet__fix code-snippet__js&quot;&gt;&lt;pre class=&quot;code-snippet__js&quot; data-lang=&quot;go&quot;&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span class=&quot;code-snippet__keyword&quot;&gt;package&lt;/span&gt; __&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;br/&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span class=&quot;code-snippet__keyword&quot;&gt;import&lt;/span&gt; (&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt; &lt;span class=&quot;code-snippet__string&quot;&gt;&quot;context&quot;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt; &lt;span class=&quot;code-snippet__string&quot;&gt;&quot;fmt&quot;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt; &lt;span class=&quot;code-snippet__string&quot;&gt;&quot;time&quot;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;br/&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt; &lt;span class=&quot;code-snippet__string&quot;&gt;&quot;github.com/dgrijalva/jwt-go&quot;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt; &lt;span class=&quot;code-snippet__string&quot;&gt;&quot;google.golang.org/grpc/metadata&quot;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;)&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;br/&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span class=&quot;code-snippet__function&quot;&gt;&lt;span class=&quot;code-snippet__keyword&quot;&gt;func&lt;/span&gt; &lt;span class=&quot;code-snippet__title&quot;&gt;CreateToken&lt;/span&gt;&lt;span class=&quot;code-snippet__params&quot;&gt;(userName &lt;span class=&quot;code-snippet__keyword&quot;&gt;string&lt;/span&gt;)&lt;/span&gt; &lt;span class=&quot;code-snippet__params&quot;&gt;(tokenString &lt;span class=&quot;code-snippet__keyword&quot;&gt;string&lt;/span&gt;)&lt;/span&gt;&lt;/span&gt; {&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt; token := jwt.NewWithClaims(jwt.SigningMethodHS256, jwt.MapClaims{&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;  &lt;span class=&quot;code-snippet__string&quot;&gt;&quot;iss&quot;&lt;/span&gt;:      &lt;span class=&quot;code-snippet__string&quot;&gt;&quot;lora-app-server&quot;&lt;/span&gt;,&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;  &lt;span class=&quot;code-snippet__string&quot;&gt;&quot;aud&quot;&lt;/span&gt;:      &lt;span class=&quot;code-snippet__string&quot;&gt;&quot;lora-app-server&quot;&lt;/span&gt;,&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;  &lt;span class=&quot;code-snippet__string&quot;&gt;&quot;nbf&quot;&lt;/span&gt;:      time.Now().Unix(),&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;  &lt;span class=&quot;code-snippet__string&quot;&gt;&quot;exp&quot;&lt;/span&gt;:      time.Now().Add(time.Hour).Unix(),&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;  &lt;span class=&quot;code-snippet__string&quot;&gt;&quot;sub&quot;&lt;/span&gt;:      &lt;span class=&quot;code-snippet__string&quot;&gt;&quot;user&quot;&lt;/span&gt;,&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;  &lt;span class=&quot;code-snippet__string&quot;&gt;&quot;username&quot;&lt;/span&gt;: userName,&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt; })&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt; tokenString, err := token.SignedString([]&lt;span class=&quot;code-snippet__keyword&quot;&gt;byte&lt;/span&gt;(&lt;span class=&quot;code-snippet__string&quot;&gt;&quot;verysecret&quot;&lt;/span&gt;))&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt; &lt;span class=&quot;code-snippet__keyword&quot;&gt;if&lt;/span&gt; err != &lt;span class=&quot;code-snippet__literal&quot;&gt;nil&lt;/span&gt; {&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;  &lt;span class=&quot;code-snippet__built_in&quot;&gt;panic&lt;/span&gt;(err)&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt; }&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt; &lt;span class=&quot;code-snippet__keyword&quot;&gt;return&lt;/span&gt; tokenString&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;br/&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;/&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span class=&quot;code-snippet__keyword&quot;&gt;type&lt;/span&gt; AuthToken &lt;span class=&quot;code-snippet__keyword&quot;&gt;struct&lt;/span&gt; {&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt; Token &lt;span class=&quot;code-snippet__keyword&quot;&gt;string&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;br/&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span class=&quot;code-snippet__function&quot;&gt;&lt;span class=&quot;code-snippet__keyword&quot;&gt;func&lt;/span&gt; &lt;span class=&quot;code-snippet__params&quot;&gt;(c AuthToken)&lt;/span&gt; &lt;span class=&quot;code-snippet__title&quot;&gt;GetRequestMetadata&lt;/span&gt;&lt;span class=&quot;code-snippet__params&quot;&gt;(ctx context.Context, uri ...&lt;span class=&quot;code-snippet__keyword&quot;&gt;string&lt;/span&gt;)&lt;/span&gt; &lt;span class=&quot;code-snippet__params&quot;&gt;(&lt;span class=&quot;code-snippet__keyword&quot;&gt;map&lt;/span&gt;[&lt;span class=&quot;code-snippet__keyword&quot;&gt;string&lt;/span&gt;]&lt;span class=&quot;code-snippet__keyword&quot;&gt;string&lt;/span&gt;, error)&lt;/span&gt;&lt;/span&gt; {&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt; &lt;span class=&quot;code-snippet__keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-snippet__keyword&quot;&gt;map&lt;/span&gt;[&lt;span class=&quot;code-snippet__keyword&quot;&gt;string&lt;/span&gt;]&lt;span class=&quot;code-snippet__keyword&quot;&gt;string&lt;/span&gt;{&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;  &lt;span class=&quot;code-snippet__string&quot;&gt;&quot;authorization&quot;&lt;/span&gt;: c.Token,&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt; }, &lt;span class=&quot;code-snippet__literal&quot;&gt;nil&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;br/&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span class=&quot;code-snippet__function&quot;&gt;&lt;span class=&quot;code-snippet__keyword&quot;&gt;func&lt;/span&gt; &lt;span class=&quot;code-snippet__params&quot;&gt;(c AuthToken)&lt;/span&gt; &lt;span class=&quot;code-snippet__title&quot;&gt;RequireTransportSecurity&lt;/span&gt;&lt;span class=&quot;code-snippet__params&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;code-snippet__title&quot;&gt;bool&lt;/span&gt;&lt;/span&gt; {&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt; &lt;span class=&quot;code-snippet__keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-snippet__literal&quot;&gt;false&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;br/&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;/&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span class=&quot;code-snippet__keyword&quot;&gt;type&lt;/span&gt; Claims &lt;span class=&quot;code-snippet__keyword&quot;&gt;struct&lt;/span&gt; {&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt; jwt.StandardClaims&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;br/&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt; &lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt; Username &lt;span class=&quot;code-snippet__keyword&quot;&gt;string&lt;/span&gt; &lt;span class=&quot;code-snippet__string&quot;&gt;`json:&quot;username&quot;`&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;br/&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;/&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;br/&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span class=&quot;code-snippet__function&quot;&gt;&lt;span class=&quot;code-snippet__keyword&quot;&gt;func&lt;/span&gt; &lt;span class=&quot;code-snippet__title&quot;&gt;getTokenFromContext&lt;/span&gt;&lt;span class=&quot;code-snippet__params&quot;&gt;(ctx context.Context)&lt;/span&gt; &lt;span class=&quot;code-snippet__params&quot;&gt;(&lt;span class=&quot;code-snippet__keyword&quot;&gt;string&lt;/span&gt;, error)&lt;/span&gt;&lt;/span&gt; {&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt; md, ok := metadata.FromIncomingContext(ctx)&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt; &lt;span class=&quot;code-snippet__keyword&quot;&gt;if&lt;/span&gt; !ok {&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;  &lt;span class=&quot;code-snippet__keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-snippet__string&quot;&gt;&quot;&quot;&lt;/span&gt;, fmt.Errorf(&lt;span class=&quot;code-snippet__string&quot;&gt;&quot;ErrNoMetadataInContext&quot;&lt;/span&gt;)&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt; }&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt; &lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt; token, ok := md[&lt;span class=&quot;code-snippet__string&quot;&gt;&quot;authorization&quot;&lt;/span&gt;]&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt; &lt;span class=&quot;code-snippet__keyword&quot;&gt;if&lt;/span&gt; !ok || &lt;span class=&quot;code-snippet__built_in&quot;&gt;len&lt;/span&gt;(token) == &lt;span class=&quot;code-snippet__number&quot;&gt;0&lt;/span&gt; {&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;  &lt;span class=&quot;code-snippet__keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-snippet__string&quot;&gt;&quot;&quot;&lt;/span&gt;, fmt.Errorf(&lt;span class=&quot;code-snippet__string&quot;&gt;&quot;ErrNoAuthorizationInMetadata&quot;&lt;/span&gt;)&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt; }&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt; &lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt; &lt;span class=&quot;code-snippet__keyword&quot;&gt;return&lt;/span&gt; token[&lt;span class=&quot;code-snippet__number&quot;&gt;0&lt;/span&gt;], &lt;span class=&quot;code-snippet__literal&quot;&gt;nil&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;br/&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span class=&quot;code-snippet__function&quot;&gt;&lt;span class=&quot;code-snippet__keyword&quot;&gt;func&lt;/span&gt; &lt;span class=&quot;code-snippet__title&quot;&gt;CheckAuth&lt;/span&gt;&lt;span class=&quot;code-snippet__params&quot;&gt;(ctx context.Context)&lt;/span&gt; &lt;span class=&quot;code-snippet__params&quot;&gt;(username &lt;span class=&quot;code-snippet__keyword&quot;&gt;string&lt;/span&gt;)&lt;/span&gt;&lt;/span&gt; {&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt; tokenStr, err := getTokenFromContext(ctx)&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt; &lt;span class=&quot;code-snippet__keyword&quot;&gt;if&lt;/span&gt; err != &lt;span class=&quot;code-snippet__literal&quot;&gt;nil&lt;/span&gt; {&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;  &lt;span class=&quot;code-snippet__built_in&quot;&gt;panic&lt;/span&gt;(&lt;span class=&quot;code-snippet__string&quot;&gt;&quot;get token from context error&quot;&lt;/span&gt;)&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt; }&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt; &lt;span class=&quot;code-snippet__keyword&quot;&gt;var&lt;/span&gt; clientClaims Claims&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt; token, err := jwt.ParseWithClaims(tokenStr, &amp;amp;clientClaims, &lt;span class=&quot;code-snippet__function&quot;&gt;&lt;span class=&quot;code-snippet__keyword&quot;&gt;func&lt;/span&gt;&lt;span class=&quot;code-snippet__params&quot;&gt;(token *jwt.Token)&lt;/span&gt; &lt;span class=&quot;code-snippet__params&quot;&gt;(&lt;span class=&quot;code-snippet__keyword&quot;&gt;interface&lt;/span&gt;{}, error)&lt;/span&gt;&lt;/span&gt; {&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;  &lt;span class=&quot;code-snippet__keyword&quot;&gt;if&lt;/span&gt; token.Header[&lt;span class=&quot;code-snippet__string&quot;&gt;&quot;alg&quot;&lt;/span&gt;] != &lt;span class=&quot;code-snippet__string&quot;&gt;&quot;HS256&quot;&lt;/span&gt; {&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;   &lt;span class=&quot;code-snippet__built_in&quot;&gt;panic&lt;/span&gt;(&lt;span class=&quot;code-snippet__string&quot;&gt;&quot;ErrInvalidAlgorithm&quot;&lt;/span&gt;)&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;  }&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;  &lt;span class=&quot;code-snippet__keyword&quot;&gt;return&lt;/span&gt; []&lt;span class=&quot;code-snippet__keyword&quot;&gt;byte&lt;/span&gt;(&lt;span class=&quot;code-snippet__string&quot;&gt;&quot;verysecret&quot;&lt;/span&gt;), &lt;span class=&quot;code-snippet__literal&quot;&gt;nil&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt; })&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt; &lt;span class=&quot;code-snippet__keyword&quot;&gt;if&lt;/span&gt; err != &lt;span class=&quot;code-snippet__literal&quot;&gt;nil&lt;/span&gt; {&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;  &lt;span class=&quot;code-snippet__built_in&quot;&gt;panic&lt;/span&gt;(&lt;span class=&quot;code-snippet__string&quot;&gt;&quot;jwt parse error&quot;&lt;/span&gt;)&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt; }&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;br/&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt; &lt;span class=&quot;code-snippet__keyword&quot;&gt;if&lt;/span&gt; !token.Valid {&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;  &lt;span class=&quot;code-snippet__built_in&quot;&gt;panic&lt;/span&gt;(&lt;span class=&quot;code-snippet__string&quot;&gt;&quot;ErrInvalidToken&quot;&lt;/span&gt;)&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt; }&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;br/&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt; &lt;span class=&quot;code-snippet__keyword&quot;&gt;return&lt;/span&gt; clientClaims.Username&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/section&gt; &lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;CreateToken 方法调用了 jwt 生成 token 的规范，包括 token 的过期时间设置。&lt;/span&gt;&lt;/p&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;另一个重要的点是 AuthToken，它实现了 PerRPCCredentials 接口。gRPC 可以为每个方法的调用进行认证，从而对不同的用户 token 进行不同的访问权限控制，首先需要实现 grpc.PerRPCCredentials 接口：&lt;/span&gt;&lt;/p&gt;&lt;section class=&quot;code-snippet__fix code-snippet__js&quot;&gt;&lt;pre class=&quot;code-snippet__js&quot; data-lang=&quot;go&quot;&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span class=&quot;code-snippet__keyword&quot;&gt;type&lt;/span&gt; PerRPCCredentials &lt;span class=&quot;code-snippet__keyword&quot;&gt;interface&lt;/span&gt; {&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;br/&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;    GetRequestMetadata(ctx context.Context, uri ...&lt;span class=&quot;code-snippet__keyword&quot;&gt;string&lt;/span&gt;) (&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;        &lt;span class=&quot;code-snippet__keyword&quot;&gt;map&lt;/span&gt;[&lt;span class=&quot;code-snippet__keyword&quot;&gt;string&lt;/span&gt;]&lt;span class=&quot;code-snippet__keyword&quot;&gt;string&lt;/span&gt;,    error,&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;    )&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;     RequireTransportSecurity() &lt;span class=&quot;code-snippet__keyword&quot;&gt;bool&lt;/span&gt; &lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/section&gt; &lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;可以认为 PerRPCCredentials 接口就是 gRPC 提供的自定义认证方式的入口。注意到我在 &lt;em&gt;GetRequestMetadata&lt;/em&gt; 方法中 set 进去一个 &lt;em&gt;authorization&lt;/em&gt; 字段，用来存储 token。&lt;/span&gt;&lt;/p&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;JWT 认证方式实现完毕，我们可以写服务端和客户端的代码：&lt;/span&gt;&lt;/p&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;服务端：&lt;/span&gt;&lt;/p&gt;&lt;section class=&quot;code-snippet__fix code-snippet__js&quot;&gt;&lt;pre class=&quot;code-snippet__js&quot; data-lang=&quot;go&quot;&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span class=&quot;code-snippet__keyword&quot;&gt;package&lt;/span&gt; __&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;br/&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span class=&quot;code-snippet__keyword&quot;&gt;import&lt;/span&gt; (&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt; &lt;span class=&quot;code-snippet__string&quot;&gt;&quot;context&quot;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt; &lt;span class=&quot;code-snippet__string&quot;&gt;&quot;fmt&quot;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt; &lt;span class=&quot;code-snippet__string&quot;&gt;&quot;google.golang.org/grpc&quot;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt; &lt;span class=&quot;code-snippet__string&quot;&gt;&quot;google.golang.org/grpc/credentials&quot;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt; &lt;span class=&quot;code-snippet__string&quot;&gt;&quot;google.golang.org/grpc/grpclog&quot;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt; &lt;span class=&quot;code-snippet__string&quot;&gt;&quot;google.golang.org/grpc/reflection&quot;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt; &lt;span class=&quot;code-snippet__string&quot;&gt;&quot;net&quot;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt; &lt;span class=&quot;code-snippet__string&quot;&gt;&quot;testing&quot;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;)&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;br/&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;/&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span class=&quot;code-snippet__function&quot;&gt;&lt;span class=&quot;code-snippet__keyword&quot;&gt;func&lt;/span&gt; &lt;span class=&quot;code-snippet__title&quot;&gt;LoggingInterceptor&lt;/span&gt;&lt;span class=&quot;code-snippet__params&quot;&gt;(ctx context.Context, req &lt;span class=&quot;code-snippet__keyword&quot;&gt;interface&lt;/span&gt;{}, info *grpc.UnaryServerInfo,&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt; handler grpc.UnaryHandler)&lt;/span&gt; &lt;span class=&quot;code-snippet__params&quot;&gt;(&lt;span class=&quot;code-snippet__keyword&quot;&gt;interface&lt;/span&gt;{}, error)&lt;/span&gt; {&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt; fmt.Printf(&lt;span class=&quot;code-snippet__string&quot;&gt;&quot;gRPC method: %s, %v&quot;&lt;/span&gt;, info.FullMethod, req)&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt; resp, err := handler(ctx, req)&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt; fmt.Printf(&lt;span class=&quot;code-snippet__string&quot;&gt;&quot;gRPC method: %s, %v&quot;&lt;/span&gt;, info.FullMethod, resp)&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt; &lt;span class=&quot;code-snippet__keyword&quot;&gt;return&lt;/span&gt; resp, err&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;br/&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span class=&quot;code-snippet__keyword&quot;&gt;type&lt;/span&gt; login &lt;span class=&quot;code-snippet__keyword&quot;&gt;struct&lt;/span&gt; {&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;br/&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span class=&quot;code-snippet__function&quot;&gt;&lt;span class=&quot;code-snippet__keyword&quot;&gt;func&lt;/span&gt; &lt;span class=&quot;code-snippet__params&quot;&gt;(login *login)&lt;/span&gt; &lt;span class=&quot;code-snippet__title&quot;&gt;Login&lt;/span&gt;&lt;span class=&quot;code-snippet__params&quot;&gt;(ctx context.Context, request *LoginRequest)&lt;/span&gt; &lt;span class=&quot;code-snippet__params&quot;&gt;(resp *LoginResp, err error)&lt;/span&gt;&lt;/span&gt; {&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt; &lt;span class=&quot;code-snippet__keyword&quot;&gt;if&lt;/span&gt; request.Username == &lt;span class=&quot;code-snippet__string&quot;&gt;&quot;xiaoming&quot;&lt;/span&gt; &amp;amp;&amp;amp; request.Password == &lt;span class=&quot;code-snippet__string&quot;&gt;&quot;123456&quot;&lt;/span&gt; {&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;  token := CreateToken(request.Username)&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;  &lt;span class=&quot;code-snippet__keyword&quot;&gt;return&lt;/span&gt; &amp;amp;LoginResp{Status: &lt;span class=&quot;code-snippet__string&quot;&gt;&quot;200&quot;&lt;/span&gt;, Token: token}, &lt;span class=&quot;code-snippet__literal&quot;&gt;nil&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt; }&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt; &lt;span class=&quot;code-snippet__keyword&quot;&gt;return&lt;/span&gt; &amp;amp;LoginResp{Status: &lt;span class=&quot;code-snippet__string&quot;&gt;&quot;401&quot;&lt;/span&gt;, Token: &lt;span class=&quot;code-snippet__string&quot;&gt;&quot;&quot;&lt;/span&gt;}, &lt;span class=&quot;code-snippet__literal&quot;&gt;nil&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;br/&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span class=&quot;code-snippet__function&quot;&gt;&lt;span class=&quot;code-snippet__keyword&quot;&gt;func&lt;/span&gt; &lt;span class=&quot;code-snippet__params&quot;&gt;(login *login)&lt;/span&gt; &lt;span class=&quot;code-snippet__title&quot;&gt;SayHello&lt;/span&gt;&lt;span class=&quot;code-snippet__params&quot;&gt;(ctx context.Context, request *PingMessage)&lt;/span&gt; &lt;span class=&quot;code-snippet__params&quot;&gt;(resp *PingMessage, err error)&lt;/span&gt;&lt;/span&gt; {&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt; auth := CheckAuth(ctx)&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt; &lt;span class=&quot;code-snippet__keyword&quot;&gt;return&lt;/span&gt; &amp;amp;PingMessage{Greeting: auth}, &lt;span class=&quot;code-snippet__literal&quot;&gt;nil&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;br/&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span class=&quot;code-snippet__function&quot;&gt;&lt;span class=&quot;code-snippet__keyword&quot;&gt;func&lt;/span&gt; &lt;span class=&quot;code-snippet__title&quot;&gt;TestGrpcServer&lt;/span&gt;&lt;span class=&quot;code-snippet__params&quot;&gt;(t *testing.T)&lt;/span&gt;&lt;/span&gt; {&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt; &lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt; lis, err := net.Listen(&lt;span class=&quot;code-snippet__string&quot;&gt;&quot;tcp&quot;&lt;/span&gt;, &lt;span class=&quot;code-snippet__string&quot;&gt;&quot;:8972&quot;&lt;/span&gt;)&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt; &lt;span class=&quot;code-snippet__keyword&quot;&gt;if&lt;/span&gt; err != &lt;span class=&quot;code-snippet__literal&quot;&gt;nil&lt;/span&gt; {&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;  fmt.Printf(&lt;span class=&quot;code-snippet__string&quot;&gt;&quot;failed to listen: %v&quot;&lt;/span&gt;, err)&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;  &lt;span class=&quot;code-snippet__keyword&quot;&gt;return&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt; }&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;br/&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt; &lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt; creds, err := credentials.NewServerTLSFromFile(&lt;span class=&quot;code-snippet__string&quot;&gt;&quot;/Users/rickiyang/server.crt&quot;&lt;/span&gt;, &lt;span class=&quot;code-snippet__string&quot;&gt;&quot;/Users/rickiyang/server.key&quot;&lt;/span&gt;)&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt; &lt;span class=&quot;code-snippet__keyword&quot;&gt;if&lt;/span&gt; err != &lt;span class=&quot;code-snippet__literal&quot;&gt;nil&lt;/span&gt; {&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;  grpclog.Fatalf(&lt;span class=&quot;code-snippet__string&quot;&gt;&quot;Failed to generate credentials %v&quot;&lt;/span&gt;, err)&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt; }&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;br/&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt; &lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt; s := grpc.NewServer(grpc.Creds(creds), grpc.UnaryInterceptor(LoggingInterceptor)) &lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt; RegisterTokenServiceServer(s, &amp;amp;login{})                                           &lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;br/&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt; reflection.Register(s) &lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt; &lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt; &lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt; err = s.Serve(lis)&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt; &lt;span class=&quot;code-snippet__keyword&quot;&gt;if&lt;/span&gt; err != &lt;span class=&quot;code-snippet__literal&quot;&gt;nil&lt;/span&gt; {&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;  fmt.Printf(&lt;span class=&quot;code-snippet__string&quot;&gt;&quot;failed to serve: %v&quot;&lt;/span&gt;, err)&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;  &lt;span class=&quot;code-snippet__keyword&quot;&gt;return&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt; }&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;br/&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/section&gt; &lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;服务端在 Login 方法中要为用户生成 token，所以调用了 &lt;em&gt;CreateToken&lt;/em&gt; 方法。同样 SayHello 方法中就要去校验客户端提供的 token 是否有效。&lt;/span&gt;&lt;/p&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;继续看客户端逻辑：&lt;/span&gt;&lt;/p&gt;&lt;section class=&quot;code-snippet__fix code-snippet__js&quot;&gt;&lt;pre class=&quot;code-snippet__js&quot; data-lang=&quot;go&quot;&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span class=&quot;code-snippet__keyword&quot;&gt;package&lt;/span&gt; __&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;br/&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span class=&quot;code-snippet__keyword&quot;&gt;import&lt;/span&gt; (&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt; &lt;span class=&quot;code-snippet__string&quot;&gt;&quot;fmt&quot;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt; &lt;span class=&quot;code-snippet__string&quot;&gt;&quot;google.golang.org/grpc/credentials&quot;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt; &lt;span class=&quot;code-snippet__string&quot;&gt;&quot;google.golang.org/grpc/grpclog&quot;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt; &lt;span class=&quot;code-snippet__string&quot;&gt;&quot;testing&quot;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;br/&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt; &lt;span class=&quot;code-snippet__string&quot;&gt;&quot;golang.org/x/net/context&quot;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt; &lt;span class=&quot;code-snippet__string&quot;&gt;&quot;google.golang.org/grpc&quot;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;)&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;br/&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;br/&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span class=&quot;code-snippet__function&quot;&gt;&lt;span class=&quot;code-snippet__keyword&quot;&gt;func&lt;/span&gt; &lt;span class=&quot;code-snippet__title&quot;&gt;TestGrpcClient&lt;/span&gt;&lt;span class=&quot;code-snippet__params&quot;&gt;(t *testing.T)&lt;/span&gt;&lt;/span&gt; {&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt; &lt;span class=&quot;code-snippet__keyword&quot;&gt;var&lt;/span&gt; err error&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt; &lt;span class=&quot;code-snippet__keyword&quot;&gt;var&lt;/span&gt; opts []grpc.DialOption&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;br/&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt; &lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt; creds, err := credentials.NewClientTLSFromFile(&lt;span class=&quot;code-snippet__string&quot;&gt;&quot;/Users/rickiyang/ca.crt&quot;&lt;/span&gt;, &lt;span class=&quot;code-snippet__string&quot;&gt;&quot;www.rickiyang.com&quot;&lt;/span&gt;)&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt; &lt;span class=&quot;code-snippet__keyword&quot;&gt;if&lt;/span&gt; err != &lt;span class=&quot;code-snippet__literal&quot;&gt;nil&lt;/span&gt; {&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;  grpclog.Fatalf(&lt;span class=&quot;code-snippet__string&quot;&gt;&quot;Failed to create TLS credentials %v&quot;&lt;/span&gt;, err)&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt; }&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt; opts = &lt;span class=&quot;code-snippet__built_in&quot;&gt;append&lt;/span&gt;(opts, grpc.WithTransportCredentials(creds))&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;br/&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt; &lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt; conn, err := grpc.Dial(&lt;span class=&quot;code-snippet__string&quot;&gt;&quot;:8972&quot;&lt;/span&gt;, opts...)&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt; &lt;span class=&quot;code-snippet__keyword&quot;&gt;if&lt;/span&gt; err != &lt;span class=&quot;code-snippet__literal&quot;&gt;nil&lt;/span&gt; {&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;  fmt.Printf(&lt;span class=&quot;code-snippet__string&quot;&gt;&quot;faild to connect: %v&quot;&lt;/span&gt;, err)&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt; }&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt; &lt;span class=&quot;code-snippet__keyword&quot;&gt;defer&lt;/span&gt; conn.Close()&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;br/&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt; c := NewTokenServiceClient(conn)&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt; &lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt; r, err := c.Login(context.Background(), &amp;amp;LoginRequest{Username: &lt;span class=&quot;code-snippet__string&quot;&gt;&quot;xiaoming&quot;&lt;/span&gt;, Password: &lt;span class=&quot;code-snippet__string&quot;&gt;&quot;123456&quot;&lt;/span&gt;})&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt; &lt;span class=&quot;code-snippet__keyword&quot;&gt;if&lt;/span&gt; err != &lt;span class=&quot;code-snippet__literal&quot;&gt;nil&lt;/span&gt; {&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;  fmt.Printf(&lt;span class=&quot;code-snippet__string&quot;&gt;&quot;could not greet: %v&quot;&lt;/span&gt;, err)&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt; }&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt; requestToken := &lt;span class=&quot;code-snippet__built_in&quot;&gt;new&lt;/span&gt;(AuthToken)&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt; requestToken.Token = r.Token&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;br/&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt; &lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt; conn, err = grpc.Dial(&lt;span class=&quot;code-snippet__string&quot;&gt;&quot;:8972&quot;&lt;/span&gt;, grpc.WithTransportCredentials(creds),&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;  grpc.WithPerRPCCredentials(requestToken))&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt; &lt;span class=&quot;code-snippet__keyword&quot;&gt;if&lt;/span&gt; err != &lt;span class=&quot;code-snippet__literal&quot;&gt;nil&lt;/span&gt; {&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;  fmt.Printf(&lt;span class=&quot;code-snippet__string&quot;&gt;&quot;faild to connect: %v&quot;&lt;/span&gt;, err)&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt; }&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt; &lt;span class=&quot;code-snippet__keyword&quot;&gt;defer&lt;/span&gt; conn.Close()&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt; c = NewTokenServiceClient(conn)&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt; hello, err := c.SayHello(context.Background(), &amp;amp;PingMessage{Greeting: &lt;span class=&quot;code-snippet__string&quot;&gt;&quot;hahah&quot;&lt;/span&gt;})&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt; &lt;span class=&quot;code-snippet__keyword&quot;&gt;if&lt;/span&gt; err != &lt;span class=&quot;code-snippet__literal&quot;&gt;nil&lt;/span&gt; {&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;  fmt.Printf(&lt;span class=&quot;code-snippet__string&quot;&gt;&quot;could not greet: %v&quot;&lt;/span&gt;, err)&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt; }&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;br/&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt; fmt.Printf(&lt;span class=&quot;code-snippet__string&quot;&gt;&quot;Greeting: %s, %s !\n&quot;&lt;/span&gt;, r.Token, hello)&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/section&gt; &lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;客户端校验分为两个部分，Login 方法调用之前我们是不能加 token 校验的，因为此刻还没有拿到 token。&lt;/span&gt;&lt;/p&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;调用 Login 获取到 Token 之后将 token set 进 metadata，重新建立连接，此后的调用就使用 token 来进行校验。大家可以运行示例实验一下。&lt;/span&gt;&lt;/p&gt;&lt;section data-tools=&quot;135编辑器&quot; data-id=&quot;104446&quot;&gt;&lt;section&gt;&lt;section data-width=&quot;100%&quot;&gt;&lt;br/&gt;&lt;/section&gt;&lt;section&gt;&lt;section hm_fix=&quot;265:351&quot;&gt;&lt;section&gt;&lt;img data-ratio=&quot;1&quot; data-src=&quot;https://mmbiz.qpic.cn/mmbiz_png/K7IVueebAHmibbyIuZLlsTnSiaiaMOjm87ibvzGoaYlPPyYLuIriavoskaHGG3EJPFvMDc8icjia0MibiacsAmwO0Hm6Kcg/640?wx_fmt=png&quot; data-type=&quot;png&quot; data-w=&quot;23&quot; data-width=&quot;100%&quot;/&gt;&lt;/section&gt;&lt;section data-brushtype=&quot;text&quot;&gt;自定义校验方式&lt;/section&gt;&lt;section&gt;&lt;img data-ratio=&quot;0.9565217391304348&quot; data-src=&quot;https://mmbiz.qpic.cn/mmbiz_png/K7IVueebAHmibbyIuZLlsTnSiaiaMOjm87ibzZ6JKrPOR6JGwJTA9nGchSbmqPsOmIBhLjLtWcO7llIUNyiaXvTXia7w/640?wx_fmt=png&quot; data-type=&quot;png&quot; data-w=&quot;23&quot; data-width=&quot;100%&quot;/&gt;&lt;/section&gt;&lt;/section&gt;&lt;/section&gt;&lt;/section&gt;&lt;/section&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;上面 Token 校验方式中说过，实现自定义校验方式要实现 PerRPCCredentials 接口。Token 校验本身就是一折特殊的自定义校验方式，我们再来举个示例：&lt;/span&gt;&lt;/p&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;先来看客户端代码：&lt;/span&gt;&lt;/p&gt;&lt;section class=&quot;code-snippet__fix code-snippet__js&quot;&gt;&lt;pre class=&quot;code-snippet__js&quot; data-lang=&quot;go&quot;&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span class=&quot;code-snippet__keyword&quot;&gt;package&lt;/span&gt; normal&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;br/&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span class=&quot;code-snippet__keyword&quot;&gt;import&lt;/span&gt; (&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt; &lt;span class=&quot;code-snippet__string&quot;&gt;&quot;fmt&quot;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt; &lt;span class=&quot;code-snippet__string&quot;&gt;&quot;google.golang.org/grpc/credentials&quot;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt; &lt;span class=&quot;code-snippet__string&quot;&gt;&quot;google.golang.org/grpc/grpclog&quot;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt; &lt;span class=&quot;code-snippet__string&quot;&gt;&quot;testing&quot;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;br/&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt; &lt;span class=&quot;code-snippet__string&quot;&gt;&quot;golang.org/x/net/context&quot;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt; &lt;span class=&quot;code-snippet__string&quot;&gt;&quot;google.golang.org/grpc&quot;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt; pb &lt;span class=&quot;code-snippet__string&quot;&gt;&quot;gorm-demo/models/pb&quot;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;)&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;br/&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span class=&quot;code-snippet__keyword&quot;&gt;const&lt;/span&gt; (&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt; &lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt; OpenTLS = &lt;span class=&quot;code-snippet__literal&quot;&gt;true&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;)&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;br/&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;/&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span class=&quot;code-snippet__keyword&quot;&gt;type&lt;/span&gt; customCredential &lt;span class=&quot;code-snippet__keyword&quot;&gt;struct&lt;/span&gt;{}&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;br/&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;/&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span class=&quot;code-snippet__function&quot;&gt;&lt;span class=&quot;code-snippet__keyword&quot;&gt;func&lt;/span&gt; &lt;span class=&quot;code-snippet__params&quot;&gt;(c customCredential)&lt;/span&gt; &lt;span class=&quot;code-snippet__title&quot;&gt;GetRequestMetadata&lt;/span&gt;&lt;span class=&quot;code-snippet__params&quot;&gt;(ctx context.Context, uri ...&lt;span class=&quot;code-snippet__keyword&quot;&gt;string&lt;/span&gt;)&lt;/span&gt; &lt;span class=&quot;code-snippet__params&quot;&gt;(&lt;span class=&quot;code-snippet__keyword&quot;&gt;map&lt;/span&gt;[&lt;span class=&quot;code-snippet__keyword&quot;&gt;string&lt;/span&gt;]&lt;span class=&quot;code-snippet__keyword&quot;&gt;string&lt;/span&gt;, error)&lt;/span&gt;&lt;/span&gt; {&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt; &lt;span class=&quot;code-snippet__keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-snippet__keyword&quot;&gt;map&lt;/span&gt;[&lt;span class=&quot;code-snippet__keyword&quot;&gt;string&lt;/span&gt;]&lt;span class=&quot;code-snippet__keyword&quot;&gt;string&lt;/span&gt;{&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;  &lt;span class=&quot;code-snippet__string&quot;&gt;&quot;appId&quot;&lt;/span&gt;:  &lt;span class=&quot;code-snippet__string&quot;&gt;&quot;110&quot;&lt;/span&gt;,&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;  &lt;span class=&quot;code-snippet__string&quot;&gt;&quot;appKey&quot;&lt;/span&gt;: &lt;span class=&quot;code-snippet__string&quot;&gt;&quot;token&quot;&lt;/span&gt;,&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt; }, &lt;span class=&quot;code-snippet__literal&quot;&gt;nil&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;br/&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;/&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span class=&quot;code-snippet__function&quot;&gt;&lt;span class=&quot;code-snippet__keyword&quot;&gt;func&lt;/span&gt; &lt;span class=&quot;code-snippet__params&quot;&gt;(c customCredential)&lt;/span&gt; &lt;span class=&quot;code-snippet__title&quot;&gt;RequireTransportSecurity&lt;/span&gt;&lt;span class=&quot;code-snippet__params&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;code-snippet__title&quot;&gt;bool&lt;/span&gt;&lt;/span&gt; {&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt; &lt;span class=&quot;code-snippet__keyword&quot;&gt;return&lt;/span&gt; OpenTLS&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;br/&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span class=&quot;code-snippet__function&quot;&gt;&lt;span class=&quot;code-snippet__keyword&quot;&gt;func&lt;/span&gt; &lt;span class=&quot;code-snippet__title&quot;&gt;TestGrpcClient&lt;/span&gt;&lt;span class=&quot;code-snippet__params&quot;&gt;(t *testing.T)&lt;/span&gt;&lt;/span&gt; {&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt; &lt;span class=&quot;code-snippet__keyword&quot;&gt;var&lt;/span&gt; err error&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt; &lt;span class=&quot;code-snippet__keyword&quot;&gt;var&lt;/span&gt; opts []grpc.DialOption&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;br/&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt; &lt;span class=&quot;code-snippet__keyword&quot;&gt;if&lt;/span&gt; OpenTLS {&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;  &lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;  creds, err := credentials.NewClientTLSFromFile(&lt;span class=&quot;code-snippet__string&quot;&gt;&quot;/Users/yangyue2/ca.crt&quot;&lt;/span&gt;, &lt;span class=&quot;code-snippet__string&quot;&gt;&quot;www.yangyue.com&quot;&lt;/span&gt;)&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;  &lt;span class=&quot;code-snippet__keyword&quot;&gt;if&lt;/span&gt; err != &lt;span class=&quot;code-snippet__literal&quot;&gt;nil&lt;/span&gt; {&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;   grpclog.Fatalf(&lt;span class=&quot;code-snippet__string&quot;&gt;&quot;Failed to create TLS credentials %v&quot;&lt;/span&gt;, err)&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;  }&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;  opts = &lt;span class=&quot;code-snippet__built_in&quot;&gt;append&lt;/span&gt;(opts, grpc.WithTransportCredentials(creds))&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt; } &lt;span class=&quot;code-snippet__keyword&quot;&gt;else&lt;/span&gt; {&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;  opts = &lt;span class=&quot;code-snippet__built_in&quot;&gt;append&lt;/span&gt;(opts, grpc.WithInsecure())&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt; }&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt; &lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt; opts = &lt;span class=&quot;code-snippet__built_in&quot;&gt;append&lt;/span&gt;(opts, grpc.WithPerRPCCredentials(&lt;span class=&quot;code-snippet__built_in&quot;&gt;new&lt;/span&gt;(customCredential)))&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt; &lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt; conn, err := grpc.Dial(&lt;span class=&quot;code-snippet__string&quot;&gt;&quot;:8972&quot;&lt;/span&gt;, opts...)&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt; &lt;span class=&quot;code-snippet__keyword&quot;&gt;if&lt;/span&gt; err != &lt;span class=&quot;code-snippet__literal&quot;&gt;nil&lt;/span&gt; {&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;  fmt.Printf(&lt;span class=&quot;code-snippet__string&quot;&gt;&quot;faild to connect: %v&quot;&lt;/span&gt;, err)&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt; }&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt; &lt;span class=&quot;code-snippet__keyword&quot;&gt;defer&lt;/span&gt; conn.Close()&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;br/&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt; c := pb.NewGreeterClient(conn)&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt; &lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt; r, err := c.SayHello(context.Background(), &amp;amp;pb.HelloRequest{Name: &lt;span class=&quot;code-snippet__string&quot;&gt;&quot;CN&quot;&lt;/span&gt;})&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt; &lt;span class=&quot;code-snippet__keyword&quot;&gt;if&lt;/span&gt; err != &lt;span class=&quot;code-snippet__literal&quot;&gt;nil&lt;/span&gt; {&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;  fmt.Printf(&lt;span class=&quot;code-snippet__string&quot;&gt;&quot;could not greet: %v&quot;&lt;/span&gt;, err)&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt; }&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;br/&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt; fmt.Printf(&lt;span class=&quot;code-snippet__string&quot;&gt;&quot;Greeting: %s !\n&quot;&lt;/span&gt;, r.Message)&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;br/&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/section&gt; &lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;自定义了一个 根据 appid 和 appkey 来校验权限的功能，服务端检查存在即放过。服务端代码：&lt;/span&gt;&lt;/p&gt;&lt;section class=&quot;code-snippet__fix code-snippet__js&quot;&gt;&lt;pre class=&quot;code-snippet__js&quot; data-lang=&quot;go&quot;&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span class=&quot;code-snippet__keyword&quot;&gt;package&lt;/span&gt; normal&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;br/&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span class=&quot;code-snippet__keyword&quot;&gt;import&lt;/span&gt; (&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt; &lt;span class=&quot;code-snippet__string&quot;&gt;&quot;context&quot;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt; &lt;span class=&quot;code-snippet__string&quot;&gt;&quot;fmt&quot;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt; &lt;span class=&quot;code-snippet__string&quot;&gt;&quot;google.golang.org/grpc&quot;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt; &lt;span class=&quot;code-snippet__string&quot;&gt;&quot;google.golang.org/grpc/codes&quot;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt; &lt;span class=&quot;code-snippet__string&quot;&gt;&quot;google.golang.org/grpc/credentials&quot;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt; &lt;span class=&quot;code-snippet__string&quot;&gt;&quot;google.golang.org/grpc/grpclog&quot;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt; &lt;span class=&quot;code-snippet__string&quot;&gt;&quot;google.golang.org/grpc/metadata&quot;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt; &lt;span class=&quot;code-snippet__string&quot;&gt;&quot;google.golang.org/grpc/reflection&quot;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt; pb &lt;span class=&quot;code-snippet__string&quot;&gt;&quot;gorm-demo/models/pb&quot;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt; &lt;span class=&quot;code-snippet__string&quot;&gt;&quot;net&quot;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt; &lt;span class=&quot;code-snippet__string&quot;&gt;&quot;testing&quot;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;)&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;br/&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;/&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span class=&quot;code-snippet__function&quot;&gt;&lt;span class=&quot;code-snippet__keyword&quot;&gt;func&lt;/span&gt; &lt;span class=&quot;code-snippet__title&quot;&gt;LoggingInterceptor&lt;/span&gt;&lt;span class=&quot;code-snippet__params&quot;&gt;(ctx context.Context, req &lt;span class=&quot;code-snippet__keyword&quot;&gt;interface&lt;/span&gt;{}, info *grpc.UnaryServerInfo,&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt; handler grpc.UnaryHandler)&lt;/span&gt; &lt;span class=&quot;code-snippet__params&quot;&gt;(&lt;span class=&quot;code-snippet__keyword&quot;&gt;interface&lt;/span&gt;{}, error)&lt;/span&gt; {&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt; fmt.Printf(&lt;span class=&quot;code-snippet__string&quot;&gt;&quot;gRPC method: %s, %v&quot;&lt;/span&gt;, info.FullMethod, req)&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt; resp, err := handler(ctx, req)&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt; fmt.Printf(&lt;span class=&quot;code-snippet__string&quot;&gt;&quot;gRPC method: %s, %v&quot;&lt;/span&gt;, info.FullMethod, resp)&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt; &lt;span class=&quot;code-snippet__keyword&quot;&gt;return&lt;/span&gt; resp, err&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;br/&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;/&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span class=&quot;code-snippet__keyword&quot;&gt;type&lt;/span&gt; helloService &lt;span class=&quot;code-snippet__keyword&quot;&gt;struct&lt;/span&gt;{}&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;br/&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;br/&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;/&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span class=&quot;code-snippet__function&quot;&gt;&lt;span class=&quot;code-snippet__keyword&quot;&gt;func&lt;/span&gt; &lt;span class=&quot;code-snippet__params&quot;&gt;(h helloService)&lt;/span&gt; &lt;span class=&quot;code-snippet__title&quot;&gt;SayHello&lt;/span&gt;&lt;span class=&quot;code-snippet__params&quot;&gt;(ctx context.Context, in *pb.HelloRequest)&lt;/span&gt; &lt;span class=&quot;code-snippet__params&quot;&gt;(*pb.HelloReply, error)&lt;/span&gt;&lt;/span&gt; {&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt; &lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt; md, ok := metadata.FromIncomingContext(ctx)&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt; &lt;span class=&quot;code-snippet__keyword&quot;&gt;if&lt;/span&gt; !ok {&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;  &lt;span class=&quot;code-snippet__keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-snippet__literal&quot;&gt;nil&lt;/span&gt;, grpc.Errorf(codes.Unauthenticated, &lt;span class=&quot;code-snippet__string&quot;&gt;&quot;无Token认证信息&quot;&lt;/span&gt;)&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt; }&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt; &lt;span class=&quot;code-snippet__keyword&quot;&gt;var&lt;/span&gt; (&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;  appId  &lt;span class=&quot;code-snippet__keyword&quot;&gt;string&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;  appKey &lt;span class=&quot;code-snippet__keyword&quot;&gt;string&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt; )&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt; &lt;span class=&quot;code-snippet__keyword&quot;&gt;if&lt;/span&gt; val, ok := md[&lt;span class=&quot;code-snippet__string&quot;&gt;&quot;appid&quot;&lt;/span&gt;]; ok {&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;  appId = val[&lt;span class=&quot;code-snippet__number&quot;&gt;0&lt;/span&gt;]&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt; }&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;br/&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt; &lt;span class=&quot;code-snippet__keyword&quot;&gt;if&lt;/span&gt; val, ok := md[&lt;span class=&quot;code-snippet__string&quot;&gt;&quot;appkey&quot;&lt;/span&gt;]; ok {&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;  appKey = val[&lt;span class=&quot;code-snippet__number&quot;&gt;0&lt;/span&gt;]&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt; }&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;br/&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt; &lt;span class=&quot;code-snippet__keyword&quot;&gt;if&lt;/span&gt; appId != &lt;span class=&quot;code-snippet__string&quot;&gt;&quot;110&quot;&lt;/span&gt; || appKey != &lt;span class=&quot;code-snippet__string&quot;&gt;&quot;token&quot;&lt;/span&gt; {&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;  &lt;span class=&quot;code-snippet__keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-snippet__literal&quot;&gt;nil&lt;/span&gt;, grpc.Errorf(codes.Unauthenticated, &lt;span class=&quot;code-snippet__string&quot;&gt;&quot;Token认证信息无效: appid=%s, appkey=%s&quot;&lt;/span&gt;, appId, appKey)&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt; }&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;br/&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt; resp := &lt;span class=&quot;code-snippet__built_in&quot;&gt;new&lt;/span&gt;(pb.HelloReply)&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt; resp.Message = fmt.Sprintf(&lt;span class=&quot;code-snippet__string&quot;&gt;&quot;Hello %s.\nToken info: appid=%s,appkey=%s&quot;&lt;/span&gt;, in.Name, appId, appKey)&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;br/&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt; &lt;span class=&quot;code-snippet__keyword&quot;&gt;return&lt;/span&gt; resp, &lt;span class=&quot;code-snippet__literal&quot;&gt;nil&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;br/&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span class=&quot;code-snippet__function&quot;&gt;&lt;span class=&quot;code-snippet__keyword&quot;&gt;func&lt;/span&gt; &lt;span class=&quot;code-snippet__title&quot;&gt;TestGrpcServer&lt;/span&gt;&lt;span class=&quot;code-snippet__params&quot;&gt;(t *testing.T)&lt;/span&gt;&lt;/span&gt; {&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt; &lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt; lis, err := net.Listen(&lt;span class=&quot;code-snippet__string&quot;&gt;&quot;tcp&quot;&lt;/span&gt;, &lt;span class=&quot;code-snippet__string&quot;&gt;&quot;:8972&quot;&lt;/span&gt;)&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt; &lt;span class=&quot;code-snippet__keyword&quot;&gt;if&lt;/span&gt; err != &lt;span class=&quot;code-snippet__literal&quot;&gt;nil&lt;/span&gt; {&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;  fmt.Printf(&lt;span class=&quot;code-snippet__string&quot;&gt;&quot;failed to listen: %v&quot;&lt;/span&gt;, err)&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;  &lt;span class=&quot;code-snippet__keyword&quot;&gt;return&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt; }&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;br/&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt; &lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt; creds, err := credentials.NewServerTLSFromFile(&lt;span class=&quot;code-snippet__string&quot;&gt;&quot;/Users/yangyue2/server.crt&quot;&lt;/span&gt;, &lt;span class=&quot;code-snippet__string&quot;&gt;&quot;/Users/yangyue2/server.key&quot;&lt;/span&gt;)&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt; &lt;span class=&quot;code-snippet__keyword&quot;&gt;if&lt;/span&gt; err != &lt;span class=&quot;code-snippet__literal&quot;&gt;nil&lt;/span&gt; {&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;  grpclog.Fatalf(&lt;span class=&quot;code-snippet__string&quot;&gt;&quot;Failed to generate credentials %v&quot;&lt;/span&gt;, err)&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt; }&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;br/&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt; &lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt; s := grpc.NewServer(grpc.Creds(creds), grpc.UnaryInterceptor(LoggingInterceptor)) &lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt; pb.RegisterGreeterServer(s, &amp;amp;helloService{})                                      &lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;br/&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt; reflection.Register(s) &lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt; &lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt; &lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt; err = s.Serve(lis)&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt; &lt;span class=&quot;code-snippet__keyword&quot;&gt;if&lt;/span&gt; err != &lt;span class=&quot;code-snippet__literal&quot;&gt;nil&lt;/span&gt; {&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;  fmt.Printf(&lt;span class=&quot;code-snippet__string&quot;&gt;&quot;failed to serve: %v&quot;&lt;/span&gt;, err)&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;  &lt;span class=&quot;code-snippet__keyword&quot;&gt;return&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt; }&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;br/&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/section&gt; &lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;服务端校验是否存在对应的 appid 和 appkey 即可。了解了如何使用之后写起来就很简单。&lt;/span&gt;&lt;/p&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;关于 gRPC 安全认证方式就到这里，两篇内容分别讲了基于 TLS 的认证和自定义认证的逻辑。大家根据业务场景自行决定使用哪种校验即可。&lt;/span&gt;&lt;/p&gt;&lt;h3 data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;&lt;strong&gt;参考资料&lt;/strong&gt;&lt;/span&gt;&lt;/h3&gt;&lt;section data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;[1]&lt;/span&gt;&lt;span&gt;&lt;p&gt;JSON Web Token: &lt;em&gt;https://jwt.io/&lt;/em&gt;&lt;/p&gt;&lt;/span&gt; &lt;span&gt;[2]&lt;/span&gt;&lt;span&gt;&lt;p&gt;Gitbub仓库: &lt;em&gt;https://github.com/rickiyang/go-web-demo/tree/main/test/grpcTest/tokenTls&lt;/em&gt;&lt;/p&gt;&lt;/span&gt; &lt;/section&gt;&lt;/section&gt;&lt;/div&gt;&lt;/div&gt;</content:encoded>
</item>
<item>
<guid>0c4780fda542d625e88dc0cd345f9520</guid>
<title>Rainbond 5.3.1 发布，支持 100+ 组件的超大应用一键交付</title>
<link>https://toutiao.io/k/le5qusv</link>
<content:encoded>&lt;div&gt;&lt;div&gt;&lt;div class=&quot;rich_media_content &quot; id=&quot;js_content&quot;&gt;
                    

                    
                    
                    
                    &lt;p data-mpa-powered-by=&quot;yiban.io&quot;&gt;2021年7月5日，Rainbond 5.3.1 正式发布。&lt;/p&gt;&lt;blockquote&gt;&lt;p&gt;&lt;a target=&quot;_blank&quot; href=&quot;https://github.com/goodrain/rainbond&quot; textvalue=&quot;Rainbond &quot; tab=&quot;outerlink&quot; data-linktype=&quot;2&quot;&gt;&lt;span&gt;&lt;span&gt;Rainbond&lt;/span&gt; &lt;/span&gt;&lt;/a&gt;&lt;span&gt;是云原生且易用的应用管理平台。云原生应用交付的最佳实践。专注于以应用为中心的理念，赋能企业搭建云原生开发云、云原生交付云。&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;&lt;strong&gt;对于企业：&lt;/strong&gt; Rainbond 是开箱即用的云原生平台，借助 Rainbond 可以快速完成企业研发和交付体系的云原生转型。&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;&lt;strong&gt;对于开发者：&lt;/strong&gt; 基于 Rainbond 开发、测试和运维企业业务应用，开箱即用的获得全方位的云原生技术能力。包括但不仅限于持续集成、服务治理、架构支撑、多维度应用观测、流量管理。&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;&lt;strong&gt;对于项目交付：&lt;/strong&gt; 基于 Rainbond 搭建产品版本化管理体系，搭建标准化客户交付环境，使传统的交付流程可以自动化、简单化和可管理。&lt;/span&gt;&lt;/p&gt;&lt;/blockquote&gt;&lt;p&gt;近一年，使用Rainbond 云原生应用交付流程（见下图）的开源用户成为主流，面对不同用户的业务复杂性，对Rainbond交付流程的性能提出了新的要求。从 5.3.0 版本发布以来4个月的时间，Rainbond 开发者以交付链路的性能优化为主要迭代方向。&lt;/p&gt;&lt;p&gt;&lt;img data-backh=&quot;158&quot; data-backw=&quot;315&quot; data-ratio=&quot;0.5027573529411765&quot; data-src=&quot;https://mmbiz.qpic.cn/mmbiz_png/tsMTBX9VJicp5tjIqctJ1z1LyvlK9T0C4uQXMdrgeP9qpQnSHLyOJ3nxtribklJFslcK5jAP8NuUrfTTSafibNgTQ/640?wx_fmt=png&quot; data-type=&quot;png&quot; data-w=&quot;2176&quot; title=&quot;null&quot;/&gt;&lt;/p&gt;&lt;p&gt;在工业互联网、智慧园区建设、智慧城市建设等等领域中，一个应用解决方案大多具有50-100个服务组件。在这些行业中，通常会有多家应用厂商来合作完成一个解决方案。Rainbond 在这个过程中提供多项能力：&lt;/p&gt;&lt;p&gt;（1）标准化应用交付模型，统一各个应用厂商的应用交付标准，使行业集成商低成本集成解决方案。&lt;/p&gt;&lt;p&gt;（2）统一交付环境，一键实现应用交付。大大降低销售过程中的演示场景、POC场景和成本和最终交付的成本。&lt;/p&gt;&lt;p&gt;（3）智能应用运维管理，降低最终客户的运维成本。&lt;/p&gt;&lt;p&gt;&lt;/p&gt;&lt;section data-mpa-template=&quot;t&quot; mpa-from-tpl=&quot;t&quot;&gt;&lt;section data-mid=&quot;&quot; mpa-from-tpl=&quot;t&quot;&gt;&lt;section data-mid=&quot;&quot; mpa-from-tpl=&quot;t&quot;&gt;&lt;section data-mid=&quot;&quot; mpa-from-tpl=&quot;t&quot;&gt;&lt;img data-ratio=&quot;0.05319148936170213&quot; data-src=&quot;https://mmbiz.qpic.cn/mmbiz_png/SNCWuBRAEwaTLSfnPyia62ZtcMGcvBKAbUbBoEmPSlicYY0BS8RuSlpNEARGp19MgXicEpaiblwuxTOAlu4XvBVV8A/640?wx_fmt=png&quot; data-type=&quot;png&quot; data-w=&quot;376&quot;/&gt;&lt;/section&gt;&lt;/section&gt;&lt;/section&gt;&lt;/section&gt;&lt;h2&gt;&lt;span data-mpa-emphasize-underline=&quot;t&quot;&gt;&lt;span&gt;关键变更&lt;/span&gt;&lt;span data-mpa-emphasize-underline-bg-line=&quot;t&quot;/&gt;&lt;/span&gt;&lt;br/&gt;&lt;/h2&gt;&lt;h3&gt;&lt;span data-mpa-emphasize-underline=&quot;t&quot;&gt;&lt;span&gt;支持100+组件规模应用交付&lt;/span&gt;&lt;span data-mpa-emphasize-underline-bg-line=&quot;t&quot;/&gt;&lt;/span&gt;&lt;/h3&gt;&lt;p&gt;基于上述的Rainbond应用交付流程，当前版本在应用模型发布、应用模型安装、应用升级、应用生命周期管理四个维度进行性能优化。以应用模型安装为例，100个组件的安装过程需要调用大量的计算资源，控制组件的启动顺序，控制微服务系统注册和配置分发。&lt;/p&gt;&lt;p&gt;&lt;img class=&quot;rich_pages js_insertlocalimg&quot; data-ratio=&quot;0.48768768768768767&quot; data-s=&quot;300,640&quot; data-src=&quot;https://mmbiz.qpic.cn/mmbiz_gif/tsMTBX9VJicp5tjIqctJ1z1LyvlK9T0C4fhZ6aWmSBiae9yicXTspTCADC0Cx1NribXkaFvP5CHIUNUibAqEOFvZTqA/640?wx_fmt=gif&quot; data-type=&quot;gif&quot; data-w=&quot;1665&quot;/&gt;&lt;/p&gt;&lt;p&gt;&lt;/p&gt;&lt;center&gt;&lt;span&gt;多组件应用安装和升级演示&lt;/span&gt;&lt;/center&gt;&lt;h3&gt;&lt;span data-mpa-emphasize-underline=&quot;t&quot;&gt;&lt;span&gt;Helm应用安装与管理(Beta)&lt;/span&gt;&lt;span data-mpa-emphasize-underline-bg-line=&quot;t&quot;/&gt;&lt;/span&gt;&lt;/h3&gt;&lt;p&gt;Rainbond 不支持Helm应用安装和管理早已是一个痛点。Rainbond 的产品形态是以管理自定义的应用规范为核心的云原生应用管理。与其他容器化平台不一样，我们不提供Kubernetes原生的资源管理面板。因此在面对灵活的Helm应用包，我们没有很好的方式将所有Helm应用转化为Rainbond的应用规范。在OAM规范的实现模式中，有一个思路是把每一个Helm应用定义为自定义的组件类型，对其进行资源类型识别从而实现一些运维能力注入。我们认为这种模式精细化管理有优势，但用户落地成本很大。&lt;/p&gt;&lt;p&gt;当前版本我们采用一种新的模式来安装和管理Helm应用。我们将其定位为 Rainbond 原生应用的补充，作为部署一些中间件的载体，所以我们主要要考虑解决以下问题：&lt;/p&gt;&lt;p&gt;（1）Helm安装的应用如何接入Rainbond ServiceMesh微服务架构，实现原生应用可调用Helm应用。&lt;/p&gt;&lt;p&gt;（2）Helm安装的应用如何接入Rainbond 网关，实现外部访问及流量治理。&lt;/p&gt;&lt;p&gt;（3）Helm应用管理能力支持多少。&lt;/p&gt;&lt;p&gt;我们定义了Kubernets自定义资源HelmApp，实现HelmApp的多集群部署。用户对接上Helm应用商店后，即可选择应用进行安装。安装过程中完全支持Helm应用的配置规范进行应用配置，同时也支持 Rancher 定义的配置表单规范，实现配置表单自动生成。Helm应用部署后自动识别其Service资源，进行服务的注册，实现Rainbond微服务和网关体系的接入。&lt;/p&gt;&lt;h3&gt;&lt;span data-mpa-emphasize-underline=&quot;t&quot;&gt;&lt;span&gt;逐步适配OAM应用规范&lt;/span&gt;&lt;span data-mpa-emphasize-underline-bg-line=&quot;t&quot;/&gt;&lt;/span&gt;&lt;/h3&gt;&lt;p&gt;从5.3.1版本开始，我们开始逐步适配OAM应用规范，提升Rainbond的可扩展性。在当前版本中我们基于&lt;a target=&quot;_blank&quot; href=&quot;https://github.com/oam-dev/spec&quot; textvalue=&quot;OAM规范&quot; tab=&quot;outerlink&quot; data-linktype=&quot;2&quot;&gt;&lt;span&gt;OAM规范&lt;/span&gt;&lt;/a&gt;，重新实现第三方组件类型，定义了ThirdComponent 作为第一个 ComponentDefinition，并在产品中实现对ComponentDefinition的基础管理机制。接下来Rainbond中现有的两种内置组件类型逐步基于ComponentDefinition定义实现。然后开放用户自行扩展的能力，Rainbond中提供整个支撑体系，包括通用运维特征能力注入、配置UI化、通用的微服务治理和流量管理、应用打包交付等。&lt;/p&gt;&lt;p&gt;&lt;img data-backh=&quot;16&quot; data-backw=&quot;315&quot; data-ratio=&quot;0.051181102362204724&quot; data-src=&quot;https://mmbiz.qpic.cn/mmbiz_png/tsMTBX9VJicp5tjIqctJ1z1LyvlK9T0C4hY0B5YJoehVslzlJHdfIdkdqCll1fQncX1nK4LRKParicUmHRuGBVrg/640?wx_fmt=png&quot; data-type=&quot;png&quot; data-w=&quot;2032&quot; title=&quot;null&quot;/&gt;&lt;/p&gt;&lt;p&gt;&lt;/p&gt;&lt;section data-mpa-template=&quot;t&quot; mpa-from-tpl=&quot;t&quot;&gt;&lt;section data-mid=&quot;&quot; mpa-from-tpl=&quot;t&quot;&gt;&lt;section data-mid=&quot;&quot; mpa-from-tpl=&quot;t&quot;&gt;&lt;section data-mid=&quot;&quot; mpa-from-tpl=&quot;t&quot;&gt;&lt;img data-ratio=&quot;0.05319148936170213&quot; data-src=&quot;https://mmbiz.qpic.cn/mmbiz_png/SNCWuBRAEwaTLSfnPyia62ZtcMGcvBKAbUbBoEmPSlicYY0BS8RuSlpNEARGp19MgXicEpaiblwuxTOAlu4XvBVV8A/640?wx_fmt=png&quot; data-type=&quot;png&quot; data-w=&quot;376&quot;/&gt;&lt;br/&gt;&lt;/section&gt;&lt;/section&gt;&lt;/section&gt;&lt;/section&gt;&lt;h2&gt;&lt;span data-mpa-emphasize-underline=&quot;t&quot;&gt;&lt;span&gt;详细变更点&lt;/span&gt;&lt;span data-mpa-emphasize-underline-bg-line=&quot;t&quot;/&gt;&lt;/span&gt;&lt;br/&gt;&lt;/h2&gt;&lt;h3&gt;&lt;span data-mpa-emphasize-underline=&quot;t&quot;&gt;&lt;span&gt;新增功能&lt;/span&gt;&lt;span data-mpa-emphasize-underline-bg-line=&quot;t&quot;/&gt;&lt;/span&gt;&lt;/h3&gt;&lt;p&gt;&lt;span&gt;&lt;span&gt;•&lt;/span&gt;【应用商店】支持Helm应用仓库对接；&lt;/span&gt;&lt;span&gt;&lt;span&gt;•&lt;/span&gt;【应用管理】支持Helm应用安装和配置；&lt;/span&gt;&lt;span&gt;&lt;span&gt;•&lt;/span&gt;【微服务治理】支持通过网关或内部组件依赖两种方式访问Helm安装的应用；&lt;/span&gt;&lt;span&gt;&lt;span&gt;•&lt;/span&gt;【微服务治理】新增GRPC协议的服务治理能力；&lt;/span&gt;&lt;span&gt;&lt;span&gt;•&lt;/span&gt;【微服务治理】新增对组件下容器启动顺序控制，实现mesh容器先于业务容器启动；&lt;/span&gt;&lt;span&gt;&lt;span&gt;•&lt;/span&gt;【组件管理】新增基于kubernetes service服务发现类型的第三方组件；&lt;/span&gt;&lt;span&gt;&lt;span&gt;•&lt;/span&gt;【源码构建】Go语言新增对Go 1.14、1.15、1.16 版本Runtime的支持；&lt;/span&gt;&lt;span&gt;&lt;span&gt;•&lt;/span&gt;【源码构建】Go语言新增对构建模块和启动命令的配置；&lt;/span&gt;&lt;span&gt;&lt;span&gt;•&lt;/span&gt;【源码构建】Java、Go、PHP等语言新增pre_build、post_build构建时shell hook的支持；&lt;/span&gt;&lt;span&gt;&lt;span&gt;•&lt;/span&gt;【企业管理】用户管理中新增对用户所在团队及角色的批量管理能力；&lt;/span&gt;&lt;span&gt;&lt;span&gt;•&lt;/span&gt;【企业管理】团队管理中新增开通集群的功能入口；&lt;/span&gt;&lt;span&gt;&lt;span&gt;•&lt;/span&gt;【集群安装】支持RKE集群配置，实现集群节点配置的灵活调整；&lt;/span&gt;&lt;/p&gt;&lt;h3&gt;&lt;span data-mpa-emphasize-underline=&quot;t&quot;&gt;&lt;span&gt;优化功能&lt;/span&gt;&lt;span data-mpa-emphasize-underline-bg-line=&quot;t&quot;/&gt;&lt;/span&gt;&lt;/h3&gt;&lt;p&gt;&lt;span&gt;&lt;span&gt;•&lt;/span&gt;【性能】应用升级体系优化，支持100+组件批量升级；&lt;/span&gt;&lt;span&gt;&lt;span&gt;•&lt;/span&gt;【性能】从应用商店安装组件实现优化，支持100+组件批量安装；&lt;/span&gt;&lt;span&gt;&lt;span&gt;•&lt;/span&gt;【性能】改进拓扑图加载逻辑，加速大应用下拓扑图加载速度；&lt;/span&gt;&lt;span&gt;&lt;span&gt;•&lt;/span&gt;【性能】优化在大量组件情况下的应用级生命周期操作API的性能；&lt;/span&gt;&lt;span&gt;&lt;span&gt;•&lt;/span&gt;【稳定性】应用网关优化，解决异常应用访问导致网关内存泄露的故障；&lt;/span&gt;&lt;span&gt;&lt;span&gt;•&lt;/span&gt;【组件管理】支持空值的环境变量和配置组变量；&lt;/span&gt;&lt;span&gt;&lt;span&gt;•&lt;/span&gt;【监控报警】移除错误的节点健康检测报警策略；&lt;/span&gt;&lt;span&gt;&lt;span&gt;•&lt;/span&gt;【组件管理】重构组件本地存储类型的实现，支持使用本地存储组件复用集群的调度策略；&lt;/span&gt;&lt;span&gt;&lt;span&gt;•&lt;/span&gt;【内部组件库】新增应用模型版本管理，支持在发布页展示版本介绍；&lt;/span&gt;&lt;span&gt;&lt;span&gt;•&lt;/span&gt;【组件管理】支持组件设置自定义主机名解析记录；&lt;/span&gt;&lt;/p&gt;&lt;h3&gt;&lt;span data-mpa-emphasize-underline=&quot;t&quot;&gt;&lt;span&gt;BUG修复&lt;/span&gt;&lt;span data-mpa-emphasize-underline-bg-line=&quot;t&quot;/&gt;&lt;/span&gt;&lt;/h3&gt;&lt;p&gt;&lt;span&gt;&lt;span&gt;•&lt;/span&gt;【源码构建】修复 .netcore 源码构建任务无法结束的故障；&lt;/span&gt;&lt;span&gt;&lt;span&gt;•&lt;/span&gt;【控制台】修复网关策略搜索功能不可用故障；&lt;/span&gt;&lt;span&gt;&lt;span&gt;•&lt;/span&gt;【源码构建】修复Maven 配置删除后源码构建无法执行的故障；&lt;/span&gt;&lt;span&gt;&lt;span&gt;•&lt;/span&gt;【稳定性】修复错误的网关策略参数导致网关故障；&lt;/span&gt;&lt;span&gt;&lt;span&gt;•&lt;/span&gt;【组件管理】修复组件实例数不一致的故障；&lt;/span&gt;&lt;span&gt;&lt;span&gt;•&lt;/span&gt;【稳定性】修复rbd-worker系统组件由于etcd不稳定异常重启的故障；&lt;/span&gt;&lt;span&gt;&lt;span&gt;•&lt;/span&gt;【应用管理】修复对接非HTTPS镜像仓库时应用备份不可用的故障；&lt;/span&gt;&lt;span&gt;&lt;span&gt;•&lt;/span&gt;【集群安装】修复集群镜像仓库证书不一致的故障；&lt;/span&gt;&lt;span&gt;&lt;br/&gt;&lt;/span&gt;&lt;/p&gt;&lt;section data-mpa-template=&quot;t&quot; mpa-from-tpl=&quot;t&quot;&gt;&lt;section data-mid=&quot;&quot; mpa-from-tpl=&quot;t&quot;&gt;&lt;section data-mid=&quot;&quot; mpa-from-tpl=&quot;t&quot;&gt;&lt;section data-mid=&quot;&quot; mpa-from-tpl=&quot;t&quot;&gt;&lt;img data-ratio=&quot;0.05319148936170213&quot; data-src=&quot;https://mmbiz.qpic.cn/mmbiz_png/SNCWuBRAEwaTLSfnPyia62ZtcMGcvBKAbUbBoEmPSlicYY0BS8RuSlpNEARGp19MgXicEpaiblwuxTOAlu4XvBVV8A/640?wx_fmt=png&quot; data-type=&quot;png&quot; data-w=&quot;376&quot;/&gt;&lt;/section&gt;&lt;/section&gt;&lt;/section&gt;&lt;/section&gt;&lt;h2&gt;&lt;span data-mpa-emphasize-underline=&quot;t&quot;&gt;&lt;span&gt;社区&lt;/span&gt;&lt;span data-mpa-emphasize-underline-bg-line=&quot;t&quot;/&gt;&lt;/span&gt;&lt;br/&gt;&lt;/h2&gt;&lt;p&gt;如果您对Rainbond项目感兴趣，如果您有一些疑问，如果您对云原生、Kubernetes等技术感兴趣，欢迎加入Rainbond 社区钉钉群。&lt;/p&gt;&lt;p&gt;&lt;img data-ratio=&quot;1.1073345259391771&quot; data-src=&quot;https://mmbiz.qpic.cn/mmbiz_jpg/tsMTBX9VJicp5tjIqctJ1z1LyvlK9T0C4ssdAibbQnDxwzxe84ksJd8pMpTR6qjzuRrhSCI6GYIesLK1VndPU3RA/640?wx_fmt=jpeg&quot; data-type=&quot;jpeg&quot; data-w=&quot;2236&quot;/&gt;&lt;/p&gt;&lt;p&gt;&lt;span md-inline=&quot;plain&quot;&gt;安装使用请参考文档：&lt;/span&gt;&lt;span md-inline=&quot;link&quot;&gt;&lt;a href=&quot;https://www.rainbond.com/docs/quick-start/quick-install/&quot; data-linktype=&quot;2&quot;&gt;&lt;span md-inline=&quot;plain&quot;&gt;快速安装&lt;/span&gt;&lt;/a&gt;&lt;/span&gt;&lt;a target=&quot;_blank&quot; href=&quot;https://www.rainbond.com/docs/quick-start/quick-install/&quot; textvalue=&quot;快速安装&quot; tab=&quot;outerlink&quot; data-linktype=&quot;2&quot;/&gt;&lt;/p&gt;&lt;p&gt;&lt;span md-inline=&quot;plain&quot;&gt;从5.3.0升级到5.3.1: &lt;/span&gt;&lt;span md-inline=&quot;link&quot;&gt;&lt;a href=&quot;https://www.rainbond.com/docs/upgrade/5.3.1-upgrade/&quot; data-linktype=&quot;2&quot;&gt;&lt;span md-inline=&quot;plain&quot;&gt;升级参考文档&lt;/span&gt;&lt;/a&gt;&lt;/span&gt;&lt;/p&gt;
                &lt;/div&gt;

                

                



                
                &lt;/div&gt;&lt;/div&gt;</content:encoded>
</item>
<item>
<guid>b6fc16b69240aa4e686207930645dd50</guid>
<title>Hilt 稳定版发布：更便捷的 Android 依赖项注入</title>
<link>https://toutiao.io/k/zxt6igx</link>
<content:encoded>&lt;div&gt;&lt;div&gt;&lt;div class=&quot;RichText ztext Post-RichText&quot;&gt;&lt;p&gt;&lt;b&gt;&lt;a href=&quot;https://link.zhihu.com/?target=https%3A//developer.android.google.cn/training/dependency-injection/hilt-android&quot; class=&quot; wrap external&quot; target=&quot;_blank&quot; rel=&quot;nofollow noreferrer&quot;&gt;Hilt&lt;/a&gt;&lt;/b&gt; 是 Jetpack 推荐使用的 Android 应用 &lt;b&gt;&lt;a href=&quot;https://link.zhihu.com/?target=https%3A//developer.android.google.cn/training/dependency-injection&quot; class=&quot; wrap external&quot; target=&quot;_blank&quot; rel=&quot;nofollow noreferrer&quot;&gt;依赖项注入 (DI)&lt;/a&gt;&lt;/b&gt; 解决方案，现已 &lt;b&gt;稳定&lt;/b&gt;。这意味着 Hilt 已经完全可以在 &lt;b&gt;生产环境&lt;/b&gt; 中使用。Hilt 相比 Dagger 更加便捷，同时也能帮您减少模板代码，它专为 Android 而生，并集成了多个 Jetpack 依赖库。很多公司已在他们的应用中使用了 Hilt 并从中获益。&lt;/p&gt;&lt;p&gt;2020 年 6 月，Hilt &lt;b&gt;&lt;a href=&quot;https://link.zhihu.com/?target=https%3A//medium.com/androiddevelopers/dependency-injection-on-android-with-hilt-67b6031e62d&quot; class=&quot; wrap external&quot; target=&quot;_blank&quot; rel=&quot;nofollow noreferrer&quot;&gt;首次发布&lt;/a&gt;&lt;/b&gt; 预览版，它肩负着定义 Android 依赖项注入 &lt;b&gt;标准方案&lt;/b&gt; 的使命，也是自那时起，我们收到了来自开发者的海量反馈。这些反馈不仅改善了 Hilt，而且使我们明确了我们走在正确的道路上。&lt;/p&gt;&lt;p&gt;Hilt 无需手动创建依赖项关系图，也无需手动注入并传递类型，而是在编译期自动根据注解生成所需代码。Hilt 通过实现工作中的复杂部分以及&lt;b&gt;生成所有模板代码&lt;/b&gt;替代手动编写，帮您&lt;b&gt;从 DI 的最佳实践中获得最大收益&lt;/b&gt;。此外，Hilt 与 Android 完全集成，可以帮助您自动管理 Android Framework 类的依赖项关系图的生命周期。&lt;/p&gt;&lt;p&gt;让我们通过一个简单示例观察 Hilt 的行为！&lt;b&gt;&lt;a href=&quot;https://link.zhihu.com/?target=https%3A//developer.android.google.cn/training/dependency-injection/hilt-android%23setup&quot; class=&quot; wrap external&quot; target=&quot;_blank&quot; rel=&quot;nofollow noreferrer&quot;&gt;配置 Hilt 之后&lt;/a&gt;&lt;/b&gt;，在项目中从无到有地向 Activity 注入ViewModel 就像在代码中添加注解一样容易，如下所示:&lt;/p&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-kotlin&quot;&gt;&lt;span class=&quot;n&quot;&gt;@HiltAndroidApp&lt;/span&gt; &lt;span class=&quot;c1&quot;&gt;// 在应用中配置 Hilt
&lt;/span&gt;&lt;span class=&quot;c1&quot;/&gt;&lt;span class=&quot;k&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;nc&quot;&gt;MyApplication&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Application&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;...&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;c1&quot;&gt;// 使 Hilt 识别该 ViewModel
&lt;/span&gt;&lt;span class=&quot;c1&quot;/&gt;&lt;span class=&quot;n&quot;&gt;@HiltViewModel&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;nc&quot;&gt;LoginViewModel&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;@Inject&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;constructor&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;val&lt;/span&gt; &lt;span class=&quot;py&quot;&gt;savedStateHandle&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;SavedStateHandle&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
    &lt;span class=&quot;cm&quot;&gt;/*…Hilt 关注的其他依赖项... */&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;ViewModel&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;...&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;


&lt;span class=&quot;c1&quot;&gt;// 使该 Activity 使用正确的 ViewModel 工厂，并注入其他依赖项
&lt;/span&gt;&lt;span class=&quot;c1&quot;/&gt;&lt;span class=&quot;n&quot;&gt;@AndroidEntryPoint&lt;/span&gt; 
&lt;span class=&quot;k&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;nc&quot;&gt;LoginActivity&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;AppCompatActivity&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;

    &lt;span class=&quot;k&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;val&lt;/span&gt; &lt;span class=&quot;py&quot;&gt;loginViewModel&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;LoginViewModel&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;by&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;viewModels&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;

    &lt;span class=&quot;k&quot;&gt;override&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;fun&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;onCreate&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;savedInstanceState&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Bundle&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;?)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;k&quot;&gt;super&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;onCreate&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;savedInstanceState&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
        &lt;span class=&quot;c1&quot;&gt;// loginViewModel 已经可以使用
&lt;/span&gt;&lt;span class=&quot;c1&quot;/&gt;    &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;除了上述内容，让您在应用中选择使用 Hilt 还有哪些理由呢？&lt;/p&gt;&lt;h2&gt;&lt;b&gt;比 Dagger 更便捷&lt;/b&gt;&lt;/h2&gt;&lt;p&gt;Hilt 基于流行的 DI 库 &lt;b&gt;&lt;a href=&quot;https://link.zhihu.com/?target=https%3A//developer.android.google.cn/training/dependency-injection/dagger-basics&quot; class=&quot; wrap external&quot; target=&quot;_blank&quot; rel=&quot;nofollow noreferrer&quot;&gt;Dagger&lt;/a&gt;&lt;/b&gt; 构建，因此可以从 Dagger 提供的编译期校验、良好的运行时性能、扩展性以及 &lt;b&gt;&lt;a href=&quot;https://zhuanlan.zhihu.com/p/270185205&quot; class=&quot;internal&quot;&gt;Android Studio 支持&lt;/a&gt;&lt;/b&gt; 中受益。一些 Dagger 注解也常用于 Hilt，例如 @Inject (告知 Dagger/Hilt 如何提供一个类型的实例)。但是 Hilt 要比 Dagger 更便捷。&lt;/p&gt;&lt;blockquote&gt;&lt;i&gt;我强烈推荐利用 Dagger 在 Android 应用中进行依赖项注入，然而单纯地使用 Dagger 可能导致在创建时内存占用过多。当这与 Android 开发中各种复杂的可感知生命周期组件一起使用时，就可能出现很多陷阱，例如内存泄漏: 作用域为 Activity 的依赖项被意外地传递到 ViewModel 中。专为 Android 量身定制的 Hilt 可以帮助您避开 Dagger 基本使用的一些陷阱。&lt;/i&gt;&lt;br/&gt;——Tinder 资深软件工程师 Marcelo Hernandez&lt;/blockquote&gt;&lt;p&gt;如果您已经在应用中使用了 Dagger，并且希望迁移到 Hilt，无需担心！Dagger 和 Hilt 可以共存，应用可以基于需要进行 &lt;b&gt;&lt;a href=&quot;https://link.zhihu.com/?target=https%3A//dagger.dev/hilt/migration-guide&quot; class=&quot; wrap external&quot; target=&quot;_blank&quot; rel=&quot;nofollow noreferrer&quot;&gt;迁移&lt;/a&gt;&lt;/b&gt;。&lt;/p&gt;&lt;h2&gt;&lt;b&gt;更少的模板代码&lt;/b&gt;&lt;/h2&gt;&lt;p&gt;Hilt 是被定制过的——这意味着为了减少您编写代码，它替您做了一些决定。Hilt 定义了标准组件及依赖关系图，并且完全集成了 Android Framework 中的类，例如: Application、Activity、Fragment、View，还定义了限制类型实例的作用域到这些组件的作用域注解。&lt;/p&gt;&lt;blockquote&gt;&lt;i&gt;通过 @HiltAndroidTest 注解，Hilt 可以自动生成测试应用以及测试组件。迁移到 Hilt 之后，我们可以删除 20% - 40% 的测试相关模板代码。&lt;/i&gt;&lt;br/&gt;——YouTube 软件工程师 Jusun Lee&lt;br/&gt;&lt;i&gt;我们仅是在 Hilt 迁移上做了浅层工作。然而，我们在其中一个迁移到 Hilt 的模块，看到了代码行数 +72/-182 的变化。&lt;/i&gt;&lt;br/&gt;——Tinder 资深软件工程师 Marcelo Hernandez&lt;/blockquote&gt;&lt;h2&gt;&lt;b&gt;为 Android 量身定制&lt;/b&gt;&lt;/h2&gt;&lt;p&gt;不同于 Java 编程语言应用的依赖项注入解决方案 Dagger，Hilt 仅支持 Android 应用。一些注解专供 Hilt 使用，并定义了专有的 Android DI 方式，这些注解包括: &lt;code&gt;@HiltAndroidApp&lt;/code&gt;、&lt;code&gt;@AndroidEntryPoint&lt;/code&gt;、&lt;code&gt;@HiltViewModel&lt;/code&gt;。&lt;/p&gt;&lt;blockquote&gt;&lt;i&gt;最终，Hilt 提供了内置的可识别 Android 生命周期的 Dagger 组件。使用 Hilt，我们可以只关注 Dagger @Modules，而不必担心组件，子组件以及组件提供程序的模式等。&lt;/i&gt;&lt;br/&gt;—— Tinder 资深软件工程师 Marcelo Hernandez&lt;/blockquote&gt;&lt;h2&gt;&lt;b&gt;组件及绑定的标准化&lt;/b&gt;&lt;/h2&gt;&lt;p&gt;不同于对 Dagger 的认识，Hilt 采用了 &lt;b&gt;&lt;a href=&quot;https://link.zhihu.com/?target=https%3A//dagger.dev/hilt/monolithic&quot; class=&quot; wrap external&quot; target=&quot;_blank&quot; rel=&quot;nofollow noreferrer&quot;&gt;单组件系统&lt;/a&gt;&lt;/b&gt; 来简化依赖项关系图，使编译期生成更少的代码。&lt;/p&gt;&lt;blockquote&gt;&lt;i&gt;通过 Hilt 的单组件系统，仅一次提供绑定定义，就可以在所有使用该组件的类中共享。这比之前有着很大的提升，YouTube 曾使用多组件系统，模块需要手动连接到自定义组件中，并且存在很多重复的绑定定义。&lt;/i&gt;&lt;br/&gt;——YouTube 软件工程师 Jusun Lee&lt;br/&gt;&lt;i&gt;由于我们的 Gradle 模块分离允许隔离开发功能，这使得我们使用 Dagger 时容易过于灵活。我们发现，将这些模块迁移到 Hilt 暴露出我们无意间违反了关注点分离的缺陷。&lt;/i&gt;&lt;br/&gt;——Tinder 资深软件开发工程师 Marcelo Hernandez&lt;/blockquote&gt;&lt;h2&gt;&lt;b&gt;集成其他 Jetpack 库&lt;/b&gt;&lt;/h2&gt;&lt;p&gt;您可以在开箱即用的情况下使用喜欢的 Jetpack 库。到目前为止，我们为 &lt;b&gt;ViewModel&lt;/b&gt;、&lt;b&gt;WorkManager&lt;/b&gt;、&lt;b&gt;Navigation&lt;/b&gt; 和 &lt;b&gt;Compose&lt;/b&gt; 提供直接注入支持。&lt;/p&gt;&lt;p&gt;参阅 &lt;b&gt;&lt;a href=&quot;https://link.zhihu.com/?target=https%3A//developer.android.google.cn/training/dependency-injection/hilt-jetpack&quot; class=&quot; wrap external&quot; target=&quot;_blank&quot; rel=&quot;nofollow noreferrer&quot;&gt;文档&lt;/a&gt;&lt;/b&gt;，了解更多关于 Jetpack 的支持。&lt;/p&gt;&lt;blockquote&gt;&lt;i&gt;我非常感激 Hilt 与 ViewModel 一起开箱即用的使用方式，以及它消除单纯使用 Dagger 时必须设置的 ViewModel.Factory 模板代码的方式。&lt;/i&gt;&lt;br/&gt;——Tinder 资深软件开发工程师 Marcelo Hernandez&lt;/blockquote&gt;&lt;h2&gt;&lt;b&gt;Hilt 学习资源&lt;/b&gt;&lt;/h2&gt;&lt;p&gt;Hilt 是 Jetpack 推荐的 Android 应用 DI 解决方案。想要了解更多并开始在您的应用中使用，请参阅如下资源:&lt;/p&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;</content:encoded>
</item>
<item>
<guid>c6fbea10968735896e3aa18d904f3569</guid>
<title>Google Play 推行 aab：对升级 App、渠道打包、分包的影响</title>
<link>https://toutiao.io/k/7fz6tx5</link>
<content:encoded>&lt;div&gt;&lt;div&gt;&lt;div class=&quot;rich_media_content &quot; id=&quot;js_content&quot;&gt;
                    

                    
                    
                    
                    &lt;p data-mpa-powered-by=&quot;yiban.io&quot;&gt;&lt;span&gt;&lt;strong&gt;&lt;span&gt;一、什么是aab？aab如何在google上安装&lt;/span&gt;&lt;/strong&gt;&lt;/span&gt;&lt;span/&gt;&lt;/p&gt;&lt;ul class=&quot;list-paddingleft-2&quot;&gt;&lt;li&gt;&lt;p&gt;&lt;span&gt; aab是Android App Bundle缩写;&lt;/span&gt;&lt;/p&gt;&lt;/li&gt;&lt;li&gt;&lt;p data-tools-id=&quot;94975&quot;&gt;&lt;span&gt; &lt;span&gt;Google Play&lt;/span&gt;上一种新的上传格式，以前是传apk,现在可以传Bundle;&lt;/span&gt;&lt;/p&gt;&lt;/li&gt;&lt;li&gt;&lt;p&gt;&lt;span&gt;Google Play 会使用您的 App Bundle 针对每种设备配置生成并提供经过优化的 APK，因此只会下载特定设备所需的代码和资源来运行您的应用;&lt;/span&gt;您不必再构建、签署和管理多个 APK 来优化对不同设备的支持，而用户也可以获得更小且更优化的下载文件包。&lt;/p&gt;&lt;/li&gt;&lt;/ul&gt;&lt;p&gt;&lt;strong&gt;&lt;span&gt;aab限制&lt;/span&gt;&lt;/strong&gt;&lt;span/&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;&lt;strong&gt;&lt;span&gt;二、aab怎么打包，怎么测试&lt;/span&gt;&lt;/strong&gt;&lt;/span&gt;&lt;span/&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;之前发过一篇文章详细的可以看&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;img class=&quot;rich_pages js_insertlocalimg&quot; data-ratio=&quot;0.7588325652841782&quot; data-s=&quot;300,640&quot; data-src=&quot;https://mmbiz.qpic.cn/mmbiz_jpg/kyDL16ViavhH3SUZxG6AMkmv1rwBXdWZZD3rEr8zKDIoIHy2IlqOSxEWsOibX4hvahrlqBnn5eDiaY2MOV3cugBwQ/640?wx_fmt=jpeg&quot; data-type=&quot;jpeg&quot; data-w=&quot;651&quot;/&gt;&lt;/p&gt;&lt;blockquote class=&quot;js_blockquote_wrap&quot; data-type=&quot;1&quot; data-url=&quot;http://mp.weixin.qq.com/s?__biz=Mzk0NDE3MjM1Ng==&amp;amp;mid=2247483935&amp;amp;idx=1&amp;amp;sn=da4a96dba5dd0897c398ffc4ba302a6b&amp;amp;chksm=c329fe34f45e772238a3a4044a2fbfa432395b1b889f7e09cf8abecbb575ebc73af6beb8a31f#rd&quot; data-author-name=&quot;Android开发编程&quot; data-content-utf8-length=&quot;13&quot; data-source-title=&quot;GooglePlay为何强推Appbundle？一起来一探究竟&quot;&gt;&lt;section class=&quot;js_blockquote_digest&quot;&gt;&lt;p&gt;aab开发、aab测试脚本&lt;/p&gt;&lt;/section&gt;&lt;section class=&quot;blockquote_info js_blockquote_source&quot; data-json=&quot;%7B%22type%22%3A%22inner%22%2C%22source%22%3A%22biz%22%2C%22digest%22%3A%22%3Cp%3Eaab%E5%BC%80%E5%8F%91%E3%80%81aab%E6%B5%8B%E8%AF%95%E8%84%9A%E6%9C%AC%3C%2Fp%3E%22%2C%22digestLen%22%3A13%2C%22text%22%3A%22%22%2C%22article%22%3A%7B%22title%22%3A%22GooglePlay%E4%B8%BA%E4%BD%95%E5%BC%BA%E6%8E%A8Appbundle%EF%BC%9F%E4%B8%80%E8%B5%B7%E6%9D%A5%E4%B8%80%E6%8E%A2%E7%A9%B6%E7%AB%9F%22%2C%22url%22%3A%22http%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzk0NDE3MjM1Ng%3D%3D%26mid%3D2247483935%26idx%3D1%26sn%3Dda4a96dba5dd0897c398ffc4ba302a6b%26chksm%3Dc329fe34f45e772238a3a4044a2fbfa432395b1b889f7e09cf8abecbb575ebc73af6beb8a31f%23rd%22%2C%22nickname%22%3A%22Android%E5%BC%80%E5%8F%91%E7%BC%96%E7%A8%8B%22%2C%22authorName%22%3A%22Android%E5%BC%80%E5%8F%91%E7%BC%96%E7%A8%8B%22%7D%2C%22hasReportOverSize%22%3Afalse%2C%22editorReportData%22%3A%5B%7B%22id%22%3A%22122333%22%2C%22key%22%3A%2278%22%2C%22len%22%3A1%7D%5D%7D&quot;&gt;&lt;span class=&quot;blockquote_biz&quot;&gt;Android开发编程，公众号：Android开发编程&lt;a href=&quot;http://mp.weixin.qq.com/s?__biz=Mzk0NDE3MjM1Ng==&amp;amp;mid=2247483935&amp;amp;idx=1&amp;amp;sn=da4a96dba5dd0897c398ffc4ba302a6b&amp;amp;chksm=c329fe34f45e772238a3a4044a2fbfa432395b1b889f7e09cf8abecbb575ebc73af6beb8a31f#rd&quot; class=&quot;blockquote_article&quot;&gt;GooglePlay为何强推Appbundle？一起来一探究竟&lt;/a&gt;&lt;/span&gt;&lt;/section&gt;&lt;/blockquote&gt;&lt;p&gt;&lt;span&gt;&lt;strong&gt;&lt;span&gt;三、aab升级有什么影响&lt;/span&gt;&lt;/strong&gt;&lt;/span&gt;&lt;span/&gt;&lt;/p&gt;&lt;p&gt;&lt;strong&gt;&lt;span&gt;1、用googleplay商店内升级&lt;/span&gt;&lt;/strong&gt;&lt;span/&gt;&lt;/p&gt;&lt;p&gt;&lt;strong&gt;&lt;span&gt;2、应用内升级&lt;/span&gt;&lt;/strong&gt;&lt;span/&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;   &lt;em&gt;&lt;strong&gt;应用内升级只能下载apk，不要下载aab---重点&lt;/strong&gt;&lt;/em&gt;&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;  ①用户从googleplay商店aab下载包，通过本地下载apk升级到最新版本，没问题的；&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;  ②用户用apk安装，通过googleplay升级，这个也是可以的；只要签名没问题，版本号没问题就可以的；   &lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;&lt;strong&gt;&lt;span&gt;四、app渠道和分包影响&lt;/span&gt;&lt;/strong&gt;&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;strong&gt;&lt;span&gt;1、不走googleplay商店，直接上第三方市场：&lt;/span&gt;&lt;/strong&gt;&lt;span/&gt;&lt;/p&gt;&lt;ul class=&quot;list-paddingleft-2&quot;&gt;&lt;li&gt;&lt;p&gt;&lt;span&gt;打包还是apk，不要aar；&lt;/span&gt;&lt;/p&gt;&lt;/li&gt;&lt;li&gt;&lt;p&gt;渠道直接打到包里就可以了；&lt;/p&gt;&lt;/li&gt;&lt;li&gt;&lt;p&gt;签名要和aab一样，不要乱用不同的签名；&lt;/p&gt;&lt;/li&gt;&lt;li&gt;&lt;p&gt;  版本号要正确&lt;/p&gt;&lt;/li&gt;&lt;/ul&gt;&lt;p&gt;&lt;strong&gt;&lt;span&gt;2、只上googleplay&lt;/span&gt;&lt;/strong&gt;&lt;span/&gt;&lt;/p&gt;&lt;ul class=&quot;list-paddingleft-2&quot;&gt;&lt;li&gt;&lt;p&gt;&lt;span&gt;用第三方比如appsFlyer、Adjust获取渠道&lt;/span&gt;&lt;/p&gt;&lt;/li&gt;&lt;li&gt;&lt;p&gt;&lt;span&gt;用谷歌提供的方法自己解析：Install Referrer API，&lt;/span&gt;&lt;span&gt;  点击带有referrer的链接（形如http://xxxx&amp;amp;referrer=test%3Dtest111）跳转到Google Play后，Google Play会记录(Capture)附带的参数，下载安装后（经测试，必须从Play商店点击下载并安装才可行），&lt;/span&gt;&lt;span&gt;首次打开APP时，Gooogle Play会将参数给APP&lt;/span&gt;&lt;/p&gt;&lt;/li&gt;&lt;/ul&gt;&lt;section class=&quot;code-snippet__fix code-snippet__js&quot;&gt;&lt;pre class=&quot;code-snippet__js&quot; data-lang=&quot;java&quot;&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;      dependencies {&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;        ...&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;        implementation &lt;span class=&quot;code-snippet__string&quot;&gt;&#x27;com.android.installreferrer:installreferrer:1.0&#x27;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;    }     &lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;            &lt;span class=&quot;code-snippet__keyword&quot;&gt;try&lt;/span&gt; {&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;            &lt;span class=&quot;code-snippet__keyword&quot;&gt;final&lt;/span&gt; InstallReferrerClient installReferrerClient = InstallReferrerClient.newBuilder(context).build();&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;            installReferrerClient.startConnection(&lt;span class=&quot;code-snippet__keyword&quot;&gt;new&lt;/span&gt; InstallReferrerStateListener() {&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;                &lt;span class=&quot;code-snippet__meta&quot;&gt;@Override&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;                &lt;span class=&quot;code-snippet__function&quot;&gt;&lt;span class=&quot;code-snippet__keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-snippet__keyword&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;code-snippet__title&quot;&gt;onInstallReferrerSetupFinished&lt;/span&gt;&lt;span class=&quot;code-snippet__params&quot;&gt;(&lt;span class=&quot;code-snippet__keyword&quot;&gt;int&lt;/span&gt; responseCode)&lt;/span&gt; &lt;/span&gt;{&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;                    &lt;span class=&quot;code-snippet__keyword&quot;&gt;switch&lt;/span&gt; (responseCode) {&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;                        &lt;span class=&quot;code-snippet__keyword&quot;&gt;case&lt;/span&gt; InstallReferrerClient.InstallReferrerResponse.OK:&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;                            &lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;                            &lt;span class=&quot;code-snippet__keyword&quot;&gt;if&lt;/span&gt; (installReferrerClient != &lt;span class=&quot;code-snippet__keyword&quot;&gt;null&lt;/span&gt;) {&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;                                &lt;span class=&quot;code-snippet__keyword&quot;&gt;try&lt;/span&gt; {&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;                                    ReferrerDetails response = installReferrerClient.getInstallReferrer();&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;                                    String referrer = response.getInstallReferrer();&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;                                    &lt;span class=&quot;code-snippet__keyword&quot;&gt;if&lt;/span&gt; (!TextUtils.isEmpty(referrer)) {&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;                                    }&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;                                    installReferrerClient.endConnection();&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;                                } &lt;span class=&quot;code-snippet__keyword&quot;&gt;catch&lt;/span&gt; (Exception ex) {&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;                                    Log.e(&lt;span class=&quot;code-snippet__string&quot;&gt;&quot;InstallReferrerHelper&quot;&lt;/span&gt;, ex.toString());&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;                                }&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;                            }&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;                            &lt;span class=&quot;code-snippet__keyword&quot;&gt;break&lt;/span&gt;;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;                        &lt;span class=&quot;code-snippet__keyword&quot;&gt;case&lt;/span&gt; InstallReferrerClient.InstallReferrerResponse.FEATURE_NOT_SUPPORTED:&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;                            &lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;                            Log.d(&lt;span class=&quot;code-snippet__string&quot;&gt;&quot;InstallReferrerHelper&quot;&lt;/span&gt;, &lt;span class=&quot;code-snippet__string&quot;&gt;&quot;FEATURE_NOT_SUPPORTED&quot;&lt;/span&gt;);&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;                            &lt;span class=&quot;code-snippet__keyword&quot;&gt;break&lt;/span&gt;;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;                        &lt;span class=&quot;code-snippet__keyword&quot;&gt;case&lt;/span&gt; InstallReferrerClient.InstallReferrerResponse.SERVICE_UNAVAILABLE:&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;                            &lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;                            Log.d(&lt;span class=&quot;code-snippet__string&quot;&gt;&quot;InstallReferrerHelper&quot;&lt;/span&gt;, &lt;span class=&quot;code-snippet__string&quot;&gt;&quot;SERVICE_UNAVAILABLE&quot;&lt;/span&gt;);&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;                            &lt;span class=&quot;code-snippet__keyword&quot;&gt;break&lt;/span&gt;;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;                    }&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;                }&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;                &lt;span class=&quot;code-snippet__meta&quot;&gt;@Override&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;                &lt;span class=&quot;code-snippet__function&quot;&gt;&lt;span class=&quot;code-snippet__keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-snippet__keyword&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;code-snippet__title&quot;&gt;onInstallReferrerServiceDisconnected&lt;/span&gt;&lt;span class=&quot;code-snippet__params&quot;&gt;()&lt;/span&gt; &lt;/span&gt;{&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;                    &lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;                    &lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;                }&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;            });&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;        } &lt;span class=&quot;code-snippet__keyword&quot;&gt;catch&lt;/span&gt; (Exception ex) {&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;            Log.e(&lt;span class=&quot;code-snippet__string&quot;&gt;&quot;InstallReferrerHelper&quot;&lt;/span&gt;, ex.toString());&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;        }&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/section&gt;&lt;p&gt;&lt;strong&gt;&lt;span&gt; 3、aab对分包的影响&lt;/span&gt;&lt;/strong&gt;&lt;span/&gt;&lt;/p&gt;&lt;p&gt;&lt;/p&gt;&lt;section class=&quot;code-snippet__fix code-snippet__js&quot;&gt;&lt;pre class=&quot;code-snippet__js&quot; data-lang=&quot;javascript&quot;&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;  bundle {&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;        language {&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;            &lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;            &lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;            &lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;            &lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;            enableSplit = &lt;span class=&quot;code-snippet__literal&quot;&gt;false&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;        }&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;        density {&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;            &lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;            enableSplit = &lt;span class=&quot;code-snippet__literal&quot;&gt;true&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;        }&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;        abi {&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;            &lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;            enableSplit = &lt;span class=&quot;code-snippet__literal&quot;&gt;true&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;        }&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;    }&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;language 语言&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;abi  so包 &lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;density  资源包：比如图片&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;enableSplit &lt;span class=&quot;code-snippet__literal&quot;&gt;true&lt;/span&gt;开启 &lt;span class=&quot;code-snippet__literal&quot;&gt;false&lt;/span&gt; 关闭&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/section&gt;&lt;p&gt;&lt;strong&gt;&lt;span&gt;总结：&lt;/span&gt;&lt;/strong&gt;&lt;/p&gt;&lt;p&gt;&lt;strong&gt;&lt;span&gt;1、aab打包一定要测试，测试脚本在公众号里可以获取 &lt;/span&gt;&lt;/strong&gt;&lt;/p&gt;&lt;p&gt;&lt;strong&gt;&lt;span&gt;2、在googleplay后台要上传签名，这个一定要小心小心在小心，不然传错了很麻烦的&lt;/span&gt;&lt;/strong&gt;&lt;/p&gt;&lt;p&gt;&lt;strong&gt;&lt;span&gt;3、关于aab的细节还有很多，有问题了直接发信息&lt;/span&gt;&lt;/strong&gt;&lt;span/&gt;&lt;/p&gt;&lt;section class=&quot;mp_profile_iframe_wrp&quot;&gt;&lt;mpprofile class=&quot;js_uneditable custom_select_card mp_profile_iframe&quot; data-pluginname=&quot;mpprofile&quot; data-id=&quot;Mzk0NDE3MjM1Ng==&quot; data-headimg=&quot;http://mmbiz.qpic.cn/mmbiz_png/kyDL16ViavhFRZkgpibUGGz2NIiaBUpj7NeBSJASje1M1ZhVvpDIGibicMUeCiad3ptsJLaLUjhrVYs5bGZWuenY6UaQ/0?wx_fmt=png&quot; data-nickname=&quot;Android开发编程&quot; data-alias=&quot;&quot; data-signature=&quot;一个有10多年经验开发的android、java、前端等语言的老程序员，在这里一起聊聊技术，一起聊聊生活、一起聊聊中年危机的生存之道，一起进步一起加油，感兴趣的欢迎订阅；不定时的更新。&quot; data-from=&quot;0&quot;/&gt;&lt;/section&gt;
                &lt;/div&gt;

                

                



                
                &lt;div class=&quot;reward_qrcode_area reward_area tc&quot; id=&quot;js_reward_qrcode&quot;&gt;
                                &lt;p class=&quot;tips_global&quot;&gt;Long-press QR code to transfer me a reward&lt;/p&gt;
                                                                &lt;p class=&quot;reward_tips&quot;/&gt;
                                &lt;span class=&quot;reward_qrcode_img_wrp&quot;&gt;&lt;img class=&quot;reward_qrcode_img&quot; id=&quot;js_reward_qrcode_img&quot;/&gt;&lt;/span&gt;
                                &lt;p class=&quot;tips_global&quot;&gt;As required by Apple&#x27;s new policy, the Reward feature has been disabled on Weixin for iOS. You can still reward an Official Account by transferring money via QR code.&lt;/p&gt;
                            &lt;/div&gt;
                                                                            
                              
            &lt;/div&gt;&lt;/div&gt;</content:encoded>
</item>
</channel></rss>