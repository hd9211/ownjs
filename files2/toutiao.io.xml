<?xml version="1.0" encoding="UTF-8"?>
        <rss version="2.0" xmlns:content="http://purl.org/rss/1.0/modules/content/">
            <channel>
            <title>开发者头条</title>
            <link>http://toutiao.io/</link>
            <description></description>
<item>
<guid>063b1beb0dbd8605e7147992b1675bb2</guid>
<title>值得拥有的手绘风格画图工具</title>
<link>https://toutiao.io/k/ukg83qx</link>
<content:encoded>&lt;div&gt;&lt;div&gt;&lt;div class=&quot;rich_media_content &quot; id=&quot;js_content&quot;&gt;
                    

                    
                    
                    
                    &lt;section data-tool=&quot;mdnice编辑器&quot; data-website=&quot;https://www.mdnice.com&quot;&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;一直在找一款手绘风格的画图工具，好的图表总能传递更多的信息。最初用微软 Visio 工具画图，但依赖于安装软件，无法轻量级使用，效果也有些僵硬，后来改用 ProcessOn 在线画图，免费版有数量限制。后面使用 Draw.io，可以做为Chrome 插件使用，总算有点手绘的意思。这次偶然碰巧看到ExcaliDraw，手绘的效果让人眼前一亮，就它了。&lt;/p&gt;&lt;blockquote&gt;&lt;p&gt;官网地址：https://excalidraw.com/&lt;/p&gt;&lt;/blockquote&gt;&lt;p&gt;&lt;img class=&quot;rich_pages js_insertlocalimg&quot; data-ratio=&quot;0.37037037037037035&quot; data-s=&quot;300,640&quot; data-src=&quot;https://mmbiz.qpic.cn/sz_mmbiz_png/EwukgicNDWBtggYTuxXgJgLXvUqnqmplZAJCjhN5ZEOJHFYnu7zHfRL5alN0Ycp4cQ7eKia0jeRHCMXwJ5Qrcvicw/640?wx_fmt=png&quot; data-type=&quot;png&quot; data-w=&quot;1080&quot;/&gt;&lt;/p&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;开源、免费、简单易用，还可以本地部署，在App中嵌入使用，看两个效果图：&lt;/p&gt;&lt;p&gt;&lt;img class=&quot;rich_pages js_insertlocalimg&quot; data-ratio=&quot;0.8609375&quot; data-s=&quot;300,640&quot; data-src=&quot;https://mmbiz.qpic.cn/sz_mmbiz_jpg/EwukgicNDWBtggYTuxXgJgLXvUqnqmplZibRRkACuqTAmRTGORNAHjSyL9Ew1QjIEwbiarxUj074wGiac9gzGFsIcw/640?wx_fmt=jpeg&quot; data-type=&quot;jpeg&quot; data-w=&quot;1280&quot;/&gt;&lt;/p&gt;&lt;p&gt;&lt;img class=&quot;rich_pages js_insertlocalimg&quot; data-ratio=&quot;0.8&quot; data-s=&quot;300,640&quot; data-src=&quot;https://mmbiz.qpic.cn/sz_mmbiz_jpg/EwukgicNDWBtggYTuxXgJgLXvUqnqmplZZky3zQYEMBKZBCIB4xWNbeMF40IebPQL7tDJmXoAm8hWQLshWpEVIQ/640?wx_fmt=jpeg&quot; data-type=&quot;jpeg&quot; data-w=&quot;1280&quot;/&gt;&lt;/p&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;怎么使用？打开浏览器，输入网址：&lt;strong&gt;&lt;span&gt;https://excalidraw.com/&lt;/span&gt;&lt;/strong&gt;，简洁的菜单、按钮，相信你操作两步就知晓如何使用了，不管是架构图、流程图、还是部署图、时序图，统统搞定。&lt;/p&gt;&lt;p&gt;&lt;span&gt;图标库太少了？别急，有丰富的图纸资产库可以轻松添加到控制台，快速帮你搞定很多意想不到的图标组件，让你的图表显&lt;/span&gt;得&lt;span&gt;个性有加。&lt;/span&gt;&lt;/p&gt;&lt;blockquote&gt;&lt;p&gt;&lt;span&gt;https://libraries.excalidraw.com/?sort=default&lt;/span&gt;&lt;/p&gt;&lt;/blockquote&gt;&lt;p&gt;&lt;img class=&quot;rich_pages js_insertlocalimg&quot; data-ratio=&quot;0.9089026915113871&quot; data-s=&quot;300,640&quot; data-src=&quot;https://mmbiz.qpic.cn/sz_mmbiz_jpg/EwukgicNDWBtggYTuxXgJgLXvUqnqmplZk48HcqndpVKeu5fUMUk132zEeHSLcKNkPKaMXCN7oEZh7cmatuZkiaQ/640?wx_fmt=jpeg&quot; data-type=&quot;jpeg&quot; data-w=&quot;966&quot;/&gt;&lt;/p&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;现在就开始你的草图风绘图之旅。&lt;/p&gt;&lt;section&gt;&lt;img class=&quot;rich_pages __bg_gif&quot; data-ratio=&quot;0.18524332810047095&quot; data-type=&quot;gif&quot; data-w=&quot;637&quot; data-src=&quot;https://mmbiz.qpic.cn/mmbiz_gif/pia7eNKm5ribqUytKORCNqLeBt05FGia804Dvp5iaPybs893QB9yC6sM0KuFeJmoYEhBmicSQkJ5vU6aIpKZhyMOeEA/640?wx_fmt=gif&quot;/&gt;&lt;/section&gt;&lt;section class=&quot;mp_profile_iframe_wrp&quot;&gt;&lt;mpprofile class=&quot;js_uneditable custom_select_card mp_profile_iframe&quot; data-pluginname=&quot;mpprofile&quot; data-id=&quot;MzIwMjE3MDIwMA==&quot; data-headimg=&quot;http://mmbiz.qpic.cn/mmbiz_png/EwukgicNDWBswFxJHbKiad1jnJCFQiaWQrRnSdQGnrHiaicTyc2FR4CId2GQk1TABicoY87kQIeoeI1z3GnwanWMg1YQ/0?wx_fmt=png&quot; data-nickname=&quot;MavenTalk&quot; data-alias=&quot;mavenTalk&quot; data-signature=&quot;传说中的大龄程序员！&quot;/&gt;&lt;/section&gt;&lt;/section&gt;
                &lt;/div&gt;

                

                



                
                &lt;/div&gt;&lt;/div&gt;</content:encoded>
</item>
<item>
<guid>0f2bd7c6e7536f9376510ecf54cd7c16</guid>
<title>漫画 Go 语言 Defer 机制及妙用</title>
<link>https://toutiao.io/k/9q7xgh3</link>
<content:encoded>&lt;div&gt;&lt;div&gt;&lt;div class=&quot;rich_media_content &quot; id=&quot;js_content&quot;&gt;
                    

                    
                    
                    
                    &lt;p&gt;&lt;span data-offset-key=&quot;dh52o-0-0&quot;&gt;赖思与甜甜，有趣有料有温度，技术学习有思路！&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;span data-offset-key=&quot;cir98-0-0&quot;&gt;Go语言的defer机制除了错误处理，更多的是处理资源关闭。看看赖思还给甜甜讲解了哪些Defer的妙用呢？&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;/p&gt;&lt;figure data-block=&quot;true&quot; data-editor=&quot;an97u&quot; data-offset-key=&quot;e56ff-0-0&quot;&gt;&lt;p&gt;&lt;img data-ratio=&quot;0.5625&quot; data-src=&quot;https://mmbiz.qpic.cn/mmbiz_jpg/pafDRXbWF0SeJjtgSgvsDs7DuEMBYHLAkaQFGeEHPlnic4qQhMLB54GqCur1TN1lqBia9n70WBjN7Ea4nHovAnHQ/640?wx_fmt=jpeg&quot; data-type=&quot;jpeg&quot; data-w=&quot;1440&quot;/&gt;&lt;/p&gt;&lt;/figure&gt;&lt;p&gt;&lt;/p&gt;&lt;pre data-offset-key=&quot;38e8g-0-0&quot;&gt;&lt;pre data-block=&quot;true&quot; data-editor=&quot;an97u&quot; data-offset-key=&quot;38e8g-0-0&quot;&gt;&lt;div data-offset-key=&quot;38e8g-0-0&quot;&gt;&lt;span&gt;&lt;span data-offset-key=&quot;38e8g-0-0&quot;&gt;&lt;span data-text=&quot;true&quot;/&gt;&lt;/span&gt;&lt;/span&gt;&lt;section class=&quot;code-snippet__fix code-snippet__js&quot;&gt;&lt;pre class=&quot;code-snippet__js&quot; data-lang=&quot;go&quot;&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span class=&quot;code-snippet__keyword&quot;&gt;var&lt;/span&gt; mu sync.Mutex&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span class=&quot;code-snippet__keyword&quot;&gt;var&lt;/span&gt; fb []&lt;span class=&quot;code-snippet__keyword&quot;&gt;byte&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span class=&quot;code-snippet__function&quot;&gt;&lt;span class=&quot;code-snippet__keyword&quot;&gt;func&lt;/span&gt; &lt;span class=&quot;code-snippet__title&quot;&gt;ReadFile&lt;/span&gt;&lt;span class=&quot;code-snippet__params&quot;&gt;(filename &lt;span class=&quot;code-snippet__keyword&quot;&gt;string&lt;/span&gt;)&lt;/span&gt; &lt;span class=&quot;code-snippet__params&quot;&gt;([]&lt;span class=&quot;code-snippet__keyword&quot;&gt;byte&lt;/span&gt;, error)&lt;/span&gt;&lt;/span&gt; {&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;    f, err := os.Open(filename)&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;    &lt;span class=&quot;code-snippet__keyword&quot;&gt;if&lt;/span&gt; err != &lt;span class=&quot;code-snippet__literal&quot;&gt;nil&lt;/span&gt; {&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;        &lt;span class=&quot;code-snippet__keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-snippet__literal&quot;&gt;nil&lt;/span&gt;, err&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;    }&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;    &lt;span class=&quot;code-snippet__keyword&quot;&gt;defer&lt;/span&gt; f.Close()&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;    mu.Lock()&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;    &lt;span class=&quot;code-snippet__keyword&quot;&gt;defer&lt;/span&gt; mu.Unlock()&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;    fb = ReadAll(f)&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;    &lt;span class=&quot;code-snippet__keyword&quot;&gt;return&lt;/span&gt; fb&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/section&gt;&lt;span&gt;&lt;span data-offset-key=&quot;38e8g-82-0&quot;&gt;&lt;span data-text=&quot;true&quot;/&gt;&lt;/span&gt;&lt;/span&gt;&lt;/div&gt;&lt;/pre&gt;&lt;/pre&gt;&lt;p&gt;&lt;/p&gt;&lt;figure data-block=&quot;true&quot; data-editor=&quot;an97u&quot; data-offset-key=&quot;e47uj-0-0&quot;&gt;&lt;p&gt;&lt;img data-ratio=&quot;0.5625&quot; data-src=&quot;https://mmbiz.qpic.cn/mmbiz_jpg/pafDRXbWF0SeJjtgSgvsDs7DuEMBYHLA7r7pJKorT0ULBlTian78WYzWrbBVrO9jEibjan3MOGZyNRtPuk6ibdxEQ/640?wx_fmt=jpeg&quot; data-type=&quot;jpeg&quot; data-w=&quot;1440&quot;/&gt;&lt;/p&gt;&lt;/figure&gt;&lt;figure data-block=&quot;true&quot; data-editor=&quot;an97u&quot; data-offset-key=&quot;5t9vm-0-0&quot;&gt;&lt;p&gt;&lt;img data-ratio=&quot;0.5625&quot; data-src=&quot;https://mmbiz.qpic.cn/mmbiz_jpg/pafDRXbWF0SeJjtgSgvsDs7DuEMBYHLAXAv7uSCMD5M7sJrGf3TH3qgJqhKfukdD34mQvLPCzpAjqHBort0dog/640?wx_fmt=jpeg&quot; data-type=&quot;jpeg&quot; data-w=&quot;1440&quot;/&gt;&lt;/p&gt;&lt;/figure&gt;&lt;p&gt;&lt;/p&gt;&lt;pre data-offset-key=&quot;rger-0-0&quot;&gt;&lt;pre data-block=&quot;true&quot; data-editor=&quot;an97u&quot; data-offset-key=&quot;rger-0-0&quot;&gt;&lt;div data-offset-key=&quot;rger-0-0&quot;&gt;&lt;span&gt;&lt;span data-offset-key=&quot;rger-0-0&quot;&gt;&lt;span data-text=&quot;true&quot;/&gt;&lt;/span&gt;&lt;/span&gt;&lt;section class=&quot;code-snippet__fix code-snippet__js&quot;&gt;&lt;pre class=&quot;code-snippet__js&quot; data-lang=&quot;go&quot;&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span class=&quot;code-snippet__keyword&quot;&gt;for&lt;/span&gt; _, filename := &lt;span class=&quot;code-snippet__keyword&quot;&gt;range&lt;/span&gt; filenames {&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;    f, err := os.Open(filename)&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;    &lt;span class=&quot;code-snippet__keyword&quot;&gt;if&lt;/span&gt; err != &lt;span class=&quot;code-snippet__literal&quot;&gt;nil&lt;/span&gt; {&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;        &lt;span class=&quot;code-snippet__keyword&quot;&gt;return&lt;/span&gt; err&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;    }&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;    &lt;span class=&quot;code-snippet__keyword&quot;&gt;defer&lt;/span&gt; f.Close() &lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/section&gt;&lt;span&gt;&lt;span data-offset-key=&quot;rger-40-0&quot;&gt;&lt;span data-text=&quot;true&quot;/&gt;&lt;/span&gt;&lt;/span&gt;&lt;/div&gt;&lt;/pre&gt;&lt;/pre&gt;&lt;p&gt;&lt;span data-offset-key=&quot;17lvp-0-0&quot;&gt;&lt;span data-text=&quot;true&quot;&gt;关于defer使用时还需要注意的是：&lt;/span&gt;&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;span data-offset-key=&quot;em1r2-0-0&quot;&gt;&lt;span data-text=&quot;true&quot;&gt;1. 当执行到defer语句时，其后函数的参数会被计算然后封装“压栈”，当defer被触发时，将所有“压栈”的方法“出栈”并执行;&lt;/span&gt;&lt;/span&gt;&lt;/p&gt;&lt;pre data-offset-key=&quot;4jdnr-0-0&quot;&gt;&lt;pre data-block=&quot;true&quot; data-editor=&quot;an97u&quot; data-offset-key=&quot;4jdnr-0-0&quot;&gt;&lt;div data-offset-key=&quot;4jdnr-0-0&quot;&gt;&lt;span&gt;&lt;span data-offset-key=&quot;4jdnr-0-0&quot;&gt;&lt;span data-text=&quot;true&quot;/&gt;&lt;/span&gt;&lt;/span&gt;&lt;section class=&quot;code-snippet__fix code-snippet__js&quot;&gt;&lt;pre class=&quot;code-snippet__js&quot; data-lang=&quot;go&quot;&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span class=&quot;code-snippet__function&quot;&gt;&lt;span class=&quot;code-snippet__keyword&quot;&gt;func&lt;/span&gt; &lt;span class=&quot;code-snippet__title&quot;&gt;main&lt;/span&gt;&lt;span class=&quot;code-snippet__params&quot;&gt;()&lt;/span&gt;&lt;/span&gt; {&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;   fmt.Println(f2())}&lt;span class=&quot;code-snippet__function&quot;&gt;&lt;span class=&quot;code-snippet__keyword&quot;&gt;func&lt;/span&gt; &lt;span class=&quot;code-snippet__title&quot;&gt;f2&lt;/span&gt;&lt;span class=&quot;code-snippet__params&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;code-snippet__params&quot;&gt;(a &lt;span class=&quot;code-snippet__keyword&quot;&gt;int&lt;/span&gt;)&lt;/span&gt;&lt;/span&gt; {&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;   &lt;span class=&quot;code-snippet__keyword&quot;&gt;defer&lt;/span&gt; &lt;span class=&quot;code-snippet__function&quot;&gt;&lt;span class=&quot;code-snippet__keyword&quot;&gt;func&lt;/span&gt;&lt;span class=&quot;code-snippet__params&quot;&gt;(a &lt;span class=&quot;code-snippet__keyword&quot;&gt;int&lt;/span&gt;)&lt;/span&gt;&lt;/span&gt; {&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;      a += &lt;span class=&quot;code-snippet__number&quot;&gt;5&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;      fmt.Println(&lt;span class=&quot;code-snippet__string&quot;&gt;&quot;defer a = &quot;&lt;/span&gt;, a)&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;   }(a)&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;   a += &lt;span class=&quot;code-snippet__number&quot;&gt;3&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;   &lt;span class=&quot;code-snippet__keyword&quot;&gt;return&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/section&gt;&lt;span&gt;&lt;span data-offset-key=&quot;4jdnr-64-0&quot;&gt;&lt;span data-text=&quot;true&quot;/&gt;&lt;/span&gt;&lt;/span&gt;&lt;/div&gt;&lt;/pre&gt;&lt;/pre&gt;&lt;p&gt;&lt;/p&gt;&lt;figure data-block=&quot;true&quot; data-editor=&quot;an97u&quot; data-offset-key=&quot;b9mhb-0-0&quot;&gt;&lt;p&gt;&lt;img data-ratio=&quot;0.11566265060240964&quot; data-src=&quot;https://mmbiz.qpic.cn/mmbiz_png/pafDRXbWF0SeJjtgSgvsDs7DuEMBYHLAfqPES5MgfQjicjalSAOc72zyibQicjpFbJeCaOsu3n4SXEBl8nBbicGM2g/640?wx_fmt=png&quot; data-type=&quot;png&quot; data-w=&quot;830&quot;/&gt;&lt;/p&gt;&lt;/figure&gt;&lt;p&gt;&lt;/p&gt;&lt;p&gt;&lt;span data-offset-key=&quot;6ofpu-0-0&quot;&gt;&lt;span data-text=&quot;true&quot;&gt;当执行到defer时，a初始值默认是0，所以func(0)会被压栈，当defer被触发时，func(0)被执行，输出a=5。&lt;/span&gt;&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;span data-offset-key=&quot;7gv6q-0-0&quot;&gt;&lt;span data-text=&quot;true&quot;&gt;2. 当一个方法中有多个defer时，defer的执行顺序是LIFO（先进后出）的；&lt;/span&gt;&lt;/span&gt;&lt;/p&gt;&lt;pre data-offset-key=&quot;5ujna-0-0&quot;&gt;&lt;pre data-block=&quot;true&quot; data-editor=&quot;an97u&quot; data-offset-key=&quot;5ujna-0-0&quot;&gt;&lt;div data-offset-key=&quot;5ujna-0-0&quot;&gt;&lt;span&gt;&lt;span data-offset-key=&quot;5ujna-0-0&quot;&gt;&lt;span data-text=&quot;true&quot;/&gt;&lt;/span&gt;&lt;/span&gt;&lt;section class=&quot;code-snippet__fix code-snippet__js&quot;&gt;&lt;pre class=&quot;code-snippet__js&quot; data-lang=&quot;swift&quot;&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span class=&quot;code-snippet__function&quot;&gt;&lt;span class=&quot;code-snippet__keyword&quot;&gt;func&lt;/span&gt; &lt;span class=&quot;code-snippet__title&quot;&gt;main&lt;/span&gt;&lt;span class=&quot;code-snippet__params&quot;&gt;()&lt;/span&gt;&lt;/span&gt; {&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;    &lt;span class=&quot;code-snippet__keyword&quot;&gt;defer&lt;/span&gt; fmt.&lt;span class=&quot;code-snippet__type&quot;&gt;Println&lt;/span&gt;(&lt;span class=&quot;code-snippet__string&quot;&gt;&quot;one&quot;&lt;/span&gt;)&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;    &lt;span class=&quot;code-snippet__keyword&quot;&gt;defer&lt;/span&gt; fmt.&lt;span class=&quot;code-snippet__type&quot;&gt;Println&lt;/span&gt;(&lt;span class=&quot;code-snippet__string&quot;&gt;&quot;two&quot;&lt;/span&gt;)&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;    &lt;span class=&quot;code-snippet__keyword&quot;&gt;defer&lt;/span&gt; fmt.&lt;span class=&quot;code-snippet__type&quot;&gt;Println&lt;/span&gt;(&lt;span class=&quot;code-snippet__string&quot;&gt;&quot;three&quot;&lt;/span&gt;)&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/section&gt;&lt;span&gt;&lt;span data-offset-key=&quot;5ujna-32-0&quot;&gt;&lt;span data-text=&quot;true&quot;/&gt;&lt;/span&gt;&lt;/span&gt;&lt;/div&gt;&lt;/pre&gt;&lt;/pre&gt;&lt;p&gt;&lt;span data-offset-key=&quot;b3r00-0-0&quot;&gt;&lt;span data-text=&quot;true&quot;&gt;执行这段代码，输出顺序是：three-&amp;gt; two-&amp;gt; one&lt;/span&gt;&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;span data-offset-key=&quot;ek5ga-0-0&quot;&gt;&lt;span data-text=&quot;true&quot;&gt;另外，defer还有一个妙用，就是在调试复杂程序时，被用于记录何时进入和退出函数。&lt;/span&gt;&lt;/span&gt;&lt;/p&gt;&lt;pre data-offset-key=&quot;37f47-0-0&quot;&gt;&lt;pre data-block=&quot;true&quot; data-editor=&quot;an97u&quot; data-offset-key=&quot;37f47-0-0&quot;&gt;&lt;div data-offset-key=&quot;37f47-0-0&quot;&gt;&lt;span&gt;&lt;span data-offset-key=&quot;37f47-0-0&quot;&gt;&lt;span data-text=&quot;true&quot;/&gt;&lt;/span&gt;&lt;/span&gt;&lt;section class=&quot;code-snippet__fix code-snippet__js&quot;&gt;&lt;pre class=&quot;code-snippet__js&quot; data-lang=&quot;swift&quot;&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span class=&quot;code-snippet__function&quot;&gt;&lt;span class=&quot;code-snippet__keyword&quot;&gt;func&lt;/span&gt; &lt;span class=&quot;code-snippet__title&quot;&gt;bigSlowOperation&lt;/span&gt;&lt;span class=&quot;code-snippet__params&quot;&gt;()&lt;/span&gt;&lt;/span&gt; {&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;    &lt;span class=&quot;code-snippet__keyword&quot;&gt;defer&lt;/span&gt; trace(&lt;span class=&quot;code-snippet__string&quot;&gt;&quot;bigSlowOperation&quot;&lt;/span&gt;)()&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;    &lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;    time.&lt;span class=&quot;code-snippet__type&quot;&gt;Sleep&lt;/span&gt;(&lt;span class=&quot;code-snippet__number&quot;&gt;10&lt;/span&gt; * time.&lt;span class=&quot;code-snippet__type&quot;&gt;Second&lt;/span&gt;)&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span class=&quot;code-snippet__function&quot;&gt;&lt;span class=&quot;code-snippet__keyword&quot;&gt;func&lt;/span&gt; &lt;span class=&quot;code-snippet__title&quot;&gt;trace&lt;/span&gt;&lt;span class=&quot;code-snippet__params&quot;&gt;(msg string)&lt;/span&gt;&lt;/span&gt; &lt;span class=&quot;code-snippet__function&quot;&gt;&lt;span class=&quot;code-snippet__keyword&quot;&gt;func&lt;/span&gt;&lt;span class=&quot;code-snippet__params&quot;&gt;()&lt;/span&gt;&lt;/span&gt; {&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;    start := time.&lt;span class=&quot;code-snippet__type&quot;&gt;Now&lt;/span&gt;()&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;    log.&lt;span class=&quot;code-snippet__type&quot;&gt;Printf&lt;/span&gt;(&lt;span class=&quot;code-snippet__string&quot;&gt;&quot;enter %s&quot;&lt;/span&gt;, msg)&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;    &lt;span class=&quot;code-snippet__keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-snippet__function&quot;&gt;&lt;span class=&quot;code-snippet__keyword&quot;&gt;func&lt;/span&gt;&lt;span class=&quot;code-snippet__params&quot;&gt;()&lt;/span&gt;&lt;/span&gt; { &lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;        log.&lt;span class=&quot;code-snippet__type&quot;&gt;Printf&lt;/span&gt;(&lt;span class=&quot;code-snippet__string&quot;&gt;&quot;exit %s (%s)&quot;&lt;/span&gt;, msg,time.&lt;span class=&quot;code-snippet__type&quot;&gt;Since&lt;/span&gt;(start)) &lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;    }&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/section&gt;&lt;span&gt;&lt;span data-offset-key=&quot;37f47-86-0&quot;&gt;&lt;span data-text=&quot;true&quot;/&gt;&lt;/span&gt;&lt;/span&gt;&lt;/div&gt;&lt;/pre&gt;&lt;/pre&gt;&lt;p&gt;&lt;/p&gt;&lt;figure data-block=&quot;true&quot; data-editor=&quot;an97u&quot; data-offset-key=&quot;cbgff-0-0&quot;&gt;&lt;p&gt;&lt;img data-ratio=&quot;0.5625&quot; data-src=&quot;https://mmbiz.qpic.cn/mmbiz_jpg/pafDRXbWF0SeJjtgSgvsDs7DuEMBYHLAvBvDCiaYw7MG5SESdicL9nyc3XIJKQVRqNJQyYg61mtHVx2AI1A0xSkA/640?wx_fmt=jpeg&quot; data-type=&quot;jpeg&quot; data-w=&quot;1440&quot;/&gt;&lt;/p&gt;&lt;/figure&gt;&lt;figure data-block=&quot;true&quot; data-editor=&quot;an97u&quot; data-offset-key=&quot;8mpii-0-0&quot;&gt;&lt;p&gt;&lt;img data-ratio=&quot;0.5625&quot; data-src=&quot;https://mmbiz.qpic.cn/mmbiz_jpg/pafDRXbWF0SeJjtgSgvsDs7DuEMBYHLArx3fiaanc7Lt3ial7qZO7UicFGS4hKGDdAIvgc4ibiciaLQI4lfJwiaoZ4syg/640?wx_fmt=jpeg&quot; data-type=&quot;jpeg&quot; data-w=&quot;1440&quot;/&gt;&lt;/p&gt;&lt;/figure&gt;&lt;figure data-block=&quot;true&quot; data-editor=&quot;an97u&quot; data-offset-key=&quot;10mmv-0-0&quot;&gt;&lt;hr/&gt;&lt;/figure&gt;&lt;p&gt;&lt;/p&gt;&lt;p&gt;&lt;span data-offset-key=&quot;55b1a-0-0&quot;&gt;&lt;span data-text=&quot;true&quot;&gt;有趣有料有温度，和我一起学技术！&lt;/span&gt;&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;span data-offset-key=&quot;6q25f-0-0&quot;&gt;&lt;span data-text=&quot;true&quot;&gt;欢迎关注公众号 &lt;/span&gt;&lt;/span&gt;&lt;span data-offset-key=&quot;6q25f-0-1&quot;&gt;&lt;span data-text=&quot;true&quot;&gt;来思Go&lt;/span&gt;&lt;/span&gt;&lt;span data-offset-key=&quot;6q25f-0-2&quot;&gt;&lt;span data-text=&quot;true&quot;&gt;，收看更多赖思与甜甜的技术学习日常。&lt;/span&gt;&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;img class=&quot;rich_pages&quot; data-ratio=&quot;1&quot; data-s=&quot;300,640&quot; data-src=&quot;https://mmbiz.qpic.cn/mmbiz_jpg/pafDRXbWF0Qm7Ziak8d3Jqg28qia9iaHibjtKQJZmM4je8fXiaJeyoxBY1icqul5nWHO06Rr3amUicfHY887r4G4R7TXQ/640?wx_fmt=jpeg&quot; data-type=&quot;jpeg&quot; data-w=&quot;258&quot;/&gt;&lt;/p&gt;
                &lt;/div&gt;

                

                



                
                &lt;/div&gt;&lt;/div&gt;</content:encoded>
</item>
<item>
<guid>e55b1563c88fd01209cc4b0f0ec508ab</guid>
<title>Redis 分布式锁遇到的序列化问题</title>
<link>https://toutiao.io/k/adg4qv6</link>
<content:encoded>&lt;div&gt;&lt;div&gt;&lt;section data-tool=&quot;mdnice编辑器&quot; data-website=&quot;https://www.mdnice.com&quot; data-mpa-powered-by=&quot;yiban.io&quot;&gt;&lt;h2 data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span/&gt;场景描述&lt;/h2&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;最近使用 Redis 遇到了一个类似分布式锁的场景，跟 Redis 实现分布式锁类比一下，就是释放锁失败，也就是缓存删不掉。又踩了一个 Redis 的坑……&lt;/p&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;这是什么个情况、又是怎样排查的呢？&lt;/p&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;本文主要对此做个复盘。&lt;/p&gt;&lt;h2 data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span/&gt;问题排查&lt;/h2&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;既然是释放锁有问题，那就先看看释放锁的代码吧。&lt;/p&gt;&lt;h3 data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span/&gt;释放锁&lt;span/&gt;&lt;/h3&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;释放锁使用了 Lua 脚本，代码逻辑和 Lua 脚本如下：&lt;/p&gt;&lt;pre data-tool=&quot;mdnice编辑器&quot;&gt;&lt;code&gt;&lt;span&gt;&lt;span&gt;public&lt;/span&gt; Object &lt;span&gt;release&lt;/span&gt;&lt;span&gt;(String key, String value)&lt;/span&gt; &lt;/span&gt;{&lt;br/&gt;  Object existedValue = stringRedisTemplate.opsForValue().get(key);&lt;br/&gt;  log.info(&lt;span&gt;&quot;key:{}, value:{}, redis旧值：{}&quot;&lt;/span&gt;, key, value, existedValue);&lt;br/&gt;  &lt;br/&gt;  DefaultRedisScript&amp;lt;Long&amp;gt; redisScript = &lt;span&gt;new&lt;/span&gt; DefaultRedisScript&amp;lt;&amp;gt;(COMPARE_AND_DELETE, Long&lt;span&gt;.&lt;span&gt;class&lt;/span&gt;)&lt;/span&gt;;&lt;br/&gt;  &lt;span&gt;return&lt;/span&gt; stringRedisTemplate.execute(redisScript, Collections.singletonList(key), value);&lt;br/&gt;}&lt;br/&gt;&lt;/code&gt;&lt;/pre&gt;&lt;pre data-tool=&quot;mdnice编辑器&quot;&gt;&lt;code&gt;&lt;span&gt;if&lt;/span&gt; redis.call(&lt;span&gt;&#x27;get&#x27;&lt;/span&gt;,KEYS[&lt;span&gt;1&lt;/span&gt;]) == ARGV[&lt;span&gt;1&lt;/span&gt;]&lt;br/&gt;&lt;span&gt;then&lt;/span&gt;&lt;br/&gt;    &lt;span&gt;return&lt;/span&gt; redis.call(&lt;span&gt;&#x27;del&#x27;&lt;/span&gt;,KEYS[&lt;span&gt;1&lt;/span&gt;])&lt;br/&gt;&lt;span&gt;else&lt;/span&gt;&lt;br/&gt;    &lt;span&gt;return&lt;/span&gt; &lt;span&gt;0&lt;/span&gt;&lt;br/&gt;&lt;span&gt;end&lt;/span&gt;;&lt;br/&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;删除脚本中，会先获取 Redis key 的旧值，并与入参 value 比较，二者相等时才会删除。&lt;/p&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;如果释放成功，也就是 Redis 缓存删除成功，返回值为 1，否则失败返回为 0。&lt;/p&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;乍一看代码似乎没啥问题，测一下试试？&lt;/p&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;不过既然要释放锁，在此之前肯定要加锁，先看看加锁的逻辑吧。&lt;/p&gt;&lt;h3 data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span/&gt;加锁&lt;span/&gt;&lt;/h3&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;说到加锁这里的逻辑，代码里有两种实现方式：&lt;/p&gt;&lt;pre data-tool=&quot;mdnice编辑器&quot;&gt;&lt;code&gt;&lt;span&gt;&lt;span&gt;public&lt;/span&gt; Object &lt;span&gt;lock01&lt;/span&gt;&lt;span&gt;(String key, String value)&lt;/span&gt; &lt;/span&gt;{&lt;br/&gt;  log.info(&lt;span&gt;&quot;lock01, key={}, value={}&quot;&lt;/span&gt;, key, value);&lt;br/&gt;  &lt;span&gt;return&lt;/span&gt; redisTemplate.opsForValue().setIfAbsent(key, value, LOCKED_TIME, TimeUnit.SECONDS);&lt;br/&gt;}&lt;br/&gt;&lt;/code&gt;&lt;/pre&gt;&lt;pre data-tool=&quot;mdnice编辑器&quot;&gt;&lt;code&gt;&lt;span&gt;&lt;span&gt;public&lt;/span&gt; Object &lt;span&gt;lock02&lt;/span&gt;&lt;span&gt;(String key, String value)&lt;/span&gt; &lt;/span&gt;{&lt;br/&gt;  log.info(&lt;span&gt;&quot;lock02, key={}, value={}&quot;&lt;/span&gt;, key, value);&lt;br/&gt;  &lt;span&gt;return&lt;/span&gt; stringRedisTemplate.opsForValue().setIfAbsent(key, value, LOCKED_TIME, TimeUnit.SECONDS);&lt;br/&gt;}&lt;br/&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;其实它们的区别就在于前者使用了 RedisTemplate，而后者使用的是 StringRedisTemplate。&lt;/p&gt;&lt;blockquote data-tool=&quot;mdnice编辑器&quot;&gt;&lt;p&gt;Q: 等等……为什么会有两个 template？？&lt;/p&gt;&lt;p&gt;A: 憋说了，是我挖的坑，RedisTemplate 是我加的……现在回想都没想明白当初为什么这样搞，可能真是脑子一时抽风了。&lt;/p&gt;&lt;/blockquote&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;先测试一下这两个方法？&lt;/p&gt;&lt;h3 data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span/&gt;测试一下&lt;span/&gt;&lt;/h3&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;使用两种方式分别加锁，其中：lock01 为 k1 和 v1，lock02 为 k2 和 v2。&lt;/p&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;分别看下 k1、k2 的值（使用工具：RDM, Redis Desktop Manager）：&lt;/p&gt;&lt;p&gt;&lt;img class=&quot;rich_pages js_insertlocalimg&quot; data-ratio=&quot;0.32421875&quot; data-s=&quot;300,640&quot; data-src=&quot;https://mmbiz.qpic.cn/sz_mmbiz_png/ophTb90oYCST7zGKoGN7yTrPMInbKpWE2geDT7nuHLT7ia5ZGdLVOULCibM46ic9pxTicLERYETwM7U7E6ibSblQxXA/640?wx_fmt=png&quot; data-type=&quot;png&quot; data-w=&quot;1280&quot;/&gt;&lt;/p&gt;&lt;p&gt;&lt;img class=&quot;rich_pages js_insertlocalimg&quot; data-ratio=&quot;0.35546875&quot; data-s=&quot;300,640&quot; data-src=&quot;https://mmbiz.qpic.cn/sz_mmbiz_png/ophTb90oYCST7zGKoGN7yTrPMInbKpWEJnSoibMiaVqL2sbvY79pUVmJbamr63dwJuy9mN9QKEvdGbQKltqKVqwg/640?wx_fmt=png&quot; data-type=&quot;png&quot; data-w=&quot;1280&quot;/&gt;&lt;/p&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;可以看到 v1 是有双引号的，而 v2 没有。&lt;/p&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;猜测应该是序列化的问题，看看 Redis 配置？&lt;/p&gt;&lt;h3 data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span/&gt;RedisTemplate 配置&lt;span/&gt;&lt;/h3&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;加锁那里可以看到，k1 使用了 RedisTemplate，而 k2 是 StringRedisTemplate，它们两个的配置有什么区别呢？&lt;/p&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;其中 RedisTemplate 的配置是自定义的，如下：&lt;/p&gt;&lt;pre data-tool=&quot;mdnice编辑器&quot;&gt;&lt;code&gt;&lt;span&gt;@Configuration&lt;/span&gt;&lt;br/&gt;&lt;span&gt;@AutoConfigureAfter&lt;/span&gt;(RedisAutoConfiguration&lt;span&gt;.&lt;span&gt;class&lt;/span&gt;)&lt;br/&gt;&lt;span&gt;public&lt;/span&gt; &lt;span&gt;class&lt;/span&gt; &lt;span&gt;RedisConfig&lt;/span&gt; &lt;/span&gt;{&lt;br/&gt;  &lt;span&gt;@Bean&lt;/span&gt;&lt;br/&gt;  &lt;span&gt;&lt;span&gt;public&lt;/span&gt; RedisTemplate&amp;lt;String, Object&amp;gt; &lt;span&gt;redisTemplate&lt;/span&gt;&lt;span&gt;(RedisConnectionFactory redisConnectionFactory)&lt;/span&gt; &lt;/span&gt;{&lt;br/&gt;    RedisTemplate&amp;lt;String, Object&amp;gt; redisTemplate = &lt;span&gt;new&lt;/span&gt; RedisTemplate&amp;lt;&amp;gt;();&lt;br/&gt;    redisTemplate.setConnectionFactory(redisConnectionFactory);&lt;br/&gt;&lt;br/&gt;    &lt;span&gt;// 使用 Jackson2JsonRedisSerialize 替换默认序列化&lt;/span&gt;&lt;br/&gt;    Jackson2JsonRedisSerializer&amp;lt;Object&amp;gt; jackson2JsonRedisSerializer&lt;br/&gt;        = &lt;span&gt;new&lt;/span&gt; Jackson2JsonRedisSerializer&amp;lt;&amp;gt;(Object&lt;span&gt;.&lt;span&gt;class&lt;/span&gt;)&lt;/span&gt;;&lt;br/&gt;&lt;br/&gt;    ObjectMapper objectMapper = &lt;span&gt;new&lt;/span&gt; ObjectMapper();&lt;br/&gt;    objectMapper.setVisibility(PropertyAccessor.ALL, JsonAutoDetect.Visibility.ANY);&lt;br/&gt;    objectMapper.enableDefaultTyping(ObjectMapper.DefaultTyping.NON_FINAL);&lt;br/&gt;    objectMapper.configure(DeserializationFeature.FAIL_ON_UNKNOWN_PROPERTIES, &lt;span&gt;false&lt;/span&gt;);&lt;br/&gt;&lt;br/&gt;    jackson2JsonRedisSerializer.setObjectMapper(objectMapper);&lt;br/&gt;&lt;br/&gt;    &lt;span&gt;// 设置 key、value 的序列化规则（尤其是 value）&lt;/span&gt;&lt;br/&gt;    redisTemplate.setKeySerializer(&lt;span&gt;new&lt;/span&gt; StringRedisSerializer());&lt;br/&gt;    redisTemplate.setValueSerializer(jackson2JsonRedisSerializer);&lt;br/&gt;    redisTemplate.afterPropertiesSet();&lt;br/&gt;&lt;br/&gt;    &lt;span&gt;return&lt;/span&gt; redisTemplate;&lt;br/&gt;  }&lt;br/&gt;}&lt;br/&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;StringRedisTemplate 的配置是 SpringBoot 默认的，即：&lt;/p&gt;&lt;pre data-tool=&quot;mdnice编辑器&quot;&gt;&lt;code&gt;&lt;span&gt;@Configuration&lt;/span&gt;&lt;br/&gt;&lt;span&gt;@ConditionalOnClass&lt;/span&gt;({RedisOperations&lt;span&gt;.&lt;span&gt;class&lt;/span&gt;})&lt;br/&gt;@&lt;span&gt;EnableConfigurationProperties&lt;/span&gt;(&lt;/span&gt;{RedisProperties&lt;span&gt;.&lt;span&gt;class&lt;/span&gt;})&lt;br/&gt;@&lt;span&gt;Import&lt;/span&gt;(&lt;/span&gt;{LettuceConnectionConfiguration&lt;span&gt;.&lt;span&gt;class&lt;/span&gt;, &lt;span&gt;JedisConnectionConfiguration&lt;/span&gt;.&lt;span&gt;class&lt;/span&gt;})&lt;br/&gt;&lt;span&gt;public&lt;/span&gt; &lt;span&gt;class&lt;/span&gt; &lt;span&gt;RedisAutoConfiguration&lt;/span&gt; &lt;/span&gt;{&lt;br/&gt;  &lt;span&gt;&lt;span&gt;public&lt;/span&gt; &lt;span&gt;RedisAutoConfiguration&lt;/span&gt;&lt;span&gt;()&lt;/span&gt; &lt;/span&gt;{&lt;br/&gt;  }&lt;br/&gt;&lt;br/&gt;  &lt;span&gt;@Bean&lt;/span&gt;&lt;br/&gt;  &lt;span&gt;@ConditionalOnMissingBean&lt;/span&gt;&lt;br/&gt;  &lt;span&gt;&lt;span&gt;public&lt;/span&gt; StringRedisTemplate &lt;span&gt;stringRedisTemplate&lt;/span&gt;&lt;span&gt;(RedisConnectionFactory redisConnectionFactory)&lt;/span&gt; &lt;span&gt;throws&lt;/span&gt; UnknownHostException &lt;/span&gt;{&lt;br/&gt;    StringRedisTemplate template = &lt;span&gt;new&lt;/span&gt; StringRedisTemplate();&lt;br/&gt;    template.setConnectionFactory(redisConnectionFactory);&lt;br/&gt;    &lt;span&gt;return&lt;/span&gt; template;&lt;br/&gt;  }&lt;br/&gt;}&lt;br/&gt;&lt;/code&gt;&lt;/pre&gt;&lt;blockquote data-tool=&quot;mdnice编辑器&quot;&gt;&lt;p&gt;PS: SpringBoot 版本为 2.1.13.RELEASE&lt;/p&gt;&lt;/blockquote&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;点进去 StringRedisTemplate 看下：&lt;/p&gt;&lt;pre data-tool=&quot;mdnice编辑器&quot;&gt;&lt;code&gt;&lt;span&gt;public&lt;/span&gt; &lt;span&gt;&lt;span&gt;class&lt;/span&gt; &lt;span&gt;StringRedisTemplate&lt;/span&gt; &lt;span&gt;extends&lt;/span&gt; &lt;span&gt;RedisTemplate&lt;/span&gt;&amp;lt;&lt;span&gt;String&lt;/span&gt;, &lt;span&gt;String&lt;/span&gt;&amp;gt; &lt;/span&gt;{&lt;br/&gt;    &lt;br/&gt;  &lt;span&gt;&lt;span&gt;public&lt;/span&gt; &lt;span&gt;StringRedisTemplate&lt;/span&gt;&lt;span&gt;()&lt;/span&gt; &lt;/span&gt;{&lt;br/&gt;    &lt;span&gt;// 注意这里的序列化设置&lt;/span&gt;&lt;br/&gt;    setKeySerializer(RedisSerializer.string());&lt;br/&gt;    setValueSerializer(RedisSerializer.string());&lt;br/&gt;    setHashKeySerializer(RedisSerializer.string());&lt;br/&gt;    setHashValueSerializer(RedisSerializer.string());&lt;br/&gt;  }&lt;br/&gt;  &lt;span&gt;// ...&lt;/span&gt;&lt;br/&gt;}&lt;br/&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;注意下序列化设置，继续跟进，看到底是什么方式：&lt;/p&gt;&lt;pre data-tool=&quot;mdnice编辑器&quot;&gt;&lt;code&gt;&lt;span&gt;public&lt;/span&gt; &lt;span&gt;&lt;span&gt;interface&lt;/span&gt; &lt;span&gt;RedisSerializer&lt;/span&gt;&amp;lt;&lt;span&gt;T&lt;/span&gt;&amp;gt; &lt;/span&gt;{&lt;br/&gt;  &lt;span&gt;&lt;span&gt;static&lt;/span&gt; RedisSerializer&amp;lt;String&amp;gt; &lt;span&gt;string&lt;/span&gt;&lt;span&gt;()&lt;/span&gt; &lt;/span&gt;{&lt;br/&gt;    &lt;span&gt;return&lt;/span&gt; StringRedisSerializer.UTF_8;&lt;br/&gt;  }&lt;br/&gt;}&lt;br/&gt;&lt;/code&gt;&lt;/pre&gt;&lt;pre data-tool=&quot;mdnice编辑器&quot;&gt;&lt;code&gt;&lt;span&gt;public&lt;/span&gt; &lt;span&gt;&lt;span&gt;class&lt;/span&gt; &lt;span&gt;StringRedisSerializer&lt;/span&gt; &lt;span&gt;implements&lt;/span&gt; &lt;span&gt;RedisSerializer&lt;/span&gt;&amp;lt;&lt;span&gt;String&lt;/span&gt;&amp;gt; &lt;/span&gt;{&lt;br/&gt;  &lt;span&gt;public&lt;/span&gt; &lt;span&gt;static&lt;/span&gt; &lt;span&gt;final&lt;/span&gt; StringRedisSerializer UTF_8 = &lt;span&gt;new&lt;/span&gt; StringRedisSerializer(StandardCharsets.UTF_8);&lt;br/&gt;    &lt;span&gt;// ...&lt;/span&gt;&lt;br/&gt;}&lt;br/&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;可以看到，StringRedisTemplate 的 key 和 value 默认都是用 StringRedisSerializer(StandardCharsets.UTF_8) 进行序列化的。&lt;/p&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;而 RedisTemplate 的 key 使用 StringRedisSerializer，value 使用的是 Jackson2JsonRedisSerializer 序列化（至于为什么用这个，这里就不是我写的了）。&lt;/p&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;到这里，基本可以定位到问题所在了：就是 RedisTemplate 的 value 序列化和 StringRedisTemplate 不一致。&lt;/p&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;如果改成一致就可以了吗？验证一下试试。&lt;/p&gt;&lt;h3 data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span/&gt;验证推论&lt;span/&gt;&lt;/h3&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;把 RedisTemplate 的 value 序列化方式修改为 StringRedisSerializer：&lt;/p&gt;&lt;pre data-tool=&quot;mdnice编辑器&quot;&gt;&lt;code&gt;&lt;span&gt;@Configuration&lt;/span&gt;&lt;br/&gt;&lt;span&gt;@AutoConfigureAfter&lt;/span&gt;(RedisAutoConfiguration&lt;span&gt;.&lt;span&gt;class&lt;/span&gt;)&lt;br/&gt;&lt;span&gt;public&lt;/span&gt; &lt;span&gt;class&lt;/span&gt; &lt;span&gt;RedisConfig&lt;/span&gt; &lt;/span&gt;{&lt;br/&gt;  &lt;span&gt;@Bean&lt;/span&gt;&lt;br/&gt;  &lt;span&gt;&lt;span&gt;public&lt;/span&gt; RedisTemplate&amp;lt;String, Object&amp;gt; &lt;span&gt;redisTemplate&lt;/span&gt;&lt;span&gt;(RedisConnectionFactory redisConnectionFactory)&lt;/span&gt; &lt;/span&gt;{&lt;br/&gt;    RedisTemplate&amp;lt;String, Object&amp;gt; redisTemplate = &lt;span&gt;new&lt;/span&gt; RedisTemplate&amp;lt;&amp;gt;();&lt;br/&gt;      &lt;br/&gt;    &lt;span&gt;// ...&lt;/span&gt;&lt;br/&gt;&lt;br/&gt;    redisTemplate.setKeySerializer(&lt;span&gt;new&lt;/span&gt; StringRedisSerializer());&lt;br/&gt;    redisTemplate.setValueSerializer(&lt;span&gt;new&lt;/span&gt; StringRedisSerializer());&lt;br/&gt;&lt;br/&gt;    &lt;span&gt;// ...&lt;/span&gt;&lt;br/&gt;    &lt;span&gt;return&lt;/span&gt; redisTemplate;&lt;br/&gt;  }&lt;br/&gt;}&lt;br/&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;再调用两种加锁逻辑，看下 k1、k2 的值：&lt;/p&gt;&lt;p&gt;&lt;img class=&quot;rich_pages js_insertlocalimg&quot; data-ratio=&quot;0.33515625&quot; data-s=&quot;300,640&quot; data-src=&quot;https://mmbiz.qpic.cn/sz_mmbiz_png/ophTb90oYCST7zGKoGN7yTrPMInbKpWE7paiaILVicvP7A6dWAsqQPNkibtukfMQeKywPtmTsF0xp6k5NPBvrtsTA/640?wx_fmt=png&quot; data-type=&quot;png&quot; data-w=&quot;1280&quot;/&gt;&lt;/p&gt;&lt;figure data-tool=&quot;mdnice编辑器&quot;&gt;&lt;p&gt;&lt;img class=&quot;rich_pages js_insertlocalimg&quot; data-ratio=&quot;0.35859375&quot; data-s=&quot;300,640&quot; data-src=&quot;https://mmbiz.qpic.cn/sz_mmbiz_png/ophTb90oYCST7zGKoGN7yTrPMInbKpWEQ8EQmt2hGz62HXVuRMQDzVAMzf8ficTnic9CECJEkYIWibfhE9Age70Ag/640?wx_fmt=png&quot; data-type=&quot;png&quot; data-w=&quot;1280&quot;/&gt;&lt;span/&gt;&lt;/p&gt;&lt;/figure&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;可以看到，v1 的双引号没了，释放锁的服务也能正常删掉了。&lt;/p&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;嗯，就是这里的问题。&lt;/p&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;至于两者序列化的源码，有兴趣的盆友们可以继续研究，这里就不再深入探讨了。&lt;/p&gt;&lt;h2 data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span/&gt;小结&lt;/h2&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;本文遇到的这个问题，主要是因为使用了不同的 RedisTemplate 来加锁和释放锁，而这两个 template 使用了不同的序列化方式，最终还是序列化带来的问题。&lt;/p&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;当初真是草率了，而且一时还没测出来……&lt;/p&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;对于生产环境，还是要慎之又慎：如临深渊，如履薄冰。&lt;span/&gt;&lt;/p&gt;&lt;section class=&quot;mp_profile_iframe_wrp&quot;&gt;&lt;mpprofile class=&quot;js_uneditable custom_select_card mp_profile_iframe&quot; data-pluginname=&quot;mpprofile&quot; data-id=&quot;MzU4NzYyMDE4MQ==&quot; data-headimg=&quot;http://mmbiz.qpic.cn/sz_mmbiz_png/ophTb90oYCQ3hdcibbKDTtUib9yUnFAicJ4RoeJPVgwzjRejhoNbVYcCzyHtcW6vn9EbxP3PpErEIRkibrms8KEYDQ/0?wx_fmt=png&quot; data-nickname=&quot;WriteOnRead&quot; data-alias=&quot;WriteOnRead&quot; data-signature=&quot;Java学习与分享。知易行难，坚持更难。加油！&quot;/&gt;&lt;/section&gt;&lt;/section&gt;
                &lt;/div&gt;&lt;/div&gt;</content:encoded>
</item>
<item>
<guid>563578263e06e5fb6ab6a417c329f502</guid>
<title>不懂就问：ZooKeeper 集群如何进行数据同步？</title>
<link>https://toutiao.io/k/7sfy943</link>
<content:encoded>&lt;div&gt;&lt;div&gt;&lt;section data-tool=&quot;mdnice编辑器&quot; data-website=&quot;https://www.mdnice.com&quot; data-mpa-powered-by=&quot;yiban.io&quot;&gt;&lt;figure data-tool=&quot;mdnice编辑器&quot;&gt;&lt;img data-ratio=&quot;0.425531914893617&quot; data-src=&quot;https://mmbiz.qpic.cn/mmbiz_png/xBgIbW1vdNNib25DXQw8iatfbZLpACr3jUlZlq9Dib8demK0fzcVGoAAVGK4x3ibUWBW0iaMSR1Xn9mAWibYlbObdlFw/640?wx_fmt=png&quot; data-type=&quot;png&quot; data-w=&quot;940&quot;/&gt;&lt;/figure&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;本文作者：HelloGitHub-&lt;strong&gt;老荀&lt;/strong&gt;&lt;/p&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;Hi，这里是 HelloGitHub 推出的 HelloZooKeeper 系列，&lt;strong&gt;免费开源、有趣、入门级的 ZooKeeper 教程&lt;/strong&gt;，面向有编程基础的新手。&lt;/p&gt;&lt;blockquote data-tool=&quot;mdnice编辑器&quot;&gt;&lt;p&gt;项目地址：https://github.com/HelloGitHub-Team/HelloZooKeeper&lt;/p&gt;&lt;/blockquote&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;a target=&quot;_blank&quot; href=&quot;https://mp.weixin.qq.com/s?__biz=MzA5MzYyNzQ0MQ==&amp;amp;mid=2247500161&amp;amp;idx=1&amp;amp;sn=98f41cbdceb7c6ec3466c6e109b0b785&amp;amp;scene=21#wechat_redirect&quot; textvalue=&quot;前一篇文章&quot; tab=&quot;innerlink&quot; data-linktype=&quot;2&quot;&gt;前一篇文章&lt;/a&gt;我们介绍了 ZK 是如何进行持久化的，这章我们将正式学习 Follower 或 Observer 是如何在选举之后和 Leader 进行数据同步的。&lt;/p&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;img data-ratio=&quot;0.22857142857142856&quot; data-src=&quot;https://mmbiz.qpic.cn/mmbiz_jpg/xBgIbW1vdNNib25DXQw8iatfbZLpACr3jU8JbA2IODF1Y8zZ19rH3ZDIGlRrgYpaUcA3U0ACWNoRiahSibf2qV48jA/640?wx_fmt=jpeg&quot; data-type=&quot;jpeg&quot; data-w=&quot;1890&quot;/&gt;&lt;/p&gt;&lt;h2 data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span/&gt;&lt;span&gt;一、选举完成&lt;/span&gt;&lt;span&gt; &lt;/span&gt;&lt;/h2&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;经历了选举之后，我们的&lt;strong&gt;马果果&lt;/strong&gt;荣耀当选当前办事处集群的 Leader，所以现在假设各个办事处的关系图是这样：&lt;/p&gt;&lt;figure data-tool=&quot;mdnice编辑器&quot;&gt;&lt;img data-src=&quot;https://mmbiz.qpic.cn/mmbiz_png/xBgIbW1vdNNib25DXQw8iatfbZLpACr3jUicQV6ew0s0TTHCAcJveebbJTqAdGgLiaWFoLXH3W0AqnicOsKKO0zAvQw/640?wx_fmt=png&quot; data-type=&quot;png&quot; data-ratio=&quot;0.6578171091445427&quot; data-w=&quot;678&quot;/&gt;&lt;/figure&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;我们现在就来说说&lt;strong&gt;马小云&lt;/strong&gt;和&lt;strong&gt;马小腾&lt;/strong&gt;是如何同&lt;strong&gt;马果果&lt;/strong&gt;进行数据同步的。&lt;/p&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;结束了累人的选举后，&lt;strong&gt;马小云&lt;/strong&gt;和&lt;strong&gt;马小腾&lt;/strong&gt;以微弱的优势输掉了竞争，只能委屈成为 Follower。整理完各自的情绪后，他们要做的第一件事情就是通过话务员上报自己的信息给&lt;strong&gt;马果果&lt;/strong&gt;，使用了专门的暗号 FOLLOWERINFO， 数据主要有自己的 epoch 和 myid：&lt;/p&gt;&lt;figure data-tool=&quot;mdnice编辑器&quot;&gt;&lt;img data-src=&quot;https://mmbiz.qpic.cn/mmbiz_png/xBgIbW1vdNNib25DXQw8iatfbZLpACr3jUJvU7QLZsU6AeWic8JpeT22xKkFaVlQj7icicxc6YPNwYh394MQNn9zuFg/640?wx_fmt=png&quot; data-type=&quot;png&quot; data-ratio=&quot;0.5169491525423728&quot; data-w=&quot;590&quot;/&gt;&lt;/figure&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;然后是&lt;strong&gt;马果果&lt;/strong&gt;这边，他收到 FOLLOWERINFO 之后也会进行统计，直到达到半数以上后，综合各个 Follower 给的信息会计算出新的 epoch，然后将这个新的 epoch 随着暗号 LEADERINFO 回发给其他 Follower&lt;/p&gt;&lt;figure data-tool=&quot;mdnice编辑器&quot;&gt;&lt;img data-src=&quot;https://mmbiz.qpic.cn/mmbiz_png/xBgIbW1vdNNib25DXQw8iatfbZLpACr3jUmuZib88lfooic8R7wRSPtnfMphicObT993Egpe74SruJP7zo1JvicUQj8w/640?wx_fmt=png&quot; data-type=&quot;png&quot; data-ratio=&quot;0.5561497326203209&quot; data-w=&quot;561&quot;/&gt;&lt;/figure&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;然后再回到&lt;strong&gt;马小云&lt;/strong&gt;和&lt;strong&gt;马小腾&lt;/strong&gt;这边，收到 LEADERINFO 之后将新的 epoch 记录下来，然后回复给&lt;strong&gt;马果果&lt;/strong&gt;一个 ACKEPOCH 暗号并带上自己这边的最大 zxid，表示刚刚的 LEADERINFO 收到了&lt;/p&gt;&lt;figure data-tool=&quot;mdnice编辑器&quot;&gt;&lt;img data-src=&quot;https://mmbiz.qpic.cn/mmbiz_png/xBgIbW1vdNNib25DXQw8iatfbZLpACr3jUAyEMgQPRh0OEEm5Cdl3Ga4icmfsTSNcDibQ2J6DbHBLibwG4iaib7lbqJYw/640?wx_fmt=png&quot; data-type=&quot;png&quot; data-ratio=&quot;0.527336860670194&quot; data-w=&quot;567&quot;/&gt;&lt;/figure&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;然后&lt;strong&gt;马果果&lt;/strong&gt;这边也会等待半数以上的 ACKEPOCH 的通知，收到之后会根据各个 Follower 的信息给出不同的同步策略。关于不同的同步策略，这里我先入为主的给大家介绍一下：&lt;/p&gt;&lt;ul data-tool=&quot;mdnice编辑器&quot; class=&quot;list-paddingleft-2&quot;&gt;&lt;li&gt;&lt;section&gt;DIFF，如果 Follower 的记录和 Leader 的记录相差的不多，使用增量同步的方式将一个一个写请求发送给 Follower&lt;/section&gt;&lt;/li&gt;&lt;li&gt;&lt;section&gt;TRUNC，这个情况的出现代表 Follower 的 zxid 是领先于当前的 Leader 的（可能是以前的 Leader），需要 Follower 自行把多余的部分给截断，降级到和 Leader 一致&lt;/section&gt;&lt;/li&gt;&lt;li&gt;&lt;section&gt;SNAP，如果 Follower 的记录和当前 Leader 相差太多，Leader 直接将自己的整个内存数据发送给 Follower&lt;/section&gt;&lt;/li&gt;&lt;/ul&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;至于采用哪一种策略，是如何进行判断的，接下来一一进行讲解。&lt;/p&gt;&lt;h3 data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span/&gt;1.1 DIFF&lt;span/&gt;&lt;/h3&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;每一个 ZK 节点在收到写请求后，会维护一个写请求队列（默认是 500 大小，通过 &lt;code&gt;zookeeper.commitLogCount&lt;/code&gt; 配置），将写请求记录在其中，这个队列中的最早进入的写请求当时的 zxid 就是 minZxid（以下简称 min），最后一个进入的写请求的 zxid 就是 maxZxid（以下简称 max），达到上限后，会移除最早进入的写请求，知道了这两个值之后，我们来看看 DIFF 是怎么判断的。&lt;/p&gt;&lt;h4 data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span/&gt;1.1.1 从内存中的写请求队列恢复&lt;span/&gt;&lt;/h4&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;一种情况就是如果当 Follower 通过 ACKEPOCH 上报的 zxid 是在 min 和 max 之间的话，就采用 DIFF 策略进行数据同步。&lt;/p&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;我们的例子中 Leader 的 zxid 是 99，说明这个存储 500 个写请求的队列根本没有放满，所以 min 是 1 max 是 99，很显然 77 以及 88 是在这个区间内的，那马果果就会为另外两位 Follower 找到他们各自所需要的区间，先发送一个 DIFF 给 Follower，然后将一条条的写请求包装成 PROPOSAL 和 COMMIT 的顺序发给他们&lt;/p&gt;&lt;figure data-tool=&quot;mdnice编辑器&quot;&gt;&lt;img data-src=&quot;https://mmbiz.qpic.cn/mmbiz_png/xBgIbW1vdNNib25DXQw8iatfbZLpACr3jUTZCvicmwO4ib0gu8ARPysxqfAzjS3CvgQ6PgicT1NSeYUVvZ1JFztt7Gw/640?wx_fmt=png&quot; data-type=&quot;png&quot; data-ratio=&quot;0.6601851851851852&quot; data-w=&quot;1080&quot;/&gt;&lt;/figure&gt;&lt;h4 data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span/&gt;1.1.2 从磁盘文件 log 恢复&lt;span/&gt;&lt;/h4&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;另一种情况是如果 Follower 的 zxid 不在 min 和 max 的区间内时，但当 &lt;code&gt;zookeeper.snapshotSizeFactor&lt;/code&gt; 配置大于 0 的话（默认是 0.33），会尝试使用 log 进行 DIFF，但是需要同步的 log 文件的总大小不能超过当前最新的 snapshot 文件大小的三分之一（以默认 0.33 为例）的话，才可以通过读取 log 文件中的写请求记录进行 DIFF 同步。同步的方法也和上面一样，先发送一个 DIFF 给 Follower 然后从 log 文件中找到该 Follower 的区间，再一条条的发送 PROPOSAL 和 COMMIT。&lt;/p&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;而 Follower 收到 PROPOSAL 的暗号消息后，就会像处理客户端请求那样去一条条处理，慢慢就会将数据恢复成和 Leader 是一致的。&lt;/p&gt;&lt;h3 data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span/&gt;1.2 SNAP&lt;span/&gt;&lt;/h3&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;假设现在三个办事处是这样的&lt;/p&gt;&lt;figure data-tool=&quot;mdnice编辑器&quot;&gt;&lt;img data-src=&quot;https://mmbiz.qpic.cn/mmbiz_png/xBgIbW1vdNNib25DXQw8iatfbZLpACr3jURrV8hj2d8qib19s3L1Gn2cgjgibkGibBzp5ZK4VWibHcXk4yz5SMrHxj7Q/640?wx_fmt=png&quot; data-type=&quot;png&quot; data-ratio=&quot;0.6225071225071225&quot; data-w=&quot;702&quot;/&gt;&lt;/figure&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;strong&gt;马果果&lt;/strong&gt;的写请求队列在默认配置下记录了 277 至 777 的写请求，又假设现在的场景不满足上面 1.1.2 的情况，&lt;strong&gt;马果果&lt;/strong&gt;就知道当前需要通过 SNAP 的情况进行同步了。&lt;/p&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;strong&gt;马果果&lt;/strong&gt;会先发送一个 SNAP 的请求给&lt;strong&gt;马小云&lt;/strong&gt;和&lt;strong&gt;马小腾&lt;/strong&gt;让他们准备起来&lt;/p&gt;&lt;figure data-tool=&quot;mdnice编辑器&quot;&gt;&lt;img data-src=&quot;https://mmbiz.qpic.cn/mmbiz_png/xBgIbW1vdNNib25DXQw8iatfbZLpACr3jU5pUj1Yibo6a7ZoWRt6mYnCQRcmHg5DG29D3O4KtMxATLc9dmwia5lvzw/640?wx_fmt=png&quot; data-type=&quot;png&quot; data-ratio=&quot;0.587037037037037&quot; data-w=&quot;1080&quot;/&gt;&lt;/figure&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;紧接着就会当前内存中的数据整个序列化（和 snapshot 文件是一样的）然后一起发送给&lt;strong&gt;马小云&lt;/strong&gt;和&lt;strong&gt;马小腾&lt;/strong&gt;。&lt;/p&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;而&lt;strong&gt;马小云&lt;/strong&gt;和&lt;strong&gt;马小腾&lt;/strong&gt;收到&lt;strong&gt;马果果&lt;/strong&gt;发来的整个 snapshot 之后会先清空自己当前的数据库的所有信息，接着直接将收到的 snapshot 反序列化就完成了整个内存数据的恢复。&lt;/p&gt;&lt;h3 data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span/&gt;1.3 TRUNC&lt;span/&gt;&lt;/h3&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;最后一种策略的场景假设是这样：&lt;/p&gt;&lt;figure data-tool=&quot;mdnice编辑器&quot;&gt;&lt;img data-src=&quot;https://mmbiz.qpic.cn/mmbiz_png/xBgIbW1vdNNib25DXQw8iatfbZLpACr3jUsUjruEtucrtm47eapZ9uSe1OgvOQC9XHFoFapEZlScrhnIU0o7AAgA/640?wx_fmt=png&quot; data-type=&quot;png&quot; data-ratio=&quot;0.6349206349206349&quot; data-w=&quot;693&quot;/&gt;&lt;/figure&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;假设&lt;strong&gt;马小腾&lt;/strong&gt;是上一个 Leader，但是经历了停电以后恢复重新以 Follower 的身份加入集群，但是他的 zxid 要比 max 还大，这个时候&lt;strong&gt;马果果&lt;/strong&gt;就会给&lt;strong&gt;马小腾&lt;/strong&gt;发送 TRUNC，（至于图中为什么&lt;strong&gt;马小云&lt;/strong&gt;不举例为 TRUNC，因为如果&lt;strong&gt;马小云&lt;/strong&gt;的 zxid 也比&lt;strong&gt;马果果&lt;/strong&gt;要大的话，&lt;strong&gt;马果果&lt;/strong&gt;在当前场景下就不可能当选 Leader 了）。&lt;/p&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;strong&gt;马果果&lt;/strong&gt;就会发送 TRUNC 给&lt;strong&gt;马小腾&lt;/strong&gt;（这里忽略&lt;strong&gt;马小云&lt;/strong&gt;）&lt;/p&gt;&lt;figure data-tool=&quot;mdnice编辑器&quot;&gt;&lt;img data-src=&quot;https://mmbiz.qpic.cn/mmbiz_png/xBgIbW1vdNNib25DXQw8iatfbZLpACr3jU1e0SIaKEymOPSAZg4kH2o7kBHjwlENZ97I3xN9LL9Iia89SA3zQp59w/640?wx_fmt=png&quot; data-type=&quot;png&quot; data-ratio=&quot;0.8715083798882681&quot; data-w=&quot;716&quot;/&gt;&lt;/figure&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;假设&lt;strong&gt;马小腾&lt;/strong&gt;的本地 log 文件目录下是这样的：&lt;/p&gt;&lt;pre data-tool=&quot;mdnice编辑器&quot;&gt;&lt;code&gt;/tmp&lt;br/&gt;└── zookeeper&lt;br/&gt;    └── &lt;span&gt;log&lt;/span&gt;&lt;br/&gt;      └── version-2&lt;br/&gt;        └── log.0&lt;br/&gt;        └── log.500&lt;br/&gt;        └── log.800&lt;br/&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;而&lt;strong&gt;马小腾&lt;/strong&gt;收到 TRUNC 之后，会找到本地 log 文件中所有大于 777 的 log 文件删除，即这里的 &lt;code&gt;log.800&lt;/code&gt; ，然后会在 &lt;code&gt;log.500&lt;/code&gt; 这个文件找到 777 这个 zxid 记录并且把当前文件的读写指针修改至 777 的位置，之后针对该文件的读写操作就会从 777 开始，这样就会把之后的那些记录给覆盖了。&lt;/p&gt;&lt;hr data-tool=&quot;mdnice编辑器&quot;/&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;而&lt;strong&gt;马果果&lt;/strong&gt;这边当判断完同步策略并发送给另外两马之后，便会发送一个 NEWLEADER 的信息给他们&lt;/p&gt;&lt;figure data-tool=&quot;mdnice编辑器&quot;&gt;&lt;img data-src=&quot;https://mmbiz.qpic.cn/mmbiz_png/xBgIbW1vdNNib25DXQw8iatfbZLpACr3jUkuflfib3t4ckZvmJfhFHLwp3u7RsDP9UUEMC2HqibibWMHSgmophjHsibw/640?wx_fmt=png&quot; data-type=&quot;png&quot; data-ratio=&quot;0.546112115732369&quot; data-w=&quot;553&quot;/&gt;&lt;/figure&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;而&lt;strong&gt;马小云&lt;/strong&gt;和&lt;strong&gt;马小腾&lt;/strong&gt;在收到 NEWLEADER 之后，若之前是通过 SNAP 方式同步数据的话，这里会强制快照一份新的 snapshot 文件在自己这里。然后会回复给&lt;strong&gt;马果果&lt;/strong&gt;一个 ACK 的消息，告诉他自己的同步数据已经完成了&lt;/p&gt;&lt;figure data-tool=&quot;mdnice编辑器&quot;&gt;&lt;img data-src=&quot;https://mmbiz.qpic.cn/mmbiz_png/xBgIbW1vdNNib25DXQw8iatfbZLpACr3jUzAxN7a93nmhyhg6UgxmDbIzxDmURzNAiafpibRVx5M5pGibJ5PzXibqZ2g/640?wx_fmt=png&quot; data-type=&quot;png&quot; data-ratio=&quot;0.5818181818181818&quot; data-w=&quot;550&quot;/&gt;&lt;/figure&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;然后&lt;strong&gt;马果果&lt;/strong&gt;同样会等待半数一样的 ACK 接收完成后，再发送一个 UPTODATE 给其他两马，告诉他们现在办事处数据已经都一致了，可以开始对外提供服务了&lt;/p&gt;&lt;figure data-tool=&quot;mdnice编辑器&quot;&gt;&lt;img data-src=&quot;https://mmbiz.qpic.cn/mmbiz_png/xBgIbW1vdNNib25DXQw8iatfbZLpACr3jUqIqGREGoM30z9aiav6HMCYPtA99DGVfv3icgVG3TUiakqictkomMX8wMmw/640?wx_fmt=png&quot; data-type=&quot;png&quot; data-ratio=&quot;0.5335820895522388&quot; data-w=&quot;536&quot;/&gt;&lt;/figure&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;然后&lt;strong&gt;马小云&lt;/strong&gt;和&lt;strong&gt;马果果&lt;/strong&gt;收到 UPTODATE 之后会再回复一个 ACK 给&lt;strong&gt;马果果&lt;/strong&gt;，但是这次&lt;strong&gt;马果果&lt;/strong&gt;收到这次的 ACK 之后不会做处理，所以在 UPTODATE 之后，各个办事处就已经算可以正式对外提供服务了。&lt;/p&gt;&lt;hr data-tool=&quot;mdnice编辑器&quot;/&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;上面说了这么多，但是&lt;strong&gt;马小云&lt;/strong&gt;和&lt;strong&gt;马小腾&lt;/strong&gt;都是 Follower，如果是 Observer 呢？怎么用上面的步骤同步呢？&lt;/p&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;区别就在第一步，Follower 发送的是 FOLLOWERINFO，而 Observer 发送的是 OBSERVERINFO 除此之外没有任何区别，和 Follower 是一样的步骤进行数据同步。&lt;/p&gt;&lt;h2 data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span/&gt;&lt;span&gt;二、继续深挖&lt;/span&gt;&lt;span&gt; &lt;/span&gt;&lt;/h2&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;现在把其中的一些细节再用猿话说明一下，三种不同的数据同步策略，Leader 在发送 Follower 的时候采用的具体方法是不太相同的&lt;/p&gt;&lt;h3 data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span/&gt;2.1 三种策略发送方式&lt;span/&gt;&lt;/h3&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;如果采用的是 DIFF 或者 TRUNC 的同步方法的话，Leader 其实不是在找到有差异数据的时候发送过去的，而是按照顺序先放入一个队列，最后再统一启动一个线程去一个个发送的&lt;/p&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;DIFF :&lt;/p&gt;&lt;figure data-tool=&quot;mdnice编辑器&quot;&gt;&lt;img data-src=&quot;https://mmbiz.qpic.cn/mmbiz_png/xBgIbW1vdNNib25DXQw8iatfbZLpACr3jU2ssewTK853xF1BraXiawhwweQjicWrSQhEiaEYdqTuwpty6D6DaZlCK0Q/640?wx_fmt=png&quot; data-type=&quot;png&quot; data-ratio=&quot;0.28174123337363965&quot; data-w=&quot;827&quot;/&gt;&lt;/figure&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;TRUNC:&lt;/p&gt;&lt;figure data-tool=&quot;mdnice编辑器&quot;&gt;&lt;img data-src=&quot;https://mmbiz.qpic.cn/mmbiz_png/xBgIbW1vdNNib25DXQw8iatfbZLpACr3jU66bCfg94gTtQsJ1megibibEy3u3x9FxJTzibgxr2o1tox5tHGNZVO6Xew/640?wx_fmt=png&quot; data-type=&quot;png&quot; data-ratio=&quot;0.3383742911153119&quot; data-w=&quot;529&quot;/&gt;&lt;/figure&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;但是以 SNAP 方式同步的话就不会放入该队列，无论是 SNAP 消息还是之后整个序列化后的内存快照 snapshot 都会直接通过服务端间的 socket 直接写入。&lt;/p&gt;&lt;h3 data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span/&gt;2.2 上帝视角&lt;span/&gt;&lt;/h3&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;让我们把三种策略消息交互的全过程再看一遍，这里就以&lt;strong&gt;马小云&lt;/strong&gt;举例了&lt;/p&gt;&lt;h4 data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span/&gt;2.2.1 DIFF&lt;span/&gt;&lt;/h4&gt;&lt;figure data-tool=&quot;mdnice编辑器&quot;&gt;&lt;img data-src=&quot;https://mmbiz.qpic.cn/mmbiz_png/xBgIbW1vdNNib25DXQw8iatfbZLpACr3jU3BfQV98fiaGsiaNgj6E6P50thHLubEng4BiaqzNZt6NtwausicVx78o3Cw/640?wx_fmt=png&quot; data-type=&quot;png&quot; data-ratio=&quot;0.7311320754716981&quot; data-w=&quot;636&quot;/&gt;&lt;/figure&gt;&lt;h4 data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span/&gt;2.2.2 TRUNC&lt;span/&gt;&lt;/h4&gt;&lt;figure data-tool=&quot;mdnice编辑器&quot;&gt;&lt;img data-src=&quot;https://mmbiz.qpic.cn/mmbiz_png/xBgIbW1vdNNib25DXQw8iatfbZLpACr3jUsiaWibIXAU19QbT9iaJQOGNpBJpdRTIfBictCburywU9rqAY7tz7jenqSw/640?wx_fmt=png&quot; data-type=&quot;png&quot; data-ratio=&quot;0.5878693623639192&quot; data-w=&quot;643&quot;/&gt;&lt;/figure&gt;&lt;h4 data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span/&gt;2.2.3 SNAP&lt;span/&gt;&lt;/h4&gt;&lt;figure data-tool=&quot;mdnice编辑器&quot;&gt;&lt;img data-src=&quot;https://mmbiz.qpic.cn/mmbiz_png/xBgIbW1vdNNib25DXQw8iatfbZLpACr3jU2VvwgQOC9JsTk2RUtCe6juPoRQyq69QodokuAvEvDwlLwJRCD3xFAA/640?wx_fmt=png&quot; data-type=&quot;png&quot; data-ratio=&quot;0.6202143950995406&quot; data-w=&quot;653&quot;/&gt;&lt;/figure&gt;&lt;hr data-tool=&quot;mdnice编辑器&quot;/&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;可以看到首尾是一样的，就是中间的请求根据不同的策略会有不同的请求发送。差不多到这里关于 Follower 或 Observer 是如何同 Leader 同步消息，整体的逻辑都介绍完了。&lt;/p&gt;&lt;h3 data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span/&gt;2.3 小结&lt;span/&gt;&lt;/h3&gt;&lt;ul data-tool=&quot;mdnice编辑器&quot; class=&quot;list-paddingleft-2&quot;&gt;&lt;li&gt;&lt;section&gt;Follower 和 Observer 同步数据的方式一共有三种：DIFF、SNAP、TRUNC&lt;/section&gt;&lt;/li&gt;&lt;li&gt;&lt;section&gt;DIFF 需要 Follower 或 Observer 和 Leader 的数据相差在 min 和 max 范围内，或者配置了允许从 log 文件中恢复&lt;/section&gt;&lt;/li&gt;&lt;li&gt;&lt;section&gt;TRUNC 是当 Follower 或 Observer 的 zxid 比 Leader 还要大的时候，该节点需要主动删除多余 zxid 相关的数据，降级至 Leader 一致&lt;/section&gt;&lt;/li&gt;&lt;li&gt;&lt;section&gt;SNAP 作为最后的数据同步手段，由 Leader 直接将内存数据整个序列化完并发送给 Follower 或 Observer，以达到恢复数据的目的&lt;/section&gt;&lt;/li&gt;&lt;/ul&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;我看了下文章的字数还行，决定加一点料，开一个小篇讲一下 ACL，这个我拖了很久没解释的坑。&lt;/p&gt;&lt;figure data-tool=&quot;mdnice编辑器&quot;&gt;&lt;img data-src=&quot;https://mmbiz.qpic.cn/mmbiz_gif/xBgIbW1vdNNib25DXQw8iatfbZLpACr3jUbZKd5A27jS0ibSLyWsaFqqtYeibLZxxfkgAGdQSRib7KaxsZS1YKaxMicA/640?wx_fmt=gif&quot; data-type=&quot;gif&quot; data-ratio=&quot;1.2096774193548387&quot; data-w=&quot;186&quot;/&gt;&lt;/figure&gt;&lt;h2 data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span/&gt;&lt;span&gt;三、没有规矩，不成方圆&lt;/span&gt;&lt;span&gt; &lt;/span&gt;&lt;/h2&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;先带大家重拾记忆，之前创建节点代码片段中的 &lt;code&gt;ZooDefs.Ids.OPEN_ACL_UNSAFE&lt;/code&gt; 就是 ACL 的参数&lt;/p&gt;&lt;pre data-tool=&quot;mdnice编辑器&quot;&gt;&lt;code&gt;client.create(&lt;span&gt;&quot;/更新视频/跳舞/20201101&quot;&lt;/span&gt;, &lt;span&gt;&quot;这是Data，既可以记录一些业务数据也可以随便写&quot;&lt;/span&gt;.getBytes(), ZooDefs.Ids.OPEN_ACL_UNSAFE, CreateMode.PERSISTENT);&lt;br/&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;首先如果配置了 &lt;code&gt;zookeeper.skipACL&lt;/code&gt; 该参数为 &lt;code&gt;yes&lt;/code&gt;（注意大小写），表示当前节点放弃 ACL 校验，默认是 &lt;code&gt;no&lt;/code&gt;&lt;/p&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;那这个 ACL 是怎么规定的，有哪些权限，又是怎么在服务端体现的呢？首先 ACL 整体分为 Permission 和 Scheme 两部分，Permission 是针对操作的权限，而 Scheme 是指定使用哪一种鉴权模式，下面我们一起来了解下。&lt;/p&gt;&lt;h3 data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span/&gt;3.1 权限 Permission 介绍&lt;span/&gt;&lt;/h3&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;首先 ZK 将权限分为 5 种：&lt;/p&gt;&lt;ul data-tool=&quot;mdnice编辑器&quot; class=&quot;list-paddingleft-2&quot;&gt;&lt;li&gt;&lt;section&gt;READ（以下简称 R），获取节点数据或者获取子节点列表&lt;/section&gt;&lt;/li&gt;&lt;li&gt;&lt;section&gt;WRITE（以下简称 W），设置节点数据&lt;/section&gt;&lt;/li&gt;&lt;li&gt;&lt;section&gt;CREATE（以下简称 C），创建节点&lt;/section&gt;&lt;/li&gt;&lt;li&gt;&lt;section&gt;DELETE（以下简称 D），删除节点&lt;/section&gt;&lt;/li&gt;&lt;li&gt;&lt;section&gt;ADMIN（以下简称 A），设置节点的 ACL 权限&lt;/section&gt;&lt;/li&gt;&lt;/ul&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;然后该 5 种权限在代码层面就是简单的 int 数据，而判断是否有权限只需要用 &amp;amp; 操作即可，和目标权限 &amp;amp; 完结果只要不等于 0 就说明拥有该权限，细节如下：&lt;/p&gt;&lt;pre data-tool=&quot;mdnice编辑器&quot;&gt;&lt;code&gt;  int  binary&lt;br/&gt;R  1   00001&lt;br/&gt;W  2   00010&lt;br/&gt;C  4   00100&lt;br/&gt;D  8   01000&lt;br/&gt;A  16  10000&lt;br/&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;假设现在的客户端权限为 RWC，对应的数值就是各个权限相加 &lt;code&gt;1 + 2 + 4 = 7&lt;/code&gt;&lt;/p&gt;&lt;pre data-tool=&quot;mdnice编辑器&quot;&gt;&lt;code&gt;  int  binary&lt;br/&gt;RWC 7   00111&lt;br/&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;对任意有 R、W、C 权限需求的节点，求 &amp;amp; 的结果都不为 0，所以就能判断该客户端是拥有 RWC 这 3 个权限的。&lt;/p&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;但是如果当该客户端对目标节点进行删除时，做 &amp;amp; 判断权限的话，可以得到结果为 0，表示该客户端不具备删除的权限，就会返回给客户端权限错误&lt;/p&gt;&lt;pre data-tool=&quot;mdnice编辑器&quot;&gt;&lt;code&gt;  int  binary&lt;br/&gt;RWC 7   00111&lt;br/&gt;D  8  &amp;amp; 01000&lt;br/&gt;------------------&lt;br/&gt;结果 0   00000&lt;br/&gt;&lt;/code&gt;&lt;/pre&gt;&lt;h3 data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span/&gt;3.2 Scheme 介绍&lt;span/&gt;&lt;/h3&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;Scheme 有 4 种，分别是 &lt;code&gt;ip&lt;/code&gt;、&lt;code&gt;world&lt;/code&gt;、&lt;code&gt;digest&lt;/code&gt;、&lt;code&gt;super&lt;/code&gt;，但是其实就是两大类，一种是针对 IP 地址的 ip，另一种是使用类似“用户名:密码”的 &lt;code&gt;world&lt;/code&gt;、&lt;code&gt;digest&lt;/code&gt;、&lt;code&gt;super&lt;/code&gt;。其实整个 ACL 是分三个部分的，&lt;code&gt;scheme:id:perms&lt;/code&gt; ，id 的取值取决于 scheme 的种类，这里是 ip 所以 id 的取值就是具体的 IP 地址，而 perms 则是我上一小节介绍的 RWCDA。&lt;/p&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;这三部分的前两部分 &lt;code&gt;scheme:id&lt;/code&gt; 相当于告诉服务端 “我是谁？”，而最后的部分 &lt;code&gt;perms&lt;/code&gt; 则是代表了 “我能做什么？”，这两个问题，任意一个问题出错都会导致服务端抛出 &lt;code&gt;NoAuthException&lt;/code&gt; 的异常，告诉客户端权限不够。&lt;/p&gt;&lt;h4 data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span/&gt;3.2.1 IP&lt;span/&gt;&lt;/h4&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;我们先来直接看一段代码，其中的 IP &lt;code&gt;10.11.12.13&lt;/code&gt; 我是随便写的&lt;/p&gt;&lt;pre data-tool=&quot;mdnice编辑器&quot;&gt;&lt;code&gt;ZooKeeper client = &lt;span&gt;new&lt;/span&gt; ZooKeeper(&lt;span&gt;&quot;127.0.0.1:2181&quot;&lt;/span&gt;, &lt;span&gt;3000&lt;/span&gt;, &lt;span&gt;null&lt;/span&gt;);&lt;br/&gt;List&amp;lt;ACL&amp;gt; aclList = &lt;span&gt;new&lt;/span&gt; ArrayList&amp;lt;&amp;gt;();&lt;br/&gt;aclList.add(&lt;span&gt;new&lt;/span&gt; ACL(ZooDefs.Perms.ALL, &lt;span&gt;new&lt;/span&gt; Id(&lt;span&gt;&quot;ip&quot;&lt;/span&gt;, &lt;span&gt;&quot;10.11.12.13&quot;&lt;/span&gt;)));&lt;br/&gt;String path = client.create(&lt;span&gt;&quot;/abc&quot;&lt;/span&gt;, &lt;span&gt;&quot;test&quot;&lt;/span&gt;.getBytes(), aclList, CreateMode.PERSISTENT);&lt;br/&gt;System.out.println(path); &lt;span&gt;// 输出 /abc&lt;/span&gt;&lt;br/&gt;client.close();&lt;br/&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;可以看到 &lt;code&gt;/abc&lt;/code&gt; 是可以被正确输出的，而且通过查看 &lt;code&gt;/&lt;/code&gt; 的子节点列表是可以看到 &lt;code&gt;/abc&lt;/code&gt; 节点的&lt;/p&gt;&lt;pre data-tool=&quot;mdnice编辑器&quot;&gt;&lt;code&gt;ZooKeeper client = &lt;span&gt;new&lt;/span&gt; ZooKeeper(&lt;span&gt;&quot;127.0.0.1:2181&quot;&lt;/span&gt;, &lt;span&gt;3000&lt;/span&gt;, &lt;span&gt;null&lt;/span&gt;);&lt;br/&gt;List&amp;lt;String&amp;gt; children = client.getChildren(&lt;span&gt;&quot;/&quot;&lt;/span&gt;, &lt;span&gt;false&lt;/span&gt;);&lt;br/&gt;System.out.println(children); &lt;span&gt;// 输出 [abc, zookeeper]&lt;/span&gt;&lt;br/&gt;client.close();&lt;br/&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;但是现在如果去访问该节点的数据的话就会得到报错&lt;/p&gt;&lt;pre data-tool=&quot;mdnice编辑器&quot;&gt;&lt;code&gt;ZooKeeper client = &lt;span&gt;new&lt;/span&gt; ZooKeeper(&lt;span&gt;&quot;127.0.0.1:2181&quot;&lt;/span&gt;, &lt;span&gt;3000&lt;/span&gt;, &lt;span&gt;null&lt;/span&gt;);&lt;br/&gt;&lt;span&gt;byte&lt;/span&gt;[] data = client.getData(&lt;span&gt;&quot;/abc&quot;&lt;/span&gt;, &lt;span&gt;false&lt;/span&gt;, &lt;span&gt;null&lt;/span&gt;);&lt;br/&gt;System.out.println(&lt;span&gt;new&lt;/span&gt; String(data));&lt;br/&gt;client.close();&lt;br/&gt;&lt;/code&gt;&lt;/pre&gt;&lt;pre data-tool=&quot;mdnice编辑器&quot;&gt;&lt;code&gt;Exception &lt;span&gt;in&lt;/span&gt; thread &lt;span&gt;&quot;main&quot;&lt;/span&gt; org.apache.zookeeper.KeeperException&lt;span&gt;$NoAuthException&lt;/span&gt;: KeeperErrorCode = NoAuth &lt;span&gt;for&lt;/span&gt; /abc&lt;br/&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;读者可以试试把上面的 IP 改成 &lt;code&gt;127.0.0.1&lt;/code&gt; 重新创建节点，之后就能正常访问了，一般生产环境中 IP 模式用的不多（也可能是我用的不多），如果要用 IP 控制访问的话，通过防火墙白名单之类的手段即可，这个层面我认为不需要 ZK 去管。&lt;/p&gt;&lt;h4 data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span/&gt;3.2.2 World&lt;span/&gt;&lt;/h4&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;这个模式应该是最常用的（手动狗头）&lt;/p&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;我们还是来看一段代码&lt;/p&gt;&lt;pre data-tool=&quot;mdnice编辑器&quot;&gt;&lt;code&gt;ZooKeeper client = &lt;span&gt;new&lt;/span&gt; ZooKeeper(&lt;span&gt;&quot;127.0.0.1:2181&quot;&lt;/span&gt;, &lt;span&gt;3000&lt;/span&gt;, &lt;span&gt;null&lt;/span&gt;);&lt;br/&gt;List&amp;lt;ACL&amp;gt; aclList = &lt;span&gt;new&lt;/span&gt; ArrayList&amp;lt;&amp;gt;();&lt;br/&gt;aclList.add(&lt;span&gt;new&lt;/span&gt; ACL(ZooDefs.Perms.READ, &lt;span&gt;new&lt;/span&gt; Id(&lt;span&gt;&quot;world&quot;&lt;/span&gt;, &lt;span&gt;&quot;anyone&quot;&lt;/span&gt;))); &lt;span&gt;// 区别是这行&lt;/span&gt;&lt;br/&gt;String path = client.create(&lt;span&gt;&quot;/abc&quot;&lt;/span&gt;, &lt;span&gt;&quot;test&quot;&lt;/span&gt;.getBytes(), aclList, CreateMode.PERSISTENT);&lt;br/&gt;System.out.println(path); &lt;span&gt;// 输出 /abc&lt;/span&gt;&lt;br/&gt;client.close();&lt;br/&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;我把 scheme 改成了 World 模式，而 World 模式的 id 取值就是固定的 anyone 不能用其他值，而且我还设置了 perms 为 R，所以这个节点只能读数据，但不能做其他操作，如果使用 &lt;code&gt;setData&lt;/code&gt; 对其进行数据修改的话也会得到权限的错误&lt;/p&gt;&lt;pre data-tool=&quot;mdnice编辑器&quot;&gt;&lt;code&gt;ZooKeeper client = &lt;span&gt;new&lt;/span&gt; ZooKeeper(&lt;span&gt;&quot;127.0.0.1:2181&quot;&lt;/span&gt;, &lt;span&gt;3000&lt;/span&gt;, &lt;span&gt;null&lt;/span&gt;);&lt;br/&gt;Stat stat = client.setData(&lt;span&gt;&quot;/abc&quot;&lt;/span&gt;, &lt;span&gt;&quot;newData&quot;&lt;/span&gt;.getBytes(), -&lt;span&gt;1&lt;/span&gt;); &lt;span&gt;// NoAuth for /abc&lt;/span&gt;&lt;br/&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;现在再回头看之前的 &lt;code&gt;ZooDefs.Ids.OPEN_ACL_UNSAFE&lt;/code&gt;，其实就是 ZK 提供的常用的静态常量，代表不校验权限&lt;/p&gt;&lt;pre data-tool=&quot;mdnice编辑器&quot;&gt;&lt;code&gt;Id ANYONE_ID_UNSAFE = &lt;span&gt;new&lt;/span&gt; Id(&lt;span&gt;&quot;world&quot;&lt;/span&gt;, &lt;span&gt;&quot;anyone&quot;&lt;/span&gt;);&lt;br/&gt;ArrayList&amp;lt;ACL&amp;gt; OPEN_ACL_UNSAFE = &lt;span&gt;new&lt;/span&gt; ArrayList&amp;lt;ACL&amp;gt;(Collections.singletonList(&lt;span&gt;new&lt;/span&gt; ACL(Perms.ALL, ANYONE_ID_UNSAFE)));&lt;br/&gt;&lt;/code&gt;&lt;/pre&gt;&lt;h4 data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span/&gt;3.2.3 Digest&lt;span/&gt;&lt;/h4&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;这个就是我们熟悉的用户名密码了，还是先上代码&lt;/p&gt;&lt;pre data-tool=&quot;mdnice编辑器&quot;&gt;&lt;code&gt;ZooKeeper client = &lt;span&gt;new&lt;/span&gt; ZooKeeper(&lt;span&gt;&quot;127.0.0.1:2181&quot;&lt;/span&gt;, &lt;span&gt;3000&lt;/span&gt;, &lt;span&gt;null&lt;/span&gt;);&lt;br/&gt;&lt;br/&gt;List&amp;lt;ACL&amp;gt; aclList = &lt;span&gt;new&lt;/span&gt; ArrayList&amp;lt;&amp;gt;();&lt;br/&gt;aclList.add(&lt;span&gt;new&lt;/span&gt; ACL(ZooDefs.Perms.ALL, &lt;br/&gt;  &lt;span&gt;new&lt;/span&gt; Id(&lt;span&gt;&quot;digest&quot;&lt;/span&gt;, DigestAuthenticationProvider.generateDigest(&lt;span&gt;&quot;laoxun:kaixin&quot;&lt;/span&gt;)))); &lt;span&gt;// 1&lt;/span&gt;&lt;br/&gt;&lt;br/&gt;String path = client.create(&lt;span&gt;&quot;/abc&quot;&lt;/span&gt;, &lt;span&gt;&quot;test&quot;&lt;/span&gt;.getBytes(), aclList, CreateMode.PERSISTENT);&lt;br/&gt;System.out.println(path);&lt;br/&gt;client.close();&lt;br/&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;这个写法中必须要注意的是 1 处的 &lt;code&gt;username:password&lt;/code&gt; 的字符串必须通过 &lt;code&gt;DigestAuthenticationProvider.generateDigest&lt;/code&gt; 的方法包装一下，用这个方法会对传入的字符串进行编码。&lt;/p&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;包装完后 &lt;code&gt;laoxun:kaixin&lt;/code&gt; 其实变成了 &lt;code&gt;laoxun:/xQjqfEf7WHKtjj2csJh1/aEee8=&lt;/code&gt;，这个过程如下：&lt;/p&gt;&lt;ul data-tool=&quot;mdnice编辑器&quot; class=&quot;list-paddingleft-2&quot;&gt;&lt;li&gt;&lt;section&gt;&lt;code&gt;laoxun:kaixin&lt;/code&gt; 对整个字符串先进行 SHA1 加密&lt;/section&gt;&lt;/li&gt;&lt;li&gt;&lt;section&gt;对加密后的结果进行 Base64 编码&lt;/section&gt;&lt;/li&gt;&lt;li&gt;&lt;section&gt;将用户名和编码后的结果拼接&lt;/section&gt;&lt;/li&gt;&lt;/ul&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;上面的代码还有一种写法如下，使用 &lt;code&gt;addAuthInfo&lt;/code&gt; 在客户端上下文中添加权限信息&lt;/p&gt;&lt;pre data-tool=&quot;mdnice编辑器&quot;&gt;&lt;code&gt;ZooKeeper client = &lt;span&gt;new&lt;/span&gt; ZooKeeper(&lt;span&gt;&quot;127.0.0.1:2181&quot;&lt;/span&gt;, &lt;span&gt;3000&lt;/span&gt;, &lt;span&gt;null&lt;/span&gt;);&lt;br/&gt;client.addAuthInfo(&lt;span&gt;&quot;digest&quot;&lt;/span&gt;, &lt;span&gt;&quot;laoxun:kaixin&quot;&lt;/span&gt;.getBytes()); &lt;span&gt;// 1. &lt;/span&gt;&lt;br/&gt;List&amp;lt;ACL&amp;gt; aclList = &lt;span&gt;new&lt;/span&gt; ArrayList&amp;lt;&amp;gt;();&lt;br/&gt;aclList.add(&lt;span&gt;new&lt;/span&gt; ACL(ZooDefs.Perms.ALL, &lt;span&gt;new&lt;/span&gt; Id(&lt;span&gt;&quot;auth&quot;&lt;/span&gt;, &lt;span&gt;&quot;&quot;&lt;/span&gt;))); &lt;span&gt;// 2. 这里的 Id 是固定写法&lt;/span&gt;&lt;br/&gt;String path = client.create(&lt;span&gt;&quot;/abc&quot;&lt;/span&gt;, &lt;span&gt;&quot;test&quot;&lt;/span&gt;.getBytes(), aclList, CreateMode.PERSISTENT);&lt;br/&gt;System.out.println(path);&lt;br/&gt;client.close();&lt;br/&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;这里有两个改动，在 1 处使用 &lt;code&gt;addAuthInfo&lt;/code&gt; 的方法可以在当前客户端的会话中添加 auth 信息，Digest 的 id 取值为 &lt;code&gt;username:password&lt;/code&gt; 直接用明文即可，无论是 username 还是 password 都是自定义的。&lt;/p&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;然后是查询代码&lt;/p&gt;&lt;pre data-tool=&quot;mdnice编辑器&quot;&gt;&lt;code&gt;ZooKeeper client = &lt;span&gt;new&lt;/span&gt; ZooKeeper(&lt;span&gt;&quot;127.0.0.1:2181&quot;&lt;/span&gt;, &lt;span&gt;3000&lt;/span&gt;, &lt;span&gt;null&lt;/span&gt;);&lt;br/&gt;client.addAuthInfo(&lt;span&gt;&quot;digest&quot;&lt;/span&gt;, &lt;span&gt;&quot;laoxun:kaixin&quot;&lt;/span&gt;.getBytes()); &lt;span&gt;// 这行如果注释的话就会报错&lt;/span&gt;&lt;br/&gt;&lt;span&gt;byte&lt;/span&gt;[] data = client.getData(&lt;span&gt;&quot;/abc&quot;&lt;/span&gt;, &lt;span&gt;false&lt;/span&gt;, &lt;span&gt;null&lt;/span&gt;);&lt;br/&gt;System.out.println(&lt;span&gt;new&lt;/span&gt; String(data)); &lt;span&gt;// test&lt;/span&gt;&lt;br/&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;不管创建的时候是何种写法，查询的时候都要使用 &lt;code&gt;addAuthInfo&lt;/code&gt; 在会话中添加权限信息，才能对该节点进行查询&lt;/p&gt;&lt;h4 data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span/&gt;3.2.4 Super&lt;span/&gt;&lt;/h4&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;听名字就知道这个模式是管理员的模式了，因为之前创建的那些节点，如果设置了用户名密码，其他客户端是无法访问的，如果该客户端自己退出了，这些节点就无法去操作了，所以需要管理员这一个角色来对其进行降维打击。&lt;/p&gt;&lt;figure data-tool=&quot;mdnice编辑器&quot;&gt;&lt;img data-src=&quot;https://mmbiz.qpic.cn/mmbiz_png/xBgIbW1vdNNib25DXQw8iatfbZLpACr3jUd13ibOzOD0V6SGsZdRCibZCSjn7zo9vn2EWjPyGx7ITS52KSN224dK6A/640?wx_fmt=png&quot; data-type=&quot;png&quot; data-ratio=&quot;1&quot; data-w=&quot;240&quot;/&gt;&lt;/figure&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;首先 Super 模式是要开启的，我这里假设管理员的用户名为 HelloZooKeeper，密码为 niubi，经过编码后就是 &lt;code&gt;HelloZooKeeper:PT8Sb6Exg9YyPCS7fYraLCsqzR8=&lt;/code&gt;， 然后需要在服务端启动的环境中指定 &lt;code&gt;zookeeper.DigestAuthenticationProvider.superDigest&lt;/code&gt; 配置，参数就是 &lt;code&gt;HelloZooKeeper:PT8Sb6Exg9YyPCS7fYraLCsqzR8=&lt;/code&gt; 即可。&lt;/p&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;创建节点假设还是以 &lt;code&gt;laoxun:kaixin&lt;/code&gt; 的模式，然后通过管理员的密码也能进行正常的访问&lt;/p&gt;&lt;pre data-tool=&quot;mdnice编辑器&quot;&gt;&lt;code&gt;ZooKeeper client = &lt;span&gt;new&lt;/span&gt; ZooKeeper(&lt;span&gt;&quot;127.0.0.1:2181&quot;&lt;/span&gt;, &lt;span&gt;3000&lt;/span&gt;, &lt;span&gt;null&lt;/span&gt;);&lt;br/&gt;client.addAuthInfo(&lt;span&gt;&quot;digest&quot;&lt;/span&gt;, &lt;span&gt;&quot;HelloZooKeeper:niubi&quot;&lt;/span&gt;.getBytes()); &lt;span&gt;// 1.&lt;/span&gt;&lt;br/&gt;&lt;span&gt;byte&lt;/span&gt;[] data = client.getData(&lt;span&gt;&quot;/abc&quot;&lt;/span&gt;, &lt;span&gt;false&lt;/span&gt;, &lt;span&gt;null&lt;/span&gt;);&lt;br/&gt;System.out.println(&lt;span&gt;new&lt;/span&gt; String(data)); &lt;span&gt;// test&lt;/span&gt;&lt;br/&gt;client.close();&lt;br/&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;这里可以看到 1 处的 Super 模式本质上还是 Digest，指定的 scheme 为 digest，然后之后的 id 取值采用的是明文，而非编码后的格式，切记！&lt;/p&gt;&lt;h3 data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span/&gt;3.3 Permission 汇总表格&lt;span/&gt;&lt;/h3&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;我这里列出大部分服务端提供的操作对应的 Permission 权限：&lt;/p&gt;&lt;section data-tool=&quot;mdnice编辑器&quot;&gt;&lt;table&gt;&lt;thead&gt;&lt;tr&gt;&lt;th&gt;操作&lt;/th&gt;&lt;th&gt;所需权限&lt;/th&gt;&lt;th&gt;描述&lt;/th&gt;&lt;/tr&gt;&lt;/thead&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td&gt;create&lt;/td&gt;&lt;td&gt;父节点的 CREATE&lt;/td&gt;&lt;td&gt;创建节点&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td&gt;create2&lt;/td&gt;&lt;td&gt;父节点的 CREATE&lt;/td&gt;&lt;td&gt;创建节点，同时返回节点数据&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td&gt;createContainer&lt;/td&gt;&lt;td&gt;父节点的 CREATE&lt;/td&gt;&lt;td&gt;创建容器节点&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td&gt;createTTL&lt;/td&gt;&lt;td&gt;父节点的 CREATE&lt;/td&gt;&lt;td&gt;创建带超时时间的节点&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td&gt;delete&lt;/td&gt;&lt;td&gt;父节点的 DELETE&lt;/td&gt;&lt;td&gt;删除节点&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td&gt;setData&lt;/td&gt;&lt;td&gt;当前节点的 WRITE&lt;/td&gt;&lt;td&gt;设置节点数据&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td&gt;setACL&lt;/td&gt;&lt;td&gt;当前节点的 ADMIN&lt;/td&gt;&lt;td&gt;设置节点的权限信息&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td&gt;reconfig&lt;/td&gt;&lt;td&gt;当前节点的 WRITE&lt;/td&gt;&lt;td&gt;重新设置一些配置（之后有机会介绍）&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td&gt;getData&lt;/td&gt;&lt;td&gt;当前节点的 READ&lt;/td&gt;&lt;td&gt;查询节点数据&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td&gt;getChildren&lt;/td&gt;&lt;td&gt;当前节点的 READ&lt;/td&gt;&lt;td&gt;获取子节点列表&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td&gt;getChildren2&lt;/td&gt;&lt;td&gt;当前节点的 READ&lt;/td&gt;&lt;td&gt;获取子节点列表&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td&gt;getAllChildrenNumber&lt;/td&gt;&lt;td&gt;当前节点的 READ&lt;/td&gt;&lt;td&gt;获取所有子节点（包含孙子节点）数量&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td&gt;getACL&lt;/td&gt;&lt;td&gt;当前节点的 ADMIN 或 READ&lt;/td&gt;&lt;td&gt;获取节点的权限信息&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/section&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;可以看到删除和创建节点看的是父节点的权限，只有读写才是看的自己本身的权限。另外如果表格中没有出现的操作可以认为不需要 ACL 权限校验，其他要么是只需要客户端是一个合法的 session 或者本身是一些比较特殊的功能，例如：createSession、closeSession 等。至于关于 session 的更多内容，留到下一篇再讲吧～哈哈&lt;/p&gt;&lt;figure data-tool=&quot;mdnice编辑器&quot;&gt;&lt;img data-src=&quot;https://mmbiz.qpic.cn/mmbiz_png/xBgIbW1vdNNib25DXQw8iatfbZLpACr3jUxjdxS29O4fmc2C4N9qzjU8MPDVFO1LriapJM8wWSGbhVwQ5J8VWJNgQ/640?wx_fmt=png&quot; data-type=&quot;png&quot; data-ratio=&quot;1&quot; data-w=&quot;255&quot;/&gt;&lt;/figure&gt;&lt;h3 data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span/&gt;3.4 ACL 背后的原理&lt;span/&gt;&lt;/h3&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;我们刚刚花了一点篇幅介绍了 ACL 是什么，怎么用？现在深入了解下 ACL 在 ZK 的服务端底层是怎么去实现的吧～为了节约篇幅，这次就直接进入猿话讲解了。&lt;/p&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;首先祭出之前的一张图，唤醒下大家的记忆&lt;/p&gt;&lt;figure data-tool=&quot;mdnice编辑器&quot;&gt;&lt;img data-src=&quot;https://mmbiz.qpic.cn/mmbiz_png/xBgIbW1vdNNib25DXQw8iatfbZLpACr3jUxgdcZeG9QKmjgsVDlWNfnKjTQaQn245HyicufVGNs0f5EgJVFUBvRFg/640?wx_fmt=png&quot; data-type=&quot;png&quot; data-ratio=&quot;0.4935064935064935&quot; data-w=&quot;1078&quot;/&gt;&lt;/figure&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;图中权限部分（蓝色字体）之前的文章直接省略跳过了，没有进行解释，今天我们就好好讲讲这个权限字段。&lt;/p&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;从图上也能看到权限这个字段是直接以数字（long 类型，64 位的整型数字）的方式保存在服务端的节点中的，而 -1 是一个特殊的值代表不进行权限的校验对应的就是之前的 &lt;code&gt;OPEN_ACL_UNSAFE&lt;/code&gt; 常量。&lt;/p&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;而 ACL 权限无论是创建节点时提供的（ACL 参数是一个 List），还是通过 &lt;code&gt;addAuth&lt;/code&gt; 方法提供的（这个方法可以被调用多次），这两种设计都表示一个客户端是可以拥有多种权限的，比如：多个用户名密码，多个 IP 地址等等。&lt;/p&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;ACL 我之前讲过是由 3 个部分组成的，即 &lt;code&gt;scheme:id:perms&lt;/code&gt; 为了简洁的表示我会在之后使用该形式去表示一个 ACL。&lt;/p&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;服务端会使用两个哈希表把目前接收到的 ACL 列表和其对应的数字双向的关系保存起来，类似这样（图中的 ACL 取值是我随意编造的）：&lt;/p&gt;&lt;figure data-tool=&quot;mdnice编辑器&quot;&gt;&lt;img data-src=&quot;https://mmbiz.qpic.cn/mmbiz_png/xBgIbW1vdNNib25DXQw8iatfbZLpACr3jUk1C2GPu3dcLoBRu7SyRq5Gp76zScqr71wSxBC6dOOGslvlGR3zon8Q/640?wx_fmt=png&quot; data-type=&quot;png&quot; data-ratio=&quot;0.7423167848699763&quot; data-w=&quot;846&quot;/&gt;&lt;/figure&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;ZK 服务端会维护一个从 1 开始的数字，收到一个新的 ACL 会同时放入这两个哈希表（源码中对应的就是两个 &lt;code&gt;Map&lt;/code&gt;，一个是 &lt;code&gt;Map&amp;lt;List&amp;lt;ACL&amp;gt;, Long&amp;gt;&lt;/code&gt;，一个是 &lt;code&gt;Map&amp;lt;Long, List&amp;lt;ACL&amp;gt;&amp;gt;&lt;/code&gt;），除了这两个哈希表以外，ZK 服务端还为每一个客户端都维护了一个会话中的权限信息，该权限信息就是客户端通过 &lt;code&gt;addAuth&lt;/code&gt; 添加的，但是这个客户端的权限信息只保存了 &lt;code&gt;scheme:id&lt;/code&gt; 部分，所以结合以下三个信息就可以对客户端的本次操作进行权限校验了：&lt;/p&gt;&lt;ul data-tool=&quot;mdnice编辑器&quot; class=&quot;list-paddingleft-2&quot;&gt;&lt;li&gt;&lt;section&gt;两个哈希表表示的节点的信息 &lt;code&gt;scheme:id:perms&lt;/code&gt;，可以有多个&lt;/section&gt;&lt;/li&gt;&lt;li&gt;&lt;section&gt;客户端会话上下文中的权限信息仅 &lt;code&gt;id:perms&lt;/code&gt; ，可以有多个&lt;/section&gt;&lt;/li&gt;&lt;li&gt;&lt;section&gt;本次操作对应的权限要求，即 3.3 表格中列出的所需权限&lt;/section&gt;&lt;/li&gt;&lt;/ul&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;校验的流程如下：&lt;/p&gt;&lt;figure data-tool=&quot;mdnice编辑器&quot;&gt;&lt;img data-src=&quot;https://mmbiz.qpic.cn/mmbiz_png/xBgIbW1vdNNib25DXQw8iatfbZLpACr3jUicw3UTFlfRuqiaIasstVV2ibNYCuLiayGfVbSSGAS3f4veCJIWKKHPv4mA/640?wx_fmt=png&quot; data-type=&quot;png&quot; data-ratio=&quot;0.2361111111111111&quot; data-w=&quot;1080&quot;/&gt;&lt;/figure&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;这里额外提一下，校验器是可以自定义的，用户可以自定义自己的 scheme 以及自己的校验逻辑，需要在服务端的环境变量中配置以 &lt;code&gt;zookeeper.authProvider.&lt;/code&gt; 开头的配置，对应的值则对应一个 class 类全路径，这个类必须实现 &lt;code&gt;org.apache.zookeeper.server.auth.AuthenticationProvider&lt;/code&gt; 接口，而且这个类必须能被 ZK 服务端加载到，这样就可以解析自定义的 scheme 控制整个校验逻辑了，这个功能比较高级，我也没用过，大家就当补充知识了解下～&lt;/p&gt;&lt;hr data-tool=&quot;mdnice编辑器&quot;/&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;今天我们了解了 Follower 和 Observer 是如何同 Leader 进行数据同步的，以及 ZK 提供的权限管理 ACL 究竟是怎么回事，下一篇我们将聊聊 ZK 的 session 管理，客户端和服务端之间是怎么保持会话的，以及服务端不同节点之间的心跳又是怎么保持的？&lt;/p&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;最后给文章点个赞吧～什么？你说不想点？&lt;/p&gt;&lt;figure data-tool=&quot;mdnice编辑器&quot;&gt;&lt;img data-src=&quot;https://mmbiz.qpic.cn/mmbiz_gif/xBgIbW1vdNNib25DXQw8iatfbZLpACr3jUDPFxpURR6Vx2etlibbvyVrqNX53icHUXLYAOs6ZRibAL1RzHggj1hh18A/640?wx_fmt=gif&quot; data-type=&quot;gif&quot; data-ratio=&quot;1&quot; data-w=&quot;500&quot;/&gt;&lt;/figure&gt;&lt;section data-tool=&quot;mdnice编辑器&quot; data-website=&quot;https://www.mdnice.com&quot;&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;老规矩，如果你有任何对文章中的疑问也可以是建议或者是对 ZK 原理部分的疑问，欢迎来仓库中提问，或者&lt;strong&gt;&lt;span&gt;阅读原文&lt;/span&gt;&lt;/strong&gt;来语雀话题讨论。&lt;/p&gt;&lt;blockquote data-tool=&quot;mdnice编辑器&quot;&gt;&lt;p&gt;地址：https://github.com/HelloGitHub-Team/HelloZooKeeper&lt;/p&gt;&lt;/blockquote&gt;&lt;/section&gt;&lt;section data-tool=&quot;mdnice编辑器&quot; data-website=&quot;https://www.mdnice.com&quot;&gt;&lt;p&gt;&lt;img data-ratio=&quot;0.08108108108108109&quot; data-type=&quot;png&quot; data-w=&quot;1258&quot; data-src=&quot;https://mmbiz.qpic.cn/mmbiz_png/wKOZZiacmHTc9LIKRXddrzz6MosLdiaH4EQNQgzsrSXHObdAia8yeIlLz6MbK9FxNDr44G7FNb2DBufqkjpwiczAibA/640?wx_fmt=png&quot;/&gt;&lt;/p&gt;&lt;/section&gt;&lt;section class=&quot;mp_profile_iframe_wrp&quot;&gt;&lt;mpprofile class=&quot;js_uneditable custom_select_card mp_profile_iframe&quot; data-pluginname=&quot;mpprofile&quot; data-id=&quot;MzA5MzYyNzQ0MQ==&quot; data-headimg=&quot;http://mmbiz.qpic.cn/mmbiz_png/xBgIbW1vdNOqkqThUJBICyFBlvLvTyOCgBpibwWotSxGExfnOYFfPiaL9yn3GMUOCEVYN2RNslGCdQwgZy6ticdyA/0?wx_fmt=png&quot; data-nickname=&quot;HelloGitHub&quot; data-alias=&quot;GitHub520&quot; data-signature=&quot;分享 GitHub 上有趣、入门级的开源项目。&quot;/&gt;&lt;/section&gt;&lt;p&gt;&lt;strong&gt;&lt;span&gt;&lt;strong&gt;&lt;span&gt;&lt;strong&gt;&lt;span&gt;👆「点击关注」&lt;/span&gt;&lt;/strong&gt;更多惊喜等待你！&lt;/span&gt;&lt;/strong&gt;&lt;/span&gt;&lt;/strong&gt;&lt;/p&gt;&lt;/section&gt;
                &lt;/div&gt;&lt;/div&gt;</content:encoded>
</item>
<item>
<guid>c454488277b2d6e15851cdd1ab6ad4db</guid>
<title>京东个性化推荐系统解析</title>
<link>https://toutiao.io/k/icrka3o</link>
<content:encoded>&lt;div&gt;&lt;div&gt;&lt;div class=&quot;rich_media_content &quot; id=&quot;js_content&quot;&gt;
                    

                    
                    
                    
                    &lt;section data-role=&quot;outer&quot; label=&quot;Powered by 135editor.com&quot; data-mpa-powered-by=&quot;yiban.io&quot;&gt;&lt;section data-tools=&quot;135编辑器&quot; data-id=&quot;27&quot;&gt;&lt;section data-tools=&quot;135编辑器&quot; data-id=&quot;27&quot; data-custom=&quot;#1e9be8&quot;&gt;&lt;section&gt;&lt;section&gt;&lt;section&gt;&lt;section data-brushtype=&quot;text&quot;&gt;点击标题下「&lt;em&gt;&lt;strong&gt;搜索与推荐Wiki&lt;/strong&gt;&lt;/em&gt;」可快速关注&lt;/section&gt;&lt;/section&gt;&lt;/section&gt;&lt;/section&gt;&lt;/section&gt;&lt;/section&gt;&lt;/section&gt;&lt;section data-role=&quot;outer&quot; label=&quot;Powered by 135editor.com&quot;&gt;&lt;section data-tools=&quot;135编辑器&quot; data-id=&quot;93040&quot;&gt;&lt;section data-role=&quot;outer&quot; label=&quot;Powered by 135editor.com&quot;&gt;&lt;section data-tools=&quot;135编辑器&quot; data-id=&quot;92886&quot;&gt;&lt;section&gt;&lt;section&gt;&lt;section&gt;▼&lt;/section&gt;&lt;section data-brushtype=&quot;text&quot;&gt;&lt;span&gt;&lt;strong&gt;相关推荐&lt;/strong&gt;&lt;/span&gt;&lt;/section&gt;&lt;section&gt;▼&lt;/section&gt;&lt;/section&gt;&lt;section&gt;&lt;section data-brushtype=&quot;text&quot;&gt;&lt;span&gt;&lt;strong&gt;1、&lt;/strong&gt;&lt;/span&gt;&lt;a target=&quot;_blank&quot; href=&quot;http://mp.weixin.qq.com/s?__biz=MzI2MDU3OTgyOQ==&amp;amp;mid=2247494249&amp;amp;idx=1&amp;amp;sn=030794352316f7c728cfc0dae1fd4d04&amp;amp;chksm=ea6522f3dd12abe5e92df1eaaa1ce5fefa76515e1b64f9eb5e0ddec9e34785021dc317e33c8c&amp;amp;scene=21#wechat_redirect&quot; data-itemshowtype=&quot;0&quot; tab=&quot;innerlink&quot; data-linktype=&quot;2&quot;&gt;&lt;span&gt;&lt;strong&gt;AUC和线上点击率指标不一致问题分析&lt;/strong&gt;&lt;/span&gt;&lt;/a&gt;&lt;/section&gt;&lt;section data-brushtype=&quot;text&quot;&gt;&lt;strong&gt;2&lt;/strong&gt;&lt;span&gt;、&lt;/span&gt;&lt;a target=&quot;_blank&quot; href=&quot;http://mp.weixin.qq.com/s?__biz=MzI2MDU3OTgyOQ==&amp;amp;mid=2247494204&amp;amp;idx=1&amp;amp;sn=1d0535badee0361af63cddcfe9ac88fa&amp;amp;chksm=ea6522a6dd12abb0df0cf7ffeb800dad5f59d7fb03fd8b188bdb3912c3b47db479a01c7ca170&amp;amp;scene=21#wechat_redirect&quot; data-itemshowtype=&quot;0&quot; tab=&quot;innerlink&quot; data-linktype=&quot;2&quot;&gt;&lt;span&gt;&lt;strong&gt;电商指标详细介绍和推荐系统常用评估指标&lt;/strong&gt;&lt;/span&gt;&lt;/a&gt;&lt;/section&gt;&lt;section data-brushtype=&quot;text&quot;&gt;&lt;strong&gt;3、&lt;/strong&gt;&lt;a target=&quot;_blank&quot; href=&quot;http://mp.weixin.qq.com/s?__biz=MzI2MDU3OTgyOQ==&amp;amp;mid=2247494219&amp;amp;idx=1&amp;amp;sn=249d2d84a21877c622a19f7bfc9e3a05&amp;amp;chksm=ea6522d1dd12abc74c34413986e247e0bd66d33e17babd1bb25cf7405eb0b81f03536fb44e78&amp;amp;scene=21#wechat_redirect&quot; data-itemshowtype=&quot;0&quot; tab=&quot;innerlink&quot; data-linktype=&quot;2&quot;&gt;&lt;span&gt;&lt;strong&gt;算法工程师的自我修养&lt;/strong&gt;&lt;/span&gt;&lt;/a&gt;&lt;/section&gt;&lt;section data-brushtype=&quot;text&quot;&gt;&lt;span&gt;&lt;strong&gt;作者：fisherman，Davidxiaozhi&lt;/strong&gt;&lt;/span&gt;&lt;/section&gt;&lt;/section&gt;&lt;/section&gt;&lt;/section&gt;&lt;/section&gt;&lt;/section&gt;&lt;/section&gt;&lt;section data-mpa-template=&quot;t&quot; mpa-from-tpl=&quot;t&quot;&gt;&lt;br/&gt;&lt;/section&gt;&lt;section data-mpa-template=&quot;t&quot; mpa-from-tpl=&quot;t&quot;&gt;&lt;section data-mid=&quot;&quot; mpa-from-tpl=&quot;t&quot;&gt;&lt;section data-mid=&quot;&quot; mpa-from-tpl=&quot;t&quot;&gt;&lt;section data-mid=&quot;&quot; mpa-from-tpl=&quot;t&quot;&gt;&lt;section data-mid=&quot;&quot; mpa-from-tpl=&quot;t&quot;&gt;&lt;br mpa-from-tpl=&quot;t&quot;/&gt;&lt;/section&gt;&lt;section data-mid=&quot;&quot; mpa-from-tpl=&quot;t&quot;&gt;&lt;br mpa-from-tpl=&quot;t&quot;/&gt;&lt;/section&gt;&lt;section data-mid=&quot;&quot; mpa-from-tpl=&quot;t&quot;&gt;&lt;br mpa-from-tpl=&quot;t&quot;/&gt;&lt;/section&gt;&lt;/section&gt;&lt;section data-mid=&quot;&quot; mpa-from-tpl=&quot;t&quot;&gt;&lt;section data-mid=&quot;&quot; mpa-from-tpl=&quot;t&quot;&gt;&lt;br mpa-from-tpl=&quot;t&quot;/&gt;&lt;/section&gt;&lt;section data-mid=&quot;&quot; mpa-from-tpl=&quot;t&quot;&gt;&lt;p data-mid=&quot;&quot;&gt;京东个性化推荐系统&lt;/p&gt;&lt;/section&gt;&lt;section data-mid=&quot;&quot; mpa-from-tpl=&quot;t&quot;&gt;&lt;br mpa-from-tpl=&quot;t&quot;/&gt;&lt;/section&gt;&lt;/section&gt;&lt;section data-mid=&quot;&quot; mpa-from-tpl=&quot;t&quot;&gt;&lt;section data-mid=&quot;&quot; mpa-from-tpl=&quot;t&quot;&gt;&lt;br mpa-from-tpl=&quot;t&quot;/&gt;&lt;/section&gt;&lt;section data-mid=&quot;&quot; mpa-from-tpl=&quot;t&quot;&gt;&lt;br mpa-from-tpl=&quot;t&quot;/&gt;&lt;/section&gt;&lt;section data-mid=&quot;&quot; mpa-from-tpl=&quot;t&quot;&gt;&lt;br/&gt;&lt;/section&gt;&lt;/section&gt;&lt;/section&gt;&lt;/section&gt;&lt;/section&gt;&lt;p&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;在电商领域，推荐的价值在于挖掘用户潜在购买需求，缩短用户到商品的距离，提升用户的购物体验。&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;&lt;br/&gt;&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;京东推荐的演进史是绚丽多彩的。&lt;/span&gt;&lt;span&gt;京东的推荐起步于2012年，当时的推荐产品甚至是基于规则匹配做的。&lt;/span&gt;&lt;span&gt;整个推荐产品线组合就像一个个松散的原始部落一样，部落与部落之前没有任何工程、算法的交集。&lt;/span&gt;&lt;span&gt;2013年，国内大数据时代到来，一方面如果做的事情与大数据不沾边，都显得自己水平不够，另外一方面京东业务在这一年开始飞速发展，所以传统的方式已经跟不上业务的发展了，为此推荐团队专门设计了新的推荐系统。&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;&lt;br/&gt;&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;随着业务的快速发展以及移动互联网的到来，多屏（京东App、京东PC商城、M站、微信手Q等）互通，推荐类型从传统的商品推荐，逐步扩展到其他类型的推荐，如活动、分类、优惠券、楼层、入口图、文章、清单、好货等。个性化推荐业务需求比较强烈，基于大数据和个性化推荐算法，实现向不同用户展示不同内容的效果。&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;为此，团队于2015年底再次升级推荐系统。2016年618期间，个性化推荐大放异彩，特别是团队开创的“智能卖场”，实现了活动会场的个性化分发，不仅带来GMV的明显提升，也大幅降低了人工成本，大大提高了流量效率和用户体验，从而达到商家和用户双赢，此产品获得了2016年度的集团优秀产品。为了更好地支撑多种个性化场景推荐业务，推荐系统一直在迭代优化升级，未来将朝着“满屏皆智能推荐”的方向发展。&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;/p&gt;&lt;section data-mpa-template=&quot;t&quot; mpa-from-tpl=&quot;t&quot;&gt;&lt;section data-mid=&quot;&quot; mpa-from-tpl=&quot;t&quot;&gt;&lt;section data-mid=&quot;&quot; mpa-from-tpl=&quot;t&quot;&gt;&lt;section data-mid=&quot;&quot; mpa-from-tpl=&quot;t&quot;&gt;&lt;img data-ratio=&quot;0.7837837837837838&quot; data-src=&quot;https://mmbiz.qpic.cn/mmbiz_png/siayVELeBkzWBXV8e57JJ4OyQuuMXTfadZCia0bN2sFBfdbTRlFx0S97kyKKjic5v6eaZ8cY4WQt0UEu4dkyowHYg/640?wx_fmt=png&quot; data-type=&quot;png&quot; data-w=&quot;74&quot;/&gt;&lt;/section&gt;&lt;section data-mid=&quot;&quot; mpa-from-tpl=&quot;t&quot;&gt;&lt;img data-ratio=&quot;0.7837837837837838&quot; data-src=&quot;https://mmbiz.qpic.cn/mmbiz_png/rl6daM2XiabyLSr7nSTyAzcoZqPAsfe5tOOrXX0aciaVAfibHeQk5NOfQTdESRsezCwstPF02LeE4RHaH6NBEB9Rw/640?wx_fmt=png&quot; data-type=&quot;png&quot; data-w=&quot;74&quot;/&gt;&lt;/section&gt;&lt;section data-mid=&quot;&quot; mpa-from-tpl=&quot;t&quot;&gt;&lt;p data-mid=&quot;&quot; mpa-is-content=&quot;t&quot;&gt;推荐产品&lt;/p&gt;&lt;/section&gt;&lt;/section&gt;&lt;/section&gt;&lt;/section&gt;&lt;p&gt;&lt;span&gt;&lt;br/&gt;&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;用户从产生购买意向，到经历购买决策，直至最后下单的整个过程，在任何一个购物链路上的节点，推荐产品都能在一定程度上帮助用户决策。&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;/p&gt;&lt;section data-mpa-template=&quot;t&quot; mpa-from-tpl=&quot;t&quot;&gt;&lt;section data-mid=&quot;&quot; mpa-from-tpl=&quot;t&quot;&gt;&lt;section data-mid=&quot;&quot; mpa-from-tpl=&quot;t&quot;&gt;&lt;section data-mid=&quot;&quot; mpa-from-tpl=&quot;t&quot;&gt;&lt;img data-ratio=&quot;0.7837837837837838&quot; data-src=&quot;https://mmbiz.qpic.cn/mmbiz_png/siayVELeBkzWBXV8e57JJ4OyQuuMXTfadZCia0bN2sFBfdbTRlFx0S97kyKKjic5v6eaZ8cY4WQt0UEu4dkyowHYg/640?wx_fmt=png&quot; data-type=&quot;png&quot; data-w=&quot;74&quot;/&gt;&lt;/section&gt;&lt;section data-mid=&quot;&quot; mpa-from-tpl=&quot;t&quot;&gt;&lt;img data-ratio=&quot;0.7837837837837838&quot; data-src=&quot;https://mmbiz.qpic.cn/mmbiz_png/rl6daM2XiabyLSr7nSTyAzcoZqPAsfe5tOOrXX0aciaVAfibHeQk5NOfQTdESRsezCwstPF02LeE4RHaH6NBEB9Rw/640?wx_fmt=png&quot; data-type=&quot;png&quot; data-w=&quot;74&quot;/&gt;&lt;/section&gt;&lt;section data-mid=&quot;&quot; mpa-from-tpl=&quot;t&quot;&gt;&lt;p data-mid=&quot;&quot; mpa-is-content=&quot;t&quot;&gt;&lt;strong&gt;推荐产品发展过程&lt;/strong&gt;&lt;/p&gt;&lt;/section&gt;&lt;/section&gt;&lt;/section&gt;&lt;/section&gt;&lt;p&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;推荐产品发展历程主要经历了几个阶段（图1），由简单的关联推荐过程到个性化推荐，逐步过渡到场景智能推荐。从相关、相似的产品推荐过渡到多特征、多维度、用户实时行为、结合用户场景进行的全方位智能推荐。&lt;/span&gt;&lt;/p&gt;&lt;figure&gt;&lt;p&gt;&lt;span&gt;&lt;img data-ratio=&quot;0.5928571428571429&quot; data-src=&quot;https://mmbiz.qpic.cn/mmbiz_png/PNzW2yzfW9nkia96AehLsT2Ms5icibl3IicgpjnnaLckWMbPopjVZJicaAI1k9uUve0fILJn8TA4NAP4uZBxjfD6JIA/640?wx_fmt=png&quot; data-type=&quot;png&quot; data-w=&quot;420&quot; data-backw=&quot;578&quot; data-backh=&quot;343&quot;/&gt;&lt;span&gt;图1　推荐产品发展历程&lt;/span&gt;&lt;/span&gt;&lt;/p&gt;&lt;/figure&gt;&lt;p&gt;&lt;span&gt;    &lt;/span&gt;&lt;/p&gt;&lt;section data-mpa-template=&quot;t&quot; mpa-from-tpl=&quot;t&quot;&gt;&lt;section data-mid=&quot;&quot; mpa-from-tpl=&quot;t&quot;&gt;&lt;section data-mid=&quot;&quot; mpa-from-tpl=&quot;t&quot;&gt;&lt;section data-mid=&quot;&quot; mpa-from-tpl=&quot;t&quot;&gt;&lt;img data-ratio=&quot;0.7837837837837838&quot; data-src=&quot;https://mmbiz.qpic.cn/mmbiz_png/siayVELeBkzWBXV8e57JJ4OyQuuMXTfadZCia0bN2sFBfdbTRlFx0S97kyKKjic5v6eaZ8cY4WQt0UEu4dkyowHYg/640?wx_fmt=png&quot; data-type=&quot;png&quot; data-w=&quot;74&quot;/&gt;&lt;/section&gt;&lt;section data-mid=&quot;&quot; mpa-from-tpl=&quot;t&quot;&gt;&lt;img data-ratio=&quot;0.7837837837837838&quot; data-src=&quot;https://mmbiz.qpic.cn/mmbiz_png/rl6daM2XiabyLSr7nSTyAzcoZqPAsfe5tOOrXX0aciaVAfibHeQk5NOfQTdESRsezCwstPF02LeE4RHaH6NBEB9Rw/640?wx_fmt=png&quot; data-type=&quot;png&quot; data-w=&quot;74&quot;/&gt;&lt;/section&gt;&lt;section data-mid=&quot;&quot; mpa-from-tpl=&quot;t&quot;&gt;&lt;p data-mid=&quot;&quot; mpa-is-content=&quot;t&quot;&gt;&lt;strong&gt;多屏多类型产品形态&lt;/strong&gt;&lt;/p&gt;&lt;/section&gt;&lt;/section&gt;&lt;/section&gt;&lt;/section&gt;&lt;p&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;多类型主要指推荐类型覆盖到多种类型，如商品、活动、分类、优惠券、楼层、入口图、文章、清单、好货等。在移动互联时代，多屏场景非常普遍，整合用户在多屏的信息，能使个性化推荐更精准。多屏整合的背后技术是通过前端埋点，用户行为触发埋点事件，通过点击流系统进行多屏的行为信息收集。这些行为数据通过实时流计算平台来计算用户的兴趣偏好，从而根据用户兴趣偏好对推荐结果进行重排序，达到个性化推荐的效果。京东多屏终端如图2所示。&lt;/span&gt;&lt;/p&gt;&lt;figure&gt;&lt;p&gt;&lt;span&gt;&lt;img data-ratio=&quot;0.5036496350364964&quot; data-src=&quot;https://mmbiz.qpic.cn/mmbiz_jpg/PNzW2yzfW9nkia96AehLsT2Ms5icibl3Iicg8vkR8Qbsbic0T2icsH3vV0jaEPhibInPeYg5EpN5SW5Z1SKUUSs1k9ibeQ/640?wx_fmt=jpeg&quot; data-type=&quot;jpeg&quot; data-w=&quot;411&quot;/&gt;&lt;span&gt;图2　京东多屏终端&lt;/span&gt;&lt;/span&gt;&lt;/p&gt;&lt;/figure&gt;&lt;section data-mpa-template=&quot;t&quot; mpa-from-tpl=&quot;t&quot;&gt;&lt;span&gt;    &lt;/span&gt;&lt;br/&gt;&lt;/section&gt;&lt;section data-mpa-template=&quot;t&quot; mpa-from-tpl=&quot;t&quot;&gt;&lt;section data-mid=&quot;&quot; mpa-from-tpl=&quot;t&quot;&gt;&lt;section data-mid=&quot;&quot; mpa-from-tpl=&quot;t&quot;&gt;&lt;section data-mid=&quot;&quot; mpa-from-tpl=&quot;t&quot;&gt;&lt;section data-mid=&quot;&quot; mpa-from-tpl=&quot;t&quot;&gt;&lt;br mpa-from-tpl=&quot;t&quot;/&gt;&lt;/section&gt;&lt;section data-mid=&quot;&quot; mpa-from-tpl=&quot;t&quot;&gt;&lt;br mpa-from-tpl=&quot;t&quot;/&gt;&lt;/section&gt;&lt;section data-mid=&quot;&quot; mpa-from-tpl=&quot;t&quot;&gt;&lt;br mpa-from-tpl=&quot;t&quot;/&gt;&lt;/section&gt;&lt;/section&gt;&lt;section data-mid=&quot;&quot; mpa-from-tpl=&quot;t&quot;&gt;&lt;section data-mid=&quot;&quot; mpa-from-tpl=&quot;t&quot;&gt;&lt;br mpa-from-tpl=&quot;t&quot;/&gt;&lt;/section&gt;&lt;section data-mid=&quot;&quot; mpa-from-tpl=&quot;t&quot;&gt;&lt;p data-mid=&quot;&quot; mpa-is-content=&quot;t&quot;&gt;&lt;strong&gt;推荐系统架构&lt;/strong&gt;&lt;/p&gt;&lt;/section&gt;&lt;section data-mid=&quot;&quot; mpa-from-tpl=&quot;t&quot;&gt;&lt;br mpa-from-tpl=&quot;t&quot;/&gt;&lt;/section&gt;&lt;/section&gt;&lt;section data-mid=&quot;&quot; mpa-from-tpl=&quot;t&quot;&gt;&lt;section data-mid=&quot;&quot; mpa-from-tpl=&quot;t&quot;&gt;&lt;br mpa-from-tpl=&quot;t&quot;/&gt;&lt;/section&gt;&lt;section data-mid=&quot;&quot; mpa-from-tpl=&quot;t&quot;&gt;&lt;br mpa-from-tpl=&quot;t&quot;/&gt;&lt;/section&gt;&lt;section data-mid=&quot;&quot; mpa-from-tpl=&quot;t&quot;&gt;&lt;br/&gt;&lt;/section&gt;&lt;/section&gt;&lt;/section&gt;&lt;/section&gt;&lt;/section&gt;&lt;p&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;推荐系统的目标是&lt;strong&gt;通过全方位的精准数据刻画用户的购买意图，推荐用户有购买意愿的商品，给用户最好的体验，提升下单转化率，增强用户黏性&lt;/strong&gt;。推荐系统的业务架构如图3所示。&lt;/span&gt;&lt;/p&gt;&lt;figure&gt;&lt;p&gt;&lt;span&gt;&lt;img data-ratio=&quot;0.5834829443447038&quot; data-src=&quot;https://mmbiz.qpic.cn/mmbiz_png/PNzW2yzfW9nkia96AehLsT2Ms5icibl3IicgXY42BQ4VPgnDbiaGofMaaDBoIicscIU5VMicv9wsIbT4HSZnZ6tIicvZ7Q/640?wx_fmt=png&quot; data-type=&quot;png&quot; data-w=&quot;557&quot; data-backw=&quot;557&quot; data-backh=&quot;325&quot;/&gt;&lt;span&gt;图3　推荐系统的业务架构&lt;/span&gt;&lt;/span&gt;&lt;/p&gt;&lt;/figure&gt;&lt;ul class=&quot;list-paddingleft-2&quot;&gt;&lt;li&gt;&lt;p&gt;&lt;strong&gt;&lt;span&gt;系统架构&lt;/span&gt;&lt;/strong&gt;&lt;span&gt;。对外提供统一的HTTP推荐服务，服务京东所有终端的推荐业务。&lt;/span&gt;&lt;/p&gt;&lt;/li&gt;&lt;li&gt;&lt;p&gt;&lt;strong&gt;&lt;span&gt;模型服务&lt;/span&gt;&lt;/strong&gt;&lt;span&gt;。为了提高个性化的效果而开发的一系列公共的个性化服务，用户维度有用户行为服务和用户画像服务，商品维度有商品画像，地域维度有小区画像，特征维度有特征服务。通过这些基础服务，让个性化推荐更简单、更精准。&lt;/span&gt;&lt;/p&gt;&lt;/li&gt;&lt;li&gt;&lt;p&gt;&lt;strong&gt;&lt;span&gt;机器学习&lt;/span&gt;&lt;/strong&gt;&lt;span&gt;。算法模型训练阶段，尝试多种机器学习模型，结合离线测评和在线A/B，验证不同场景下的算法模型的效果，提高推荐的转化率。&lt;/span&gt;&lt;/p&gt;&lt;/li&gt;&lt;li&gt;&lt;p&gt;&lt;strong&gt;&lt;span&gt;数据平台&lt;/span&gt;&lt;/strong&gt;&lt;span&gt;。数据是推荐的源泉，包括数据收集和数据计算。数据虽然是整体推荐架构的最底层，却是非常重要的，因为数据直接关系到推荐的健康发展和效果提升。&lt;/span&gt;&lt;/p&gt;&lt;/li&gt;&lt;/ul&gt;&lt;p&gt;&lt;span&gt;    &lt;/span&gt;&lt;/p&gt;&lt;section data-mpa-template=&quot;t&quot; mpa-from-tpl=&quot;t&quot;&gt;&lt;section data-mid=&quot;&quot; mpa-from-tpl=&quot;t&quot;&gt;&lt;section data-mid=&quot;&quot; mpa-from-tpl=&quot;t&quot;&gt;&lt;section data-mid=&quot;&quot; mpa-from-tpl=&quot;t&quot;&gt;&lt;img data-ratio=&quot;0.7837837837837838&quot; data-src=&quot;https://mmbiz.qpic.cn/mmbiz_png/siayVELeBkzWBXV8e57JJ4OyQuuMXTfadZCia0bN2sFBfdbTRlFx0S97kyKKjic5v6eaZ8cY4WQt0UEu4dkyowHYg/640?wx_fmt=png&quot; data-type=&quot;png&quot; data-w=&quot;74&quot;/&gt;&lt;/section&gt;&lt;section data-mid=&quot;&quot; mpa-from-tpl=&quot;t&quot;&gt;&lt;img data-ratio=&quot;0.7837837837837838&quot; data-src=&quot;https://mmbiz.qpic.cn/mmbiz_png/rl6daM2XiabyLSr7nSTyAzcoZqPAsfe5tOOrXX0aciaVAfibHeQk5NOfQTdESRsezCwstPF02LeE4RHaH6NBEB9Rw/640?wx_fmt=png&quot; data-type=&quot;png&quot; data-w=&quot;74&quot;/&gt;&lt;/section&gt;&lt;section data-mid=&quot;&quot; mpa-from-tpl=&quot;t&quot;&gt;&lt;p data-mid=&quot;&quot; mpa-is-content=&quot;t&quot;&gt;&lt;strong&gt;个性化推荐架构&lt;/strong&gt;&lt;/p&gt;&lt;/section&gt;&lt;/section&gt;&lt;/section&gt;&lt;/section&gt;&lt;p&gt;&lt;span&gt;&lt;br/&gt;&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;在起步初期，推荐产品比较简单，每个推荐产品都是独立服务实现。新版推荐系统是一个系统性工程，其依赖数据、架构、算法、人机交互等环节的有机结合。新版推荐系统的目标，是通过个性化数据挖掘、机器学习等技术，&lt;strong&gt;将“千人一面”变为“千人千面”&lt;/strong&gt;，提高用户忠诚度和用户体验，提高用户购物决策的质量和效率；提高网站交叉销售能力，缩短用户购物路径，提高流量转化率（CVR）。目前新版推荐系统支持多类型个性化推荐，包括商品、店铺、品牌、活动、优惠券、楼层等。新版个性化推荐系统架构如图4所示。&lt;/span&gt;&lt;/p&gt;&lt;figure&gt;&lt;p&gt;&lt;span&gt;&lt;img data-ratio=&quot;0.6173228346456693&quot; data-src=&quot;https://mmbiz.qpic.cn/mmbiz_jpg/PNzW2yzfW9nkia96AehLsT2Ms5icibl3IicggvBPGNScvg4z0etOQTWkoeogQBHzNe5NmEkWurALusXMty7FUJXqrg/640?wx_fmt=jpeg&quot; data-type=&quot;jpeg&quot; data-w=&quot;635&quot; data-backw=&quot;578&quot; data-backh=&quot;357&quot;/&gt;&lt;span&gt;图4　新版个性化推荐系统架构&lt;/span&gt;&lt;/span&gt;&lt;/p&gt;&lt;/figure&gt;&lt;p&gt;&lt;span&gt;    &lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;个性化推荐系统架构图中不同的颜色代表不同的业务处理场景：数据处理部分（最底层绿色模块），包括离线数据预处理、机器学习模型训练，以及在线实时行为的接入、实时特征计算。推荐平台（蓝色模块），主要体现响应用户请求时推荐系统的各服务模块之间的交互关系。推荐系统核心模块：&lt;/span&gt;&lt;/p&gt;&lt;ul class=&quot;list-paddingleft-2&quot;&gt;&lt;li&gt;&lt;p&gt;&lt;span&gt;&lt;strong&gt;&lt;span&gt;推荐网关&lt;/span&gt;&lt;/strong&gt;&lt;/span&gt;&lt;span&gt;。推荐服务的入口，负责推荐请求的合法性检查、请求分发、在线Debug 以及组装请求响应的结果。&lt;/span&gt;&lt;/p&gt;&lt;/li&gt;&lt;li&gt;&lt;p&gt;&lt;span&gt;&lt;strong&gt;&lt;span&gt;调度引擎&lt;/span&gt;&lt;/strong&gt;&lt;/span&gt;&lt;span&gt;。负责推荐服务按策略调度及流量分发，主要根据配置中心的推荐产品 的实验配置策略进行分流，支持按用户分流、随机分流和按关键参数分流。支持自定义埋 点，收集实时数据；支持应急预案功能，处理紧急情况，秒级生效。&lt;/span&gt;&lt;/p&gt;&lt;/li&gt;&lt;li&gt;&lt;p&gt;&lt;span&gt;&lt;strong&gt;&lt;span&gt;推荐引擎&lt;/span&gt;&lt;/strong&gt;&lt;/span&gt;&lt;span&gt;。负责推荐在线算法逻辑实现，主要包括召回、过滤、特征计算、排序、 多样化等处理过程。&lt;/span&gt;&lt;/p&gt;&lt;/li&gt;&lt;li&gt;&lt;p&gt;&lt;span&gt;&lt;strong&gt;个性化基础服务&lt;/strong&gt;&lt;/span&gt;&lt;span&gt;。目前主要个性化基础服务有用户画像、商品画像、用户行为、 预测服务。用户画像包括用户的长期兴趣、短期兴趣、实时兴趣。兴趣主要有性别、品牌 偏好、品类偏好、购买力等级、自营偏好、尺码颜色偏好、促销敏感度、家庭情况等。商品画像主要包括商品的产品词、修饰词、品牌词、质量分、价格等级、性别、年龄、标签等。用户行为主要获取用户近期行为，包括用户的搜索、点击、关注、加入购车、下单等。预测服务主要是基于用户的历史行为，使用机器学习训练模型，用于调整召回候选集的权重。&lt;/span&gt;&lt;/p&gt;&lt;/li&gt;&lt;li&gt;&lt;p&gt;&lt;span&gt;&lt;strong&gt;&lt;span&gt;特征服务平台&lt;/span&gt;&lt;/strong&gt;&lt;/span&gt;&lt;span&gt;。负责为个性服务提供特征数据和特征计算，特征服务平台主要针对 特征数据，进行有效的声明、管理，进而达到特征资源的共享，快速支持针对不同的特征进行有效的声明、上线、测试以及A/B实验效果对比。&lt;/span&gt;&lt;/p&gt;&lt;/li&gt;&lt;/ul&gt;&lt;p&gt;&lt;span&gt;    &lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;个性化技术（橙色模块），个性化主要通过特征和算法训练模型来进行重排序，达到精准推荐的目的。&lt;/span&gt;&lt;span&gt;特征服务平台主要用于提供大量多维度的特征信息，推荐场景回放技术是指通过用户实时场景特征信息反馈到推荐排序，在线学习（Online-Learning）和深度学习都是大规模特征计算的个性化服务。&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;    &lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;个性化推荐系统的主要优势体现为支持多类型推荐和多屏产品形态，支持算法模型A/B实验快速迭代，支持系统架构与算法解耦，支持存储资源与推荐引擎计算的解耦，支持预测召回与推荐引擎计算的解耦，支持自定义埋点功能；推荐特征数据服务平台化，支持推荐场景回放。&lt;/span&gt;&lt;/p&gt;&lt;section data-mpa-template=&quot;t&quot; mpa-from-tpl=&quot;t&quot;&gt;&lt;section data-mid=&quot;&quot; mpa-from-tpl=&quot;t&quot;&gt;&lt;section data-mid=&quot;&quot; mpa-from-tpl=&quot;t&quot;&gt;&lt;section data-mid=&quot;&quot; mpa-from-tpl=&quot;t&quot;&gt;&lt;img data-ratio=&quot;0.7837837837837838&quot; data-src=&quot;https://mmbiz.qpic.cn/mmbiz_png/siayVELeBkzWBXV8e57JJ4OyQuuMXTfadZCia0bN2sFBfdbTRlFx0S97kyKKjic5v6eaZ8cY4WQt0UEu4dkyowHYg/640?wx_fmt=png&quot; data-type=&quot;png&quot; data-w=&quot;74&quot;/&gt;&lt;/section&gt;&lt;section data-mid=&quot;&quot; mpa-from-tpl=&quot;t&quot;&gt;&lt;img data-ratio=&quot;0.7837837837837838&quot; data-src=&quot;https://mmbiz.qpic.cn/mmbiz_png/rl6daM2XiabyLSr7nSTyAzcoZqPAsfe5tOOrXX0aciaVAfibHeQk5NOfQTdESRsezCwstPF02LeE4RHaH6NBEB9Rw/640?wx_fmt=png&quot; data-type=&quot;png&quot; data-w=&quot;74&quot;/&gt;&lt;/section&gt;&lt;section data-mid=&quot;&quot; mpa-from-tpl=&quot;t&quot;&gt;&lt;p data-mid=&quot;&quot; mpa-is-content=&quot;t&quot;&gt;&lt;strong&gt;数据平台&lt;/strong&gt;&lt;/p&gt;&lt;/section&gt;&lt;/section&gt;&lt;/section&gt;&lt;/section&gt;&lt;p&gt;&lt;span&gt;    &lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;京东拥有庞大的用户量和全品类的商品以及多种促销活动，可以根据用户在京东平台上的行为记录积累数据，如&lt;strong&gt;浏览、加购物车、关注、搜索、购买、评论&lt;/strong&gt;等行为数据，以及商品本身的&lt;strong&gt;品牌、品类、描述、价格&lt;/strong&gt;等属性数据的积累，活动、素材等资源的数据积累。这些数据是大规模机器学习的基础，也是更精确地进行个性化推荐的前提。&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;    &lt;/span&gt;&lt;/p&gt;&lt;section data-mpa-template=&quot;t&quot; mpa-from-tpl=&quot;t&quot;&gt;&lt;section data-mid=&quot;&quot; mpa-from-tpl=&quot;t&quot;&gt;&lt;section data-mid=&quot;&quot; mpa-from-tpl=&quot;t&quot;&gt;&lt;section data-mid=&quot;&quot; mpa-from-tpl=&quot;t&quot;&gt;&lt;img data-ratio=&quot;0.7837837837837838&quot; data-src=&quot;https://mmbiz.qpic.cn/mmbiz_png/siayVELeBkzWBXV8e57JJ4OyQuuMXTfadZCia0bN2sFBfdbTRlFx0S97kyKKjic5v6eaZ8cY4WQt0UEu4dkyowHYg/640?wx_fmt=png&quot; data-type=&quot;png&quot; data-w=&quot;74&quot;/&gt;&lt;/section&gt;&lt;section data-mid=&quot;&quot; mpa-from-tpl=&quot;t&quot;&gt;&lt;img data-ratio=&quot;0.7837837837837838&quot; data-src=&quot;https://mmbiz.qpic.cn/mmbiz_png/rl6daM2XiabyLSr7nSTyAzcoZqPAsfe5tOOrXX0aciaVAfibHeQk5NOfQTdESRsezCwstPF02LeE4RHaH6NBEB9Rw/640?wx_fmt=png&quot; data-type=&quot;png&quot; data-w=&quot;74&quot;/&gt;&lt;/section&gt;&lt;section data-mid=&quot;&quot; mpa-from-tpl=&quot;t&quot;&gt;&lt;p data-mid=&quot;&quot; mpa-is-content=&quot;t&quot;&gt;&lt;strong&gt;数据收集&lt;/strong&gt;&lt;/p&gt;&lt;/section&gt;&lt;/section&gt;&lt;/section&gt;&lt;/section&gt;&lt;p&gt;&lt;span&gt;&lt;br/&gt;&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;用户行为数据收集流程一般是用户在京东平台（京东App、京东PC网站、微信手Q）上相关操作，都会触发埋点请求点击流系统（专门用于收集行为数据的平台系统）。点击流系统接到请求后，进行实时消息发送（用于实时计算业务消费）和落本地日志（用于离线模型计算），定时自动抽取行为日志到大数据平台中心。算法人员在数据集市上通过机器学习训练模型，这些算法模型应用于推荐服务，推荐服务辅助用户决策，进一步影响用户的购物行为，购物行为数据再发送到点击流，从而达到数据收集闭环。&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;    &lt;/span&gt;&lt;/p&gt;&lt;section data-mpa-template=&quot;t&quot; mpa-from-tpl=&quot;t&quot;&gt;&lt;section data-mid=&quot;&quot; mpa-from-tpl=&quot;t&quot;&gt;&lt;section data-mid=&quot;&quot; mpa-from-tpl=&quot;t&quot;&gt;&lt;section data-mid=&quot;&quot; mpa-from-tpl=&quot;t&quot;&gt;&lt;img data-ratio=&quot;0.7837837837837838&quot; data-src=&quot;https://mmbiz.qpic.cn/mmbiz_png/siayVELeBkzWBXV8e57JJ4OyQuuMXTfadZCia0bN2sFBfdbTRlFx0S97kyKKjic5v6eaZ8cY4WQt0UEu4dkyowHYg/640?wx_fmt=png&quot; data-type=&quot;png&quot; data-w=&quot;74&quot;/&gt;&lt;/section&gt;&lt;section data-mid=&quot;&quot; mpa-from-tpl=&quot;t&quot;&gt;&lt;img data-ratio=&quot;0.7837837837837838&quot; data-src=&quot;https://mmbiz.qpic.cn/mmbiz_png/rl6daM2XiabyLSr7nSTyAzcoZqPAsfe5tOOrXX0aciaVAfibHeQk5NOfQTdESRsezCwstPF02LeE4RHaH6NBEB9Rw/640?wx_fmt=png&quot; data-type=&quot;png&quot; data-w=&quot;74&quot;/&gt;&lt;/section&gt;&lt;section data-mid=&quot;&quot; mpa-from-tpl=&quot;t&quot;&gt;&lt;p data-mid=&quot;&quot; mpa-is-content=&quot;t&quot;&gt;&lt;strong&gt;离线计算&lt;/strong&gt;&lt;/p&gt;&lt;/section&gt;&lt;/section&gt;&lt;/section&gt;&lt;/section&gt;&lt;p&gt;&lt;span&gt;&lt;br/&gt;&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;目前离线计算平台涉及的计算内容主要有离线模型、离线特征、用户画像、商品画像、用户行为，离线计算主要在Hadoop上运行MapReduce，也有部分在Spark平台上计算，计算的结果通过公共导数工具导入存储库。团队考虑到业务种类繁多、类型复杂以及存储类型多样，开发了插件化导数工具，降低离线数据开发及维护的成本。数据离线计算架构如图5所示。&lt;/span&gt;&lt;/p&gt;&lt;figure&gt;&lt;p&gt;&lt;span&gt;&lt;img data-ratio=&quot;0.42226148409893993&quot; data-src=&quot;https://mmbiz.qpic.cn/mmbiz_png/PNzW2yzfW9nkia96AehLsT2Ms5icibl3Iicgicak0FGribappJp796FhjlFMLYkoG1ia2xGDuib5hk5MJDPlOcQQs1AIrQ/640?wx_fmt=png&quot; data-type=&quot;png&quot; data-w=&quot;566&quot; data-backw=&quot;566&quot; data-backh=&quot;239&quot;/&gt;&lt;span&gt;图5　数据离线计算架构&lt;/span&gt;&lt;/span&gt;&lt;/p&gt;&lt;/figure&gt;&lt;p&gt;&lt;span&gt;&lt;br/&gt;&lt;/span&gt;&lt;/p&gt;&lt;section data-mpa-template=&quot;t&quot; mpa-from-tpl=&quot;t&quot;&gt;&lt;section data-mid=&quot;&quot; mpa-from-tpl=&quot;t&quot;&gt;&lt;section data-mid=&quot;&quot; mpa-from-tpl=&quot;t&quot;&gt;&lt;section data-mid=&quot;&quot; mpa-from-tpl=&quot;t&quot;&gt;&lt;img data-ratio=&quot;0.7837837837837838&quot; data-src=&quot;https://mmbiz.qpic.cn/mmbiz_png/siayVELeBkzWBXV8e57JJ4OyQuuMXTfadZCia0bN2sFBfdbTRlFx0S97kyKKjic5v6eaZ8cY4WQt0UEu4dkyowHYg/640?wx_fmt=png&quot; data-type=&quot;png&quot; data-w=&quot;74&quot;/&gt;&lt;/section&gt;&lt;section data-mid=&quot;&quot; mpa-from-tpl=&quot;t&quot;&gt;&lt;img data-ratio=&quot;0.7837837837837838&quot; data-src=&quot;https://mmbiz.qpic.cn/mmbiz_png/rl6daM2XiabyLSr7nSTyAzcoZqPAsfe5tOOrXX0aciaVAfibHeQk5NOfQTdESRsezCwstPF02LeE4RHaH6NBEB9Rw/640?wx_fmt=png&quot; data-type=&quot;png&quot; data-w=&quot;74&quot;/&gt;&lt;/section&gt;&lt;section data-mid=&quot;&quot; mpa-from-tpl=&quot;t&quot;&gt;&lt;p data-mid=&quot;&quot; mpa-is-content=&quot;t&quot;&gt;&lt;strong&gt;在线计算&lt;/strong&gt;&lt;/p&gt;&lt;/section&gt;&lt;/section&gt;&lt;/section&gt;&lt;/section&gt;&lt;p&gt;&lt;span&gt;&lt;br/&gt;&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;目前在线计算的范围主要有&lt;strong&gt;用户实时行为、用户实时画像、用户实时反馈、实时交互特征计算&lt;/strong&gt;等。在线计算是根据业务需求，快速捕捉用户的兴趣和场景特征，从而实时反馈 到用户的推荐结果及排序，给用户专属的个性化体验。在线计算的实现消息主要来源于Kafka集群的消息订阅和JMQ消息订阅，通过Storm集群或Spark集群实时消费，推送到Redis集群和HBase集群存储。数据在线计算框架如图6所示。&lt;/span&gt;&lt;/p&gt;&lt;figure&gt;&lt;p&gt;&lt;span&gt;&lt;img data-ratio=&quot;0.40669856459330145&quot; data-src=&quot;https://mmbiz.qpic.cn/mmbiz_png/PNzW2yzfW9nkia96AehLsT2Ms5icibl3Iicgib2BOtUScBXdNWj8lC0WJNQgFy4Iic0U6EGoLQgeFxfLdJCuxSBarn5g/640?wx_fmt=png&quot; data-type=&quot;png&quot; data-w=&quot;627&quot; data-backw=&quot;578&quot; data-backh=&quot;235&quot;/&gt;&lt;span&gt;图6　数据在线计算架构&lt;/span&gt;&lt;/span&gt;&lt;/p&gt;&lt;/figure&gt;&lt;p&gt;&lt;span&gt;  &lt;/span&gt;&lt;/p&gt;&lt;section data-mpa-template=&quot;t&quot; mpa-from-tpl=&quot;t&quot;&gt;&lt;section data-mid=&quot;&quot; mpa-from-tpl=&quot;t&quot;&gt;&lt;section data-mid=&quot;&quot; mpa-from-tpl=&quot;t&quot;&gt;&lt;section data-mid=&quot;&quot; mpa-from-tpl=&quot;t&quot;&gt;&lt;section data-mid=&quot;&quot; mpa-from-tpl=&quot;t&quot;&gt;&lt;br mpa-from-tpl=&quot;t&quot;/&gt;&lt;/section&gt;&lt;section data-mid=&quot;&quot; mpa-from-tpl=&quot;t&quot;&gt;&lt;br mpa-from-tpl=&quot;t&quot;/&gt;&lt;/section&gt;&lt;section data-mid=&quot;&quot; mpa-from-tpl=&quot;t&quot;&gt;&lt;br mpa-from-tpl=&quot;t&quot;/&gt;&lt;/section&gt;&lt;/section&gt;&lt;section data-mid=&quot;&quot; mpa-from-tpl=&quot;t&quot;&gt;&lt;section data-mid=&quot;&quot; mpa-from-tpl=&quot;t&quot;&gt;&lt;br mpa-from-tpl=&quot;t&quot;/&gt;&lt;/section&gt;&lt;section data-mid=&quot;&quot; mpa-from-tpl=&quot;t&quot;&gt;&lt;p data-mid=&quot;&quot;&gt;关键技术&lt;/p&gt;&lt;/section&gt;&lt;section data-mid=&quot;&quot; mpa-from-tpl=&quot;t&quot;&gt;&lt;br mpa-from-tpl=&quot;t&quot;/&gt;&lt;/section&gt;&lt;/section&gt;&lt;section data-mid=&quot;&quot; mpa-from-tpl=&quot;t&quot;&gt;&lt;section data-mid=&quot;&quot; mpa-from-tpl=&quot;t&quot;&gt;&lt;br mpa-from-tpl=&quot;t&quot;/&gt;&lt;/section&gt;&lt;section data-mid=&quot;&quot; mpa-from-tpl=&quot;t&quot;&gt;&lt;br mpa-from-tpl=&quot;t&quot;/&gt;&lt;/section&gt;&lt;section data-mid=&quot;&quot; mpa-from-tpl=&quot;t&quot;&gt;&lt;br/&gt;&lt;/section&gt;&lt;/section&gt;&lt;/section&gt;&lt;/section&gt;&lt;/section&gt;&lt;p&gt;&lt;span&gt;&lt;br/&gt;&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;推荐系统涉及的技术点比较多，考虑到篇幅有限，这里重点介绍个性化推荐中比较重要的部分。&lt;/span&gt;&lt;/p&gt;&lt;section data-mpa-template=&quot;t&quot; mpa-from-tpl=&quot;t&quot;&gt;&lt;section data-mid=&quot;&quot; mpa-from-tpl=&quot;t&quot;&gt;&lt;section data-mid=&quot;&quot; mpa-from-tpl=&quot;t&quot;&gt;&lt;section data-mid=&quot;&quot; mpa-from-tpl=&quot;t&quot;&gt;&lt;img data-ratio=&quot;0.7837837837837838&quot; data-src=&quot;https://mmbiz.qpic.cn/mmbiz_png/siayVELeBkzWBXV8e57JJ4OyQuuMXTfadZCia0bN2sFBfdbTRlFx0S97kyKKjic5v6eaZ8cY4WQt0UEu4dkyowHYg/640?wx_fmt=png&quot; data-type=&quot;png&quot; data-w=&quot;74&quot;/&gt;&lt;/section&gt;&lt;section data-mid=&quot;&quot; mpa-from-tpl=&quot;t&quot;&gt;&lt;img data-ratio=&quot;0.7837837837837838&quot; data-src=&quot;https://mmbiz.qpic.cn/mmbiz_png/rl6daM2XiabyLSr7nSTyAzcoZqPAsfe5tOOrXX0aciaVAfibHeQk5NOfQTdESRsezCwstPF02LeE4RHaH6NBEB9Rw/640?wx_fmt=png&quot; data-type=&quot;png&quot; data-w=&quot;74&quot;/&gt;&lt;/section&gt;&lt;section data-mid=&quot;&quot; mpa-from-tpl=&quot;t&quot;&gt;&lt;p data-mid=&quot;&quot; mpa-is-content=&quot;t&quot;&gt;&lt;strong&gt;推荐&lt;/strong&gt;引擎&lt;/p&gt;&lt;/section&gt;&lt;/section&gt;&lt;/section&gt;&lt;/section&gt;&lt;p&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;个性化推荐系统的核心是推荐引擎，推荐引擎的一般处理过程是召回候选集，进行规 则过滤，使用算法模型打分，模型融合排序，推荐结果多样化展示。主要使用的技术是机器学习模型，结合知识图谱，挖掘商品间的关系，按用户场景，通过高维特征计算和海量召回，大规模排序模型，进行个性化推荐，提升排序效果，给用户极致的购物体验。&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;&lt;br/&gt;&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;推荐引擎处理逻辑主要包括分配任务，执行推荐器，合并召回结果。推荐器负责召回 候选集、业务规则过滤、特征计算、排序等处理。推荐引擎技术架构如图7所示。&lt;/span&gt;&lt;/p&gt;&lt;figure&gt;&lt;p&gt;&lt;span&gt;&lt;img data-ratio=&quot;0.6025848142164781&quot; data-src=&quot;https://mmbiz.qpic.cn/mmbiz_png/PNzW2yzfW9nkia96AehLsT2Ms5icibl3IicgACL4NziasiaMbCaWu2OrOeox7RA9BxDs8oWvGGscQx3KGavW3fwo3niaA/640?wx_fmt=png&quot; data-type=&quot;png&quot; data-w=&quot;619&quot; data-backw=&quot;578&quot; data-backh=&quot;348&quot;/&gt;&lt;span&gt;图7　推荐引擎技术架构&lt;/span&gt;&lt;/span&gt;&lt;/p&gt;&lt;/figure&gt;&lt;p&gt;&lt;span&gt;&lt;strong&gt;分配&lt;/strong&gt;&lt;/span&gt;&lt;span&gt;：根据推荐场景，按召回源进行任务拆分，关键是让分布式任务到达负载均衡。&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;推荐器。推荐引擎的核心执行组件，获取个性化推荐结果，推荐器的实现如图8所示。&lt;/span&gt;&lt;/p&gt;&lt;figure&gt;&lt;p&gt;&lt;span&gt;&lt;img data-ratio=&quot;0.48542274052478135&quot; data-src=&quot;https://mmbiz.qpic.cn/mmbiz_png/PNzW2yzfW9nkia96AehLsT2Ms5icibl3IicgBYibBxevZmo78bich6hicFTMoqXEKF2nrQ65l0fE4iaysN50iaNqk0QEalA/640?wx_fmt=png&quot; data-type=&quot;png&quot; data-w=&quot;686&quot; data-backw=&quot;578&quot; data-backh=&quot;281&quot;/&gt;&lt;span&gt;图8　推荐器架构&lt;/span&gt;&lt;/span&gt;&lt;/p&gt;&lt;/figure&gt;&lt;ul class=&quot;list-paddingleft-2&quot;&gt;&lt;li&gt;&lt;p&gt;&lt;strong&gt;&lt;span&gt;召回阶段&lt;/span&gt;&lt;/strong&gt;&lt;span&gt;。获取候选集，一般从基于用户画像、用户偏好、地域等维度进行召回，如果是新用户的召回资源不够，会使用冷启动服务进行召回。&lt;/span&gt;&lt;/p&gt;&lt;/li&gt;&lt;li&gt;&lt;p&gt;&lt;strong&gt;&lt;span&gt;规则过滤阶段&lt;/span&gt;&lt;/strong&gt;&lt;span&gt;。对人工规则、一品多商、子母码、邮差差价等进行过滤。&lt;/span&gt;&lt;/p&gt;&lt;/li&gt;&lt;li&gt;&lt;p&gt;&lt;strong&gt;&lt;span&gt;特征计算阶段&lt;/span&gt;&lt;/strong&gt;&lt;span&gt;。结合用户实时行为、用户画像、知识图谱、特征服务，计算出召回的候选集的特征向量。&lt;/span&gt;&lt;/p&gt;&lt;/li&gt;&lt;li&gt;&lt;p&gt;&lt;strong&gt;&lt;span&gt;排序阶段&lt;/span&gt;&lt;/strong&gt;&lt;span&gt;。使用算法模型对召回候选集打分，根据召回源和候选集的分值，按一定的策略对候选集进行重新排序。&lt;/span&gt;&lt;/p&gt;&lt;/li&gt;&lt;/ul&gt;&lt;p&gt;&lt;strong&gt;&lt;span&gt;合并&lt;/span&gt;&lt;/strong&gt;&lt;span&gt;：归并多个推荐器返回的推荐结果，按业务规则进行合并，考虑一定的多样性。举例来说，京东App首页“猜你喜欢”的实现过程如图9所示。首先根据用户画像信息和用户的近期行为及相关反馈信息，选择不同的召回方式，进行业务规则过滤；对满足要求的候选商品集，提取用户特征、商品特征、用户和商品的交叉特征；使用算法模型根据这些特征计算候选商品的得分；根据每个商品的得分对商品进行排序，同时会丰富推荐理由，考虑用户体验，会对最终排好序推荐结果进行微调整，如多样性展示。&lt;/span&gt;&lt;/p&gt;&lt;figure&gt;&lt;p&gt;&lt;span&gt;&lt;img data-ratio=&quot;0.5607008760951189&quot; data-src=&quot;https://mmbiz.qpic.cn/mmbiz_jpg/PNzW2yzfW9nkia96AehLsT2Ms5icibl3IicgwO2vJDCPrWNe1kJqetWpmE3OOHI057gWaV2cIWcAFlRm2BJL2ouqVQ/640?wx_fmt=jpeg&quot; data-type=&quot;jpeg&quot; data-w=&quot;799&quot; data-backw=&quot;578&quot; data-backh=&quot;324&quot;/&gt;&lt;span&gt;图9　猜你喜欢实现过程图&lt;/span&gt;&lt;/span&gt;&lt;/p&gt;&lt;/figure&gt;&lt;p&gt;&lt;span&gt;    &lt;/span&gt;&lt;/p&gt;&lt;section data-mpa-template=&quot;t&quot; mpa-from-tpl=&quot;t&quot;&gt;&lt;section data-mid=&quot;&quot; mpa-from-tpl=&quot;t&quot;&gt;&lt;section data-mid=&quot;&quot; mpa-from-tpl=&quot;t&quot;&gt;&lt;section data-mid=&quot;&quot; mpa-from-tpl=&quot;t&quot;&gt;&lt;section data-mid=&quot;&quot; mpa-from-tpl=&quot;t&quot;&gt;&lt;br mpa-from-tpl=&quot;t&quot;/&gt;&lt;/section&gt;&lt;section data-mid=&quot;&quot; mpa-from-tpl=&quot;t&quot;&gt;&lt;br mpa-from-tpl=&quot;t&quot;/&gt;&lt;/section&gt;&lt;section data-mid=&quot;&quot; mpa-from-tpl=&quot;t&quot;&gt;&lt;br mpa-from-tpl=&quot;t&quot;/&gt;&lt;/section&gt;&lt;/section&gt;&lt;section data-mid=&quot;&quot; mpa-from-tpl=&quot;t&quot;&gt;&lt;section data-mid=&quot;&quot; mpa-from-tpl=&quot;t&quot;&gt;&lt;br mpa-from-tpl=&quot;t&quot;/&gt;&lt;/section&gt;&lt;section data-mid=&quot;&quot; mpa-from-tpl=&quot;t&quot;&gt;&lt;p data-mid=&quot;&quot; mpa-is-content=&quot;t&quot;&gt;&lt;strong&gt;用户画像&lt;/strong&gt;&lt;/p&gt;&lt;/section&gt;&lt;section data-mid=&quot;&quot; mpa-from-tpl=&quot;t&quot;&gt;&lt;br mpa-from-tpl=&quot;t&quot;/&gt;&lt;/section&gt;&lt;/section&gt;&lt;section data-mid=&quot;&quot; mpa-from-tpl=&quot;t&quot;&gt;&lt;section data-mid=&quot;&quot; mpa-from-tpl=&quot;t&quot;&gt;&lt;br mpa-from-tpl=&quot;t&quot;/&gt;&lt;/section&gt;&lt;section data-mid=&quot;&quot; mpa-from-tpl=&quot;t&quot;&gt;&lt;br mpa-from-tpl=&quot;t&quot;/&gt;&lt;/section&gt;&lt;section data-mid=&quot;&quot; mpa-from-tpl=&quot;t&quot;&gt;&lt;br/&gt;&lt;/section&gt;&lt;/section&gt;&lt;/section&gt;&lt;/section&gt;&lt;/section&gt;&lt;p&gt;&lt;span&gt;京东大数据有别于其他厂商的地方就是京东拥有最长的价值链和全流程的数据积累。京东数据的特征非常全面，数据链记录着每个用户的每一步操作：从登录到搜索、浏览、选择商品、页面停留时间、评论阅读、是否关注促销，以及加入购物车、下订单、付款、配送方式，最终是否有售后和返修，整个用户的购物行为完整数据都被记录下来。通过对这些用户行为及相关场景的分析，构建了京东用户画像，如图10所示。&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;其中不仅有用户的年龄、性别、购物习惯，更有根据其购物行为分析出的大量数据， 例如是否已婚，是否有孩子，对促销是否敏感等。另外，实时用户画像可以秒级分析出用户的购买意图，以及实时兴趣偏好。京东推荐用户画像技术体系如图11所示。&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;&lt;strong&gt;用户画像在京东各终端的推荐产品中都有应用，618推出的智能卖场是用户画像的典型 应用场景&lt;/strong&gt;。智能卖场的产品包括发现好货、个性化楼层、秒杀、活动、优惠券、分类、标签等。以秒杀为例，推荐结果会根据当前用户的用户画像中的画像模型（性别、年龄、促销敏感度、品类偏好、购买力）进行加权，让用户最感兴趣的商品排在前面。&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;&lt;strong&gt;用户画像也是场景推荐的核心基础&lt;/strong&gt;。以东家小院为例，根据用户的历史行为汇聚出很多场景标签，按当前用户的画像模型，调整场景标签的排序。如用户选择“包治百病”标签，会按用户画像中的性别、年龄、品类、促销敏感度等画像模型进行推荐商品的重排序。&lt;/span&gt;&lt;/p&gt;&lt;figure&gt;&lt;p&gt;&lt;span&gt;&lt;img data-ratio=&quot;0.6370262390670554&quot; data-src=&quot;https://mmbiz.qpic.cn/mmbiz_jpg/PNzW2yzfW9nkia96AehLsT2Ms5icibl3IicgjA35WicqPictg3oic1VZmTyKPic77EXaPiaaevA0OWa2icZNqkWJunNT7picA/640?wx_fmt=jpeg&quot; data-type=&quot;jpeg&quot; data-w=&quot;686&quot;/&gt;&lt;span&gt;图10　用户画像示意图&lt;/span&gt;&lt;/span&gt;&lt;/p&gt;&lt;/figure&gt;&lt;figure&gt;&lt;p&gt;&lt;span&gt;&lt;img data-ratio=&quot;0.4283746556473829&quot; data-src=&quot;https://mmbiz.qpic.cn/mmbiz_png/PNzW2yzfW9nkia96AehLsT2Ms5icibl3IicgWrC9wpYOa7WL6ic9PDtEqfegmm6MK46AWukiaibsFACicdqjoSBCzfp64Q/640?wx_fmt=png&quot; data-type=&quot;png&quot; data-w=&quot;726&quot;/&gt;&lt;span&gt;图11　京东推荐用户画像技术体系&lt;/span&gt;&lt;/span&gt;&lt;/p&gt;&lt;/figure&gt;&lt;section data-mpa-template=&quot;t&quot; mpa-from-tpl=&quot;t&quot;&gt;&lt;br/&gt;&lt;/section&gt;&lt;section data-mpa-template=&quot;t&quot; mpa-from-tpl=&quot;t&quot;&gt;&lt;section data-mid=&quot;&quot; mpa-from-tpl=&quot;t&quot;&gt;&lt;section data-mid=&quot;&quot; mpa-from-tpl=&quot;t&quot;&gt;&lt;section data-mid=&quot;&quot; mpa-from-tpl=&quot;t&quot;&gt;&lt;section data-mid=&quot;&quot; mpa-from-tpl=&quot;t&quot;&gt;&lt;br mpa-from-tpl=&quot;t&quot;/&gt;&lt;/section&gt;&lt;section data-mid=&quot;&quot; mpa-from-tpl=&quot;t&quot;&gt;&lt;br mpa-from-tpl=&quot;t&quot;/&gt;&lt;/section&gt;&lt;section data-mid=&quot;&quot; mpa-from-tpl=&quot;t&quot;&gt;&lt;br mpa-from-tpl=&quot;t&quot;/&gt;&lt;/section&gt;&lt;/section&gt;&lt;section data-mid=&quot;&quot; mpa-from-tpl=&quot;t&quot;&gt;&lt;section data-mid=&quot;&quot; mpa-from-tpl=&quot;t&quot;&gt;&lt;br mpa-from-tpl=&quot;t&quot;/&gt;&lt;/section&gt;&lt;section data-mid=&quot;&quot; mpa-from-tpl=&quot;t&quot;&gt;&lt;p data-mid=&quot;&quot; mpa-is-content=&quot;t&quot;&gt;&lt;strong&gt;特征服务平台&lt;/strong&gt;&lt;/p&gt;&lt;/section&gt;&lt;section data-mid=&quot;&quot; mpa-from-tpl=&quot;t&quot;&gt;&lt;br mpa-from-tpl=&quot;t&quot;/&gt;&lt;/section&gt;&lt;/section&gt;&lt;section data-mid=&quot;&quot; mpa-from-tpl=&quot;t&quot;&gt;&lt;section data-mid=&quot;&quot; mpa-from-tpl=&quot;t&quot;&gt;&lt;br mpa-from-tpl=&quot;t&quot;/&gt;&lt;/section&gt;&lt;section data-mid=&quot;&quot; mpa-from-tpl=&quot;t&quot;&gt;&lt;br mpa-from-tpl=&quot;t&quot;/&gt;&lt;/section&gt;&lt;section data-mid=&quot;&quot; mpa-from-tpl=&quot;t&quot;&gt;&lt;br/&gt;&lt;/section&gt;&lt;/section&gt;&lt;/section&gt;&lt;/section&gt;&lt;/section&gt;&lt;p&gt;&lt;span&gt;&lt;strong&gt;特征就是一种属性的描述，特征是个性化推荐的基础，常用的特征分为单边特征和双边特征。&lt;/strong&gt;单边特征是指对象本身的属性描述，如商品的颜色；双边特征是指两个对象交互程度的描述，如某用户最近一小时浏览的品牌与候选集中品牌的匹配程度。从特征生成的场景来说，分为离线特征和实时特征。&lt;strong&gt;离线特征&lt;/strong&gt;是通过算法模型提前生成&lt;strong&gt;，实时特征&lt;/strong&gt;是通过实时计算的方式生成的。特征的质量直接影响推荐的效果、特征计算的性能，同时影响个性化推荐的处理能力。另外，共享和复用特征可以提高算法的迭代速度并节约人力成本。&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;&lt;br/&gt;&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;&lt;strong&gt;特征服务管理平台主要针对特征数据和特征计算，进行有效声明和管理，进而达到特征资源的共享和复用。&lt;/strong&gt;特征服务平台能快速满足针对制定不同的特征进行有效的声明、上线、测试以及A/B实验效果对比的需求，做到特征的可维护、可说明、可验证。特征服务平台的主要功能如下：离线特征的定制化使用，在线特征的定制化使用，由定制化特征产生新的特征，部分特征、模型在线申明，不同特征效果快速A/B。特征服务平台架构如图12所示。&lt;/span&gt;&lt;/p&gt;&lt;figure&gt;&lt;p&gt;&lt;span&gt;&lt;img data-ratio=&quot;0.7113702623906706&quot; data-src=&quot;https://mmbiz.qpic.cn/mmbiz_jpg/PNzW2yzfW9nkia96AehLsT2Ms5icibl3Iicg8Ab2iaKaLrv5gJT3MteyZ3SvmkicyjxwqXkiaibVbt5eGicgaNBsLlLEWlA/640?wx_fmt=jpeg&quot; data-type=&quot;jpeg&quot; data-w=&quot;686&quot; data-backw=&quot;578&quot; data-backh=&quot;411&quot;/&gt;&lt;span&gt;图12　特征服务平台架构&lt;/span&gt;&lt;/span&gt;&lt;/p&gt;&lt;/figure&gt;&lt;p&gt;&lt;span&gt;&lt;br/&gt;&lt;/span&gt;&lt;/p&gt;&lt;section data-mpa-template=&quot;t&quot; mpa-from-tpl=&quot;t&quot;&gt;&lt;section data-mid=&quot;&quot; mpa-from-tpl=&quot;t&quot;&gt;&lt;section data-mid=&quot;&quot; mpa-from-tpl=&quot;t&quot;&gt;&lt;section data-mid=&quot;&quot; mpa-from-tpl=&quot;t&quot;&gt;&lt;img data-ratio=&quot;0.7837837837837838&quot; data-src=&quot;https://mmbiz.qpic.cn/mmbiz_png/siayVELeBkzWBXV8e57JJ4OyQuuMXTfadZCia0bN2sFBfdbTRlFx0S97kyKKjic5v6eaZ8cY4WQt0UEu4dkyowHYg/640?wx_fmt=png&quot; data-type=&quot;png&quot; data-w=&quot;74&quot;/&gt;&lt;/section&gt;&lt;section data-mid=&quot;&quot; mpa-from-tpl=&quot;t&quot;&gt;&lt;img data-ratio=&quot;0.7837837837837838&quot; data-src=&quot;https://mmbiz.qpic.cn/mmbiz_png/rl6daM2XiabyLSr7nSTyAzcoZqPAsfe5tOOrXX0aciaVAfibHeQk5NOfQTdESRsezCwstPF02LeE4RHaH6NBEB9Rw/640?wx_fmt=png&quot; data-type=&quot;png&quot; data-w=&quot;74&quot;/&gt;&lt;/section&gt;&lt;section data-mid=&quot;&quot; mpa-from-tpl=&quot;t&quot;&gt;&lt;p data-mid=&quot;&quot; mpa-is-content=&quot;t&quot;&gt;&lt;strong&gt;场景特征回放技术&lt;/strong&gt;&lt;/p&gt;&lt;/section&gt;&lt;/section&gt;&lt;/section&gt;&lt;/section&gt;&lt;p&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;推荐的一般处理逻辑是每次请求会召回一批商品，然后根据用户的行为数据和用户模型计算出每个商品的特征。算法模型会根据每个商品的特征计算出每个商品的得分，最后选出得分最高的几个商品推荐给用户。&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;&lt;br/&gt;&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;线上计算特征这种行为是一次性的，不会被记录下来。因此在线下训练模型的时候，如果想利用上述的特征，就需要在线下机器上再次计算一遍这些特征。&lt;strong&gt;遗憾的是，线下计算出来的特征往往不能和线上特征完全相同，这就导致了模型训练的效果较差&lt;/strong&gt;。场景特征回放示意图如图13所示，推荐业务调用推荐引擎，推荐引擎将场景特征通过特征回放服务记录下来，推送至大数据平台，机器学习根据场景特征数据重新训练算法模型，进而影响推荐引擎中的排序，形成一个场景闭环推荐，达到更准确的个性化推荐。&lt;/span&gt;&lt;/p&gt;&lt;figure&gt;&lt;p&gt;&lt;span&gt;&lt;img data-ratio=&quot;0.54292343387471&quot; data-src=&quot;https://mmbiz.qpic.cn/mmbiz_png/PNzW2yzfW9nkia96AehLsT2Ms5icibl3IicgVV88CED6uZLUSQvOWtRJRbotq8w8YzjgvvM9YRwQeMrzczDMwk9V0w/640?wx_fmt=png&quot; data-type=&quot;png&quot; data-w=&quot;431&quot; data-backw=&quot;431&quot; data-backh=&quot;234&quot;/&gt;&lt;span&gt;图13　场景特征回放示意图&lt;/span&gt;&lt;/span&gt;&lt;/p&gt;&lt;/figure&gt;&lt;p&gt;&lt;span&gt;场景特征回放技术架构如图14所示，场景特征回放技术实现过程如下。线上特征一般是一系列的数值，我们将这些特征按照一定的规则组装成一个字符串，然后将特征使用HTTP的POST方法异步发送到服务端。&lt;/span&gt;&lt;/p&gt;&lt;figure&gt;&lt;p&gt;&lt;span&gt;&lt;img data-ratio=&quot;0.4908722109533469&quot; data-src=&quot;https://mmbiz.qpic.cn/mmbiz_png/PNzW2yzfW9nkia96AehLsT2Ms5icibl3Iicg6l523KWMzTdNA3Iu0x2SDRMquBdtD5icpsKsJCfB23N2x09HT12rORQ/640?wx_fmt=png&quot; data-type=&quot;png&quot; data-w=&quot;493&quot;/&gt;&lt;span&gt;图1&lt;/span&gt;&lt;span&gt;4　场景特征回放技术架构&lt;/span&gt;&lt;/span&gt;&lt;/p&gt;&lt;/figure&gt;&lt;p&gt;&lt;span&gt;服务端使用Openresty接收这些HTTP请求，并把HTTP请求中的特征数据落地到本地磁盘文件中。Openresty是一种高性能的Web服务器，能够承受很高的QPS，并且具有很高的稳定性，它的这两点特性保障了服务的稳定。&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;&lt;strong&gt;数据抽取系统&lt;/strong&gt;把服务器集群磁盘上的数据抽取到临时仓库。&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;数据抽取系统对数据进行压缩和过滤处理，然后推送到Hive表中。不同类型的请求会放到不同的分区中，更加方便算法工程师使用这些数据。&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;&lt;strong&gt;个性化推荐系统是一个系统工程，依赖产品、数据、架构、算法、人机交互等进行场景推荐，本节重点从这几个维度阐述了京东的个性化推荐系统&lt;/strong&gt;。推荐系统随着业务发展和社会生活方式的改变而进行不断升级，经历了从PC时代到移动互联时代，从关联推荐走向个性化推荐，从纯商品推荐到多类型推荐的转变。个性化推荐系统已经实现了千人千面。诚然，个性化的效果也有待提升，有些体验类的问题也在逐步完善。目前正在进行或有待提高的方面包括：算法方面丰富知识图谱、深度学习广泛应用；推荐系统方面会更好地支持海量召回、高维特征计算、在线学习，推荐更实时，更精准；产品方面已向“满屏皆智能推荐”方向迈进。最后，希望个性化推荐系统能让购物变得简单，变得更人性化、更丰富、更美好。&lt;/span&gt;&lt;/p&gt;&lt;section data-mpa-template=&quot;t&quot; mpa-from-tpl=&quot;t&quot;&gt;&lt;section data-mid=&quot;&quot; mpa-from-tpl=&quot;t&quot;&gt;&lt;section data-mid=&quot;&quot; mpa-from-tpl=&quot;t&quot;&gt;&lt;section data-mid=&quot;&quot; mpa-from-tpl=&quot;t&quot;&gt;&lt;img data-ratio=&quot;0.04195804195804196&quot; data-src=&quot;https://mmbiz.qpic.cn/mmbiz_png/1BiahkUNKiclteCuCXiaCW4UMxvnLW4rTb6NTKnUoGsLbztIoJUj2t9ttkcdhm6ryDTH9k9b8uyl7Tj9Rf3PaWMYA/640?wx_fmt=png&quot; data-type=&quot;png&quot; data-w=&quot;572&quot;/&gt;&lt;/section&gt;&lt;/section&gt;&lt;/section&gt;&lt;/section&gt;&lt;section data-mpa-template=&quot;t&quot; mpa-from-tpl=&quot;t&quot;&gt;&lt;section data-mid=&quot;&quot; mpa-from-tpl=&quot;t&quot;&gt;&lt;section data-mid=&quot;&quot; mpa-from-tpl=&quot;t&quot;&gt;&lt;section data-mid=&quot;&quot; mpa-from-tpl=&quot;t&quot;&gt;&lt;section data-mid=&quot;&quot; mpa-from-tpl=&quot;t&quot;&gt;&lt;img data-ratio=&quot;3.8&quot; data-src=&quot;https://mmbiz.qpic.cn/mmbiz_png/tfMFNHRtASpMGplp8lGIoBpqOqPXntWkl0blqQeDiaNju61zZnWKLqRUmnZUMw6YC0azozUicdscEtYhewwGRrAw/640?wx_fmt=png&quot; data-type=&quot;png&quot; data-w=&quot;10&quot;/&gt;&lt;/section&gt;&lt;section data-mid=&quot;&quot; mpa-from-tpl=&quot;t&quot;&gt;&lt;img data-ratio=&quot;3.8&quot; data-src=&quot;https://mmbiz.qpic.cn/mmbiz_png/ClJhfDaMV6OJicKyML3obA8pBS2HNSRnHUB0CdnBF79ILjSFf6rgkKv6Y72MFEpibsxkgAEp6hQZibbOs8DbR7meQ/640?wx_fmt=png&quot; data-type=&quot;png&quot; data-w=&quot;10&quot;/&gt;&lt;/section&gt;&lt;/section&gt;&lt;section data-mid=&quot;&quot; mpa-from-tpl=&quot;t&quot;&gt;&lt;section data-mid=&quot;&quot; mpa-from-tpl=&quot;t&quot;&gt;&lt;p data-mid=&quot;&quot; mpa-is-content=&quot;t&quot;&gt;作者简介：&lt;/p&gt;&lt;p data-mid=&quot;&quot; mpa-is-content=&quot;t&quot;&gt;fisherman，时任推荐部门推荐系统负责人，负责推荐部门的架构设计及相关研发工作。&lt;/p&gt;&lt;p data-mid=&quot;&quot; mpa-is-content=&quot;t&quot;&gt;Davidxiaozhi，时任推荐部门推荐系统架构师，负责推荐系统的架构设计和系统升级。&lt;/p&gt;&lt;/section&gt;&lt;/section&gt;&lt;/section&gt;&lt;/section&gt;&lt;/section&gt;&lt;section&gt;&lt;br/&gt;&lt;/section&gt;&lt;section&gt;&lt;span&gt;点击下方传送门，&lt;/span&gt;&lt;strong&gt;&lt;span&gt;关注我们&lt;/span&gt;&lt;/strong&gt;&lt;span&gt;哦~&lt;/span&gt;&lt;/section&gt;&lt;section class=&quot;mp_profile_iframe_wrp&quot;&gt;&lt;mpprofile class=&quot;js_uneditable custom_select_card mp_profile_iframe&quot; data-pluginname=&quot;mpprofile&quot; data-id=&quot;MzI2MDU3OTgyOQ==&quot; data-headimg=&quot;http://mmbiz.qpic.cn/mmbiz_png/02kicEWsIniciaRWJ07GCCGQZ65yrAqsUqjdJ5e37HmjZBE5JaFMGb7VmW4p3YcuYRpibEzFTabwl07IaMEqCNwzcA/0?wx_fmt=png&quot; data-nickname=&quot;搜索与推荐Wiki&quot; data-alias=&quot;SearchAndRecWiki&quot; data-signature=&quot;专注于搜索和推荐系统，以系列分享为主，持续打造精品内容！&quot;/&gt;&lt;/section&gt;&lt;section&gt;&lt;br/&gt;&lt;/section&gt;&lt;pre&gt;&lt;section data-brushtype=&quot;text&quot;&gt;&lt;strong&gt;&lt;span&gt;&lt;strong&gt;&lt;span&gt;—&lt;/span&gt;&lt;/strong&gt;完&lt;strong&gt;&lt;span&gt;&lt;strong&gt;&lt;span&gt;—&lt;/span&gt;&lt;/strong&gt;&lt;/span&gt;&lt;/strong&gt;&lt;/span&gt;&lt;/strong&gt;&lt;/section&gt;&lt;pre&gt;&lt;section&gt;&lt;section powered-by=&quot;xiumi.us&quot;&gt;&lt;section&gt;&lt;section&gt;&lt;section&gt;&lt;section powered-by=&quot;xiumi.us&quot;&gt;&lt;section&gt;&lt;section&gt;&lt;section&gt;&lt;br/&gt;&lt;/section&gt;&lt;p&gt;&lt;img class=&quot;rich_pages __bg_gif&quot; data-backh=&quot;321&quot; data-backw=&quot;578&quot; data-cropselx1=&quot;0&quot; data-cropselx2=&quot;578&quot; data-cropsely1=&quot;0&quot; data-cropsely2=&quot;321&quot; data-ratio=&quot;0.5555555555555556&quot; data-type=&quot;gif&quot; data-w=&quot;639&quot; data-src=&quot;https://mmbiz.qpic.cn/mmbiz_gif/02kicEWsInicjLSQIJKCWcOk64en0p55eBNywfpYexwFVhjtMkEZ2cUKf0qZ2BCiaL2SBo2fPm1Zdn1LYZchqSmKA/640?wx_fmt=gif&quot;/&gt;&lt;/p&gt;&lt;p&gt;&lt;img class=&quot;rich_pages __bg_gif&quot; data-backh=&quot;33&quot; data-backw=&quot;546&quot; data-cropselx1=&quot;0&quot; data-cropselx2=&quot;546&quot; data-cropsely1=&quot;0&quot; data-cropsely2=&quot;33&quot; data-ratio=&quot;0.059654631083202514&quot; data-s=&quot;300,640&quot; data-type=&quot;gif&quot; data-w=&quot;637&quot; data-src=&quot;https://mmbiz.qpic.cn/mmbiz_gif/TsomEQAKP4eyMZqYnRlJaibWPMPOK9EE6SaWtprTnQ0rsZd6mTHRCD2dHLKIKicHP6cibfNSAPJndY8OicbSmZYibEw/640?wx_fmt=gif&quot;/&gt;&lt;/p&gt;&lt;/section&gt;&lt;/section&gt;&lt;/section&gt;&lt;/section&gt;&lt;/section&gt;&lt;/section&gt;&lt;/section&gt;&lt;/section&gt;&lt;/pre&gt;&lt;/pre&gt;
                &lt;/div&gt;

                

                



                
                &lt;/div&gt;&lt;/div&gt;</content:encoded>
</item>
</channel></rss>