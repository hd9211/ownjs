<?xml version="1.0" encoding="UTF-8"?>
        <rss version="2.0" xmlns:content="http://purl.org/rss/1.0/modules/content/">
            <channel>
            <title>开发者头条</title>
            <link>http://toutiao.io/</link>
            <description></description>
<item>
<guid>492648e91b5b0f73105be2abc7dbcc42</guid>
<title>2022 年升职加薪就靠它了！抓紧时间！</title>
<link>https://toutiao.io/k/fitvcz1</link>
<content:encoded>&lt;div&gt;&lt;div&gt;&lt;div class=&quot;profile_inner&quot;&gt;
                              &lt;strong class=&quot;profile_nickname&quot;&gt;开发者头条&lt;/strong&gt;
                              &lt;img class=&quot;profile_avatar&quot; id=&quot;js_profile_qrcode_img&quot; src=&quot;&quot; alt=&quot;&quot;/&gt;

                              &lt;p class=&quot;profile_meta&quot;&gt;
                              &lt;label class=&quot;profile_meta_label&quot;&gt;Weixin ID&lt;/label&gt;
                              &lt;span class=&quot;profile_meta_value&quot;&gt;kaifazhetoutiao&lt;/span&gt;
                              &lt;/p&gt;

                              &lt;p class=&quot;profile_meta&quot;&gt;
                              &lt;label class=&quot;profile_meta_label&quot;&gt;About Feature&lt;/label&gt;
                              &lt;span class=&quot;profile_meta_value&quot;&gt;程序员分享平台 | 官方应用下载地址：http://toutiao.io/download&lt;/span&gt;
                              &lt;/p&gt;
                              
                          &lt;/div&gt;
                          &lt;/div&gt;&lt;/div&gt;</content:encoded>
</item>
<item>
<guid>bc30ec71cff02337f98b8aaaa1011dc0</guid>
<title>深度分页，我都是这么玩的</title>
<link>https://toutiao.io/k/p61u81q</link>
<content:encoded>&lt;div&gt;&lt;div&gt;&lt;div class=&quot;weui-dialog&quot;&gt;
      &lt;p class=&quot;weui-dialog__hd&quot;&gt;&lt;strong class=&quot;weui-dialog__title&quot;&gt;&quot;Top Stories&quot; is disabled&lt;/strong&gt;&lt;/p&gt;
      &lt;p class=&quot;weui-dialog__bd&quot;&gt;
        Enable &quot;Top Stories&quot; in &quot;Settings&quot; &amp;gt; &quot;General&quot; &amp;gt; &quot;Manage Discover&quot;      &lt;/p&gt;
      
    &lt;/div&gt;
  &lt;/div&gt;&lt;/div&gt;</content:encoded>
</item>
<item>
<guid>d265d35077231d4586b6820fd4ef7611</guid>
<title>2022 年要考虑的 7 种 Docker 替代方案</title>
<link>https://toutiao.io/k/ywk73n5</link>
<content:encoded>&lt;div&gt;&lt;div&gt;&lt;section&gt;&lt;p&gt;&lt;img class=&quot;rich_pages wxw-img&quot; data-galleryid=&quot;&quot; data-ratio=&quot;0.15625&quot; data-src=&quot;https://mmbiz.qpic.cn/mmbiz_gif/YriaiaJPb26VN5koUu22VNrAnuXDfGLRs8w4tRT63wErRVia5ic9J4ZyzWLDwcKT1Ldrzibn8lWIAnCQmkMCAVEtuIg/640?wx_fmt=gif&quot; data-type=&quot;gif&quot; data-w=&quot;640&quot;/&gt;&lt;/p&gt;&lt;section&gt;作者 | Sudip Sengupta&lt;/section&gt;&lt;section&gt;
译者 | 辛晓亮&lt;/section&gt;&lt;p&gt;许多企业都采用容器来进行开发和管理稳定的应用程序，Docker 是该领域功能最丰富且使用最广泛的工具之一，已有数百万应用程序在使用它。Docker 本身有着强大的独立生态系统，并提供了一个广泛的工具包来管理容器化过程，但 Docker 还有其他替代品，它们提供了独特的用例和功能。本文深入探讨了 Docker 七个替代品，其中包括一系列综合平台，如 Docker 以及可以作为 Docker 生态系统组件替代品的工具等。&lt;/p&gt;&lt;section&gt;
&lt;span&gt;Podman&lt;/span&gt;&lt;/section&gt;&lt;p&gt;&lt;img class=&quot;rich_pages wxw-img&quot; data-ratio=&quot;0.2852852852852853&quot; data-src=&quot;https://mmbiz.qpic.cn/mmbiz_png/YriaiaJPb26VPdOhe0afO6YmFOckTwrr17v7vcib7WiaCFZA3GyyNEGfb7vuNsDSIqF2GeqZKovvBRsCDRibyomDqQw/640?wx_fmt=png&quot; data-type=&quot;png&quot; data-w=&quot;1332&quot;/&gt;&lt;/p&gt;&lt;p&gt;Podman 是 RedHat 开发的一个无守护程序的开源 Linux 原生容器引擎，用于构建、运行和管理 Linux OCI 容器与容器镜像。尽管 Podman 提供了一个类似于 Docker 的命令行界面，但它的操作方式并不相同。&lt;/p&gt;&lt;p&gt;Docker 和 Podman 之间的一个显著区别是，Docker 运行一个持久的、自给自足的运行时来管理其对象或称为 dockerd 的守护进程；而 Podman 并不依赖守护进程来工作，相反，Podman 将容器作为子进程启动，它还直接与注册表和使用运行时进程的 Linux 内核进行交互，也正因如此，Podman 被称为无守护进程的容器技术。&lt;/p&gt;&lt;p&gt;没有守护进程提高了 Podman 作为容器引擎的灵活性，消除了对单个进程的依赖。Podman 与 Docker 的另一大不同就是它不需要 root 权限。这一特点提供了一个额外的安全缓冲区，限制了某些可能操纵关键系统设置并使容器和包含的应用程序易受攻击的潜在危险进程。&lt;/p&gt;&lt;p&gt;此外，Podman 可以运行 pod-- 包含一个或多个容器的集合，作为一个单一实体管理，并利用共享的资源池。通过这项能力，Podman 用户可以将他们的工作负载转移到 Kubernetes。&lt;/p&gt;&lt;section&gt;
&lt;span&gt;L  X  D&lt;/span&gt;&lt;/section&gt;&lt;p&gt;&lt;img class=&quot;rich_pages wxw-img&quot; data-ratio=&quot;0.34294385432473445&quot; data-src=&quot;https://mmbiz.qpic.cn/mmbiz_png/YriaiaJPb26VPdOhe0afO6YmFOckTwrr17ygsk3jCfFca9MTzgDHXTCIU5dGx6KwPNz0GwGEzm4wFF5uALsjxIrg/640?wx_fmt=png&quot; data-type=&quot;png&quot; data-w=&quot;1318&quot;/&gt;&lt;/p&gt;&lt;p&gt;LXD 一个专为 LXC Linux 容器设计的开源容器引擎。LXC 使用户能够在隔离的容器或类似于虚拟机的虚拟环境中运行应用程序，而无需承担管理单个内核的技术负担。LXD 提供了一个用于连接 LXC 软件库的接口，同时创建了一个守护进程，负责处理网络、数据存储和管理多个 LXC 容器。尽管 LXC 可以作为独立工具运行，但它拥有有限的功能子集。LXD 提供了这些附加功能，因此依赖于 LXC 工作。&lt;/p&gt;&lt;p&gt;LXD 与 Docker 的主要区别如下。与 Docker 建议每个容器只有单个进程的设计模式不同，LXC/LXD 中的容器可以运行多个进程。此外，Docker 容器可移植性更强，为与 LXD 相比，Docker 有效地抽象了资源。最后，Docker 支持在 Windows 和 macOS 环境上运行，但 LXD 只支持 Linux。&lt;/p&gt;&lt;section&gt;
&lt;span&gt;containerd&lt;/span&gt;&lt;/section&gt;&lt;p&gt;&lt;img class=&quot;rich_pages wxw-img&quot; data-ratio=&quot;0.3249444855662472&quot; data-src=&quot;https://mmbiz.qpic.cn/mmbiz_png/YriaiaJPb26VPdOhe0afO6YmFOckTwrr17TiaFWSIfjhzEYEW6Pk4M4etCCh8I9B3sEcL0mLo8x5AniayEAMtVmbOQ/640?wx_fmt=png&quot; data-type=&quot;png&quot; data-w=&quot;1351&quot;/&gt;&lt;/p&gt;&lt;p&gt;containerd 是一个高级容器运行时，它通过在底层运行 runc 以提供操作系统和容器引擎之间的接口。runc 是一个支持 Windows 和 Linux 的守护进程，它抽象了特定于操作系统的功能，使运行和监督容器以及管理图像传输和存储变得更加容易。&lt;/p&gt;&lt;p&gt;containerd 提供的这种抽象级别功能消除了进行若干低级系统调用的复杂性，使得容器的可移植性得以实现。然而，与 Docker 不同，containerd 不处理镜像的构建或卷的创建。有趣的是，containerd 是 Docker 的默认运行时，现在它是一个独立的工具，就像 runc 一样。这也使得 containerd 像 Kubernetes 一样成为一个方便的编排工具，containerd 也是最受欢迎的 Docker 替代品之一。&lt;/p&gt;&lt;section&gt;
&lt;span&gt;Buildah&lt;/span&gt;&lt;/section&gt;&lt;p&gt;&lt;img class=&quot;rich_pages wxw-img&quot; data-ratio=&quot;0.2906875543951262&quot; data-src=&quot;https://mmbiz.qpic.cn/mmbiz_png/YriaiaJPb26VPdOhe0afO6YmFOckTwrr17ZcY4FuiauOUibQicmxfyEy78iaeJq9rHIefza085fsHJy4I3eaZp5XYBpQ/640?wx_fmt=png&quot; data-type=&quot;png&quot; data-w=&quot;1149&quot;/&gt;&lt;/p&gt;&lt;p&gt;Buildah 是红帽基金会为容器化系统开发的一个 OCI 镜像构建工具。它是一个提供类似于在 Docker 中运行 &lt;code&gt;docker build&lt;/code&gt; 的功能的工具。Buildah 经常与 Podman 一起使用，互作补充，例如，Podman 在后台使用 Buildah 功能的子集来实现其构建过程。&lt;/p&gt;&lt;p&gt;它可以从 Dockerfile 或 Containerfile 中构建镜像，并生成与使用 Docker 创建的镜像相同的镜像，因为这些镜像是符合 OCI 的。此外，它还提供了对镜像层的细粒度控制，允许在一个单一层中进行多次修改提交。它还提供了从头开始构建镜像的能力，即不包含任何内容的镜像，这让用户可以自由地只添加运行应用程序所需的软件包。最后，与 Docker 不同的是，在 Buildah 中，用户只能看到他们构建的镜像。&lt;/p&gt;&lt;section&gt;
&lt;span&gt;BuildKit&lt;/span&gt;&lt;/section&gt;&lt;p&gt;&lt;img class=&quot;rich_pages wxw-img&quot; data-ratio=&quot;0.2831230283911672&quot; data-src=&quot;https://mmbiz.qpic.cn/mmbiz_png/YriaiaJPb26VPdOhe0afO6YmFOckTwrr17cyEvAcrCF9Uu7qQxbcicbBxRgu3mf5tO0hFK7qjV4246pJG24Uk6PicQ/640?wx_fmt=png&quot; data-type=&quot;png&quot; data-w=&quot;1268&quot;/&gt;&lt;/p&gt;&lt;p&gt;BuildKit 是第二代构建镜像的 Moby 项目，在较新的 Docker 版本中作为实验性功能提供。&lt;span&gt;与 Do&lt;/span&gt;&lt;span&gt;cker 一样，它使用守护程序&lt;/span&gt;运行。不过，标准 Docker 构建和 BuildKit 之间的主要区别之一是，前者是逐层构建，后者提供并行构建处理。这个功能提高了性能，使构建速度更快。BuildKit 还允许跳过未使用的阶段，改善增量构建，并允许无根构建。此外，BuildKit 使用一个缓存来减少重建图像每一层的需要。&lt;/p&gt;&lt;section&gt;
&lt;span&gt;Kaniko&lt;/span&gt;&lt;/section&gt;&lt;p&gt;&lt;img class=&quot;rich_pages wxw-img&quot; data-ratio=&quot;0.3467297084318361&quot; data-src=&quot;https://mmbiz.qpic.cn/mmbiz_png/YriaiaJPb26VPdOhe0afO6YmFOckTwrr17oDFlibicibMlDxGwy9MnM3QVwZiaBcuhKdrMNFNzAK4fdUc0N5m7ZTXjKQ/640?wx_fmt=png&quot; data-type=&quot;png&quot; data-w=&quot;1269&quot;/&gt;&lt;/p&gt;&lt;p&gt;Kaniko 是一个谷歌镜像构建工具，它可以从 Dockerfile 构建镜像。它和 Buildah 一样是无守护进程的，但更侧重于在 Kubernetes 中构建镜像。Kaniko 对于本地开发实例来说不是很方便，因为它通常作为镜像与 Kubernetes 等容器编排器一起运行。对于 Kubernetes 集群中的持续集成和交付管道，Kaniko 可以成为一个实用的工具。&lt;/p&gt;&lt;section&gt;
&lt;span&gt;RunC&lt;/span&gt;&lt;/section&gt;&lt;p&gt;&lt;img class=&quot;rich_pages wxw-img&quot; data-ratio=&quot;0.3230437903804738&quot; data-src=&quot;https://mmbiz.qpic.cn/mmbiz_png/YriaiaJPb26VPdOhe0afO6YmFOckTwrr17FAXBYfic6Y7wwhYfHTAMrY5HE72EoggsRuXmnrmGQz1AOP3TZiajOOmA/640?wx_fmt=png&quot; data-type=&quot;png&quot; data-w=&quot;1393&quot;/&gt;&lt;/p&gt;&lt;p&gt;RunC 以前是嵌入到 Docker 架构中的一个模块，在 2015 年作为独立工具发布。此后，它成为一个广泛使用的、标准化的、可互操作的容器运行时。DevOps 团队可以将其作为 Docker 或其他定制容器引擎的一部分。RunC 属于容器化生态系统中的容器运行时部分。容器运行时是处理容器运行的容器引擎中使用的较低级别的组件。&lt;/p&gt;&lt;p&gt;尽管 Docker 为组织在容器化过程中所需的各个方面提供了一个全面的工具包，但某些 DevOps 功能可能需要探索其他替代方案。但是，在选择任何此类选项时也需牢记此类替代方案所运行的主机操作系统及其使用情况。&lt;/p&gt;&lt;p&gt;&lt;strong&gt;&lt;span&gt;原文链接：&lt;/span&gt;&lt;/strong&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;https://www.containiq.com/post/docker-alternatives&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;&lt;span&gt;点击底部&lt;/span&gt;&lt;span&gt;阅读原文&lt;/span&gt;&lt;span&gt;访问 InfoQ 官网，获取更多精彩内容！&lt;/span&gt;&lt;/span&gt;&lt;/p&gt;&lt;section&gt;&lt;span photoshow-hd-src=&quot;https://mmbiz.qpic.cn/mmbiz_jpg/YriaiaJPb26VNPrPHVrV124MK6fhrWJSGLwiapMkaCSpJichgaCz6JzXr413C6xfEjiasT96KgRdhjRP3CHnaEHQe7A/&quot;&gt;今日好文推荐&lt;/span&gt;&lt;span/&gt;&lt;/section&gt;&lt;section&gt;&lt;p&gt;&lt;a target=&quot;_blank&quot; href=&quot;http://mp.weixin.qq.com/s?__biz=MjM5MDE0Mjc4MA==&amp;amp;mid=2651106089&amp;amp;idx=1&amp;amp;sn=4eb1903a395a9544767d5383bd4cfbff&amp;amp;chksm=bdb9537a8aceda6c96a107d348b5e954fb2107f89870b67a6c50f557c7969029f21b4240aa2d&amp;amp;scene=21#wechat_redirect&quot; textvalue=&quot;75%新项目都可以“无脑”选择单体架构&quot; linktype=&quot;text&quot; imgurl=&quot;&quot; imgdata=&quot;null&quot; data-itemshowtype=&quot;0&quot; tab=&quot;innerlink&quot; data-linktype=&quot;2&quot;&gt;75%新项目都可以“无脑”选择单体架构&lt;/a&gt;&lt;/p&gt;&lt;p&gt;&lt;a target=&quot;_blank&quot; href=&quot;http://mp.weixin.qq.com/s?__biz=MjM5MDE0Mjc4MA==&amp;amp;mid=2651105854&amp;amp;idx=1&amp;amp;sn=346fc790136616fc3e088acc8bf0f950&amp;amp;chksm=bdb9526d8acedb7bff88e236e17002102f92918bb3245796020239927cfa21ce5bd341caad6a&amp;amp;scene=21#wechat_redirect&quot; textvalue=&quot;InfoQ 最新 Java 发展趋势报告&quot; linktype=&quot;text&quot; imgurl=&quot;&quot; imgdata=&quot;null&quot; data-itemshowtype=&quot;0&quot; tab=&quot;innerlink&quot; data-linktype=&quot;2&quot; wah-hotarea=&quot;click&quot; hasload=&quot;1&quot;&gt;InfoQ 最新 Java 发展趋势报告&lt;/a&gt;&lt;/p&gt;&lt;p&gt;&lt;a target=&quot;_blank&quot; href=&quot;http://mp.weixin.qq.com/s?__biz=MjM5MDE0Mjc4MA==&amp;amp;mid=2651105779&amp;amp;idx=1&amp;amp;sn=9d06a049aa0429b3eb56c6af73305bb0&amp;amp;chksm=bdb951a08aced8b68c97d4d0ed16bdeee3128bd0e081b173b2c35e955c7c09e737af191c2694&amp;amp;scene=21#wechat_redirect&quot; textvalue=&quot;AlphaCode编程比赛击败一半程序员；微信超1亿人视频号看春晚，6.6亿人抢红包；Flutter 2.10发布 ｜ Q资讯&quot; linktype=&quot;text&quot; imgurl=&quot;&quot; imgdata=&quot;null&quot; data-itemshowtype=&quot;0&quot; tab=&quot;innerlink&quot; data-linktype=&quot;2&quot; wah-hotarea=&quot;click&quot; hasload=&quot;1&quot;&gt;AlphaCode编程比赛击败一半程序员；微信超1亿人视频号看春晚，6.6亿人抢红包；Flutter 2.10发布 ｜ Q资讯&lt;/a&gt;&lt;/p&gt;&lt;p&gt;&lt;a target=&quot;_blank&quot; href=&quot;http://mp.weixin.qq.com/s?__biz=MjM5MDE0Mjc4MA==&amp;amp;mid=2651105739&amp;amp;idx=1&amp;amp;sn=0c9a1d1a5b45c7a5a5c6779cb3f2a232&amp;amp;chksm=bdb951988aced88e599f05b2cb023a267e074a033cfb395d5742b5dbd7c5fd08ae924bd5df32&amp;amp;scene=21#wechat_redirect&quot; textvalue=&quot;这十个事件，让“永不宕机”变成了一个笑话&quot; linktype=&quot;text&quot; imgurl=&quot;&quot; imgdata=&quot;null&quot; data-itemshowtype=&quot;0&quot; tab=&quot;innerlink&quot; data-linktype=&quot;2&quot; wah-hotarea=&quot;click&quot; hasload=&quot;1&quot;&gt;这十个事件，让“永不宕机”变成了一个笑话&lt;/a&gt;&lt;span/&gt;&lt;/p&gt;&lt;p&gt;&lt;img class=&quot;rich_pages wxw-img __bg_gif&quot; data-galleryid=&quot;&quot; data-ratio=&quot;1.1515625&quot; data-src=&quot;https://mmbiz.qpic.cn/mmbiz_gif/YriaiaJPb26VNBX66P2F9dF2yuYfbcibGMuaBYgvK62MGPE9HhgU2vptFAUZdaO2cGKCsP4h1DnibIGywKSkFv9b6g/640?wx_fmt=gif&quot; data-type=&quot;gif&quot; data-w=&quot;640&quot;/&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;点个在看少个 bug&lt;/span&gt;&lt;span&gt;&lt;span&gt; &lt;/span&gt;&lt;span&gt;👇&lt;/span&gt;&lt;/span&gt;&lt;/p&gt;&lt;/section&gt;&lt;/section&gt;
                &lt;/div&gt;&lt;/div&gt;</content:encoded>
</item>
<item>
<guid>c0ecc17f15df43325b74b2784a9d2baa</guid>
<title>探索 iOS 编码对包大小的影响</title>
<link>https://toutiao.io/k/9l0jd4q</link>
<content:encoded>&lt;div&gt;&lt;div&gt;&lt;section data-tool=&quot;mdnice编辑器&quot; data-website=&quot;https://www.mdnice.com&quot;&gt;&lt;h2 data-tool=&quot;mdnice编辑器&quot;&gt;从二进制文件层面来分析编码对包大小影响&lt;/h2&gt;&lt;blockquote data-tool=&quot;mdnice编辑器&quot;&gt;&lt;p&gt;以分析属性为例子，介绍一种“从二进制文件层面来分析编码对包大小影响”的分析方法。&lt;/p&gt;&lt;p&gt;文章底部有&lt;strong&gt;抖音直播内推群二维码&lt;span/&gt;&lt;/strong&gt;&lt;span&gt;。&lt;/span&gt;&lt;/p&gt;&lt;/blockquote&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;实验背景：用真机 iphone11，iOS13.5.1，release，build setting 默认设置，linkmap file 使用 arm64 进行实验。&lt;/p&gt;&lt;h3 data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span/&gt;.o 级别对比&lt;span/&gt;&lt;/h3&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;通过对比 ViewControler 没有属性、有一个属性、两个属性的情况：&lt;/p&gt;&lt;pre data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span/&gt;&lt;code&gt;@interface ViewController : UIViewController&lt;br/&gt;&lt;br/&gt;@property (nonatomic, strong) NSString *myString1;&lt;br/&gt;&lt;br/&gt;@property (nonatomic, strong) NSString *myString2;&lt;br/&gt;&lt;br/&gt;@end&lt;br/&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;code&gt;ViewController.o&lt;/code&gt;占用字节&lt;/p&gt;&lt;ul data-tool=&quot;mdnice编辑器&quot; class=&quot;list-paddingleft-2&quot;&gt;&lt;li&gt;&lt;section&gt;没有属性 0.36k&lt;/section&gt;&lt;/li&gt;&lt;li&gt;&lt;section&gt;一个属性 0.67k&lt;/section&gt;&lt;/li&gt;&lt;li&gt;&lt;section&gt;两个属性 0.92k&lt;/section&gt;&lt;/li&gt;&lt;/ul&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;当一个类减少一个属性，会减少 0.25k，这里有一个前提，这个类还有其他属性。&lt;/p&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;因此，我们可以得到一个结论：一个属性占用 0.25K。&lt;/p&gt;&lt;h3 data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span/&gt;查看 linkmap file 中的符号属于哪个 section 的 tips&lt;span/&gt;&lt;/h3&gt;&lt;pre data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span/&gt;&lt;code&gt;&lt;span&gt;# Sections:&lt;/span&gt;&lt;br/&gt;&lt;span&gt;# Address        Size            Segment        Section&lt;/span&gt;&lt;br/&gt;0x10000623C        0x00000224        __TEXT        __text&lt;br/&gt;0x100006460        0x00000090        __TEXT        __stubs&lt;br/&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;__TEXT.__text 的地址范围是 0x10000623C - 0x100006460，那么 linkmap file 中的 Symbols 对应的地址，如果是在这个范围内，就属于__TEXT__.text。&lt;/p&gt;&lt;pre data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span/&gt;&lt;code&gt;0x10000623C        0x00000034        [  1] -[ViewController viewDidLoad]&lt;br/&gt;0x100006270        0x00000010        [  1] -[ViewController myString1]&lt;br/&gt;0x100006280        0x00000014        [  1] -[ViewController setMyString1:]&lt;br/&gt;0x100006294        0x00000010        [  1] -[ViewController myString2]&lt;br/&gt;0x1000062A4        0x00000014        [  1] -[ViewController setMyString2:]&lt;br/&gt;0x1000062B8        0x00000040        [  1] -[ViewController .cxx_destruct]&lt;br/&gt;0x1000062F8        0x00000008        [  2] -[AppDelegate application:didFinishLaunchingWithOptions:]&lt;br/&gt;0x100006300        0x0000008C        [  2] -[AppDelegate application:configurationForConnectingSceneSession:options:]&lt;br/&gt;0x10000638C        0x00000004        [  2] -[AppDelegate application:didDiscardSceneSessions:]&lt;br/&gt;0x100006390        0x00000080        [  3] _main&lt;br/&gt;0x100006410        0x00000004        [  4] -[SceneDelegate scene:willConnectToSession:options:]&lt;br/&gt;0x100006414        0x00000004        [  4] -[SceneDelegate sceneDidDisconnect:]&lt;br/&gt;0x100006418        0x00000004        [  4] -[SceneDelegate sceneDidBecomeActive:]&lt;br/&gt;0x10000641C        0x00000004        [  4] -[SceneDelegate sceneWillResignActive:]&lt;br/&gt;0x100006420        0x00000004        [  4] -[SceneDelegate sceneWillEnterForeground:]&lt;br/&gt;0x100006424        0x00000004        [  4] -[SceneDelegate sceneDidEnterBackground:]&lt;br/&gt;0x100006428        0x00000010        [  4] -[SceneDelegate window]&lt;br/&gt;0x100006438        0x00000014        [  4] -[SceneDelegate setWindow:]&lt;br/&gt;0x10000644C        0x00000014        [  4] -[SceneDelegate .cxx_destruct]&lt;br/&gt;0x100006460        0x0000000C        [  5] _NSStringFromClass&lt;br/&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;0x10000623C 到 0x100006460 的符号都属于__TEXT.__text。&lt;/p&gt;&lt;h3 data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span/&gt;探索一个属性会产生哪些符号&lt;span/&gt;&lt;/h3&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;将 section(节) size 不同拎出来，数字的单位：字节&lt;/p&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;strong&gt;__TEXT 段：&lt;/strong&gt;&lt;/p&gt;&lt;section data-tool=&quot;mdnice编辑器&quot;&gt;&lt;table&gt;&lt;thead&gt;&lt;tr&gt;&lt;th&gt;&lt;span&gt;section&lt;/span&gt;&lt;/th&gt;&lt;th&gt;&lt;span&gt;__text&lt;/span&gt;&lt;/th&gt;&lt;th&gt;&lt;span&gt;__objc_methname&lt;/span&gt;&lt;/th&gt;&lt;th&gt;&lt;span&gt;__objc_methtype&lt;/span&gt;&lt;/th&gt;&lt;th&gt;&lt;span&gt;__objc_classname&lt;/span&gt;&lt;/th&gt;&lt;th&gt;&lt;span&gt;__cstring&lt;/span&gt;&lt;/th&gt;&lt;th&gt;&lt;span&gt;_unwind_info&lt;/span&gt;&lt;/th&gt;&lt;/tr&gt;&lt;/thead&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td&gt;&lt;span&gt;没有属性&lt;/span&gt;&lt;/td&gt;&lt;td&gt;&lt;span&gt;412&lt;/span&gt;&lt;/td&gt;&lt;td&gt;&lt;span&gt;3396&lt;/span&gt;&lt;/td&gt;&lt;td&gt;&lt;span&gt;2831&lt;/span&gt;&lt;/td&gt;&lt;td&gt;&lt;span&gt;112&lt;/span&gt;&lt;/td&gt;&lt;td&gt;&lt;span&gt;144&lt;/span&gt;&lt;/td&gt;&lt;td&gt;&lt;span&gt;100&lt;/span&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td&gt;&lt;span&gt;一个属性&lt;/span&gt;&lt;/td&gt;&lt;td&gt;&lt;span&gt;468&lt;/span&gt;&lt;/td&gt;&lt;td&gt;&lt;span&gt;3431&lt;/span&gt;&lt;/td&gt;&lt;td&gt;&lt;span&gt;2843&lt;/span&gt;&lt;/td&gt;&lt;td&gt;&lt;span&gt;112&lt;/span&gt;&lt;/td&gt;&lt;td&gt;&lt;span&gt;183&lt;/span&gt;&lt;/td&gt;&lt;td&gt;&lt;span&gt;100&lt;/span&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td&gt;&lt;span&gt;两个属性&lt;/span&gt;&lt;/td&gt;&lt;td&gt;&lt;span&gt;548&lt;/span&gt;&lt;/td&gt;&lt;td&gt;&lt;span&gt;3466&lt;/span&gt;&lt;/td&gt;&lt;td&gt;&lt;span&gt;2843&lt;/span&gt;&lt;/td&gt;&lt;td&gt;&lt;span&gt;114&lt;/span&gt;&lt;/td&gt;&lt;td&gt;&lt;span&gt;222&lt;/span&gt;&lt;/td&gt;&lt;td&gt;&lt;span&gt;112&lt;/span&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/section&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;strong&gt;__DATA 段：&lt;/strong&gt;&lt;/p&gt;&lt;section data-tool=&quot;mdnice编辑器&quot;&gt;&lt;table&gt;&lt;thead&gt;&lt;tr&gt;&lt;th&gt;&lt;span&gt;Section&lt;/span&gt;&lt;/th&gt;&lt;th&gt;&lt;span&gt;__objc_const&lt;/span&gt;&lt;/th&gt;&lt;th&gt;&lt;span&gt;__objc_ivar&lt;/span&gt;&lt;/th&gt;&lt;/tr&gt;&lt;/thead&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td&gt;&lt;span&gt;没有属性&lt;/span&gt;&lt;/td&gt;&lt;td&gt;&lt;span&gt;4904&lt;/span&gt;&lt;/td&gt;&lt;td&gt;&lt;span&gt;4&lt;/span&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td&gt;&lt;span&gt;一个属性&lt;/span&gt;&lt;/td&gt;&lt;td&gt;&lt;span&gt;5040&lt;/span&gt;&lt;/td&gt;&lt;td&gt;&lt;span&gt;8&lt;/span&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td&gt;&lt;span&gt;两个属性&lt;/span&gt;&lt;/td&gt;&lt;td&gt;&lt;span&gt;5136&lt;/span&gt;&lt;/td&gt;&lt;td&gt;&lt;span&gt;12&lt;/span&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/section&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;分析：&lt;/p&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;$1 表示没有属性和一个属性的对比&lt;/p&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;$2 表示一个属性和两个属性的对比&lt;/p&gt;&lt;h4 data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span/&gt;TEXT.text 分析&lt;span/&gt;&lt;/h4&gt;&lt;section data-tool=&quot;mdnice编辑器&quot;&gt;&lt;table&gt;&lt;thead&gt;&lt;tr&gt;&lt;th&gt;&lt;span&gt;segment&lt;/span&gt;&lt;/th&gt;&lt;th&gt;&lt;span&gt;section&lt;/span&gt;&lt;/th&gt;&lt;th&gt;&lt;span&gt;没有属性&lt;/span&gt;&lt;/th&gt;&lt;th&gt;&lt;span&gt;一个属性&lt;/span&gt;&lt;/th&gt;&lt;th&gt;&lt;span&gt;两个属性&lt;/span&gt;&lt;/th&gt;&lt;th&gt;&lt;span&gt;$1&lt;/span&gt;&lt;/th&gt;&lt;th&gt;&lt;span&gt;$&lt;/span&gt;&lt;span&gt;2&lt;/span&gt;&lt;/th&gt;&lt;/tr&gt;&lt;/thead&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td&gt;&lt;span&gt;__TEXT&lt;/span&gt;&lt;/td&gt;&lt;td&gt;&lt;span&gt;__text&lt;/span&gt;&lt;/td&gt;&lt;td&gt;&lt;span&gt;412&lt;/span&gt;&lt;/td&gt;&lt;td&gt;&lt;span&gt;468&lt;/span&gt;&lt;/td&gt;&lt;td&gt;&lt;span&gt;548&lt;/span&gt;&lt;/td&gt;&lt;td&gt;&lt;span&gt;56&lt;/span&gt;&lt;/td&gt;&lt;td&gt;&lt;span&gt;80&lt;/span&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/section&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;strong&gt;Linkmap File 差异：&lt;/strong&gt;&lt;/p&gt;&lt;pre data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span/&gt;&lt;code&gt;// ViewController没有属性，差异点是没有-[ViewController .cxx_destruct]符号&lt;br/&gt;// 一个属性: 16 + 20 + 20 = 56(与上方的 &lt;span&gt;$1&lt;/span&gt;是对应上的)&lt;br/&gt;0x100006318        0x00000010        [  1] -[ViewController myString1]&lt;br/&gt;0x100006328        0x00000014        [  1] -[ViewController setMyString1:]&lt;br/&gt;0x10000633C        0x00000014        [  1] -[ViewController .cxx_destruct]&lt;br/&gt;// 两个属性 16 + 20 + 16 + 20 +64 = 136&lt;br/&gt;// 一个属性与两个属性比较 136 - 56 = 80(与上方的 &lt;span&gt;$2&lt;/span&gt;是对应上的)&lt;br/&gt;0x100006270        0x00000010        [  1] -[ViewController myString1]&lt;br/&gt;0x100006280        0x00000014        [  1] -[ViewController setMyString1:]&lt;br/&gt;0x100006294        0x00000010        [  1] -[ViewController myString2]&lt;br/&gt;0x1000062A4        0x00000014        [  1] -[ViewController setMyString2:]&lt;br/&gt;0x1000062B8        0x00000040        [  1] -[ViewController .cxx_destruct]&lt;br/&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;疑惑点：&lt;code&gt;.cxx_destruct&lt;/code&gt;的大小不一样，以下用两个截图回答这个问题，因为.cxx_destruct 内部的实现不一样，导致汇编的指令数量也不一样。&lt;/p&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;strong&gt;一个属性 &lt;code&gt;.cxx_destruct&lt;/code&gt;内部实现的汇编代码：&lt;/strong&gt;&lt;/p&gt;&lt;figure data-tool=&quot;mdnice编辑器&quot;&gt;&lt;img class=&quot;rich_pages wxw-img&quot; data-ratio=&quot;0.3203125&quot; data-src=&quot;https://mmbiz.qpic.cn/mmbiz_png/5EcwYhllQOjicGHFOibJnzTFGzOK9DHryM5c3cjseiaADsRicpFPLhGAtic3hicXzZgybSfpHF7TQiaBQiaHsAwX4FI5KQ/640?wx_fmt=png&quot; data-type=&quot;png&quot; data-w=&quot;1280&quot;/&gt;&lt;/figure&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;strong&gt;两个属性 &lt;code&gt;.cxx_destruct&lt;/code&gt;内部实现的汇编代码：&lt;/strong&gt;&lt;/p&gt;&lt;figure data-tool=&quot;mdnice编辑器&quot;&gt;&lt;img class=&quot;rich_pages wxw-img&quot; data-ratio=&quot;0.35703125&quot; data-src=&quot;https://mmbiz.qpic.cn/mmbiz_png/5EcwYhllQOjicGHFOibJnzTFGzOK9DHryMKAaZicJKict9Cy1lKmq8XHEsWYQHDc3D4PPaxTCREJq9icj8DRChMdfwQ/640?wx_fmt=png&quot; data-type=&quot;png&quot; data-w=&quot;1280&quot;/&gt;&lt;/figure&gt;&lt;h4 data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span/&gt;TEXT.objc_methname 分析&lt;span/&gt;&lt;/h4&gt;&lt;section data-tool=&quot;mdnice编辑器&quot;&gt;&lt;table&gt;&lt;thead&gt;&lt;tr&gt;&lt;th&gt;&lt;span&gt;segment&lt;/span&gt;&lt;/th&gt;&lt;th&gt;&lt;span&gt;section&lt;/span&gt;&lt;/th&gt;&lt;th&gt;&lt;span&gt;没有属性&lt;/span&gt;&lt;/th&gt;&lt;th&gt;&lt;span&gt;一个属性&lt;/span&gt;&lt;/th&gt;&lt;th&gt;&lt;span&gt;两个属性&lt;/span&gt;&lt;/th&gt;&lt;th&gt;&lt;span&gt;$1&lt;/span&gt;&lt;/th&gt;&lt;th&gt;&lt;span&gt;$&lt;/span&gt;&lt;span&gt;2&lt;/span&gt;&lt;/th&gt;&lt;/tr&gt;&lt;/thead&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td&gt;&lt;span&gt;__TEXT&lt;/span&gt;&lt;/td&gt;&lt;td&gt;&lt;span&gt;__objc_methname&lt;/span&gt;&lt;/td&gt;&lt;td&gt;&lt;span&gt;3396&lt;/span&gt;&lt;/td&gt;&lt;td&gt;&lt;span&gt;3431&lt;/span&gt;&lt;/td&gt;&lt;td&gt;&lt;span&gt;3466&lt;/span&gt;&lt;/td&gt;&lt;td&gt;&lt;span&gt;35&lt;/span&gt;&lt;/td&gt;&lt;td&gt;&lt;span&gt;35&lt;/span&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/section&gt;&lt;pre data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span/&gt;&lt;code&gt;// 比较字节方法如上&lt;br/&gt;// 一个属性&lt;br/&gt;0x1000065FC        0x0000000A        [  1] literal string: myString1&lt;br/&gt;0x100006606        0x0000000E        [  1] literal string: setMyString1:&lt;br/&gt;0x100006614        0x0000000E        [  1] literal string: .cxx_destruct&lt;br/&gt;0x100006622        0x0000000B        [  1] literal string: _myString1&lt;br/&gt;// 两个属性&lt;br/&gt;0x1000065A4        0x0000000A        [  1] literal string: myString1&lt;br/&gt;0x1000065AE        0x0000000E        [  1] literal string: setMyString1:&lt;br/&gt;0x1000065BC        0x0000000A        [  1] literal string: myString2&lt;br/&gt;0x1000065C6        0x0000000E        [  1] literal string: setMyString2:&lt;br/&gt;0x1000065D4        0x0000000E        [  1] literal string: .cxx_destruct&lt;br/&gt;0x1000065E2        0x0000000B        [  1] literal string: _myString1&lt;br/&gt;0x1000065ED        0x0000000B        [  1] literal string: _myString2&lt;br/&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;这里补充额外的一个点&lt;code&gt;Dead Stripped Symbols&lt;/code&gt;相关的知识点：&lt;/p&gt;&lt;pre data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span/&gt;&lt;code&gt;// Text.text&lt;br/&gt;0x1000062B8        0x00000040        [  1] -[ViewController .cxx_destruct]&lt;br/&gt;0x10000644C        0x00000014        [  4] -[SceneDelegate .cxx_destruct]&lt;br/&gt;// TEXT.objc_methname&lt;br/&gt;0x1000065D4        0x0000000E        [  1] literal string: .cxx_destruct&lt;br/&gt;&amp;lt;&amp;lt;dead&amp;gt;&amp;gt;         0x0000000E            [  4] literal string: .cxx_destruct&lt;br/&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;code&gt;Dead Stripped Symbols&lt;/code&gt;的意思是.o 文件中不必要的符号去掉；&lt;/p&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;例如&lt;code&gt;[ 4] literal string: .cxx_destruct&lt;/code&gt;就是不必要的符号，&lt;code&gt;[ 4]是指SceneDelegate.o&lt;/code&gt;之所以不必要是因为对于&lt;code&gt;objc_methname&lt;/code&gt;节来说，不需要有同名的符号。&lt;/p&gt;&lt;pre data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span/&gt;&lt;code&gt;// linkfile map内容，[ 4]指SceneDelegate.o&lt;br/&gt;[  4] /Users/xxxx/Library/Developer/Xcode/DerivedData/PacketSize-athynpqwkehwhtfsynewxvtjyvdz/Build/Intermediates.noindex/PacketSize.build/Release-iphoneos/PacketSize.build/Objects-normal/arm64/SceneDelegate.o&lt;br/&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;Xcode 中&lt;code&gt;Dead Stripped Symbols&lt;/code&gt;相关的设置：&lt;/p&gt;&lt;figure data-tool=&quot;mdnice编辑器&quot;&gt;&lt;img class=&quot;rich_pages wxw-img&quot; data-ratio=&quot;0.553763440860215&quot; data-src=&quot;https://mmbiz.qpic.cn/mmbiz_png/5EcwYhllQOjicGHFOibJnzTFGzOK9DHryMWfEoriclbqKUQ2tiag7fAibgjAPd0j7Hic5dLUpHiaiauZT6hDuwwj6jT1Kg/640?wx_fmt=png&quot; data-type=&quot;png&quot; data-w=&quot;1116&quot;/&gt;&lt;/figure&gt;&lt;h4 data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span/&gt;TEXT.objc_methtype&lt;span/&gt;&lt;/h4&gt;&lt;section data-tool=&quot;mdnice编辑器&quot;&gt;&lt;table&gt;&lt;thead&gt;&lt;tr&gt;&lt;th&gt;&lt;span&gt;segment&lt;/span&gt;&lt;/th&gt;&lt;th&gt;&lt;span&gt;section&lt;/span&gt;&lt;/th&gt;&lt;th&gt;&lt;span&gt;没有属性&lt;/span&gt;&lt;/th&gt;&lt;th&gt;&lt;span&gt;一个属性&lt;/span&gt;&lt;/th&gt;&lt;th&gt;&lt;span&gt;两个属性&lt;/span&gt;&lt;/th&gt;&lt;th&gt;&lt;span&gt;$1&lt;/span&gt;&lt;/th&gt;&lt;th&gt;&lt;span&gt;$&lt;/span&gt;&lt;span&gt;2&lt;/span&gt;&lt;/th&gt;&lt;/tr&gt;&lt;/thead&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td&gt;&lt;span&gt;__TEXT&lt;/span&gt;&lt;/td&gt;&lt;td&gt;&lt;span&gt;__objc_methtype&lt;/span&gt;&lt;/td&gt;&lt;td&gt;&lt;span&gt;2831&lt;/span&gt;&lt;/td&gt;&lt;td&gt;&lt;span&gt;2843&lt;/span&gt;&lt;/td&gt;&lt;td&gt;&lt;span&gt;2843&lt;/span&gt;&lt;/td&gt;&lt;td&gt;&lt;span&gt;12&lt;/span&gt;&lt;/td&gt;&lt;td&gt;&lt;span&gt;0&lt;/span&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/section&gt;&lt;pre data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span/&gt;&lt;code&gt;// 有NSString属性，有以下符号&lt;br/&gt;0x1000073CF        0x00000008        [  1] literal string: @16@0:8&lt;br/&gt;0x1000073D7        0x0000000B        [  1] literal string: v24@0:8@16&lt;br/&gt;0x1000073E2        0x0000000C        [  1] literal string: @&lt;span&gt;&quot;NSString&quot;&lt;/span&gt;&lt;br/&gt;// 同样Dead Stripped Symbols中也有@16@0:8、v24@0:8@16&lt;br/&gt;&lt;/code&gt;&lt;/pre&gt;&lt;h4 data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span/&gt;TEXT.cstring 分析&lt;span/&gt;&lt;/h4&gt;&lt;section data-tool=&quot;mdnice编辑器&quot;&gt;&lt;table&gt;&lt;thead&gt;&lt;tr&gt;&lt;th&gt;&lt;span&gt;segment&lt;/span&gt;&lt;/th&gt;&lt;th&gt;&lt;span&gt;section&lt;/span&gt;&lt;/th&gt;&lt;th&gt;&lt;span&gt;没有属性&lt;/span&gt;&lt;/th&gt;&lt;th&gt;&lt;span&gt;一个属性&lt;/span&gt;&lt;/th&gt;&lt;th&gt;&lt;span&gt;两个属性&lt;/span&gt;&lt;/th&gt;&lt;th&gt;&lt;span&gt;$1&lt;/span&gt;&lt;/th&gt;&lt;th&gt;&lt;span&gt;$2&lt;/span&gt;&lt;/th&gt;&lt;/tr&gt;&lt;/thead&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td&gt;&lt;span&gt;__TEXT&lt;/span&gt;&lt;/td&gt;&lt;td&gt;&lt;span&gt;__cstring&lt;/span&gt;&lt;/td&gt;&lt;td&gt;&lt;span&gt;144&lt;/span&gt;&lt;/td&gt;&lt;td&gt;&lt;span&gt;183&lt;/span&gt;&lt;/td&gt;&lt;td&gt;&lt;span&gt;222&lt;/span&gt;&lt;/td&gt;&lt;td&gt;&lt;span&gt;39&lt;/span&gt;&lt;/td&gt;&lt;td&gt;&lt;span&gt;39&lt;/span&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/section&gt;&lt;pre data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span/&gt;&lt;code&gt;// 一个属性 10 + 29 = 39&lt;br/&gt;0x100007EE2        0x0000000A        [  1] literal string: myString1&lt;br/&gt;0x100007EEC        0x0000001D        [  1] literal string: T@&lt;span&gt;&quot;NSString&quot;&lt;/span&gt;,&amp;amp;,N,V_myString1&lt;br/&gt;// 两个属性&lt;br/&gt;0x100007EAF        0x0000000A        [  1] literal string: myString1&lt;br/&gt;0x100007EB9        0x0000001D        [  1] literal string: T@&lt;span&gt;&quot;NSString&quot;&lt;/span&gt;,&amp;amp;,N,V_myString1&lt;br/&gt;0x100007ED6        0x0000000A        [  1] literal string: myString2&lt;br/&gt;0x100007EE0        0x0000001D        [  1] literal string: T@&lt;span&gt;&quot;NSString&quot;&lt;/span&gt;,&amp;amp;,N,V_myString2&lt;br/&gt;&lt;/code&gt;&lt;/pre&gt;&lt;h4 data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span/&gt;TEXT.objc_classname 分析&lt;span/&gt;&lt;/h4&gt;&lt;section data-tool=&quot;mdnice编辑器&quot;&gt;&lt;table&gt;&lt;thead&gt;&lt;tr&gt;&lt;th&gt;&lt;span&gt;segment&lt;/span&gt;&lt;/th&gt;&lt;th&gt;&lt;span&gt;section&lt;/span&gt;&lt;/th&gt;&lt;th&gt;&lt;span&gt;没有属性&lt;/span&gt;&lt;/th&gt;&lt;th&gt;&lt;span&gt;一个属性&lt;/span&gt;&lt;/th&gt;&lt;th&gt;&lt;span&gt;两个属性&lt;/span&gt;&lt;/th&gt;&lt;th&gt;&lt;span&gt;$1&lt;/span&gt;&lt;/th&gt;&lt;th&gt;&lt;span&gt;$&lt;/span&gt;&lt;span&gt;2&lt;/span&gt;&lt;/th&gt;&lt;/tr&gt;&lt;/thead&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td&gt;&lt;span&gt;__TEXT&lt;/span&gt;&lt;/td&gt;&lt;td&gt;&lt;span&gt;__objc_classname&lt;/span&gt;&lt;/td&gt;&lt;td&gt;&lt;span&gt;112&lt;/span&gt;&lt;/td&gt;&lt;td&gt;&lt;span&gt;112&lt;/span&gt;&lt;/td&gt;&lt;td&gt;&lt;span&gt;114&lt;/span&gt;&lt;/td&gt;&lt;td&gt;&lt;span&gt;0&lt;/span&gt;&lt;/td&gt;&lt;td&gt;&lt;span&gt;2&lt;/span&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/section&gt;&lt;pre data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span/&gt;&lt;code&gt;两个属性，比其他多占用了两个字节，目前还不知道这两个字节是怎么排列出来的，字节对齐？&lt;br/&gt;0x100007322        0x0000000F        [  1] literal string: ViewController&lt;br/&gt;0x100007331        0x00000002        [  1] literal string: &lt;br/&gt;0x100007333        0x0000000C        [  2] literal string: AppDelegate&lt;br/&gt;0x10000733F        0x00000016        [  2] literal string: UIApplicationDelegate&lt;br/&gt;0x100007355        0x00000009        [  2] literal string: NSObject&lt;br/&gt;0x10000735E        0x0000000E        [  4] literal string: SceneDelegate&lt;br/&gt;0x10000736C        0x00000016        [  4] literal string: UIWindowSceneDelegate&lt;br/&gt;0x100007382        0x00000010        [  4] literal string: UISceneDelegate&lt;br/&gt;0x100007392        0x00000002        [  4] literal string: &lt;br/&gt;&lt;/code&gt;&lt;/pre&gt;&lt;h4 data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span/&gt;DATA.objc_const 分析&lt;span/&gt;&lt;/h4&gt;&lt;section data-tool=&quot;mdnice编辑器&quot;&gt;&lt;table&gt;&lt;thead&gt;&lt;tr&gt;&lt;th&gt;&lt;span&gt;segment&lt;/span&gt;&lt;/th&gt;&lt;th&gt;&lt;span&gt;section&lt;/span&gt;&lt;/th&gt;&lt;th&gt;&lt;span&gt;没有属性&lt;/span&gt;&lt;/th&gt;&lt;th&gt;&lt;span&gt;一个属性&lt;/span&gt;&lt;/th&gt;&lt;th&gt;&lt;span&gt;两个属性&lt;/span&gt;&lt;/th&gt;&lt;th&gt;&lt;span&gt;$1&lt;/span&gt;&lt;/th&gt;&lt;th&gt;&lt;span&gt;$2&lt;/span&gt;&lt;/th&gt;&lt;/tr&gt;&lt;/thead&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td&gt;&lt;span&gt;__DATA&lt;/span&gt;&lt;/td&gt;&lt;td&gt;&lt;span&gt;__objc_const&lt;/span&gt;&lt;/td&gt;&lt;td&gt;&lt;span&gt;4904&lt;/span&gt;&lt;/td&gt;&lt;td&gt;&lt;span&gt;5040&lt;/span&gt;&lt;/td&gt;&lt;td&gt;&lt;span&gt;5136&lt;/span&gt;&lt;/td&gt;&lt;td&gt;&lt;span&gt;136&lt;/span&gt;&lt;/td&gt;&lt;td&gt;&lt;span&gt;96&lt;/span&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/section&gt;&lt;pre data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span/&gt;&lt;code&gt;没有属性&lt;br/&gt;0x100008110        0x00000020        [  1] __OBJC_&lt;span&gt;$_INSTANCE_METHODS_ViewController&lt;/span&gt;&lt;br/&gt;&lt;br/&gt;一个属性 40 + 24 + (104 - 32) = 136&lt;br/&gt;0x100008178        0x00000028        [  1] __OBJC_&lt;span&gt;$_INSTANCE_VARIABLES_ViewController&lt;/span&gt;&lt;br/&gt;0x100008110        0x00000068        [  1] __OBJC_&lt;span&gt;$_INSTANCE_METHODS_ViewController&lt;/span&gt;&lt;br/&gt;0x1000081A0        0x00000018        [  1] __OBJC_&lt;span&gt;$_PROP_LIST_ViewController&lt;/span&gt;&lt;br/&gt;&lt;br/&gt;两个属性 (152 - 104) + (72 - 40) + (40 - 24) = 96&lt;br/&gt;0x100008110        0x00000098        [  1] __OBJC_&lt;span&gt;$_INSTANCE_METHODS_ViewController&lt;/span&gt;&lt;br/&gt;0x1000081A8        0x00000048        [  1] __OBJC_&lt;span&gt;$_INSTANCE_VARIABLES_ViewController&lt;/span&gt;&lt;br/&gt;0x1000081F0        0x00000028        [  1] __OBJC_&lt;span&gt;$_PROP_LIST_ViewController&lt;/span&gt;&lt;br/&gt;&lt;/code&gt;&lt;/pre&gt;&lt;h4 data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span/&gt;DATA.objc_ivar 分析&lt;span/&gt;&lt;/h4&gt;&lt;section data-tool=&quot;mdnice编辑器&quot;&gt;&lt;table&gt;&lt;thead&gt;&lt;tr&gt;&lt;th&gt;&lt;span&gt;segment&lt;/span&gt;&lt;/th&gt;&lt;th&gt;&lt;span&gt;section&lt;/span&gt;&lt;/th&gt;&lt;th&gt;&lt;span&gt;没有属性&lt;/span&gt;&lt;/th&gt;&lt;th&gt;&lt;span&gt;一个属性&lt;/span&gt;&lt;/th&gt;&lt;th&gt;&lt;span&gt;两个属性&lt;/span&gt;&lt;/th&gt;&lt;th&gt;&lt;span&gt;$1&lt;/span&gt;&lt;/th&gt;&lt;th&gt;&lt;span&gt;$2&lt;/span&gt;&lt;/th&gt;&lt;/tr&gt;&lt;/thead&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td&gt;&lt;span&gt;__DATA&lt;/span&gt;&lt;/td&gt;&lt;td&gt;&lt;span&gt;__objc_ivar&lt;/span&gt;&lt;/td&gt;&lt;td&gt;&lt;span&gt;4&lt;/span&gt;&lt;/td&gt;&lt;td&gt;&lt;span&gt;8&lt;/span&gt;&lt;/td&gt;&lt;td&gt;&lt;span&gt;12&lt;/span&gt;&lt;/td&gt;&lt;td&gt;&lt;span&gt;4&lt;/span&gt;&lt;/td&gt;&lt;td&gt;&lt;span&gt;4&lt;/span&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/section&gt;&lt;pre data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span/&gt;&lt;code&gt;一个属性&lt;br/&gt;0x1000094B0        0x00000004        [  1] _OBJC_IVAR_&lt;span&gt;$_ViewController&lt;/span&gt;._myString1&lt;br/&gt;两个属性&lt;br/&gt;0x100009510        0x00000004        [  1] _OBJC_IVAR_&lt;span&gt;$_ViewController&lt;/span&gt;._myString1&lt;br/&gt;0x100009514        0x00000004        [  1] _OBJC_IVAR_&lt;span&gt;$_ViewController&lt;/span&gt;._myString2&lt;br/&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;strong&gt;总结&lt;/strong&gt;：通过以上的介绍，我们掌握了“从二进制文件层面分析编码对包大小的影响”的分析方法，用此方法我们可以继续分析“函数、direct、block”对包大小的影响。&lt;/p&gt;&lt;h2 data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span/&gt;编码上优化包大小的 Tips&lt;/h2&gt;&lt;h3 data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span/&gt;属性动态化&lt;span/&gt;&lt;/h3&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;探索对属性添加@dynamic 会对二进制文件产生的影响，探索方式跟上面一样，还是通过 link file map 的符号分析：&lt;/p&gt;&lt;pre data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span/&gt;&lt;code&gt;@interface ViewController()&lt;br/&gt;&lt;br/&gt;// 对比myString1属性有无添加@dynamic修饰的区别&lt;br/&gt;@property (nonatomic, copy) NSString *myString1;&lt;br/&gt;&lt;br/&gt;@end&lt;br/&gt;&lt;/code&gt;&lt;/pre&gt;&lt;h4 data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span/&gt;TEXT.text 分析&lt;span/&gt;&lt;/h4&gt;&lt;section data-tool=&quot;mdnice编辑器&quot;&gt;&lt;table&gt;&lt;thead&gt;&lt;tr&gt;&lt;th&gt;&lt;span&gt;segment&lt;/span&gt;&lt;/th&gt;&lt;th&gt;&lt;span&gt;section&lt;/span&gt;&lt;/th&gt;&lt;th&gt;&lt;span&gt;无 dynamic&lt;/span&gt;&lt;/th&gt;&lt;th&gt;&lt;span&gt;有 dynamic&lt;/span&gt;&lt;/th&gt;&lt;th&gt;&lt;span&gt;比较&lt;/span&gt;&lt;/th&gt;&lt;/tr&gt;&lt;/thead&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td&gt;&lt;span&gt;__TEXT&lt;/span&gt;&lt;/td&gt;&lt;td&gt;&lt;span&gt;__text&lt;/span&gt;&lt;/td&gt;&lt;td&gt;&lt;span&gt;412&lt;/span&gt;&lt;/td&gt;&lt;td&gt;&lt;span&gt;468&lt;/span&gt;&lt;/td&gt;&lt;td&gt;&lt;span&gt;56&lt;/span&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/section&gt;&lt;pre data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span/&gt;&lt;code&gt;// 添加dynamic修饰没有以下部分&lt;br/&gt;// 16 + 20 + 20 = 56&lt;br/&gt;0x100006318        0x00000010        [  1] -[ViewController myString1]&lt;br/&gt;0x100006328        0x00000014        [  1] -[ViewController setMyString1:]&lt;br/&gt;0x10000633C        0x00000014        [  1] -[ViewController .cxx_destruct]&lt;br/&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;说明添加了&lt;code&gt;@dynamic&lt;/code&gt;修饰不会生成 getter、setter，并且没有实例变量，自然也不需要在&lt;code&gt;dealloc&lt;/code&gt;中执行置 nil 的代码。&lt;/p&gt;&lt;h4 data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span/&gt;TEXT.objc_methname 分析&lt;span/&gt;&lt;/h4&gt;&lt;section data-tool=&quot;mdnice编辑器&quot;&gt;&lt;table&gt;&lt;thead&gt;&lt;tr&gt;&lt;th&gt;&lt;span&gt;segment&lt;/span&gt;&lt;/th&gt;&lt;th&gt;&lt;span&gt;section&lt;/span&gt;&lt;/th&gt;&lt;th&gt;&lt;span&gt;无 dynamic&lt;/span&gt;&lt;/th&gt;&lt;th&gt;&lt;span&gt;有 dynamic&lt;/span&gt;&lt;/th&gt;&lt;th&gt;&lt;span&gt;比较&lt;/span&gt;&lt;/th&gt;&lt;/tr&gt;&lt;/thead&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td&gt;&lt;span&gt;__TEXT&lt;/span&gt;&lt;/td&gt;&lt;td&gt;&lt;span&gt;__objc_methname&lt;/span&gt;&lt;/td&gt;&lt;td&gt;&lt;span&gt;3431&lt;/span&gt;&lt;/td&gt;&lt;td&gt;&lt;span&gt;3396&lt;/span&gt;&lt;/td&gt;&lt;td&gt;&lt;span&gt;35&lt;/span&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/section&gt;&lt;pre data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span/&gt;&lt;code&gt;// 添加dynamic修饰没有以下部分&lt;br/&gt;// 10 + 14 + 11 = 35&lt;br/&gt;0x1000065FC        0x0000000A        [  1] literal string: myString1&lt;br/&gt;0x100006606        0x0000000E        [  1] literal string: setMyString1:&lt;br/&gt;0x100006622        0x0000000B        [  1] literal string: _myString1&lt;br/&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;说明添加了&lt;code&gt;@dynamic&lt;/code&gt;修饰不会生成 getter、setter，并且没有实例变量，自然就不需要生成对应的常量符号。&lt;/p&gt;&lt;h4 data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span/&gt;TEXT.objc_methtype 分析&lt;span/&gt;&lt;/h4&gt;&lt;section data-tool=&quot;mdnice编辑器&quot;&gt;&lt;table&gt;&lt;thead&gt;&lt;tr&gt;&lt;th&gt;&lt;span&gt;segment&lt;/span&gt;&lt;/th&gt;&lt;th&gt;&lt;span&gt;section&lt;/span&gt;&lt;/th&gt;&lt;th&gt;&lt;span&gt;无 dynamic&lt;/span&gt;&lt;/th&gt;&lt;th&gt;&lt;span&gt;有 dynamic&lt;/span&gt;&lt;/th&gt;&lt;th&gt;&lt;span&gt;比较&lt;/span&gt;&lt;/th&gt;&lt;/tr&gt;&lt;/thead&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td&gt;&lt;span&gt;__TEXT&lt;/span&gt;&lt;/td&gt;&lt;td&gt;&lt;span&gt;__objc_methtype&lt;/span&gt;&lt;/td&gt;&lt;td&gt;&lt;span&gt;2831&lt;/span&gt;&lt;/td&gt;&lt;td&gt;&lt;span&gt;2843&lt;/span&gt;&lt;/td&gt;&lt;td&gt;&lt;span&gt;12&lt;/span&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/section&gt;&lt;pre data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span/&gt;&lt;code&gt;// 添加dynamic修饰没有下面的符号&lt;br/&gt;// 但是在计算添加dynamic收益时，不能将这个计算入内，原因是一个项目一般都是这些符号的&lt;br/&gt;0x1000073E2        0x0000000C        [  1] literal string: @&lt;span&gt;&quot;NSString&quot;&lt;/span&gt;&lt;br/&gt;&lt;/code&gt;&lt;/pre&gt;&lt;h4 data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span/&gt;TEXT.cstring 分析&lt;span/&gt;&lt;/h4&gt;&lt;section data-tool=&quot;mdnice编辑器&quot;&gt;&lt;table&gt;&lt;thead&gt;&lt;tr&gt;&lt;th&gt;&lt;span&gt;segment&lt;/span&gt;&lt;/th&gt;&lt;th&gt;&lt;span&gt;section&lt;/span&gt;&lt;/th&gt;&lt;th&gt;&lt;span&gt;无 dynamic&lt;/span&gt;&lt;/th&gt;&lt;th&gt;&lt;span&gt;有 dynamic&lt;/span&gt;&lt;/th&gt;&lt;th&gt;&lt;span&gt;比较&lt;/span&gt;&lt;/th&gt;&lt;/tr&gt;&lt;/thead&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td&gt;&lt;span&gt;__TEXT&lt;/span&gt;&lt;/td&gt;&lt;td&gt;&lt;span&gt;__cstring&lt;/span&gt;&lt;/td&gt;&lt;td&gt;&lt;span&gt;173&lt;/span&gt;&lt;/td&gt;&lt;td&gt;&lt;span&gt;183&lt;/span&gt;&lt;/td&gt;&lt;td&gt;&lt;span&gt;10&lt;/span&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/section&gt;&lt;pre data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span/&gt;&lt;code&gt;一个属性&lt;br/&gt;0x100007EEC        0x0000001D        [  1] literal string: T@&lt;span&gt;&quot;NSString&quot;&lt;/span&gt;,&amp;amp;,N,V_myString1&lt;br/&gt;dynamic属性&lt;br/&gt;0x100007EF9        0x00000013        [  1] literal string: T@&lt;span&gt;&quot;NSString&quot;&lt;/span&gt;,&amp;amp;,D,N&lt;br/&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;【T@&quot;NSString&quot;,&amp;amp;,N,V_myString1】和【T@&quot;NSString&quot;,&amp;amp;,D,N】是属性类型字符串， property type stringapple 的官方文档中有这个介绍&lt;/p&gt;&lt;blockquote data-tool=&quot;mdnice编辑器&quot;&gt;&lt;p&gt;&lt;span&gt;https://developer.apple.com/library/archive/documentation/Cocoa/Conceptual/ObjCRuntimeGuide/Articles/ocrtPropertyIntrospection.html#//apple_ref/doc/uid/TP40008048-CH101 // 关于属性类型字符串介绍&lt;/span&gt;&lt;/p&gt;&lt;/blockquote&gt;&lt;h4 data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span/&gt;DATA.objc_const 分析&lt;span/&gt;&lt;/h4&gt;&lt;section data-tool=&quot;mdnice编辑器&quot;&gt;&lt;table&gt;&lt;thead&gt;&lt;tr&gt;&lt;th&gt;&lt;span&gt;segment&lt;/span&gt;&lt;/th&gt;&lt;th&gt;&lt;span&gt;section&lt;/span&gt;&lt;/th&gt;&lt;th&gt;&lt;span&gt;无 dynamic&lt;/span&gt;&lt;/th&gt;&lt;th&gt;&lt;span&gt;有 dynamic&lt;/span&gt;&lt;/th&gt;&lt;th&gt;&lt;span&gt;比较&lt;/span&gt;&lt;/th&gt;&lt;/tr&gt;&lt;/thead&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td&gt;&lt;span&gt;__DATA&lt;/span&gt;&lt;/td&gt;&lt;td&gt;&lt;span&gt;__objc_const&lt;/span&gt;&lt;/td&gt;&lt;td&gt;&lt;span&gt;4928&lt;/span&gt;&lt;/td&gt;&lt;td&gt;&lt;span&gt;5040&lt;/span&gt;&lt;/td&gt;&lt;td&gt;&lt;span&gt;112&lt;/span&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/section&gt;&lt;pre data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span/&gt;&lt;code&gt;一个属性&lt;br/&gt;0x100008110        0x00000068        [  1] __OBJC_&lt;span&gt;$_INSTANCE_METHODS_ViewController&lt;/span&gt;&lt;br/&gt;0x100008178        0x00000028        [  1] __OBJC_&lt;span&gt;$_INSTANCE_VARIABLES_ViewController&lt;/span&gt;&lt;br/&gt;&lt;br/&gt;dynamic属性&lt;br/&gt;0x100008110        0x00000020        [  1] __OBJC_&lt;span&gt;$_INSTANCE_METHODS_ViewController&lt;/span&gt;&lt;br/&gt;&lt;br/&gt;(104 - 32) + 40 = 112&lt;br/&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;实例方法列表没有 myString1 的 getter、setter。&lt;/p&gt;&lt;h4 data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span/&gt;DATA.objc_ivar 分析&lt;span/&gt;&lt;/h4&gt;&lt;section data-tool=&quot;mdnice编辑器&quot;&gt;&lt;table&gt;&lt;thead&gt;&lt;tr&gt;&lt;th&gt;&lt;span&gt;segment&lt;/span&gt;&lt;/th&gt;&lt;th&gt;&lt;span&gt;section&lt;/span&gt;&lt;/th&gt;&lt;th&gt;&lt;span&gt;无 dynamic&lt;/span&gt;&lt;/th&gt;&lt;th&gt;&lt;span&gt;有 dynamic&lt;/span&gt;&lt;/th&gt;&lt;th&gt;&lt;span&gt;比较&lt;/span&gt;&lt;/th&gt;&lt;/tr&gt;&lt;/thead&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td&gt;&lt;span&gt;__DATA&lt;/span&gt;&lt;/td&gt;&lt;td&gt;&lt;span&gt;__objc_ivar&lt;/span&gt;&lt;/td&gt;&lt;td&gt;&lt;span&gt;4&lt;/span&gt;&lt;/td&gt;&lt;td&gt;&lt;span&gt;8&lt;/span&gt;&lt;/td&gt;&lt;td&gt;&lt;span&gt;4&lt;/span&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/section&gt;&lt;pre data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span/&gt;&lt;code&gt;dynamic 属性没有以下符号&lt;br/&gt;0x1000094B0        0x00000004        [  1] _OBJC_IVAR_&lt;span&gt;$_ViewController&lt;/span&gt;._myString1&lt;br/&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;没有实例变量，自然就没有&lt;code&gt;_OBJC_IVAR_$_ViewController._myString1&lt;/code&gt;符号。&lt;/p&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;strong&gt;结论&lt;/strong&gt;：用&lt;code&gt;@dynamic&lt;/code&gt;优化一个属性，收益是(229 - 12)= 217B，12 是__objc_methtype 不能算进来；应用场景是对 model 类添加&lt;code&gt;@dynamic&lt;/code&gt;。&lt;/p&gt;&lt;h3 data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span/&gt;方法调用、函数调用、direct 方法调用&lt;span/&gt;&lt;/h3&gt;&lt;h4 data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span/&gt;实验数据&lt;span/&gt;&lt;/h4&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;strong&gt;实验方法：&lt;/strong&gt;&lt;/p&gt;&lt;pre data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span/&gt;&lt;code&gt;// 对照组&lt;br/&gt;&lt;span&gt;#define Test // 先空实现&lt;/span&gt;&lt;br/&gt;void func(ViewController *mSelf)&lt;br/&gt;{&lt;br/&gt;  [mSelf method];&lt;br/&gt;}&lt;br/&gt;&lt;br/&gt;@interface ViewController ()&lt;br/&gt;&lt;br/&gt;@end&lt;br/&gt;&lt;br/&gt;@implementation ViewController&lt;br/&gt;&lt;br/&gt;- (void)viewDidLoad {&lt;br/&gt;  [super viewDidLoad];&lt;br/&gt;  [self &lt;span&gt;test&lt;/span&gt;];&lt;br/&gt;}&lt;br/&gt;&lt;br/&gt;- (void)method&lt;br/&gt;{&lt;br/&gt;  NSLog(@&lt;span&gt;&quot;&quot;&lt;/span&gt;);&lt;br/&gt;}&lt;br/&gt;&lt;br/&gt;- (void)&lt;span&gt;test&lt;/span&gt;&lt;br/&gt;{&lt;br/&gt;    // 2000个 Test 宏的调用，注意，对照组的宏是空实现&lt;br/&gt;}&lt;br/&gt;&lt;br/&gt;// 方法调用 的 实验&lt;br/&gt;// 修改Test宏&lt;br/&gt;&lt;span&gt;#define Test [self method];&lt;/span&gt;&lt;br/&gt;&lt;br/&gt;// 函数调用 的 实验&lt;br/&gt;&lt;span&gt;#define Test func(self);&lt;/span&gt;&lt;br/&gt;&lt;br/&gt;// direct方法调用 的 实验&lt;br/&gt;&lt;span&gt;#define Test [self method];&lt;/span&gt;&lt;br/&gt;- (void)&lt;span&gt;test&lt;/span&gt; __attribute__((objc_direct));&lt;br/&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;strong&gt;使用函数的汇编指令：&lt;/strong&gt;&lt;/p&gt;&lt;figure data-tool=&quot;mdnice编辑器&quot;&gt;&lt;img class=&quot;rich_pages wxw-img&quot; data-ratio=&quot;0.41015625&quot; data-src=&quot;https://mmbiz.qpic.cn/mmbiz_png/5EcwYhllQOjicGHFOibJnzTFGzOK9DHryM6qxPUGZjiaYAnlILWcyiaibGQ6H3jicqCX6IVPmWsR4MerzFXTJCCX1ia4A/640?wx_fmt=png&quot; data-type=&quot;png&quot; data-w=&quot;1280&quot;/&gt;&lt;/figure&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;strong&gt;使用方法的汇编指令：&lt;/strong&gt;&lt;/p&gt;&lt;figure data-tool=&quot;mdnice编辑器&quot;&gt;&lt;img class=&quot;rich_pages wxw-img&quot; data-ratio=&quot;0.39921875&quot; data-src=&quot;https://mmbiz.qpic.cn/mmbiz_png/5EcwYhllQOjicGHFOibJnzTFGzOK9DHryMxAeLqVlEdmvicZWjCKFcp6OglPheZVgiaRUibic0U6S1lckRyY0ia0bx1Bg/640?wx_fmt=png&quot; data-type=&quot;png&quot; data-w=&quot;1280&quot;/&gt;&lt;/figure&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;以上两个截图的汇编指令基本一样，说明在调用 func(self)函数时，因为函数内部实现过于简单，被编译优化了，直接优化为内敛函数。&lt;/p&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;strong&gt;修改 func 函数的实现，避开编译优化：&lt;/strong&gt;&lt;/p&gt;&lt;pre data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span/&gt;&lt;code&gt;// 不影响调用逻辑的情况下，将函数实现改复杂点&lt;br/&gt;void func(ViewController *mSelf)&lt;br/&gt;{&lt;br/&gt;  &lt;span&gt;if&lt;/span&gt; ([mSelf isKindOfClass:[ViewController class]]) {&lt;br/&gt;    [mSelf method];&lt;br/&gt;  }&lt;br/&gt;}&lt;br/&gt;&lt;/code&gt;&lt;/pre&gt;&lt;figure data-tool=&quot;mdnice编辑器&quot;&gt;&lt;img class=&quot;rich_pages wxw-img&quot; data-ratio=&quot;0.5296875&quot; data-src=&quot;https://mmbiz.qpic.cn/mmbiz_png/5EcwYhllQOjicGHFOibJnzTFGzOK9DHryM1VFOENvuMMUSKEn7FqEY3lfU8jBILvPFMgbqlxDEmjNA5X9MALKJvw/640?wx_fmt=png&quot; data-type=&quot;png&quot; data-w=&quot;1280&quot;/&gt;&lt;/figure&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;另外还做了一组方法名长度不同的实验：&lt;/p&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;短方法名：method&lt;/p&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;长方法名：methodmethodmethodmethodmethodmethodmethodmethod&lt;/p&gt;&lt;section data-tool=&quot;mdnice编辑器&quot;&gt;&lt;table&gt;&lt;thead&gt;&lt;tr&gt;&lt;th&gt;&lt;br/&gt;&lt;/th&gt;&lt;th&gt;&lt;span&gt;短方法名&lt;/span&gt;&lt;/th&gt;&lt;th&gt;&lt;span&gt;长方法名&lt;/span&gt;&lt;/th&gt;&lt;/tr&gt;&lt;/thead&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td&gt;&lt;span&gt;对照组&lt;/span&gt;&lt;/td&gt;&lt;td&gt;&lt;span&gt;0.52K&lt;/span&gt;&lt;/td&gt;&lt;td&gt;&lt;span&gt;0.61K&lt;/span&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td&gt;&lt;span&gt;方法调用&lt;/span&gt;&lt;/td&gt;&lt;td&gt;&lt;span&gt;23.98K&lt;/span&gt;&lt;/td&gt;&lt;td&gt;&lt;span&gt;24.07K&lt;/span&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td&gt;&lt;span&gt;函数调用&lt;/span&gt;&lt;/td&gt;&lt;td&gt;&lt;span&gt;16.30K&lt;/span&gt;&lt;/td&gt;&lt;td&gt;&lt;span&gt;16.34K&lt;/span&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td&gt;&lt;span&gt;direct 方法调用&lt;/span&gt;&lt;/td&gt;&lt;td&gt;&lt;span&gt;16.11K&lt;/span&gt;&lt;/td&gt;&lt;td&gt;&lt;span&gt;16.16K&lt;/span&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/section&gt;&lt;h4 data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span/&gt;短方法名和长方法名对二进制大小的影响？&lt;span/&gt;&lt;/h4&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;分别查看短方法名和长方法名的 TEXT.text&lt;/p&gt;&lt;pre data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span/&gt;&lt;code&gt;// 短方法名&lt;br/&gt;0x100004560        0x00005FB4        __TEXT        __text&lt;br/&gt;0x1000045CC        0x00005DDC        [  1] -[ViewController &lt;span&gt;test&lt;/span&gt;]&lt;br/&gt;// 长方法名&lt;br/&gt;0x100004534        0x00005FB4        __TEXT        __text&lt;br/&gt;0x1000045A0        0x00005DDC        [  1] -[ViewController &lt;span&gt;test&lt;/span&gt;]&lt;br/&gt;&lt;br/&gt;大小都是0x00005FB4&lt;br/&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;strong&gt;短方法：&lt;/strong&gt;&lt;/p&gt;&lt;figure data-tool=&quot;mdnice编辑器&quot;&gt;&lt;img class=&quot;rich_pages wxw-img&quot; data-ratio=&quot;0.23076923076923078&quot; data-src=&quot;https://mmbiz.qpic.cn/mmbiz_png/5EcwYhllQOjicGHFOibJnzTFGzOK9DHryMmhib6lVjicQPBTGchRvN62SybxrTeAFYAeh7wpPxSESzX19LuZkcBvYQ/640?wx_fmt=png&quot; data-type=&quot;png&quot; data-w=&quot;1976&quot;/&gt;&lt;/figure&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;strong&gt;长方法：&lt;/strong&gt;&lt;/p&gt;&lt;figure data-tool=&quot;mdnice编辑器&quot;&gt;&lt;img class=&quot;rich_pages wxw-img&quot; data-ratio=&quot;0.2528379772961816&quot; data-src=&quot;https://mmbiz.qpic.cn/mmbiz_png/5EcwYhllQOjicGHFOibJnzTFGzOK9DHryM13Ocv4uabsBabEgcJRW6Z0wy3yvO2HQCY7RItwK75Cc2APbtjxW41g/640?wx_fmt=png&quot; data-type=&quot;png&quot; data-w=&quot;1938&quot;/&gt;&lt;/figure&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;短方法名和长方法名对二进制大小的影响非常小，TEXT.text 的大小是一样的，原因是方法调用主要是操作函数指针，此时方法名长度对此没有影响；&lt;/p&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;那么主要影响是&lt;code&gt;TEXT.objc_methname&lt;/code&gt;&lt;/p&gt;&lt;pre data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span/&gt;&lt;code&gt;// 短方法名&lt;br/&gt;0x10000A664        0x00000D96        __TEXT        __objc_methname&lt;br/&gt;// 长方法名&lt;br/&gt;0x10000A638        0x00000DC0        __TEXT        __objc_methname&lt;br/&gt;&lt;/code&gt;&lt;/pre&gt;&lt;h4 data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span/&gt;本实验中，函数调用和方法调用的区别？&lt;span/&gt;&lt;/h4&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;先对比下方法调用和函数调用，在二进制上的区别：&lt;/p&gt;&lt;pre data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span/&gt;&lt;code&gt;// 函数和方法的区别&lt;br/&gt;// 函数调用&lt;br/&gt;0x100006448        0x000040CC        __TEXT        __text&lt;br/&gt;// 方法调用&lt;br/&gt;0x100004560        0x00005FB4        __TEXT        __text&lt;br/&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;区别还是在 TEXT.text 上。&lt;/p&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;strong&gt;函数调用的汇编：&lt;/strong&gt;&lt;/p&gt;&lt;figure data-tool=&quot;mdnice编辑器&quot;&gt;&lt;img class=&quot;rich_pages wxw-img&quot; data-ratio=&quot;0.5296875&quot; data-src=&quot;https://mmbiz.qpic.cn/mmbiz_png/5EcwYhllQOjicGHFOibJnzTFGzOK9DHryM1VFOENvuMMUSKEn7FqEY3lfU8jBILvPFMgbqlxDEmjNA5X9MALKJvw/640?wx_fmt=png&quot; data-type=&quot;png&quot; data-w=&quot;1280&quot;/&gt;&lt;/figure&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;strong&gt;方法调用的汇编：&lt;/strong&gt;&lt;/p&gt;&lt;figure data-tool=&quot;mdnice编辑器&quot;&gt;&lt;img class=&quot;rich_pages wxw-img&quot; data-ratio=&quot;0.39921875&quot; data-src=&quot;https://mmbiz.qpic.cn/mmbiz_png/5EcwYhllQOjicGHFOibJnzTFGzOK9DHryMxAeLqVlEdmvicZWjCKFcp6OglPheZVgiaRUibic0U6S1lckRyY0ia0bx1Bg/640?wx_fmt=png&quot; data-type=&quot;png&quot; data-w=&quot;1280&quot;/&gt;&lt;/figure&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;方法调用需要更多的指令，因此&lt;strong&gt;将方法调用改为函数调用&lt;/strong&gt;，随着调用处越多，包大小的收益越大。&lt;/p&gt;&lt;h4 data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span/&gt;函数调用和 direct 方法调用的区别？&lt;span/&gt;&lt;/h4&gt;&lt;pre data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span/&gt;&lt;code&gt;// 函数和direct的区别&lt;br/&gt;// 函数调用&lt;br/&gt;0x100006448        0x000040CC        __TEXT        __text&lt;br/&gt;0x10000A664        0x00000D96        __TEXT        __objc_methname&lt;br/&gt;0x10000BF90        0x00000070        __TEXT        __unwind_info&lt;br/&gt;0x10000C0F0        0x00001358        __DATA        __objc_const&lt;br/&gt;0x10000D448        0x00000038        __DATA        __objc_selrefs&lt;br/&gt;0x10000D480        0x00000018        __DATA        __objc_classrefs&lt;br/&gt;// direct调用&lt;br/&gt;0x1000064C4        0x00004060        __TEXT        __text&lt;br/&gt;0x10000A674        0x00000D8F        __TEXT        __objc_methname&lt;br/&gt;0x10000BF9C        0x00000064        __TEXT        __unwind_info&lt;br/&gt;0x10000C0F0        0x00001340        __DATA        __objc_const&lt;br/&gt;0x10000D430        0x00000028        __DATA        __objc_selrefs&lt;br/&gt;0x10000D458        0x00000010        __DATA        __objc_classrefs&lt;br/&gt;&lt;br/&gt;// direct方法调用TEXT.text中没有[ViewController method]符号，但是当method方法内部的实现比较多时，就会有[ViewController method]符号；原因是method过于简单被编译器优化为内联了&lt;br/&gt;// 因为method被内联了，所以__objc_selrefs少了一个符号；但是当method实现复杂了，会多一个method方法的调用，__objc_selrefs就多一个符号&lt;br/&gt;&lt;br/&gt;// 函数在TEXT.objc_methname多了以下两个符号&lt;br/&gt;0x10000A664        0x00000006        [  1] literal string: class&lt;br/&gt;0x10000A66A        0x0000000F        [  1] literal string: isKindOfClass:&lt;br/&gt;&lt;br/&gt;// 函数调用实例方法列表尺寸比direct方法调用大，原因direct没有实例方法&lt;br/&gt;// 函数调用&lt;br/&gt;0x10000C138        0x00000050        [  1] __OBJC_&lt;span&gt;$_INSTANCE_METHODS_ViewController&lt;/span&gt;&lt;br/&gt;// direct方法调用&lt;br/&gt;0x10000C138        0x00000038        [  1] __OBJC_&lt;span&gt;$_INSTANCE_METHODS_ViewController&lt;/span&gt;&lt;br/&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;strong&gt;结论&lt;/strong&gt;：direct 方法收益和函数调用基本一致，每一处调用优化收益是 3.93b。&lt;/p&gt;&lt;h4 data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span/&gt;函数调用、direct 方法调用为何可以减少二进制文件大小？&lt;span/&gt;&lt;/h4&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;strong&gt;正常方法调用：&lt;/strong&gt;&lt;/p&gt;&lt;figure data-tool=&quot;mdnice编辑器&quot;&gt;&lt;img class=&quot;rich_pages wxw-img&quot; data-ratio=&quot;0.09765625&quot; data-src=&quot;https://mmbiz.qpic.cn/mmbiz_png/5EcwYhllQOjicGHFOibJnzTFGzOK9DHryM767lp3gI0iaWibxqla5Gk9KibaEricA8ibmN9Biaia3uribSEpCBLzRHKpPLicg/640?wx_fmt=png&quot; data-type=&quot;png&quot; data-w=&quot;1280&quot;/&gt;&lt;/figure&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;strong&gt;函数调用：&lt;/strong&gt;&lt;/p&gt;&lt;figure data-tool=&quot;mdnice编辑器&quot;&gt;&lt;img class=&quot;rich_pages wxw-img&quot; data-ratio=&quot;0.0796875&quot; data-src=&quot;https://mmbiz.qpic.cn/mmbiz_png/5EcwYhllQOjicGHFOibJnzTFGzOK9DHryMRaQFfYAVHs4JLoHJLs3UAjIv3j5Bqicv5YNIwBSfyVBGIFymINoVtVw/640?wx_fmt=png&quot; data-type=&quot;png&quot; data-w=&quot;1280&quot;/&gt;&lt;/figure&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;strong&gt;direct 方法调用：&lt;/strong&gt;&lt;/p&gt;&lt;figure data-tool=&quot;mdnice编辑器&quot;&gt;&lt;img class=&quot;rich_pages wxw-img&quot; data-ratio=&quot;0.2375&quot; data-src=&quot;https://mmbiz.qpic.cn/mmbiz_png/5EcwYhllQOjicGHFOibJnzTFGzOK9DHryMTiaut7jjhAfOJ9pQuticTxDe46rTxJicrF3DFnzlXfLZmn4SqrKd1dPoQ/640?wx_fmt=png&quot; data-type=&quot;png&quot; data-w=&quot;1280&quot;/&gt;&lt;/figure&gt;&lt;pre data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span/&gt;&lt;code&gt;x0是储存函数的第一个参数，msgSend的第一个参数肯定是self，所以x0是self&lt;br/&gt;cbz先判断self是否存在，如果不存在，goto 0x1000063ac-&amp;gt;ret,ret是&lt;span&gt;return&lt;/span&gt;；&lt;br/&gt;&lt;br/&gt;- (void)method&lt;br/&gt;{&lt;br/&gt;  NSLog(@&lt;span&gt;&quot;&quot;&lt;/span&gt;);&lt;br/&gt;}&lt;br/&gt;如果self存在，则执行 NSLog&lt;br/&gt;&lt;br/&gt;因为method方法实现过于简单，被编译器优化为内联了。&lt;br/&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;当方法实现比较简单，使用 direct 修饰，可以优化调用效率，但是包大小收益可能是负收益；因为很多处调用 direct 方法被内联。&lt;/p&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;strong&gt;回到一开始的问题&lt;/strong&gt;：函数调用、direct 方法调用可以减少二进制文件大小的原因是因为相比方法调用，指令变少了。&lt;/p&gt;&lt;h3 data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span/&gt;去 Block&lt;span/&gt;&lt;/h3&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;strong&gt;实验内容：&lt;/strong&gt;&lt;/p&gt;&lt;pre data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span/&gt;&lt;code&gt;// 有block和无block的代码区别&lt;br/&gt;- (void)blockTest&lt;br/&gt;{&lt;br/&gt;    [self.blockProvider blockInterface1:1];&lt;br/&gt;}&lt;br/&gt;- (void)blockTest&lt;br/&gt;{&lt;br/&gt;    [self.blockProvider blockInterface:^{&lt;br/&gt;&lt;br/&gt;    }];&lt;br/&gt;}&lt;br/&gt;&lt;/code&gt;&lt;/pre&gt;&lt;h4 data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span/&gt;block 调用会产生哪些符号？&lt;span/&gt;&lt;/h4&gt;&lt;pre data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span/&gt;&lt;code&gt;// 一个block调用与两个block调用的区别&lt;br/&gt;// __DATA.const（没有初始化过的常量） 多一个调用就会多一个___block_literal_global符号，这个占用32个字节&lt;br/&gt;0x100008070        0x00000020        [  1] ___block_descriptor_32_e5_v8?0l&lt;br/&gt;0x100008090        0x00000020        [  1] ___block_literal_global&lt;br/&gt;0x1000080B0        0x00000020        [  1] ___block_literal_global.12&lt;br/&gt;&lt;br/&gt;// ___block_literal_global就是Block_layout结构体对象&lt;br/&gt;struct Block_layout {&lt;br/&gt;void *isa; int flags;&lt;br/&gt;int reserved;&lt;br/&gt;void (*invoke)(void *, ...);&lt;br/&gt;struct Block_descriptor *descriptor;&lt;br/&gt;/* Imported variables. */&lt;br/&gt;};&lt;br/&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;每多一处 block 的调用，会多一个___block_literal_global 符号，占用 32b。&lt;/p&gt;&lt;pre data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span/&gt;&lt;code&gt;// 无block调用&lt;br/&gt;0x1000060A4        0x00000044        [  1] -[ViewController blockTest]&lt;br/&gt;// 一个block调用&lt;br/&gt;0x100006094        0x00000048        [  1] -[ViewController blockTest]&lt;br/&gt;0x1000060DC        0x00000004        [  1] ___27-[ViewController blockTest]_block_invoke&lt;br/&gt;// 包含_block_invoke这个符号，则说明[ViewController blockTest]方法的实现中，有实现block&lt;br/&gt;&lt;br/&gt;// 两个block调用&lt;br/&gt;// 如果有两个block调用，会多出 ___29-[ViewController viewDidLoad]_block_invoke_2&lt;br/&gt;&lt;br/&gt;// 有一个block调用比无block调用多出 36 + 4 = 40b&lt;br/&gt;// 有两个block调用比有一个block调用多出24 + 4 = 28b&lt;br/&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;每多一处 block 的调用，会多一个_block_invoke_2 符号，占用 4b。&lt;/p&gt;&lt;h4 data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span/&gt;block 调用和方法调用，在调用处的汇编指令差别？&lt;span/&gt;&lt;/h4&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;strong&gt;方法调用：&lt;/strong&gt;&lt;/p&gt;&lt;pre data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span/&gt;&lt;code&gt;- (void)blockTest&lt;br/&gt;{&lt;br/&gt;  [self.blockProvider blockInterface1:1];&lt;br/&gt;}&lt;br/&gt;&lt;/code&gt;&lt;/pre&gt;&lt;figure data-tool=&quot;mdnice编辑器&quot;&gt;&lt;img class=&quot;rich_pages wxw-img&quot; data-ratio=&quot;0.27578125&quot; data-src=&quot;https://mmbiz.qpic.cn/mmbiz_png/5EcwYhllQOjicGHFOibJnzTFGzOK9DHryMwOicjrezsNCiaiarXicxsvDTBtk7n6gC7VZnLph6QmW2kenoxqgl4GiaElQ/640?wx_fmt=png&quot; data-type=&quot;png&quot; data-w=&quot;1280&quot;/&gt;&lt;/figure&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;strong&gt;block 调用：&lt;/strong&gt;&lt;/p&gt;&lt;figure data-tool=&quot;mdnice编辑器&quot;&gt;&lt;img class=&quot;rich_pages wxw-img&quot; data-ratio=&quot;0.29296875&quot; data-src=&quot;https://mmbiz.qpic.cn/mmbiz_png/5EcwYhllQOjicGHFOibJnzTFGzOK9DHryMXcxmPIEKZpDrLO3PW4S1oHmfpbwEoqnmAVibX4TKgae5264jQ5ZMchQ/640?wx_fmt=png&quot; data-type=&quot;png&quot; data-w=&quot;1280&quot;/&gt;&lt;/figure&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;在调用处的指令，block 调用只是比方法调用多了一个指令，多了 4 个字节（maplinkfile 计算出来的）。&lt;/p&gt;&lt;h4 data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span/&gt;去 Block 优化的示例&lt;span/&gt;&lt;/h4&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;strong&gt;含有 block 参数方法的实现：&lt;/strong&gt;&lt;/p&gt;&lt;pre data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span/&gt;&lt;code&gt;// 定义含有block的方法&lt;br/&gt;- (void)blockInterface:(void(^)(void))block&lt;br/&gt;{&lt;br/&gt;  [self shill];&lt;br/&gt;&lt;br/&gt;  !block ? : block();&lt;br/&gt;}&lt;br/&gt;&lt;br/&gt;- (void)shill&lt;br/&gt;{&lt;br/&gt;  NSString *string = @&lt;span&gt;&quot;123&quot;&lt;/span&gt;;&lt;br/&gt;  &lt;span&gt;if&lt;/span&gt; ([string isKindOfClass:[NSString class]]) {&lt;br/&gt;    NSLog(@&lt;span&gt;&quot;123&quot;&lt;/span&gt;);&lt;br/&gt;  }&lt;br/&gt;}&lt;br/&gt;&lt;br/&gt;// 去Block的优化&lt;br/&gt;&lt;span&gt;#define CallBlock(blockProvider,BLOCK)\&lt;/span&gt;&lt;br/&gt;[blockProvider shill];\&lt;br/&gt;BLOCK&lt;br/&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;strong&gt;实验对比：&lt;/strong&gt;&lt;/p&gt;&lt;pre data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span/&gt;&lt;code&gt;- (void)blockTest&lt;br/&gt;{&lt;br/&gt;  [self.blockProvider blockInterface:^{&lt;br/&gt;    NSLog(@&lt;span&gt;&quot;block&quot;&lt;/span&gt;);&lt;br/&gt;  }];&lt;br/&gt;}&lt;br/&gt;&lt;br/&gt;- (void)blockTest&lt;br/&gt;{&lt;br/&gt;  CallBlock(self.blockProvider,{&lt;br/&gt;    NSLog(@&lt;span&gt;&quot;block&quot;&lt;/span&gt;);&lt;br/&gt;  })&lt;br/&gt;}&lt;br/&gt;&lt;/code&gt;&lt;/pre&gt;&lt;pre data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span/&gt;&lt;code&gt;// 去Block，相当于把block的实现内联了&lt;br/&gt;0x100006064        0x00000050        [  1] -[ViewController blockTest]&lt;br/&gt;&lt;br/&gt;// 调用含有block的方法&lt;br/&gt;// TEXT.text&lt;br/&gt;0x10000604C        0x00000048        [  1] -[ViewController blockTest]&lt;br/&gt;0x100006094        0x0000001C        [  1] ___27-[ViewController blockTest]_block_invoke&lt;br/&gt;// DATA.const&lt;br/&gt;0x100008070        0x00000020        [  1] ___block_descriptor_32_e5_v8?0l&lt;br/&gt;0x100008090        0x00000020        [  1] ___block_literal_global&lt;br/&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;strong&gt;调用含有 block 的方法：&lt;/strong&gt;&lt;/p&gt;&lt;figure data-tool=&quot;mdnice编辑器&quot;&gt;&lt;img class=&quot;rich_pages wxw-img&quot; data-ratio=&quot;0.4828125&quot; data-src=&quot;https://mmbiz.qpic.cn/mmbiz_png/5EcwYhllQOjicGHFOibJnzTFGzOK9DHryM7Nb26zEyQmx1RLL1PGFyTCwvpubbTLVZhHMSERDDy4fv4wRE2tRB7w/640?wx_fmt=png&quot; data-type=&quot;png&quot; data-w=&quot;1280&quot;/&gt;&lt;/figure&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;strong&gt;去 Block：&lt;/strong&gt;&lt;/p&gt;&lt;figure data-tool=&quot;mdnice编辑器&quot;&gt;&lt;img class=&quot;rich_pages wxw-img&quot; data-ratio=&quot;0.30703125&quot; data-src=&quot;https://mmbiz.qpic.cn/mmbiz_png/5EcwYhllQOjicGHFOibJnzTFGzOK9DHryMxCskXd46A444fYicdKGvS8lICl6luPMuYHj32rJ4Z0061hAbJNnyLrg/640?wx_fmt=png&quot; data-type=&quot;png&quot; data-w=&quot;1280&quot;/&gt;&lt;/figure&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;strong&gt;结论&lt;/strong&gt;：去 Block 的主要收益在于减少了___block_literal_global 和_block_invoke 符号，但是去 block 相当于把 block 的实现内联了，_block_invoke 主要大小的占用是 block 的实现，这块内联和_block_invoke 的差异差不多有 0x0000001C(28) - (0x00000050 - 0x00000048) = 20b；&lt;/p&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;___block_literal_global 固定 20b；&lt;/p&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;所以&lt;strong&gt;去 block 的收益是 40b&lt;/strong&gt;。&lt;/p&gt;&lt;h2 data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span/&gt;总结&lt;/h2&gt;&lt;ol data-tool=&quot;mdnice编辑器&quot; class=&quot;list-paddingleft-2&quot;&gt;&lt;li&gt;&lt;section&gt;介绍了从二进制文件层面分析编码对包大小的影响；&lt;/section&gt;&lt;/li&gt;&lt;li&gt;&lt;section&gt;介绍了属性、方法调用、函数调用、direct 方法调用、block 调用在汇编下的差别，让我们在平时编码中，能有个大概的印象，该代码对应的汇编大概是什么样子；&lt;/section&gt;&lt;/li&gt;&lt;li&gt;&lt;section&gt;得出一些收益数据：&lt;/section&gt;&lt;/li&gt;&lt;/ol&gt;&lt;section data-tool=&quot;mdnice编辑器&quot;&gt;&lt;table&gt;&lt;thead&gt;&lt;tr&gt;&lt;th&gt;@dynamic 优化属性&lt;/th&gt;&lt;th&gt;函数化或者 direct 修饰&lt;/th&gt;&lt;th&gt;去 Block&lt;/th&gt;&lt;/tr&gt;&lt;/thead&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td&gt;217B&lt;/td&gt;&lt;td&gt;3.93b&lt;/td&gt;&lt;td&gt;40b&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/section&gt;&lt;h2 data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span/&gt;加入我们&lt;/h2&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;我们是&lt;strong&gt;字节跳动直播团队&lt;/strong&gt;，直播团队负责为字节跳动旗下核心 App 提供直播服务， 直播是字节的头部业务，高速增长，两年不到的时间就跻身行业第一，目前已远超竞品；抖音系产品体量优势巨大，直播业务仍有较大增长空间。你将参与抖音、抖音 Lite、抖音火山版等知名产品的直播业务研发，你开发的功能与创意将影响亿级用户；你将接触到高复杂度的架构，以及领先的直播实时连线与互动技术、跨平台技术等。&lt;/p&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;base：北上广深杭都有&lt;/p&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;strong&gt;飞书&lt;/strong&gt;扫码加入&lt;strong&gt;抖音直播内推群&lt;/strong&gt;，群内有抖音直播业务介绍和面试 tip👇&lt;/p&gt;&lt;figure data-tool=&quot;mdnice编辑器&quot;&gt;&lt;img class=&quot;rich_pages wxw-img&quot; data-ratio=&quot;1.131195335276968&quot; data-src=&quot;https://mmbiz.qpic.cn/mmbiz_png/5EcwYhllQOjicGHFOibJnzTFGzOK9DHryM8fibmXU8jpETHksnCjwOMr7cf0oWX09x7iaKeQFCdkzCb3KQ0IvW9DqQ/640?wx_fmt=png&quot; data-type=&quot;png&quot; data-w=&quot;1372&quot;/&gt;&lt;/figure&gt;&lt;/section&gt;&lt;/div&gt;&lt;/div&gt;</content:encoded>
</item>
<item>
<guid>ff9faba0786646f10ee2bc7a294c11e8</guid>
<title>使用 Cilium 增强 Kubernetes 网络安全</title>
<link>https://toutiao.io/k/37vv9md</link>
<content:encoded>&lt;div&gt;&lt;div&gt;&lt;section data-tool=&quot;mdnice编辑器&quot; data-website=&quot;https://www.mdnice.com&quot;&gt;&lt;h2 data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;TL;DR&lt;/span&gt;&lt;span/&gt;&lt;/h2&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;在本篇，我们分别使用了 Kubernetes 原生的网络策略和 Cilium 的网络策略实现了 Pod 网络层面的隔离。不同的是，前者只提供了基于 L3/4 的网络策略；后者支持 L3/4、L7 的网络策略。&lt;/p&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;通过网络策略来提升网络安全，可以极大降低了实现和维护的成本，同时对系统几乎没有影响。&lt;/p&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;尤其是基于 eBPF 技术的 Cilium，解决了内核扩展性不足的问题，从内核层面为工作负载提供安全可靠、可观测的网络连接。&lt;/p&gt;&lt;h2 data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;背景&lt;/span&gt;&lt;span/&gt;&lt;/h2&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;为什么说 Kubernetes 网络存在安全隐患？集群中的 Pod 默认是未隔离的，也就是 Pod 之间的网络是互通的，可以互相通信的。&lt;/p&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;这里就会有问题，比如由于数据敏感服务 B 只允许特定的服务 A 才能访问，而服务 C 无法访问 B。要禁止服务 C 对服务 B 的访问，可以有几种方案：&lt;/p&gt;&lt;ul data-tool=&quot;mdnice编辑器&quot; class=&quot;list-paddingleft-2&quot;&gt;&lt;li&gt;&lt;section&gt;在 SDK 中提供通用的解决方案，实现白名单的功能。首先请求要带有来源的标识，然后服务端可以接收规则设置放行特定标识的请求，拒绝其他的请求。&lt;/section&gt;&lt;/li&gt;&lt;li&gt;&lt;section&gt;云原生的解决方案，使用服务网格的 RBAC、mTLS 功能。RBAC 实现原理与应用层的 SDK 方案类似，但是属于基础设施层的抽象通用方案；mTLS 则会更加复杂一些，在连接握手阶段进行身份验证，涉及证书的签发、验证等操作。&lt;/section&gt;&lt;/li&gt;&lt;/ul&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;以上两种方案各有利弊：&lt;/p&gt;&lt;ul data-tool=&quot;mdnice编辑器&quot; class=&quot;list-paddingleft-2&quot;&gt;&lt;li&gt;&lt;section&gt;SDK 的方案实现简单，但是规模较大的系统会面临升级推广困难、多语言支持成本高等问题。&lt;/section&gt;&lt;/li&gt;&lt;li&gt;&lt;section&gt;服务网格的方案是基础设施层的通用方案，天生支持多语言。但是对于未落地网格的用户来说，架构变化大，成本高。如果单纯为了解决安全问题，使用网格方案性价比又很低，且不说现有网格实现等落地难度大及后期的使用维护成本高。&lt;/section&gt;&lt;/li&gt;&lt;/ul&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;继续向基础设施下层找方案，从网络层入手。Kubernetes 提供了的&lt;span&gt;网络策略 *NetworkPolicy*&lt;/span&gt;&lt;sup&gt;[1]&lt;/sup&gt;，则可以实现“网络层面的隔离”。&lt;/p&gt;&lt;h2 data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;示例应用&lt;/span&gt;&lt;span/&gt;&lt;/h2&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;在进一步演示 &lt;span&gt;NetworkPolicy&lt;/span&gt; 的方案之前，先介绍用于演示的示例应用。我们使用 Cilium 在互动教程 &lt;span&gt;Cilium getting started&lt;/span&gt;&lt;sup&gt;[2]&lt;/sup&gt; 中使用的“星球大战”场景。&lt;/p&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;这里有三个应用，星战迷估计不会陌生：&lt;/p&gt;&lt;ul data-tool=&quot;mdnice编辑器&quot; class=&quot;list-paddingleft-2&quot;&gt;&lt;li&gt;&lt;section&gt;死星 &lt;span&gt;deathstar&lt;/span&gt;：在 &lt;code&gt;80&lt;/code&gt; 端口提供 web 服务，有 2 个 副本，通过 Kubernetes Service 的负载均衡为&lt;strong&gt;帝国战机&lt;/strong&gt;对外提供”登陆“服务。&lt;/section&gt;&lt;/li&gt;&lt;li&gt;&lt;section&gt;钛战机 &lt;span&gt;tiefighter&lt;/span&gt;：执行登陆请求。&lt;/section&gt;&lt;/li&gt;&lt;li&gt;&lt;section&gt;X翼战机 &lt;span&gt;xwing&lt;/span&gt;：执行登陆请求。&lt;/section&gt;&lt;/li&gt;&lt;/ul&gt;&lt;figure data-tool=&quot;mdnice编辑器&quot;&gt;&lt;img class=&quot;rich_pages wxw-img&quot; data-ratio=&quot;0.8492520138089759&quot; data-src=&quot;https://mmbiz.qpic.cn/mmbiz_png/tMghG0NOfxec2EkzdFcUSgwicz701f6VwrdfgPyCkOhzewcaKVHRnc5Dt6P1uDb5C63kgFcEQsXC8kjbmYDFpsw/640?wx_fmt=png&quot; data-type=&quot;png&quot; data-w=&quot;869&quot;/&gt;&lt;/figure&gt;&lt;blockquote data-tool=&quot;mdnice编辑器&quot;&gt;&lt;p&gt;如图所示，我们使用了 &lt;span&gt;Label&lt;/span&gt; 对三个应用进行了标识：&lt;code&gt;org&lt;/code&gt; 和 &lt;code&gt;class&lt;/code&gt;。在执行网络策略时，我们会使用这两个标签识别负载。&lt;/p&gt;&lt;/blockquote&gt;&lt;pre data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span/&gt;&lt;code&gt;&lt;span&gt;# app.yaml&lt;/span&gt;&lt;br/&gt;&lt;span&gt;---&lt;/span&gt;&lt;br/&gt;&lt;span&gt;apiVersion:&lt;/span&gt; &lt;span&gt;v1&lt;/span&gt;&lt;br/&gt;&lt;span&gt;kind:&lt;/span&gt; &lt;span&gt;Service&lt;/span&gt;&lt;br/&gt;&lt;span&gt;metadata:&lt;/span&gt;&lt;br/&gt;  &lt;span&gt;name:&lt;/span&gt; &lt;span&gt;deathstar&lt;/span&gt;&lt;br/&gt;  &lt;span&gt;labels:&lt;/span&gt;&lt;br/&gt;    &lt;span&gt;app.kubernetes.io/name:&lt;/span&gt; &lt;span&gt;deathstar&lt;/span&gt;&lt;br/&gt;&lt;span&gt;spec:&lt;/span&gt;&lt;br/&gt;  &lt;span&gt;type:&lt;/span&gt; &lt;span&gt;ClusterIP&lt;/span&gt;&lt;br/&gt;  &lt;span&gt;ports:&lt;/span&gt;&lt;br/&gt;  &lt;span&gt;-&lt;/span&gt; &lt;span&gt;port:&lt;/span&gt; &lt;span&gt;80&lt;/span&gt;&lt;br/&gt;  &lt;span&gt;selector:&lt;/span&gt;&lt;br/&gt;    &lt;span&gt;org:&lt;/span&gt; &lt;span&gt;empire&lt;/span&gt;&lt;br/&gt;    &lt;span&gt;class:&lt;/span&gt; &lt;span&gt;deathstar&lt;/span&gt;&lt;br/&gt;&lt;span&gt;---&lt;/span&gt;&lt;br/&gt;&lt;span&gt;apiVersion:&lt;/span&gt; &lt;span&gt;apps/v1&lt;/span&gt;&lt;br/&gt;&lt;span&gt;kind:&lt;/span&gt; &lt;span&gt;Deployment&lt;/span&gt;&lt;br/&gt;&lt;span&gt;metadata:&lt;/span&gt;&lt;br/&gt;  &lt;span&gt;name:&lt;/span&gt; &lt;span&gt;deathstar&lt;/span&gt;&lt;br/&gt;  &lt;span&gt;labels:&lt;/span&gt;&lt;br/&gt;    &lt;span&gt;app.kubernetes.io/name:&lt;/span&gt; &lt;span&gt;deathstar&lt;/span&gt;&lt;br/&gt;&lt;span&gt;spec:&lt;/span&gt;&lt;br/&gt;  &lt;span&gt;replicas:&lt;/span&gt; &lt;span&gt;2&lt;/span&gt;&lt;br/&gt;  &lt;span&gt;selector:&lt;/span&gt;&lt;br/&gt;    &lt;span&gt;matchLabels:&lt;/span&gt;&lt;br/&gt;      &lt;span&gt;org:&lt;/span&gt; &lt;span&gt;empire&lt;/span&gt;&lt;br/&gt;      &lt;span&gt;class:&lt;/span&gt; &lt;span&gt;deathstar&lt;/span&gt;&lt;br/&gt;  &lt;span&gt;template:&lt;/span&gt;&lt;br/&gt;    &lt;span&gt;metadata:&lt;/span&gt;&lt;br/&gt;      &lt;span&gt;labels:&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;org:&lt;/span&gt; &lt;span&gt;empire&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;class:&lt;/span&gt; &lt;span&gt;deathstar&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;app.kubernetes.io/name:&lt;/span&gt; &lt;span&gt;deathstar&lt;/span&gt;&lt;br/&gt;    &lt;span&gt;spec:&lt;/span&gt;&lt;br/&gt;      &lt;span&gt;containers:&lt;/span&gt;&lt;br/&gt;      &lt;span&gt;-&lt;/span&gt; &lt;span&gt;name:&lt;/span&gt; &lt;span&gt;deathstar&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;image:&lt;/span&gt; &lt;span&gt;docker.io/cilium/starwars&lt;/span&gt;&lt;br/&gt;&lt;span&gt;---&lt;/span&gt;&lt;br/&gt;&lt;span&gt;apiVersion:&lt;/span&gt; &lt;span&gt;v1&lt;/span&gt;&lt;br/&gt;&lt;span&gt;kind:&lt;/span&gt; &lt;span&gt;Pod&lt;/span&gt;&lt;br/&gt;&lt;span&gt;metadata:&lt;/span&gt;&lt;br/&gt;  &lt;span&gt;name:&lt;/span&gt; &lt;span&gt;tiefighter&lt;/span&gt;&lt;br/&gt;  &lt;span&gt;labels:&lt;/span&gt;&lt;br/&gt;    &lt;span&gt;org:&lt;/span&gt; &lt;span&gt;empire&lt;/span&gt;&lt;br/&gt;    &lt;span&gt;class:&lt;/span&gt; &lt;span&gt;tiefighter&lt;/span&gt;&lt;br/&gt;    &lt;span&gt;app.kubernetes.io/name:&lt;/span&gt; &lt;span&gt;tiefighter&lt;/span&gt;&lt;br/&gt;&lt;span&gt;spec:&lt;/span&gt;&lt;br/&gt;  &lt;span&gt;containers:&lt;/span&gt;&lt;br/&gt;  &lt;span&gt;-&lt;/span&gt; &lt;span&gt;name:&lt;/span&gt; &lt;span&gt;spaceship&lt;/span&gt;&lt;br/&gt;    &lt;span&gt;image:&lt;/span&gt; &lt;span&gt;docker.io/tgraf/netperf&lt;/span&gt;&lt;br/&gt;&lt;span&gt;---&lt;/span&gt;&lt;br/&gt;&lt;span&gt;apiVersion:&lt;/span&gt; &lt;span&gt;v1&lt;/span&gt;&lt;br/&gt;&lt;span&gt;kind:&lt;/span&gt; &lt;span&gt;Pod&lt;/span&gt;&lt;br/&gt;&lt;span&gt;metadata:&lt;/span&gt;&lt;br/&gt;  &lt;span&gt;name:&lt;/span&gt; &lt;span&gt;xwing&lt;/span&gt;&lt;br/&gt;  &lt;span&gt;labels:&lt;/span&gt;&lt;br/&gt;    &lt;span&gt;app.kubernetes.io/name:&lt;/span&gt; &lt;span&gt;xwing&lt;/span&gt;&lt;br/&gt;    &lt;span&gt;org:&lt;/span&gt; &lt;span&gt;alliance&lt;/span&gt;&lt;br/&gt;    &lt;span&gt;class:&lt;/span&gt; &lt;span&gt;xwing&lt;/span&gt;&lt;br/&gt;&lt;span&gt;spec:&lt;/span&gt;&lt;br/&gt;  &lt;span&gt;containers:&lt;/span&gt;&lt;br/&gt;  &lt;span&gt;-&lt;/span&gt; &lt;span&gt;name:&lt;/span&gt; &lt;span&gt;spaceship&lt;/span&gt;&lt;br/&gt;    &lt;span&gt;image:&lt;/span&gt; &lt;span&gt;docker.io/tgraf/netperf&lt;/span&gt;&lt;br/&gt;&lt;/code&gt;&lt;/pre&gt;&lt;h2 data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;Kubernetes 网络策略&lt;/span&gt;&lt;span/&gt;&lt;/h2&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;可以通过&lt;span&gt;官方文档&lt;/span&gt;&lt;sup&gt;[3]&lt;/sup&gt;获取更多详细信息，这里我们直接放出配置：&lt;/p&gt;&lt;pre data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span/&gt;&lt;code&gt;&lt;span&gt;# native/networkpolicy.yaml&lt;/span&gt;&lt;br/&gt;&lt;span&gt;apiVersion:&lt;/span&gt; &lt;span&gt;networking.k8s.io/v1&lt;/span&gt;&lt;br/&gt;&lt;span&gt;kind:&lt;/span&gt; &lt;span&gt;NetworkPolicy&lt;/span&gt;&lt;br/&gt;&lt;span&gt;metadata:&lt;/span&gt;&lt;br/&gt;  &lt;span&gt;name:&lt;/span&gt; &lt;span&gt;policy&lt;/span&gt;&lt;br/&gt;  &lt;span&gt;namespace:&lt;/span&gt; &lt;span&gt;default&lt;/span&gt;&lt;br/&gt;&lt;span&gt;spec:&lt;/span&gt;&lt;br/&gt;  &lt;span&gt;podSelector:&lt;/span&gt;&lt;br/&gt;    &lt;span&gt;matchLabels:&lt;/span&gt;&lt;br/&gt;      &lt;span&gt;org:&lt;/span&gt; &lt;span&gt;empire&lt;/span&gt;&lt;br/&gt;      &lt;span&gt;class:&lt;/span&gt; &lt;span&gt;deathstar&lt;/span&gt;&lt;br/&gt;  &lt;span&gt;policyTypes:&lt;/span&gt;&lt;br/&gt;  &lt;span&gt;-&lt;/span&gt; &lt;span&gt;Ingress&lt;/span&gt;&lt;br/&gt;  &lt;span&gt;ingress:&lt;/span&gt;&lt;br/&gt;  &lt;span&gt;-&lt;/span&gt; &lt;span&gt;from:&lt;/span&gt;&lt;br/&gt;    &lt;span&gt;-&lt;/span&gt; &lt;span&gt;podSelector:&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;matchLabels:&lt;/span&gt;&lt;br/&gt;          &lt;span&gt;org:&lt;/span&gt; &lt;span&gt;empire&lt;/span&gt;&lt;br/&gt;    &lt;span&gt;ports:&lt;/span&gt;&lt;br/&gt;    &lt;span&gt;-&lt;/span&gt; &lt;span&gt;protocol:&lt;/span&gt; &lt;span&gt;TCP&lt;/span&gt;&lt;br/&gt;      &lt;span&gt;port:&lt;/span&gt; &lt;span&gt;80&lt;/span&gt;&lt;br/&gt;&lt;/code&gt;&lt;/pre&gt;&lt;ul data-tool=&quot;mdnice编辑器&quot; class=&quot;list-paddingleft-2&quot;&gt;&lt;li&gt;&lt;section&gt;&lt;code&gt;podSelector&lt;/code&gt; ：表示要应用网络策略的工作负载均衡，通过 &lt;span&gt;label&lt;/span&gt; 选择到了 &lt;span&gt;deathstar&lt;/span&gt; 的 2 个 Pod。&lt;/section&gt;&lt;/li&gt;&lt;li&gt;&lt;section&gt;&lt;code&gt;policyTypes&lt;/code&gt; ：表示流量的类型，可以是 &lt;code&gt;Ingress&lt;/code&gt; 或 &lt;code&gt;Egress&lt;/code&gt; 或两者兼具。这里使用 &lt;code&gt;Ingress&lt;/code&gt;，表示对选择的 &lt;span&gt;deathstar&lt;/span&gt; Pod 的入站流量执行规则。&lt;/section&gt;&lt;/li&gt;&lt;li&gt;&lt;section&gt;&lt;code&gt;ingress.from&lt;/code&gt;：表示流量的来源工作负载，也是使用 &lt;code&gt;podSelector&lt;/code&gt; 和 &lt;span&gt;Label&lt;/span&gt; 进行选择，这里选中了 &lt;code&gt;org=empire&lt;/code&gt; 也就是所有“帝国的战机”。&lt;/section&gt;&lt;/li&gt;&lt;li&gt;&lt;section&gt;&lt;code&gt;ingress.ports&lt;/code&gt;：表示流量的进入端口，这里列出了 &lt;span&gt;deathstar&lt;/span&gt; 的服务端口。&lt;/section&gt;&lt;/li&gt;&lt;/ul&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;接下来，我们测试下。&lt;/p&gt;&lt;h3 data-tool=&quot;mdnice编辑器&quot;&gt;测试&lt;/h3&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;先准备环境，我们使用 &lt;span&gt;K3s&lt;/span&gt;&lt;sup&gt;[4]&lt;/sup&gt; 作为 Kubernetes 环境。但由于 K3s 默认的 CNI 插件 Flannel 不支持网络策略，我们需要换个插件，这里选择 &lt;span&gt;Calico&lt;/span&gt;&lt;sup&gt;[5]&lt;/sup&gt;，即 K3s + Calico 的方案。&lt;/p&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;先创建一个单节点的集群：&lt;/p&gt;&lt;pre data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span/&gt;&lt;code&gt;curl -sfL https://get.k3s.io | K3S_KUBECONFIG_MODE=&quot;644&quot; INSTALL_K3S_EXEC=&quot;--flannel-backend=none --cluster-cidr=10.42.0.0/16 --disable-network-policy --disable=traefik&quot; sh -&lt;br/&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;此时，所有的 Pod 都处于 &lt;code&gt;Pending&lt;/code&gt; 状态，因为还需要安装 Calico：&lt;/p&gt;&lt;pre data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span/&gt;&lt;code&gt;kubectl apply -f https://projectcalico.docs.tigera.io/manifests/calico.yaml&lt;br/&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;待 Calico 成功运行后，所有的 Pod 也会成功运行。&lt;/p&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;接下来就是部署应用：&lt;/p&gt;&lt;pre data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span/&gt;&lt;code&gt;kubectl apply -f app.yaml&lt;br/&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;strong&gt;执行策略前&lt;/strong&gt;，执行下面的命令看看“战机能否登陆死星”：&lt;/p&gt;&lt;pre data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span/&gt;&lt;code&gt;kubectl exec tiefighter -- curl -s -XPOST deathstar.default.svc.cluster.local/v1/request-landing&lt;br/&gt;Ship landed&lt;br/&gt;&lt;br/&gt;kubectl exec xwing -- curl -s -XPOST deathstar.default.svc.cluster.local/v1/request-landing&lt;br/&gt;Ship landed&lt;br/&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;从结果来看，两种 ”战机“（Pod 负载）都可以访问 &lt;span&gt;deathstar&lt;/span&gt; 服务。&lt;/p&gt;&lt;figure data-tool=&quot;mdnice编辑器&quot;&gt;&lt;img class=&quot;rich_pages wxw-img&quot; data-ratio=&quot;0.8471264367816091&quot; data-src=&quot;https://mmbiz.qpic.cn/mmbiz_png/tMghG0NOfxec2EkzdFcUSgwicz701f6VwqzJotZtZoiaFoXD2okXDQNjxT4nyMxbDPC10k1LjFf46Hk37mIxZojA/640?wx_fmt=png&quot; data-type=&quot;png&quot; data-w=&quot;870&quot;/&gt;&lt;/figure&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;此时执行网络策略：&lt;/p&gt;&lt;pre data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span/&gt;&lt;code&gt;kubectl apply -f native/networkpolicy.yaml&lt;br/&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;再次尝试”登陆“，&lt;span&gt;xwing&lt;/span&gt; 的登陆请求会停在那（需要使用 &lt;span&gt;ctrl+c&lt;/span&gt; 退出，或者请求时加上 &lt;code&gt;--connect-timeout 2&lt;/code&gt;）。&lt;/p&gt;&lt;figure data-tool=&quot;mdnice编辑器&quot;&gt;&lt;img class=&quot;rich_pages wxw-img&quot; data-ratio=&quot;0.8471264367816091&quot; data-src=&quot;https://mmbiz.qpic.cn/mmbiz_png/tMghG0NOfxec2EkzdFcUSgwicz701f6VwgX2zaJQdclCx58FbCtDrHlicbeksxpTUz8ay5Rib653BTmUSOziaDrdmg/640?wx_fmt=png&quot; data-type=&quot;png&quot; data-w=&quot;870&quot;/&gt;&lt;/figure&gt;&lt;h3 data-tool=&quot;mdnice编辑器&quot;&gt;思考&lt;/h3&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;使用 Kubernetes 网络策略实现了我们想要的，从网络层面为服务增加了白名单的功能，这种方案没有改造成本，对系统也几乎无影响。&lt;/p&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;Cilium 还没出场就结束了？我们继续看：&lt;/p&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;有时我们的服务会对外暴露一些管理端点，由系统调用执行一些管理上的操作，比如热更新、重启等。这些端点是不允许普通服务来调用，否则会造成严重的后果。&lt;/p&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;比如示例中，&lt;span&gt;tiefighter&lt;/span&gt; 访问了 &lt;span&gt;deathstar&lt;/span&gt; 的管理端点 &lt;code&gt;/exhaust-port&lt;/code&gt;：&lt;/p&gt;&lt;pre data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span/&gt;&lt;code&gt;kubectl exec tiefighter -- curl -s -XPUT deathstar.default.svc.cluster.local/v1/exhaust-port&lt;br/&gt;Panic: deathstar exploded&lt;br/&gt;&lt;br/&gt;goroutine 1 [running]:&lt;br/&gt;main.HandleGarbage(0x2080c3f50, 0x2, 0x4, 0x425c0, 0x5, 0xa)&lt;br/&gt;        /code/src/github.com/empire/deathstar/&lt;br/&gt;        temp/main.go:9 +0x64&lt;br/&gt;main.main()&lt;br/&gt;        /code/src/github.com/empire/deathstar/&lt;br/&gt;        temp/main.go:5 +0x85&lt;br/&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;出现了 &lt;span&gt;Panic&lt;/span&gt; 错误，检查 Pod 你会发现 &lt;span&gt;dealthstar&lt;/span&gt; 挂了。&lt;/p&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;strong&gt;Kubernetes 的网络策略仅能工作在 L3/4 层，对 L7 层就无能为力了。&lt;/strong&gt;&lt;/p&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;还是要请出 Cilium。&lt;/p&gt;&lt;h2 data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;Cilium 网络策略&lt;/span&gt;&lt;span/&gt;&lt;/h2&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;strong&gt;由于 Cilium 涉及了 Linux 内核、网络等众多知识点，要讲清实现原理篇幅极大。故这里仅摘取了官网的介绍，后期希望有时间再写一篇关于实现的。&lt;/strong&gt;&lt;/p&gt;&lt;h3 data-tool=&quot;mdnice编辑器&quot;&gt;Cilium 简介&lt;/h3&gt;&lt;blockquote data-tool=&quot;mdnice编辑器&quot;&gt;&lt;p&gt;&lt;span&gt;Cilium&lt;/span&gt;&lt;sup&gt;[6]&lt;/sup&gt; 是一个开源软件，用于提供、保护和观察容器工作负载（云原生）之间的网络连接，由革命性的内核技术 &lt;span&gt;eBPF&lt;/span&gt;&lt;sup&gt;[7]&lt;/sup&gt; 推动。&lt;/p&gt;&lt;/blockquote&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;strong&gt;eBPF 是什么？&lt;/strong&gt;&lt;/p&gt;&lt;blockquote data-tool=&quot;mdnice编辑器&quot;&gt;&lt;p&gt;Linux 内核一直是实现监控/可观测性、网络和安全功能的理想地方。不过很多情况下这并非易事，因为这些工作需要修改内核源码或加载内核模块， 最终实现形式是在已有的层层抽象之上叠加新的抽象。eBPF 是一项革命性技术，它能在内核中运行沙箱程序（sandbox programs）， 而无需修改内核源码或者加载内核模块。&lt;/p&gt;&lt;/blockquote&gt;&lt;blockquote data-tool=&quot;mdnice编辑器&quot;&gt;&lt;p&gt;将 Linux 内核变成可编程之后，就能基于现有的（而非增加新的）抽象层来打造更加智能、 功能更加丰富的基础设施软件，而不会增加系统的复杂度，也不会牺牲执行效率和安全性。&lt;/p&gt;&lt;/blockquote&gt;&lt;figure data-tool=&quot;mdnice编辑器&quot;&gt;&lt;img class=&quot;rich_pages wxw-img&quot; data-ratio=&quot;0.5268214571657326&quot; data-src=&quot;https://mmbiz.qpic.cn/mmbiz_jpg/tMghG0NOfxec2EkzdFcUSgwicz701f6VwwicXHKudjS0cAQPc1HUdqITaAicZ1HIfPHZBnPZh7Ya0FrEfGe92YbxA/640?wx_fmt=jpeg&quot; data-type=&quot;jpeg&quot; data-w=&quot;1249&quot;/&gt;&lt;/figure&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;我们来看下 Cilium 的网络策略：&lt;/p&gt;&lt;pre data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span/&gt;&lt;code&gt;&lt;span&gt;# cilium/networkpolicy-L4.yaml&lt;/span&gt;&lt;br/&gt;&lt;span&gt;apiVersion:&lt;/span&gt; &lt;span&gt;&quot;cilium.io/v2&quot;&lt;/span&gt;&lt;br/&gt;&lt;span&gt;kind:&lt;/span&gt; &lt;span&gt;CiliumNetworkPolicy&lt;/span&gt;&lt;br/&gt;&lt;span&gt;metadata:&lt;/span&gt;&lt;br/&gt;  &lt;span&gt;name:&lt;/span&gt; &lt;span&gt;&quot;rule1&quot;&lt;/span&gt;&lt;br/&gt;&lt;span&gt;spec:&lt;/span&gt;&lt;br/&gt;  &lt;span&gt;description:&lt;/span&gt; &lt;span&gt;&quot;L7 policy to restrict access to specific HTTP call&quot;&lt;/span&gt;&lt;br/&gt;  &lt;span&gt;endpointSelector:&lt;/span&gt;&lt;br/&gt;    &lt;span&gt;matchLabels:&lt;/span&gt;&lt;br/&gt;      &lt;span&gt;org:&lt;/span&gt; &lt;span&gt;empire&lt;/span&gt;&lt;br/&gt;      &lt;span&gt;class:&lt;/span&gt; &lt;span&gt;deathstar&lt;/span&gt;&lt;br/&gt;  &lt;span&gt;ingress:&lt;/span&gt;&lt;br/&gt;  &lt;span&gt;-&lt;/span&gt; &lt;span&gt;fromEndpoints:&lt;/span&gt;&lt;br/&gt;    &lt;span&gt;-&lt;/span&gt; &lt;span&gt;matchLabels:&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;org:&lt;/span&gt; &lt;span&gt;empire&lt;/span&gt;&lt;br/&gt;    &lt;span&gt;toPorts:&lt;/span&gt;&lt;br/&gt;    &lt;span&gt;-&lt;/span&gt; &lt;span&gt;ports:&lt;/span&gt;&lt;br/&gt;      &lt;span&gt;-&lt;/span&gt; &lt;span&gt;port:&lt;/span&gt; &lt;span&gt;&quot;80&quot;&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;protocol:&lt;/span&gt; &lt;span&gt;TCP&lt;/span&gt;&lt;br/&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;与 Kubernetes 的原生网络策略差异不大，参考前面的介绍也都看懂，我们直接进入测试。&lt;/p&gt;&lt;h3 data-tool=&quot;mdnice编辑器&quot;&gt;测试&lt;/h3&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;由于 Cilium 本身就实现了 CNI，所以之前的集群就不能用了，先卸载集群：&lt;/p&gt;&lt;pre data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span/&gt;&lt;code&gt;k3s-uninstall.sh&lt;br/&gt;&lt;span&gt;#&lt;/span&gt;&lt;span&gt; ！！！切记要清理之前的 cni 插件&lt;/span&gt;&lt;br/&gt;sudo rm -rf /etc/cni/net.d&lt;br/&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;还是使用同样的命令创建单节点的集群：&lt;/p&gt;&lt;pre data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span/&gt;&lt;code&gt;curl -sfL https://get.k3s.io | K3S_KUBECONFIG_MODE=&quot;644&quot; INSTALL_K3S_EXEC=&quot;--flannel-backend=none --cluster-cidr=10.42.0.0/16 --disable-network-policy --disable=traefik&quot; sh -&lt;br/&gt;&lt;span&gt;&lt;br/&gt;#&lt;/span&gt;&lt;span&gt; cilium 会使用该变量&lt;/span&gt;&lt;br/&gt;export KUBECONFIG=/etc/rancher/k3s/k3s.yaml&lt;br/&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;接下来安装 Cilium CLI：&lt;/p&gt;&lt;pre data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span/&gt;&lt;code&gt;curl -L --remote-name-all https://github.com/cilium/cilium-cli/releases/latest/download/cilium-linux-amd64.tar.gz{,.sha256sum}&lt;br/&gt;sha256sum --check cilium-linux-amd64.tar.gz.sha256sum&lt;br/&gt;sudo tar xzvfC cilium-linux-amd64.tar.gz /usr/local/bin&lt;br/&gt;rm cilium-linux-amd64.tar.gz{,.sha256sum}&lt;br/&gt;&lt;br/&gt;cilium version&lt;br/&gt;cilium-cli: v0.10.2 compiled with go1.17.6 on linux/amd64&lt;br/&gt;cilium image (default): v1.11.1&lt;br/&gt;cilium image (stable): v1.11.1&lt;br/&gt;cilium image (running): unknown. Unable to obtain cilium version, no cilium pods found in namespace &quot;kube-system&quot;&lt;br/&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;安装 Cilium 到集群：&lt;/p&gt;&lt;pre data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span/&gt;&lt;code&gt;cilium install&lt;br/&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;待 Cilium 成功运行：&lt;/p&gt;&lt;pre data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span/&gt;&lt;code&gt;cilium status&lt;br/&gt;    /¯¯\&lt;br/&gt; /¯¯\__/¯¯\    Cilium:         OK&lt;br/&gt; \__/¯¯\__/    Operator:       OK&lt;br/&gt; /¯¯\__/¯¯\    Hubble:         disabled&lt;br/&gt; \__/¯¯\__/    ClusterMesh:    disabled&lt;br/&gt;    \__/&lt;br/&gt;&lt;br/&gt;Deployment        cilium-operator    Desired: 1, Ready: 1/1, Available: 1/1&lt;br/&gt;DaemonSet         cilium             Desired: 1, Ready: 1/1, Available: 1/1&lt;br/&gt;Containers:       cilium             Running: 1&lt;br/&gt;                  cilium-operator    Running: 1&lt;br/&gt;Cluster Pods:     3/3 managed by Cilium&lt;br/&gt;Image versions    cilium-operator    quay.io/cilium/operator-generic:v1.11.1@sha256:977240a4783c7be821e215ead515da3093a10f4a7baea9f803511a2c2b44a235: 1&lt;br/&gt;                  cilium             quay.io/cilium/cilium:v1.11.1@sha256:251ff274acf22fd2067b29a31e9fda94253d2961c061577203621583d7e85bd2: 1&lt;br/&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;部署应用：&lt;/p&gt;&lt;pre data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span/&gt;&lt;code&gt;kubectl apply -f app.yaml&lt;br/&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;待应用启动后测试服务调用：&lt;/p&gt;&lt;pre data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span/&gt;&lt;code&gt;kubectl exec tiefighter -- curl -s -XPOST deathstar.default.svc.cluster.local/v1/request-landing&lt;br/&gt;Ship landed&lt;br/&gt;kubectl exec xwing -- curl -s -XPOST deathstar.default.svc.cluster.local/v1/request-landing&lt;br/&gt;Ship landed&lt;br/&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;执行 L4 网络策略：&lt;/p&gt;&lt;pre data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span/&gt;&lt;code&gt;kubectl apply -f cilium/networkpolicy-L4.yaml&lt;br/&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;再次尝试“登陆”死星，&lt;span&gt;xwing&lt;/span&gt; 战机同样无法登陆，说明 L4 层的规则生效。&lt;/p&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;我们再尝试 L7 层的规则：&lt;/p&gt;&lt;pre data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span/&gt;&lt;code&gt;&lt;span&gt;# cilium/networkpolicy-L7.yaml&lt;/span&gt;&lt;br/&gt;&lt;span&gt;apiVersion:&lt;/span&gt; &lt;span&gt;&quot;cilium.io/v2&quot;&lt;/span&gt;&lt;br/&gt;&lt;span&gt;kind:&lt;/span&gt; &lt;span&gt;CiliumNetworkPolicy&lt;/span&gt;&lt;br/&gt;&lt;span&gt;metadata:&lt;/span&gt;&lt;br/&gt;  &lt;span&gt;name:&lt;/span&gt; &lt;span&gt;&quot;rule1&quot;&lt;/span&gt;&lt;br/&gt;&lt;span&gt;spec:&lt;/span&gt;&lt;br/&gt;  &lt;span&gt;description:&lt;/span&gt; &lt;span&gt;&quot;L7 policy to restrict access to specific HTTP call&quot;&lt;/span&gt;&lt;br/&gt;  &lt;span&gt;endpointSelector:&lt;/span&gt;&lt;br/&gt;    &lt;span&gt;matchLabels:&lt;/span&gt;&lt;br/&gt;      &lt;span&gt;org:&lt;/span&gt; &lt;span&gt;empire&lt;/span&gt;&lt;br/&gt;      &lt;span&gt;class:&lt;/span&gt; &lt;span&gt;deathstar&lt;/span&gt;&lt;br/&gt;  &lt;span&gt;ingress:&lt;/span&gt;&lt;br/&gt;  &lt;span&gt;-&lt;/span&gt; &lt;span&gt;fromEndpoints:&lt;/span&gt;&lt;br/&gt;    &lt;span&gt;-&lt;/span&gt; &lt;span&gt;matchLabels:&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;org:&lt;/span&gt; &lt;span&gt;empire&lt;/span&gt;&lt;br/&gt;    &lt;span&gt;toPorts:&lt;/span&gt;&lt;br/&gt;    &lt;span&gt;-&lt;/span&gt; &lt;span&gt;ports:&lt;/span&gt;&lt;br/&gt;      &lt;span&gt;-&lt;/span&gt; &lt;span&gt;port:&lt;/span&gt; &lt;span&gt;&quot;80&quot;&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;protocol:&lt;/span&gt; &lt;span&gt;TCP&lt;/span&gt;&lt;br/&gt;      &lt;span&gt;rules:&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;http:&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;-&lt;/span&gt; &lt;span&gt;method:&lt;/span&gt; &lt;span&gt;&quot;POST&quot;&lt;/span&gt;&lt;br/&gt;          &lt;span&gt;path:&lt;/span&gt; &lt;span&gt;&quot;/v1/request-landing&quot;&lt;/span&gt;&lt;br/&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;执行规则：&lt;/p&gt;&lt;pre data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span/&gt;&lt;code&gt;kubectl apply -f cilium/networkpolicy-L7.yaml&lt;br/&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;这回，使用 &lt;span&gt;tiefighter&lt;/span&gt; 调用死星的管理接口：&lt;/p&gt;&lt;pre data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span/&gt;&lt;code&gt;kubectl exec tiefighter -- curl -s -XPUT deathstar.default.svc.cluster.local/v1/exhaust-port&lt;br/&gt;Access denied&lt;br/&gt;&lt;span&gt;#&lt;/span&gt;&lt;span&gt; 登陆接口工作正常&lt;/span&gt;&lt;br/&gt;kubectl exec tiefighter -- curl -s -XPOST deathstar.default.svc.cluster.local/v1/request-landing&lt;br/&gt;Ship landed&lt;br/&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;这回返回了 &lt;span&gt;Access denied&lt;/span&gt;，说明 L7 层的规则生效了。&lt;/p&gt;&lt;figure data-tool=&quot;mdnice编辑器&quot;&gt;&lt;img class=&quot;rich_pages wxw-img&quot; data-ratio=&quot;0.841324200913242&quot; data-src=&quot;https://mmbiz.qpic.cn/mmbiz_png/tMghG0NOfxec2EkzdFcUSgwicz701f6Vwy7ZqS9rAAZq5YMFlIHl2FTzcnbicXqa0B4dlIf8AfGjuQNp5JKGNonw/640?wx_fmt=png&quot; data-type=&quot;png&quot; data-w=&quot;876&quot;/&gt;&lt;/figure&gt;&lt;h3 data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;参考资料&lt;/span&gt;&lt;/h3&gt;&lt;section data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;&lt;span&gt;[1] &lt;/span&gt;&lt;p&gt;网络策略 &lt;span&gt;NetworkPolicy&lt;/span&gt;: &lt;span&gt;https://kubernetes.io/zh/docs/concepts/services-networking/network-policies/&lt;/span&gt;&lt;/p&gt;&lt;/span&gt;&lt;span&gt;&lt;span&gt;[2] &lt;/span&gt;&lt;p&gt;Cilium getting started: &lt;span&gt;https://play.instruqt.com/isovalent/tracks/cilium-getting-started&lt;/span&gt;&lt;/p&gt;&lt;/span&gt;&lt;span&gt;&lt;span&gt;[3] &lt;/span&gt;&lt;p&gt;官方文档: &lt;span&gt;https://kubernetes.io/zh/docs/concepts/services-networking/network-policies/&lt;/span&gt;&lt;/p&gt;&lt;/span&gt;&lt;span&gt;&lt;span&gt;[4] &lt;/span&gt;&lt;p&gt;K3s: &lt;span&gt;https://k3s.io&lt;/span&gt;&lt;/p&gt;&lt;/span&gt;&lt;span&gt;&lt;span&gt;[5] &lt;/span&gt;&lt;p&gt;Calico: &lt;span&gt;https://www.tigera.io/project-calico/&lt;/span&gt;&lt;/p&gt;&lt;/span&gt;&lt;span&gt;&lt;span&gt;[6] &lt;/span&gt;&lt;p&gt;Cilium: &lt;span&gt;https://cilium.io&lt;/span&gt;&lt;/p&gt;&lt;/span&gt;&lt;span&gt;&lt;span&gt;[7] &lt;/span&gt;&lt;p&gt;eBPF: &lt;span&gt;https://ebpf.io&lt;/span&gt;&lt;/p&gt;&lt;/span&gt;&lt;/section&gt;&lt;/section&gt;&lt;/div&gt;&lt;/div&gt;</content:encoded>
</item>
</channel></rss>