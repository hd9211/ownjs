<?xml version="1.0" encoding="UTF-8"?>
        <rss version="2.0" xmlns:content="http://purl.org/rss/1.0/modules/content/">
            <channel>
            <title>开发者头条</title>
            <link>http://toutiao.io/</link>
            <description></description>
<item>
<guid>9e9ae45188ae4814c08b78983548c014</guid>
<title>这些年我用过的API文档工具，个个是精品！</title>
<link>https://toutiao.io/k/xt41e64</link>
<content:encoded>&lt;div&gt;&lt;div&gt;&lt;section data-tool=&quot;mdnice编辑器&quot; data-website=&quot;https://www.mdnice.com&quot;&gt;&lt;blockquote data-tool=&quot;mdnice编辑器&quot;&gt;&lt;p&gt;这些年用过不少API文档工具，也写过不少相关的文章，我发现&lt;code&gt;哪种API文档工具更好用&lt;/code&gt;一直都是大家比较关心的话题。今天整理了下我曾经用过的7种API文档工具，每个都有详细的使用教程，肯定有你中意的一种！&lt;/p&gt;&lt;/blockquote&gt;&lt;h2 data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span/&gt;&lt;span&gt;Swagger&lt;/span&gt;&lt;span&gt; &lt;/span&gt;&lt;/h2&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;Swagger是一款非常流行的API文档工具，它能帮助你简化API文档的开发，极大提高开发效率，之前在&lt;code&gt;mall&lt;/code&gt;项目中就是使用的它。&lt;/p&gt;&lt;figure data-tool=&quot;mdnice编辑器&quot;&gt;&lt;img class=&quot;rich_pages wxw-img&quot; data-ratio=&quot;0.6937014667817084&quot; data-src=&quot;https://mmbiz.qpic.cn/mmbiz_png/CKvMdchsUwnIKNicq9svDltkD4FDPgMt27OWHpLU9KCqCLBiblGLBLrNknUd1zpEj6ibYRMaf5DwH2QtAFkQZqFFw/640?wx_fmt=png&quot; data-type=&quot;png&quot; data-w=&quot;1159&quot;/&gt;&lt;/figure&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;我们一般将Swagger和SpringBoot结合使用，使用的是Springfox给我们提供的工具。使用该工具可以根据注解自动生成API文档，并且可以在生成的文档上进行接口调试。&lt;/p&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;由于API文档随着项目的启动而更新，所以API文档的实时性很有保证！Springfox官方还给我们提供了Starter，整合非常方便，如果你还在SpringBoot项目中手动整合Swagger的话，不妨看下&lt;a href=&quot;https://mp.weixin.qq.com/s?__biz=MzU1Nzg4NjgyMw==&amp;amp;mid=2247487222&amp;amp;idx=1&amp;amp;sn=033645b871af6d6fe2b29a9074510dc6&amp;amp;scene=21#wechat_redirect&quot; data-linktype=&quot;2&quot;&gt;《还在手动整合Swagger？Swagger官方Starter是真的香！》&lt;/a&gt; 。&lt;/p&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;项目地址：&lt;strong&gt;&lt;span&gt;https://github.com/springfox/springfox&lt;/span&gt;&lt;/strong&gt;&lt;/p&gt;&lt;h2 data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span/&gt;&lt;span&gt;Knife4j&lt;/span&gt;&lt;span&gt; &lt;/span&gt;&lt;/h2&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;虽然Swagger已经非常好用，但是存在界面不够美观，API调试功能弱的缺点，比如请求参数没有校验，返回一堆JSON数据时无法折叠这类问题。于是在Swagger的基础上，就有了一些增强工具的出现。&lt;/p&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;Knife4j是springfox-swagger的增强UI实现，为Java开发者在使用Swagger的时候，提供了简洁、强大的接口文档体验。Knife4j完全遵循了springfox-swagger中的使用方式，并在此基础上做了增强功能，如果你用过Swagger，你就可以无缝切换到Knife4j。&lt;/p&gt;&lt;figure data-tool=&quot;mdnice编辑器&quot;&gt;&lt;img class=&quot;rich_pages wxw-img&quot; data-ratio=&quot;0.6917098445595855&quot; data-src=&quot;https://mmbiz.qpic.cn/mmbiz_png/CKvMdchsUwnIKNicq9svDltkD4FDPgMt2hJGNoWSVn1zic3Dicu4DSsoaaQKZYsQMkmsWK1RCY0FfQRQ6E8jQI3rw/640?wx_fmt=png&quot; data-type=&quot;png&quot; data-w=&quot;1158&quot;/&gt;&lt;/figure&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;使用Knife4j就好像给Swagger换了个新皮肤，瞬间就高大上了，具体使用可以参考&lt;a href=&quot;https://mp.weixin.qq.com/s?__biz=MzU1Nzg4NjgyMw==&amp;amp;mid=2247485970&amp;amp;idx=1&amp;amp;sn=062ab21693907e86bd98ae33f4672ae5&amp;amp;scene=21#wechat_redirect&quot; data-linktype=&quot;2&quot;&gt;《给Swagger换了个新皮肤，瞬间高大上了！》&lt;/a&gt; 。&lt;/p&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;如果你的项目是微服务项目的话，使用Knife4j可以聚合所有服务的文档，具体使用可以参考&lt;a href=&quot;https://mp.weixin.qq.com/s?__biz=MzU1Nzg4NjgyMw==&amp;amp;mid=2247486002&amp;amp;idx=1&amp;amp;sn=e05b2804135650ec2ec587ad82193b9a&amp;amp;scene=21#wechat_redirect&quot; data-linktype=&quot;2&quot;&gt;《微服务聚合Swagger文档，这波操作是真的香！》&lt;/a&gt; 。&lt;/p&gt;&lt;figure data-tool=&quot;mdnice编辑器&quot;&gt;&lt;img class=&quot;rich_pages wxw-img&quot; data-ratio=&quot;0.44203440538519073&quot; data-src=&quot;https://mmbiz.qpic.cn/mmbiz_png/CKvMdchsUwnIKNicq9svDltkD4FDPgMt2rxd1PGoUmYa5DYgPsLk1bYm6iaxH4knsLibRPyTahhib0A4p2hIvZrKkQ/640?wx_fmt=png&quot; data-type=&quot;png&quot; data-w=&quot;1337&quot;/&gt;&lt;/figure&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;项目地址：&lt;strong&gt;&lt;span&gt;https://github.com/xiaoymin/swagger-bootstrap-ui&lt;/span&gt;&lt;/strong&gt;&lt;/p&gt;&lt;h2 data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span/&gt;&lt;span&gt;Postman&lt;/span&gt;&lt;span&gt; &lt;/span&gt;&lt;/h2&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;由于Swagger的接口调试能力比较弱，使用Postman来调试也不失为一个好方案。&lt;/p&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;Postman是一款API接口调试工具，使用它可以很方便的对接口进行测试，并且后端人员可以将自己的调试结果导出，方便前端人员调试，具体使用可以参考&lt;a href=&quot;https://mp.weixin.qq.com/s?__biz=MzU1Nzg4NjgyMw==&amp;amp;mid=2247483933&amp;amp;idx=1&amp;amp;sn=8373e9b9389939063fb24c2bb3c16e03&amp;amp;scene=21#wechat_redirect&quot; data-linktype=&quot;2&quot;&gt;《Postman：API接口调试利器》&lt;/a&gt; 。&lt;/p&gt;&lt;figure data-tool=&quot;mdnice编辑器&quot;&gt;&lt;img class=&quot;rich_pages wxw-img&quot; data-ratio=&quot;0.6318252730109204&quot; data-src=&quot;https://mmbiz.qpic.cn/mmbiz_png/CKvMdchsUwnIKNicq9svDltkD4FDPgMt2ghZ6RAn2MJbrL0245JwUcYqfR6iaaiarrbic3Xic4zEyuhn5MjsxibYDH9w/640?wx_fmt=png&quot; data-type=&quot;png&quot; data-w=&quot;1282&quot;/&gt;&lt;/figure&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;当然在Postman中查看API文档也是可以的，只是功能有点偏弱，所以才有了Swagger+Postman这种流行组合，具体可以参考&lt;a href=&quot;https://mp.weixin.qq.com/s?__biz=MzU1Nzg4NjgyMw==&amp;amp;mid=2247487687&amp;amp;idx=1&amp;amp;sn=d4f54d6b369c6db9ba0c267ed521ff72&amp;amp;scene=21#wechat_redirect&quot; data-linktype=&quot;2&quot;&gt;《Swagger界面丑、功能弱怎么破？用Postman增强下就给力了！》&lt;/a&gt; 。&lt;/p&gt;&lt;figure data-tool=&quot;mdnice编辑器&quot;&gt;&lt;img class=&quot;rich_pages wxw-img&quot; data-ratio=&quot;0.6408227848101266&quot; data-src=&quot;https://mmbiz.qpic.cn/mmbiz_png/CKvMdchsUwnIKNicq9svDltkD4FDPgMt2ul1Xiawvnlj1Jbq0TN70TWojMZnEpl2yf4rESswRgJicvKbUYDl0jpTQ/640?wx_fmt=png&quot; data-type=&quot;png&quot; data-w=&quot;1264&quot;/&gt;&lt;/figure&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;官方网站：&lt;span&gt;&lt;strong&gt;https://www.postman.com/&lt;/strong&gt;&lt;/span&gt;&lt;/p&gt;&lt;h2 data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span/&gt;&lt;span&gt;YApi&lt;/span&gt;&lt;span&gt; &lt;/span&gt;&lt;/h2&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;除了Knife4j这类给Swagger做增强的工具，还有一类工具本身就具有API文档管理的功能，可独立部署并且可以对接Swagger，功能更加强大，也可以称之为API文档管理平台。&lt;/p&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;YApi正是这样一种工具，YApi是高效、易用、功能强大的API管理平台，旨在为开发、产品、测试人员提供更优雅的接口管理服务。YApi在Github上已累计获得了18K+Star，具有优秀的交互体验，YApi不仅提供了常用的接口管理功能，还提供了权限管理、Mock数据、Swagger数据导入等功能，总之功能很强大！&lt;/p&gt;&lt;figure data-tool=&quot;mdnice编辑器&quot;&gt;&lt;img class=&quot;rich_pages wxw-img&quot; data-ratio=&quot;0.6127067014795474&quot; data-src=&quot;https://mmbiz.qpic.cn/mmbiz_png/CKvMdchsUwnIKNicq9svDltkD4FDPgMt2qvXYED3vUkCVEp7DYCdkQDxxlmpEZyJYbo80NeR8oqtpNiatohpm4zw/640?wx_fmt=png&quot; data-type=&quot;png&quot; data-w=&quot;1149&quot;/&gt;&lt;/figure&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;YApi的具体使用可以参考&lt;a href=&quot;https://mp.weixin.qq.com/s?__biz=MzU1Nzg4NjgyMw==&amp;amp;mid=2247488229&amp;amp;idx=1&amp;amp;sn=165200c21b9ccd501bcda48a1605e44f&amp;amp;scene=21#wechat_redirect&quot; data-linktype=&quot;2&quot;&gt;《当Swagger遇上YApi，瞬间高大上了！》&lt;/a&gt; 。&lt;/p&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;项目地址：&lt;span&gt;&lt;strong&gt;https://github.com/YMFE/yapi&lt;/strong&gt;&lt;/span&gt;&lt;/p&gt;&lt;h2 data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span/&gt;&lt;span&gt;smart-doc&lt;/span&gt;&lt;span&gt; &lt;/span&gt;&lt;/h2&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;Swagger需要通过它自己的注解来实现API文档的生成，代码入侵性有点强，如果你想零入侵的话，不妨试试&lt;code&gt;smart-doc&lt;/code&gt;。&lt;/p&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;code&gt;smart-doc&lt;/code&gt;是一款API文档生成工具，无需多余操作，只要你规范地写好代码注释，就能生成API文档。同时能直接生成Postman调试文件，一键导入Postman即可调试，非常好用！&lt;/p&gt;&lt;figure data-tool=&quot;mdnice编辑器&quot;&gt;&lt;img class=&quot;rich_pages wxw-img&quot; data-ratio=&quot;0.6504534212695795&quot; data-src=&quot;https://mmbiz.qpic.cn/mmbiz_png/CKvMdchsUwnIKNicq9svDltkD4FDPgMt2fwwLTM8tLV6gTEsEoKYUaFyB1lXBkl0xsTD99mWgsW7qrNJYicYt0yA/640?wx_fmt=png&quot; data-type=&quot;png&quot; data-w=&quot;1213&quot;/&gt;&lt;/figure&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;code&gt;smart-doc&lt;/code&gt;和Swagger的接口调试能力一样，都比较弱，也得配合Postman来使用，具体可以参考&lt;a href=&quot;https://mp.weixin.qq.com/s?__biz=MzU1Nzg4NjgyMw==&amp;amp;mid=2247495190&amp;amp;idx=1&amp;amp;sn=d3e2f8fd5f3b5f2988917dbe0babf19d&amp;amp;scene=21#wechat_redirect&quot; data-linktype=&quot;2&quot;&gt;《还在用Swagger？试试这款零注解侵入的API文档生成工具，跟Postman绝配！》&lt;/a&gt; 。&lt;/p&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;项目地址：&lt;span&gt;&lt;strong&gt;https://gitee.com/smart-doc-team/smart-doc&lt;/strong&gt;&lt;/span&gt;&lt;/p&gt;&lt;h2 data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span/&gt;&lt;span&gt;Torna&lt;/span&gt;&lt;span&gt; &lt;/span&gt;&lt;/h2&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;又一款可独立部署的API文档管理工具，可以搭建API文档管理平台。不仅支持Swagger导入、还支持Postman和OpenApi等导入。&lt;/p&gt;&lt;figure data-tool=&quot;mdnice编辑器&quot;&gt;&lt;img class=&quot;rich_pages wxw-img&quot; data-ratio=&quot;0.5219512195121951&quot; data-src=&quot;https://mmbiz.qpic.cn/mmbiz_png/CKvMdchsUwnIKNicq9svDltkD4FDPgMt2esG5nnh8iawXKclevFS10lQmhKvCFXERm7c6cB5VLop5IPz6fpOchAw/640?wx_fmt=png&quot; data-type=&quot;png&quot; data-w=&quot;1025&quot;/&gt;&lt;/figure&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;Torna是一套企业级接口文档解决方案，可以配合Swagger使用，具体参考&lt;a href=&quot;https://mp.weixin.qq.com/s?__biz=MzU1Nzg4NjgyMw==&amp;amp;mid=2247495402&amp;amp;idx=1&amp;amp;sn=64e5071d5291213f07812c1ee27a2fc7&amp;amp;scene=21#wechat_redirect&quot; data-linktype=&quot;2&quot;&gt;《当 Swagger 遇上 Torna，瞬间高大上了！》&lt;/a&gt; 。它具有如下功能：&lt;/p&gt;&lt;ul data-tool=&quot;mdnice编辑器&quot; class=&quot;list-paddingleft-2&quot;&gt;&lt;li&gt;&lt;section&gt;文档管理：支持接口文档增删改查、接口调试、字典管理及导入导出功能；&lt;/section&gt;&lt;/li&gt;&lt;li&gt;&lt;section&gt;权限管理：支持接口文档的权限管理，同时有访客、开发者、管理员三种角色；&lt;/section&gt;&lt;/li&gt;&lt;li&gt;&lt;section&gt;双模式：独创的双模式，管理模式可以用来编辑文档内容，浏览模式纯粹查阅文档，界面无其它元素干扰。&lt;/section&gt;&lt;/li&gt;&lt;/ul&gt;&lt;figure data-tool=&quot;mdnice编辑器&quot;&gt;&lt;img class=&quot;rich_pages wxw-img&quot; data-ratio=&quot;0.5386973180076629&quot; data-src=&quot;https://mmbiz.qpic.cn/mmbiz_png/CKvMdchsUwnIKNicq9svDltkD4FDPgMt2nxXjkb7a5IGHibCe7zibXy6Yg6kQuH6Glv7Yxeuicfe4Hf0jkfJScJENg/640?wx_fmt=png&quot; data-type=&quot;png&quot; data-w=&quot;1305&quot;/&gt;&lt;/figure&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;项目地址：&lt;span&gt;&lt;strong&gt;https://gitee.com/durcframework/torna&lt;/strong&gt;&lt;/span&gt;&lt;/p&gt;&lt;h2 data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span/&gt;&lt;span&gt;Apifox&lt;/span&gt;&lt;span&gt; &lt;/span&gt;&lt;/h2&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;一款在线使用的API文档管理工具，可以配合Swagger使用，功能强大，界面炫酷！&lt;/p&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;Apifox 的定位是&lt;code&gt;Postman + Swagger + Mock + JMeter&lt;/code&gt;，具有API文档管理、API调试、API Mock、API 自动化测试等功能。可以通过一种工具解决之前使用多种工具的数据同步问题。高效、及时、准确！&lt;/p&gt;&lt;figure data-tool=&quot;mdnice编辑器&quot;&gt;&lt;img class=&quot;rich_pages wxw-img&quot; data-ratio=&quot;0.625&quot; data-src=&quot;https://mmbiz.qpic.cn/mmbiz_png/CKvMdchsUwnIKNicq9svDltkD4FDPgMt2kQic1NLz8pliaU8Z6pMRO5DdhCEmkic89nOicocdnoUrFZg06ibhxz7JJjA/640?wx_fmt=png&quot; data-type=&quot;png&quot; data-w=&quot;1280&quot;/&gt;&lt;/figure&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;具体使用可以参考：&lt;a href=&quot;https://mp.weixin.qq.com/s?__biz=MzU1Nzg4NjgyMw==&amp;amp;mid=2247495749&amp;amp;idx=1&amp;amp;sn=172dc024a07dd58f839032305fd79736&amp;amp;scene=21#wechat_redirect&quot; data-linktype=&quot;2&quot;&gt;《取代 Postman + Swagger！这款神器功能更强大，界面更炫酷！》&lt;/a&gt; 。&lt;/p&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;官方网站：&lt;span&gt;&lt;strong&gt;https://www.apifox.cn/&lt;/strong&gt;&lt;/span&gt;&lt;/p&gt;&lt;h2 data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span/&gt;&lt;span&gt;总结&lt;/span&gt;&lt;span&gt; &lt;/span&gt;&lt;/h2&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;本文整理了之前使用过的7种API文档生成+管理工具，如果你是刚开始使用API文档工具的话，使用Swagger准没错！如果你正在使用Swagger，想要使用更好的API文档工具的话，可以考虑将Swagger配合Knife4j、YApi或Torna来使用。如果你不介意在线使用API文档管理工具的话，可以使用Apifox，它的功能更强大。&lt;/p&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;最后，大家用的哪种API文档工具呢？&lt;/p&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;欢迎来投票统计看下！&lt;/p&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span class=&quot;vote_area&quot;&gt;&lt;span/&gt;&lt;span/&gt;&lt;/span&gt;&lt;/p&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;/p&gt;&lt;hr data-tool=&quot;mdnice编辑器&quot;/&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;strong&gt;微信8.0将好友放开到了一万，小伙伴可以加我大号了，先到先得，再满就真没了&lt;/strong&gt;&lt;/p&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;strong&gt;扫描下方二维码即可加我微信啦，&lt;code&gt;2021，抱团取暖，一起牛逼。&lt;/code&gt;&lt;/strong&gt;&lt;/p&gt;&lt;figure data-tool=&quot;mdnice编辑器&quot;&gt;&lt;img class=&quot;rich_pages wxw-img&quot; data-ratio=&quot;1&quot; data-src=&quot;https://mmbiz.qpic.cn/mmbiz_jpg/CKvMdchsUwnIKNicq9svDltkD4FDPgMt2Pus6ricVGMpmYu7FYic5nBMiazHXicxLr1nyZ5WKdwtPvkeqgCPVSqVW2w/640?wx_fmt=jpeg&quot; data-type=&quot;jpeg&quot; data-w=&quot;512&quot;/&gt;&lt;/figure&gt;&lt;h2 data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span/&gt;&lt;span&gt;推荐阅读&lt;/span&gt;&lt;span&gt; &lt;/span&gt;&lt;/h2&gt;&lt;/section&gt;&lt;/div&gt;&lt;/div&gt;</content:encoded>
</item>
<item>
<guid>558806dd6f88a4c7cb797dd4748baaea</guid>
<title>大数据时代-使用关系型数据库的价值意义？</title>
<link>https://toutiao.io/k/4syxmlm</link>
<content:encoded>&lt;div&gt;&lt;div&gt;&lt;div class=&quot;rich_media_content &quot; id=&quot;js_content&quot;&gt;
                    

                    
                    
                    
                    &lt;p&gt;不知道大家有没有这种经历：一个系统刚上线的时候是有完整的架构逻辑的，数据库表的设计也是经过精细推敲，以为可以经得起时间的考验。结果呢？上线之后各种新业务支持、新需求支持。不得不在原有的数据表中添加字段，一张表最后扩展到五六十个字段。甚至要建立几个ext（扩展）字段，把用下划线分割或者干脆一个json对象塞进去，像极了自家的衣柜。&lt;/p&gt;&lt;p&gt;&lt;img class=&quot;rich_pages wxw-img&quot; data-galleryid=&quot;&quot; data-ratio=&quot;0.6153846153846154&quot; data-s=&quot;300,640&quot; data-src=&quot;https://mmbiz.qpic.cn/mmbiz_png/2tk5ianItRlicO9CCTMKM25LvN3vXTENnjwmZ3K26icROg8dM5cSpn0Boibn1xJJ3TibibpRsUn839Y0c9yfR1nN43Fg/640?wx_fmt=png&quot; data-type=&quot;png&quot; data-w=&quot;650&quot;/&gt;&lt;/p&gt;&lt;p&gt;&lt;/p&gt;&lt;p&gt;这时候，甚至让人产生怀疑：当时技术选型是不是选错了？使用了关系型数据库表建立了一套结构化数据，最终数据塞的太多，失去了意义。对我来说简直就是key-value嘛，为什么要用关系型数据库嘞？&lt;/p&gt;&lt;p&gt;&lt;/p&gt;&lt;p&gt;以下是本人对这个问题的思考。&lt;/p&gt;&lt;p&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;&lt;strong&gt;&lt;span&gt;按结构分类的体系结构&lt;/span&gt;&lt;/strong&gt;&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;&lt;strong&gt;&lt;span&gt;结构化数据&lt;/span&gt;&lt;/strong&gt;&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;strong&gt;定义&lt;/strong&gt;&lt;/p&gt;&lt;p&gt;业界指关系模型数据，即以关系数据库(RDBMS)表形式管理的数据&lt;/p&gt;&lt;p&gt;&lt;strong&gt;简析&lt;/strong&gt;&lt;/p&gt;&lt;p&gt;虽然专业角度上看，结构化就是关系模型的说法并不准确，但针对目前业内现状，还是定义为关系模型最为妥善，因为它准确的代表了我们传统上最熟悉的企业业务数据。&lt;/p&gt;&lt;p&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;&lt;strong&gt;半结构化数据&lt;/strong&gt;&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;strong&gt;定义&lt;/strong&gt;&lt;/p&gt;&lt;p&gt;非关系模型的、有基本固定结构模式的数据，例如日志文件、XML文档、JSON文档、Email等。&lt;/p&gt;&lt;p&gt;&lt;strong&gt;解析&lt;/strong&gt;&lt;/p&gt;&lt;p&gt;严格讲，结构化与半结构化数据都是有基本固定结构模式的数据。但是关系型数据的结构更加严谨，可进行排序和计算等。而半结构化数据已经是大数据领域的范畴了。&lt;/p&gt;&lt;p&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;&lt;strong&gt;&lt;span&gt;非结构化数据&lt;/span&gt;&lt;/strong&gt;&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;strong&gt;定义&lt;/strong&gt;&lt;/p&gt;&lt;p&gt;没有固定模式的数据，如WORD、PDF、PPT、EXL，各种格式的图片、视频等。&lt;/p&gt;&lt;p&gt;&lt;strong&gt;简析&lt;/strong&gt;&lt;/p&gt;&lt;p&gt;区分半结构化与非结构化的意义在于，对两者的处理方法是不同的。对于非结构化数据，现在的大数据处理方法基本也就是当个磁带用，存储一下。需要的时候按照id给调用出来。高级一点的就是搜索引擎，分个词，按照关键词给调出来。&lt;/p&gt;&lt;p&gt;&lt;/p&gt;&lt;p&gt;&lt;strong&gt;&lt;span&gt;结论：在业界，希望数据是结构化的，目前最成熟的还是关系型数据库存储。&lt;/span&gt;&lt;/strong&gt;&lt;/p&gt;&lt;p&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;&lt;strong&gt;OLTP与OLAP&lt;/strong&gt;&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;/p&gt;&lt;p&gt;数据处理大致可以分成两大类：联机事务处理OLTP(on-line transaction processing)、联机分析处理OLAP(On-Line Analytical Processing)。&lt;/p&gt;&lt;p&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;&lt;strong&gt;OLTP&lt;/strong&gt;&lt;/span&gt;&lt;/p&gt;&lt;p&gt;是传统的关系型数据库的主要应用，主要是基本的、日常的事务处理，例如银行交易、订单处理。&lt;/p&gt;&lt;p&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;&lt;strong&gt;OLAP&lt;/strong&gt;&lt;/span&gt;&lt;/p&gt;&lt;p&gt;是数据仓库系统的主要应用，支持复杂的分析操作，侧重决策支持，并且提供直观易懂的查询结果。&lt;/p&gt;&lt;p&gt;现在联机分析处理的内容主要还是采集的结构化数据，半结构化数据都很少。有人说现在分析技术很牛X呀？什么AI人工智能啊。大家有没有听说人工智能的更精确表述：人工智障。AI除了作为一个中性的名词之外，还是一个贬义词，比如AI演技。&lt;/p&gt;&lt;p&gt;&lt;img class=&quot;rich_pages wxw-img&quot; data-ratio=&quot;1.0375&quot; data-src=&quot;https://mmbiz.qpic.cn/mmbiz_jpg/2tk5ianItRlicO9CCTMKM25LvN3vXTENnjwGS7OhtJia089LT1JYE6B1QTd5PnQNAqNF13WCCLnzzPjyyNGV317Cg/640?wx_fmt=jpeg&quot; data-type=&quot;jpeg&quot; data-w=&quot;240&quot;/&gt;&lt;/p&gt;&lt;p&gt;不过从选择行业的角度看，AI还是很有前途的。将来说不定可以做出神盾局特工里的Aida那样的超级机器人，只是千万要给她植入正确的观念，不要以摧毁世界为己任。&lt;/p&gt;&lt;p&gt;&lt;img class=&quot;rich_pages wxw-img&quot; data-ratio=&quot;0.5717981888745148&quot; data-src=&quot;https://mmbiz.qpic.cn/mmbiz_jpg/2tk5ianItRlicO9CCTMKM25LvN3vXTENnjzXu9SnzviakwDO2SVKIRUuCOIUerLqFjzYdVQ5lEnM9CvYl6kmHMr8w/640?wx_fmt=jpeg&quot; data-type=&quot;jpeg&quot; data-w=&quot;773&quot;/&gt;&lt;/p&gt;&lt;p&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;&lt;strong&gt;两者比较&lt;/strong&gt;&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;img class=&quot;rich_pages wxw-img&quot; data-ratio=&quot;0.3661360347322721&quot; data-src=&quot;https://mmbiz.qpic.cn/mmbiz/2tk5ianItRlicO9CCTMKM25LvN3vXTENnjUVWibu8IWibYialR3Mriaj809ZbuUbjQzcc02N75kh2KsGsRGtuWtEWFQQ/640?wx_fmt=other&quot; data-type=&quot;other&quot; data-w=&quot;691&quot;/&gt;&lt;/p&gt;&lt;p&gt;&lt;/p&gt;&lt;p&gt;&lt;strong&gt;&lt;span&gt;结论：在业界，希望OLTP操作，关系型数据库仍是首选。&lt;/span&gt;&lt;/strong&gt;&lt;/p&gt;&lt;p&gt;&lt;strong&gt;&lt;span&gt;&lt;br/&gt;&lt;/span&gt;&lt;/strong&gt;&lt;/p&gt;&lt;h1&gt;&lt;span&gt;&lt;strong&gt;&lt;span&gt;NoSQL&lt;/span&gt;&lt;/strong&gt;&lt;/span&gt;&lt;/h1&gt;&lt;p&gt;&lt;/p&gt;&lt;h1&gt;&lt;strong&gt;&lt;span&gt;定义&lt;/span&gt;&lt;/strong&gt;&lt;br/&gt;&lt;/h1&gt;&lt;h1&gt;非关系型数据库（NoSQL =not only sql ），是对不同于传统的关系型数据库的数据库管理系统的统称。一般是分布式的，且一般不保证遵循 ACID 原则的数据存储系统。&lt;/h1&gt;&lt;p&gt;&lt;img class=&quot;rich_pages wxw-img&quot; data-ratio=&quot;0.5625&quot; data-src=&quot;https://mmbiz.qpic.cn/mmbiz_jpg/2tk5ianItRlicO9CCTMKM25LvN3vXTENnjZyVibSFy8tlnJTvXuoBrvGR9fUbndyqNdYduVPeib36PkibsUW8pFRcicw/640?wx_fmt=jpeg&quot; data-type=&quot;jpeg&quot; data-w=&quot;1280&quot;/&gt;&lt;/p&gt;&lt;p&gt;&lt;/p&gt;&lt;h2&gt;&lt;span&gt;&lt;strong&gt;&lt;span&gt;RDBMS vs NoSQL&lt;/span&gt;&lt;/strong&gt;&lt;/span&gt;&lt;/h2&gt;&lt;p&gt;&lt;strong&gt;RDBMS&lt;/strong&gt;&lt;/p&gt;&lt;p&gt;&lt;strong&gt;NoSQL&lt;/strong&gt;&lt;/p&gt;&lt;ul class=&quot;list-paddingleft-2&quot;&gt;&lt;li&gt;&lt;p&gt;没有声明性查询语言&lt;/p&gt;&lt;/li&gt;&lt;li&gt;&lt;p&gt;没有预定义的模式&lt;/p&gt;&lt;/li&gt;&lt;li&gt;&lt;p&gt;键 - 值对存储，列存储，文档存储，图形数据库&lt;/p&gt;&lt;/li&gt;&lt;li&gt;&lt;p&gt;最终一致性，而非ACID属性&lt;/p&gt;&lt;/li&gt;&lt;li&gt;&lt;p&gt;非结构化和不可预知的数据&lt;/p&gt;&lt;/li&gt;&lt;li&gt;&lt;p&gt;CAP定理&lt;/p&gt;&lt;/li&gt;&lt;li&gt;&lt;p&gt;高性能，高可用性和可伸缩性&lt;/p&gt;&lt;/li&gt;&lt;/ul&gt;&lt;p&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;结论：&lt;/span&gt;&lt;span&gt;在业界，希望严格的一致，关系型数据库仍是第一选择。&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;&lt;strong&gt;数据库表与程序设计Q&amp;amp;A&lt;/strong&gt;&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;/p&gt;&lt;p&gt;RDBMS对程序设计提了很高的要求，强制在设计阶段想明白很多东西，不然数据表结构是设计不出来的：需要存储哪些字段，字段是什么类型，是否需要关联触发器、两个表之间是什么关系……所以有了如UML建模这种建模工具，来建立概念模型和物理模型。&lt;/p&gt;&lt;p&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;&lt;strong&gt;&lt;span&gt;Q：用了关系型数据库却基本用不到关系型运算，那使用关系型数据库还有价值吗？&lt;/span&gt;&lt;/strong&gt;&lt;/span&gt;&lt;/p&gt;&lt;p&gt;A：关系型运算是指选择、投影、连接、除法、外连接等。现在业界越来越不推荐直接在OLTP程序里使用join来连接表了，尽量使用单表操作。用的最多的还是选择，简单理解就是select+where的查询语句。业界也不推荐在OLTP程序中使用过于复杂的查询条件。&lt;/p&gt;&lt;p&gt;那是不是关系型数据库的优势就发挥不出来了呢？咱们这么想这件事情哈。现在数据库资源非常宝贵，所以为了保护数据库资源现在有很多措施：比如优先走缓存，再比如把刚才说的不推荐的join和复杂查询改用搜索引擎来做。&lt;/p&gt;&lt;p&gt;这里的搜索引擎呢数据来源还是关系型数据库。试想有个支付系统，在OLTP程序里完成了实时交易。数据都落到了关系型数据库中。商家想在后台看看自己今天的交易流水，这个就很合适将数据库中的数据采集到搜索引擎当中。商家查询时展示的是搜索引擎的结果。试想，搜索引擎的结果不是从关系型数据库中得来的，而是来源于key-value形式的nosql呢？那中间还要加一层数据处理，这个处理要做的事情就是把数据处理成结构化数据。那直接存在关系型数据库里就好了呀。&lt;/p&gt;&lt;p&gt;有的朋友就说了现在我们就是只做OLTP，这些后台查询都没有。可是现在没有不代表将来没有。有很多需求不是专门的需求人员提出来的，而是我们技术人员围绕着资源自己挖掘出来的，技术引领业务嘛！&lt;/p&gt;&lt;p&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;&lt;strong&gt;&lt;span&gt;Q：怎样技术引领业务呢？&lt;/span&gt;&lt;/strong&gt;&lt;/span&gt;&lt;/p&gt;&lt;p&gt;A：我非常建议大家找工作的时候第一看重的是公司和项目的前景和发展。有不错的业务量，有不错的增长。数据就是引领业务的钥匙。这就涉及到另外一个问题：数据要尽量满足范式的要求，让数据是简洁的、明晰的。&lt;/p&gt;&lt;p&gt;ext（扩展）字段，把用下划线分割或者干脆一个json对象塞进去，我是不建议的。我建议把字段定义清楚，该用关联子表的用子表。用子表从目前的业务上讲虽然处理上复杂些，开发可能会稍微减慢。但是从长远来看，现在可以放成一坨的数据，将来都是要分析的。如果现在定义清楚了，将是一笔宝贵的资源。&lt;/p&gt;
                &lt;/div&gt;

                

                



                
                &lt;/div&gt;&lt;/div&gt;</content:encoded>
</item>
<item>
<guid>48f2599c9afd332ee2232a18167a0903</guid>
<title>golang面试题：怎么避免内存逃逸？</title>
<link>https://toutiao.io/k/5yvfc9w</link>
<content:encoded>&lt;div&gt;&lt;div&gt;&lt;div class=&quot;rich_media_content &quot; id=&quot;js_content&quot;&gt;
                    

                    
                    
                    
                    &lt;section data-tool=&quot;mdnice编辑器&quot; data-website=&quot;https://www.mdnice.com&quot;&gt;&lt;figure data-tool=&quot;mdnice编辑器&quot;&gt;&lt;img class=&quot;rich_pages wxw-img&quot; data-ratio=&quot;0.4255555555555556&quot; data-src=&quot;https://mmbiz.qpic.cn/mmbiz_png/FmVWPHrDdnmt8rD6bsHalATUjw2XaWdc3UgD37wBI2TrCtribCozjf6CAMqz1pwncicnicbCuI9xqla4TKXS84IoQ/640?wx_fmt=png&quot; data-type=&quot;png&quot; data-w=&quot;900&quot;/&gt;&lt;/figure&gt;&lt;h2 data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span/&gt;&lt;span&gt;问题&lt;/span&gt;&lt;span&gt; &lt;/span&gt;&lt;/h2&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;怎么避免&lt;strong&gt;内存逃逸&lt;/strong&gt;？&lt;/p&gt;&lt;h2 data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span/&gt;&lt;span&gt;怎么答&lt;/span&gt;&lt;span&gt; &lt;/span&gt;&lt;/h2&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;在&lt;code&gt;runtime/stubs.go:133&lt;/code&gt;有个函数叫&lt;code&gt;noescape&lt;/code&gt;。&lt;code&gt;noescape&lt;/code&gt;可以在逃逸分析中&lt;strong&gt;隐藏一个指针&lt;/strong&gt;。让这个指针在逃逸分析中&lt;strong&gt;不会被检测为逃逸&lt;/strong&gt;。&lt;/p&gt;&lt;pre data-tool=&quot;mdnice编辑器&quot;&gt;&lt;code&gt; &lt;span&gt;// noescape hides a pointer from escape analysis.  noescape is&lt;/span&gt;&lt;br/&gt; &lt;span&gt;// the identity function but escape analysis doesn&#x27;t think the&lt;/span&gt;&lt;br/&gt; &lt;span&gt;// output depends on the input.  noescape is inlined and currently&lt;/span&gt;&lt;br/&gt; &lt;span&gt;// compiles down to zero instructions.&lt;/span&gt;&lt;br/&gt; &lt;span&gt;// USE CAREFULLY!&lt;/span&gt;&lt;br/&gt; &lt;span&gt;//go:nosplit&lt;/span&gt;&lt;br/&gt; &lt;span&gt;&lt;span&gt;func&lt;/span&gt; &lt;span&gt;noescape&lt;/span&gt;&lt;span&gt;(p unsafe.Pointer)&lt;/span&gt; &lt;span&gt;unsafe&lt;/span&gt;.&lt;span&gt;Pointer&lt;/span&gt;&lt;/span&gt; {&lt;br/&gt;     x := &lt;span&gt;uintptr&lt;/span&gt;(p)&lt;br/&gt;     &lt;span&gt;return&lt;/span&gt; unsafe.Pointer(x ^ &lt;span&gt;0&lt;/span&gt;)&lt;br/&gt;}&lt;br/&gt;&lt;/code&gt;&lt;/pre&gt;&lt;h2 data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span/&gt;&lt;span&gt;举例&lt;/span&gt;&lt;span&gt; &lt;/span&gt;&lt;/h2&gt;&lt;ul data-tool=&quot;mdnice编辑器&quot; class=&quot;list-paddingleft-2&quot;&gt;&lt;li&gt;&lt;section&gt;通过一个例子加深理解，接下来尝试下怎么通过 &lt;code&gt;go build -gcflags=-m&lt;/code&gt; 查看逃逸的情况。&lt;/section&gt;&lt;/li&gt;&lt;/ul&gt;&lt;pre data-tool=&quot;mdnice编辑器&quot;&gt;&lt;code&gt;&lt;span&gt;package&lt;/span&gt; main&lt;br/&gt;&lt;br/&gt;&lt;span&gt;import&lt;/span&gt; (&lt;br/&gt; &lt;span&gt;&quot;unsafe&quot;&lt;/span&gt;&lt;br/&gt;)&lt;br/&gt;&lt;br/&gt;&lt;span&gt;type&lt;/span&gt; A &lt;span&gt;struct&lt;/span&gt; {&lt;br/&gt; S *&lt;span&gt;string&lt;/span&gt;&lt;br/&gt;}&lt;br/&gt;&lt;br/&gt;&lt;span&gt;&lt;span&gt;func&lt;/span&gt; &lt;span&gt;(f *A)&lt;/span&gt; &lt;span&gt;String&lt;/span&gt;&lt;span&gt;()&lt;/span&gt; &lt;span&gt;string&lt;/span&gt;&lt;/span&gt; {&lt;br/&gt; &lt;span&gt;return&lt;/span&gt; *f.S&lt;br/&gt;}&lt;br/&gt;&lt;br/&gt;&lt;span&gt;type&lt;/span&gt; ATrick &lt;span&gt;struct&lt;/span&gt; {&lt;br/&gt; S unsafe.Pointer&lt;br/&gt;}&lt;br/&gt;&lt;br/&gt;&lt;span&gt;&lt;span&gt;func&lt;/span&gt; &lt;span&gt;(f *ATrick)&lt;/span&gt; &lt;span&gt;String&lt;/span&gt;&lt;span&gt;()&lt;/span&gt; &lt;span&gt;string&lt;/span&gt;&lt;/span&gt; {&lt;br/&gt; &lt;span&gt;return&lt;/span&gt; *(*&lt;span&gt;string&lt;/span&gt;)(f.S)&lt;br/&gt;}&lt;br/&gt;&lt;br/&gt;&lt;span&gt;&lt;span&gt;func&lt;/span&gt; &lt;span&gt;NewA&lt;/span&gt;&lt;span&gt;(s &lt;span&gt;string&lt;/span&gt;)&lt;/span&gt; &lt;span&gt;A&lt;/span&gt;&lt;/span&gt; {&lt;br/&gt; &lt;span&gt;return&lt;/span&gt; A{S: &amp;amp;s}&lt;br/&gt;}&lt;br/&gt;&lt;br/&gt;&lt;span&gt;&lt;span&gt;func&lt;/span&gt; &lt;span&gt;NewATrick&lt;/span&gt;&lt;span&gt;(s &lt;span&gt;string&lt;/span&gt;)&lt;/span&gt; &lt;span&gt;ATrick&lt;/span&gt;&lt;/span&gt; {&lt;br/&gt; &lt;span&gt;return&lt;/span&gt; ATrick{S: noescape(unsafe.Pointer(&amp;amp;s))}&lt;br/&gt;}&lt;br/&gt;&lt;br/&gt;&lt;span&gt;&lt;span&gt;func&lt;/span&gt; &lt;span&gt;noescape&lt;/span&gt;&lt;span&gt;(p unsafe.Pointer)&lt;/span&gt; &lt;span&gt;unsafe&lt;/span&gt;.&lt;span&gt;Pointer&lt;/span&gt;&lt;/span&gt; {&lt;br/&gt; x := &lt;span&gt;uintptr&lt;/span&gt;(p)&lt;br/&gt; &lt;span&gt;return&lt;/span&gt; unsafe.Pointer(x ^ &lt;span&gt;0&lt;/span&gt;)&lt;br/&gt;}&lt;br/&gt;&lt;br/&gt;&lt;span&gt;&lt;span&gt;func&lt;/span&gt; &lt;span&gt;main&lt;/span&gt;&lt;span&gt;()&lt;/span&gt;&lt;/span&gt; {&lt;br/&gt; s := &lt;span&gt;&quot;hello&quot;&lt;/span&gt;&lt;br/&gt; f1 := NewA(s)&lt;br/&gt; f2 := NewATrick(s)&lt;br/&gt; s1 := f1.String()&lt;br/&gt; s2 := f2.String()&lt;br/&gt; _ = s1 + s2&lt;br/&gt;}&lt;br/&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;执行&lt;code&gt;go build -gcflags=-m main.go&lt;/code&gt;&lt;/p&gt;&lt;pre data-tool=&quot;mdnice编辑器&quot;&gt;&lt;code&gt;$&lt;span&gt;go&lt;/span&gt; build -gcflags=-m main.&lt;span&gt;go&lt;/span&gt;&lt;br/&gt;# command-line-arguments&lt;br/&gt;./main.&lt;span&gt;go&lt;/span&gt;:&lt;span&gt;11&lt;/span&gt;:&lt;span&gt;6&lt;/span&gt;: can inline (*A).String&lt;br/&gt;./main.&lt;span&gt;go&lt;/span&gt;:&lt;span&gt;19&lt;/span&gt;:&lt;span&gt;6&lt;/span&gt;: can inline (*ATrick).String&lt;br/&gt;./main.&lt;span&gt;go&lt;/span&gt;:&lt;span&gt;23&lt;/span&gt;:&lt;span&gt;6&lt;/span&gt;: can inline NewA&lt;br/&gt;./main.&lt;span&gt;go&lt;/span&gt;:&lt;span&gt;31&lt;/span&gt;:&lt;span&gt;6&lt;/span&gt;: can inline noescape&lt;br/&gt;./main.&lt;span&gt;go&lt;/span&gt;:&lt;span&gt;27&lt;/span&gt;:&lt;span&gt;6&lt;/span&gt;: can inline NewATrick&lt;br/&gt;./main.&lt;span&gt;go&lt;/span&gt;:&lt;span&gt;28&lt;/span&gt;:&lt;span&gt;29&lt;/span&gt;: inlining call to noescape&lt;br/&gt;./main.&lt;span&gt;go&lt;/span&gt;:&lt;span&gt;36&lt;/span&gt;:&lt;span&gt;6&lt;/span&gt;: can inline main&lt;br/&gt;./main.&lt;span&gt;go&lt;/span&gt;:&lt;span&gt;38&lt;/span&gt;:&lt;span&gt;14&lt;/span&gt;: inlining call to NewA&lt;br/&gt;./main.&lt;span&gt;go&lt;/span&gt;:&lt;span&gt;39&lt;/span&gt;:&lt;span&gt;19&lt;/span&gt;: inlining call to NewATrick&lt;br/&gt;./main.&lt;span&gt;go&lt;/span&gt;:&lt;span&gt;39&lt;/span&gt;:&lt;span&gt;19&lt;/span&gt;: inlining call to noescape&lt;br/&gt;./main.&lt;span&gt;go&lt;/span&gt;:&lt;span&gt;40&lt;/span&gt;:&lt;span&gt;17&lt;/span&gt;: inlining call to (*A).String&lt;br/&gt;./main.&lt;span&gt;go&lt;/span&gt;:&lt;span&gt;41&lt;/span&gt;:&lt;span&gt;17&lt;/span&gt;: inlining call to (*ATrick).String&lt;br/&gt;/&lt;span&gt;var&lt;/span&gt;/folders/&lt;span&gt;45&lt;/span&gt;/qx9lfw2s2zzgvhzg3mtzkwzc0000gn/T/&lt;span&gt;go&lt;/span&gt;-build763863171/b001/_gomod_.&lt;span&gt;go&lt;/span&gt;:&lt;span&gt;6&lt;/span&gt;:&lt;span&gt;6&lt;/span&gt;: can inline init&lt;span&gt;.0&lt;/span&gt;&lt;br/&gt;./main.&lt;span&gt;go&lt;/span&gt;:&lt;span&gt;11&lt;/span&gt;:&lt;span&gt;7&lt;/span&gt;: leaking param: f to result ~r0 level=&lt;span&gt;2&lt;/span&gt;&lt;br/&gt;./main.&lt;span&gt;go&lt;/span&gt;:&lt;span&gt;19&lt;/span&gt;:&lt;span&gt;7&lt;/span&gt;: leaking param: f to result ~r0 level=&lt;span&gt;2&lt;/span&gt;&lt;br/&gt;./main.&lt;span&gt;go&lt;/span&gt;:&lt;span&gt;24&lt;/span&gt;:&lt;span&gt;16&lt;/span&gt;: &amp;amp;s escapes to heap&lt;br/&gt;./main.&lt;span&gt;go&lt;/span&gt;:&lt;span&gt;23&lt;/span&gt;:&lt;span&gt;13&lt;/span&gt;: moved to heap: s&lt;br/&gt;./main.&lt;span&gt;go&lt;/span&gt;:&lt;span&gt;27&lt;/span&gt;:&lt;span&gt;18&lt;/span&gt;: NewATrick s does not escape&lt;br/&gt;./main.&lt;span&gt;go&lt;/span&gt;:&lt;span&gt;28&lt;/span&gt;:&lt;span&gt;45&lt;/span&gt;: NewATrick &amp;amp;s does not escape&lt;br/&gt;./main.&lt;span&gt;go&lt;/span&gt;:&lt;span&gt;31&lt;/span&gt;:&lt;span&gt;15&lt;/span&gt;: noescape p does not escape&lt;br/&gt;./main.&lt;span&gt;go&lt;/span&gt;:&lt;span&gt;38&lt;/span&gt;:&lt;span&gt;14&lt;/span&gt;: main &amp;amp;s does not escape&lt;br/&gt;./main.&lt;span&gt;go&lt;/span&gt;:&lt;span&gt;39&lt;/span&gt;:&lt;span&gt;19&lt;/span&gt;: main &amp;amp;s does not escape&lt;br/&gt;./main.&lt;span&gt;go&lt;/span&gt;:&lt;span&gt;40&lt;/span&gt;:&lt;span&gt;10&lt;/span&gt;: main f1 does not escape&lt;br/&gt;./main.&lt;span&gt;go&lt;/span&gt;:&lt;span&gt;41&lt;/span&gt;:&lt;span&gt;10&lt;/span&gt;: main f2 does not escape&lt;br/&gt;./main.&lt;span&gt;go&lt;/span&gt;:&lt;span&gt;42&lt;/span&gt;:&lt;span&gt;9&lt;/span&gt;: main s1 + s2 does not escape&lt;br/&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;其中主要看中间一小段&lt;/p&gt;&lt;pre data-tool=&quot;mdnice编辑器&quot;&gt;&lt;code&gt;./main.&lt;span&gt;go&lt;/span&gt;:&lt;span&gt;24&lt;/span&gt;:&lt;span&gt;16&lt;/span&gt;: &amp;amp;s escapes to heap    &lt;span&gt;//这个是NewA中的，逃逸了&lt;/span&gt;&lt;br/&gt;./main.&lt;span&gt;go&lt;/span&gt;:&lt;span&gt;23&lt;/span&gt;:&lt;span&gt;13&lt;/span&gt;: moved to heap: s&lt;br/&gt;./main.&lt;span&gt;go&lt;/span&gt;:&lt;span&gt;27&lt;/span&gt;:&lt;span&gt;18&lt;/span&gt;: NewATrick s does not escape &lt;span&gt;// NewATrick里的s的却没逃逸&lt;/span&gt;&lt;br/&gt;./main.&lt;span&gt;go&lt;/span&gt;:&lt;span&gt;28&lt;/span&gt;:&lt;span&gt;45&lt;/span&gt;: NewATrick &amp;amp;s does not escape&lt;br/&gt;&lt;/code&gt;&lt;/pre&gt;&lt;h2 data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span/&gt;&lt;span&gt;解释&lt;/span&gt;&lt;span&gt; &lt;/span&gt;&lt;/h2&gt;&lt;ul data-tool=&quot;mdnice编辑器&quot; class=&quot;list-paddingleft-2&quot;&gt;&lt;li&gt;&lt;section&gt;&lt;p&gt;上段代码对&lt;code&gt;A&lt;/code&gt;和&lt;code&gt;ATrick&lt;/code&gt;同样的功能有两种实现：他们包含一个 &lt;code&gt;string&lt;/code&gt; ，然后用 &lt;code&gt;String()&lt;/code&gt; 方法返回这个字符串。但是从逃逸分析看&lt;code&gt;ATrick&lt;/code&gt; 版本没有逃逸。&lt;/p&gt;&lt;/section&gt;&lt;/li&gt;&lt;li&gt;&lt;section&gt;&lt;p&gt;&lt;code&gt;noescape()&lt;/code&gt; 函数的作用是遮蔽输入和输出的依赖关系。使编译器不认为 &lt;code&gt;p&lt;/code&gt; 会通过 &lt;code&gt;x&lt;/code&gt; 逃逸， 因为 &lt;code&gt;uintptr()&lt;/code&gt; 产生的引用是编译器无法理解的。&lt;/p&gt;&lt;/section&gt;&lt;/li&gt;&lt;li&gt;&lt;section&gt;&lt;p&gt;内置的 &lt;code&gt;uintptr&lt;/code&gt; 类型是一个真正的指针类型，但是在编译器层面，它只是一个存储一个 &lt;code&gt;指针地址&lt;/code&gt; 的 &lt;code&gt;int&lt;/code&gt; 类型。代码的最后一行返回 &lt;code&gt;unsafe.Pointer&lt;/code&gt; 也是一个 &lt;code&gt;int&lt;/code&gt;。&lt;/p&gt;&lt;/section&gt;&lt;/li&gt;&lt;li&gt;&lt;section&gt;&lt;p&gt;&lt;code&gt;noescape()&lt;/code&gt; 在 &lt;code&gt;runtime&lt;/code&gt; 包中使用 &lt;code&gt;unsafe.Pointer&lt;/code&gt; 的地方被大量使用。如果作者清楚被 &lt;code&gt;unsafe.Pointer&lt;/code&gt; 引用的数据肯定不会被逃逸，但编译器却不知道的情况下，这是很有用的。&lt;/p&gt;&lt;/section&gt;&lt;/li&gt;&lt;li&gt;&lt;section&gt;&lt;p&gt;&lt;strong&gt;面试中秀一秀是可以的&lt;/strong&gt;，如果在实际项目中如果使用这种unsafe包大概率会被同事打死。&lt;strong&gt;不建议使用！&lt;/strong&gt;  毕竟包的名字就叫做 &lt;code&gt;unsafe&lt;/code&gt;, 而且源码中的注释也写明了 &lt;code&gt;USE CAREFULLY!&lt;/code&gt;。&lt;/p&gt;&lt;/section&gt;&lt;/li&gt;&lt;/ul&gt;&lt;h6 data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span/&gt;如果你想每天学习一个知识点？那就快来关注小白吧。&lt;span/&gt;&lt;/h6&gt;&lt;section class=&quot;mp_profile_iframe_wrp&quot;&gt;&lt;mpprofile class=&quot;js_uneditable custom_select_card mp_profile_iframe&quot; data-pluginname=&quot;mpprofile&quot; data-id=&quot;Mzg5NDY2MDk4Mw==&quot; data-headimg=&quot;http://mmbiz.qpic.cn/mmbiz_png/AnAgeMhDIianpibeb1icaNfMQWI9DibKw3EcA2nvqMtwQ1GuX5bFuupzh6LaH1AkOZggtabj6t0mXvgIGibhwUYCz4w/0?wx_fmt=png&quot; data-nickname=&quot;小白debug&quot; data-alias=&quot;xiaobaidebug&quot; data-signature=&quot;答应我，关注之后，好好学技术，别只是收藏我的表情包。。&quot; data-from=&quot;0&quot;/&gt;&lt;/section&gt;&lt;/section&gt;
                &lt;/div&gt;

                

                



                
                &lt;/div&gt;&lt;/div&gt;</content:encoded>
</item>
<item>
<guid>6ccb59b0956690f25eea394a34915a34</guid>
<title>CSS实现微信朋友圈的九宫格图片自适应</title>
<link>https://toutiao.io/k/f1tvjcl</link>
<content:encoded>&lt;div&gt;&lt;div&gt;&lt;section data-tool=&quot;mdnice编辑器&quot; data-website=&quot;https://www.mdnice.com&quot; data-mpa-powered-by=&quot;yiban.io&quot;&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;大家好，我是&lt;/span&gt;&lt;span&gt;&lt;strong&gt;Peter&lt;/strong&gt;&lt;/span&gt;&lt;span&gt;，微信朋友圈都发过吧？&lt;/span&gt;&lt;span&gt;它支持最多发9张图片，所以我们也称之为&lt;/span&gt;&lt;span&gt;九宫格&lt;/span&gt;&lt;/p&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;要知道发1~9任意数量的图片时，这些图片的排列方式可能有所不同。大体有这&lt;span&gt;四种排列情况&lt;/span&gt;：&lt;/p&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;情况一&lt;/span&gt;：只有一张图，完整展示整张图&lt;/p&gt;&lt;figure data-tool=&quot;mdnice编辑器&quot;&gt;&lt;img class=&quot;rich_pages wxw-img&quot; data-ratio=&quot;0.6815227483751161&quot; data-src=&quot;https://mmbiz.qpic.cn/mmbiz_png/lgHVurTfTcxCC8S0mpWUH3Xou53YXLPNKBqkvzedib2BzBoqiaO7VfT1iaE3xXADFuoiaHibMTZ8C5OxyiaP2Xr6gGgQ/640?wx_fmt=png&quot; data-type=&quot;png&quot; data-w=&quot;1077&quot;/&gt;&lt;figcaption&gt;1张图&lt;/figcaption&gt;&lt;/figure&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;情况二&lt;/span&gt;：2~3张图的情况，无法完整展示每张图，则在第一排依次排开（一排最多3张）&lt;/p&gt;&lt;figure data-tool=&quot;mdnice编辑器&quot;&gt;&lt;img class=&quot;rich_pages wxw-img&quot; data-ratio=&quot;0.8973880597014925&quot; data-src=&quot;https://mmbiz.qpic.cn/mmbiz_png/lgHVurTfTcxCC8S0mpWUH3Xou53YXLPNJgy1Js6R2fEJO5fkf3aicxcRJnicuIaIyicw8iaEY7qicvWsDuT8OqaVfsg/640?wx_fmt=png&quot; data-type=&quot;png&quot; data-w=&quot;1072&quot;/&gt;&lt;figcaption&gt;2张图 &amp;amp; 3张图&lt;/figcaption&gt;&lt;/figure&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;情况三&lt;/span&gt;：4张图的情况，无法完整展示每张图，每排2张图，共2排&lt;/p&gt;&lt;figure data-tool=&quot;mdnice编辑器&quot;&gt;&lt;img class=&quot;rich_pages wxw-img&quot; data-ratio=&quot;0.7097674418604651&quot; data-src=&quot;https://mmbiz.qpic.cn/mmbiz_png/lgHVurTfTcxCC8S0mpWUH3Xou53YXLPNyWlmY8FAb13mdbblJkJ3d7M3tWJegDwT0x4XFnwQicEBfBE9yzFdY8g/640?wx_fmt=png&quot; data-type=&quot;png&quot; data-w=&quot;1075&quot;/&gt;&lt;figcaption&gt;4张图&lt;/figcaption&gt;&lt;/figure&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;情况四&lt;/span&gt;：5~9张图的情况跟情况二类似，也无法完整展示每张图，每排最多3张图，依次排开&lt;/p&gt;&lt;figure data-tool=&quot;mdnice编辑器&quot;&gt;&lt;img class=&quot;rich_pages wxw-img&quot; data-ratio=&quot;0.7007434944237918&quot; data-src=&quot;https://mmbiz.qpic.cn/mmbiz_png/lgHVurTfTcxCC8S0mpWUH3Xou53YXLPNrq1sGIiajEwkAUglyOJ5sJazTkc8DGq6XCZ9D8YyFSLBZ7pdXCqznQg/640?wx_fmt=png&quot; data-type=&quot;png&quot; data-w=&quot;1076&quot;/&gt;&lt;figcaption&gt;5张图&lt;/figcaption&gt;&lt;/figure&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;其实就是对不同数量的图片做了一个排版的自适应，原理也很简单，我们一起来用CSS实现一下吧~&lt;/span&gt;&lt;/p&gt;&lt;blockquote data-tool=&quot;mdnice编辑器&quot;&gt;&lt;p&gt;没有完全按照微信的排版是，自己改良了一下，最终完整效果见下面这个视频👇&lt;span/&gt;&lt;/p&gt;&lt;/blockquote&gt;&lt;section/&gt;&lt;h2 data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;创建容器&lt;/span&gt;&lt;/h2&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;先创建一个元素作为容器&lt;/p&gt;&lt;pre data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span/&gt;&lt;code&gt;&lt;span&gt;&amp;lt;&lt;span&gt;div&lt;/span&gt; &lt;span&gt;class&lt;/span&gt;=&lt;span&gt;&quot;pictures-adaptive&quot;&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;br/&gt;  &lt;span&gt;&amp;lt;!-- 里面放 img 图片 --&amp;gt;&lt;/span&gt;&lt;br/&gt;&lt;span&gt;&amp;lt;/&lt;span&gt;div&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;br/&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;并将其设置为 &lt;code&gt;Flex&lt;/code&gt; 布局，且可换行&lt;/p&gt;&lt;pre data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span/&gt;&lt;code&gt;&lt;span&gt;.pictures-adaptive&lt;/span&gt; {&lt;br/&gt;  &lt;span&gt;display&lt;/span&gt;: flex;&lt;br/&gt;  &lt;span&gt;flex-wrap&lt;/span&gt;: wrap;&lt;br/&gt;}&lt;br/&gt;&lt;/code&gt;&lt;/pre&gt;&lt;h2 data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span/&gt;&lt;span&gt;1张图片&lt;/span&gt;&lt;/h2&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;只有1张图片的情况最简单，就让图片直接展示就好，但大于1张图时，所有图片都是无法完全展示的，它们是以一个正方形的形式展现的，所以我们需要给 &lt;code&gt;img&lt;/code&gt; 外侧包一个容器，便于后续控制图片的展示&lt;/p&gt;&lt;pre data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span/&gt;&lt;code&gt;&lt;span&gt;&amp;lt;&lt;span&gt;div&lt;/span&gt; &lt;span&gt;class&lt;/span&gt;=&lt;span&gt;&quot;pictures-adaptive&quot;&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;br/&gt;  &lt;span&gt;&amp;lt;&lt;span&gt;div&lt;/span&gt; &lt;span&gt;class&lt;/span&gt;=&lt;span&gt;&quot;wrap&quot;&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;br/&gt;    &lt;span&gt;&amp;lt;&lt;span&gt;img&lt;/span&gt; &lt;span&gt;src&lt;/span&gt;=&lt;span&gt;&quot;demo.png&quot;&lt;/span&gt;/&amp;gt;&lt;/span&gt;&lt;br/&gt;  &lt;span&gt;&amp;lt;/&lt;span&gt;div&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;br/&gt;&lt;span&gt;&amp;lt;/&lt;span&gt;div&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;br/&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;样式也不用设置，最终效果是这样的&lt;/p&gt;&lt;figure data-tool=&quot;mdnice编辑器&quot;&gt;&lt;img class=&quot;rich_pages wxw-img&quot; data-ratio=&quot;0.5014925373134328&quot; data-src=&quot;https://mmbiz.qpic.cn/mmbiz_png/lgHVurTfTcxCC8S0mpWUH3Xou53YXLPNicRMzDCAC9AoCr1ccicZMHBicQt5XR8JrRWVHMuRibzTIScMUHGnJibdPMA/640?wx_fmt=png&quot; data-type=&quot;png&quot; data-w=&quot;670&quot;/&gt;&lt;figcaption&gt;1张图片&lt;/figcaption&gt;&lt;/figure&gt;&lt;h2 data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span/&gt;&lt;span&gt;多张图片&lt;/span&gt;&lt;/h2&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;大于1张图片时，图片需要在正方形容器中&lt;span&gt;非完整居中展示&lt;/span&gt;，可以让 &lt;code&gt;img&lt;/code&gt; 标签相对于外部容器元素相对定位&lt;/p&gt;&lt;pre data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span/&gt;&lt;code&gt;&lt;span&gt;/* 相对定位，img相对于.wrap相对定位 */&lt;/span&gt;&lt;br/&gt;&lt;span&gt;.wrap&lt;/span&gt; {&lt;br/&gt;  &lt;span&gt;position&lt;/span&gt;: relative;&lt;br/&gt;  &lt;span&gt;overflow&lt;/span&gt;: hidden;&lt;br/&gt;  &lt;span&gt;margin-bottom&lt;/span&gt;: &lt;span&gt;2%&lt;/span&gt;;&lt;br/&gt;}&lt;br/&gt;&lt;br/&gt;&lt;span&gt;/* 大于1张图片时，img标签的样式 */&lt;/span&gt;&lt;br/&gt;&lt;span&gt;.wrap&lt;/span&gt;&lt;span&gt;:not(&lt;/span&gt;&lt;span&gt;:nth-child(1)&lt;/span&gt;&lt;span&gt;:nth-last-child(1))&lt;/span&gt; &lt;span&gt;img&lt;/span&gt; {&lt;br/&gt;  &lt;span&gt;position&lt;/span&gt;: absolute;&lt;br/&gt;  &lt;span&gt;top&lt;/span&gt;: &lt;span&gt;0&lt;/span&gt;;&lt;br/&gt;  &lt;span&gt;left&lt;/span&gt;: &lt;span&gt;0&lt;/span&gt;;&lt;br/&gt;  &lt;span&gt;width&lt;/span&gt;: &lt;span&gt;100%&lt;/span&gt;;&lt;br/&gt;  &lt;span&gt;height&lt;/span&gt;: &lt;span&gt;100%&lt;/span&gt;;&lt;br/&gt;  &lt;span&gt;object-fit&lt;/span&gt;: cover;&lt;br/&gt;}&lt;br/&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;分析了一下，多张图片的情况可以分为 &lt;span&gt;2、4张图片&lt;/span&gt; 或者 &lt;span&gt;3张图片&lt;/span&gt;、&lt;span&gt;5~9张图片&lt;/span&gt;&lt;/p&gt;&lt;h3 data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span/&gt;&lt;span/&gt;&lt;span&gt;2或4张图片&lt;/span&gt;&lt;span/&gt;&lt;/h3&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;2或4张图片时都是一行只有两个图片，且两张图片各占一半左右的宽度&lt;/p&gt;&lt;pre data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span/&gt;&lt;code&gt;&lt;span&gt;/*  2张图片  */&lt;/span&gt;&lt;br/&gt;&lt;span&gt;.wrap&lt;/span&gt;&lt;span&gt;:nth-child(1)&lt;/span&gt;&lt;span&gt;:nth-last-child(2)&lt;/span&gt;,&lt;br/&gt;&lt;span&gt;.wrap&lt;/span&gt;&lt;span&gt;:nth-child(2)&lt;/span&gt;&lt;span&gt;:nth-last-child(1)&lt;/span&gt;,&lt;br/&gt;&lt;span&gt;/*  4张图片  */&lt;/span&gt;&lt;br/&gt;&lt;span&gt;.wrap&lt;/span&gt;&lt;span&gt;:nth-child(1)&lt;/span&gt;&lt;span&gt;:nth-last-child(4)&lt;/span&gt;,&lt;br/&gt;&lt;span&gt;.wrap&lt;/span&gt;&lt;span&gt;:nth-child(2)&lt;/span&gt;&lt;span&gt;:nth-last-child(3)&lt;/span&gt;,&lt;br/&gt;&lt;span&gt;.wrap&lt;/span&gt;&lt;span&gt;:nth-child(3)&lt;/span&gt;&lt;span&gt;:nth-last-child(2)&lt;/span&gt;,&lt;br/&gt;&lt;span&gt;.wrap&lt;/span&gt;&lt;span&gt;:nth-child(4)&lt;/span&gt;&lt;span&gt;:nth-last-child(1)&lt;/span&gt;&lt;br/&gt;{&lt;br/&gt;  &lt;span&gt;width&lt;/span&gt;: &lt;span&gt;49%&lt;/span&gt;;&lt;br/&gt;  &lt;span&gt;padding-bottom&lt;/span&gt;: &lt;span&gt;49%&lt;/span&gt;;&lt;br/&gt;}&lt;br/&gt;&lt;br/&gt;&lt;br/&gt;&lt;span&gt;/* 每行的两张图片中间间隔2%的宽度 */&lt;/span&gt;&lt;br/&gt;&lt;span&gt;/*  2张图片  */&lt;/span&gt;&lt;br/&gt;&lt;span&gt;.wrap&lt;/span&gt;&lt;span&gt;:nth-child(2)&lt;/span&gt;&lt;span&gt;:nth-last-child(1)&lt;/span&gt;,&lt;br/&gt;&lt;span&gt;/*  4张图片  */&lt;/span&gt;&lt;br/&gt;&lt;span&gt;.wrap&lt;/span&gt;&lt;span&gt;:nth-child(2)&lt;/span&gt;&lt;span&gt;:nth-last-child(3)&lt;/span&gt;,&lt;br/&gt;&lt;span&gt;.wrap&lt;/span&gt;&lt;span&gt;:nth-child(4)&lt;/span&gt;&lt;span&gt;:nth-last-child(1)&lt;/span&gt;&lt;br/&gt;{&lt;br/&gt;  &lt;span&gt;margin-left&lt;/span&gt;: &lt;span&gt;2%&lt;/span&gt;;&lt;br/&gt;}&lt;br/&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;最终效果是这样的&lt;/p&gt;&lt;figure data-tool=&quot;mdnice编辑器&quot;&gt;&lt;img class=&quot;rich_pages wxw-img&quot; data-ratio=&quot;0.5118343195266272&quot; data-src=&quot;https://mmbiz.qpic.cn/mmbiz_png/lgHVurTfTcxCC8S0mpWUH3Xou53YXLPN7TTFVzn7TWOqV2o60ooq71M5Dsyuo2sp5RTfMMvxylJwR2Lc6nGiaGg/640?wx_fmt=png&quot; data-type=&quot;png&quot; data-w=&quot;676&quot;/&gt;&lt;figcaption&gt;2张图片&lt;/figcaption&gt;&lt;/figure&gt;&lt;figure data-tool=&quot;mdnice编辑器&quot;&gt;&lt;img class=&quot;rich_pages wxw-img&quot; data-ratio=&quot;1&quot; data-src=&quot;https://mmbiz.qpic.cn/mmbiz_png/lgHVurTfTcxCC8S0mpWUH3Xou53YXLPNcPrzTOtXjzSTzTzMYmMzI5OrbSuTFia78ibSJv88Vp1VhQcF36B9ZQJw/640?wx_fmt=png&quot; data-type=&quot;png&quot; data-w=&quot;678&quot;/&gt;&lt;figcaption&gt;4张图片&lt;/figcaption&gt;&lt;/figure&gt;&lt;h3 data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span/&gt;&lt;span/&gt;&lt;span&gt;3张图片&lt;/span&gt;&lt;span/&gt;&lt;/h3&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;3张图片的情况是：&lt;span&gt;三张图排列在同一行&lt;/span&gt;&lt;/p&gt;&lt;pre data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span/&gt;&lt;code&gt;&lt;span&gt;/*  3张图片  */&lt;/span&gt;&lt;br/&gt;&lt;span&gt;.wrap&lt;/span&gt;&lt;span&gt;:nth-child(1)&lt;/span&gt;&lt;span&gt;:nth-last-child(3)&lt;/span&gt;,&lt;br/&gt;&lt;span&gt;.wrap&lt;/span&gt;&lt;span&gt;:nth-child(2)&lt;/span&gt;&lt;span&gt;:nth-last-child(2)&lt;/span&gt;,&lt;br/&gt;&lt;span&gt;.wrap&lt;/span&gt;&lt;span&gt;:nth-child(3)&lt;/span&gt;&lt;span&gt;:nth-last-child(1)&lt;/span&gt; &lt;br/&gt;{&lt;br/&gt;  &lt;span&gt;width&lt;/span&gt;: &lt;span&gt;32%&lt;/span&gt;;&lt;br/&gt;  &lt;span&gt;padding-bottom&lt;/span&gt;: &lt;span&gt;32%&lt;/span&gt;;&lt;br/&gt;}&lt;br/&gt;&lt;br/&gt;&lt;span&gt;/*  间隔  */&lt;/span&gt;&lt;br/&gt;&lt;span&gt;.wrap&lt;/span&gt;&lt;span&gt;:nth-child(2)&lt;/span&gt;&lt;span&gt;:nth-last-child(2)&lt;/span&gt;,&lt;br/&gt;&lt;span&gt;.wrap&lt;/span&gt;&lt;span&gt;:nth-child(3)&lt;/span&gt;&lt;span&gt;:nth-last-child(1)&lt;/span&gt; &lt;br/&gt;{&lt;br/&gt;  &lt;span&gt;margin-left&lt;/span&gt;: &lt;span&gt;2%&lt;/span&gt;;&lt;br/&gt;}&lt;br/&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;最终效果是这样的&lt;/p&gt;&lt;figure data-tool=&quot;mdnice编辑器&quot;&gt;&lt;img class=&quot;rich_pages wxw-img&quot; data-ratio=&quot;0.34310850439882695&quot; data-src=&quot;https://mmbiz.qpic.cn/mmbiz_png/lgHVurTfTcxCC8S0mpWUH3Xou53YXLPNplqWuRyaPzesF6eTpxUy9qMNfcwVOmJiaMIgFjhuXukiciczyyiaW9TYQQ/640?wx_fmt=png&quot; data-type=&quot;png&quot; data-w=&quot;682&quot;/&gt;&lt;figcaption&gt;3张图片&lt;/figcaption&gt;&lt;/figure&gt;&lt;h3 data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span/&gt;&lt;span/&gt;&lt;span&gt;5~9张图片&lt;/span&gt;&lt;span/&gt;&lt;/h3&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;5~9张图片的情况其实跟3张图片的排版是一样的，不过可以简化写法&lt;/p&gt;&lt;pre data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span/&gt;&lt;code&gt;&lt;span&gt;/*  5张以上图片  */&lt;/span&gt;&lt;br/&gt;&lt;span&gt;.wrap&lt;/span&gt;&lt;span&gt;:nth-child(n&lt;/span&gt; + 5),&lt;br/&gt;&lt;span&gt;.wrap&lt;/span&gt;&lt;span&gt;:nth-child(1)&lt;/span&gt;&lt;span&gt;:nth-last-child(n&lt;/span&gt; + 5),&lt;br/&gt;&lt;span&gt;.wrap&lt;/span&gt;&lt;span&gt;:nth-child(1)&lt;/span&gt;&lt;span&gt;:nth-last-child(n&lt;/span&gt; + 5) ~ &lt;span&gt;.wrap&lt;/span&gt;&lt;br/&gt;{&lt;br/&gt;  &lt;span&gt;width&lt;/span&gt;: &lt;span&gt;32%&lt;/span&gt;;&lt;br/&gt;  &lt;span&gt;padding-bottom&lt;/span&gt;: &lt;span&gt;32%&lt;/span&gt;;&lt;br/&gt;}&lt;br/&gt;&lt;br/&gt;&lt;span&gt;/*  间隔  */&lt;/span&gt;&lt;br/&gt;&lt;span&gt;.wrap&lt;/span&gt;&lt;span&gt;:nth-child(n&lt;/span&gt; + 5)&lt;span&gt;:not(&lt;/span&gt;&lt;span&gt;:nth-child(3n&lt;/span&gt; + 1)),&lt;br/&gt;&lt;span&gt;.wrap&lt;/span&gt;&lt;span&gt;:nth-child(1)&lt;/span&gt;&lt;span&gt;:nth-last-child(n&lt;/span&gt; + 5) ~ &lt;span&gt;.wrap&lt;/span&gt;&lt;span&gt;:not(&lt;/span&gt;&lt;span&gt;:nth-child(3n&lt;/span&gt; + 1))&lt;br/&gt;{&lt;br/&gt;  &lt;span&gt;margin-left&lt;/span&gt;: &lt;span&gt;2%&lt;/span&gt;;&lt;br/&gt;}&lt;br/&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;最终效果是这样的&lt;/p&gt;&lt;figure data-tool=&quot;mdnice编辑器&quot;&gt;&lt;img class=&quot;rich_pages wxw-img&quot; data-ratio=&quot;1&quot; data-src=&quot;https://mmbiz.qpic.cn/mmbiz_png/lgHVurTfTcxCC8S0mpWUH3Xou53YXLPNj6icj6RcjDB0mwabbBdC3m1DRN9ZxHQUCGdCAVnTw6tBQJpjM4B5dOg/640?wx_fmt=png&quot; data-type=&quot;png&quot; data-w=&quot;680&quot;/&gt;&lt;figcaption&gt;9张图片&lt;/figcaption&gt;&lt;/figure&gt;&lt;h2 data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span/&gt;&lt;span&gt;完整代码&lt;/span&gt;&lt;/h2&gt;&lt;pre data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span/&gt;&lt;code&gt;&lt;span&gt;&amp;lt;!DOCTYPE &lt;span&gt;html&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;br/&gt;&lt;span&gt;&amp;lt;&lt;span&gt;html&lt;/span&gt; &lt;span&gt;lang&lt;/span&gt;=&lt;span&gt;&quot;en&quot;&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;br/&gt;&lt;span&gt;&amp;lt;&lt;span&gt;head&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;br/&gt;  &lt;span&gt;&amp;lt;&lt;span&gt;meta&lt;/span&gt; &lt;span&gt;charset&lt;/span&gt;=&lt;span&gt;&quot;UTF-8&quot;&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;br/&gt;  &lt;span&gt;&amp;lt;&lt;span&gt;meta&lt;/span&gt; &lt;span&gt;http-equiv&lt;/span&gt;=&lt;span&gt;&quot;X-UA-Compatible&quot;&lt;/span&gt; &lt;span&gt;content&lt;/span&gt;=&lt;span&gt;&quot;IE=edge&quot;&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;br/&gt;  &lt;span&gt;&amp;lt;&lt;span&gt;meta&lt;/span&gt; &lt;span&gt;name&lt;/span&gt;=&lt;span&gt;&quot;viewport&quot;&lt;/span&gt; &lt;span&gt;content&lt;/span&gt;=&lt;span&gt;&quot;width=device-width, initial-scale=1.0&quot;&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;br/&gt;  &lt;span&gt;&amp;lt;&lt;span&gt;title&lt;/span&gt;&amp;gt;&lt;/span&gt;微信朋友圈图片九宫格排版自适应（改编版）&lt;span&gt;&amp;lt;/&lt;span&gt;title&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;br/&gt;  &lt;span&gt;&amp;lt;&lt;span&gt;style&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;span&gt;&lt;br/&gt;    &lt;span&gt;.pictures-adaptive&lt;/span&gt; {&lt;br/&gt;      &lt;span&gt;display&lt;/span&gt;: flex;&lt;br/&gt;      &lt;span&gt;flex-wrap&lt;/span&gt;: wrap;&lt;br/&gt;    }&lt;br/&gt;&lt;br/&gt;    &lt;span&gt;.wrap&lt;/span&gt; {&lt;br/&gt;      &lt;span&gt;position&lt;/span&gt;: relative;&lt;br/&gt;      &lt;span&gt;overflow&lt;/span&gt;: hidden;&lt;br/&gt;      &lt;span&gt;margin-bottom&lt;/span&gt;: &lt;span&gt;2%&lt;/span&gt;;&lt;br/&gt;    }&lt;br/&gt;&lt;br/&gt;    &lt;span&gt;/*  3张图片  */&lt;/span&gt;&lt;br/&gt;    &lt;span&gt;.wrap&lt;/span&gt;&lt;span&gt;:nth-child(1)&lt;/span&gt;&lt;span&gt;:nth-last-child(3)&lt;/span&gt;,&lt;br/&gt;    &lt;span&gt;.wrap&lt;/span&gt;&lt;span&gt;:nth-child(2)&lt;/span&gt;&lt;span&gt;:nth-last-child(2)&lt;/span&gt;,&lt;br/&gt;    &lt;span&gt;.wrap&lt;/span&gt;&lt;span&gt;:nth-child(3)&lt;/span&gt;&lt;span&gt;:nth-last-child(1)&lt;/span&gt; &lt;br/&gt;    {&lt;br/&gt;      &lt;span&gt;width&lt;/span&gt;: &lt;span&gt;32%&lt;/span&gt;;&lt;br/&gt;      &lt;span&gt;padding-bottom&lt;/span&gt;: &lt;span&gt;32%&lt;/span&gt;;&lt;br/&gt;    }&lt;br/&gt;&lt;br/&gt;    &lt;span&gt;/*  间隔  */&lt;/span&gt;&lt;br/&gt;    &lt;span&gt;.wrap&lt;/span&gt;&lt;span&gt;:nth-child(2)&lt;/span&gt;&lt;span&gt;:nth-last-child(2)&lt;/span&gt;,&lt;br/&gt;    &lt;span&gt;.wrap&lt;/span&gt;&lt;span&gt;:nth-child(3)&lt;/span&gt;&lt;span&gt;:nth-last-child(1)&lt;/span&gt; &lt;br/&gt;    {&lt;br/&gt;      &lt;span&gt;margin-left&lt;/span&gt;: &lt;span&gt;2%&lt;/span&gt;;&lt;br/&gt;    }&lt;br/&gt;&lt;br/&gt;    &lt;span&gt;.wrap&lt;/span&gt;&lt;span&gt;:not(&lt;/span&gt;&lt;span&gt;:nth-child(1)&lt;/span&gt;&lt;span&gt;:nth-last-child(1))&lt;/span&gt; &lt;span&gt;img&lt;/span&gt; {&lt;br/&gt;      &lt;span&gt;position&lt;/span&gt;: absolute;&lt;br/&gt;      &lt;span&gt;top&lt;/span&gt;: &lt;span&gt;0&lt;/span&gt;;&lt;br/&gt;      &lt;span&gt;left&lt;/span&gt;: &lt;span&gt;0&lt;/span&gt;;&lt;br/&gt;      &lt;span&gt;width&lt;/span&gt;: &lt;span&gt;100%&lt;/span&gt;;&lt;br/&gt;      &lt;span&gt;height&lt;/span&gt;: &lt;span&gt;100%&lt;/span&gt;;&lt;br/&gt;      &lt;span&gt;object-fit&lt;/span&gt;: cover;&lt;br/&gt;    }&lt;br/&gt;&lt;br/&gt;    &lt;span&gt;/*  2张图片  */&lt;/span&gt;&lt;br/&gt;    &lt;span&gt;.wrap&lt;/span&gt;&lt;span&gt;:nth-child(1)&lt;/span&gt;&lt;span&gt;:nth-last-child(2)&lt;/span&gt;,&lt;br/&gt;    &lt;span&gt;.wrap&lt;/span&gt;&lt;span&gt;:nth-child(2)&lt;/span&gt;&lt;span&gt;:nth-last-child(1)&lt;/span&gt;,&lt;br/&gt;    &lt;span&gt;/*  4张图片  */&lt;/span&gt;&lt;br/&gt;    &lt;span&gt;.wrap&lt;/span&gt;&lt;span&gt;:nth-child(1)&lt;/span&gt;&lt;span&gt;:nth-last-child(4)&lt;/span&gt;,&lt;br/&gt;    &lt;span&gt;.wrap&lt;/span&gt;&lt;span&gt;:nth-child(2)&lt;/span&gt;&lt;span&gt;:nth-last-child(3)&lt;/span&gt;,&lt;br/&gt;    &lt;span&gt;.wrap&lt;/span&gt;&lt;span&gt;:nth-child(3)&lt;/span&gt;&lt;span&gt;:nth-last-child(2)&lt;/span&gt;,&lt;br/&gt;    &lt;span&gt;.wrap&lt;/span&gt;&lt;span&gt;:nth-child(4)&lt;/span&gt;&lt;span&gt;:nth-last-child(1)&lt;/span&gt;&lt;br/&gt;    {&lt;br/&gt;      &lt;span&gt;width&lt;/span&gt;: &lt;span&gt;49%&lt;/span&gt;;&lt;br/&gt;      &lt;span&gt;padding-bottom&lt;/span&gt;: &lt;span&gt;49%&lt;/span&gt;;&lt;br/&gt;    }&lt;br/&gt;&lt;br/&gt;    &lt;span&gt;/* 每行的两张图片中间间隔2%的宽度 */&lt;/span&gt;&lt;br/&gt;    &lt;span&gt;/*  2张图片  */&lt;/span&gt;&lt;br/&gt;    &lt;span&gt;.wrap&lt;/span&gt;&lt;span&gt;:nth-child(2)&lt;/span&gt;&lt;span&gt;:nth-last-child(1)&lt;/span&gt;,&lt;br/&gt;    &lt;span&gt;/*  4张图片  */&lt;/span&gt;&lt;br/&gt;    &lt;span&gt;.wrap&lt;/span&gt;&lt;span&gt;:nth-child(2)&lt;/span&gt;&lt;span&gt;:nth-last-child(3)&lt;/span&gt;,&lt;br/&gt;    &lt;span&gt;.wrap&lt;/span&gt;&lt;span&gt;:nth-child(4)&lt;/span&gt;&lt;span&gt;:nth-last-child(1)&lt;/span&gt;&lt;br/&gt;    {&lt;br/&gt;      &lt;span&gt;margin-left&lt;/span&gt;: &lt;span&gt;2%&lt;/span&gt;;&lt;br/&gt;    }&lt;br/&gt;&lt;br/&gt;    &lt;span&gt;/*  5张以上图片  */&lt;/span&gt;&lt;br/&gt;    &lt;span&gt;.wrap&lt;/span&gt;&lt;span&gt;:nth-child(n&lt;/span&gt; + 5),&lt;br/&gt;    &lt;span&gt;.wrap&lt;/span&gt;&lt;span&gt;:nth-child(1)&lt;/span&gt;&lt;span&gt;:nth-last-child(n&lt;/span&gt; + 5),&lt;br/&gt;    &lt;span&gt;.wrap&lt;/span&gt;&lt;span&gt;:nth-child(1)&lt;/span&gt;&lt;span&gt;:nth-last-child(n&lt;/span&gt; + 5) ~ &lt;span&gt;.wrap&lt;/span&gt;&lt;br/&gt;    {&lt;br/&gt;      &lt;span&gt;width&lt;/span&gt;: &lt;span&gt;32%&lt;/span&gt;;&lt;br/&gt;      &lt;span&gt;padding-bottom&lt;/span&gt;: &lt;span&gt;32%&lt;/span&gt;;&lt;br/&gt;    }&lt;br/&gt;&lt;br/&gt;    &lt;span&gt;.wrap&lt;/span&gt;&lt;span&gt;:nth-child(n&lt;/span&gt; + 5)&lt;span&gt;:not(&lt;/span&gt;&lt;span&gt;:nth-child(3n&lt;/span&gt; + 1)),&lt;br/&gt;    &lt;span&gt;.wrap&lt;/span&gt;&lt;span&gt;:nth-child(1)&lt;/span&gt;&lt;span&gt;:nth-last-child(n&lt;/span&gt; + 5) ~ &lt;span&gt;.wrap&lt;/span&gt;&lt;span&gt;:not(&lt;/span&gt;&lt;span&gt;:nth-child(3n&lt;/span&gt; + 1))&lt;br/&gt;    {&lt;br/&gt;      &lt;span&gt;margin-left&lt;/span&gt;: &lt;span&gt;2%&lt;/span&gt;;&lt;br/&gt;    }&lt;br/&gt;  &lt;/span&gt;&lt;span&gt;&amp;lt;/&lt;span&gt;style&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;br/&gt;&lt;span&gt;&amp;lt;/&lt;span&gt;head&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;br/&gt;&lt;span&gt;&amp;lt;&lt;span&gt;body&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;br/&gt;  &lt;span&gt;&amp;lt;&lt;span&gt;div&lt;/span&gt; &lt;span&gt;class&lt;/span&gt;=&lt;span&gt;&quot;pictures-adaptive&quot;&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;br/&gt;    &lt;span&gt;&amp;lt;&lt;span&gt;div&lt;/span&gt; &lt;span&gt;class&lt;/span&gt;=&lt;span&gt;&quot;wrap&quot;&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;br/&gt;      &lt;span&gt;&amp;lt;&lt;span&gt;img&lt;/span&gt; &lt;span&gt;src&lt;/span&gt;=&lt;span&gt;&quot;data:image/jpeg;base64,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&quot;&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;br/&gt;      &lt;span&gt;&amp;lt;!-- More imgs --&amp;gt;&lt;/span&gt;&lt;br/&gt;    &lt;span&gt;&amp;lt;/&lt;span&gt;div&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;br/&gt;  &lt;span&gt;&amp;lt;/&lt;span&gt;div&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;br/&gt;&lt;span&gt;&amp;lt;/&lt;span&gt;body&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;br/&gt;&lt;span&gt;&amp;lt;/&lt;span&gt;html&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;br/&gt;&lt;/code&gt;&lt;/pre&gt;&lt;h2 data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span/&gt;&lt;span&gt;最后&lt;/span&gt;&lt;/h2&gt;&lt;section class=&quot;mp_profile_iframe_wrp&quot;&gt;&lt;mpprofile class=&quot;js_uneditable custom_select_card mp_profile_iframe&quot; data-pluginname=&quot;mpprofile&quot; data-id=&quot;MzkwODIwMDY2OQ==&quot; data-headimg=&quot;http://mmbiz.qpic.cn/sz_mmbiz_png/3GPT1CHiaSVuTf2nqwvRMOiarZSOlzHsHXHiaLI5jJW6j2KAB6qfMDSYZODN9JxVItAV5icAD6HldO0ibtLwKBjEXOw/0?wx_fmt=png&quot; data-nickname=&quot;前端巅峰&quot; data-alias=&quot;Java-Script-&quot; data-signature=&quot;专注于国内外前端前沿技术的应用与落地&quot; data-from=&quot;0&quot;/&gt;&lt;/section&gt;&lt;section class=&quot;mp_profile_iframe_wrp&quot;&gt;&lt;span&gt;如果本文能对大家有所帮助的话，点个 &lt;/span&gt;&lt;span&gt;赞&lt;/span&gt;&lt;span&gt; 和 &lt;/span&gt;&lt;span&gt;在看&lt;/span&gt;&lt;span&gt; 再走吧~&lt;/span&gt;&lt;/section&gt;&lt;/section&gt;&lt;/div&gt;&lt;/div&gt;</content:encoded>
</item>
<item>
<guid>ded8e9d11ec484bea63a2d8a72958eef</guid>
<title>从零到一编码实现Redis分布式锁</title>
<link>https://toutiao.io/k/97npbxa</link>
<content:encoded>&lt;div&gt;&lt;div&gt;&lt;p class=&quot;original_area_primary&quot;&gt;
                                                                                                &lt;/p&gt;

                    
                                            &lt;div class=&quot;rich_media_content &quot; id=&quot;js_content&quot;&gt;
                    

                    
                    
                    
                    &lt;blockquote data-mpa-powered-by=&quot;yiban.io&quot;&gt;&lt;p&gt;&lt;span&gt;&lt;strong&gt;问&lt;/strong&gt;: 不是有redission等现成工具吗？咋不用？&lt;br/&gt;&lt;strong&gt;答&lt;/strong&gt;: 不，我就想自己写一个！&lt;br/&gt;&lt;br/&gt;&lt;span&gt;陈建斌说 : 你这个男的怎么回事 ?！&lt;/span&gt;&lt;/span&gt;&lt;/p&gt;&lt;/blockquote&gt;&lt;p&gt;&lt;span&gt;有的同学，就是这么尿性。也能理解，不自己弄一下，怎么能理解透彻，那就一起来搞一下呗！&lt;/span&gt;&lt;/p&gt;&lt;h2&gt;&lt;strong&gt;&lt;span&gt;使用场景和选型&lt;/span&gt;&lt;/strong&gt;&lt;/h2&gt;&lt;p&gt;&lt;span&gt;分布式多节点的部署方式，使得共享变量有可能被同时操作，遇到有数据一致性要求的情况，就需要采取全局锁定的措施来保障并发操作下的一致性要求，如，库存扣减操作、同一个商品的上下架和更新操作等等。&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;常见的，分布式锁采用&lt;/span&gt;&lt;code&gt;&lt;span&gt;Zookeeper&lt;/span&gt;&lt;/code&gt;&lt;span&gt;和&lt;/span&gt;&lt;code&gt;&lt;span&gt;Redis&lt;/span&gt;&lt;/code&gt;&lt;span&gt;来实现。怎么取舍呢？&lt;/span&gt;&lt;/p&gt;&lt;section&gt;&lt;table&gt;&lt;thead&gt;&lt;tr&gt;&lt;td&gt;&lt;br/&gt;&lt;/td&gt;&lt;td&gt;&lt;p&gt;&lt;span&gt;zookeeper&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td&gt;&lt;p&gt;&lt;span&gt;redis&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/thead&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td&gt;&lt;p&gt;&lt;span&gt;&lt;strong&gt;加锁原理&lt;/strong&gt;&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td&gt;&lt;p&gt;&lt;span&gt;创建节点,节点已存在时创建失败&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td&gt;&lt;p&gt;&lt;span&gt;插入数据,数据已存在则设置失败&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td&gt;&lt;p&gt;&lt;span&gt;&lt;strong&gt;过期保护&lt;/strong&gt;&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td&gt;&lt;p&gt;&lt;span&gt;节点类型为临时节点,断连删除&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td&gt;&lt;p&gt;&lt;span&gt;设置过期时间,到期删除&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td&gt;&lt;p&gt;&lt;span&gt;&lt;strong&gt;优点&lt;/strong&gt;&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td&gt;&lt;p&gt;&lt;span&gt;在加锁失败时,zk的注册通知更优雅&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td&gt;&lt;p&gt;&lt;span&gt;速度快,性能高&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td&gt;&lt;p&gt;&lt;span&gt;&lt;strong&gt;缺点&lt;/strong&gt;&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td&gt;&lt;p&gt;&lt;span&gt;只有leader负责写,然后通知flower,性能较差&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td&gt;&lt;p&gt;&lt;span&gt;抢锁失败时,需要自旋循环尝试&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/section&gt;&lt;p&gt;&lt;span&gt;生产环境下，性能往往被优先考虑，相比较各自的优缺点，综合考虑，我们一般更倾向于redis。&lt;/span&gt;&lt;/p&gt;&lt;h2&gt;&lt;strong&gt;&lt;span&gt;从0到1 实现分布式锁&lt;/span&gt;&lt;/strong&gt;&lt;/h2&gt;&lt;h3&gt;&lt;span&gt;step1: 加锁 和 解锁的基础能力构建&lt;/span&gt;&lt;/h3&gt;&lt;p&gt;&lt;code&gt;&lt;span&gt;Jedis.set(key, value, params)&lt;/span&gt;&lt;/code&gt;&lt;span&gt; 👏🏻&lt;br/&gt;这个2.6之后新增的加强版set命令是真不错，解决了加锁时设置锁超时时间的原子诉求，防止服务宕机导致的死锁~&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;(1) 一个具有加锁解锁功能的分布式锁对象，最少要有 &lt;span&gt;&lt;code&gt;jedis客户端&lt;/code&gt;&lt;/span&gt; 、 &lt;span&gt;&lt;code&gt;对应的redis key&lt;/code&gt;&lt;/span&gt; 、 &lt;span&gt;&lt;code&gt;锁超时时间&lt;/code&gt;&lt;/span&gt; :&lt;/span&gt;&lt;/p&gt;&lt;pre&gt;&lt;section&gt;&lt;code&gt;&lt;span&gt;/&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span&gt;&lt;span&gt;/构建分布式锁对象&lt;/span&gt;&lt;br/&gt;&lt;span&gt;public&lt;/span&gt; &lt;span&gt;class&lt;/span&gt; &lt;span&gt;DistributedLock&lt;/span&gt; {&lt;br/&gt;    &lt;span&gt;private&lt;/span&gt; Jedis jedis;&lt;br/&gt;    &lt;span&gt;private&lt;/span&gt; String lockName;&lt;br/&gt;    &lt;span&gt;private&lt;/span&gt; &lt;span&gt;long&lt;/span&gt; lockExpireSecond;&lt;br/&gt;&lt;br/&gt;    &lt;span&gt;public&lt;/span&gt; &lt;span&gt;DistributedLock&lt;/span&gt;(Jedis jedis, String lockName, &lt;span&gt;long&lt;/span&gt; lockExpireSecond) {&lt;br/&gt;        &lt;span&gt;this&lt;/span&gt;.jedis = jedis;&lt;br/&gt;        &lt;span&gt;this&lt;/span&gt;.lockName = lockName;&lt;br/&gt;        &lt;span&gt;this&lt;/span&gt;.lockExpireSecond = lockExpireSecond;&lt;br/&gt;    }&lt;br/&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/section&gt;&lt;/pre&gt;&lt;p&gt;&lt;span&gt;(2) 利用&lt;/span&gt;&lt;code&gt;&lt;span&gt;jedis&lt;/span&gt;&lt;/code&gt;&lt;span&gt;提供的&lt;/span&gt;&lt;code&gt;&lt;span&gt;SetParams&lt;/span&gt;&lt;/code&gt;&lt;span&gt; ，对&lt;/span&gt;&lt;code&gt;&lt;span&gt;NX&lt;/span&gt;&lt;/code&gt;&lt;span&gt; , &lt;/span&gt;&lt;code&gt;&lt;span&gt;PX&lt;/span&gt;&lt;/code&gt;&lt;span&gt; 在&lt;/span&gt;&lt;code&gt;&lt;span&gt;jedis.set&lt;/span&gt;&lt;/code&gt;&lt;span&gt;操作中一次性的原子的完成设置:&lt;/span&gt;&lt;/p&gt;&lt;pre&gt;&lt;section&gt;&lt;code&gt;&lt;span&gt;&lt;span&gt;public&lt;/span&gt; &lt;span&gt;void&lt;/span&gt; &lt;span&gt;lock&lt;/span&gt;() &lt;span&gt;throws&lt;/span&gt; BizException {&lt;br/&gt;    &lt;span&gt;String&lt;/span&gt; &lt;span&gt;lockResult&lt;/span&gt; = &lt;span&gt;null&lt;/span&gt;;&lt;br/&gt;    &lt;span&gt;try&lt;/span&gt; {&lt;br/&gt;       &lt;span&gt;//设置 NX PX 参数&lt;/span&gt;&lt;br/&gt;       &lt;span&gt;SetParams&lt;/span&gt; &lt;span&gt;params&lt;/span&gt; = &lt;span&gt;new&lt;/span&gt; &lt;span&gt;SetParams&lt;/span&gt;();&lt;br/&gt;       params.nx();&lt;br/&gt;       params.px(TimeUnit.SECONDS.toMillis(lockExpireSecond));&lt;br/&gt;       &lt;span&gt;//执行加锁 , value 暂定 为固定字符串&lt;/span&gt;&lt;br/&gt;       lockResult = &lt;span&gt;this&lt;/span&gt;.jedis.set(&lt;span&gt;this&lt;/span&gt;.lockName, &lt;span&gt;&quot;lockValue&quot;&lt;/span&gt;, params);&lt;br/&gt;&lt;br/&gt;   } &lt;span&gt;catch&lt;/span&gt; (Exception e) {&lt;br/&gt;       LOG.error(&lt;span&gt;&quot;lock error&quot;&lt;/span&gt;,e);&lt;br/&gt;   }&lt;br/&gt;&lt;br/&gt;   &lt;span&gt;if&lt;/span&gt; (&lt;span&gt;&quot;OK&quot;&lt;/span&gt;.equals(lockResult)) {&lt;br/&gt;       LOG.debug(&lt;span&gt;&quot;locked success,lockName:{}&quot;&lt;/span&gt;,lockName);&lt;br/&gt;   } &lt;span&gt;else&lt;/span&gt; {&lt;br/&gt;      &lt;span&gt;throw&lt;/span&gt; &lt;span&gt;new&lt;/span&gt; &lt;span&gt;BizException&lt;/span&gt;(&lt;span&gt;&quot;Get lock failed.&quot;&lt;/span&gt;);&lt;br/&gt;   }&lt;br/&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/section&gt;&lt;/pre&gt;&lt;p&gt;&lt;span&gt;(3) 用&lt;/span&gt;&lt;code&gt;&lt;span&gt;jedis.del&lt;/span&gt;&lt;/code&gt;&lt;span&gt;命令完成解锁：&lt;/span&gt;&lt;/p&gt;&lt;pre&gt;&lt;section&gt;&lt;code&gt;&lt;span&gt; &lt;span&gt;public&lt;/span&gt; &lt;span&gt;boolean&lt;/span&gt; &lt;span&gt;unlock&lt;/span&gt;() {&lt;br/&gt;    &lt;span&gt;boolean&lt;/span&gt; unlockResult=&lt;span&gt;false&lt;/span&gt;;&lt;br/&gt;&lt;br/&gt;   &lt;span&gt;try&lt;/span&gt; {&lt;br/&gt;       &lt;span&gt;this&lt;/span&gt;.jedis.del(&lt;span&gt;this&lt;/span&gt;.lockName);&lt;br/&gt;       unlockResult=&lt;span&gt;true&lt;/span&gt;;&lt;br/&gt;   }&lt;span&gt;catch&lt;/span&gt; (Exception e){&lt;br/&gt;      LOG.error(&lt;span&gt;&quot;unLock error&quot;&lt;/span&gt;,e);&lt;br/&gt;   }&lt;br/&gt;    &lt;span&gt;return&lt;/span&gt; unlockResult;&lt;br/&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/section&gt;&lt;/pre&gt;&lt;h3&gt;&lt;span&gt;step2: 加锁失败直接结束? 希望多试几次&lt;/span&gt;&lt;/h3&gt;&lt;p&gt;&lt;span&gt;从上面的构造函数和&lt;/span&gt;&lt;code&gt;&lt;span&gt;lock()&lt;/span&gt;&lt;/code&gt;&lt;span&gt;实现，发现当前实现属于一锤子买卖，不成功便成仁。这其实不太满足我们的生产需求，很多场景下，业务执行速度是很快的，只要稍微等一等，就可以。那怎么办？&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;&lt;strong&gt;&lt;code&gt;自定义重试次数和等待间隔，有限重试等待&lt;/code&gt;&lt;/strong&gt;&lt;/span&gt;&lt;/p&gt;&lt;pre&gt;&lt;section&gt;&lt;code&gt;&lt;span&gt;&lt;span&gt;//新增重试间隔属性&lt;/span&gt;&lt;br/&gt;&lt;span&gt;private&lt;/span&gt; &lt;span&gt;long&lt;/span&gt; retryIntervalTime; &lt;br/&gt;&lt;br/&gt;&lt;span&gt;//通过构造方法初始化重试间隔&lt;/span&gt;&lt;br/&gt;&lt;span&gt;public&lt;/span&gt; &lt;span&gt;DistributedLock&lt;/span&gt;(Jedis jedis, String lockName, &lt;span&gt;long&lt;/span&gt; lockExpireSecond, &lt;span&gt;long&lt;/span&gt; retryIntervalTime) {&lt;br/&gt;   ...略&lt;br/&gt;   &lt;span&gt;this&lt;/span&gt;.retryIntervalTime = retryIntervalTime;&lt;br/&gt;}&lt;br/&gt;&lt;br/&gt;&lt;span&gt;//新增入参，加锁超时时间&lt;/span&gt;&lt;br/&gt;&lt;span&gt;public&lt;/span&gt; &lt;span&gt;void&lt;/span&gt; &lt;span&gt;lock&lt;/span&gt;(&lt;span&gt;long&lt;/span&gt; timeout,TimeUnit unit) &lt;span&gt;throws&lt;/span&gt; TimeoutException {&lt;br/&gt;   &lt;span&gt;String&lt;/span&gt; &lt;span&gt;lockResult&lt;/span&gt; = &lt;span&gt;null&lt;/span&gt;;&lt;br/&gt;   &lt;span&gt;try&lt;/span&gt; {&lt;br/&gt;       &lt;span&gt;//设置 NX PX 参数&lt;/span&gt;&lt;br/&gt;       &lt;span&gt;SetParams&lt;/span&gt; &lt;span&gt;params&lt;/span&gt; = &lt;span&gt;new&lt;/span&gt; &lt;span&gt;SetParams&lt;/span&gt;();&lt;br/&gt;       params.nx();&lt;br/&gt;       params.px(TimeUnit.SECONDS.toMillis(lockExpireSecond));&lt;br/&gt;            &lt;br/&gt;      &lt;span&gt;//加锁开始时间&lt;/span&gt;&lt;br/&gt;      &lt;span&gt;long&lt;/span&gt; startTime=System.nanoTime();&lt;br/&gt;            &lt;br/&gt;      &lt;span&gt;//循环有限等待&lt;/span&gt;&lt;br/&gt;      &lt;span&gt;while&lt;/span&gt; (!&lt;span&gt;&quot;OK&quot;&lt;/span&gt;.equals(lockResult=&lt;span&gt;this&lt;/span&gt;.jedis.set(&lt;span&gt;this&lt;/span&gt;.lockName, &lt;span&gt;&quot;lockValue&quot;&lt;/span&gt;, params))&amp;amp;&amp;amp;!isTimeout(startTime,unit.toNanos(timeout))){&lt;br/&gt;           Thread.sleep(retryIntervalTime);&lt;br/&gt;     }&lt;br/&gt;&lt;br/&gt;  } &lt;span&gt;catch&lt;/span&gt; (Exception e) {&lt;br/&gt;      LOG.error(&lt;span&gt;&quot;lock error&quot;&lt;/span&gt;,e);&lt;br/&gt;  }&lt;br/&gt;        &lt;br/&gt;  &lt;span&gt;//修改抛出异常类型为超时异常&lt;/span&gt;&lt;br/&gt;  &lt;span&gt;if&lt;/span&gt; (&lt;span&gt;&quot;OK&quot;&lt;/span&gt;.equals(lockResult)) {&lt;br/&gt;       LOG.debug(&lt;span&gt;&quot;locked success,lockName:{}&quot;&lt;/span&gt;,lockName);&lt;br/&gt;  } &lt;span&gt;else&lt;/span&gt; {&lt;br/&gt;      &lt;span&gt;throw&lt;/span&gt; &lt;span&gt;new&lt;/span&gt; &lt;span&gt;TimeoutException&lt;/span&gt;(&lt;span&gt;&quot;Get lock failed because of timeout.&quot;&lt;/span&gt;);&lt;br/&gt;  }&lt;br/&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/section&gt;&lt;/pre&gt;&lt;h3&gt;&lt;span&gt;step3: 只能解自己加的锁，别人的锁不能乱动&lt;/span&gt;&lt;/h3&gt;&lt;p&gt;&lt;span&gt;考虑一个问题：我们为了防止加锁后机器宕机的情况，给锁设置了过期时间，以此来保障锁可以在服务节点宕机不能解锁时，也可以给后续业务提供锁操作。&lt;/span&gt;&lt;/p&gt;&lt;figure&gt;&lt;img class=&quot;rich_pages wxw-img&quot; data-ratio=&quot;0.5366178428761651&quot; data-src=&quot;https://mmbiz.qpic.cn/mmbiz_png/xE6oscyT533CIGonPXeDgc0Vial1lovGCH2IjiahiacrEfibNgIKicfC06kUG8nibBmUtSepWmwKRzSPNR5ujNnR8aTg/640?wx_fmt=png&quot; data-type=&quot;png&quot; data-w=&quot;1502&quot; title=&quot;null&quot;/&gt;&lt;p&gt;&lt;span&gt;参考《How to do distributed locking》&lt;/span&gt;&lt;/p&gt;&lt;/figure&gt;&lt;p&gt;&lt;span&gt;上图中，因为业务执行时间的不可控（或者遇到GC等不可预期的停顿），给分布式锁带来了使用问题。&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;我们先看问题一：用户线程&lt;/span&gt;&lt;code&gt;&lt;span&gt;1&lt;/span&gt;&lt;/code&gt;&lt;span&gt; 把 线程&lt;/span&gt;&lt;code&gt;&lt;span&gt;2&lt;/span&gt;&lt;/code&gt;&lt;span&gt;的锁释放了！怎么办呢？&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;&lt;strong&gt;&lt;code&gt;加锁保存线程标识，解锁校验，非自己的锁不释放&lt;/code&gt;&lt;/strong&gt;&lt;/span&gt;&lt;/p&gt;&lt;pre&gt;&lt;section&gt;&lt;code&gt;&lt;span&gt;&lt;span&gt;//其他属性略，新增lockOwner标识&lt;/span&gt;&lt;br/&gt;&lt;span&gt;private&lt;/span&gt; String lockOwner;&lt;br/&gt;&lt;br/&gt;&lt;span&gt;//通过构造函数初始化lockOwner标识 &lt;/span&gt;&lt;br/&gt;&lt;span&gt;public&lt;/span&gt; &lt;span&gt;DistributedLock&lt;/span&gt;(Jedis jedis, String lockName, String lockOwner, &lt;span&gt;long&lt;/span&gt; lockExpireSecond, &lt;span&gt;long&lt;/span&gt; retryIntervalTime) {&lt;br/&gt;    ...略&lt;br/&gt;    &lt;span&gt;this&lt;/span&gt;.lockOwner = lockOwner;&lt;br/&gt;}&lt;br/&gt;&lt;br/&gt;&lt;span&gt;public&lt;/span&gt; &lt;span&gt;void&lt;/span&gt; &lt;span&gt;lock&lt;/span&gt;(&lt;span&gt;long&lt;/span&gt; timeout,TimeUnit unit) &lt;span&gt;throws&lt;/span&gt; TimeoutException {&lt;br/&gt;   &lt;span&gt;String&lt;/span&gt; &lt;span&gt;lockResult&lt;/span&gt; = &lt;span&gt;null&lt;/span&gt;;&lt;br/&gt;   &lt;span&gt;try&lt;/span&gt; {&lt;br/&gt;      &lt;span&gt;//设置 NX PX 参数&lt;/span&gt;&lt;br/&gt;      &lt;span&gt;SetParams&lt;/span&gt; &lt;span&gt;params&lt;/span&gt; = &lt;span&gt;new&lt;/span&gt; &lt;span&gt;SetParams&lt;/span&gt;();&lt;br/&gt;      params.nx();&lt;br/&gt;      params.px(TimeUnit.SECONDS.toMillis(lockExpireSecond));&lt;br/&gt;            &lt;br/&gt;      &lt;span&gt;//加锁开始时间&lt;/span&gt;&lt;br/&gt;      &lt;span&gt;long&lt;/span&gt; startTime=System.nanoTime();&lt;br/&gt;            &lt;br/&gt;      &lt;span&gt;// set时的value 改为 lockOwner&lt;/span&gt;&lt;br/&gt;     &lt;span&gt;while&lt;/span&gt; (!&lt;span&gt;&quot;OK&quot;&lt;/span&gt;.equals(lockResult=&lt;span&gt;this&lt;/span&gt;.jedis.set(&lt;span&gt;this&lt;/span&gt;.lockName, &lt;span&gt;this&lt;/span&gt;.lockOwner, params))&amp;amp;&amp;amp;!isTimeout(startTime,unit.toNanos(timeout))){&lt;br/&gt;         Thread.sleep(retryIntervalTime);&lt;br/&gt;      }&lt;br/&gt;   } &lt;span&gt;catch&lt;/span&gt; (Exception e) {&lt;br/&gt;       LOG.error(&lt;span&gt;&quot;lock error&quot;&lt;/span&gt;,e);&lt;br/&gt;   }&lt;br/&gt;   ...略&lt;br/&gt;}&lt;br/&gt;    &lt;br/&gt;&lt;span&gt;public&lt;/span&gt; &lt;span&gt;boolean&lt;/span&gt; &lt;span&gt;unlock&lt;/span&gt;() {&lt;br/&gt;    &lt;span&gt;boolean&lt;/span&gt; unlockResult=&lt;span&gt;false&lt;/span&gt;;&lt;br/&gt;    &lt;span&gt;try&lt;/span&gt; {&lt;br/&gt;       &lt;span&gt;// 先getValue ,并和当前lockOwner匹配，匹配上才去解锁&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;if&lt;/span&gt; (&lt;span&gt;this&lt;/span&gt;.lockOwner.equals(&lt;span&gt;this&lt;/span&gt;.jedis.get(&lt;span&gt;this&lt;/span&gt;.lockName))) {&lt;br/&gt;           &lt;span&gt;this&lt;/span&gt;.jedis.del(&lt;span&gt;this&lt;/span&gt;.lockName);&lt;br/&gt;           unlockResult = &lt;span&gt;true&lt;/span&gt;;&lt;br/&gt;       }&lt;br/&gt;   }&lt;span&gt;catch&lt;/span&gt; (Exception e){&lt;br/&gt;        LOG.error(&lt;span&gt;&quot;unLock error&quot;&lt;/span&gt;,e);&lt;br/&gt;  }&lt;br/&gt;    &lt;span&gt;return&lt;/span&gt; unlockResult;&lt;br/&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/section&gt;&lt;/pre&gt;&lt;p&gt;&lt;span&gt;有的同学说，这个解锁的地方，需要用lua包成原子操作。单从功能上来讲，上面的实现也是OK的，因为只有get到的结果和本身匹配，才会进行下述操作。包成lua脚本的目的，应该主要是为了减少一次传输，提高执行效率。&lt;/span&gt;&lt;/p&gt;&lt;h3&gt;&lt;span&gt;step4: expire时间不够产生并发冲突&lt;/span&gt;&lt;/h3&gt;&lt;figure&gt;&lt;img class=&quot;rich_pages wxw-img&quot; data-ratio=&quot;0.5558739255014327&quot; data-src=&quot;https://mmbiz.qpic.cn/mmbiz_png/xE6oscyT533CIGonPXeDgc0Vial1lovGCKsc2F33Tib7FYrXPaZpQAlx8lLsgVOVFyHOUCpzB1OofZ3x0MvPlejA/640?wx_fmt=png&quot; data-type=&quot;png&quot; data-w=&quot;1396&quot; title=&quot;null&quot;/&gt;&lt;/figure&gt;&lt;p&gt;&lt;span&gt;也就是之前的图中的问题二：线程1 还在执行中，锁就过期释放了，导致线程2也加锁成功，这直接导致了线程间的业务冲突。怎么办呢？&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;&lt;strong&gt;&lt;code&gt;锁持有期内，根据需要，动态延长锁的过期时间&lt;/code&gt;&lt;/strong&gt;&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;触发锁延期的方案选型，也是个大事，&lt;/span&gt;&lt;code&gt;&lt;span&gt;jdk原生timer&lt;/span&gt;&lt;/code&gt;&lt;span&gt;、&lt;/span&gt;&lt;code&gt;&lt;span&gt;调度线程池&lt;/span&gt;&lt;/code&gt;&lt;span&gt;、&lt;/span&gt;&lt;code&gt;&lt;span&gt;netty&lt;/span&gt;&lt;/code&gt;&lt;span&gt;的&lt;/span&gt;&lt;code&gt;&lt;span&gt;Timer&lt;/span&gt;&lt;/code&gt;&lt;span&gt;都可以实现，选哪个好？&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;综合对比精度、资源消耗等方面，&lt;/span&gt;&lt;code&gt;&lt;span&gt;Netty&lt;/span&gt;&lt;/code&gt;&lt;span&gt;中采用时间轮算法的&lt;/span&gt;&lt;code&gt;&lt;span&gt;Timer&lt;/span&gt;&lt;/code&gt;&lt;span&gt;应该是首选，都能管理成千上万的连接、调度心跳检测，拿来搞个锁延期还不是手拿把掐？&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;/p&gt;&lt;section&gt;&lt;span&gt;&lt;span&gt;•&lt;/span&gt;首先，需要构建一个全局的Timer来存储和调度任务&lt;span&gt;•&lt;/span&gt;其次，在加锁成功之后添加定时触发任务&lt;span&gt;•&lt;/span&gt;再次，延期操作时，需要校验当前线程是否还持有锁&lt;span&gt;•&lt;/span&gt;最后，在解锁时，取消定时任务&lt;span&gt;•&lt;/span&gt;注意点，任务需要循环注册 , 考虑线程被中断的情况&lt;/span&gt;&lt;/section&gt;&lt;p&gt;&lt;/p&gt;&lt;section&gt;&lt;span&gt;构建分布式锁上下文，用于存储全局时间轮调度器:&lt;/span&gt;&lt;/section&gt;&lt;pre&gt;&lt;p&gt;&lt;code&gt;&lt;span&gt;&lt;span&gt;public&lt;/span&gt; &lt;span&gt;class&lt;/span&gt; &lt;span&gt;LockContext&lt;/span&gt; {&lt;br/&gt;&lt;br/&gt;    &lt;span&gt;private&lt;/span&gt; HashedWheelTimer timer;&lt;br/&gt;&lt;br/&gt;    &lt;span&gt;private&lt;/span&gt; &lt;span&gt;LockContext&lt;/span&gt;(){&lt;br/&gt;        &lt;span&gt;//时间轮参数可以从业务自己的配置获取&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;// long tickDuration=(Long) config.get(&quot;tickDuration&quot;);&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;// int tickPerWheel=(int) config.get(&quot;tickPerWheel&quot;); //默认1024&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;// boolean leakDetection=(Boolean)config.get(&quot;leakDetection&quot;);&lt;/span&gt;&lt;br/&gt;        timer = &lt;span&gt;new&lt;/span&gt; &lt;span&gt;HashedWheelTimer&lt;/span&gt;(&lt;span&gt;new&lt;/span&gt; &lt;span&gt;DefaultThreadFactory&lt;/span&gt;(&lt;span&gt;&quot;distributedLock-timer&quot;&lt;/span&gt;,&lt;span&gt;true&lt;/span&gt;), &lt;span&gt;10&lt;/span&gt;, TimeUnit.MILLISECONDS, &lt;span&gt;1024&lt;/span&gt;, &lt;span&gt;false&lt;/span&gt;);&lt;br/&gt;    }&lt;/span&gt;&lt;/code&gt;&lt;/p&gt;&lt;/pre&gt;&lt;section&gt;&lt;span&gt;通过构造函数，将上下文及调度器传入分布式锁对象：&lt;/span&gt;&lt;/section&gt;&lt;pre&gt;&lt;p&gt;&lt;code&gt;&lt;span&gt;&lt;span&gt;public&lt;/span&gt; &lt;span&gt;class&lt;/span&gt; &lt;span&gt;DistributedLock&lt;/span&gt; {&lt;br/&gt;    &lt;span&gt;//上下文&lt;/span&gt;&lt;br/&gt;    &lt;span&gt;private&lt;/span&gt; LockContext context;&lt;br/&gt;    &lt;span&gt;//当前持有的 Timer 调度对象&lt;/span&gt;&lt;br/&gt;    &lt;span&gt;private&lt;/span&gt; &lt;span&gt;volatile&lt;/span&gt; Timeout  lockTimeout;&lt;br/&gt;&lt;br/&gt;    &lt;span&gt;public&lt;/span&gt; &lt;span&gt;DistributedLock&lt;/span&gt;(Jedis jedis, String lockName, String lockOwner, &lt;span&gt;long&lt;/span&gt; lockExpireSecond, &lt;span&gt;long&lt;/span&gt; retryIntervalTime, LockContext context) {&lt;br/&gt;         ...其他属性略&lt;br/&gt;        &lt;span&gt;this&lt;/span&gt;.context = context;&lt;br/&gt;    }&lt;/span&gt;&lt;/code&gt;&lt;/p&gt;&lt;/pre&gt;&lt;section&gt;&lt;span&gt;加锁成功之后，执行调度器注册操作：&lt;/span&gt;&lt;/section&gt;&lt;pre&gt;&lt;p&gt;&lt;code&gt;&lt;span&gt;&lt;span&gt;public&lt;/span&gt; &lt;span&gt;void&lt;/span&gt; &lt;span&gt;lock&lt;/span&gt;(&lt;span&gt;long&lt;/span&gt; timeout, TimeUnit unit) &lt;span&gt;throws&lt;/span&gt; TimeoutException {&lt;br/&gt;    &lt;span&gt;//...加锁 略&lt;/span&gt;&lt;br/&gt;    &lt;br/&gt;   &lt;span&gt;if&lt;/span&gt; (&lt;span&gt;&quot;OK&quot;&lt;/span&gt;.equals(lockResult)) {&lt;br/&gt;       LOGGER.info(&lt;span&gt;&quot;locked success,lockName:{}&quot;&lt;/span&gt;,lockName);&lt;br/&gt;       &lt;span&gt;try&lt;/span&gt; {&lt;br/&gt;           &lt;span&gt;//注册循环延期事件&lt;/span&gt;&lt;br/&gt;           registerLoopReExpire();&lt;br/&gt;       }&lt;span&gt;finally&lt;/span&gt; {&lt;br/&gt;           &lt;span&gt;if&lt;/span&gt; (Thread.currentThread().isInterrupted()&amp;amp;&amp;amp;&lt;span&gt;this&lt;/span&gt;.lockTimeout!=&lt;span&gt;null&lt;/span&gt;){&lt;br/&gt;               LOGGER.warn(&lt;span&gt;&quot;线程中断，定时任务取消&quot;&lt;/span&gt;);&lt;br/&gt;               &lt;span&gt;this&lt;/span&gt;.lockTimeout.cancel();&lt;br/&gt;           }&lt;br/&gt;       }&lt;br/&gt;   } &lt;span&gt;else&lt;/span&gt; {&lt;br/&gt;       &lt;span&gt;throw&lt;/span&gt; &lt;span&gt;new&lt;/span&gt; &lt;span&gt;TimeoutException&lt;/span&gt;(&lt;span&gt;&quot;Get lock failed because of timeout.&quot;&lt;/span&gt;);&lt;br/&gt;    }&lt;br/&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/p&gt;&lt;/pre&gt;&lt;section&gt;&lt;span&gt;方法&lt;/span&gt;&lt;code&gt;&lt;span&gt;registerLoopReExpire()&lt;/span&gt;&lt;/code&gt;&lt;span&gt;中是实际的任务注册和延期操作：&lt;/span&gt;&lt;/section&gt;&lt;pre&gt;&lt;p&gt;&lt;code&gt;&lt;span&gt;&lt;span&gt;private&lt;/span&gt; &lt;span&gt;void&lt;/span&gt; &lt;span&gt;registerLoopReExpire&lt;/span&gt;() {&lt;br/&gt;    LOGGER.info(&lt;span&gt;&quot;分布式锁延期任务注册&quot;&lt;/span&gt;);&lt;br/&gt;&lt;br/&gt;    &lt;span&gt;//每次注册，都把timeout赋给当前锁对象,用于后续解锁时取消&lt;/span&gt;&lt;br/&gt;    &lt;span&gt;this&lt;/span&gt;.lockTimeout = context.getTimer().newTimeout(&lt;span&gt;new&lt;/span&gt; &lt;span&gt;TimerTask&lt;/span&gt;() {&lt;br/&gt;        &lt;span&gt;@Override&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;public&lt;/span&gt; &lt;span&gt;void&lt;/span&gt; &lt;span&gt;run&lt;/span&gt;(Timeout timeout) &lt;span&gt;throws&lt;/span&gt; Exception {&lt;br/&gt;        &lt;br/&gt;            &lt;span&gt;//校验是否还在持有锁，并延长过期时间&lt;/span&gt;&lt;br/&gt;            &lt;span&gt;boolean&lt;/span&gt; isReExpired=reExpireLock(lockName,lockOwner);&lt;br/&gt;        &lt;br/&gt;            &lt;span&gt;if&lt;/span&gt; (isReExpired) {&lt;br/&gt;                &lt;span&gt;//自己调自己，循环注册&lt;/span&gt;&lt;br/&gt;                registerLoopReExpire();&lt;br/&gt;            }&lt;span&gt;else&lt;/span&gt; {&lt;br/&gt;                lockTimeout.cancel();&lt;br/&gt;            }&lt;br/&gt;        }&lt;br/&gt;    }, TimeUnit.SECONDS.toMillis( lockExpireSecond)/&lt;span&gt;2&lt;/span&gt;, TimeUnit.MILLISECONDS);&lt;br/&gt;&lt;br/&gt;    LOGGER.info(&lt;span&gt;&quot;分布式锁延期任务注册完成&quot;&lt;/span&gt;);&lt;br/&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/p&gt;&lt;/pre&gt;&lt;section&gt;&lt;span&gt;这里有几个点需要重点关注：&lt;/span&gt;&lt;/section&gt;&lt;section&gt;&lt;span&gt;•&lt;/span&gt;&lt;code&gt;&lt;span&gt;newTimeout()&lt;/span&gt;&lt;/code&gt;&lt;span&gt;操作会返回一个&lt;/span&gt;&lt;code&gt;&lt;span&gt;Timeout&lt;/span&gt;&lt;/code&gt;&lt;span&gt;实体，我们需要依赖该实体来对当前任务进行管理，所以需要赋值给锁内部对象。&lt;/span&gt;&lt;/section&gt;&lt;section&gt;&lt;span&gt;•&lt;/span&gt;&lt;/section&gt;&lt;section&gt;&lt;span&gt;锁延期，需要根据&lt;/span&gt;&lt;code&gt;&lt;span&gt;lockOwner&lt;/span&gt;&lt;/code&gt;&lt;span&gt; 和 &lt;/span&gt;&lt;code&gt;&lt;span&gt;lockName&lt;/span&gt;&lt;/code&gt;&lt;span&gt;来判断，持有锁才加锁，需要使用&lt;/span&gt;&lt;code&gt;&lt;span&gt;lua&lt;/span&gt;&lt;/code&gt;&lt;span&gt;方式来保证判断和执行的原子性。&lt;/span&gt;&lt;/section&gt;&lt;section&gt;&lt;span&gt;&lt;span&gt;•&lt;/span&gt;执行完延期操作之后，需要根据结果进行后续处理，成功则继续注册，失败则取消当前任务。&lt;span&gt;•&lt;/span&gt;定时任务的执行时间，应该要小于锁的过期时间，取过期时间的&lt;/span&gt;&lt;code&gt;&lt;span&gt;1/2&lt;/span&gt;&lt;/code&gt;&lt;span&gt;或&lt;/span&gt;&lt;code&gt;&lt;span&gt;1/3&lt;/span&gt;&lt;/code&gt;&lt;span&gt;或自定义传入。&lt;/span&gt;&lt;/section&gt;&lt;section&gt;&lt;span&gt;来验证一下，我们设置 锁的过期时间为3秒，业务执行时间为10秒 ，执行：&lt;/span&gt;&lt;/section&gt;&lt;section&gt;&lt;figure data-tool=&quot;mdnice编辑器&quot;&gt;&lt;img class=&quot;rich_pages wxw-img&quot; data-ratio=&quot;0.6524547803617571&quot; data-src=&quot;https://mmbiz.qpic.cn/mmbiz_png/xE6oscyT533CIGonPXeDgc0Vial1lovGCm42ljSPnBpHtWs1cmpCibwCwrxTIqUlKRMiaFuBz5ZDHdQDuxnlxBu7Q/640?wx_fmt=png&quot; data-type=&quot;png&quot; data-w=&quot;774&quot;/&gt;&lt;/figure&gt;&lt;/section&gt;&lt;section&gt;&lt;span&gt;可以看到，定时任务一共延期了6次，最后一次注册成功了，但是业务执行完随着解锁任务取消了。&lt;br/&gt;&lt;/span&gt;&lt;/section&gt;&lt;h2&gt;&lt;strong&gt;&lt;span&gt;总结和回顾&lt;/span&gt;&lt;/strong&gt;&lt;/h2&gt;&lt;section&gt;&lt;span&gt;本文，我们从0到1的对分布式锁进行了编码实现。从基本能力，最后到生产环境的各种诉求基本都进行了填充和完善。&lt;/span&gt;&lt;/section&gt;&lt;section&gt;&lt;span&gt;值得一提的是，除了延期功能，上述大部分能力都是经历过生产环境考验的。大家如果发现了延期功能的实现有什么问题，欢迎留言纠正，一起讨论进步。&lt;/span&gt;&lt;/section&gt;&lt;section&gt;&lt;span&gt;当然，上述内容还有缺失，比如&lt;/span&gt;&lt;code&gt;&lt;span&gt;jedis&lt;/span&gt;&lt;/code&gt;&lt;span&gt; 操作&lt;/span&gt;&lt;code&gt;&lt;span&gt;lua&lt;/span&gt;&lt;/code&gt;&lt;span&gt;脚本的延期实现，可重入锁的改造，由于篇幅原因就不都贴出来了，有兴趣的同学也可以按上述思路继续完善。&lt;/span&gt;&lt;/section&gt;&lt;section&gt;&lt;span&gt;另外，我们的上述实现都是基于主从架构，因此，分布式锁有可能会在主从切换或者其他宕机场景出现异常，但是个人认为，用牺牲效率来保障稳定的redLock，在大部分场景下其实没有什么必要。关于这部分，其实有几个号主讲述的非常到位，可以搜来看看。&lt;/span&gt;&lt;/section&gt;&lt;section&gt;&lt;span&gt;最后，当我们对照redisson的分布式锁实现，来回看我们自己的实现，其实就会发现，在主逻辑上的实现，其实是大同小异的，只是redission的在可重入、效率兼顾(netty架构的运用)等方面要更加完备。&lt;/span&gt;&lt;/section&gt;&lt;section&gt;&lt;span&gt;纸上得来终觉浅~ 共勉~&lt;/span&gt;&lt;/section&gt;&lt;section data-mpa-template=&quot;t&quot; mpa-from-tpl=&quot;t&quot;&gt;&lt;span/&gt;&lt;section mpa-from-tpl=&quot;t&quot;&gt;&lt;p&gt;&lt;span&gt;有道无术，术可成；有术无道，止于术&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;欢迎大家关注&lt;/span&gt;&lt;span&gt;&lt;strong mpa-from-tpl=&quot;t&quot;&gt;Java之道&lt;/strong&gt;&lt;/span&gt;&lt;span&gt;公众号&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;br mpa-from-tpl=&quot;t&quot;/&gt;&lt;/p&gt;&lt;p&gt;&lt;img class=&quot;rich_pages wxw-img&quot; data-copyright=&quot;0&quot; data-ratio=&quot;0.5555555555555556&quot; data-s=&quot;300,640&quot; data-src=&quot;https://mmbiz.qpic.cn/mmbiz_png/1Fk759B8md4yPF1ZAnySd6Xqparsv06tG4FibicFOr7moddq2D3087xicOrF9l54yOVLQkkiaWUBheSzFfibyGMgeug/640?wx_fmt=jpeg&quot; data-type=&quot;jpeg&quot; data-w=&quot;900&quot;/&gt;&lt;/p&gt;&lt;/section&gt;&lt;p&gt;&lt;span&gt;好文章，我&lt;/span&gt;&lt;span&gt;&lt;span&gt;在看&lt;/span&gt;❤️&lt;/span&gt;&lt;/p&gt;&lt;/section&gt;
                &lt;/div&gt;

                

                



                
                &lt;/div&gt;&lt;/div&gt;</content:encoded>
</item>
</channel></rss>