<?xml version="1.0" encoding="UTF-8"?>
        <rss version="2.0" xmlns:content="http://purl.org/rss/1.0/modules/content/">
            <channel>
            <title>开发者头条</title>
            <link>http://toutiao.io/</link>
            <description></description>
<item>
<guid>8d6de898b4e329d86697a3b5779212da</guid>
<title>8 张图带你了解大型应用架构演进历程</title>
<link>https://toutiao.io/k/xuv7rlf</link>
<content:encoded>&lt;div&gt;&lt;div&gt;&lt;section data-tool=&quot;mdnice编辑器&quot; data-website=&quot;https://www.mdnice.com&quot;&gt;&lt;h2 data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span/&gt;&lt;span&gt;前言&lt;/span&gt;&lt;span/&gt;&lt;/h2&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;几乎所有的大型应用都是从一个小应用开始的，好的互联网产品是慢慢运营出来的，不是一开始就开发好的，所以本篇我们来聊聊应用架构的演进历程。&lt;/p&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;如何打造一个高可用，高性能，易扩展的应用？首先我们了解一下大型应用的特点：&lt;/p&gt;&lt;ul data-tool=&quot;mdnice编辑器&quot; class=&quot;list-paddingleft-2&quot;&gt;&lt;li&gt;&lt;section&gt;高可用：系统需要不间断的提供服务，不能出现单点故障&lt;/section&gt;&lt;/li&gt;&lt;li&gt;&lt;section&gt;高并发：在大流量的冲击下，系统依然稳定提供服务&lt;/section&gt;&lt;/li&gt;&lt;li&gt;&lt;section&gt;大数据：应用每天都会产生大量的数据，需要存储和管理好这些数据&lt;/section&gt;&lt;/li&gt;&lt;/ul&gt;&lt;h2 data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span/&gt;&lt;span&gt;最简单的架构&lt;/span&gt;&lt;span/&gt;&lt;/h2&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;刚开始应用没有太多访问量，所以只需要一台服务器，这时候的架构如下图：&lt;/p&gt;&lt;figure data-tool=&quot;mdnice编辑器&quot;&gt;&lt;img data-ratio=&quot;0.49375&quot; data-src=&quot;https://mmbiz.qpic.cn/mmbiz_png/ggRgNal7zGicf6vk3kaemSzAD7bHhK4yQnhRK7RWJs1RJBAsCylY5WYZqKUibUtt1IHr52b7QqeQ7gEsJxiaJSKTQ/640?wx_fmt=png&quot; data-type=&quot;png&quot; data-w=&quot;800&quot;/&gt;&lt;figcaption&gt;&lt;span/&gt;最简单的架构&lt;/figcaption&gt;&lt;/figure&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;应用程序、文件、数据库往往都部署在一台服务器上。应用程序可以采用Java开发，部署在Tomcat服务器上，数据库可以使用开源的MySQL&lt;/p&gt;&lt;h2 data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span/&gt;&lt;span&gt;应用与数据服务分隔&lt;/span&gt;&lt;span/&gt;&lt;/h2&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;随着应用的业务越来越复杂，应用访问量越来越大，导致性能越来越差，存储空间严重不足，这时候我们考虑把服务增加到三台（能通过加机器解决的问题都不是问题）；分离出应用服务器、数据库服务器、文件服务器。&lt;/p&gt;&lt;ul data-tool=&quot;mdnice编辑器&quot; class=&quot;list-paddingleft-2&quot;&gt;&lt;li&gt;&lt;section&gt;应用服务器需要处理大量的访问，所以需要性能更好的CPU&lt;/section&gt;&lt;/li&gt;&lt;li&gt;&lt;section&gt;数据库服务器需要存储大量的数据以及快速的检索，所以需磁盘的检索速度较快以及存储空间大&lt;/section&gt;&lt;/li&gt;&lt;li&gt;&lt;section&gt;文件服务器需要存储上传的文件，需要更大的磁盘；现在通常情况下会选择第三方的存储服务&lt;/section&gt;&lt;/li&gt;&lt;/ul&gt;&lt;figure data-tool=&quot;mdnice编辑器&quot;&gt;&lt;img data-ratio=&quot;0.465&quot; data-src=&quot;https://mmbiz.qpic.cn/mmbiz_png/ggRgNal7zGicf6vk3kaemSzAD7bHhK4yQjQYNRwSLTtGmJU0mqtSiciae0QrC31XdGAtIyNtXeKDq78A5ibKGej99w/640?wx_fmt=png&quot; data-type=&quot;png&quot; data-w=&quot;800&quot;/&gt;&lt;figcaption&gt;&lt;span/&gt;应用与数据访问服务分隔&lt;/figcaption&gt;&lt;/figure&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;根据每个服务器对应的场景，配置服务器后应用的性能能够大大提高，更好的支持业务的发展。但是随之业务的发展，访问量的增大，这种架构又将再次面临挑战，应用服务器处理能力下降，存储空间不足&lt;/p&gt;&lt;h2 data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span/&gt;&lt;span&gt;应用服务器集群&lt;/span&gt;&lt;span/&gt;&lt;/h2&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;在高并发，大流量的情况下，一台服务器是肯定处理不过来的，这个时候增加服务器，部署集群提供服务，来分担每台服务器的压力。部署集群的另一个好处是可伸缩性，比如当遇到了双11大流量的场景下，可以增加服务器分摊流量，等双11过后，减少服务器节约成本。架构如下：&lt;/p&gt;&lt;figure data-tool=&quot;mdnice编辑器&quot;&gt;&lt;img data-ratio=&quot;0.42125&quot; data-src=&quot;https://mmbiz.qpic.cn/mmbiz_png/ggRgNal7zGicf6vk3kaemSzAD7bHhK4yQWicNMqzicoMC1HHaxaz8hU18d75CRCibvX9V1pg3f7UuuicNywX80licbpw/640?wx_fmt=png&quot; data-type=&quot;png&quot; data-w=&quot;800&quot;/&gt;&lt;figcaption&gt;&lt;span/&gt;应用服务器集群&lt;/figcaption&gt;&lt;/figure&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;如果应用服务器是Tomcat，那么可以部署一个Tomcat的集群，外部在部署一个负载均衡器，可以采用随机、轮询或者一致性哈希算法达将用户的请求分发到不同应用服务集群；通常选择的免费的负载均衡是nginx。在这种架构下，应用服务器的负载将不会是整个应用的瓶颈点；&lt;/p&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;虽然应用程序的处理速度在这种架构下提升了许多，但是又会暴露一个问题，数据库的压力大大增大，导致访问响应延迟，影响整个应用的性能。这种架构还有个问题，通常应用是有状态的，需要记录用户的登录信息，如果每次用户的请求都是随机路由到后端的应用服务器，那么用户的会话将会丢失；解决这个问题两个方案：&lt;/p&gt;&lt;ul data-tool=&quot;mdnice编辑器&quot; class=&quot;list-paddingleft-2&quot;&gt;&lt;li&gt;&lt;section&gt;采用一致性hash把用户的请求路由到同一个Tomcat，如果有一台服务器跪了，那么这台服务器上面的用户信息将会丢失&lt;/section&gt;&lt;/li&gt;&lt;li&gt;&lt;section&gt;Tomcat集群之间通过配置session复制，达到共享，此方案效率较低&lt;/section&gt;&lt;/li&gt;&lt;/ul&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;两个方案都不是很好，那么还有其他的方案吗？请继续往下看&lt;/p&gt;&lt;h2 data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span/&gt;&lt;span&gt;缓存&lt;/span&gt;&lt;span/&gt;&lt;/h2&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;根据二八原则，80%的的业务都是集中访问20%的数据，这20%的数据通常称为热点数据，但是这20%的数据占用的内存也不会小，如果每个应用服务器都存放一份，有些浪费存储空间，所以这时候需要考虑加入分布式缓存服务器（常用的是Redis）；当引入了分布式缓存服务器，再来看上面那个方案的问题，就可以解决了，把用户的会话存放到缓存服务器，不仅可以防止用户数据丢失，效率也不低；架构图如下：&lt;/p&gt;&lt;figure data-tool=&quot;mdnice编辑器&quot;&gt;&lt;img data-ratio=&quot;0.52&quot; data-src=&quot;https://mmbiz.qpic.cn/mmbiz_png/ggRgNal7zGicf6vk3kaemSzAD7bHhK4yQPwuUagZ0h3Jz3w7lDgwV8YtoACOZsr2wbTIR9K6x7cHXaib05yNN4nA/640?wx_fmt=png&quot; data-type=&quot;png&quot; data-w=&quot;800&quot;/&gt;&lt;figcaption&gt;&lt;span/&gt;缓存&lt;/figcaption&gt;&lt;/figure&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;由于分布式缓存服务器毕竟存放在远程，需要经过网络，所以取数据还是要花一点时间；本地缓存访问速度更快，但是内存空间有限，并且还会出现和应用程序争抢资源；所以这种架构搭配了分布式缓存和本地缓存，本地缓存存放少量常用热点数据，当本地缓存中没有命中时在去集中式缓存取&lt;/p&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;在引进缓存之后，数据库的访问压力可以的一定的缓解&lt;/p&gt;&lt;h2 data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span/&gt;&lt;span&gt;数据库读写分离&lt;/span&gt;&lt;span/&gt;&lt;/h2&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;虽然在加入了缓存之后，部分数据可以直接走缓存，不需要访问数据库，但是任然会有一些请求，会访问数据库，比如：缓存失效，缓存未命中；当流量大的时候，数据库的访问量也不小。这时候我们需要考虑搭建数据库集群，读写分离&lt;/p&gt;&lt;figure data-tool=&quot;mdnice编辑器&quot;&gt;&lt;img data-ratio=&quot;0.575&quot; data-src=&quot;https://mmbiz.qpic.cn/mmbiz_png/ggRgNal7zGicf6vk3kaemSzAD7bHhK4yQruU99JpAljqiaYjHbZ9KmcCQX4PFdicBuFiaNV6FW9D6ptiaXZBnoEhHXg/640?wx_fmt=png&quot; data-type=&quot;png&quot; data-w=&quot;800&quot;/&gt;&lt;figcaption&gt;&lt;span/&gt;数据库读写分离&lt;/figcaption&gt;&lt;/figure&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;当应用服务器有写操作时，访问主库，当应用程序有读操作时，访问从库；大多数的应用都是读的操作远远大于写的操作，所以可以配置数据库一主多从来分担数据库的压力；为了让应用程序对应主库和从库无感知，通常需要引入一些读写分离的框架做一个统一的数据访问模块。&lt;/p&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;这种架构通常需要警惕的一个问题是主从延迟，当在高并发的场景下，主库刚写成功，数据库还未成功同步完从库，这时候另一个请求进入读取数据发现不存在；解放方案是在应用程序中高并发的场景下设置强制走主库查询&lt;/p&gt;&lt;blockquote data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;❝&lt;/span&gt;&lt;p&gt;兄弟们，请不要白嫖哦，文章看一半，请先点个赞&lt;/p&gt;&lt;span&gt;❞&lt;/span&gt;&lt;/blockquote&gt;&lt;h2 data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span/&gt;&lt;span&gt;反向代理和CDN&lt;/span&gt;&lt;span/&gt;&lt;/h2&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;假如随着业务的不断扩大，全国各地都会使用到我们的应用，由于各地区的网络情况不同，所以有的人请求响应速度快，有的人请求响应速度慢，这会严重的影响到用户的体验。为了提高响应速度需要引入反向代理和CDN；CDN和反向代理都是采用的缓存，目的：&lt;/p&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;架构图如下：&lt;/p&gt;&lt;figure data-tool=&quot;mdnice编辑器&quot;&gt;&lt;img data-ratio=&quot;0.50125&quot; data-src=&quot;https://mmbiz.qpic.cn/mmbiz_png/ggRgNal7zGicf6vk3kaemSzAD7bHhK4yQ9r7nTCb9u4zPRzhvmxmDqBx82gUT6NzlAJuqvfZWTRXTgFicV2GOibiaQ/640?wx_fmt=png&quot; data-type=&quot;png&quot; data-w=&quot;800&quot;/&gt;&lt;figcaption&gt;&lt;span/&gt;反向代理和CDN&lt;/figcaption&gt;&lt;/figure&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;CDN: 部署在网络提供商的机房，当用户来访问的时候，从距离用户最近的服务器返回数据，尽快呈现给用户；通常情况下在CDN中缓存的是静态资源（html,js,css），达到动静分离；但是有时候遇到了某些数据访问量特别大的时候，后端会生成静态资源放入到CDN，比如：商城的首页，每个用户进入都需要访问的页面，如果每次请求都进入到后端，那么服务器的压力肯定不小，这种情况下会把首页生成静态的文件缓存到cdn和反向代理服务器&lt;/p&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;反向代理：部署在应用的中心机房，通常也是缓存的静态资源，当用户通过CDN未请求到需要的数据时，先进入反向代理服务器，如果有缓存用户访问的数据，那么直接返回给用户；这里也有特殊情况，对于有些场景下的热点数据，在这里根据用户的请求去分布式缓存服务器中获取，能拿到就直接返回。&lt;/p&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;这种架构已经把缓存做到了4级&lt;/p&gt;&lt;ul data-tool=&quot;mdnice编辑器&quot; class=&quot;list-paddingleft-2&quot;&gt;&lt;li&gt;&lt;section&gt;第一级：CDN 缓存静态资源&lt;/section&gt;&lt;/li&gt;&lt;li&gt;&lt;section&gt;第二级：反向代理缓存静态资源以及部分热点数据&lt;/section&gt;&lt;/li&gt;&lt;li&gt;&lt;section&gt;第三级：应用服务器的本地缓存&lt;/section&gt;&lt;/li&gt;&lt;li&gt;&lt;section&gt;第四级：分布式缓存服务器&lt;/section&gt;&lt;/li&gt;&lt;/ul&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;通常情况下经过了这4级缓存，能够进入到数据库的请求也不多了，很好的释放了数据库的压力&lt;/p&gt;&lt;h2 data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span/&gt;&lt;span&gt;搜索引擎和NoSQL&lt;/span&gt;&lt;span/&gt;&lt;/h2&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;随着业务的不断扩大，对于数据的存储和查询的需求也越来越复杂，通常情况我们需要引入非关系型数据库，比如搜索引擎和NoSQL数据库&lt;/p&gt;&lt;figure data-tool=&quot;mdnice编辑器&quot;&gt;&lt;img data-ratio=&quot;0.60375&quot; data-src=&quot;https://mmbiz.qpic.cn/mmbiz_png/ggRgNal7zGicf6vk3kaemSzAD7bHhK4yQ6Wcj8ynjq3PjCVPKib7Q7YanbrbdsicibgYIViaKB2tz0xDGI9lf8fFrUg/640?wx_fmt=png&quot; data-type=&quot;png&quot; data-w=&quot;800&quot;/&gt;&lt;figcaption&gt;&lt;span/&gt;搜索引擎和NoSQL&lt;/figcaption&gt;&lt;/figure&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;有时候我们的查询场景很复杂，需要查询很多数据表，经过一系列的计算才能完成，这时候可以考虑通过数据同步工具（比如canal）拉去数据到大数据平台，使用批处理框架离线计算，把输出的结果存放到搜索引擎或者NoSQL数据库中，应用程序直接查询计算的结果返回给用户。也有可能我们需要汇总多个表的数据做一张宽表，方便应用程序查询&lt;/p&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;由于引入的数据存储方式增多，为了减轻应用程序的管理多个数据源的麻烦，需要封装统一数据访问模块，如果使用的时Java，可以考虑spring-data&lt;/p&gt;&lt;h2 data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span/&gt;&lt;span&gt;业务纵向拆分&lt;/span&gt;&lt;span/&gt;&lt;/h2&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;互联网公司通常的宗旨是小步迭代试错快跑，当业务发展到足够大，对于单体应用想要达到这个宗旨是有难度的，随着业务的发展，应用程序越来越大，研发、维护、发布的成本也越来越大，这时候就需要考虑根据业务把单体应用拆分为多个服务，服务之间可以通过RPC远程调用和消息队列来一起完成用户的请求。&lt;/p&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;由于业务的拆分，通常情况下也会相应的对数据库进行拆分，达到一个服务对应一个数据库的理想状态&lt;/p&gt;&lt;figure data-tool=&quot;mdnice编辑器&quot;&gt;&lt;img data-ratio=&quot;0.6025&quot; data-src=&quot;https://mmbiz.qpic.cn/mmbiz_png/ggRgNal7zGicf6vk3kaemSzAD7bHhK4yQ9uwLFeiafJtWW25fVEcQlibwTYtqGO7IiaQNNNjXZh9PHgInmg234BQbg/640?wx_fmt=png&quot; data-type=&quot;png&quot; data-w=&quot;800&quot;/&gt;&lt;figcaption&gt;&lt;span/&gt;业务纵向拆分&lt;/figcaption&gt;&lt;/figure&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;引入MQ的好处：&lt;/p&gt;&lt;ul data-tool=&quot;mdnice编辑器&quot; class=&quot;list-paddingleft-2&quot;&gt;&lt;li&gt;&lt;section&gt;提高系统的可用性：当消费服务器发送故障时，消息还在消息队列中，数据不会丢失&lt;/section&gt;&lt;/li&gt;&lt;li&gt;&lt;section&gt;加快请求的响应：当用户请求到达服务器后，把请求中可以异步处理的数据放入到MQ，让系统逐一消费，不需要用户等待，加快了响应速度&lt;/section&gt;&lt;/li&gt;&lt;li&gt;&lt;section&gt;削峰填谷：当大量请求都同时进入到系统之后，会全部放入到消息队列，系统逐一消费，不会对系统造成很大的冲击&lt;/section&gt;&lt;/li&gt;&lt;/ul&gt;&lt;h2 data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span/&gt;&lt;span&gt;总结&lt;/span&gt;&lt;span/&gt;&lt;/h2&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;还有一个情况未谈及到，就是数据库的水平拆分，这也是数据库拆分的最后手段，只有当单表数据特别大，不能满足业务的需要才使用。使用最多的还是进行数据库的业务纵向拆分，把数据库中不同业务的数据放到不同的物理服务器上。&lt;/p&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;应用当前到底选择什么架构，一定要根据实际业务的需求进行灵活的选择，驱动技术架构发展的主要动力还是在于业务的发展，不要为了技术而技术。&lt;/p&gt;&lt;h2 data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span/&gt;&lt;span&gt;写在最后&lt;/span&gt;&lt;span/&gt;&lt;/h2&gt;&lt;ul data-tool=&quot;mdnice编辑器&quot; class=&quot;list-paddingleft-2&quot;&gt;&lt;li&gt;&lt;section&gt;首先感谢大家可以耐心地读到这里。&lt;/section&gt;&lt;/li&gt;&lt;li&gt;&lt;section&gt;当然，文中或许会存在或多或少的不足、错误之处，有建议或者意见也非常欢迎大家在评论交流。&lt;/section&gt;&lt;/li&gt;&lt;li&gt;&lt;section&gt;最后，&lt;strong&gt;「白嫖不好，创作不易」&lt;/strong&gt;，希望朋友们可以&lt;strong&gt;「点赞」&lt;/strong&gt;，因为这些就是我分享的全部动力来源🙏&lt;/section&gt;&lt;/li&gt;&lt;/ul&gt;&lt;/section&gt;
                &lt;/div&gt;&lt;/div&gt;</content:encoded>
</item>
<item>
<guid>105bc61cec691c7852618215c045a7ea</guid>
<title>[译] Offer 薪资不如预期？你或许需要薪酬谈判服务</title>
<link>https://toutiao.io/k/f7fdiw9</link>
<content:encoded>&lt;div&gt;&lt;div&gt;&lt;div class=&quot;rich_media_content &quot; id=&quot;js_content&quot;&gt;
                    

                    
                    
                    
                    &lt;p data-mpa-powered-by=&quot;yiban.io&quot;&gt;&lt;/p&gt;&lt;p&gt;&lt;img class=&quot;rich_pages js_insertlocalimg&quot; data-backh=&quot;385&quot; data-backw=&quot;578&quot; data-ratio=&quot;0.6657142857142857&quot; data-s=&quot;300,640&quot; data-src=&quot;https://mmbiz.qpic.cn/mmbiz_jpg/la8s6uvJibdRQ0LtmjOBzJFMxKxOebm3xsMiaMqgsC8EDETJnG3nfluJMYSJNNs8JohyibgLlVQTswnERNNnDYp8Q/640?wx_fmt=jpeg&quot; data-type=&quot;jpeg&quot; data-w=&quot;700&quot;/&gt;&lt;/p&gt;&lt;section&gt;&lt;span&gt;Photo by Peggy Anke on Unsplash&lt;/span&gt;&lt;/section&gt;&lt;p&gt;&lt;span&gt;作者：&lt;/span&gt;&lt;span&gt;Daniel Biales&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;译者：安顶山下&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;原文：&lt;/span&gt;&lt;span&gt;https://levelup.gitconnected.com/learn-how-to-negotiate-your-salary-with-expert-help-5afedd11a178&lt;/span&gt;&lt;/p&gt;&lt;section&gt;&lt;span&gt;好不容易拿到了一个不错的 &lt;/span&gt;&lt;span&gt;Offer&lt;/span&gt;&lt;span&gt;，&lt;/span&gt;&lt;span&gt;HR &lt;/span&gt;&lt;span&gt;问你期望薪酬，你却不知道怎么开口？或者支支吾吾了半天，不好意思说了&lt;span&gt;一个&lt;/span&gt;很泛的区间？或者想当然地自抬身价，报个虚高的数字？&lt;/span&gt;&lt;br/&gt;&lt;/section&gt;&lt;section&gt;&lt;span/&gt;&lt;/section&gt;&lt;section&gt;&lt;span&gt;今天分享 &lt;/span&gt;&lt;span&gt;Daniel Biales&lt;/span&gt; &lt;span&gt;的经验，他在薪资谈判专家的帮助下，科学地准备面试和&lt;span&gt;薪资谈判&lt;/span&gt;，最终拿下梦想的 &lt;/span&gt;&lt;span&gt;Google&lt;/span&gt;&lt;span&gt; &lt;/span&gt;&lt;span&gt;Offer&lt;/span&gt;&lt;span&gt;，年薪涨了&lt;/span&gt; &lt;span&gt;3.5&lt;/span&gt;&lt;span&gt; 万美元以上。&lt;/span&gt;&lt;/section&gt;&lt;section&gt;&lt;span&gt;从另一个方面来说，薪酬谈判作为一项服务，目前在国内还仅仅局限在猎头机构中。更准确的说，是少数好的猎头机构才能提供，而且往往是在候选人拿到 &lt;/span&gt;&lt;span&gt;Offer&lt;/span&gt;&lt;span&gt; 后才介入，其实作用已经不是很大了。如何提供个性化的薪酬谈判服务，让候选人觉得满意，让招聘方觉得不是漫天要价？这是一个有意思的问题。&lt;br/&gt;&lt;/span&gt;&lt;/section&gt;&lt;p&gt;&lt;span&gt;或许本篇文章有一些启示。以下是他的分享， &lt;/span&gt;&lt;span&gt;Enjoy&lt;/span&gt;&lt;span&gt; ~&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;&lt;br mpa-from-tpl=&quot;t&quot;/&gt;&lt;/span&gt;&lt;/p&gt;&lt;section data-mpa-template=&quot;t&quot; mpa-from-tpl=&quot;t&quot;&gt;&lt;section data-mid=&quot;&quot; mpa-from-tpl=&quot;t&quot;&gt;&lt;section data-mid=&quot;&quot; mpa-from-tpl=&quot;t&quot;&gt;&lt;section data-mid=&quot;&quot; mpa-from-tpl=&quot;t&quot;&gt;&lt;img data-ratio=&quot;0.06206896551724138&quot; data-src=&quot;https://mmbiz.qpic.cn/mmbiz_png/soSiaOAXKsnPBA5zOd8RoLRU0xQhVBCibjzJfMPTJSJbh9kZPAMtyO8Dy5Kb5ueN36mYtfI5pfpibNtHvjqicmWl3A/640?wx_fmt=png&quot; data-type=&quot;png&quot; data-w=&quot;290&quot;/&gt;&lt;/section&gt;&lt;/section&gt;&lt;/section&gt;&lt;/section&gt;&lt;p&gt;&lt;/p&gt;&lt;section&gt;&lt;strong&gt;&lt;em&gt;&lt;span&gt;免责声明&lt;/span&gt;&lt;/em&gt;&lt;/strong&gt;&lt;em&gt;&lt;span&gt;：我想澄清一点，&lt;em&gt;除了是&lt;em&gt;&lt;span&gt; interviewing.io&lt;/span&gt; 网站的&lt;/em&gt;一个&lt;/em&gt;满意客户，我与 &lt;/span&gt;&lt;span&gt;interviewing.io&lt;/span&gt;&lt;span&gt; 网站再无任何瓜葛。为了获得网站提供的服务，我已全额付费，写这篇文章&lt;em&gt;&lt;span&gt;我并没有收取任何回扣&lt;/span&gt;&lt;/em&gt;。我甚至没有公布我的推荐码，所以你该知道我没有从这篇文章中捞到任何好处。&lt;/span&gt;&lt;/em&gt;&lt;/section&gt;&lt;section&gt;&lt;span&gt;首先，我会告诉你我使用 “薪资谈判包（&lt;/span&gt;&lt;span&gt;Salary negotiation package&lt;/span&gt;&lt;span&gt;）” 的经历。然后，我会详细分析这项服务的利弊。再接下来，我会分享一些经验教训。最后，我会让你知道我是否会再次使用这项服务。&lt;/span&gt;&lt;/section&gt;&lt;h1 data-selectable-paragraph=&quot;&quot;&gt;&lt;span&gt;目录&lt;/span&gt;&lt;br/&gt;&lt;/h1&gt;&lt;ul class=&quot;list-paddingleft-2&quot;&gt;&lt;li&gt;&lt;section&gt;&lt;span&gt;薪资谈判经历&lt;/span&gt;&lt;/section&gt;&lt;/li&gt;&lt;li&gt;&lt;p&gt;&lt;span&gt;服务的优点&lt;/span&gt;&lt;/p&gt;&lt;/li&gt;&lt;li&gt;&lt;p&gt;&lt;span&gt;服务的缺点&lt;/span&gt;&lt;/p&gt;&lt;/li&gt;&lt;li&gt;&lt;p&gt;&lt;span&gt;我学到的3个技巧&lt;/span&gt;&lt;/p&gt;&lt;/li&gt;&lt;li&gt;&lt;p&gt;&lt;span&gt;我会成为回头客吗？&lt;/span&gt;&lt;/p&gt;&lt;/li&gt;&lt;/ul&gt;&lt;section&gt;&lt;strong&gt;&lt;span&gt;薪资谈判经历&lt;/span&gt;&lt;/strong&gt;&lt;br/&gt;&lt;/section&gt;&lt;h2 data-selectable-paragraph=&quot;&quot;&gt;&lt;span&gt;&lt;strong&gt;会见专家&lt;/strong&gt;&lt;/span&gt;&lt;/h2&gt;&lt;p&gt;&lt;span&gt;在我找工作的最后两个月，我发现 &lt;/span&gt;&lt;span&gt;interviewing.io&lt;/span&gt;&lt;span&gt; 提供了技术职位的薪资谈判服务。网站声称，薪资谈判是一种服务，你可以通过该服务：&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;&lt;span&gt;“ &lt;/span&gt;&lt;span&gt;与薪资谈判专家合作，他会告诉你在什么时候该说些什么。[他们] 保证你收到的 &lt;/span&gt;&lt;/span&gt;&lt;span&gt;Offer &lt;/span&gt;&lt;span&gt;&lt;span&gt;薪资现金部分至少涨 1 万美元，否则你可以分文不付。&lt;/span&gt;&lt;span&gt;”&lt;/span&gt;&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;这项服务需花费 &lt;/span&gt;&lt;span&gt;2000&lt;/span&gt;&lt;span&gt; 美元，但似乎是值得的。&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;“我听说可以通过薪资谈判来提高薪水，但我从未试过。所以我注册了这项服务来学习如何进行薪资谈判。”  我一注册完，立即就接到了来自&lt;span&gt; &lt;/span&gt;&lt;span&gt;interviewing.io &lt;/span&gt;网站&lt;span&gt; &lt;/span&gt;&lt;/span&gt;&lt;span&gt;CEO Aline Lerner&lt;/span&gt;&lt;span&gt; 的电话。她正在测试 &lt;/span&gt;&lt;span&gt;beta &lt;/span&gt;&lt;span&gt;版，为的是能更好地确定产品边界并了解未来谈判顾问所需的技能。她打这个电话是为了确定我是否是&lt;span&gt; &lt;/span&gt;&lt;span&gt;beta &lt;/span&gt;&lt;span&gt;版服务&lt;/span&gt;的合适人选，以及确认他们是否能帮得上忙。&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;当时，我已经收到了两个正式 &lt;/span&gt;&lt;span&gt;Offer&lt;/span&gt;&lt;span&gt;，还有一个准 &lt;/span&gt;&lt;span&gt;Offer&lt;/span&gt;&lt;span&gt;，还有几个马上要进行的&lt;span&gt;最后一轮面试&lt;/span&gt;。综合考虑我的背景和情况，&lt;span&gt;Aline&lt;/span&gt; 说我是该 &lt;span&gt;beta &lt;/span&gt;&lt;span&gt;版功能的&lt;/span&gt;理想人选。&lt;/span&gt;&lt;/p&gt;&lt;section&gt;&lt;span&gt;在我们的下一个电话中，&lt;span&gt;Aline&lt;/span&gt; 首先提供了一些有关如何与招聘人员互动的常用建议。这是为了确保在薪资谈判开始前，不要让我自己处于不利地位。我们一起过了一遍我拿到的每一个 &lt;span&gt;Offer&lt;/span&gt;，讨论了细节，并制定了一个总体计划。我们确定这时开启薪资谈判还为时过早。&lt;span&gt;Aline&lt;/span&gt;&lt;span&gt; 希望&lt;/span&gt;等我收到已有 &lt;/span&gt;&lt;span&gt;Offer&lt;/span&gt;&lt;span&gt; 的更多详细信息，并完成其中一个下周进行的最后一轮面试后，再开始薪资谈判。她主动提出要帮助我，确保我的 &lt;span&gt;Offer&lt;/span&gt;&lt;span&gt; 不过期失效&lt;/span&gt;。幸运的是，这些 &lt;span&gt;Offer&lt;/span&gt;&lt;span&gt; &lt;/span&gt;没有任何截止日期。我们决定在接下来一周内开始启动薪资谈判计划，但她也说了，如果有什么事我们可以早点见面。&lt;/span&gt;&lt;/section&gt;&lt;h2 data-selectable-paragraph=&quot;&quot;&gt;&lt;span&gt;&lt;strong&gt;最后一轮面试和 &lt;/strong&gt;&lt;/span&gt;&lt;strong&gt;&lt;span&gt;Offer&lt;/span&gt;&lt;/strong&gt;&lt;/h2&gt;&lt;section&gt;&lt;span&gt;在接下来的&lt;/span&gt;&lt;span&gt;几周里，我和 &lt;/span&gt;&lt;span&gt;Aline&lt;/span&gt;&lt;span&gt; &lt;/span&gt;&lt;span&gt;每周都见面，同时也会在邮件中交流一些重要事件。&lt;/span&gt;&lt;span&gt;这期间最重要的事件有：&lt;/span&gt;&lt;br/&gt;&lt;/section&gt;&lt;section&gt;&lt;span&gt;在这个阶段，&lt;span&gt;Aline&lt;/span&gt; 通过提供免费的 &lt;span&gt;interviewing.io&lt;/span&gt; 模拟面试来帮助我。我安排了一个 &lt;/span&gt;&lt;span&gt;Facebook &lt;/span&gt;&lt;span&gt;技术模拟面试和一个&lt;/span&gt; &lt;span&gt;Facebook&lt;/span&gt;&lt;span&gt; 系统设计模拟面试。我们还想出了如何在&lt;span&gt;不开始正式谈判的情况下&lt;/span&gt;让我第三个 &lt;/span&gt;&lt;span&gt;Offe&lt;/span&gt;&lt;span&gt;r 涨薪的办法。同样，我们计划一周后再见面，并且我会将面试的进展及时同步给 &lt;/span&gt;&lt;span&gt;Aline&lt;/span&gt;&lt;span&gt;。在接下来的一周，发生了很多事情。&lt;/span&gt;&lt;/section&gt;&lt;ul class=&quot;list-paddingleft-2&quot;&gt;&lt;li&gt;&lt;p&gt;&lt;span&gt;我完成了所有的面试&lt;/span&gt;&lt;/p&gt;&lt;/li&gt;&lt;li&gt;&lt;p&gt;&lt;span&gt;我收到了薪资最高的 &lt;/span&gt;&lt;span&gt;Offer&lt;/span&gt;&lt;/p&gt;&lt;/li&gt;&lt;li&gt;&lt;p&gt;&lt;span&gt;我的第三个 &lt;/span&gt;&lt;span&gt;Offer&lt;/span&gt;&lt;span&gt; &lt;span&gt;薪资&lt;/span&gt;提高了&lt;br/&gt;&lt;/span&gt;&lt;/p&gt;&lt;/li&gt;&lt;li&gt;&lt;p&gt;&lt;span&gt;我收到了 &lt;/span&gt;&lt;span&gt;Google&lt;/span&gt;&lt;span&gt; 的 &lt;/span&gt;&lt;span&gt;Offer&lt;/span&gt;&lt;/p&gt;&lt;/li&gt;&lt;li&gt;&lt;p&gt;&lt;span&gt;我的其中一个 &lt;/span&gt;&lt;span&gt;Offer&lt;/span&gt;&lt;span&gt; 被设定了最后期限&lt;/span&gt;&lt;/p&gt;&lt;/li&gt;&lt;/ul&gt;&lt;h2&gt;&lt;span&gt;&lt;strong&gt;最后的步骤&lt;/strong&gt;&lt;/span&gt;&lt;/h2&gt;&lt;p&gt;&lt;span&gt;在这个阶段，我处于有利地位。我有 &lt;/span&gt;&lt;span&gt;5&lt;/span&gt;&lt;span&gt; 个 正在考虑的 &lt;/span&gt;&lt;span&gt;Offer&lt;/span&gt;&lt;span&gt;。下次我和&lt;/span&gt;&lt;span&gt; Aline &lt;/span&gt;&lt;span&gt;沟通时&lt;/span&gt;&lt;span&gt;，我们首先讨论了我的选择喜好。有很多机会让我兴奋不已，但我还是列了一个排名清单。接下来我们讨论的是“谈判策略”。这包括为每个 &lt;/span&gt;&lt;span&gt;Offer &lt;/span&gt;&lt;span&gt;提出涨薪方案，确定哪些是现实可行的，并最终决定我们要提出的要求。我们讨论了计划和预期的结果。接下来，是时候将这个计划付诸行动了！&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;img class=&quot;rich_pages js_insertlocalimg&quot; data-backh=&quot;386&quot; data-backw=&quot;578&quot; data-ratio=&quot;0.6671428571428571&quot; data-s=&quot;300,640&quot; data-src=&quot;https://mmbiz.qpic.cn/mmbiz_jpg/la8s6uvJibdTDiahbW85Bl1PdL4mtSWBLqHgxbGOoJIsrVXicj3UTiauHe5pENugDLACAnLXCKEacqpt1knYrt2ZHw/640?wx_fmt=jpeg&quot; data-type=&quot;jpeg&quot; data-w=&quot;700&quot;/&gt;&lt;/p&gt;&lt;section&gt;&lt;span&gt;Photo by &lt;/span&gt;&lt;span&gt;Scott Graham&lt;/span&gt;&lt;span&gt; on &lt;/span&gt;&lt;span&gt;Unsplash&lt;/span&gt;&lt;/section&gt;&lt;section&gt;&lt;span&gt;我开始与我的首选 &lt;/span&gt;&lt;span&gt;Offer&lt;/span&gt;&lt;span&gt; 商谈。在大多数情况下，一切都如预期进行。但也会有一些意外情况，好在 &lt;span&gt;Aline&lt;/span&gt; 在必要时帮我及时调整了策略。特别是在最后，当事情变得更难处理的时候，&lt;span&gt;Aline&lt;/span&gt; 的帮助尤其有用。她向我保证，事情仍在正确的轨道上，即使是最坏的情况也不会太差。&lt;/span&gt;&lt;/section&gt;&lt;h2&gt;&lt;span&gt;&lt;strong&gt;结果&lt;/strong&gt;&lt;/span&gt;&lt;/h2&gt;&lt;p&gt;&lt;span&gt;最后，我感到非常高兴。我签了 &lt;/span&gt;&lt;span&gt;Google&lt;/span&gt;&lt;span&gt; 的 &lt;/span&gt;&lt;span&gt;Offer&lt;/span&gt;&lt;span&gt;，这已经超出了我的薪酬预期。在&lt;/span&gt;&lt;span&gt;Aline &lt;/span&gt;&lt;span&gt;的帮助下，我的 &lt;/span&gt;&lt;span&gt;Offer&lt;/span&gt;&lt;span&gt; 报价提高了 &lt;/span&gt;&lt;span&gt;3.5&lt;/span&gt;&lt;span&gt; 万美元，提升幅度超过了 &lt;/span&gt;&lt;span&gt;15% &lt;/span&gt;&lt;span&gt;！&lt;/span&gt;&lt;/p&gt;&lt;h1&gt;&lt;strong&gt;&lt;span&gt;服务的优点&lt;/span&gt;&lt;/strong&gt;&lt;/h1&gt;&lt;p&gt;&lt;strong&gt;&lt;span&gt;学&lt;/span&gt;&lt;span&gt;习 &lt;/span&gt;&lt;/strong&gt;&lt;span&gt;&lt;span&gt;&lt;strong&gt;&lt;span&gt;—&lt;/span&gt;&lt;/strong&gt;&lt;/span&gt;&lt;/span&gt;&lt;span&gt; 我购买这项服务的主要原因之一是学习如何进行薪酬谈判。&lt;/span&gt;&lt;span&gt;包括学习薪资谈判的&lt;/span&gt;&lt;span&gt;策略和技巧。由于&lt;/span&gt;&lt;span&gt;我和专家一起工作，因此我可以有机会问些额外的问题。&lt;/span&gt;&lt;span&gt;在与招聘人员互动后，我给 &lt;span&gt;Aline &lt;/span&gt;发了一封邮件，邮件中总结了这次互动。&lt;/span&gt;&lt;span&gt;我问她是否可以做些什么来改善和招聘人员之间的互动。&lt;/span&gt;&lt;span&gt;我还提了一些假设的问题。&lt;/span&gt;&lt;span&gt;这些问题可以帮助我了解，在不同情况下我该怎么去应对问题。&lt;/span&gt;&lt;span&gt;这不仅帮助我提高了目前的 &lt;/span&gt;&lt;span&gt;Offer &lt;/span&gt;&lt;span&gt;报价，还教会了我将来进行谈判时该怎么做。&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;strong&gt;&lt;span&gt;信心 &lt;/span&gt;&lt;/strong&gt;&lt;span&gt;&lt;span&gt;&lt;span&gt;&lt;strong&gt;&lt;span&gt;—&lt;/span&gt;&lt;/strong&gt; &lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span&gt;在很多情况下，我的直觉告诉我该怎么做是好的。这意味着我比自己想象的要更了解薪酬谈判。但是，如果没有 &lt;span&gt;i&lt;/span&gt;&lt;span&gt;nterviewing.io&lt;/span&gt; 的薪资谈判服务，我会怀疑自己，永远想知道自己到底有没有做对。和专家一起工作，消除了自我怀疑，并纠正了我直觉错误的地方。&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;strong&gt;&lt;span&gt;缓解压力 — &lt;/span&gt;&lt;/strong&gt;&lt;span&gt;选择一份新工作总是有压力的。在此过程中能得到一些支持，感觉很棒。当事情进展顺利时，&lt;/span&gt;&lt;span&gt;Aline&lt;/span&gt;&lt;span&gt;&lt;span&gt; &lt;/span&gt;会祝贺我；当出现不确定情况时，&lt;span&gt;Aline&lt;/span&gt; 会让我安心；当事情进展不顺利时，&lt;span&gt;Aline&lt;/span&gt; 会鼓励我；当我评估自己的选择时，&lt;span&gt;Aline&lt;/span&gt; 则会提供很多信息。在你做出改变一生的决定时，有这样一个人在你身边真是太好了。&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;img class=&quot;rich_pages js_insertlocalimg&quot; data-backh=&quot;333&quot; data-backw=&quot;500&quot; data-ratio=&quot;0.666&quot; data-s=&quot;300,640&quot; data-src=&quot;https://mmbiz.qpic.cn/mmbiz_jpg/la8s6uvJibdTDiahbW85Bl1PdL4mtSWBLqiaAQnHL6c5Eo3mm3cU2bM0EIw0RbcR3iaWWscpX1M1ibYaibOAicGlJhkhA/640?wx_fmt=jpeg&quot; data-type=&quot;jpeg&quot; data-w=&quot;500&quot;/&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;Photo by&lt;/span&gt;&lt;span&gt; JESHOOTS.COM&lt;/span&gt;&lt;span&gt; on &lt;/span&gt;&lt;span&gt;Unsplash&lt;/span&gt;&lt;/p&gt;&lt;section&gt;&lt;strong&gt;&lt;span&gt;个性化 &lt;/span&gt;&lt;/strong&gt;&lt;strong&gt;&lt;span&gt;—&lt;/span&gt;&lt;/strong&gt; &lt;span&gt;服务的个性化是其最大的特色。&lt;span&gt;Aline&lt;/span&gt; 告诉我的第一件事是她会帮助我拿到我想要的结果。如果我想为薪水最少的公司工作，那么她会帮助我尽可能地提高薪水。在 &lt;/span&gt;&lt;span&gt;Offer &lt;/span&gt;&lt;span&gt;之间做抉择让我感到没有丝毫的压力。&lt;br/&gt;&lt;/span&gt;&lt;/section&gt;&lt;p&gt;&lt;span&gt;在制定策略时，&lt;/span&gt;&lt;span&gt;Aline&lt;/span&gt;&lt;span&gt; 根据我的时间安排制定了计划。&lt;/span&gt;&lt;span&gt;Aline&lt;/span&gt;&lt;span&gt; 明确表示，这是一种理想的策略，但是如果我对计划的任何部分不满意，我们也可以进行调整。&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;另外，我个人所处的实际情况，最终决定了 &lt;span&gt;Aline&lt;/span&gt; 给我的建议。这比你自己阅读 &lt;/span&gt;&lt;span&gt;Medium&lt;/span&gt;&lt;span&gt; （&lt;/span&gt;&lt;span&gt;&lt;span&gt;注：国外著名的专注于写作与阅读的平台，其上有很多高质量的内容。创始人是前 &lt;/span&gt;&lt;span&gt;Twitter&lt;/span&gt;&lt;span&gt; 创始人，目前需科学上网才能访问&lt;/span&gt;&lt;/span&gt;&lt;span&gt;）文章得到的建议要有用得多。&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;strong&gt;&lt;span&gt;服务的缺点&lt;/span&gt;&lt;/strong&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;在撰写本节时，我想起了面试官问的一个问题：&lt;/span&gt;&lt;span&gt;“你最大的缺点是什么？&lt;/span&gt;&lt;span&gt;” 回答的时候，大多数弱点到头来都反而凸显了更多的优点。&lt;/span&gt;&lt;span&gt;但是，在使用 “薪资谈判服务”之前，有几件事你应该考虑一下。&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;strong&gt;&lt;span&gt;时间&lt;strong&gt;&lt;span&gt; &lt;/span&gt;&lt;/strong&gt;&lt;strong&gt;&lt;span&gt;—&lt;/span&gt;&lt;/strong&gt; &lt;/span&gt;&lt;/strong&gt;&lt;span&gt;和专家一起工作确实需要花费时间。它给本已很耗时的面试流程又增加了额外的任务。不过，当我和 &lt;/span&gt;&lt;span&gt;Aline&lt;/span&gt;&lt;span&gt; 合作时，她却非常灵活。所有会议都是在 “根据需要” 的基础上进行的。她回复邮件的速度非常迅速，给我打电话的时间也很灵活。我从来没有任何时间安排上的问题，也不存在与 &lt;/span&gt;&lt;span&gt;Aline &lt;/span&gt;&lt;span&gt;沟通上的问题。&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;strong&gt;&lt;span&gt;成本 —&lt;/span&gt;&lt;span&gt;&lt;span&gt; &lt;/span&gt;&lt;/span&gt;&lt;/strong&gt;&lt;span&gt;这项服务并不便宜。&lt;/span&gt;&lt;span&gt;2000 &lt;/span&gt;&lt;span&gt;美元&lt;/span&gt;&lt;span&gt;是&lt;/span&gt;&lt;span&gt;一笔&lt;/span&gt;&lt;span&gt;不小的支出，尽管与你收到的 &lt;/span&gt;&lt;span&gt;Offer &lt;/span&gt;&lt;span&gt;相比，这并&lt;/span&gt;&lt;span&gt;不&lt;/span&gt;&lt;span&gt;算多。&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;一开始，我认为 &lt;/span&gt;&lt;span&gt;2000&lt;/span&gt;&lt;span&gt; 美元是一个合理的价格。当服务结束时，我觉得这是此生难遇的好事。在短期内，我获得了 &lt;/span&gt;&lt;span&gt;18&lt;/span&gt;&lt;span&gt; 倍以上的投资回报率。我在新工作中只需不到三周的时间就可以收支平衡。从长远来看，&lt;span&gt;在我后续的职业&lt;/span&gt;&lt;span&gt;生&lt;/span&gt;&lt;span&gt;涯中，&lt;/span&gt;我的薪水只会更高。&lt;/span&gt;&lt;span/&gt;&lt;/p&gt;&lt;p&gt;&lt;img class=&quot;rich_pages js_insertlocalimg&quot; data-backh=&quot;750&quot; data-backw=&quot;500&quot; data-ratio=&quot;1.5&quot; data-s=&quot;300,640&quot; data-src=&quot;https://mmbiz.qpic.cn/mmbiz_jpg/la8s6uvJibdTDiahbW85Bl1PdL4mtSWBLqNIbaTz6MmCBsdlJqTcdmPZzqBIlbRVyrmBexQibarefo69kliaMjko9w/640?wx_fmt=jpeg&quot; data-type=&quot;jpeg&quot; data-w=&quot;500&quot;/&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;Photo by &lt;/span&gt;&lt;span&gt;cottonbro&lt;/span&gt;&lt;span&gt; from &lt;/span&gt;&lt;span&gt;Pexels&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;strong&gt;&lt;span&gt;情境 &lt;strong&gt;&lt;span&gt;—&lt;/span&gt;&lt;/strong&gt; &lt;/span&gt;&lt;/strong&gt;&lt;span&gt;薪资谈判的成效因情况而异。我没有找到很多关于&lt;span&gt;薪资&lt;/span&gt;&lt;span&gt;谈判&lt;/span&gt;&lt;span/&gt;&lt;span&gt;成&lt;/span&gt;&lt;span&gt;效&lt;/span&gt;&lt;span/&gt;的数据，因此我仅凭自己的经验撰写了这篇文章。我不能保证你也会有同样的经历。然而&lt;span&gt;i&lt;/span&gt;&lt;span&gt;nterviewing.io&lt;/span&gt; 保证在向你收费之前你的 &lt;/span&gt;&lt;span&gt;Offer&lt;/span&gt;&lt;span&gt; 至少要涨 &lt;/span&gt;&lt;span&gt;1&lt;/span&gt;&lt;span&gt; 万美元。这应该足以抵消 “结果可能会有所不同” 的事实。&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;strong&gt;&lt;span&gt;我学到的3个技巧&lt;/span&gt;&lt;/strong&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;以下是我从 &lt;span&gt;i&lt;/span&gt;&lt;span&gt;nterviewing.io&lt;/span&gt; 薪资谈判专家中学到的一些技巧。&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;strong&gt;&lt;span&gt;不要做第一个说出薪酬的人&lt;/span&gt;&lt;/strong&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;在面试过程中，可能会有人问你的期望薪酬。请礼貌地告诉他们，你不愿意在那个时候分享这个信息。&lt;/span&gt;&lt;span&gt;Aline Lerner &lt;/span&gt;&lt;span&gt;录制了一段精彩的视频（&lt;/span&gt;&lt;span&gt;https://youtu.be/p_B1_862ZFM?t=2902&lt;/span&gt;&lt;span&gt;），里面讲述了实现这一目标的最佳方法。&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;我过去曾听过这个建议，但是直到我遇到 &lt;/span&gt;&lt;span&gt;Aline&lt;/span&gt;&lt;span&gt;，我才完全认同。我之前的策略是给出一个我所能接受的薪酬范围。和 &lt;span&gt;Aline&lt;/span&gt; 见面后，我听从了她的建议，甚至都不再给出薪酬范围。以往当我给出一个范围时，我收到的 &lt;/span&gt;&lt;span&gt;Offer &lt;/span&gt;&lt;span&gt;都比最低期望薪资低 &lt;/span&gt;&lt;span&gt;2 &lt;/span&gt;&lt;span&gt;万美元。而当我不再给出薪酬范围后，我却收到了一些在我薪酬范围内的&lt;/span&gt;&lt;span&gt;Offer&lt;/span&gt;&lt;span&gt;。我没有足够的数据来判断这是否是巧合。但是，不透露薪资信息从来不会对我的求职产生负面影响。&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;strong&gt;&lt;span&gt;多拿几个 Offer&lt;/span&gt;&lt;/strong&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;你需要尽早知道的一条建议是，拿到的 &lt;/span&gt;&lt;span&gt;Offer&lt;/span&gt;&lt;span&gt; 越多越好。一个有竞争力的 &lt;/span&gt;&lt;span&gt;Offer&lt;/span&gt;&lt;span&gt; 是薪酬谈判的有力筹码。知道你有其他 &lt;/span&gt;&lt;span&gt;Offer&lt;/span&gt;&lt;span&gt; 可能会促使公司提高他们的 &lt;/span&gt;&lt;span&gt;Offer&lt;/span&gt;&lt;span&gt;。如果有开价更高的&lt;span&gt;竞争性&lt;/span&gt;&lt;span&gt; &lt;/span&gt;&lt;span&gt;Offer&lt;/span&gt;&lt;span&gt; &lt;/span&gt;，或者有来自竞争对手的 &lt;span&gt;O&lt;/span&gt;&lt;span&gt;ffer&lt;/span&gt;，那可以为你目前在谈的 &lt;/span&gt;&lt;span&gt;Offer &lt;/span&gt;&lt;span&gt;带来更多的 &lt;/span&gt;&lt;span&gt;money&lt;/span&gt;&lt;span&gt;。有备份的 &lt;/span&gt;&lt;span&gt;Offer&lt;/span&gt;&lt;span&gt; 也是很好的，因为它可以保证当首选的 &lt;/span&gt;&lt;span&gt;Offer &lt;/span&gt;&lt;span&gt;出现严重问题时，手里至少还有其他 &lt;/span&gt;&lt;span&gt;Offer&lt;/span&gt;&lt;span&gt;。所以当你求职的时候，要确保除了你的梦想工作之外，还要申请几个非梦想梯队的工作&lt;/span&gt;&lt;span&gt;。&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;以我的情况而言，有竞争力的 &lt;/span&gt;&lt;span&gt;Offer&lt;/span&gt;&lt;span&gt; 最终会变得非常重要。我相信是有竞争力的 &lt;span&gt;Offer&lt;/span&gt;&lt;span&gt; &lt;/span&gt;帮助我获得了薪酬最高的 &lt;/span&gt;&lt;span&gt;Offer&lt;/span&gt;&lt;span&gt;，然后又促使 &lt;/span&gt;&lt;span&gt;Google&lt;/span&gt;&lt;span&gt; 提升薪资击败原先那个&lt;span&gt;薪酬&lt;/span&gt;&lt;span&gt;最高的&lt;/span&gt; &lt;/span&gt;&lt;span&gt;Offer&lt;/span&gt;&lt;span&gt;。&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;strong&gt;&lt;span&gt;仅谈判一次&lt;/span&gt;&lt;/strong&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;当我收到一个薪资较低的 &lt;/span&gt;&lt;span&gt;Offer&lt;/span&gt;&lt;span&gt; 时，我的第一反应是马上开始薪酬谈判。在&lt;span&gt;Aline&lt;/span&gt;&lt;span&gt; 的&lt;/span&gt;帮助下，我意识到这不是最好的做法。这种方法的问题在于，我想在收到最好的 &lt;span&gt;Offer&lt;/span&gt;&lt;span&gt; &lt;/span&gt;之前就开始薪酬谈判。如果我当时谈好了涨薪，那么当我收到更高薪水的 &lt;/span&gt;&lt;span&gt;Offer&lt;/span&gt;&lt;span&gt; 时，我就不得不重新谈了。这会导致你和公司的 “谈判疲劳”。而且公司不太可能进行第二次谈判，因为他们不知道你会再向他们提多少次涨薪。&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;img class=&quot;rich_pages js_insertlocalimg&quot; data-backh=&quot;385&quot; data-backw=&quot;578&quot; data-ratio=&quot;0.6657142857142857&quot; data-s=&quot;300,640&quot; data-src=&quot;https://mmbiz.qpic.cn/mmbiz_jpg/la8s6uvJibdTDiahbW85Bl1PdL4mtSWBLqDYJejevvkcLrf4Btkl8MticaRNfibJJehQdL2eicITSP2CQVcdRBoRPHA/640?wx_fmt=jpeg&quot; data-type=&quot;jpeg&quot; data-w=&quot;700&quot;/&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;Photo by &lt;/span&gt;&lt;span&gt;Andrea Piacquadio&lt;/span&gt;&lt;span&gt; from &lt;/span&gt;&lt;span&gt;Pexels&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;总结一下：首先，要专注于你的既定策略。然后，当你拿到所有的 &lt;/span&gt;&lt;span&gt;Offer &lt;/span&gt;&lt;span&gt;后，再开始谈判。这期间可能会有一些来来回回的交流，但他们的时间跨度很短，不需要耗费大量时间。&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;strong&gt;&lt;span&gt;我会成为回头客吗？&lt;/span&gt;&lt;/strong&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;长话短说，是的！&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;你可&lt;/span&gt;&lt;span&gt;能想知道我是否会再次使用这个服务。&lt;/span&gt;&lt;span&gt;是的，我想我会的。但是&lt;/span&gt;&lt;span&gt;，我第二次使用它的时候情况会有所不同。那么，&lt;/span&gt;&lt;span&gt;我会改变我第一次做的事吗？不会。但是&lt;/span&gt;&lt;span&gt;下一次，我将在以后的求职中再使用这项服务。&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;img class=&quot;rich_pages js_insertlocalimg&quot; data-backh=&quot;750&quot; data-backw=&quot;500&quot; data-ratio=&quot;1.5&quot; data-s=&quot;300,640&quot; data-src=&quot;https://mmbiz.qpic.cn/mmbiz_jpg/la8s6uvJibdTDiahbW85Bl1PdL4mtSWBLq0yLpFdAB3icL4tkHkJjn4resn8OaL2zHcCCOOz1WXLnZ1rmhtiaWib78A/640?wx_fmt=jpeg&quot; data-type=&quot;jpeg&quot; data-w=&quot;500&quot;/&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;Photo by &lt;/span&gt;&lt;span&gt;Andrea Piacquadio&lt;/span&gt;&lt;span&gt; from &lt;/span&gt;&lt;span&gt;Pexels&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;薪资谈判分为三个阶段：&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;strong&gt;&lt;span&gt;早期 —— &lt;/span&gt;&lt;/strong&gt;&lt;span&gt;就是你在申请职位和面试的时候。上面提到的“&lt;strong&gt;&lt;span&gt;不要做第一个说出薪酬的人&lt;/span&gt;&lt;/strong&gt;”这样的建议在这里很适用。&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;strong&gt;&lt;span&gt;中期 —— &lt;/span&gt;&lt;/strong&gt;&lt;span&gt;你开始收到 &lt;/span&gt;&lt;span&gt;Offer&lt;/span&gt;&lt;span&gt;，但面试还没全部结束。这个阶段的大多数策略都涉及如何延长 &lt;span&gt;Offer&lt;/span&gt; 的截止日期。&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;strong&gt;&lt;span&gt;后期 —— &lt;/span&gt;&lt;/strong&gt;&lt;span&gt;这时候，&lt;/span&gt;&lt;span&gt;所有的 &lt;span&gt;Offer&lt;/span&gt; 都已摆在桌面上，这个阶段的策略就是要尝试如何给 &lt;/span&gt;&lt;span&gt;Offer &lt;/span&gt;&lt;span&gt;涨薪&lt;/span&gt;&lt;span&gt;。&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;在早期阶段，谈判策略是通用的。它们不会因公司或场景而改变。中期阶段的策略大多是通用的。在某些情况下可能需要更具体的策略。例如，如果公司不能再延长截止日期该怎么办。最后，后期阶段的策略是视情况而定的。&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;我第一次使用这个服务时，我在中期阶段开始与 &lt;/span&gt;&lt;span&gt;Aline &lt;/span&gt;&lt;span&gt;合作。我学到了适用于早期和中期的各种技巧。现在，我觉得自己已经能很轻松地经历这些阶段了。下次我使用这个服务时，我会从中期和后期阶段之间开始。鉴于我这次的成功经历，我下次还会毫不犹豫地聘请薪酬谈判专家，为我在最终的谈判中指明方向。&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;&lt;span&gt;以上，&lt;/span&gt;&lt;span&gt;Enjoy&lt;/span&gt;&lt;span&gt; ~&lt;/span&gt;&lt;/span&gt;&lt;/p&gt;
                &lt;/div&gt;

                

                



                
                &lt;/div&gt;&lt;/div&gt;</content:encoded>
</item>
<item>
<guid>46ee1a855790a781ece0d31a3f36d774</guid>
<title>终于讲清楚了：深入理解 Java 应用程序中 final 关键字的各种使用场景</title>
<link>https://toutiao.io/k/febn4rp</link>
<content:encoded>&lt;div&gt;&lt;div&gt;&lt;div class=&quot;rich_media_content &quot; id=&quot;js_content&quot;&gt;
                    

                    
                    
                    
                    &lt;section&gt;&lt;span&gt;在 Java 语言众多的关键字中，final 关键字无疑是被提到最多的，也是在面试过程中经常被问到的知识点。今天，老王查找了很多材料，最后终于收集了关于 final 关键字比较全的知识点。首先，final 关键字可以修饰的对象有三个：一是修饰变量、二是修饰方法、三是修饰类，下面我们来看经过 final 关键字修饰的这三种对象会有着怎样的不同。&lt;/span&gt;&lt;br/&gt;&lt;/section&gt;&lt;section&gt;&lt;span&gt;&lt;br/&gt;&lt;/span&gt;&lt;/section&gt;&lt;section&gt;&lt;span&gt;1，final 关键字修饰变量&lt;/span&gt;&lt;strong&gt;&lt;span/&gt;&lt;/strong&gt;&lt;/section&gt;&lt;p&gt;&lt;span&gt;在使用 final 关键字修饰变量时，又可以分为两种情况：一种是基本数据类型的变量、另一种是引用类型的变量。final 关键字在修饰基本数据类型时必须对变量赋予初始值，因此，final 关键字也经常和 static 关键字一起用来声明常量值，final 正好限制了必须赋值、static 声明了静态变量。&lt;/span&gt;&lt;strong&gt;&lt;span&gt;&lt;br/&gt;&lt;/span&gt;&lt;/strong&gt;&lt;/p&gt;&lt;section class=&quot;code-snippet__fix code-snippet__js&quot;&gt;&lt;pre class=&quot;code-snippet__js&quot; data-lang=&quot;javascript&quot;&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;/&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;final &lt;span class=&quot;code-snippet__keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;code-snippet__built_in&quot;&gt;String&lt;/span&gt; str = &lt;span class=&quot;code-snippet__string&quot;&gt;&quot;老王说编程&quot;&lt;/span&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/section&gt;&lt;p&gt;&lt;span&gt;修饰引用变量时，该引用变量如果已经被赋值则不可以再被赋值，否则也会出现不能被编译的情况。&lt;/span&gt;&lt;/p&gt;&lt;section class=&quot;code-snippet__fix code-snippet__js&quot;&gt;&lt;pre class=&quot;code-snippet__js&quot; data-lang=&quot;java&quot;&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;/&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span class=&quot;code-snippet__keyword&quot;&gt;final&lt;/span&gt; Main main = &lt;span class=&quot;code-snippet__keyword&quot;&gt;new&lt;/span&gt; Main();&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;/&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;main = &lt;span class=&quot;code-snippet__keyword&quot;&gt;new&lt;/span&gt; Main();&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/section&gt;&lt;section&gt;&lt;span&gt;&lt;span/&gt;&lt;/span&gt;&lt;/section&gt;&lt;p&gt;&lt;mpcpc js_editor_cpcad=&quot;&quot; class=&quot;js_cpc_area cpc_iframe&quot; src=&quot;/cgi-bin/readtemplate?t=tmpl/cpc_tmpl#1614761665001&quot; data-category_id_list=&quot;48|32|26|49|1|27|28|45|46|55|39|8|3|47|35|41|5|31|6|7|24|37|22|11|50|54|53|52|42|29|43|16|17|51|36&quot; data-id=&quot;1614761665001&quot;/&gt;&lt;/p&gt;&lt;section&gt;&lt;span&gt;2，final 关键字修饰方法&lt;/span&gt;&lt;/section&gt;&lt;p&gt;&lt;span&gt;&lt;span&gt;通过 final 关键字修饰的方法是不能被子类的方法重写的，相当于一个方法的功能已经被定了不能进行重写修改。一般情况下，如果一个方法的功能已经确定好不再改变了则可以使用 final 关键字修饰一下，因为 final 关键字修饰以后的方法是在程序编译的时候就被动态绑定了不用等到程序运行的时候被动态绑定，这样就大大的提高了执行的效率。&lt;/span&gt;&lt;/span&gt;&lt;/p&gt;&lt;section class=&quot;code-snippet__fix code-snippet__js&quot;&gt;&lt;pre class=&quot;code-snippet__js&quot; data-lang=&quot;cs&quot;&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span class=&quot;code-snippet__function&quot;&gt;&lt;span class=&quot;code-snippet__keyword&quot;&gt;public&lt;/span&gt; final &lt;span class=&quot;code-snippet__keyword&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;code-snippet__title&quot;&gt;method&lt;/span&gt;(&lt;span class=&quot;code-snippet__params&quot;/&gt;)&lt;/span&gt; {&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;    System.&lt;span class=&quot;code-snippet__keyword&quot;&gt;out&lt;/span&gt;.println(&lt;span class=&quot;code-snippet__string&quot;&gt;&quot;it is final method&quot;&lt;/span&gt;);&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;  }&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/section&gt;&lt;section&gt;&lt;br/&gt;&lt;/section&gt;&lt;section&gt;&lt;span&gt;3，final 关键字修饰类&lt;/span&gt;&lt;/section&gt;&lt;p&gt;&lt;span&gt;被 final 关键字修饰的类一般叫 final 类，final 类是不能被继承的，这也就意味着 final 类的功能一般是比较完整的。因此，Jdk 中有很多类都是用 final 关键字进行修饰的，它们不需要被继承。其中，最常见的 String 类就是 fianl 关键字修饰的类，还有其他的装饰类等等。&lt;/span&gt;&lt;/p&gt;&lt;section class=&quot;code-snippet__fix code-snippet__js&quot;&gt;&lt;pre class=&quot;code-snippet__js&quot; data-lang=&quot;java&quot;&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span class=&quot;code-snippet__keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-snippet__keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;code-snippet__class&quot;&gt;&lt;span class=&quot;code-snippet__keyword&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;code-snippet__title&quot;&gt;String&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;    &lt;span class=&quot;code-snippet__keyword&quot;&gt;implements&lt;/span&gt; &lt;span class=&quot;code-snippet__title&quot;&gt;java&lt;/span&gt;.&lt;span class=&quot;code-snippet__title&quot;&gt;io&lt;/span&gt;.&lt;span class=&quot;code-snippet__title&quot;&gt;Serializable&lt;/span&gt;, &lt;span class=&quot;code-snippet__title&quot;&gt;Comparable&lt;/span&gt;&amp;lt;&lt;span class=&quot;code-snippet__title&quot;&gt;String&lt;/span&gt;&amp;gt;, &lt;span class=&quot;code-snippet__title&quot;&gt;CharSequence&lt;/span&gt; &lt;/span&gt;{ }&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/section&gt;&lt;section&gt;&lt;span/&gt;&lt;/section&gt;&lt;section class=&quot;code-snippet__fix code-snippet__js&quot;&gt;&lt;pre class=&quot;code-snippet__js&quot; data-lang=&quot;java&quot;&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span class=&quot;code-snippet__keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-snippet__keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;code-snippet__class&quot;&gt;&lt;span class=&quot;code-snippet__keyword&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;code-snippet__title&quot;&gt;Integer&lt;/span&gt; &lt;span class=&quot;code-snippet__keyword&quot;&gt;extends&lt;/span&gt; &lt;span class=&quot;code-snippet__title&quot;&gt;Number&lt;/span&gt; &lt;span class=&quot;code-snippet__keyword&quot;&gt;implements&lt;/span&gt; &lt;span class=&quot;code-snippet__title&quot;&gt;Comparable&lt;/span&gt;&amp;lt;&lt;span class=&quot;code-snippet__title&quot;&gt;Integer&lt;/span&gt;&amp;gt; &lt;/span&gt;{}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/section&gt;&lt;section class=&quot;code-snippet__fix code-snippet__js&quot;&gt;&lt;pre class=&quot;code-snippet__js&quot; data-lang=&quot;java&quot;&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span class=&quot;code-snippet__keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-snippet__keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;code-snippet__class&quot;&gt;&lt;span class=&quot;code-snippet__keyword&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;code-snippet__title&quot;&gt;Long&lt;/span&gt; &lt;span class=&quot;code-snippet__keyword&quot;&gt;extends&lt;/span&gt; &lt;span class=&quot;code-snippet__title&quot;&gt;Number&lt;/span&gt; &lt;span class=&quot;code-snippet__keyword&quot;&gt;implements&lt;/span&gt; &lt;span class=&quot;code-snippet__title&quot;&gt;Comparable&lt;/span&gt;&amp;lt;&lt;span class=&quot;code-snippet__title&quot;&gt;Long&lt;/span&gt;&amp;gt; &lt;/span&gt;{}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/section&gt;&lt;section&gt;&lt;span&gt;以上包括其他的装饰器类都是被 final 关键字进行修饰的，它自身提供的方法和功能也是非常完备的。&lt;/span&gt;&lt;br/&gt;&lt;/section&gt;&lt;section&gt;&lt;br/&gt;&lt;/section&gt;&lt;section&gt;&lt;span&gt;4，static 关键字的不同&lt;/span&gt;&lt;/section&gt;&lt;p&gt;&lt;span&gt;&lt;span&gt;既然文章说明 final 关键字，难免会让人联想到 static 关键字的使用场景，毕竟，final static 成对出现的频率也是比较高的。使用 static 修饰的变量只会在类加载的时候被初始化不会因为对象的再次创建而改变。&lt;/span&gt;&lt;/span&gt;&lt;/p&gt;&lt;section class=&quot;code-snippet__fix code-snippet__js&quot;&gt;&lt;pre class=&quot;code-snippet__js&quot; data-lang=&quot;javascript&quot;&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;/&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;/&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span class=&quot;code-snippet__keyword&quot;&gt;static&lt;/span&gt; double num = &lt;span class=&quot;code-snippet__built_in&quot;&gt;Math&lt;/span&gt;.random();&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/section&gt;&lt;section&gt;&lt;span&gt;&lt;span/&gt;&lt;/span&gt;&lt;/section&gt;&lt;section class=&quot;mp_profile_iframe_wrp&quot;&gt;&lt;mpprofile class=&quot;js_uneditable custom_select_card mp_profile_iframe&quot; data-pluginname=&quot;mpprofile&quot; data-id=&quot;MzA3ODk1Mzg0Mg==&quot; data-headimg=&quot;http://mmbiz.qpic.cn/mmbiz_png/wzyc1ToJM6iapatWXS30ia0W8PkyCtILmSOrN6AgtyGJsZVrjGwsk31FsPDyJZ5bKia6r9PGaaD75s7Pc7XcpYf5g/0?wx_fmt=png&quot; data-nickname=&quot;老王说编程&quot; data-alias=&quot;lwsbc1024&quot; data-signature=&quot;还原编程思想、深入日常开发、分享最新技术及编程经验&quot;/&gt;&lt;/section&gt;&lt;p&gt;&lt;em&gt;&lt;strong&gt;&lt;span&gt;点击卡片关注【老王说编程】，每天进步一点点，您的每一个点赞、在看、分享都是在致力于减少攻城狮产出的 BUG，欢迎大家在评论区进行留言，一起学习，一起成长！&lt;/span&gt;&lt;/strong&gt;&lt;/em&gt;&lt;/p&gt;
                &lt;/div&gt;

                

                



                
                &lt;div class=&quot;reward_qrcode_area reward_area tc&quot; id=&quot;js_reward_qrcode&quot;&gt;
                                &lt;p class=&quot;tips_global&quot;&gt;Long-press QR code to transfer me a reward&lt;/p&gt;
                                                                &lt;p class=&quot;reward_tips&quot;&gt;老王辛苦啦，给他加个鸡腿🍗&lt;/p&gt;
                                &lt;span class=&quot;reward_qrcode_img_wrp&quot;&gt;&lt;img class=&quot;reward_qrcode_img&quot; id=&quot;js_reward_qrcode_img&quot;/&gt;&lt;/span&gt;
                                &lt;p class=&quot;tips_global&quot;&gt;As required by Apple&#x27;s new policy, the Reward feature has been disabled on Weixin for iOS. You can still reward an Official Account by transferring money via QR code.&lt;/p&gt;
                            &lt;/div&gt;
                                                                            
                              
            &lt;/div&gt;&lt;/div&gt;</content:encoded>
</item>
<item>
<guid>f6a2ea85b6dc4ec55f906d713c9d553b</guid>
<title>不用代码趣讲 ZooKeeper 集群</title>
<link>https://toutiao.io/k/3j3kd2k</link>
<content:encoded>&lt;div&gt;&lt;div&gt;&lt;section data-tool=&quot;mdnice编辑器&quot; data-website=&quot;https://www.mdnice.com&quot; data-mpa-powered-by=&quot;yiban.io&quot;&gt;&lt;figure data-tool=&quot;mdnice编辑器&quot;&gt;&lt;img data-ratio=&quot;0.425531914893617&quot; data-src=&quot;https://mmbiz.qpic.cn/mmbiz_png/xBgIbW1vdNPSwZU8icHpjrdbNEKuP5GG7nYmDjSjcIOtJtZrx9E0T5z9IlibCM2ygC6Gzr3tlou4HHJCE4hxszaA/640?wx_fmt=png&quot; data-type=&quot;png&quot; data-w=&quot;940&quot;/&gt;&lt;/figure&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;本文作者：HelloGitHub-&lt;strong&gt;老荀&lt;/strong&gt;&lt;/p&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;Hi，这里是 HelloGitHub 推出的 HelloZooKeeper 系列，&lt;strong&gt;免费开源、有趣、入门级的 ZooKeeper 教程&lt;/strong&gt;，面向有编程基础的新手。&lt;/p&gt;&lt;blockquote data-tool=&quot;mdnice编辑器&quot;&gt;&lt;p&gt;项目地址：https://github.com/HelloGitHub-Team/HelloZooKeeper&lt;/p&gt;&lt;/blockquote&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;今天开始我们将深入 ZK 集群相关知识～&lt;/p&gt;&lt;h2 data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span/&gt;&lt;span&gt;一、为什么需要集群&lt;/span&gt;&lt;span&gt; &lt;/span&gt;&lt;/h2&gt;&lt;h3 data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span/&gt;1.1 马果果病了&lt;span/&gt;&lt;/h3&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;ZKr～老规矩～&lt;/p&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;strong&gt;马果果&lt;/strong&gt;毕竟年纪大了，这办事处的事情越来越多，终于有一天扛不住，生病了，住院了，听医生说要休息好几天。办事处负责人不在的话就不能给村民们提供服务了。大家平时也要注意身体啊～&lt;/p&gt;&lt;figure data-tool=&quot;mdnice编辑器&quot;&gt;&lt;img data-src=&quot;https://mmbiz.qpic.cn/mmbiz_png/xBgIbW1vdNPSwZU8icHpjrdbNEKuP5GG7MNnNhZSHG4qIQW4ynHU9icibvBJiaxDowuCKWL8cmx43HVfO2mnWAy75A/640?wx_fmt=png&quot; data-type=&quot;png&quot; data-ratio=&quot;1.1049382716049383&quot; data-w=&quot;162&quot;/&gt;&lt;/figure&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;一连好几天都没收到通知的&lt;strong&gt;坤坤&lt;/strong&gt;急死了，还有其他非常依赖办事处的村民们都一起跑去村委会投诉了，村委会也很无奈啊，最终商量了下，决定请村里威望同样很高的著名企业家，太极爱好者并且还是村里首富的&lt;strong&gt;马小云&lt;/strong&gt;成立第二办事处，地点离原来的办事处也很近，同样负责处理之前&lt;strong&gt;马果果&lt;/strong&gt;办事处的事务。&lt;strong&gt;马小云&lt;/strong&gt;之前也是办事处的常客，对其中的流程已经是非常清楚了，一直想为人民做实事的他，欣然答应了下来。&lt;/p&gt;&lt;figure data-tool=&quot;mdnice编辑器&quot;&gt;&lt;img data-src=&quot;https://mmbiz.qpic.cn/mmbiz_png/xBgIbW1vdNPSwZU8icHpjrdbNEKuP5GG7ZADa28ibNoHdUVqicnITktaRlFl0vgJuC37odia2OdPA9EuckzBsVCiaLA/640?wx_fmt=png&quot; data-type=&quot;png&quot; data-ratio=&quot;1.1975806451612903&quot; data-w=&quot;248&quot;/&gt;&lt;/figure&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;而且已经有了之前的成功经验，所以直接照搬之前的处理流程就行了。但是细心的村民很快就发现了问题，之前在&lt;strong&gt;马果果&lt;/strong&gt;的办事处很多已经记录过的事务，现在都消失了，在新的办事处这里需要重新登记，非常不方便，但是&lt;strong&gt;马小云&lt;/strong&gt;表示也没办法，&lt;strong&gt;马果果&lt;/strong&gt;病得太突然了，还没交接过，只能表示让大家忍忍。&lt;/p&gt;&lt;figure data-tool=&quot;mdnice编辑器&quot;&gt;&lt;img data-src=&quot;https://mmbiz.qpic.cn/mmbiz_png/xBgIbW1vdNPSwZU8icHpjrdbNEKuP5GG7U8PRwWuZeRpvHbZRV5MXV8jCdfTXCg22QxtGLqNxSWDBBuCWlVT0Ig/640?wx_fmt=png&quot; data-type=&quot;png&quot; data-ratio=&quot;0.62751677852349&quot; data-w=&quot;298&quot;/&gt;&lt;/figure&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;就这样，过了两周，&lt;strong&gt;马果果&lt;/strong&gt;痊愈出院了，在住院期间他也已经得知了&lt;strong&gt;马小云&lt;/strong&gt;这两周代他帮助村民解决大小事务，他内心非常感激&lt;strong&gt;马小云&lt;/strong&gt;所做的一切，热爱工作的他，第一时间就回到了工作岗位，把办事处的大门重新打开，也广播告诉了村民，自己这里又能办理事务了，希望大家可以继续过来。由于&lt;strong&gt;马小云&lt;/strong&gt;毕竟业务能力稍差点，处理速度没那么快，导致第二办事处排队更严重了。&lt;/p&gt;&lt;figure data-tool=&quot;mdnice编辑器&quot;&gt;&lt;img data-src=&quot;https://mmbiz.qpic.cn/mmbiz_png/xBgIbW1vdNPSwZU8icHpjrdbNEKuP5GG7CqgEwiaaYaicFfqqP2Dzqu4lWrPwE5Tdb5gnCLkAbygsib7twQicDzqD1g/640?wx_fmt=png&quot; data-type=&quot;png&quot; data-ratio=&quot;0.4925124792013311&quot; data-w=&quot;601&quot;/&gt;&lt;/figure&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;听到第一办事处又开张的村民们非常高兴，毕竟谁也不希望排长队浪费时间，于是都来到了第一办事处&lt;/p&gt;&lt;figure data-tool=&quot;mdnice编辑器&quot;&gt;&lt;img data-src=&quot;https://mmbiz.qpic.cn/mmbiz_png/xBgIbW1vdNPSwZU8icHpjrdbNEKuP5GG7ictXwXXfQMaIEhKibc5TQPe3a9BcbH85sOTGh4rc0xX5c8ySYXjvdYrQ/640?wx_fmt=png&quot; data-type=&quot;png&quot; data-ratio=&quot;0.6565874730021598&quot; data-w=&quot;463&quot;/&gt;&lt;/figure&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;但是呢，&lt;strong&gt;马果果&lt;/strong&gt;休息了两周，这两周期间村民的登记的事务，他全部都没有，村民们纷纷表示这不行啊：“我们不管你们有几个办事处，你们得保证数据都是一致的啊！”。村委会也同意村民的诉求，勒令两个办事处整改，需要解决这个问题！而且因为&lt;strong&gt;马果果&lt;/strong&gt;资历更老，更有经验，所以让&lt;strong&gt;马小云&lt;/strong&gt;一切听&lt;strong&gt;马果果&lt;/strong&gt;的指挥，方案也由&lt;strong&gt;马果果&lt;/strong&gt;去想办法出台。&lt;/p&gt;&lt;h3 data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span/&gt;1.2 马果果的新规定&lt;span/&gt;&lt;/h3&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;strong&gt;马果果&lt;/strong&gt;不愧姜还是老的辣，很快就想出了一个好办法，出台了一系列的规则：&lt;/p&gt;&lt;ul data-tool=&quot;mdnice编辑器&quot; class=&quot;list-paddingleft-2&quot;&gt;&lt;li&gt;&lt;section&gt;数据必须以&lt;strong&gt;马果果&lt;/strong&gt;为主&lt;/section&gt;&lt;/li&gt;&lt;li&gt;&lt;section&gt;两个办事处间需要打通联系，随时保持沟通&lt;/section&gt;&lt;/li&gt;&lt;li&gt;&lt;section&gt;之前把村民前来登记的事务区分成读和写，是非常正确的决定。之后写操作必须通过&lt;strong&gt;马果果&lt;/strong&gt;，读操作&lt;strong&gt;马小云&lt;/strong&gt;可以自行解决&lt;/section&gt;&lt;/li&gt;&lt;/ul&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;但是光出台规则还不够，还需要一系列可以落地的操作，于是&lt;strong&gt;马果果&lt;/strong&gt;向村委会申请，办事处需要扩招人，村委会决定让&lt;strong&gt;马果果&lt;/strong&gt;放手干，同意了他的申请。&lt;/p&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;strong&gt;马果果&lt;/strong&gt;把自己办公室的布置重新调整了下变成了这样：&lt;/p&gt;&lt;figure data-tool=&quot;mdnice编辑器&quot;&gt;&lt;img data-src=&quot;https://mmbiz.qpic.cn/mmbiz_png/xBgIbW1vdNPSwZU8icHpjrdbNEKuP5GG7iaC37OJORK8eRL4THKnspeibRFD8iaibUHkT1HKGS52znPTmuoLHjzhZ8A/640?wx_fmt=png&quot; data-type=&quot;png&quot; data-ratio=&quot;0.41412012644889357&quot; data-w=&quot;949&quot;/&gt;&lt;/figure&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;简单介绍下新来的同事们：&lt;/p&gt;&lt;ul data-tool=&quot;mdnice编辑器&quot; class=&quot;list-paddingleft-2&quot;&gt;&lt;li&gt;&lt;section&gt;&lt;strong&gt;小PS&lt;/strong&gt;负责区分村民的请求是否需要发起提案，并把请求再次转发给&lt;strong&gt;小C&lt;/strong&gt;以及&lt;strong&gt;小S&lt;/strong&gt;&lt;/section&gt;&lt;/li&gt;&lt;li&gt;&lt;section&gt;&lt;strong&gt;小C&lt;/strong&gt;负责管理&lt;strong&gt;小PS&lt;/strong&gt;提案的提交工作，这个职位非常重要，所以&lt;strong&gt;马果果&lt;/strong&gt;很有私心的请了一个妹子来承担这个职位&lt;/section&gt;&lt;/li&gt;&lt;li&gt;&lt;section&gt;现在的&lt;strong&gt;小S&lt;/strong&gt;不再和&lt;strong&gt;小F&lt;/strong&gt;打交道了而是和&lt;strong&gt;小A&lt;/strong&gt;打交道，等他归档完后就会通知&lt;strong&gt;小A&lt;/strong&gt;&lt;/section&gt;&lt;/li&gt;&lt;li&gt;&lt;section&gt;因为现在有两个办事处了，所以需要聘请一个话务员，专门负责和隔壁的&lt;strong&gt;马小云&lt;/strong&gt;办事处进行沟通&lt;/section&gt;&lt;/li&gt;&lt;/ul&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;光是安排好自己还不够，&lt;strong&gt;马果果&lt;/strong&gt;替&lt;strong&gt;马小云&lt;/strong&gt;也设计了一套新的办公室方案：&lt;/p&gt;&lt;figure data-tool=&quot;mdnice编辑器&quot;&gt;&lt;img data-src=&quot;https://mmbiz.qpic.cn/mmbiz_png/xBgIbW1vdNPSwZU8icHpjrdbNEKuP5GG7SzR6XtWNpictcibQN2SQibcaF4hnOBNCL6kiaia1XIckehxcPOdibfXibK93w/640?wx_fmt=png&quot; data-type=&quot;png&quot; data-ratio=&quot;0.43448275862068964&quot; data-w=&quot;870&quot;/&gt;&lt;/figure&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;和&lt;strong&gt;马果果&lt;/strong&gt;不太一样，这里也简单介绍下：&lt;/p&gt;&lt;ul data-tool=&quot;mdnice编辑器&quot; class=&quot;list-paddingleft-2&quot;&gt;&lt;li&gt;&lt;section&gt;使用&lt;strong&gt;小FR&lt;/strong&gt;替换了原来的&lt;strong&gt;小P&lt;/strong&gt;作为办事处第一接待人&lt;/section&gt;&lt;/li&gt;&lt;li&gt;&lt;section&gt;&lt;strong&gt;小S&lt;/strong&gt;也不和&lt;strong&gt;小F&lt;/strong&gt;打交道了，直接和&lt;strong&gt;小SA&lt;/strong&gt;打交道，等他归档完就会通知&lt;strong&gt;小SA&lt;/strong&gt;&lt;/section&gt;&lt;/li&gt;&lt;li&gt;&lt;section&gt;和&lt;strong&gt;马果果&lt;/strong&gt;一样也聘请了一个话务员负责和&lt;strong&gt;马果果&lt;/strong&gt;进行联系&lt;/section&gt;&lt;/li&gt;&lt;/ul&gt;&lt;hr data-tool=&quot;mdnice编辑器&quot;/&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;原来只有&lt;strong&gt;马果果&lt;/strong&gt;负责的一个办事处，随着&lt;strong&gt;马果果&lt;/strong&gt;的病倒，村民的业务就无法继续展开了，这就是单点故障，所以在原来的基础上增加一个办事处，可以增加整个办事处的吞吐量的同时也可以在一个办事处无法提供服务时，不至于导致村民们无法使用，这就是高可用。这也是为什么需要集群部署的最重要原因！&lt;/p&gt;&lt;h2 data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span/&gt;&lt;span&gt;二、第一办事处&lt;/span&gt;&lt;span&gt; &lt;/span&gt;&lt;/h2&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;引入了集群前，原本一个节点数据自己内部运作管理就行，非常方便，但是引入集群后，集群间的节点如何沟通成了问题，让我们一起来看看&lt;strong&gt;马果果&lt;/strong&gt;的新员工们是怎么做的吧？&lt;/p&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;不同于之前的单机流程，现在流程复杂了很多，增加了很多出场的人物，为了让大家能快速记忆，我这里提前把名字的由来剧透给大家：&lt;/p&gt;&lt;ul data-tool=&quot;mdnice编辑器&quot; class=&quot;list-paddingleft-2&quot;&gt;&lt;li&gt;&lt;section&gt;&lt;strong&gt;小P&lt;/strong&gt;对应代码中的 &lt;code&gt;PrepRequestProcessor&lt;/code&gt; 负责预处理&lt;/section&gt;&lt;/li&gt;&lt;li&gt;&lt;section&gt;&lt;strong&gt;小PS&lt;/strong&gt;对应代码中的 &lt;code&gt;ProposalRequestProcessor&lt;/code&gt; 负责写事务的提案&lt;/section&gt;&lt;/li&gt;&lt;li&gt;&lt;section&gt;&lt;strong&gt;小C&lt;/strong&gt;对应代码中的 &lt;code&gt;CommitProcessor&lt;/code&gt; 负责对事务请求提交&lt;/section&gt;&lt;/li&gt;&lt;li&gt;&lt;section&gt;&lt;strong&gt;小S&lt;/strong&gt;对应代码中的 &lt;code&gt;SyncRequestProcessor&lt;/code&gt; 负责数据的归档&lt;/section&gt;&lt;/li&gt;&lt;li&gt;&lt;section&gt;&lt;strong&gt;小A&lt;/strong&gt;对应代码中的 &lt;code&gt;AckRequestProcessor&lt;/code&gt; 负责告诉&lt;strong&gt;马果果&lt;/strong&gt;当前事务的 ACK 信息&lt;/section&gt;&lt;/li&gt;&lt;li&gt;&lt;section&gt;&lt;strong&gt;小F&lt;/strong&gt;对应代码中的 &lt;code&gt;FinalRequestProcessor&lt;/code&gt; 负责对内存模型的操作&lt;/section&gt;&lt;/li&gt;&lt;/ul&gt;&lt;h3 data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span/&gt;2.1 负责的小PS&lt;span/&gt;&lt;/h3&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;原先&lt;strong&gt;小P&lt;/strong&gt;在第一时间询问村民后，并对当次请求进行标记后，就会把该请求转发给&lt;strong&gt;小PS&lt;/strong&gt;，&lt;strong&gt;小PS&lt;/strong&gt;做的事情也很简单：&lt;/p&gt;&lt;figure data-tool=&quot;mdnice编辑器&quot;&gt;&lt;img data-src=&quot;https://mmbiz.qpic.cn/mmbiz_png/xBgIbW1vdNPSwZU8icHpjrdbNEKuP5GG72jxPO30WrgSmRKL7ibRMVkkK1JlABI3nMp7dWLbTzyJTdm5bFP1rbgw/640?wx_fmt=png&quot; data-type=&quot;png&quot; data-ratio=&quot;0.16391752577319588&quot; data-w=&quot;970&quot;/&gt;&lt;/figure&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;主要就是看是不是写请求，如果是的话就要发起提案并且本地要通知&lt;strong&gt;小S&lt;/strong&gt;归档。&lt;/p&gt;&lt;h3 data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span/&gt;2.2 忙碌的小C&lt;span/&gt;&lt;/h3&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;strong&gt;小C&lt;/strong&gt;是除了&lt;strong&gt;小F&lt;/strong&gt;最忙碌的人了，她在接受到上一个同事传递过来的请求后会：&lt;/p&gt;&lt;figure data-tool=&quot;mdnice编辑器&quot;&gt;&lt;img data-src=&quot;https://mmbiz.qpic.cn/mmbiz_png/xBgIbW1vdNPSwZU8icHpjrdbNEKuP5GG7zyCAcwoV6OTdescPCzRSjQOjQvOeLQ6Bica7MHUdmpIGmOfgiaic4wU6A/640?wx_fmt=png&quot; data-type=&quot;png&quot; data-ratio=&quot;0.23634204275534443&quot; data-w=&quot;842&quot;/&gt;&lt;/figure&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;不是说&lt;strong&gt;小C&lt;/strong&gt;是最忙的吗？就这？&lt;/p&gt;&lt;figure data-tool=&quot;mdnice编辑器&quot;&gt;&lt;img data-src=&quot;https://mmbiz.qpic.cn/mmbiz_png/xBgIbW1vdNPSwZU8icHpjrdbNEKuP5GG7ddVVbyibTP5fWWMQr1oicsu33pZSiahMGW9eib9NzZeaZRDhNfXTjHAArQ/640?wx_fmt=png&quot; data-type=&quot;png&quot; data-ratio=&quot;0.7490740740740741&quot; data-w=&quot;1080&quot;/&gt;&lt;/figure&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;别急，&lt;strong&gt;小C&lt;/strong&gt;的处理过程的确是比较繁琐，但是我这里先给出简单的流程，最重要的提交操作，我暂时不展开，之后会讲～&lt;/p&gt;&lt;h3 data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span/&gt;2.3 小S和小A&lt;span/&gt;&lt;/h3&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;strong&gt;小S&lt;/strong&gt;处理的流程发生了改变，他前面的同事不再是&lt;strong&gt;小P&lt;/strong&gt;，而他处理完归档后也不再把请求交给&lt;strong&gt;小F&lt;/strong&gt;而是交给&lt;strong&gt;小A&lt;/strong&gt;，而&lt;strong&gt;小A&lt;/strong&gt;做的事情更简单，仅仅只是告诉&lt;strong&gt;马果果&lt;/strong&gt;办事处此次事务请求归档成功，其实就是 ACK。&lt;/p&gt;&lt;h3 data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span/&gt;2.4 话务员&lt;span/&gt;&lt;/h3&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;为了更顺畅的和隔壁的&lt;strong&gt;马小云&lt;/strong&gt;办事处相互沟通，&lt;strong&gt;马果果&lt;/strong&gt;定下了几个暗号，而话务员则负责用暗号去通知&lt;strong&gt;马小云&lt;/strong&gt;&lt;/p&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;当然暗号不止这些，之后有遇到再说。&lt;/p&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;在具体展开流程细节前，我觉得还是要把&lt;strong&gt;马小云&lt;/strong&gt;的流程简单介绍下，等两边都介绍完后，再合并在一起讲解～&lt;/p&gt;&lt;h2 data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span/&gt;&lt;span&gt;三、第二办事处&lt;/span&gt;&lt;span&gt; &lt;/span&gt;&lt;/h2&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;同样因为现在有两个办事处的关系，&lt;strong&gt;马小云&lt;/strong&gt;也无法单纯使用之前的流程，并且新员工中有明显区别于&lt;strong&gt;马果果&lt;/strong&gt;的&lt;strong&gt;小FR&lt;/strong&gt;和&lt;strong&gt;小SA&lt;/strong&gt;，这里也介绍下：&lt;/p&gt;&lt;ul data-tool=&quot;mdnice编辑器&quot; class=&quot;list-paddingleft-2&quot;&gt;&lt;li&gt;&lt;section&gt;&lt;strong&gt;小FR&lt;/strong&gt;对应代码中的 &lt;code&gt;FollowerRequestProcessor&lt;/code&gt; 负责&lt;strong&gt;马小云&lt;/strong&gt;这边的预处理&lt;/section&gt;&lt;/li&gt;&lt;li&gt;&lt;section&gt;&lt;strong&gt;小SA&lt;/strong&gt;对应代码中的 &lt;code&gt;SendAckRequestProcessor&lt;/code&gt; 和&lt;strong&gt;马果果&lt;/strong&gt;的&lt;strong&gt;小A&lt;/strong&gt;类似，通过话务员通知&lt;strong&gt;马果果&lt;/strong&gt;当前事务的 ACK&lt;/section&gt;&lt;/li&gt;&lt;/ul&gt;&lt;h3 data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span/&gt;3.1 同样细心的小FR和小SA&lt;span/&gt;&lt;/h3&gt;&lt;figure data-tool=&quot;mdnice编辑器&quot;&gt;&lt;img data-src=&quot;https://mmbiz.qpic.cn/mmbiz_png/xBgIbW1vdNPSwZU8icHpjrdbNEKuP5GG7uK2ruc2KLbvic9GfljPTCaT04uDAoR3eGhs6lpibcPyEjw3fzuo5uv7w/640?wx_fmt=png&quot; data-type=&quot;png&quot; data-ratio=&quot;0.18980891719745224&quot; data-w=&quot;785&quot;/&gt;&lt;/figure&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;和&lt;strong&gt;小PS&lt;/strong&gt;有点类似，也是需要区分读写，但区别是写请求需要通知&lt;strong&gt;马果果&lt;/strong&gt;。&lt;/p&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;strong&gt;小SA&lt;/strong&gt;的逻辑是接受到&lt;strong&gt;小S&lt;/strong&gt;的归档信息后，把 ACK 通知给&lt;strong&gt;马果果&lt;/strong&gt;，太简单了就不画图了。&lt;/p&gt;&lt;h2 data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span/&gt;&lt;span&gt;四、实战&lt;/span&gt;&lt;span&gt; &lt;/span&gt;&lt;/h2&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;刚刚我们把两个办事处逻辑都大致介绍了下，但是太过于碎片化了和简单，所以下面开始进入实战环节，会分别假定不同的业务场景和复杂程度，从简单到复杂，把从村民来办事处登记事务到办事处处理完成之间的逻辑按照时间顺序进行整理。&lt;/p&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;em&gt;前排提醒，多图预警&lt;/em&gt;&lt;/p&gt;&lt;h3 data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span/&gt;4.1 一个读请求（马果果）&lt;span/&gt;&lt;/h3&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;假设我们的&lt;strong&gt;坤坤&lt;/strong&gt;来到&lt;strong&gt;马果果&lt;/strong&gt;的办事处，想要查询&lt;strong&gt;鸡太美&lt;/strong&gt;最新的跳舞视频 &lt;code&gt;/鸡太美/跳舞&lt;/code&gt;&lt;/p&gt;&lt;figure data-tool=&quot;mdnice编辑器&quot;&gt;&lt;img data-src=&quot;https://mmbiz.qpic.cn/mmbiz_png/xBgIbW1vdNPSwZU8icHpjrdbNEKuP5GG7AsyxIAo68ehcuCKBn9YvDFmWMYslGnCYt1AmjdRjk93ztmOF2Eghtw/640?wx_fmt=png&quot; data-type=&quot;png&quot; data-ratio=&quot;0.612037037037037&quot; data-w=&quot;1080&quot;/&gt;&lt;/figure&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;strong&gt;小P&lt;/strong&gt;首先知道&lt;strong&gt;坤坤&lt;/strong&gt;是合法的村民，然后询问得知，此次来办事处的目的是为了查询，就会把此次登记标记为读请求，就把&lt;strong&gt;坤坤&lt;/strong&gt;的请求交给下一个柜台的&lt;strong&gt;小PS&lt;/strong&gt;。&lt;/p&gt;&lt;figure data-tool=&quot;mdnice编辑器&quot;&gt;&lt;img data-src=&quot;https://mmbiz.qpic.cn/mmbiz_png/xBgIbW1vdNPSwZU8icHpjrdbNEKuP5GG7fNSrjPxT7TbYl9OP8k3u1gVRu0dRnFIJMsRfL4EdMfHhQqjDCX6g5A/640?wx_fmt=png&quot; data-type=&quot;png&quot; data-ratio=&quot;0.6314814814814815&quot; data-w=&quot;1080&quot;/&gt;&lt;/figure&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;strong&gt;小PS&lt;/strong&gt;拿到请求后，先把请求原封不动的给到了&lt;strong&gt;小C&lt;/strong&gt;，之后通过&lt;strong&gt;小P&lt;/strong&gt;的标记知道了这是一个读请求，便不做其他处理。&lt;/p&gt;&lt;figure data-tool=&quot;mdnice编辑器&quot;&gt;&lt;img data-src=&quot;https://mmbiz.qpic.cn/mmbiz_png/xBgIbW1vdNPSwZU8icHpjrdbNEKuP5GG72mlianqushVadv29szFfVfzeBn3RrdCzibJ0IthfwexqibS0lYSTtSiaDw/640?wx_fmt=png&quot; data-type=&quot;png&quot; data-ratio=&quot;0.5861111111111111&quot; data-w=&quot;1080&quot;/&gt;&lt;/figure&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;strong&gt;小C&lt;/strong&gt;取到这个请求后也发现这是一个读请求，所以也直接交给了&lt;strong&gt;小F&lt;/strong&gt;，自己不需要其他处理。&lt;/p&gt;&lt;figure data-tool=&quot;mdnice编辑器&quot;&gt;&lt;img data-src=&quot;https://mmbiz.qpic.cn/mmbiz_png/xBgIbW1vdNPSwZU8icHpjrdbNEKuP5GG7piaQb1A0XLyyUFD4YgXKWPk5jG6ia5x9YSnKMXgFjzyJiaicoicLiaico58fw/640?wx_fmt=png&quot; data-type=&quot;png&quot; data-ratio=&quot;0.6231481481481481&quot; data-w=&quot;1080&quot;/&gt;&lt;/figure&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;strong&gt;小F&lt;/strong&gt;拿出了小红本查看，假设 &lt;code&gt;/鸡太美/跳舞&lt;/code&gt; 存在，把对应的数据就返回给了&lt;strong&gt;坤坤&lt;/strong&gt;。&lt;/p&gt;&lt;figure data-tool=&quot;mdnice编辑器&quot;&gt;&lt;img data-src=&quot;https://mmbiz.qpic.cn/mmbiz_png/xBgIbW1vdNPSwZU8icHpjrdbNEKuP5GG7dKboWpvCkDmMUGEVxFJvjen24ClCeibrv5JAMS1yicnxyGzwTHDXQ2lg/640?wx_fmt=png&quot; data-type=&quot;png&quot; data-ratio=&quot;0.39766839378238344&quot; data-w=&quot;772&quot;/&gt;&lt;/figure&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;strong&gt;坤坤&lt;/strong&gt;拿到了结果心满意足的回去了并且定好了 17 点的闹钟守在电脑前等着&lt;strong&gt;鸡太美&lt;/strong&gt;的开播了&lt;/p&gt;&lt;hr data-tool=&quot;mdnice编辑器&quot;/&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;可以看到一个读请求的处理流程是非常简单的，别急，难度会一点点的增加哦&lt;/p&gt;&lt;h3 data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span/&gt;4.2 一个读请求（马小云）&lt;span/&gt;&lt;/h3&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;同样还是我们的&lt;strong&gt;坤坤&lt;/strong&gt;，但是这次来到&lt;strong&gt;马小云&lt;/strong&gt;的办事处，同样想要查询&lt;strong&gt;鸡太美&lt;/strong&gt;最新的跳舞视频 &lt;code&gt;/鸡太美/跳舞&lt;/code&gt;&lt;/p&gt;&lt;figure data-tool=&quot;mdnice编辑器&quot;&gt;&lt;img data-src=&quot;https://mmbiz.qpic.cn/mmbiz_png/xBgIbW1vdNPSwZU8icHpjrdbNEKuP5GG75MUolAJiaiaRsFht2sDRxiaxcAer3vfY5QSyFaLgQR7iaRiagIicfNcWX48g/640?wx_fmt=png&quot; data-type=&quot;png&quot; data-ratio=&quot;0.7083333333333334&quot; data-w=&quot;1080&quot;/&gt;&lt;/figure&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;与&lt;strong&gt;马果果&lt;/strong&gt;不同的是，先处理&lt;strong&gt;坤坤&lt;/strong&gt;请求的是&lt;strong&gt;小FR&lt;/strong&gt;，他会先把请求发给&lt;strong&gt;小C&lt;/strong&gt;，之后通过询问&lt;strong&gt;坤坤&lt;/strong&gt;得知此次目的是查询，就不会做其他处理。你可能会问，&lt;strong&gt;小FR&lt;/strong&gt;不需要对&lt;strong&gt;坤坤&lt;/strong&gt;的身份进行核实吗？我认为可能是因为当前是读请求所以不会对数据造成破坏，所以并没有做校验。&lt;/p&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;之后的&lt;strong&gt;小C&lt;/strong&gt;和&lt;strong&gt;小F&lt;/strong&gt;和&lt;strong&gt;马果果&lt;/strong&gt;版本没有任何不同，就不赘述了。让我们进入下一个难度吧。&lt;/p&gt;&lt;h3 data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span/&gt;4.3 一个写请求（马果果）&lt;span/&gt;&lt;/h3&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;写请求就和读请求不一样了，因为根据&lt;strong&gt;马果果&lt;/strong&gt;的规定，两个办事处的数据得保持一致，所以就会涉及到如何通知对方了，让我们一起来看看吧。&lt;/p&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;假设我们的&lt;strong&gt;坤坤&lt;/strong&gt;来到&lt;strong&gt;马果果&lt;/strong&gt;的办事处，想要为自己创建一个事务登记 &lt;code&gt;/坤坤/日记&lt;/code&gt;&lt;/p&gt;&lt;figure data-tool=&quot;mdnice编辑器&quot;&gt;&lt;img data-src=&quot;https://mmbiz.qpic.cn/mmbiz_png/xBgIbW1vdNPSwZU8icHpjrdbNEKuP5GG7ZqiaQmItX1muUt87Wa9NbqSsXCiccGIvX8S4yBD46SAKoYTnRicuCXVmw/640?wx_fmt=png&quot; data-type=&quot;png&quot; data-ratio=&quot;1.002004008016032&quot; data-w=&quot;499&quot;/&gt;&lt;/figure&gt;&lt;figure data-tool=&quot;mdnice编辑器&quot;&gt;&lt;img data-src=&quot;https://mmbiz.qpic.cn/mmbiz_png/xBgIbW1vdNPSwZU8icHpjrdbNEKuP5GG7VTOtBnzHsgvAqCo3gJqicKGQyp5NhZibfZU6l0FLkdgVdkUzLibO90hgw/640?wx_fmt=png&quot; data-type=&quot;png&quot; data-ratio=&quot;0.6287037037037037&quot; data-w=&quot;1080&quot;/&gt;&lt;/figure&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;strong&gt;小P&lt;/strong&gt;知道&lt;strong&gt;坤坤&lt;/strong&gt;是合法的村民并且&lt;strong&gt;坤坤&lt;/strong&gt;此次的目的是写数据，所以就给&lt;strong&gt;坤坤&lt;/strong&gt;的请求打了一个写事务的标记，就把请求交给了&lt;strong&gt;小PS&lt;/strong&gt;了。&lt;/p&gt;&lt;figure data-tool=&quot;mdnice编辑器&quot;&gt;&lt;img data-src=&quot;https://mmbiz.qpic.cn/mmbiz_png/xBgIbW1vdNPSwZU8icHpjrdbNEKuP5GG7SO3SZqGcsOnWhy00eMdSPWGullI1odicWURG1nfu3cjxtGMicSu5XfBQ/640?wx_fmt=png&quot; data-type=&quot;png&quot; data-ratio=&quot;0.649074074074074&quot; data-w=&quot;1080&quot;/&gt;&lt;/figure&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;strong&gt;小PS&lt;/strong&gt;还是先把请求交给了&lt;strong&gt;小C&lt;/strong&gt;先处理。&lt;/p&gt;&lt;figure data-tool=&quot;mdnice编辑器&quot;&gt;&lt;img data-src=&quot;https://mmbiz.qpic.cn/mmbiz_png/xBgIbW1vdNPSwZU8icHpjrdbNEKuP5GG78RBDGqyrwR2DcmIOHDJ3YINIHcIIdARSyfvLLSVh4z4TugH3xyrCyA/640?wx_fmt=png&quot; data-type=&quot;png&quot; data-ratio=&quot;0.5712962962962963&quot; data-w=&quot;1080&quot;/&gt;&lt;/figure&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;strong&gt;小C&lt;/strong&gt;看到此次是写请求就拿出自己的小本子记了下来&lt;/p&gt;&lt;figure data-tool=&quot;mdnice编辑器&quot;&gt;&lt;img data-src=&quot;https://mmbiz.qpic.cn/mmbiz_png/xBgIbW1vdNPSwZU8icHpjrdbNEKuP5GG74eHGp4xTYwlvk7cnKoZq7X25icVOnamGCKxbZMSwLZdIlmlyo4zkLibA/640?wx_fmt=png&quot; data-type=&quot;png&quot; data-ratio=&quot;0.7083333333333334&quot; data-w=&quot;1080&quot;/&gt;&lt;/figure&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;strong&gt;小PS&lt;/strong&gt;已经得知此次是写请求。注意！这里开始就不一样了，&lt;strong&gt;小PS&lt;/strong&gt;会让话务员给&lt;strong&gt;马小云&lt;/strong&gt;办事处打电话。&lt;/p&gt;&lt;figure data-tool=&quot;mdnice编辑器&quot;&gt;&lt;img data-src=&quot;https://mmbiz.qpic.cn/mmbiz_png/xBgIbW1vdNPSwZU8icHpjrdbNEKuP5GG7oYnr8mZCCWK4zUmLb2jvK5pRt9uTOF9ib5hPJ9tpzC8ia8SV4qDU3ibAg/640?wx_fmt=png&quot; data-type=&quot;png&quot; data-ratio=&quot;0.5425925925925926&quot; data-w=&quot;1080&quot;/&gt;&lt;/figure&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;话务员告诉他们这次的请求并带着 PROPOSAL 的暗号。&lt;/p&gt;&lt;figure data-tool=&quot;mdnice编辑器&quot;&gt;&lt;img data-src=&quot;https://mmbiz.qpic.cn/mmbiz_png/xBgIbW1vdNPSwZU8icHpjrdbNEKuP5GG7qrKfa8GsuoYr9txUNBzV8KPC28Hfm89ric0fSK6CtygLPAPOsy49nhw/640?wx_fmt=png&quot; data-type=&quot;png&quot; data-ratio=&quot;0.3881932021466905&quot; data-w=&quot;559&quot;/&gt;&lt;/figure&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;这里必须要提一下事务编号，为了严格保证村民来登记的顺序，&lt;strong&gt;马果果&lt;/strong&gt;还规定了必须给每一次的写事务分配一个唯一的递增数字，从 0 开始。&lt;/p&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;并且通知&lt;strong&gt;马小云&lt;/strong&gt;的同时，&lt;strong&gt;马果果&lt;/strong&gt;也会把当前的提案记录下来：&lt;/p&gt;&lt;figure data-tool=&quot;mdnice编辑器&quot;&gt;&lt;img data-src=&quot;https://mmbiz.qpic.cn/mmbiz_png/xBgIbW1vdNPSwZU8icHpjrdbNEKuP5GG7cYDvUjsMmBezRCIXjPJHof4buluW4aE5A5nF0s8KwH3BoZ5vFXicJ1g/640?wx_fmt=png&quot; data-type=&quot;png&quot; data-ratio=&quot;1.1663366336633663&quot; data-w=&quot;1010&quot;/&gt;&lt;/figure&gt;&lt;hr data-tool=&quot;mdnice编辑器&quot;/&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;这时候我们把视角切换到&lt;strong&gt;马小云&lt;/strong&gt;这边，&lt;strong&gt;马小云&lt;/strong&gt;的话务员接受到&lt;strong&gt;马果果&lt;/strong&gt;那边的 PROPOSAL 的暗号后，会直接让自己这边的&lt;strong&gt;小S&lt;/strong&gt;进行归档，&lt;strong&gt;马小云&lt;/strong&gt;则会在备忘录里记录：&lt;/p&gt;&lt;figure data-tool=&quot;mdnice编辑器&quot;&gt;&lt;img data-src=&quot;https://mmbiz.qpic.cn/mmbiz_png/xBgIbW1vdNPSwZU8icHpjrdbNEKuP5GG7lqTAiaJZibGSY3ZXTcwLHArmRUgxf0GibDg2TUbuJB16YPBnHBXsdRkHA/640?wx_fmt=png&quot; data-type=&quot;png&quot; data-ratio=&quot;1.2149122807017543&quot; data-w=&quot;456&quot;/&gt;&lt;/figure&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;等&lt;strong&gt;小S&lt;/strong&gt;归档完后，就会把&lt;strong&gt;坤坤&lt;/strong&gt;的请求交给&lt;strong&gt;小SA&lt;/strong&gt;&lt;/p&gt;&lt;figure data-tool=&quot;mdnice编辑器&quot;&gt;&lt;img data-src=&quot;https://mmbiz.qpic.cn/mmbiz_png/xBgIbW1vdNPSwZU8icHpjrdbNEKuP5GG7pCIojyPVRnaTJn0hhRw9ngv0Eu5sYaRuaAF61ibrP5k8vOK2oPRXqvw/640?wx_fmt=png&quot; data-type=&quot;png&quot; data-ratio=&quot;0.6972222222222222&quot; data-w=&quot;1080&quot;/&gt;&lt;/figure&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;strong&gt;小SA&lt;/strong&gt;事情很简单就是让话务员通知&lt;strong&gt;马果果&lt;/strong&gt;归档完成&lt;/p&gt;&lt;figure data-tool=&quot;mdnice编辑器&quot;&gt;&lt;img data-src=&quot;https://mmbiz.qpic.cn/mmbiz_png/xBgIbW1vdNPSwZU8icHpjrdbNEKuP5GG7tM7fBia5CmkJIibTqlR0EvK6K8DNuvShxLImebcbP0wz62rVKmSZd3vw/640?wx_fmt=png&quot; data-type=&quot;png&quot; data-ratio=&quot;0.6064814814814815&quot; data-w=&quot;1080&quot;/&gt;&lt;/figure&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;接着&lt;strong&gt;马小云&lt;/strong&gt;这边的话务员就会给&lt;strong&gt;马果果&lt;/strong&gt;办事处打电话通知他们归档完成&lt;/p&gt;&lt;figure data-tool=&quot;mdnice编辑器&quot;&gt;&lt;img data-src=&quot;https://mmbiz.qpic.cn/mmbiz_png/xBgIbW1vdNPSwZU8icHpjrdbNEKuP5GG727CBPdc8XXhK9L8eEpjzvuoNuh3HGCyIoE3pfjaepicqlovK5esDcvw/640?wx_fmt=png&quot; data-type=&quot;png&quot; data-ratio=&quot;0.3733826247689464&quot; data-w=&quot;541&quot;/&gt;&lt;/figure&gt;&lt;hr data-tool=&quot;mdnice编辑器&quot;/&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;视角再一次回到&lt;strong&gt;马果果&lt;/strong&gt;这边，在&lt;strong&gt;小PS&lt;/strong&gt;让话务员通知&lt;strong&gt;马小云&lt;/strong&gt;那边的同时&lt;strong&gt;小S&lt;/strong&gt;也没闲着，进行了归档的操作&lt;/p&gt;&lt;figure data-tool=&quot;mdnice编辑器&quot;&gt;&lt;img data-src=&quot;https://mmbiz.qpic.cn/mmbiz_png/xBgIbW1vdNPSwZU8icHpjrdbNEKuP5GG7vOiaSZJ8axvYpicbenARFibUxJLt4jLYoueibDSl9yaYKUNbRLh9RalHGw/640?wx_fmt=png&quot; data-type=&quot;png&quot; data-ratio=&quot;0.5871156661786238&quot; data-w=&quot;683&quot;/&gt;&lt;/figure&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;strong&gt;小S&lt;/strong&gt;归档完成后，会把请求交给&lt;strong&gt;小A&lt;/strong&gt;，&lt;strong&gt;小A&lt;/strong&gt;做的事情很简单就是通知&lt;strong&gt;马果果&lt;/strong&gt;此次归档完成。&lt;/p&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;我们这里假设先是&lt;strong&gt;马果果&lt;/strong&gt;这边的&lt;strong&gt;小S&lt;/strong&gt;归档完成，&lt;strong&gt;马果果&lt;/strong&gt;在收到归档完成消息后会拿出刚刚的小本本找到对应的提案记录，并把已经归档完成的给记下来：&lt;/p&gt;&lt;figure data-tool=&quot;mdnice编辑器&quot;&gt;&lt;img data-src=&quot;https://mmbiz.qpic.cn/mmbiz_png/xBgIbW1vdNPSwZU8icHpjrdbNEKuP5GG7ppVibrrdic4Two7eicHicy8PYTe8pmsmU1CwjuwYT3vYdynvBkgib0MV1KQ/640?wx_fmt=png&quot; data-type=&quot;png&quot; data-ratio=&quot;1.1505154639175257&quot; data-w=&quot;485&quot;/&gt;&lt;/figure&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;因为&lt;strong&gt;马果果&lt;/strong&gt;知道一共有两个办事处，所以还需要等待&lt;strong&gt;马小云&lt;/strong&gt;的归档完成通知。&lt;/p&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;过了一会会，&lt;strong&gt;马小云&lt;/strong&gt;的归档通知也来了，就再在小本本上记下来&lt;/p&gt;&lt;figure data-tool=&quot;mdnice编辑器&quot;&gt;&lt;img data-src=&quot;https://mmbiz.qpic.cn/mmbiz_png/xBgIbW1vdNPSwZU8icHpjrdbNEKuP5GG7CfcHkgqD8vaia0BFiacnpwOic9R6AbzYmtJhhic56iaIpyibyuPtzNvOfptg/640?wx_fmt=png&quot; data-type=&quot;png&quot; data-ratio=&quot;1.1731958762886598&quot; data-w=&quot;485&quot;/&gt;&lt;/figure&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;至此，两个办事处对于当前提案都已经完成了归档，&lt;strong&gt;马果果&lt;/strong&gt;就会让话务员通知&lt;strong&gt;马小云&lt;/strong&gt;可以提交了，并且会将小本本上事务 0 的这条记录删除（图就不画了）。&lt;/p&gt;&lt;figure data-tool=&quot;mdnice编辑器&quot;&gt;&lt;img data-src=&quot;https://mmbiz.qpic.cn/mmbiz_png/xBgIbW1vdNPSwZU8icHpjrdbNEKuP5GG7gMVPZmhWguTog9zwSIP14kcpqfKMrcVPHWoCg4DSkgNxB2nmRfvoUw/640?wx_fmt=png&quot; data-type=&quot;png&quot; data-ratio=&quot;0.3302238805970149&quot; data-w=&quot;536&quot;/&gt;&lt;/figure&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;通知完，&lt;strong&gt;马果果&lt;/strong&gt;就让&lt;strong&gt;小C&lt;/strong&gt;可以进行提交了&lt;/p&gt;&lt;figure data-tool=&quot;mdnice编辑器&quot;&gt;&lt;img data-src=&quot;https://mmbiz.qpic.cn/mmbiz_png/xBgIbW1vdNPSwZU8icHpjrdbNEKuP5GG7EribdLmz9mavJ7SHEsFdAyzKNQ2RUI63FzcJNJ5YwaYz1L9kXf23KuQ/640?wx_fmt=png&quot; data-type=&quot;png&quot; data-ratio=&quot;0.5226666666666666&quot; data-w=&quot;750&quot;/&gt;&lt;/figure&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;strong&gt;小C&lt;/strong&gt;就会拿出刚刚的备忘录，找到&lt;strong&gt;坤坤&lt;/strong&gt;的等待处理的事务的第一条（当前场景只有一条）就是：创建 &lt;code&gt;/坤坤/日记&lt;/code&gt;。就马上把这个事务交给了&lt;strong&gt;小F&lt;/strong&gt;处理&lt;/p&gt;&lt;figure data-tool=&quot;mdnice编辑器&quot;&gt;&lt;img data-src=&quot;https://mmbiz.qpic.cn/mmbiz_png/xBgIbW1vdNPSwZU8icHpjrdbNEKuP5GG7nvoLtDNHG6h0VCDEvK4VFfRibbdK1tP1zvPUshekiaUpCCtlVV187vng/640?wx_fmt=png&quot; data-type=&quot;png&quot; data-ratio=&quot;0.5964391691394659&quot; data-w=&quot;674&quot;/&gt;&lt;/figure&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;strong&gt;小F&lt;/strong&gt;就会在小红本上把当前事务记录下来：&lt;/p&gt;&lt;figure data-tool=&quot;mdnice编辑器&quot;&gt;&lt;img data-src=&quot;https://mmbiz.qpic.cn/mmbiz_png/xBgIbW1vdNPSwZU8icHpjrdbNEKuP5GG7Tdxmr8m4NojjibCIvsIHvhpckYw6RAUYebshsOlPMJg2FOmeicQagOVQ/640?wx_fmt=png&quot; data-type=&quot;png&quot; data-ratio=&quot;0.43333333333333335&quot; data-w=&quot;810&quot;/&gt;&lt;/figure&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;交给&lt;strong&gt;小F&lt;/strong&gt;后，&lt;strong&gt;小C&lt;/strong&gt;发现&lt;strong&gt;坤坤的&lt;/strong&gt;所有事务都处理完了，就把他从备忘录上删除了：&lt;/p&gt;&lt;figure data-tool=&quot;mdnice编辑器&quot;&gt;&lt;img data-src=&quot;https://mmbiz.qpic.cn/mmbiz_png/xBgIbW1vdNPSwZU8icHpjrdbNEKuP5GG7F6bAgloLUp60vTEPJu6PdG3m9SsqAPBKSgp0m222HrSU21G3rT4Ccw/640?wx_fmt=png&quot; data-type=&quot;png&quot; data-ratio=&quot;0.7017326732673267&quot; data-w=&quot;808&quot;/&gt;&lt;/figure&gt;&lt;hr data-tool=&quot;mdnice编辑器&quot;/&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;让我们把视角再切到&lt;strong&gt;马小云&lt;/strong&gt;，&lt;strong&gt;马果果&lt;/strong&gt;这边的&lt;strong&gt;小C&lt;/strong&gt;在处理的时候，&lt;strong&gt;马小云&lt;/strong&gt;的话务员收到了来自&lt;strong&gt;马果果&lt;/strong&gt;的 COMMIT 消息并告诉了&lt;strong&gt;马小云&lt;/strong&gt;，而&lt;strong&gt;马小云&lt;/strong&gt;会从备忘录中找出最早的一条请求就是：坤坤，创建，&lt;code&gt;/坤坤/日记&lt;/code&gt;，然后就会把该请求交给&lt;strong&gt;小C&lt;/strong&gt;&lt;/p&gt;&lt;figure data-tool=&quot;mdnice编辑器&quot;&gt;&lt;img data-src=&quot;https://mmbiz.qpic.cn/mmbiz_png/xBgIbW1vdNPSwZU8icHpjrdbNEKuP5GG7UWxu08rDkEcvgWQlR15dsZ75WSIls5iaK575TYGZmbr50HzuCZEzMmA/640?wx_fmt=png&quot; data-type=&quot;png&quot; data-ratio=&quot;0.5592705167173252&quot; data-w=&quot;658&quot;/&gt;&lt;/figure&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;至于之后&lt;strong&gt;小C&lt;/strong&gt;处理以及处理完交给&lt;strong&gt;小F&lt;/strong&gt;处理，和&lt;strong&gt;马果果&lt;/strong&gt;那边的逻辑是一样的，就不赘述了。&lt;/p&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;至此，一个写请求（&lt;strong&gt;马果果&lt;/strong&gt;）的基本流程就算完成了。&lt;/p&gt;&lt;h3 data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span/&gt;4.4 一个写请求（马小云）&lt;span/&gt;&lt;/h3&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;假设我们的&lt;strong&gt;坤坤&lt;/strong&gt;这次来到&lt;strong&gt;马小云&lt;/strong&gt;的办事处，同样为自己创建一个事务登记 &lt;code&gt;/坤坤/日记&lt;/code&gt;&lt;/p&gt;&lt;figure data-tool=&quot;mdnice编辑器&quot;&gt;&lt;img data-src=&quot;https://mmbiz.qpic.cn/mmbiz_png/xBgIbW1vdNPSwZU8icHpjrdbNEKuP5GG7fnuKbb2ILTVyWIuazibUxvSANQ694wKxeNuvibUyzuic0GcicdAMqueOcw/640?wx_fmt=png&quot; data-type=&quot;png&quot; data-ratio=&quot;0.6805555555555556&quot; data-w=&quot;1080&quot;/&gt;&lt;/figure&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;strong&gt;小FR&lt;/strong&gt;先把请求交给了&lt;strong&gt;小C&lt;/strong&gt;，然后发现了&lt;strong&gt;坤坤&lt;/strong&gt;这次来办理的是写请求，就会要求话务员通知&lt;strong&gt;马果果&lt;/strong&gt;。&lt;/p&gt;&lt;figure data-tool=&quot;mdnice编辑器&quot;&gt;&lt;img data-src=&quot;https://mmbiz.qpic.cn/mmbiz_png/xBgIbW1vdNPSwZU8icHpjrdbNEKuP5GG7E5576iaRvrpaO5FHEv1ELjokndBap6jMI8CjpQ9pjnLTqE4JtLWZLVw/640?wx_fmt=png&quot; data-type=&quot;png&quot; data-ratio=&quot;0.36822429906542054&quot; data-w=&quot;1070&quot;/&gt;&lt;/figure&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;话务员就会打电话给&lt;strong&gt;马果果&lt;/strong&gt;办事处，并且告诉他们此次的请求以及携带上 REQUEST 暗号&lt;/p&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;而&lt;strong&gt;马小云&lt;/strong&gt;这边的&lt;strong&gt;小C&lt;/strong&gt;会和之前的例子一样，也会在备忘录里记录下&lt;/p&gt;&lt;figure data-tool=&quot;mdnice编辑器&quot;&gt;&lt;img data-src=&quot;https://mmbiz.qpic.cn/mmbiz_png/xBgIbW1vdNPSwZU8icHpjrdbNEKuP5GG74eHGp4xTYwlvk7cnKoZq7X25icVOnamGCKxbZMSwLZdIlmlyo4zkLibA/640?wx_fmt=png&quot; data-type=&quot;png&quot; data-ratio=&quot;0.7083333333333334&quot; data-w=&quot;1080&quot;/&gt;&lt;/figure&gt;&lt;hr data-tool=&quot;mdnice编辑器&quot;/&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;现在我们把视角切到&lt;strong&gt;马果果&lt;/strong&gt;这边，话务员接受到 REQUEST 的请求后，告诉了&lt;strong&gt;马果果&lt;/strong&gt;，而&lt;strong&gt;马果果&lt;/strong&gt;会直接把这个请求交给&lt;strong&gt;小P&lt;/strong&gt;去处理&lt;/p&gt;&lt;figure data-tool=&quot;mdnice编辑器&quot;&gt;&lt;img data-src=&quot;https://mmbiz.qpic.cn/mmbiz_png/xBgIbW1vdNPSwZU8icHpjrdbNEKuP5GG7KtKsFpoahRZuib9ltyagmgqx8jt80ibiaYNmWG5UVNWVQr5P107feibia6Q/640?wx_fmt=png&quot; data-type=&quot;png&quot; data-ratio=&quot;0.5388888888888889&quot; data-w=&quot;1080&quot;/&gt;&lt;/figure&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;仿佛就是&lt;strong&gt;坤坤&lt;/strong&gt;直接来自己办事处办理业务一样，从&lt;strong&gt;小P&lt;/strong&gt;之后的流程和之前的例子可以说是一模一样了，就不赘述了。&lt;/p&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;我现在举了 4 种无并发的场景，除了写请求都很简单，我这里就再把写请求&lt;strong&gt;马果果&lt;/strong&gt;重新用图画一遍&lt;/p&gt;&lt;figure data-tool=&quot;mdnice编辑器&quot;&gt;&lt;img data-src=&quot;https://mmbiz.qpic.cn/mmbiz_png/xBgIbW1vdNPSwZU8icHpjrdbNEKuP5GG78EmoxtYC3IafQXH8HbwrcoQUgqrDiax3CUOibibn0kKj64ecoERoK8AQA/640?wx_fmt=png&quot; data-type=&quot;png&quot; data-ratio=&quot;1.2435643564356436&quot; data-w=&quot;1010&quot;/&gt;&lt;/figure&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;为了简约图中省略了故事中的话务员以及&lt;strong&gt;马果果&lt;/strong&gt;和&lt;strong&gt;马小云&lt;/strong&gt;，相同颜色代表处于同一时间处理，时间顺序从小到大。&lt;/p&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;好了，让我们继续提升难度进入并发实战，作为一个公共的办事处是不可能同时只处理一件事务的！&lt;/p&gt;&lt;h3 data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span/&gt;4.5 多个村民多种请求&lt;span/&gt;&lt;/h3&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;这一章节我不会再从头开始画图了，只画重要的部分，我们先看看，如果有多个村民的话，那几个小本本是怎么记的吧！&lt;/p&gt;&lt;figure data-tool=&quot;mdnice编辑器&quot;&gt;&lt;img data-src=&quot;https://mmbiz.qpic.cn/mmbiz_png/xBgIbW1vdNPSwZU8icHpjrdbNEKuP5GG7QAAcDoHl1qtIlibeWGG6GibMr0940a2bTRZyaCNpQpa0icKpDg03ZVXKQ/640?wx_fmt=png&quot; data-type=&quot;png&quot; data-ratio=&quot;0.6940581542351454&quot; data-w=&quot;791&quot;/&gt;&lt;/figure&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;strong&gt;小C&lt;/strong&gt;的备忘录的特点总结：&lt;/p&gt;&lt;ul data-tool=&quot;mdnice编辑器&quot; class=&quot;list-paddingleft-2&quot;&gt;&lt;li&gt;&lt;section&gt;以村民作为 key，之后的请求是按照请求的顺序摆放的队列&lt;/section&gt;&lt;/li&gt;&lt;li&gt;&lt;section&gt;队列中的第一个请求肯定是写请求，如果是读请求的话，就根本不会记录&lt;/section&gt;&lt;/li&gt;&lt;li&gt;&lt;section&gt;当村民对应的请求队列为空后，整条记录删除&lt;/section&gt;&lt;/li&gt;&lt;/ul&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;我们以图中的&lt;strong&gt;坤坤&lt;/strong&gt;举例，假设现在等待的请求是这样的（我省略了路径，这里只关心事务的类型）&lt;/p&gt;&lt;figure data-tool=&quot;mdnice编辑器&quot;&gt;&lt;img data-src=&quot;https://mmbiz.qpic.cn/mmbiz_png/xBgIbW1vdNPSwZU8icHpjrdbNEKuP5GG7QwrvnFhat3znCLX88A57v7vKAMTfFUZg1ISl4nibSKyh7QczTyHs25w/640?wx_fmt=png&quot; data-type=&quot;png&quot; data-ratio=&quot;0.2972222222222222&quot; data-w=&quot;1080&quot;/&gt;&lt;/figure&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;当第一个创建的请求入队后，之后的查询请求也无法被执行，都需要等到创建请求执行完毕后才能继续，所以当第一个创建的请求被提交后，之后的查询1、查询2、查询3会被立马按顺序移除出队列并执行，而查询4则需要等待前面的删除和创建全部提交后才会被执行。&lt;/p&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;这样的逻辑保证了，同一个客户端的请求是按照时间顺序执行的，不会出现后到的读请求先于前面的写请求执行，造成脏读，但是需要注意的是不同的客户端的顺序是无法保证的，很可能&lt;strong&gt;坤坤&lt;/strong&gt;的创建请求还未提交，之后&lt;strong&gt;东东&lt;/strong&gt;的查询操作就能被返回了。&lt;/p&gt;&lt;hr data-tool=&quot;mdnice编辑器&quot;/&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;strong&gt;马果果&lt;/strong&gt;的小本本如果有多条记录的话就是这样&lt;/p&gt;&lt;figure data-tool=&quot;mdnice编辑器&quot;&gt;&lt;img data-src=&quot;https://mmbiz.qpic.cn/mmbiz_png/xBgIbW1vdNPSwZU8icHpjrdbNEKuP5GG7gaSrRZZPjrcNueaNM7EObZ197yJOzfr2ej6tBvQt7R7ibqASHby8QOw/640?wx_fmt=png&quot; data-type=&quot;png&quot; data-ratio=&quot;1.184782608695652&quot; data-w=&quot;460&quot;/&gt;&lt;/figure&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;你可能会问：&lt;strong&gt;鸡太美&lt;/strong&gt;的那条记录不是归档完成了吗，为什么还在小本本里？因为 ZK 必须保证事务执行的顺序！所以只要有比当前事务编号小的其他事务仍然未提交，本事务就不能提交，图里就是&lt;strong&gt;鸡太美&lt;/strong&gt;必须等到&lt;strong&gt;坤坤&lt;/strong&gt;和&lt;strong&gt;东东&lt;/strong&gt;都提交完才能进行提交！&lt;/p&gt;&lt;hr data-tool=&quot;mdnice编辑器&quot;/&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;strong&gt;马小云&lt;/strong&gt;这边也有一个备忘录，如果有多条记录的话会是这样：&lt;/p&gt;&lt;figure data-tool=&quot;mdnice编辑器&quot;&gt;&lt;img data-src=&quot;https://mmbiz.qpic.cn/mmbiz_png/xBgIbW1vdNPSwZU8icHpjrdbNEKuP5GG7GVRRRE3Fop3sWoq5XZGt1Aa1ga4mVp8BTAVZxfsA7o1w5BoSxXLTTQ/640?wx_fmt=png&quot; data-type=&quot;png&quot; data-ratio=&quot;1.1704035874439462&quot; data-w=&quot;446&quot;/&gt;&lt;/figure&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;这个备忘录其实是一个先进先出的队列，每次&lt;strong&gt;马小云&lt;/strong&gt;的提交会从队列中移除最前面的一条记录来操作。&lt;/p&gt;&lt;hr data-tool=&quot;mdnice编辑器&quot;/&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;故事差不多讲完了，有些细节用程序员的语言再说一下，我其实省略了两个处理器 ：&lt;/p&gt;&lt;ul data-tool=&quot;mdnice编辑器&quot; class=&quot;list-paddingleft-2&quot;&gt;&lt;li&gt;&lt;section&gt;&lt;code&gt;ToBeAppliedRequestProcessor&lt;/code&gt;这个处理器在&lt;strong&gt;马果果&lt;/strong&gt;这边才是紧接着&lt;strong&gt;小C&lt;/strong&gt;的，但是我个人感觉下来没什么用就不讲了，大家有兴趣可以去了解下&lt;/section&gt;&lt;/li&gt;&lt;li&gt;&lt;section&gt;&lt;code&gt;LeaderRequestProcessor&lt;/code&gt; 这个处理器才是&lt;strong&gt;马果果&lt;/strong&gt;的第一个处理器，他的逻辑涉及到会话、ACL，其他就没什么用，留到之后有机会讲&lt;/section&gt;&lt;/li&gt;&lt;/ul&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;大家先看下这个图：&lt;/p&gt;&lt;figure data-tool=&quot;mdnice编辑器&quot;&gt;&lt;img data-src=&quot;https://mmbiz.qpic.cn/mmbiz_png/xBgIbW1vdNPSwZU8icHpjrdbNEKuP5GG7QicBwQtX4lpvZqpfRPSZEBGe0g2T6SIGXt3fHKcKKKTsGTYlU1MB80w/640?wx_fmt=png&quot; data-type=&quot;png&quot; data-ratio=&quot;0.8386524822695035&quot; data-w=&quot;564&quot;/&gt;&lt;/figure&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;用红框标记的都是线程对象，主要逻辑都在 &lt;code&gt;run&lt;/code&gt; 方法中，&lt;strong&gt;小P&lt;/strong&gt;和&lt;strong&gt;小S&lt;/strong&gt;我们之前就讲过了，这里就多了&lt;strong&gt;小C&lt;/strong&gt;和&lt;strong&gt;小FR&lt;/strong&gt;。这里我得提一下，但凡你们只要在 ZK 中看到线程对象，那么他基本上是使用了生产者-消费者的模型，对象内部维护了一个阻塞队列，我这次就不画图了，因为重要的逻辑之前都已经讲了。&lt;/p&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;画了这么多图，这里先进行下小结：&lt;/p&gt;&lt;ul data-tool=&quot;mdnice编辑器&quot; class=&quot;list-paddingleft-2&quot;&gt;&lt;li&gt;&lt;section&gt;&lt;strong&gt;马果果&lt;/strong&gt;就是我们平时在 ZK 中听到的 Leader 节点，负责对写事务请求发起提案并最终决定提交&lt;/section&gt;&lt;/li&gt;&lt;li&gt;&lt;section&gt;&lt;strong&gt;马小云&lt;/strong&gt;对应就是 ZK 中的 Follower，只能独自处理读请求，写请求需要转发给 Leader 去处理&lt;/section&gt;&lt;/li&gt;&lt;li&gt;&lt;section&gt;读请求无论客户端请求给哪个服务端的节点，处理流程都相对简单，可能几乎不需要节点之间的通信，自己就能处理（前提是没有待处理的写请求）&lt;/section&gt;&lt;/li&gt;&lt;li&gt;&lt;section&gt;写请求如果客户端请求到的是 Leader， Leader 就会对此次事务请求在集群中发起提案，接受到提案的 Follower 各自进行归档，并返回给 Leader 成功的 ACK 信息，Leader 对 ACK 进行统计，达到集群数量半数以上就集群中发起 COMMIT 请求，Follower 们接收到提交请求后，才会修改各自内存中的数据&lt;/section&gt;&lt;/li&gt;&lt;li&gt;&lt;section&gt;写请求如果客户端请求到的是 Follower，Follower 在本地做简单记录后就会把请求转发给 Leader 去处理，之后和上一条是一样的情况&lt;/section&gt;&lt;/li&gt;&lt;li&gt;&lt;section&gt;分布式事务的理论中是有回滚阶段的，当集群中的节点本地提交失败后，会通知 Leader 失败信息，而 Leader 统计 ACK 之后发现本次事务无法提交就会发送回滚的请求给各个节点。但是！很遗憾我并没有在 ZK 的源码中找到和事务回滚有关的逻辑（当然也很有可能是我疏忽了，如果你知道逻辑在哪儿的话，请一定告诉我），我现在的认为&lt;strong&gt;小S&lt;/strong&gt;处理归档的时候是不允许失败的，如果失败报错了，整个服务节点会报错退出&lt;/section&gt;&lt;/li&gt;&lt;/ul&gt;&lt;h2 data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span/&gt;&lt;span&gt;五、剧透&lt;/span&gt;&lt;span&gt; &lt;/span&gt;&lt;/h2&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;在本篇文章的最后，我们再看看动物村又发生了哪些故事吧。&lt;/p&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;strong&gt;马果果&lt;/strong&gt;毕竟年事已高，需要定期去医院进行体检，就会耽误办事处这边的工作，而渐渐的随着时间的推移，&lt;strong&gt;马小云&lt;/strong&gt;的业务能力越来越强了，心里就产生了：凭什么我要听这老头的？于是主动向村委会提议，建议 Leader 的人选要进行选举，不能就一直让&lt;strong&gt;马果果&lt;/strong&gt;占着这个位子，村委会听后也觉得很有道理，于是拉来&lt;strong&gt;马果果&lt;/strong&gt;一起商量，&lt;strong&gt;马果果&lt;/strong&gt;肯定不能同意啊，但是无奈&lt;strong&gt;马小云&lt;/strong&gt;毕竟是首富，很快就通过上下打点让村委会一致通过了这个建议&lt;/p&gt;&lt;figure data-tool=&quot;mdnice编辑器&quot;&gt;&lt;img data-src=&quot;https://mmbiz.qpic.cn/mmbiz_png/xBgIbW1vdNPSwZU8icHpjrdbNEKuP5GG7fUNBDltSWiccSOGnsIEuSbsEL5W1Ym9kat8OXD6lQicsAVoUXD0MQOiag/640?wx_fmt=png&quot; data-type=&quot;png&quot; data-ratio=&quot;1&quot; data-w=&quot;230&quot;/&gt;&lt;/figure&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;但是现在只有两个办事处，如果双方各执一词，就平票了，所以村委会再次经过商量决定引入第三个办事处，这个新办事处的负责人选择了村里的著名企业家&lt;strong&gt;马小腾&lt;/strong&gt;，这样就不会出现平票的情况，具体选举规则如下：&lt;/p&gt;&lt;ul data-tool=&quot;mdnice编辑器&quot; class=&quot;list-paddingleft-2&quot;&gt;&lt;li&gt;&lt;section&gt;每天三个办事处开张前必须要先投票选出一个 Leader&lt;/section&gt;&lt;/li&gt;&lt;li&gt;&lt;section&gt;Leader 必须是经手处理过事务编号最大的&lt;/section&gt;&lt;/li&gt;&lt;li&gt;&lt;section&gt;需要各个办事处半数以上的同意&lt;/section&gt;&lt;/li&gt;&lt;li&gt;&lt;section&gt;一切以 Leader 为主，读写请求遵守之前&lt;strong&gt;马果果&lt;/strong&gt;的定下的流程&lt;/section&gt;&lt;/li&gt;&lt;li&gt;&lt;section&gt;当 Leader 无法处理事务的时候，需要立即选出新的 Leader，选出之前办事处不能对外提供服务&lt;/section&gt;&lt;/li&gt;&lt;/ul&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;所以现在有了三个办事处成了这样&lt;/p&gt;&lt;figure data-tool=&quot;mdnice编辑器&quot;&gt;&lt;img data-src=&quot;https://mmbiz.qpic.cn/mmbiz_png/xBgIbW1vdNPSwZU8icHpjrdbNEKuP5GG7MrXuIFxNRBYTSsYK0DfL6acK5Ribl8HMffl8srmjNKvCW9uDYOicL4nw/640?wx_fmt=png&quot; data-type=&quot;png&quot; data-ratio=&quot;1.6704119850187267&quot; data-w=&quot;267&quot;/&gt;&lt;/figure&gt;&lt;hr data-tool=&quot;mdnice编辑器&quot;/&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;所以下一篇的主题大家应该知道了吧～就是：选举！会讲讲 ZK 集群是如何选举出 Leader。敬请期待吧～&lt;/p&gt;&lt;figure data-tool=&quot;mdnice编辑器&quot;&gt;&lt;img data-src=&quot;https://mmbiz.qpic.cn/mmbiz_gif/xBgIbW1vdNPSwZU8icHpjrdbNEKuP5GG7Vc3ibr2sYicHkQPiaSP4iaW8qpLlaVET79UIyJCH9SaOUkpOck8bJgmw4g/640?wx_fmt=gif&quot; data-type=&quot;gif&quot; data-ratio=&quot;1.134020618556701&quot; data-w=&quot;97&quot;/&gt;&lt;/figure&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;老规矩，如果你有任何对文章中的疑问也可以是建议或者是对 ZK 原理部分的疑问，欢迎来仓库中提 issue 给我们，或者来语雀话题讨论。&lt;/p&gt;&lt;blockquote data-tool=&quot;mdnice编辑器&quot;&gt;&lt;p&gt;地址：https://www.yuque.com/kaixin1002/yla8hz&lt;/p&gt;&lt;/blockquote&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;老哥们转评赞安排一下好吗，ZKr～&lt;/p&gt;&lt;p&gt;&lt;img class=&quot;rich_pages&quot; data-ratio=&quot;0.5625&quot; data-src=&quot;https://mmbiz.qpic.cn/mmbiz_gif/xBgIbW1vdNNcB6j6yzoz5mxCBFuodUSc9lvJgBeLjMaaMG2GxrHNd4Hia8DBBN2UC0yx0L1suzIK2tISHrwuPDA/640?wx_fmt=gif&quot; data-type=&quot;gif&quot; data-w=&quot;896&quot;/&gt;&lt;/p&gt;&lt;p&gt;&lt;/p&gt;&lt;p&gt;&lt;img data-ratio=&quot;0.08108108108108109&quot; data-type=&quot;png&quot; data-w=&quot;1258&quot; data-src=&quot;https://mmbiz.qpic.cn/mmbiz_png/wKOZZiacmHTc9LIKRXddrzz6MosLdiaH4EQNQgzsrSXHObdAia8yeIlLz6MbK9FxNDr44G7FNb2DBufqkjpwiczAibA/640?wx_fmt=png&quot;/&gt;&lt;/p&gt;&lt;/section&gt;&lt;/div&gt;&lt;/div&gt;</content:encoded>
</item>
<item>
<guid>cda9465b8b0a14bf3e451169d5caa19d</guid>
<title>美团外卖特征平台的建设与实践</title>
<link>https://toutiao.io/k/zwp7jms</link>
<content:encoded>&lt;div&gt;&lt;div&gt;&lt;section data-tool=&quot;mdnice编辑器&quot; data-website=&quot;https://www.mdnice.com&quot;&gt;&lt;h2 data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;&lt;strong&gt;1 背景&lt;/strong&gt;&lt;/span&gt;&lt;span/&gt;&lt;/h2&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;美团外卖业务种类繁多、场景丰富，根据业务特点可分为推荐、广告、搜索三大业务线以及数个子业务线，比如商家推荐、菜品推荐、列表广告、外卖搜索等等，满足了数亿用户对外卖服务的全方面需求。而在每条业务线的背后，都涉及用户、商家、平台三方面利益的平衡：用户需要精准的展现结果；商家需要尽可能多的曝光和转化；平台需要营收的最大化，而算法策略通过模型机制的优化迭代，合理地维护这三方面的利益平衡，促进生态良性发展。&lt;/span&gt;&lt;/p&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;随着业务的发展，外卖算法模型也在不断演进迭代中。从之前简单的线性模型、树模型，到现在复杂的深度学习模型，预估效果也变得愈发精准。这一切除了受益于模型参数的不断调优，也受益于外卖算法平台对算力增长的工程化支撑。外卖算法平台通过统一算法工程框架，解决了模型&amp;amp;特征迭代的系统性问题，极大地提升了外卖算法的迭代效率。&lt;/span&gt;&lt;/p&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;根据功能不同，外卖算法平台可划分为三部分：模型服务、模型训练和特征平台。其中，模型服务用于提供在线模型预估，模型训练用于提供模型的训练产出，特征平台则提供特征和样本的数据支撑。本文将重点阐述外卖特征平台在建设过程中遇到的挑战以及优化思路。&lt;/span&gt;&lt;/p&gt;&lt;figure data-tool=&quot;mdnice编辑器&quot;&gt;&lt;img data-cropselx1=&quot;0&quot; data-cropselx2=&quot;541&quot; data-cropsely1=&quot;0&quot; data-cropsely2=&quot;448&quot; data-ratio=&quot;0.8282899366643209&quot; data-src=&quot;https://mmbiz.qpic.cn/mmbiz_png/hEx03cFgUsWEuxGARmicXLyGYuZcYyU5OoibtLKm3UeOGJld1BLRPX8UNPfq5WeMQxu1xwVdoJ94jF3Sia3wT7GvQ/640?wx_fmt=png&quot; data-type=&quot;png&quot; data-w=&quot;1421&quot;/&gt;&lt;/figure&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;诚然，业界对特征系统的研究较为广泛，比如微信FeatureKV存储系统聚焦于解决特征数据快速同步问题，腾讯广告特征工程聚焦于解决机器学习平台中Pre-Trainer方面的问题，美团酒旅在线特征系统聚焦于解决高并发情形下的特征存取和生产调度问题，而外卖特征平台则聚焦于提供从样本生成-&amp;gt;特征生产-&amp;gt;特征计算的一站式链路，用于解决特征的快速迭代问题。&lt;/span&gt;&lt;/p&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;随着外卖业务的发展，特征体量也在快速增长，外卖平台面对的挑战和压力也不断增大。目前，平台已接入特征配置近万个，特征维度近50种，日处理特征数据量几十TB，日处理特征千亿量级，日调度任务数量达数百个。面对海量的数据资源，平台如何做到特征的快速迭代、特征的高效计算以及样本的配置化生成？下文将分享美团外卖在平台建设过程中的一些思考和优化思路，希望能对大家有所帮助或启发。&lt;/span&gt;&lt;/p&gt;&lt;h2 data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;&lt;strong&gt;2 特征框架演进&lt;/strong&gt;&lt;/span&gt;&lt;/h2&gt;&lt;h3 data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;2.1 旧框架的不足&lt;/span&gt;&lt;/h3&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;外卖业务发展初期，为了提升策略迭代效率，算法同学通过积累和提炼，整理出一套通用的特征生产框架，该框架由三部分组成：特征统计、特征推送和特征获取加载。如下图所示：&lt;/span&gt;&lt;/p&gt;&lt;figure data-tool=&quot;mdnice编辑器&quot;&gt;&lt;img data-cropselx1=&quot;0&quot; data-cropselx2=&quot;448&quot; data-cropsely1=&quot;0&quot; data-cropsely2=&quot;92&quot; data-ratio=&quot;0.20515267175572519&quot; data-src=&quot;https://mmbiz.qpic.cn/mmbiz_png/hEx03cFgUsWEuxGARmicXLyGYuZcYyU5OSy5F175B4AfpaSNP341wY90LjKSxxbdenlfTDxyHSQpP6ADP1S2BOA/640?wx_fmt=png&quot; data-type=&quot;png&quot; data-w=&quot;2096&quot;/&gt;&lt;/figure&gt;&lt;ul data-tool=&quot;mdnice编辑器&quot; class=&quot;list-paddingleft-2&quot;&gt;&lt;li&gt;&lt;section&gt;&lt;span&gt;&lt;strong&gt;特征统计&lt;/strong&gt;：基于基础数据表，框架支持统计多个时段内特定维度的总量、分布等统计类特征。&lt;/span&gt;&lt;/section&gt;&lt;/li&gt;&lt;li&gt;&lt;section&gt;&lt;span&gt;&lt;strong&gt;特征推送&lt;/strong&gt;：框架支持将Hive表里的记录映射成Domain对象，并将序列化后的结果写入KV存储。&lt;/span&gt;&lt;/section&gt;&lt;/li&gt;&lt;li&gt;&lt;section&gt;&lt;span&gt;&lt;strong&gt;特征获取加载&lt;/strong&gt;：框架支持在线从KV存储读取Domain对象，并将反序列化后的结果供模型预估使用。&lt;/span&gt;&lt;/section&gt;&lt;/li&gt;&lt;/ul&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;该框架应用在外卖多条业务线中，为算法策略的迭代提供了有力支撑。但随着外卖业务的发展，业务线的增多，数据体量的增大，该框架逐渐暴露以下三点不足：&lt;/span&gt;&lt;/p&gt;&lt;ul data-tool=&quot;mdnice编辑器&quot; class=&quot;list-paddingleft-2&quot;&gt;&lt;li&gt;&lt;section&gt;&lt;span&gt;&lt;strong&gt;特征迭代成本高&lt;/strong&gt;：框架缺乏配置化管理，新特征上线需要同时改动离线侧和在线侧代码，迭代周期较长。&lt;/span&gt;&lt;/section&gt;&lt;/li&gt;&lt;li&gt;&lt;section&gt;&lt;span&gt;&lt;strong&gt;特征复用困难&lt;/strong&gt;：外卖不同业务线间存在相似场景，使特征的复用成为可能，但框架缺乏对复用能力的很好支撑，导致资源浪费、特征价值无法充分发挥。&lt;/span&gt;&lt;/section&gt;&lt;/li&gt;&lt;li&gt;&lt;section&gt;&lt;span&gt;&lt;strong&gt;平台化能力缺失&lt;/strong&gt;：框架提供了特征读写的底层开发能力，但缺乏对特征迭代完整周期的平台化追踪和管理能力。&lt;/span&gt;&lt;/section&gt;&lt;/li&gt;&lt;/ul&gt;&lt;h3 data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;2.2 新平台的优势&lt;/span&gt;&lt;/h3&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;针对旧框架的不足，我们在2018年中旬开始着手搭建新版的特征平台，经过不断的摸索、实践和优化，平台功能逐渐完备，使特征迭代能力更上一层台阶。&lt;/span&gt;&lt;/p&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;特征平台框架由三部分组成：训练样本生成（&lt;/span&gt;&lt;span&gt;离线&lt;/span&gt;&lt;span&gt;）、特征生产（&lt;/span&gt;&lt;span&gt;近线&lt;/span&gt;&lt;span&gt;）以及特征获取计算（&lt;/span&gt;&lt;span&gt;在线&lt;/span&gt;&lt;span&gt;），如下图所示：&lt;/span&gt;&lt;/p&gt;&lt;figure data-tool=&quot;mdnice编辑器&quot;&gt;&lt;img data-cropselx1=&quot;1&quot; data-cropselx2=&quot;411&quot; data-cropsely1=&quot;0&quot; data-cropsely2=&quot;308&quot; data-ratio=&quot;0.7482057416267942&quot; data-src=&quot;https://mmbiz.qpic.cn/mmbiz_png/hEx03cFgUsWEuxGARmicXLyGYuZcYyU5O9ibYJByZquhbXdcO06FNu2quhbpp9FasK8nql19xorIGXunuAZRzpow/640?wx_fmt=png&quot; data-type=&quot;png&quot; data-w=&quot;1672&quot;/&gt;&lt;/figure&gt;&lt;ul data-tool=&quot;mdnice编辑器&quot; class=&quot;list-paddingleft-2&quot;&gt;&lt;li&gt;&lt;section&gt;&lt;span&gt;&lt;strong&gt;训练样本生成&lt;/strong&gt;：离线侧，平台提供统一配置化的训练样本生成能力，为模型的效果验证提供数据支撑。&lt;/span&gt;&lt;/section&gt;&lt;/li&gt;&lt;li&gt;&lt;section&gt;&lt;span&gt;&lt;strong&gt;特征生产&lt;/strong&gt;：近线侧，平台提供面对海量特征数据的加工、调度、存储、同步能力，保证特征数据在线快速生效。&lt;/span&gt;&lt;/section&gt;&lt;/li&gt;&lt;li&gt;&lt;section&gt;&lt;span&gt;&lt;strong&gt;特征获取计算&lt;/strong&gt;：在线侧，平台提供高可用的特征获取能力和高性能的特征计算能力，灵活支撑多种复杂模型的特征需求。&lt;/span&gt;&lt;/section&gt;&lt;/li&gt;&lt;/ul&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;目前，外卖特征平台已接入外卖多条业务线，涵盖数十个场景，为业务的策略迭代提供平台化支持。其中，平台的优势在于两点：&lt;/span&gt;&lt;/p&gt;&lt;ul data-tool=&quot;mdnice编辑器&quot; class=&quot;list-paddingleft-2&quot;&gt;&lt;li&gt;&lt;section&gt;&lt;span&gt;&lt;strong&gt;业务提效&lt;/strong&gt;：通过特征配置化管理能力、特征&amp;amp;算子&amp;amp;解决方案复用能力以及离线在线打通能力，提升了特征迭代效率，降低了业务的接入成本，助力业务快速拿到结果。&lt;/span&gt;&lt;/section&gt;&lt;/li&gt;&lt;li&gt;&lt;section&gt;&lt;span&gt;&lt;strong&gt;业务赋能&lt;/strong&gt;：平台以统一的标准建立特征效果评估体系，有助于特征在业务间的借鉴和流通，最大程度发挥出特征的价值。&lt;/span&gt;&lt;/section&gt;&lt;/li&gt;&lt;/ul&gt;&lt;h2 data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;&lt;strong&gt;3 特征平台建设&lt;/strong&gt;&lt;/span&gt;&lt;/h2&gt;&lt;h3 data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;3.1 特征生产：海量特征的生产能力&lt;/span&gt;&lt;/h3&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;特征同步的方式有多种，业界常见做法是通过开发MR任务/Spark任务/使用同步组件，从多个数据源读取多个字段，并将聚合的结果同步至KV存储。这种做法实现简单，但存在以下问题：&lt;/span&gt;&lt;/p&gt;&lt;ul data-tool=&quot;mdnice编辑器&quot; class=&quot;list-paddingleft-2&quot;&gt;&lt;li&gt;&lt;section&gt;&lt;span&gt;&lt;strong&gt;特征重复拉取&lt;/strong&gt;：同一特征被不同任务使用时，会导致特征被重复拉取，造成资源浪费。&lt;/span&gt;&lt;/section&gt;&lt;/li&gt;&lt;li&gt;&lt;section&gt;&lt;span&gt;&lt;strong&gt;缺乏全局调度&lt;/strong&gt;：同步任务间彼此隔离，相互独立，缺乏多任务的全局调度管理机制，无法进行特征复用、增量更新、全局限流等操作，影响特征的同步速度。&lt;/span&gt;&lt;/section&gt;&lt;/li&gt;&lt;li&gt;&lt;section&gt;&lt;span&gt;&lt;strong&gt;存储方式不够灵活健壮&lt;/strong&gt;：新特征存储时，涉及到上下游代码/文件的改动，迭代成本高，特征数据异常时，需长时间重导旧数据，回滚效率较低。&lt;/span&gt;&lt;/section&gt;&lt;/li&gt;&lt;/ul&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;围绕上述几点问题，本文将从三个方面进行特征生产核心机制的介绍：&lt;/span&gt;&lt;/p&gt;&lt;ul data-tool=&quot;mdnice编辑器&quot; class=&quot;list-paddingleft-2&quot;&gt;&lt;li&gt;&lt;section&gt;&lt;span&gt;&lt;strong&gt;特征语义机制&lt;/strong&gt;：用于解决平台从数百个数据源进行特征拉取和转化的效率问题。&lt;/span&gt;&lt;/section&gt;&lt;/li&gt;&lt;li&gt;&lt;section&gt;&lt;span&gt;&lt;strong&gt;特征多任务调度机制&lt;/strong&gt;：用于解决海量特征数据的快速同步问题。&lt;/span&gt;&lt;/section&gt;&lt;/li&gt;&lt;li&gt;&lt;section&gt;&lt;span&gt;&lt;strong&gt;特征存储机制&lt;/strong&gt;：用于解决特征存储在配置化和可靠性方面的问题。&lt;/span&gt;&lt;/section&gt;&lt;/li&gt;&lt;/ul&gt;&lt;h4 data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;3.1.1 特征语义&lt;/span&gt;&lt;/h4&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;特征平台目前已接入上游Hive表数百个、特征配置近万个，其中大部分特征都需天级别的更新。那平台如何从上游高效地拉取特征呢？直观想法是从特征配置和上游Hive表两个角度进行考虑：&lt;/span&gt;&lt;/p&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;&lt;strong&gt;特征配置角度&lt;/strong&gt;：平台根据每个特征配置，单独启动任务进行特征拉取。&lt;/span&gt;&lt;/p&gt;&lt;ul data-tool=&quot;mdnice编辑器&quot; class=&quot;list-paddingleft-2&quot;&gt;&lt;li&gt;&lt;section&gt;&lt;span&gt;优点：控制灵活。&lt;/span&gt;&lt;/section&gt;&lt;/li&gt;&lt;li&gt;&lt;section&gt;&lt;span&gt;缺点：每个特征都会启动各自的拉取任务，执行效率低且耗费资源。&lt;/span&gt;&lt;/section&gt;&lt;/li&gt;&lt;/ul&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;&lt;strong&gt;上游Hive表角度&lt;/strong&gt;：Hive表中多个特征字段，统一放至同一任务中拉取。&lt;/span&gt;&lt;/p&gt;&lt;ul data-tool=&quot;mdnice编辑器&quot; class=&quot;list-paddingleft-2&quot;&gt;&lt;li&gt;&lt;section&gt;&lt;span&gt;优点：任务数量可控，资源占用低。&lt;/span&gt;&lt;/section&gt;&lt;/li&gt;&lt;li&gt;&lt;section&gt;&lt;span&gt;缺点：任务逻辑耦合较重，新增特征时需感知Hive表其它字段拉取逻辑，导致接入成本高。&lt;/span&gt;&lt;/section&gt;&lt;/li&gt;&lt;/ul&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;上述两种方案都存在各自问题，不能很好满足业务需求。因此，特征平台结合两个方案的优点，并经过探索分析，提出了特征语义的概念：&lt;/span&gt;&lt;/p&gt;&lt;ul data-tool=&quot;mdnice编辑器&quot; class=&quot;list-paddingleft-2&quot;&gt;&lt;li&gt;&lt;section&gt;&lt;span&gt;&lt;strong&gt;特征语义&lt;/strong&gt;：由特征配置中的上游Hive表、特征维度、特征过滤条件、特征聚合条件四个字段提取合并而成，本质就是相同的查询条件，比如：Select &lt;strong&gt;KeyInHive&lt;/strong&gt;,f1,f2 From &lt;strong&gt;HiveSrc&lt;/strong&gt; Where &lt;strong&gt;Condition&lt;/strong&gt; Group by &lt;strong&gt;Group&lt;/strong&gt;，此时该四个字段配置相同，可将F1、F2两个特征的获取过程可合并为一个SQL语句进行查询，从而减少整体查询次数。另外，平台将语义合并过程做成自动化透明化，接入方只需关心新增特征的拉取逻辑，无需感知同表其它字段，从而降低接入成本。&lt;/span&gt;&lt;/section&gt;&lt;/li&gt;&lt;/ul&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;特征平台对特征语义的处理分为两个阶段：语义抽取和语义合并，如下图所示：&lt;/span&gt;&lt;/p&gt;&lt;figure data-tool=&quot;mdnice编辑器&quot;&gt;&lt;img data-cropselx1=&quot;0&quot; data-cropselx2=&quot;541&quot; data-cropsely1=&quot;0&quot; data-cropsely2=&quot;198&quot; data-ratio=&quot;0.3650717703349282&quot; data-src=&quot;https://mmbiz.qpic.cn/mmbiz_png/hEx03cFgUsWEuxGARmicXLyGYuZcYyU5Os1FH2aqkZIo3UhsCcPZB3fiaGPrnJhXd5dUCfgJycYsUCln4KeUngGQ/640?wx_fmt=png&quot; data-type=&quot;png&quot; data-w=&quot;2090&quot;/&gt;&lt;/figure&gt;&lt;ul data-tool=&quot;mdnice编辑器&quot; class=&quot;list-paddingleft-2&quot;&gt;&lt;li&gt;&lt;section&gt;&lt;span&gt;&lt;strong&gt;语义抽取&lt;/strong&gt;：平台解析特征配置，构建SQL语法树，通过支持多种形式判同逻辑（&lt;span&gt;比如交换律、等效替换等规则&lt;/span&gt;），生成可唯一化表达的SQL语句。&lt;/span&gt;&lt;/section&gt;&lt;/li&gt;&lt;li&gt;&lt;section&gt;&lt;span&gt;&lt;strong&gt;语义合并&lt;/strong&gt;：如果不同特征对应的语义相同，平台会将其抽取过程进行合并，比如：Select KeyInHive, &lt;strong&gt;Extract1 as f1&lt;/strong&gt;, &lt;strong&gt;Extract2 as f2&lt;/strong&gt; From HiveSrc Where Condition Group by Group，其中Extract即特征的抽取逻辑，f1和f2的抽取逻辑可进行合并，并将最终抽取到的特征数据落地至特征共享表中存储，供多业务方使用。&lt;/span&gt;&lt;/section&gt;&lt;/li&gt;&lt;/ul&gt;&lt;h4 data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;3.1.2 特征多任务调度&lt;/span&gt;&lt;/h4&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;为了保证每天数十TB数据量的快速同步，特征平台首先按照特征的处理流程：获取、聚合和同步，分别制定了特征语义任务、特征聚合任务和特征同步任务：&lt;/span&gt;&lt;/p&gt;&lt;ul data-tool=&quot;mdnice编辑器&quot; class=&quot;list-paddingleft-2&quot;&gt;&lt;li&gt;&lt;section&gt;&lt;span&gt;&lt;strong&gt;特征语义任务&lt;/strong&gt;：用于将特征数据从数据源拉取解析，并落地至特征共享表中。&lt;/span&gt;&lt;/section&gt;&lt;/li&gt;&lt;li&gt;&lt;section&gt;&lt;span&gt;&lt;strong&gt;特征聚合任务&lt;/strong&gt;：用于不同业务线（&lt;/span&gt;&lt;span&gt;租户&lt;/span&gt;&lt;span&gt;）按照自身需求，从特征共享表中获取特定特征并聚合，生成全量快照以及增量数据。&lt;/span&gt;&lt;/section&gt;&lt;/li&gt;&lt;li&gt;&lt;section&gt;&lt;span&gt;&lt;strong&gt;特征同步任务&lt;/strong&gt;：用于将增量数据（&lt;/span&gt;&lt;span&gt;天级&lt;/span&gt;&lt;span&gt;）和全量数据（&lt;/span&gt;&lt;span&gt;定期&lt;/span&gt;&lt;span&gt;）同步至KV存储中。&lt;/span&gt;&lt;/section&gt;&lt;/li&gt;&lt;/ul&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;同时，特征平台搭建了多任务调度机制，将不同类型的任务进行调度串联，以提升特征同步的时效性，如下图所示：&lt;/span&gt;&lt;/p&gt;&lt;figure data-tool=&quot;mdnice编辑器&quot;&gt;&lt;img data-cropselx1=&quot;0&quot; data-cropselx2=&quot;378&quot; data-cropsely1=&quot;0&quot; data-cropsely2=&quot;340&quot; data-ratio=&quot;0.8990353697749196&quot; data-src=&quot;https://mmbiz.qpic.cn/mmbiz_png/hEx03cFgUsWEuxGARmicXLyGYuZcYyU5Oj7g9GECnRqupVpHeV6iaVrK60pGOYCCwav7jYvfPTp9RUfoESQsNb2w/640?wx_fmt=png&quot; data-type=&quot;png&quot; data-w=&quot;1555&quot;/&gt;&lt;/figure&gt;&lt;ul data-tool=&quot;mdnice编辑器&quot; class=&quot;list-paddingleft-2&quot;&gt;&lt;li&gt;&lt;section&gt;&lt;span&gt;&lt;strong&gt;任务调度器&lt;/strong&gt;：按照任务执行顺序，循环检测上游任务状态，保证任务的有序执行。&lt;/span&gt;&lt;/section&gt;&lt;/li&gt;&lt;li&gt;&lt;section&gt;&lt;span&gt;&lt;strong&gt;特征语义任务调度&lt;/strong&gt;：当上游Hive表就绪后，执行语义任务。&lt;/span&gt;&lt;/section&gt;&lt;/li&gt;&lt;ul class=&quot;list-paddingleft-2&quot;&gt;&lt;li&gt;&lt;section&gt;&lt;span&gt;上游监测：通过上游任务调度接口实时获取上游Hive表就绪状态，就绪即拉取，保证特征拉取的时效性。&lt;/span&gt;&lt;/section&gt;&lt;/li&gt;&lt;li&gt;&lt;section&gt;&lt;span&gt;语义优先级：每个语义都会设置优先级，高优先级语义对应的特征会被优先聚合和同步，保证重要特征的及时更新。&lt;/span&gt;&lt;/section&gt;&lt;/li&gt;&lt;li&gt;&lt;section&gt;&lt;span&gt;队列优选：平台会获取多个队列的实时状态，并优先选择可用资源最多的队列执行语义任务，提升任务执行效率。&lt;/span&gt;&lt;/section&gt;&lt;/li&gt;&lt;/ul&gt;&lt;li&gt;&lt;section&gt;&lt;span&gt;&lt;strong&gt;特征复用&lt;/strong&gt;：特征的价值在于复用，特征只需接入平台一次，就可在不同业务间流通，是一种业务赋能的体现。&lt;/span&gt;&lt;/section&gt;&lt;/li&gt;&lt;ul class=&quot;list-paddingleft-2&quot;&gt;&lt;li&gt;&lt;section&gt;&lt;span&gt;特征统一存储在特征共享表中，供下游不同业务方按需读取，灵活使用。&lt;/span&gt;&lt;/section&gt;&lt;/li&gt;&lt;li&gt;&lt;section&gt;&lt;span&gt;特征的统一接入复用，避免相同数据的重复计算和存储，节省资源开销。&lt;/span&gt;&lt;/section&gt;&lt;/li&gt;&lt;/ul&gt;&lt;li&gt;&lt;section&gt;&lt;span&gt;&lt;strong&gt;特征聚合任务调度&lt;/strong&gt;：当上游语义任务就绪后，执行聚合任务。&lt;/span&gt;&lt;/section&gt;&lt;/li&gt;&lt;ul class=&quot;list-paddingleft-2&quot;&gt;&lt;li&gt;&lt;section&gt;&lt;span&gt;多租户机制：多租户是平台面向多业务接入的基础，业务以租户为单位进行特征管理，并为平台分摊计算资源和存储资源。&lt;/span&gt;&lt;/section&gt;&lt;/li&gt;&lt;li&gt;&lt;section&gt;&lt;span&gt;特征分组：特征分组将相同维度下的多个特征进行聚合，以减少特征Key的数量，避免大量Key读写对KV存储性能造成的影响。&lt;/span&gt;&lt;/section&gt;&lt;/li&gt;&lt;li&gt;&lt;section&gt;&lt;span&gt;全量快照：平台通过天级别聚合的方式生成特征全量快照，一方面便于增量数据探查，另一方面也避免历史数据的丢失。&lt;/span&gt;&lt;/section&gt;&lt;/li&gt;&lt;li&gt;&lt;section&gt;&lt;span&gt;增量探查：通过将最新特征数据与全量快照的数值对比，探查出发生变化的特征，便于后续增量同步。&lt;/span&gt;&lt;/section&gt;&lt;/li&gt;&lt;li&gt;&lt;section&gt;&lt;span&gt;特征补偿：因就绪延迟而未被当天同步的特征，可跨天进行补偿同步，避免出现特征跨天丢失的问题。&lt;/span&gt;&lt;/section&gt;&lt;/li&gt;&lt;/ul&gt;&lt;li&gt;&lt;section&gt;&lt;span&gt;&lt;strong&gt;特征同步任务调度&lt;/strong&gt;：当上游聚合任务就绪后，执行同步任务。&lt;/span&gt;&lt;/section&gt;&lt;/li&gt;&lt;ul class=&quot;list-paddingleft-2&quot;&gt;&lt;li&gt;&lt;section&gt;&lt;span&gt;增量同步：将经全量快照探查到的增量数据，同步写入KV存储，大大降低数据写入量，提升同步效率。&lt;/span&gt;&lt;/section&gt;&lt;/li&gt;&lt;li&gt;&lt;section&gt;&lt;span&gt;全量刷新：KV存储中的数据由于过期时间限制，需定期进行全量刷新，避免出现特征过期导致的数据丢失问题。&lt;/span&gt;&lt;/section&gt;&lt;/li&gt;&lt;li&gt;&lt;section&gt;&lt;span&gt;全局限流：通过监测同步任务的并行度以及KV存储状态指标，实时调整全局同步速度，在保证KV存储稳定性前提下，充分利用可用资源来提升特征同步效率。&lt;/span&gt;&lt;/section&gt;&lt;/li&gt;&lt;/ul&gt;&lt;/ul&gt;&lt;h4 data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;3.1.3 特征存储&lt;/span&gt;&lt;/h4&gt;&lt;h5 data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;3.1.3.1 特征动态序列化&lt;/span&gt;&lt;/h5&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;特征数据通过聚合处理后，需存储到HDFS/KV系统中，用于后续任务/服务的使用。数据的存储会涉及到存储格式的选型，业界常见的存储格式有JSON、Object、Protobuf等，其中JSON配置灵活，Object支持自定义结构，Protobuf编码性能好且压缩比高。由于特征平台支持的数据类型较为固定，但对序列化反序列化性能以及数据压缩效果有较高要求，因此选择Protobuf作为特征存储格式。&lt;/span&gt;&lt;/p&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;Protobuf的常规使用方式是通过Proto文件维护特征配置。新增特征需编辑Proto文件，并编译生成新版本JAR包，在离线&amp;amp;在线同时发布更新后，才能生产解析新增特征，导致迭代成本较高。Protobuf也提供了动态自描述和反射机制，帮助生产侧和消费侧动态适配消息格式的变更，避免静态编译带来的JAR包升级成本，但代价是空间成本和性能成本均高于静态编译方式，不适用于高性能、低时延的线上场景。&lt;/span&gt;&lt;/p&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;针对该问题，特征平台从特征元数据管理的角度，设计了一种基于Protobuf的特征动态序列化机制，在不影响读写性能前提下，做到对新增特征读写的完全配置化。&lt;/span&gt;&lt;/p&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;为方便阐述，先概述下Protobuf编码格式。如下图所示，Protobuf按“键-值”形式序列化每个属性，其中键标识了该属性的序号和类型。可以看出，从原理上，序列化主要要依赖键中定义的字段序号和类型。&lt;/span&gt;&lt;/p&gt;&lt;figure data-tool=&quot;mdnice编辑器&quot;&gt;&lt;img data-cropselx1=&quot;0&quot; data-cropselx2=&quot;541&quot; data-cropsely1=&quot;0&quot; data-cropsely2=&quot;107&quot; data-ratio=&quot;0.19780743565300285&quot; data-src=&quot;https://mmbiz.qpic.cn/mmbiz_png/hEx03cFgUsWEuxGARmicXLyGYuZcYyU5O2sp49o0td2H5sgafBVLbYiaPBiaPVeib4icJfQxYJPnmBB9AeIy5bt3ltQ/640?wx_fmt=png&quot; data-type=&quot;png&quot; data-w=&quot;2098&quot;/&gt;&lt;/figure&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;因此，特征平台通过从元数据管理接口查询元数据，来替换常规的Proto文件配置方式，去动态填充和解析键中定义的字段序号和类型，以完成序列化和反序列化，如下图所示：&lt;/span&gt;&lt;/p&gt;&lt;figure data-tool=&quot;mdnice编辑器&quot;&gt;&lt;img data-cropselx1=&quot;0&quot; data-cropselx2=&quot;541&quot; data-cropsely1=&quot;0&quot; data-cropsely2=&quot;212&quot; data-ratio=&quot;0.3922599139990444&quot; data-src=&quot;https://mmbiz.qpic.cn/mmbiz_png/hEx03cFgUsWEuxGARmicXLyGYuZcYyU5O3WrZrMibs56Lop7Rm4zxkPMjE9raNZVUsYRXSSJz2VCONkNeJZYUz7w/640?wx_fmt=png&quot; data-type=&quot;png&quot; data-w=&quot;2093&quot;/&gt;&lt;/figure&gt;&lt;ul data-tool=&quot;mdnice编辑器&quot; class=&quot;list-paddingleft-2&quot;&gt;&lt;li&gt;&lt;section&gt;&lt;span&gt;&lt;strong&gt;特征序列化&lt;/strong&gt;：通过查询特征元数据，获取特征的序号和类型，将特征序号填充至键的序号属性中，并根据特征类型决定键的类型属性以及特征值的填充方式。&lt;/span&gt;&lt;/section&gt;&lt;/li&gt;&lt;li&gt;&lt;section&gt;&lt;span&gt;&lt;strong&gt;特征反序列化&lt;/strong&gt;：解析键的属性，获取特征序号，通过查询特征元数据，获取对应的特征类型，并根据特征类型决定特征值的解析方式（&lt;/span&gt;&lt;span&gt;定长/变长&lt;/span&gt;&lt;span&gt;）。&lt;/span&gt;&lt;/section&gt;&lt;/li&gt;&lt;/ul&gt;&lt;h5 data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;3.1.3.2 特征多版本&lt;/span&gt;&lt;/h5&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;特征数据存储于KV系统中，为在线服务提供特征的实时查询。业界常见的特征在线存储方式有两种：单一版本存储和多版本存储。&lt;/span&gt;&lt;/p&gt;&lt;ul data-tool=&quot;mdnice编辑器&quot; class=&quot;list-paddingleft-2&quot;&gt;&lt;li&gt;&lt;section&gt;&lt;span&gt;单一版本存储即覆盖更新，用新数据直接覆盖旧数据，实现简单，对物理存储占用较少，但在数据异常的时候无法快速回滚。&lt;/span&gt;&lt;/section&gt;&lt;/li&gt;&lt;li&gt;&lt;section&gt;&lt;span&gt;多版本存储相比前者，增加了版本概念，每一份数据都对应特定版本，虽然物理存储占用较多，但在数据异常的时候可通过版本切换的方式快速回滚，保证线上稳定性。&lt;/span&gt;&lt;/section&gt;&lt;/li&gt;&lt;/ul&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;因此，特征平台选择特征多版本作为线上数据存储方式。&lt;/span&gt;&lt;/p&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;传统的多版本方式是通过全量数据的切换实现，即每天在全量数据写入后再进行版本切换。然而，特征平台存在增量和全量两种更新方式，不能简单复用全量的切换方式，需考虑增量和全量的依赖关系。因此，特征平台设计了一种适用于增量&amp;amp;全量两种更新方式下的版本切换方式（&lt;/span&gt;&lt;span&gt;如下图所示&lt;/span&gt;&lt;span&gt;）。该方式以全量数据为基础，白天进行增量更新，版本保持不变，在增量更新结束后，定期进行全量更新（&lt;/span&gt;&lt;span&gt;重写&lt;/span&gt;&lt;span&gt;），并进行版本切换。&lt;/span&gt;&lt;/p&gt;&lt;figure data-tool=&quot;mdnice编辑器&quot;&gt;&lt;img data-cropselx1=&quot;1&quot; data-cropselx2=&quot;418&quot; data-cropsely1=&quot;0&quot; data-cropsely2=&quot;309&quot; data-ratio=&quot;0.7422920302501455&quot; data-src=&quot;https://mmbiz.qpic.cn/mmbiz_png/hEx03cFgUsWEuxGARmicXLyGYuZcYyU5Oka6FosaUhJBtWmrnyhBQcNCljRGchAdVS3oCAEDx15q4dAlx74VCNw/640?wx_fmt=png&quot; data-type=&quot;png&quot; data-w=&quot;1719&quot;/&gt;&lt;/figure&gt;&lt;h3 data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;3.2 特征获取计算：高性能的特征获取计算能力&lt;/span&gt;&lt;/h3&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;特征获取计算为模型服务、业务系统、离线训练提供特征的实时获取能力和高性能的计算能力，是特征平台能力输出的重要途径。&lt;/span&gt;&lt;/p&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;旧框架中，特征处理分散在业务系统中，与业务逻辑耦合严重，随着模型规模增长和业务系统的架构升级，特征处理性能逐渐成为瓶颈，主要存在以下问题：&lt;/span&gt;&lt;/p&gt;&lt;ul data-tool=&quot;mdnice编辑器&quot; class=&quot;list-paddingleft-2&quot;&gt;&lt;li&gt;&lt;section&gt;&lt;span&gt;&lt;strong&gt;需要代码开发&lt;/strong&gt;：特征处理的代码冗长，一方面会造成易增难改的现象，另一方面相同逻辑代码重复拷贝较多，也会造成复用性逐渐变差，代码质量就会持续恶化。&lt;/span&gt;&lt;/section&gt;&lt;/li&gt;&lt;li&gt;&lt;section&gt;&lt;span&gt;&lt;strong&gt;潜在性能风险&lt;/strong&gt;：大量实验同时进行，每次处理特征并集，性能会互相拖累。&lt;/span&gt;&lt;/section&gt;&lt;/li&gt;&lt;li&gt;&lt;section&gt;&lt;span&gt;&lt;strong&gt;一致性难以保证&lt;/strong&gt;：离线训练样本和在线预估对特征的处理逻辑难以统一。&lt;/span&gt;&lt;/section&gt;&lt;/li&gt;&lt;/ul&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;因此，我们在新平台建设中，将特征处理逻辑抽象成独立模块，并对模块的职责边界做了清晰设定：通过提供统一API的方式，只负责特征的获取和计算，而不关心业务流程上下文。在新的特征获取和计算模块设计中，我们主要关注以下两个方面：&lt;/span&gt;&lt;/p&gt;&lt;ul data-tool=&quot;mdnice编辑器&quot; class=&quot;list-paddingleft-2&quot;&gt;&lt;li&gt;&lt;section&gt;&lt;span&gt;&lt;strong&gt;易用性&lt;/strong&gt;：特征处理配置的易用性会影响到使用方的迭代效率，如果新增特征或更改特征计算逻辑需要代码改动，势必会拖慢迭代效率。&lt;/span&gt;&lt;/section&gt;&lt;/li&gt;&lt;li&gt;&lt;section&gt;&lt;span&gt;&lt;strong&gt;性能&lt;/strong&gt;：特征处理过程需要实时处理大量特征的拉取和计算逻辑，其效率会直接影响到上游服务的整体性能。&lt;/span&gt;&lt;/section&gt;&lt;/li&gt;&lt;/ul&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;围绕以上两点，本文将从下述两个方面分别介绍特征获取计算部分：&lt;/span&gt;&lt;/p&gt;&lt;ul data-tool=&quot;mdnice编辑器&quot; class=&quot;list-paddingleft-2&quot;&gt;&lt;li&gt;&lt;section&gt;&lt;span&gt;&lt;strong&gt;模型特征自描述MFDL&lt;/strong&gt;：将特征计算流程配置化，提升特征使用的易用性。&lt;/span&gt;&lt;/section&gt;&lt;/li&gt;&lt;li&gt;&lt;section&gt;&lt;span&gt;&lt;strong&gt;特征获取流程&lt;/strong&gt;：统一特征获取流程，解决特征获取的性能问题。&lt;/span&gt;&lt;/section&gt;&lt;/li&gt;&lt;/ul&gt;&lt;h4 data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;3.2.1 模型特征自描述MFDL&lt;/span&gt;&lt;/h4&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;模型特征处理是模型预处理的一部分，业界常用的做法有：&lt;/span&gt;&lt;/p&gt;&lt;ul data-tool=&quot;mdnice编辑器&quot; class=&quot;list-paddingleft-2&quot;&gt;&lt;li&gt;&lt;section&gt;&lt;p&gt;&lt;span&gt;将特征处理逻辑和模型打包在一起，使用PMML或类似格式描述。优点是配置简洁；缺点是无法单独更新模型文件或特征配置。&lt;/span&gt;&lt;/p&gt;&lt;/section&gt;&lt;/li&gt;&lt;li&gt;&lt;section&gt;&lt;p&gt;&lt;span&gt;将特征处理逻辑和模型隔离，特征处理部分使用单独的配置描述，比如JSON或CSV等格式。优点是特征处理配置和模型文件分离，便于分开迭代；缺点是可能会引起特征配置和模型加载不一致性的问题，增加系统复杂度。&lt;/span&gt;&lt;/p&gt;&lt;/section&gt;&lt;/li&gt;&lt;/ul&gt;&lt;section&gt;&lt;p&gt;&lt;span&gt;考虑到对存量模型的兼容，我们定义了一套自有的配置格式，能独立于模型文件之外快速配置。基于对原有特征处理逻辑的梳理，我们将特征处理过程抽象成以下两个部分：&lt;/span&gt;&lt;/p&gt;&lt;/section&gt;&lt;ul data-tool=&quot;mdnice编辑器&quot; class=&quot;list-paddingleft-2&quot;&gt;&lt;li&gt;&lt;section&gt;&lt;p&gt;&lt;strong&gt;&lt;span&gt;模型特征计算&lt;/span&gt;&lt;/strong&gt;&lt;span&gt;：主要用来描述特征的计算过程。这里区分了原始特征和模型特征：将从数据源直接获取到的特征称之为原始特征，将经过计算后输入给模型的特征称之为模型特征，这样就可以实现同一个原始特征经过不同的处理逻辑计算出不同的模型特征。&lt;/span&gt;&lt;/p&gt;&lt;/section&gt;&lt;/li&gt;&lt;li&gt;&lt;section&gt;&lt;p&gt;&lt;strong&gt;&lt;span&gt;模型特征转换&lt;/span&gt;&lt;/strong&gt;&lt;span&gt;：将生成的模型特征根据配置转换成可以直接输入给模型的数据格式。由于模型特征计算的结果不能被模型直接使用，还需要经过一些转换逻辑的处理，比如转换成Tensor、Matrix等格式。&lt;/span&gt;&lt;/p&gt;&lt;/section&gt;&lt;/li&gt;&lt;/ul&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;基于该两点，特征平台设计了MFDL（&lt;/span&gt;&lt;span&gt;Model Feature Description Language&lt;/span&gt;&lt;span&gt;）来完整的描述模型特征的生成流程，用配置化的方式描述模型特征计算和转换过程。其中，特征计算部分通过自定义的DSL来描述，而特征转换部分则针对不同类型的模型设计不同的配置项。通过将特征计算和转换分离，就可以很方便的扩展支持不同的机器学习框架或模型结构。&lt;/span&gt;&lt;/p&gt;&lt;figure data-tool=&quot;mdnice编辑器&quot;&gt;&lt;img data-cropselx1=&quot;1&quot; data-cropselx2=&quot;498&quot; data-cropsely1=&quot;0&quot; data-cropsely2=&quot;160&quot; data-ratio=&quot;0.32344497607655504&quot; data-src=&quot;https://mmbiz.qpic.cn/mmbiz_png/hEx03cFgUsWEuxGARmicXLyGYuZcYyU5ODuzr2HViao3lU57Q8pakBCAvK84fSgNLvuqNcCWbOHWgwfKicaNsCaeQ/640?wx_fmt=png&quot; data-type=&quot;png&quot; data-w=&quot;2090&quot;/&gt;&lt;/figure&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;在MFDL流程中，特征计算DSL是模型处理的重点和难点。一套易用的特征计算规范需既要满足特征处理逻辑的差异性，又要便于使用和理解。经过对算法需求的了解和对业界做法的调研，我们开发了一套易用易读且符合编程习惯的特征表达式，并基于JavaCC实现了高性能的执行引擎，支持了以下特性：&lt;/span&gt;&lt;/p&gt;&lt;ul data-tool=&quot;mdnice编辑器&quot; class=&quot;list-paddingleft-2&quot;&gt;&lt;li&gt;&lt;section&gt;&lt;span&gt;&lt;strong&gt;特征类型&lt;/strong&gt;：支持以下常用的特征数据结构：&lt;/span&gt;&lt;/section&gt;&lt;/li&gt;&lt;ul class=&quot;list-paddingleft-2&quot;&gt;&lt;li&gt;&lt;section&gt;&lt;span&gt;&lt;strong&gt;单值类型（String/Long/Double）&lt;/strong&gt;：数值和文本类型特征。&lt;/span&gt;&lt;/section&gt;&lt;/li&gt;&lt;li&gt;&lt;section&gt;&lt;span&gt;&lt;strong&gt;Map类型&lt;/strong&gt;：交叉或字典类型的特征。&lt;/span&gt;&lt;/section&gt;&lt;/li&gt;&lt;li&gt;&lt;section&gt;&lt;span&gt;&lt;strong&gt;List类型&lt;/strong&gt;：Embedding或向量特征。&lt;/span&gt;&lt;/section&gt;&lt;/li&gt;&lt;/ul&gt;&lt;li&gt;&lt;section&gt;&lt;span&gt;&lt;strong&gt;逻辑运算&lt;/strong&gt;：支持常规的算术和逻辑运算，比如a&amp;gt;b?(a-b):0。&lt;/span&gt;&lt;/section&gt;&lt;/li&gt;&lt;li&gt;&lt;section&gt;&lt;span&gt;&lt;strong&gt;函数算子&lt;/strong&gt;：逻辑运算只适合少量简单的处理逻辑，而更多复杂的逻辑通常需要通过函数算子来完成。业务方既可以根据自己的需求编写算子，也可快速复用平台定期收集整理的常用算子，以降低开发成本，提升模型迭代效率。&lt;/span&gt;&lt;/section&gt;&lt;/li&gt;&lt;/ul&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;特征计算DSL举例如下所示：&lt;/span&gt;&lt;/p&gt;&lt;figure data-tool=&quot;mdnice编辑器&quot;&gt;&lt;img data-cropselx1=&quot;0&quot; data-cropselx2=&quot;380&quot; data-cropsely1=&quot;0&quot; data-cropsely2=&quot;74&quot; data-ratio=&quot;0.19666048237476808&quot; data-src=&quot;https://mmbiz.qpic.cn/mmbiz_png/hEx03cFgUsWEuxGARmicXLyGYuZcYyU5O6aEtXa8ebDvJBUxyTEiauvIR6tKgVyHskibffx2XpialicNG9MIPqd0Aww/640?wx_fmt=png&quot; data-type=&quot;png&quot; data-w=&quot;1617&quot;/&gt;&lt;/figure&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;基于规范化的DSL，一方面可以让执行引擎在执行阶段做一些主动优化，包括向量化计算、并行计算等，另一方面也有助于使用方将精力聚焦于特征计算的业务逻辑，而不用关心实现细节，既降低了使用门槛，也避免了误操作对线上稳定性造成的影响。&lt;/span&gt;&lt;/p&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;由于MFDL是独立于模型文件之外的配置，因此特征更新迭代时只需要将新的配置推送到服务器上，经过加载和预测后即可生效，实现了特征处理的热更新，提升了迭代效率。同时，MFDL也是离线训练时使用的特征配置文件，结合统一的算子逻辑，保证了离线训练样本/在线预估特征处理的一致性。在系统中，只需要在离线训练时配置一次，训练完成后即可一键推送到线上服务，安全高效。&lt;/span&gt;&lt;/p&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;下面是一个TF模型的MFDL配置示例：&lt;/span&gt;&lt;/p&gt;&lt;figure data-tool=&quot;mdnice编辑器&quot;&gt;&lt;img data-cropselx1=&quot;0&quot; data-cropselx2=&quot;541&quot; data-cropsely1=&quot;0&quot; data-cropsely2=&quot;142&quot; data-ratio=&quot;0.26368396001903854&quot; data-src=&quot;https://mmbiz.qpic.cn/mmbiz_png/hEx03cFgUsWEuxGARmicXLyGYuZcYyU5OgtF5jEdb60Fcbnmp6s7zNoo8rG1sSxoswHOkD0oKoGYQN7dvJjw34w/640?wx_fmt=png&quot; data-type=&quot;png&quot; data-w=&quot;2101&quot;/&gt;&lt;/figure&gt;&lt;h4 data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;3.2.2 特征获取流程&lt;/span&gt;&lt;/h4&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;MFDL中使用到的特征数据，需在特征计算之前从KV存储进行统一获取。为了提升特征获取效率，平台会对多个特征数据源异步并行获取，并针对不同的数据源，使用不同的手段进行优化，比如RPC聚合等。特征获取的基本流程如下图所示：&lt;/span&gt;&lt;/p&gt;&lt;figure data-tool=&quot;mdnice编辑器&quot;&gt;&lt;img data-cropselx1=&quot;0&quot; data-cropselx2=&quot;390&quot; data-cropsely1=&quot;0&quot; data-cropsely2=&quot;227&quot; data-ratio=&quot;0.5820198482194979&quot; data-src=&quot;https://mmbiz.qpic.cn/mmbiz_png/hEx03cFgUsWEuxGARmicXLyGYuZcYyU5OL8JejvmUuqDc3FTNicz6K9JN34R8dRzyy5bbIrj3QicN2w6wju2R0fyw/640?wx_fmt=png&quot; data-type=&quot;png&quot; data-w=&quot;1713&quot;/&gt;&lt;/figure&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;在特征生产章节已经提到，特征数据是按分组进行聚合存储。特征获取在每次访问KV存储时，都会读取整个分组下所有的特征数据，一个分组下特征数量的多少将会直接影响到在线特征获取的性能。因此，我们在特征分组分配方面进行了相关优化，既保证了特征获取的高效性，又保证了线上服务的稳定性。&lt;/span&gt;&lt;/p&gt;&lt;h5 data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;3.2.2.1 智能分组&lt;/span&gt;&lt;/h5&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;特征以分组的形式进行聚合，用于特征的写入和读取。起初，特征是以固定分组的形式进行组织管理，即不同业务线的特征会被人工聚合到同一分组中，这种方式实现简单，但却暴露出以下两点问题：&lt;/span&gt;&lt;/p&gt;&lt;ul data-tool=&quot;mdnice编辑器&quot; class=&quot;list-paddingleft-2&quot;&gt;&lt;li&gt;&lt;section&gt;&lt;span&gt;&lt;strong&gt;特征读取性能差&lt;/strong&gt;：线上需要读取解析多个业务线聚合后的特征大Value，而每个业务线只会用到其中部分特征，导致计算资源浪费、读取性能变差。&lt;/span&gt;&lt;/section&gt;&lt;/li&gt;&lt;li&gt;&lt;section&gt;&lt;strong&gt;&lt;span&gt;影响KV集群稳定性&lt;/span&gt;&lt;/strong&gt;&lt;span&gt;：特征大Value被高频读取，一方面会将集群的网卡带宽打满，另一方面大Value不会被读取至内存，只能磁盘查找，影响集群查询性能（&lt;span&gt;特定KV存储场景&lt;/span&gt;）。&lt;/span&gt;&lt;/section&gt;&lt;/li&gt;&lt;/ul&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;因此，特征平台设计了智能分组，打破之前固定分组的形式，通过合理机制进行特征分组的动态调整，保证特征聚合的合理性和有效性。如下图所示，平台打通了线上线下链路，线上用于上报业务线所用的特征状态，线下则通过收集分析线上特征，从全局视角对特征所属分组进行智能化的整合、迁移、反馈和管理。同时，基于存储和性能的折中考虑，平台建立了两种分组类型：业务分组和公共分组：&lt;/span&gt;&lt;/p&gt;&lt;figure data-tool=&quot;mdnice编辑器&quot;&gt;&lt;img data-cropselx1=&quot;0&quot; data-cropselx2=&quot;541&quot; data-cropsely1=&quot;0&quot; data-cropsely2=&quot;190&quot; data-ratio=&quot;0.3506679389312977&quot; data-src=&quot;https://mmbiz.qpic.cn/mmbiz_png/hEx03cFgUsWEuxGARmicXLyGYuZcYyU5OWSosgmVDJlKxias50R19BO0jx8RpBuWOtnLibw1fxaAicun5GluyvI56g/640?wx_fmt=png&quot; data-type=&quot;png&quot; data-w=&quot;2096&quot;/&gt;&lt;/figure&gt;&lt;ul data-tool=&quot;mdnice编辑器&quot; class=&quot;list-paddingleft-2&quot;&gt;&lt;li&gt;&lt;section&gt;&lt;span&gt;&lt;strong&gt;业务分组&lt;/strong&gt;：用于聚合每个业务线各自用到的专属特征，保证特征获取的有效性。如果特征被多业务共用，若仍存储在各自业务分组，会导致存储资源浪费，需迁移至公共分组（&lt;/span&gt;&lt;span&gt;存储角度&lt;/span&gt;&lt;span&gt;）。&lt;/span&gt;&lt;/section&gt;&lt;/li&gt;&lt;li&gt;&lt;section&gt;&lt;span&gt;&lt;strong&gt;公共分组&lt;/strong&gt;：用于聚合多业务线同时用到的特征，节省存储资源开销，但分组增多会带来KV存储读写量增大，因此公共分组数量需控制在合理范围内（&lt;/span&gt;&lt;span&gt;性能角度&lt;/span&gt;&lt;span&gt;）。&lt;/span&gt;&lt;/section&gt;&lt;/li&gt;&lt;/ul&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;通过特征在两种分组间的动态迁移以及对线上的实时反馈，保证各业务对特征所拉即所用，提升特征读取性能，保证KV集群稳定性。&lt;/span&gt;&lt;/p&gt;&lt;h5 data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;3.2.2.2 分组合并&lt;/span&gt;&lt;/h5&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;智能分组可以有效的提升特征获取效率，但同时也引入了一个问题：在智能分组过程中，特征在分组迁移阶段，会出现一个特征同时存在于多个分组的情况，造成特征在多个分组重复获取的问题，增加对KV存储的访问压力。为了优化特征获取效率，在特征获取之前需要对特征分组进行合并，将特征尽量放在同一个分组中进行获取，从而减少访问KV存储的次数，提升特征获取性能。&lt;/span&gt;&lt;/p&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;如下图所示，经过分组合并，将特征获取的分组个数由4个（&lt;/span&gt;&lt;span&gt;最坏情况&lt;/span&gt;&lt;span&gt;）减少到2个，从而对KV存储访问量降低一半。&lt;/span&gt;&lt;/p&gt;&lt;figure data-tool=&quot;mdnice编辑器&quot;&gt;&lt;img data-cropselx1=&quot;1&quot; data-cropselx2=&quot;358&quot; data-cropsely1=&quot;0&quot; data-cropsely2=&quot;292&quot; data-ratio=&quot;0.8217008797653959&quot; data-src=&quot;https://mmbiz.qpic.cn/mmbiz_png/hEx03cFgUsWEuxGARmicXLyGYuZcYyU5OzSticpS2x2knzC6zqXw8yoI1ic5xzrcJ9SPm54ZN0N5QP6TiaY13WTdfQ/640?wx_fmt=png&quot; data-type=&quot;png&quot; data-w=&quot;1705&quot;/&gt;&lt;/figure&gt;&lt;h3 data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;3.3 训练样本构建：统一配置化的一致性训练样本生成能力&lt;/span&gt;&lt;/h3&gt;&lt;h4 data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;3.3.1 现状分析&lt;/span&gt;&lt;/h4&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;训练样本是特征工程连接算法模型的一个关键环节，训练样本构建的本质是一个数据加工过程，而这份数据如何做到“能用”（&lt;/span&gt;&lt;span&gt;数据质量要准确可信&lt;/span&gt;&lt;span&gt;）、“易用”（&lt;/span&gt;&lt;span&gt;生产过程要灵活高效&lt;/span&gt;&lt;span&gt;）、“好用”（&lt;/span&gt;&lt;span&gt;通过平台能力为业务赋能&lt;/span&gt;&lt;span&gt;）对于算法模型迭代的效率和效果至关重要。&lt;/span&gt;&lt;/p&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;在特征平台统一建设之前，外卖策略团队在训练样本构建流程上主要遇到几个问题：&lt;/span&gt;&lt;/p&gt;&lt;ul data-tool=&quot;mdnice编辑器&quot; class=&quot;list-paddingleft-2&quot;&gt;&lt;li&gt;&lt;section&gt;&lt;span&gt;&lt;strong&gt;重复性开发&lt;/strong&gt;：缺少体系化的平台系统，依赖一些简单工具或定制化开发Hive/Spark任务，与业务耦合性较高，在流程复用、运维成本、性能调优等方面都表现较差。&lt;/span&gt;&lt;/section&gt;&lt;/li&gt;&lt;li&gt;&lt;section&gt;&lt;span&gt;&lt;strong&gt;灵活性不足&lt;/strong&gt;：样本构建流程复杂，包括但不限数据预处理、特征抽取、特征样本拼接、特征验证，以及数据格式转换（&lt;span&gt;如TFRecord&lt;/span&gt;）等，已有工具在配置化、扩展性上很难满足需求，使用成本较高。&lt;/span&gt;&lt;/section&gt;&lt;/li&gt;&lt;li&gt;&lt;section&gt;&lt;span&gt;&lt;strong&gt;一致性较差&lt;/strong&gt;：线上、线下在配置文件、算子上使用不统一，导致在线预测样本与离线训练样本的特征值不一致，模型训练正向效果难保障。&lt;/span&gt;&lt;/section&gt;&lt;/li&gt;&lt;/ul&gt;&lt;h4 data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;3.3.2 配置化流程&lt;/span&gt;&lt;/h4&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;平台化建设最重要的流程之一是“如何进行流程抽象”，业界有一些机器学习平台的做法是平台提供较细粒度的组件，让用户自行选择组件、配置依赖关系，最终生成一张样本构建的DAG图。&lt;/span&gt;&lt;/p&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;对于用户而言，这样看似是提高了流程编排的自由度，但深入了解算法同学实际工作场景后发现，算法模型迭代过程中，大部分的样本生产流程都比较固定，反而让用户每次都去找组件、配组件属性、指定关系依赖这样的操作，会给算法同学带来额外的负担，所以我们尝试了一种新的思路来优化这个问题：&lt;strong&gt;模板化 + 配置化&lt;/strong&gt;，即平台提供一个基准的模板流程，该流程中的每一个节点都抽象为一个或一类组件，用户基于该模板，通过简单配置即可生成自己样本构建流程，如下图所示：&lt;/span&gt;&lt;/p&gt;&lt;figure data-tool=&quot;mdnice编辑器&quot;&gt;&lt;img data-cropselx1=&quot;0&quot; data-cropselx2=&quot;541&quot; data-cropsely1=&quot;0&quot; data-cropsely2=&quot;183&quot; data-ratio=&quot;0.33890214797136037&quot; data-src=&quot;https://mmbiz.qpic.cn/mmbiz_png/hEx03cFgUsWEuxGARmicXLyGYuZcYyU5O14Qg6nfA94GjoOCId7BJthg0nY4t9OByDLrmmeDMYfqLraW4QPwa9g/640?wx_fmt=png&quot; data-type=&quot;png&quot; data-w=&quot;2095&quot;/&gt;&lt;/figure&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;整个流程模板包括三个部分：&lt;strong&gt;输入（Input）&lt;/strong&gt;、&lt;strong&gt;转化（Transform）&lt;/strong&gt;、&lt;strong&gt;输出（Output）&lt;/strong&gt;， 其中包含的组件有：Label数据预处理、实验特征抽取、特征样本关联、特征矩阵生成、特征格式转换、特征统计分析、数据写出，组件主要功能：&lt;/span&gt;&lt;/p&gt;&lt;ul data-tool=&quot;mdnice编辑器&quot; class=&quot;list-paddingleft-2&quot;&gt;&lt;li&gt;&lt;section&gt;&lt;span&gt;&lt;strong&gt;Label数据预处理&lt;/strong&gt;：支持通过自定义Hive/Spark SQL方式抽取Label数据，平台也内置了一些UDF（&lt;/span&gt;&lt;span&gt;如URL Decode、MD5/Murmur Hash 等&lt;/span&gt;&lt;span&gt;），通过自定义SQL+UDF方式灵活满足各种数据预处理的需求。在数据源方面，支持如下类型：&lt;/span&gt;&lt;/section&gt;&lt;/li&gt;&lt;ul class=&quot;list-paddingleft-2&quot;&gt;&lt;li&gt;&lt;section&gt;&lt;span&gt;一致性特征样本：指线上模型预测时，会将一次预测请求中使用到的特征及Label相关字段收集、加工、拼接，为离线训练提供基础的样本数据，推荐使用，可更好保障一致性。&lt;/span&gt;&lt;/section&gt;&lt;/li&gt;&lt;li&gt;&lt;section&gt;&lt;span&gt;自定义：不使用算法平台提供的一致性特征样本数据源，通过自定义方式抽取Label数据。&lt;/span&gt;&lt;/section&gt;&lt;/li&gt;&lt;li&gt;&lt;section&gt;&lt;span&gt;父训练样本：可依赖之前或其他同学生产的训练样本结果，只需要简单修改特征或采样等配置，即可实现对原数据微调，快速生成新的训练数据，提高执行效率。&lt;/span&gt;&lt;/section&gt;&lt;/li&gt;&lt;/ul&gt;&lt;li&gt;&lt;section&gt;&lt;span&gt;&lt;strong&gt;实验特征抽取&lt;/strong&gt;：线下训练如果需要调研一些新特征（&lt;/span&gt;&lt;span&gt;即在一致性特征样本中不存在&lt;/span&gt;&lt;span&gt;）效果，可以通过特征补录方式加入新的特征集。&lt;/span&gt;&lt;/section&gt;&lt;/li&gt;&lt;li&gt;&lt;section&gt;&lt;span&gt;&lt;strong&gt;特征样本关联&lt;/strong&gt;：将Label数据与补录的实验特征根据唯一标识（&lt;/span&gt;&lt;span&gt;如：poi_id&lt;/span&gt;&lt;span&gt;）进行关联。&lt;/span&gt;&lt;/section&gt;&lt;/li&gt;&lt;li&gt;&lt;section&gt;&lt;span&gt;&lt;strong&gt;特征矩阵生成&lt;/strong&gt;：根据用户定义的特征MFDL配置文件，将每一个样本需要的特征集计算合并，生成特征矩阵，得到训练样本中间表。&lt;/span&gt;&lt;/section&gt;&lt;/li&gt;&lt;li&gt;&lt;section&gt;&lt;span&gt;&lt;strong&gt;特征格式转换&lt;/strong&gt;：基于训练样本中间表，根据不同模型类型，将数据转换为不同格式的文件（&lt;/span&gt;&lt;span&gt;如：CSV/TFRecord&lt;/span&gt;&lt;span&gt;）。&lt;/span&gt;&lt;/section&gt;&lt;/li&gt;&lt;li&gt;&lt;section&gt;&lt;span&gt;&lt;strong&gt;特征统计分析&lt;/strong&gt;：辅助功能，基于训练样本中间表，对特征统计分析，包括均值、方差、最大/最小值、分位数、空值率等多种统计维度，输出统计分析报告。&lt;/span&gt;&lt;/section&gt;&lt;/li&gt;&lt;li&gt;&lt;section&gt;&lt;span&gt;&lt;strong&gt;数据写出&lt;/strong&gt;：将不同中间结果，写出到Hive表/HDFS等存储介质。&lt;/span&gt;&lt;/section&gt;&lt;/li&gt;&lt;/ul&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;上面提到，整个流程是模板化，模板中的多数环节都可以通过配置选择开启或关闭，所以整个流程也支持从中间的某个环节开始执行，灵活满足各类数据生成需求。&lt;/span&gt;&lt;/p&gt;&lt;h4 data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;3.3.3 一致性保障&lt;/span&gt;&lt;/h4&gt;&lt;h5 data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;（1）为什么会不一致？&lt;/span&gt;&lt;/h5&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;上文还提到了一个关键的问题：一致性较差。先来看下为什么会不一致？&lt;/span&gt;&lt;/p&gt;&lt;figure data-tool=&quot;mdnice编辑器&quot;&gt;&lt;img data-cropselx1=&quot;0&quot; data-cropselx2=&quot;541&quot; data-cropsely1=&quot;0&quot; data-cropsely2=&quot;222&quot; data-ratio=&quot;0.41086749285033364&quot; data-src=&quot;https://mmbiz.qpic.cn/mmbiz_png/hEx03cFgUsWEuxGARmicXLyGYuZcYyU5O0dHLUDNMdGxxYia0SjVTtlrubWGibGaPzCCZ6Kt6op5yyZPg5oS8TvfA/640?wx_fmt=png&quot; data-type=&quot;png&quot; data-w=&quot;2098&quot;/&gt;&lt;/figure&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;上图展示了在离线训练和在线预测两条链路中构建样本的方式，最终导致离线、在线特征值Diff的原因主要有三点：&lt;/span&gt;&lt;/p&gt;&lt;ul data-tool=&quot;mdnice编辑器&quot; class=&quot;list-paddingleft-2&quot;&gt;&lt;li&gt;&lt;section&gt;&lt;span&gt;&lt;strong&gt;特征配置文件不一致&lt;/strong&gt;：在线侧、离线侧对特征计算、编排等配置描述未统一，靠人工较难保障一致性。&lt;/span&gt;&lt;/section&gt;&lt;/li&gt;&lt;li&gt;&lt;section&gt;&lt;span&gt;&lt;strong&gt;特征更新时机不一致&lt;/strong&gt;：特征一般是覆盖更新，特征抽取、计算、同步等流程较长，由于数据源更新、重刷、特征计算任务失败等诸多不确定因素，在线、离线在不同的更新时机下，数据口径不一致。&lt;/span&gt;&lt;/section&gt;&lt;/li&gt;&lt;li&gt;&lt;section&gt;&lt;span&gt;&lt;strong&gt;特征算子定义不一致&lt;/strong&gt;：从数据源抽取出来的原始特征一般都需要经过二次运算，线上、线下算子不统一。&lt;/span&gt;&lt;/section&gt;&lt;/li&gt;&lt;/ul&gt;&lt;h5 data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;（2）如何保证一致性？&lt;/span&gt;&lt;/h5&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;明确了问题所在，我们通过如下方案来解决一致性问题：&lt;/span&gt;&lt;/p&gt;&lt;figure data-tool=&quot;mdnice编辑器&quot;&gt;&lt;img data-cropselx1=&quot;0&quot; data-cropselx2=&quot;541&quot; data-cropsely1=&quot;0&quot; data-cropsely2=&quot;179&quot; data-ratio=&quot;0.3319006685768863&quot; data-src=&quot;https://mmbiz.qpic.cn/mmbiz_png/hEx03cFgUsWEuxGARmicXLyGYuZcYyU5OwNwiaWCYbgvDHK6sxuVFBUZvvsOCsC683ZXZTIBJCLjqPo1CstmkLTg/640?wx_fmt=png&quot; data-type=&quot;png&quot; data-w=&quot;2094&quot;/&gt;&lt;/figure&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;线下生成训练样本时，用户先定义特征MFDL配置文件，在模型训练后，通过平台一键打包功能，将MFDL配置文件以及训练输出的模型文件，打包、上传到模型管理平台，通过一定的版本管理及加载策略，将模型动态加载到线上服务，从而实现线上、线下配置一体化。&lt;/span&gt;&lt;/p&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;通过实时收集在线Serving输出的特征快照，经过一定的规则处理，将结果数据输出到Hive表，作为离线训练样本的基础数据源，提供一致性特征样本，保障在线、离线数据口径一致。&lt;/span&gt;&lt;/p&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;上文提到可以通过特征补录方式添加新的实验特征，补录特征如果涉及到算子二次加工，平台既提供基础的算子库，也支持自定义算子，通过算子库共用保持线上、线下计算口径一致。&lt;/span&gt;&lt;/p&gt;&lt;h4 data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;3.3.4 为业务赋能&lt;/span&gt;&lt;/h4&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;从特征生产，到特征获取计算，再到生成训练样本，特征平台的能力不断得到延展，逐步和离线训练流程、在线预测服务形成一个紧密协作的整体。在特征平台的能力边界上，我们也在不断的思考和探索，希望能除了为业务提供稳定、可靠、易用的特征数据之外，还能从特征的视角出发，更好的建设特征生命周期闭环，通过平台化的能力反哺业务，为业务赋能。在上文特征生产章节，提到了特征平台一个重要能力：特征复用，这也是特征平台为业务赋能最主要的一点。&lt;/span&gt;&lt;/p&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;特征复用需要解决两个问题：&lt;/span&gt;&lt;/p&gt;&lt;ul data-tool=&quot;mdnice编辑器&quot; class=&quot;list-paddingleft-2&quot;&gt;&lt;li&gt;&lt;section&gt;&lt;span&gt;&lt;strong&gt;特征快速发现&lt;/strong&gt;：当前特征平台有上万特征，需要通过平台化的能力，让高质量的特征快速被用户发现，另外，特征的“高质量”如何度量，也需要有统一的评价标准来支撑。&lt;/span&gt;&lt;/section&gt;&lt;/li&gt;&lt;li&gt;&lt;section&gt;&lt;span&gt;&lt;strong&gt;特征快速使用&lt;/strong&gt;：对于用户发现并筛选出的目标特征，平台需要能够以较低的配置成本、计算资源快速支持使用（&lt;/span&gt;&lt;span&gt;参考上文3.1.2 小节“特征复用”&lt;/span&gt;&lt;span&gt;）。&lt;/span&gt;&lt;/section&gt;&lt;/li&gt;&lt;/ul&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;本小节重点介绍如何帮助用户快速发现特征，主要包括两个方面：主动检索和被动推荐，如下图所示：&lt;/span&gt;&lt;/p&gt;&lt;figure data-tool=&quot;mdnice编辑器&quot;&gt;&lt;img data-cropselx1=&quot;0&quot; data-cropselx2=&quot;541&quot; data-cropsely1=&quot;0&quot; data-cropsely2=&quot;191&quot; data-ratio=&quot;0.3524082021936099&quot; data-src=&quot;https://mmbiz.qpic.cn/mmbiz_png/hEx03cFgUsWEuxGARmicXLyGYuZcYyU5OZQibEcMf2ugoykJM2IicfV86q3xSHib0PKpvMMnckOulkvtEGPW00x8eA/640?wx_fmt=png&quot; data-type=&quot;png&quot; data-w=&quot;2097&quot;/&gt;&lt;/figure&gt;&lt;ul data-tool=&quot;mdnice编辑器&quot; class=&quot;list-paddingleft-2&quot;&gt;&lt;li&gt;&lt;section&gt;&lt;span&gt;首先，用户可以通过主动检索，从特征仓库筛选出目标特征候选集，然后结合特征画像来进一步筛选，得到特征初选集，最后通过离线实验流程、在线ABTest，结合模型效果，评估筛选出最终的结果集。其中特征画像主要包括以下评价指标：&lt;/span&gt;&lt;/section&gt;&lt;/li&gt;&lt;ul class=&quot;list-paddingleft-2&quot;&gt;&lt;li&gt;&lt;section&gt;&lt;strong&gt;&lt;span&gt;特征复用度&lt;/span&gt;&lt;/strong&gt;&lt;span&gt;：通过查看该特征在各业务、各模型的引用次数，帮助用户直观判断该特征的价值。&lt;/span&gt;&lt;/section&gt;&lt;/li&gt;&lt;li&gt;&lt;section&gt;&lt;strong&gt;&lt;span&gt;特征标注信息&lt;/span&gt;&lt;/strong&gt;&lt;span&gt;：通过查看该特征在其他业务离线、在线效果的标注信息，帮助用户判断该特征的正负向效果。&lt;/span&gt;&lt;/section&gt;&lt;/li&gt;&lt;li&gt;&lt;section&gt;&lt;strong&gt;&lt;span&gt;数据质量评估&lt;/span&gt;&lt;/strong&gt;&lt;span&gt;：平台通过离线统计任务，按天粒度对特征进行统计分析，包括特征的就绪时间、空值率、均值、方差、最大/小值、分位点统计等，生成特征评估报告，帮助用户判断该特征是否可靠。&lt;/span&gt;&lt;/section&gt;&lt;/li&gt;&lt;/ul&gt;&lt;li&gt;&lt;section&gt;&lt;span&gt;其次，平台根据特征的评价体系，将表现较好的Top特征筛选出来，通过排行榜展现、消息推送方式触达用户，帮助用户挖掘高分特征。&lt;/span&gt;&lt;/section&gt;&lt;/li&gt;&lt;/ul&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;为业务赋能是一个长期探索和实践的过程，未来我们还会继续尝试在深度学习场景中，建立每个特征对模型贡献度的评价体系，并通过自动化的方式打通模型在线上、线下的评估效果，通过智能化的方式挖掘特征价值。&lt;/span&gt;&lt;/p&gt;&lt;h2 data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;&lt;strong&gt;4 总结与展望&lt;/strong&gt;&lt;/span&gt;&lt;/h2&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;本文分别从特征框架演进、特征生产、特征获取计算以及训练样本生成四个方面介绍了特征平台在建设与实践中的思考和优化思路。经过两年的摸索建设和实践，外卖特征平台已经建立起完善的架构体系、一站式的服务流程，为外卖业务的算法迭代提供了有力支撑。&lt;/span&gt;&lt;/p&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;未来，外卖特征平台将继续推进从离线-&amp;gt;近线-&amp;gt;在线的全链路优化工作，在计算性能、资源开销、能力扩展、合作共建等方面持续投入人力探索和建设，并在更多更具挑战的业务场景中发挥平台的价值。同时，平台将继续和模型服务和模型训练紧密结合，共建端到端算法闭环，助力外卖业务蓬勃发展。&lt;/span&gt;&lt;/p&gt;&lt;h2 data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;5 作者简介&lt;/span&gt;&lt;/h2&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;英亮、陈龙、刘磊、亚劼、乐彬等，美团外卖算法平台工程师。&lt;/span&gt;&lt;/p&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;/p&gt;&lt;/section&gt;&lt;/div&gt;&lt;/div&gt;</content:encoded>
</item>
</channel></rss>