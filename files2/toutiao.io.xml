<?xml version="1.0" encoding="UTF-8"?>
        <rss version="2.0" xmlns:content="http://purl.org/rss/1.0/modules/content/">
            <channel>
            <title>开发者头条</title>
            <link>http://toutiao.io/</link>
            <description></description>
<item>
<guid>1b241b77409b0f9aad775cb49326e1ad</guid>
<title>2022 年来了！抓紧啦！</title>
<link>https://toutiao.io/k/rf8ezjy</link>
<content:encoded>&lt;div&gt;&lt;div&gt;&lt;div class=&quot;weui-dialog&quot;&gt;
      &lt;p class=&quot;weui-dialog__hd&quot;&gt;&lt;strong class=&quot;weui-dialog__title&quot;&gt;&quot;Top Stories&quot; is disabled&lt;/strong&gt;&lt;/p&gt;
      &lt;p class=&quot;weui-dialog__bd&quot;&gt;
        Enable &quot;Top Stories&quot; in &quot;Settings&quot; &amp;gt; &quot;General&quot; &amp;gt; &quot;Manage Discover&quot;      &lt;/p&gt;
      
    &lt;/div&gt;
  &lt;/div&gt;&lt;/div&gt;</content:encoded>
</item>
<item>
<guid>05a7928cb9700aadfe3c3f12e28dbccd</guid>
<title>一文读懂蓝绿发布、A/B 测试和金丝雀发布的优缺点</title>
<link>https://toutiao.io/k/dd76ptd</link>
<content:encoded>&lt;div&gt;&lt;div&gt;&lt;div class=&quot;rich_media_content &quot; id=&quot;js_content&quot;&gt;
                    

                    
                    
                    
                    &lt;p&gt;&lt;span&gt;‍‍‍&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;img class=&quot;rich_pages wxw-img&quot; data-croporisrc=&quot;https://mmbiz.qpic.cn/mmbiz_jpg/tMJtfgIIibWL1uI2nhcwI5BDO1look3Cj4UaK3F1kXJqD0dW07aiaSzRtUfGcI3VcfPmzjianibQra8KNRQicE5VHtQ/0?wx_fmt=jpeg&quot; data-cropx1=&quot;0&quot; data-cropx2=&quot;1000&quot; data-cropy1=&quot;17.30103806228374&quot; data-cropy2=&quot;453.287197231834&quot; data-galleryid=&quot;&quot; data-ratio=&quot;0.435&quot; data-s=&quot;300,640&quot; data-src=&quot;https://mmbiz.qpic.cn/mmbiz_jpg/tMJtfgIIibWL1uI2nhcwI5BDO1look3CjP0rgO7n8I0vRPQHibThvDzTXJia30I0iaT2WKR9dDYD8oJ2HF3d8pNNNw/640?wx_fmt=jpeg&quot; data-type=&quot;jpeg&quot; data-w=&quot;1000&quot;/&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;作者 | 扬少&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;/p&gt;&lt;h1 data-lake-id=&quot;3968f4bcc3cf82abfbc02aed09f69519&quot;&gt;&lt;span&gt;&lt;strong&gt;背景&lt;/strong&gt;&lt;/span&gt;&lt;/h1&gt;&lt;p&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;目前，业界已经总结出了几种常见的服务发布策略来解决版本升级过程中带来的流量有损问题。本文首先会对这些普遍的发布策略进行简单的原理解析，最后结合阿里云的云原生网关对这些发布策略进行实践。&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;/p&gt;&lt;h1 data-lake-id=&quot;84a9d12df914a9b17dc17475d1de26c2&quot;&gt;&lt;span&gt;&lt;strong&gt;发布策略&lt;/strong&gt;&lt;/span&gt;&lt;/h1&gt;&lt;p&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;被业界广泛采用的服务发布策略包括蓝绿发布、A/B 测试以及金丝雀发布。&lt;/span&gt;&lt;/p&gt;&lt;h3 data-lake-id=&quot;a35743c789db2487c207ec28db344043&quot;&gt;&lt;br/&gt;&lt;/h3&gt;&lt;h2 data-lake-id=&quot;c1955fa8f0e34746b02b6339660bfe1b&quot;&gt;&lt;span&gt;&lt;strong&gt;&lt;span&gt;1.蓝绿发布&lt;/span&gt;&lt;/strong&gt;&lt;/span&gt;&lt;/h2&gt;&lt;p&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;蓝绿发布需要对服务的新版本进行冗余部署，一般新版本的机器规格和数量与旧版本保持一致，相当于该服务有两套完全相同的部署环境，只不过此时只有旧版本在对外提供服务，新版本作为热备。当服务进行版本升级时，我们只需将流量全部切换到新版本即可，旧版本作为热备。由于冗余部署的缘故，所以不必担心新版本的资源不够。如果新版本上线后出现严重的程序 BUG，那么我们只需将流量全部切回至旧版本，大大缩短故障恢复的时间。待新版本完成 BUG 修复并重新部署之后，再将旧版本的流量切换到新版本。&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;蓝绿发布通过使用额外的机器资源来解决服务发布期间的不可用问题，当服务新版本出现故障时，也可以快速将流量切回旧版本。&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;如图，某服务旧版本为 v1，对新版本 v2 进行冗余部署。版本升级时，将现有流量全部切换为新版本 v2。&lt;img data-height=&quot;1px&quot; data-ratio=&quot;1&quot; data-src=&quot;https://mmbiz.qpic.cn/mmbiz_png/tMJtfgIIibWL1uI2nhcwI5BDO1look3CjFRwedic9nR73jK8Jb7277dhN36na7icYlvONGO7xfrXmkntfXGiaOYnNQ/640?wx_fmt=png&quot; data-type=&quot;png&quot; data-w=&quot;1&quot; title=&quot;image.gif&quot;/&gt;&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;&lt;br/&gt;&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;&lt;img class=&quot;rich_pages wxw-img&quot; data-height=&quot;362px&quot; data-ratio=&quot;0.22073170731707317&quot; data-src=&quot;https://mmbiz.qpic.cn/mmbiz_png/tMJtfgIIibWL1uI2nhcwI5BDO1look3CjPPjmUd9yVtJa5FOEDF9KmImyWSPYLib9PV3RqAHctTIT5L2nhDToKicQ/640?wx_fmt=png&quot; data-type=&quot;png&quot; data-w=&quot;1640&quot; title=&quot;1.png&quot;/&gt;&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;&lt;br/&gt;&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;当新版本 v2 存在程序 BUG 或者发生故障时，可以快速切回旧版本 v1。&lt;img data-height=&quot;1px&quot; data-ratio=&quot;1&quot; data-src=&quot;https://mmbiz.qpic.cn/mmbiz_png/tMJtfgIIibWL1uI2nhcwI5BDO1look3CjFRwedic9nR73jK8Jb7277dhN36na7icYlvONGO7xfrXmkntfXGiaOYnNQ/640?wx_fmt=png&quot; data-type=&quot;png&quot; data-w=&quot;1&quot; title=&quot;image.gif&quot;/&gt;&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;&lt;br/&gt;&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;&lt;img class=&quot;rich_pages wxw-img&quot; data-height=&quot;366px&quot; data-ratio=&quot;0.22509225092250923&quot; data-src=&quot;https://mmbiz.qpic.cn/mmbiz_png/tMJtfgIIibWL1uI2nhcwI5BDO1look3Cjkibqiamzdyuffk1tXOzzd8FBiciaMyZecRAWlT9JFyjib96DjJNqfdSCMhw/640?wx_fmt=png&quot; data-type=&quot;png&quot; data-w=&quot;1626&quot; title=&quot;2.png&quot;/&gt;&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;&lt;br/&gt;&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;蓝绿部署的优点：&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;&lt;br/&gt;&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;1.部署结构简单，运维方便；&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;&lt;br/&gt;&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;2.服务升级过程操作简单，周期短。&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;蓝绿部署的缺点：&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;&lt;br/&gt;&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;1.资源冗余，需要部署两套生产环境；&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;&lt;br/&gt;&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;2.新版本故障影响范围大。&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;/p&gt;&lt;h2 data-lake-id=&quot;fdfec2977dca03a555679f6a04e648c0&quot;&gt;&lt;span&gt;&lt;strong&gt;&lt;span&gt;2.A/B 测试&lt;/span&gt;&lt;/strong&gt;&lt;/span&gt;&lt;/h2&gt;&lt;p&gt;&lt;span&gt;&lt;br/&gt;&lt;/span&gt;&lt;/p&gt;&lt;h3 data-lake-id=&quot;47aabaf9f9eb2a0623df816f10f958e6&quot;/&gt;&lt;p&gt;&lt;span&gt;相比于蓝绿发布的流量切换方式，A/B 测试基于用户请求的元信息将流量路由到新版本，这是一种基于请求内容匹配的灰度发布策略。只有匹配特定规则的请求才会被引流到新版本，常见的做法包括基于 Http Header 和 Cookie。基于 Http Header 方式的例子，例如 User-Agent 的值为 Android 的请求 （来自安卓系统的请求）可以访问新版本，其他系统仍然访问旧版本。基于 Cookie 方式的例子，Cookie 中通常包含具有业务语义的用户信息，例如普通用户可以访问新版本，VIP 用户仍然访问旧版本。&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;如图，某服务当前版本为 v1，现在新版本 v2 要上线。希望安卓用户可以尝鲜新功能，其他系统用户保持不变。&lt;img data-height=&quot;1px&quot; data-ratio=&quot;1&quot; data-src=&quot;https://mmbiz.qpic.cn/mmbiz_png/tMJtfgIIibWL1uI2nhcwI5BDO1look3CjFRwedic9nR73jK8Jb7277dhN36na7icYlvONGO7xfrXmkntfXGiaOYnNQ/640?wx_fmt=png&quot; data-type=&quot;png&quot; data-w=&quot;1&quot; title=&quot;image.gif&quot;/&gt;&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;&lt;br/&gt;&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;&lt;img class=&quot;rich_pages wxw-img&quot; data-height=&quot;362px&quot; data-ratio=&quot;0.218335343787696&quot; data-src=&quot;https://mmbiz.qpic.cn/mmbiz_png/tMJtfgIIibWL1uI2nhcwI5BDO1look3Cj3p7GWBCoz1X7iaib1dZenQPlVDoM2CKxmbndHua2gDsSstiaQGRuVP0VQ/640?wx_fmt=png&quot; data-type=&quot;png&quot; data-w=&quot;1658&quot; title=&quot;3.png&quot;/&gt;&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;&lt;br/&gt;&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;通过在监控平台观察旧版本与新版本的成功率、RT 对比，当新版本整体服务预期后，即可将所有请求切换到新版本 v2，最后为了节省资源，可以逐步下线到旧版本 v1。&lt;img data-height=&quot;1px&quot; data-ratio=&quot;1&quot; data-src=&quot;https://mmbiz.qpic.cn/mmbiz_png/tMJtfgIIibWL1uI2nhcwI5BDO1look3CjFRwedic9nR73jK8Jb7277dhN36na7icYlvONGO7xfrXmkntfXGiaOYnNQ/640?wx_fmt=png&quot; data-type=&quot;png&quot; data-w=&quot;1&quot; title=&quot;image.gif&quot;/&gt;&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;&lt;br/&gt;&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;&lt;img class=&quot;rich_pages wxw-img&quot; data-height=&quot;364px&quot; data-ratio=&quot;0.2169249106078665&quot; data-src=&quot;https://mmbiz.qpic.cn/mmbiz_png/tMJtfgIIibWL1uI2nhcwI5BDO1look3Cj1eVOfSrI2TxIYt6gzoZdAYxwYe2y97qRaVVJjFMh2kE1qp0EqlZuWA/640?wx_fmt=png&quot; data-type=&quot;png&quot; data-w=&quot;1678&quot; title=&quot;4.png&quot;/&gt;&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;&lt;br/&gt;&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;A/B 测试的优点：&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;&lt;br/&gt;&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;1.可以对特定的请求或者用户提供服务新版本，新版本故障影响范围小；&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;&lt;br/&gt;&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;2.需要构建完备的监控平台，用于对比不同版本之间请求状态的差异。&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;A/B 测试的缺点：&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;&lt;br/&gt;&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;1.仍然存在资源冗余，因为无法准确评估请求容量；&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;&lt;br/&gt;&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;2.发布周期长。&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;/p&gt;&lt;h2 data-lake-id=&quot;cc414a4c04eeb8f79eafac0a708b94f9&quot;&gt;&lt;span&gt;&lt;strong&gt;&lt;span&gt;3.金丝雀发布&lt;/span&gt;&lt;/strong&gt;&lt;/span&gt;&lt;/h2&gt;&lt;p&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;在蓝绿发布中，由于存在流量整体切换，所以需要按照原服务占用的机器规模为新版本克隆一套环境，相当于要求原来1倍的机器资源。在 A/B 测试中，只要能够预估中匹配特定规则的请求规模，我们可以按需为新版本分配额外的机器资源。相比于前两种发布策略，金丝雀发布的思想则是将少量的请求引流到新版本上，因此部署新版本服务只需极小数的机器。验证新版本符合预期后，逐步调整流量权重比例，使得流量慢慢从老版本迁移至新版本，期间可以根据设置的流量比例，对新版本服务进行扩容，同时对老版本服务进行缩容，使得底层资源得到最大化利用。&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;如图，某服务当前版本为 v1，现在新版本 v2 要上线。为确保流量在服务升级过程中平稳无损，采用金丝雀发布方案，逐步将流量从老版本迁移至新版本。&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;&lt;br/&gt;&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;&lt;img class=&quot;rich_pages wxw-img&quot; data-height=&quot;1334px&quot; data-ratio=&quot;0.802647412755716&quot; data-src=&quot;https://mmbiz.qpic.cn/mmbiz_png/tMJtfgIIibWL1uI2nhcwI5BDO1look3CjEjNQ5UlLFfKAyOrmCkKjNTKZQiab0JfNwD8ErWtD4avs5wdGmY0Wwbw/640?wx_fmt=png&quot; data-type=&quot;png&quot; data-w=&quot;1662&quot; title=&quot;5.png&quot;/&gt;&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;&lt;br/&gt;&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;金丝雀发布的优点：&lt;br/&gt;&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;&lt;br/&gt;&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;1.按比例将流量无差别地导向新版本，新版本故障影响范围小；&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;&lt;br/&gt;&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;2.发布期间逐步对新版本扩容，同时对老版本缩容，资源利用率高。&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;金丝雀发布的缺点：&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;&lt;br/&gt;&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;1.流量无差别地导向新版本，可能会影响重要用户的体验；&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;&lt;br/&gt;&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;2.发布周期长。&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;/p&gt;&lt;h1 data-lake-id=&quot;5153d649a8741bb1080186e3439e266c&quot;&gt;&lt;span&gt;&lt;strong&gt;实践&lt;/strong&gt;&lt;/span&gt;&lt;/h1&gt;&lt;p&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;接下来，我们会基于阿里云的容器运维平台 ACK 以及 MSE 云原生网关对以上介绍的三种发布策略进行实践。这里我们采用最简单的业务架构来展示，即一个云原生网关、一个后端服务（响应中返回当前版本信息）和注册中心。注册中心决定了业务架构中服务发现方式，我们会分别以 K8s 容器服务和 Nacos 两种服务发现机制来实践不同的发布策略。&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;/p&gt;&lt;h2 data-lake-id=&quot;08019d266e031e483e6d1c90970f4d05&quot;&gt;&lt;span&gt;&lt;strong&gt;&lt;span&gt;1.前提条件&lt;/span&gt;&lt;/strong&gt;&lt;/span&gt;&lt;/h2&gt;&lt;p&gt;&lt;/p&gt;&lt;h3 data-lake-id=&quot;bd0136696dabd48e631c9c73730f3b3c&quot;/&gt;&lt;p&gt;&lt;span&gt;&lt;br/&gt;&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;&lt;br/&gt;&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;/p&gt;&lt;h2 data-lake-id=&quot;88cca6a0d9a1cd13364d819f2031022a&quot;&gt;&lt;span&gt;&lt;strong&gt;&lt;span&gt;2.服务发现方式：K8s 容器服务&lt;/span&gt;&lt;/strong&gt;&lt;/span&gt;&lt;/h2&gt;&lt;p&gt;&lt;/p&gt;&lt;h3 data-lake-id=&quot;9e290c61b8c42854af30af99c9fded15&quot;/&gt;&lt;p&gt;&lt;span&gt;在这个例子中，我们使用 K8s 原生的服务发现方式，即通过声明式 Service API 资源将后端服务注册到 CoreDNS。例子中的后端服务提供一个查询当前版本的接口/version，并且当前版本为 v1。云原生网关深度集成 ACK，可以实时动态地从 ACK 集群中获取服务信息，方便通过云原生网关将该后端服务暴露给外部用户。&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;业务架构如下图：&lt;img data-height=&quot;1px&quot; data-ratio=&quot;1&quot; data-src=&quot;https://mmbiz.qpic.cn/mmbiz_png/tMJtfgIIibWL1uI2nhcwI5BDO1look3CjFRwedic9nR73jK8Jb7277dhN36na7icYlvONGO7xfrXmkntfXGiaOYnNQ/640?wx_fmt=png&quot; data-type=&quot;png&quot; data-w=&quot;1&quot; title=&quot;image.gif&quot;/&gt;&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;&lt;img class=&quot;rich_pages wxw-img&quot; data-height=&quot;780px&quot; data-ratio=&quot;0.6141732283464567&quot; data-src=&quot;https://mmbiz.qpic.cn/mmbiz_png/tMJtfgIIibWL1uI2nhcwI5BDO1look3CjYDYz8xkqQNRUfagYkk0k1185ySPe9r3zkjdKSJmPIe7m2MDBibHTbUA/640?wx_fmt=png&quot; data-type=&quot;png&quot; data-w=&quot;1270&quot; title=&quot;6.png&quot;/&gt;&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;/p&gt;&lt;h4 data-lake-id=&quot;3f51412477ee2bbb0345f9735c26dd44&quot;&gt;&lt;span&gt;&lt;strong&gt;&lt;span&gt;1.部署&lt;/span&gt;&lt;/strong&gt;&lt;/span&gt;&lt;/h4&gt;&lt;p&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;将以下资源（Service和Deployment）应用到 ACK 集群，完成后端服务的部署和发布，当前应用版本为 v1。&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;/p&gt;&lt;pre&gt;&lt;section&gt;&lt;pre&gt;&lt;p&gt;&lt;span&gt;&lt;span&gt;apiVersion: v1&lt;/span&gt;&lt;br/&gt;&lt;span&gt;kind: Service&lt;/span&gt;&lt;br/&gt;&lt;span&gt;metadata:&lt;/span&gt;&lt;br/&gt;  name: httpbin&lt;br/&gt;&lt;span&gt;spec:&lt;/span&gt;&lt;br/&gt;  ports:&lt;br/&gt;  - port: 8080&lt;br/&gt;    protocol: TCP&lt;br/&gt;  selector:&lt;br/&gt;    app: httpbin&lt;br/&gt;---&lt;br/&gt;&lt;span&gt;apiVersion: apps/v1&lt;/span&gt;&lt;br/&gt;&lt;span&gt;kind: Deployment&lt;/span&gt;&lt;br/&gt;&lt;span&gt;metadata:&lt;/span&gt;&lt;br/&gt;  name: httpbin-v1&lt;br/&gt;&lt;span&gt;spec:&lt;/span&gt;&lt;br/&gt;  replicas: 3&lt;br/&gt;  selector:&lt;br/&gt;    matchLabels:&lt;br/&gt;      app: httpbin&lt;br/&gt;      version: v1&lt;br/&gt;  template:&lt;br/&gt;    metadata:&lt;br/&gt;      labels:&lt;br/&gt;        app: httpbin&lt;br/&gt;        version: v1&lt;br/&gt;    spec:&lt;br/&gt;      containers:&lt;br/&gt;      - image: specialyang/spring-cloud-httpbin-k8s:v1&lt;br/&gt;        imagePullPolicy: Always&lt;br/&gt;        name: spring-cloud-httpbin-k8s&lt;br/&gt;        ports:&lt;br/&gt;        - containerPort: 8080&lt;br/&gt;&lt;/span&gt;&lt;/p&gt;&lt;/pre&gt;&lt;/section&gt;&lt;p&gt;&lt;span&gt;&lt;br/&gt;&lt;/span&gt;&lt;/p&gt;&lt;/pre&gt;&lt;p&gt;&lt;span&gt;在云原生网关的服务管理-&amp;gt;来源管理中，添加目标 ACK 集群。&lt;br/&gt;&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;&lt;br/&gt;&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;&lt;img class=&quot;rich_pages wxw-img&quot; data-height=&quot;350px&quot; data-ratio=&quot;0.12393767705382436&quot; data-src=&quot;https://mmbiz.qpic.cn/mmbiz_png/tMJtfgIIibWL1uI2nhcwI5BDO1look3CjibxyLZAJnTPoTsWtmnQw3Ua44yEgvaggvnruiadaaia7KJaAias4EI8gEg/640?wx_fmt=png&quot; data-type=&quot;png&quot; data-w=&quot;2824&quot; title=&quot;7.png&quot;/&gt;&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;&lt;br/&gt;&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;在服务管理中导入要暴露给云原生网关的服务 httpbin。&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;&lt;br/&gt;&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;&lt;img class=&quot;rich_pages wxw-img&quot; data-height=&quot;328px&quot; data-ratio=&quot;0.11573747353563868&quot; data-src=&quot;https://mmbiz.qpic.cn/mmbiz_png/tMJtfgIIibWL1uI2nhcwI5BDO1look3CjX5bnGV5aEygquaI5KynJia2bY5ZD9voolnBT0ULd7qBia9WwTicoVnQAg/640?wx_fmt=png&quot; data-type=&quot;png&quot; data-w=&quot;2834&quot; title=&quot;8.png&quot;/&gt;&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;在 httpbin 服务的策略配置中添加服务版本 v1，注意需要选择对应的标签来筛选出 v1 版本的节点，因为目前我们只部署了 v1 版本，所以 v1 版本的节点数占总实例数 100%。&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;&lt;br/&gt;&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;&lt;img class=&quot;rich_pages wxw-img&quot; data-height=&quot;428px&quot; data-ratio=&quot;0.17398373983739837&quot; data-src=&quot;https://mmbiz.qpic.cn/mmbiz_png/tMJtfgIIibWL1uI2nhcwI5BDO1look3Cjt3sx2x5tibia8icBtslk6ibnNM4sTds1vrJHZQn84Tick6lFnrYy9kI3TVA/640?wx_fmt=png&quot; data-type=&quot;png&quot; data-w=&quot;2460&quot; title=&quot;9.png&quot;/&gt;&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;&lt;br/&gt;&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;在路由管理中为该服务创建一条路由规则，从而将服务暴露给外部用户。httpbin 服务暴露的 api 的 path 为/version，请求转发至服务 httpbin 的 v1 版本。&lt;img data-height=&quot;1px&quot; data-ratio=&quot;1&quot; data-src=&quot;https://mmbiz.qpic.cn/mmbiz_png/tMJtfgIIibWL1uI2nhcwI5BDO1look3CjFRwedic9nR73jK8Jb7277dhN36na7icYlvONGO7xfrXmkntfXGiaOYnNQ/640?wx_fmt=png&quot; data-type=&quot;png&quot; data-w=&quot;1&quot; title=&quot;image.gif&quot;/&gt;&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;&lt;br/&gt;&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;&lt;img class=&quot;rich_pages wxw-img&quot; data-height=&quot;260px&quot; data-ratio=&quot;0.10492332526230831&quot; data-src=&quot;https://mmbiz.qpic.cn/mmbiz_png/tMJtfgIIibWL1uI2nhcwI5BDO1look3CjPIuIZpaDricXicEBVPV4QKnW7Fibibp99HWnJZ6ib0qRFhHAakFQPajo7rw/640?wx_fmt=png&quot; data-type=&quot;png&quot; data-w=&quot;2478&quot; title=&quot;10.png&quot;/&gt;&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;&lt;br/&gt;&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;执行以下脚本测试请求的响应结果。&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;/p&gt;&lt;pre&gt;&lt;section&gt;&lt;pre&gt;&lt;p&gt;&lt;span&gt;for i in {1..10}; do curl &lt;span&gt;&quot;${GATEWAY_EXTERNAL_IP}/version&quot;&lt;/span&gt;; echo &lt;span&gt;&quot;&quot;&lt;/span&gt;;  done&lt;br/&gt;&lt;span&gt;version: v1&lt;/span&gt;&lt;br/&gt;&lt;span&gt;version: v1&lt;/span&gt;&lt;br/&gt;&lt;span&gt;version: v1&lt;/span&gt;&lt;br/&gt;&lt;span&gt;version: v1&lt;/span&gt;&lt;br/&gt;&lt;span&gt;version: v1&lt;/span&gt;&lt;br/&gt;&lt;span&gt;version: v1&lt;/span&gt;&lt;br/&gt;&lt;span&gt;version: v1&lt;/span&gt;&lt;br/&gt;&lt;span&gt;version: v1&lt;/span&gt;&lt;br/&gt;&lt;span&gt;version: v1&lt;/span&gt;&lt;br/&gt;&lt;span&gt;version: v1&lt;/span&gt;&lt;/span&gt;&lt;/p&gt;&lt;/pre&gt;&lt;/section&gt;&lt;/pre&gt;&lt;p&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;&lt;strong&gt;&lt;span&gt;2.蓝绿部署&lt;/span&gt;&lt;/strong&gt;&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;蓝绿部署需要按照服务当前版本所占用的资源状况为服务新版本申请同样的资源规格，部署完毕之后将流量整体切换到服务新版本。&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;&lt;img data-height=&quot;1px&quot; data-ratio=&quot;1&quot; data-src=&quot;https://mmbiz.qpic.cn/mmbiz_png/tMJtfgIIibWL1uI2nhcwI5BDO1look3CjFRwedic9nR73jK8Jb7277dhN36na7icYlvONGO7xfrXmkntfXGiaOYnNQ/640?wx_fmt=png&quot; data-type=&quot;png&quot; data-w=&quot;1&quot; title=&quot;image.gif&quot;/&gt;&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;&lt;img class=&quot;rich_pages wxw-img&quot; data-height=&quot;768px&quot; data-ratio=&quot;0.6075949367088608&quot; data-src=&quot;https://mmbiz.qpic.cn/mmbiz_png/tMJtfgIIibWL1uI2nhcwI5BDO1look3CjRqHu0bMI4CZ39DZXTpiaDvR515iboiblzJDgzH8YpqyAj4ZAq6MibibMyDQ/640?wx_fmt=png&quot; data-type=&quot;png&quot; data-w=&quot;1264&quot; title=&quot;11.png&quot;/&gt;&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;&lt;br/&gt;&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;利用 K8s 的声明式 API 资源部署 httpbin 服务的新版本 v2，副本数同样是 3。&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;/p&gt;&lt;pre&gt;&lt;section&gt;&lt;pre&gt;&lt;p&gt;&lt;span&gt;&lt;span&gt;apiVersion: apps/v1&lt;/span&gt;&lt;br/&gt;&lt;span&gt;kind: Deployment&lt;/span&gt;&lt;br/&gt;&lt;span&gt;metadata:&lt;/span&gt;&lt;br/&gt;  name: httpbin-v2&lt;br/&gt;&lt;span&gt;spec:&lt;/span&gt;&lt;br/&gt;  replicas: 3&lt;br/&gt;  selector:&lt;br/&gt;    matchLabels:&lt;br/&gt;      app: httpbin&lt;br/&gt;      version: v2&lt;br/&gt;  template:&lt;br/&gt;    metadata:&lt;br/&gt;      labels:&lt;br/&gt;        app: httpbin&lt;br/&gt;        version: v2&lt;br/&gt;    spec:&lt;br/&gt;      containers:&lt;br/&gt;      - image: specialyang/spring-cloud-httpbin-k8s:v2&lt;br/&gt;        imagePullPolicy: Always&lt;br/&gt;        name: spring-cloud-httpbin-k8s&lt;br/&gt;        ports:&lt;br/&gt;        - containerPort: 8080&lt;/span&gt;&lt;/p&gt;&lt;/pre&gt;&lt;/section&gt;&lt;/pre&gt;&lt;p&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;在 httpbin 服务的策略配置中添加服务版本 v2，注意需要选择对应的标签来筛选出 v2 版本的节点，集群中现在 v1 和 v2 版本的节点数一致，所以各占 50%。&lt;img data-height=&quot;1px&quot; data-ratio=&quot;1&quot; data-src=&quot;https://mmbiz.qpic.cn/mmbiz_png/tMJtfgIIibWL1uI2nhcwI5BDO1look3CjFRwedic9nR73jK8Jb7277dhN36na7icYlvONGO7xfrXmkntfXGiaOYnNQ/640?wx_fmt=png&quot; data-type=&quot;png&quot; data-w=&quot;1&quot; title=&quot;image.gif&quot;/&gt;&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;&lt;br/&gt;&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;&lt;img class=&quot;rich_pages wxw-img&quot; data-height=&quot;446px&quot; data-ratio=&quot;0.18248772504091654&quot; data-src=&quot;https://mmbiz.qpic.cn/mmbiz_png/tMJtfgIIibWL1uI2nhcwI5BDO1look3CjTHFoemIUzpklbGtJYLkXL6Wtw1zKicIYv9ZBfx1xWkIG760pU8gp2tA/640?wx_fmt=png&quot; data-type=&quot;png&quot; data-w=&quot;2444&quot; title=&quot;12.png&quot;/&gt;&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;&lt;br/&gt;&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;现在，我们开始利用蓝绿发布的思想将流量从 v1 整体切换至 v2，仅需要之前修改上面创建的路由规则中目标服务即可。&lt;br/&gt;&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;&lt;br/&gt;&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;&lt;img class=&quot;rich_pages wxw-img&quot; data-height=&quot;240px&quot; data-ratio=&quot;0.09724473257698542&quot; data-src=&quot;https://mmbiz.qpic.cn/mmbiz_png/tMJtfgIIibWL1uI2nhcwI5BDO1look3CjMgLGDJLN1SXVSAa1brwW1y3EvTSaHTtVC2UtVSEwZA6OyYeFiaFoSdw/640?wx_fmt=png&quot; data-type=&quot;png&quot; data-w=&quot;2468&quot; title=&quot;13.png&quot;/&gt;&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;&lt;br/&gt;&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;执行以下脚本测试请求的响应结果。&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;/p&gt;&lt;pre&gt;&lt;section&gt;&lt;pre&gt;&lt;p&gt;&lt;span&gt;for i in {1..10}; do curl &lt;span&gt;&quot;${GATEWAY_EXTERNAL_IP}/version&quot;&lt;/span&gt;; echo &lt;span&gt;&quot;&quot;&lt;/span&gt;;  done&lt;br/&gt;&lt;span&gt;version: v2&lt;/span&gt;&lt;br/&gt;&lt;span&gt;version: v2&lt;/span&gt;&lt;br/&gt;&lt;span&gt;version: v2&lt;/span&gt;&lt;br/&gt;&lt;span&gt;version: v2&lt;/span&gt;&lt;br/&gt;&lt;span&gt;version: v2&lt;/span&gt;&lt;br/&gt;&lt;span&gt;version: v2&lt;/span&gt;&lt;br/&gt;&lt;span&gt;version: v2&lt;/span&gt;&lt;br/&gt;&lt;span&gt;version: v2&lt;/span&gt;&lt;br/&gt;&lt;span&gt;version: v2&lt;/span&gt;&lt;br/&gt;&lt;span&gt;version: v2&lt;/span&gt;&lt;br/&gt;&lt;/span&gt;&lt;/p&gt;&lt;/pre&gt;&lt;/section&gt;&lt;p&gt;&lt;/p&gt;&lt;/pre&gt;&lt;p&gt;&lt;span&gt;现在我们发现访问 api 资源/version 的请求的流量已经全部从 v1 切换至 v2。&lt;/span&gt;&lt;/p&gt;&lt;h4 data-lake-id=&quot;5da09753caad3a27a91dd6bb139be055&quot;&gt;&lt;br/&gt;&lt;/h4&gt;&lt;h4 data-lake-id=&quot;0acdf656716830eb6b1e548c9a245a06&quot;&gt;&lt;span&gt;&lt;strong&gt;&lt;span&gt;3.A/B测试&lt;/span&gt;&lt;/strong&gt;&lt;/span&gt;&lt;/h4&gt;&lt;p&gt;&lt;/p&gt;&lt;h4 data-lake-id=&quot;9473eb0e33352e807bc95d2e277cb6ac&quot;/&gt;&lt;p&gt;&lt;span&gt;A/B 测试基于用户请求的元信息将流量路由到新版本，换句话说，就是可以根据请求内容来动态路由。举个例子，我们希望 User-Agent 的值为 Android 的请求 （来自安卓系统的请求）可以访问新版本，其他系统仍然访问旧版本。&lt;img data-height=&quot;1px&quot; data-ratio=&quot;1&quot; data-src=&quot;https://mmbiz.qpic.cn/mmbiz_png/tMJtfgIIibWL1uI2nhcwI5BDO1look3CjFRwedic9nR73jK8Jb7277dhN36na7icYlvONGO7xfrXmkntfXGiaOYnNQ/640?wx_fmt=png&quot; data-type=&quot;png&quot; data-w=&quot;1&quot; title=&quot;image.gif&quot;/&gt;&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;&lt;br/&gt;&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;&lt;img class=&quot;rich_pages wxw-img&quot; data-height=&quot;766px&quot; data-ratio=&quot;0.6060126582278481&quot; data-src=&quot;https://mmbiz.qpic.cn/mmbiz_png/tMJtfgIIibWL1uI2nhcwI5BDO1look3CjbruyqczpMhIweyrOBhg0qfQ4n64Mek1gOiaib5Sia80bet5FmeZ1G2qpg/640?wx_fmt=png&quot; data-type=&quot;png&quot; data-w=&quot;1264&quot; title=&quot;14.png&quot;/&gt;&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;&lt;br/&gt;&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;我们仍然利用上面实践中部署的 httpbin 的 v1，v2 的 deployment。此外，需要创建两条路由规则：&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;/p&gt;&lt;p&gt;&lt;/p&gt;&lt;p&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;&lt;img class=&quot;rich_pages wxw-img&quot; data-height=&quot;322px&quot; data-ratio=&quot;0.13100081366965013&quot; data-src=&quot;https://mmbiz.qpic.cn/mmbiz_png/tMJtfgIIibWL1uI2nhcwI5BDO1look3CjIJXzUMmqkdVgKuBncZYFgqPWeqntxN6EHcS5FuQyYTSOuoDyNjRDtg/640?wx_fmt=png&quot; data-type=&quot;png&quot; data-w=&quot;2458&quot; title=&quot;15.png&quot;/&gt;&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;&lt;img data-height=&quot;1px&quot; data-ratio=&quot;1&quot; data-src=&quot;https://mmbiz.qpic.cn/mmbiz_png/tMJtfgIIibWL1uI2nhcwI5BDO1look3CjFRwedic9nR73jK8Jb7277dhN36na7icYlvONGO7xfrXmkntfXGiaOYnNQ/640?wx_fmt=png&quot; data-type=&quot;png&quot; data-w=&quot;1&quot; title=&quot;image.gif&quot;/&gt;&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;注意相比 version 路由规则，version-v2 的路由规则中需要增加请求头匹配规则。&lt;img data-height=&quot;1px&quot; data-ratio=&quot;1&quot; data-src=&quot;https://mmbiz.qpic.cn/mmbiz_png/tMJtfgIIibWL1uI2nhcwI5BDO1look3CjFRwedic9nR73jK8Jb7277dhN36na7icYlvONGO7xfrXmkntfXGiaOYnNQ/640?wx_fmt=png&quot; data-type=&quot;png&quot; data-w=&quot;1&quot; title=&quot;image.gif&quot;/&gt;&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;&lt;br/&gt;&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;&lt;img class=&quot;rich_pages wxw-img&quot; data-height=&quot;276px&quot; data-ratio=&quot;0.19166666666666668&quot; data-src=&quot;https://mmbiz.qpic.cn/mmbiz_png/tMJtfgIIibWL1uI2nhcwI5BDO1look3CjSl1U5U8Micf5wBxwubQGicPp2W3icvVbNmU7qc1uYaVYKMicqwwfLaibmoA/640?wx_fmt=png&quot; data-type=&quot;png&quot; data-w=&quot;1440&quot; title=&quot;16.png&quot;/&gt;&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;&lt;br/&gt;&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;通过以下脚本测试 A/B test 的效果。&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;/p&gt;&lt;pre&gt;&lt;section&gt;&lt;pre&gt;&lt;p&gt;&lt;span&gt;// user agent中不含有 android&lt;br/&gt;curl &lt;span&gt;${GATEWAY_EXTERNAL_IP}&lt;/span&gt;/version&lt;br/&gt;version: v1&lt;br/&gt;// user agent中含有 android&lt;br/&gt;curl -H &lt;span&gt;&quot;User-Agent: Mozilla/5.0 (Linux; Android 4.0.3)&quot;&lt;/span&gt; &lt;span&gt;${GATEWAY_EXTERNAL_IP}&lt;/span&gt;/version&lt;br/&gt;version: v2&lt;br/&gt;&lt;/span&gt;&lt;/p&gt;&lt;/pre&gt;&lt;/section&gt;&lt;p&gt;&lt;/p&gt;&lt;/pre&gt;&lt;p&gt;&lt;span&gt;可以看出，当前请求会按照来源的操作系统对流量进行分流。&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;/p&gt;&lt;h4 data-lake-id=&quot;82c49434e67e4f1ddce69c7326e0d306&quot;&gt;&lt;span&gt;&lt;strong&gt;&lt;span&gt;4.金丝雀发布&lt;/span&gt;&lt;/strong&gt;&lt;/span&gt;&lt;/h4&gt;&lt;p&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;金丝雀发布允许引流一小部分流量到服务新版本，待验证通过后，逐步调大流量，直至切流完毕，期间可伴随着新版本的扩容，旧版本的缩容操作，达到资源利用率最大化。&lt;img data-height=&quot;1px&quot; data-ratio=&quot;1&quot; data-src=&quot;https://mmbiz.qpic.cn/mmbiz_png/tMJtfgIIibWL1uI2nhcwI5BDO1look3CjFRwedic9nR73jK8Jb7277dhN36na7icYlvONGO7xfrXmkntfXGiaOYnNQ/640?wx_fmt=png&quot; data-type=&quot;png&quot; data-w=&quot;1&quot; title=&quot;image.gif&quot;/&gt;&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;&lt;br/&gt;&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;&lt;img class=&quot;rich_pages wxw-img&quot; data-height=&quot;768px&quot; data-ratio=&quot;0.6114649681528662&quot; data-src=&quot;https://mmbiz.qpic.cn/mmbiz_png/tMJtfgIIibWL1uI2nhcwI5BDO1look3CjxxdB8Z3VV3Wsh1B0MzTcF77Osb4Piaczky6ne43T0oRkTicUzlEMBQjA/640?wx_fmt=png&quot; data-type=&quot;png&quot; data-w=&quot;1256&quot; title=&quot;17.png&quot;/&gt;&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;&lt;br/&gt;&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;在金丝雀发布策略中，服务新版本的副本初始部署数无需与原始保持一致。仅需保持资源始终满足灰度流量，所以我们将新版本的副本数调为 1，可以在服务策略中服务版本模块看到当前各版本节点数的占比情况。&lt;img data-height=&quot;1px&quot; data-ratio=&quot;1&quot; data-src=&quot;https://mmbiz.qpic.cn/mmbiz_png/tMJtfgIIibWL1uI2nhcwI5BDO1look3CjFRwedic9nR73jK8Jb7277dhN36na7icYlvONGO7xfrXmkntfXGiaOYnNQ/640?wx_fmt=png&quot; data-type=&quot;png&quot; data-w=&quot;1&quot; title=&quot;image.gif&quot;/&gt;&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;&lt;br/&gt;&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;&lt;img class=&quot;rich_pages wxw-img&quot; data-height=&quot;444px&quot; data-ratio=&quot;0.18226600985221675&quot; data-src=&quot;https://mmbiz.qpic.cn/mmbiz_png/tMJtfgIIibWL1uI2nhcwI5BDO1look3CjthqgdqGdBgTaicdqicrmoY4ibJZXvquVS8qjiaYqm0m426iaFIkmxop7kUA/640?wx_fmt=png&quot; data-type=&quot;png&quot; data-w=&quot;2436&quot; title=&quot;18.png&quot;/&gt;&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;&lt;br/&gt;&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;清除掉其他发布策略遗留的路由规则，我们新创建一条路由规则，在目标服务中按照权重将流量转发至新旧版本。&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;&lt;br/&gt;&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;&lt;img class=&quot;rich_pages wxw-img&quot; data-height=&quot;278px&quot; data-ratio=&quot;0.11319218241042345&quot; data-src=&quot;https://mmbiz.qpic.cn/mmbiz_png/tMJtfgIIibWL1uI2nhcwI5BDO1look3CjMkZoJuUOvr94l6aIiaQspE4kKrmEAA2gYk1zaKiah0aMpjaZXrLVBlsg/640?wx_fmt=png&quot; data-type=&quot;png&quot; data-w=&quot;2456&quot; title=&quot;19.png&quot;/&gt;&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;&lt;br/&gt;&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;其中，目标服务需要配置两个目的地，httpbin 的 v1 和 v2 版本，并设置对应的流量比。&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;&lt;br/&gt;&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;&lt;img class=&quot;rich_pages wxw-img&quot; data-height=&quot;542px&quot; data-ratio=&quot;0.36522911051212936&quot; data-src=&quot;https://mmbiz.qpic.cn/mmbiz_png/tMJtfgIIibWL1uI2nhcwI5BDO1look3Cjmo2zYrXgDwu2k4zkbVFxLDsD3jCTcvgYPy3lMVWGu3EhEkFumuZLibw/640?wx_fmt=png&quot; data-type=&quot;png&quot; data-w=&quot;1484&quot; title=&quot;20.png&quot;/&gt;&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;&lt;br/&gt;&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;通过以下脚本测试金丝雀发布的效果。&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;/p&gt;&lt;pre&gt;&lt;section&gt;&lt;pre&gt;&lt;p&gt;&lt;span&gt;for i in {1..10}; do curl &lt;span&gt;&quot;${GATEWAY_EXTERNAL_IP}/version&quot;&lt;/span&gt;; echo &lt;span&gt;&quot;&quot;&lt;/span&gt;;  done&lt;br/&gt;&lt;span&gt;version: v1&lt;/span&gt;&lt;br/&gt;&lt;span&gt;version: v1&lt;/span&gt;&lt;br/&gt;&lt;span&gt;version: v1&lt;/span&gt;&lt;br/&gt;&lt;span&gt;version: v1&lt;/span&gt;&lt;br/&gt;&lt;span&gt;version: v1&lt;/span&gt;&lt;br/&gt;&lt;span&gt;version: v2&lt;/span&gt;&lt;br/&gt;&lt;span&gt;version: v1&lt;/span&gt;&lt;br/&gt;&lt;span&gt;version: v2&lt;/span&gt;&lt;br/&gt;&lt;span&gt;version: v1&lt;/span&gt;&lt;br/&gt;&lt;span&gt;version: v1&lt;/span&gt;&lt;/span&gt;&lt;/p&gt;&lt;/pre&gt;&lt;/section&gt;&lt;/pre&gt;&lt;p&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;在以上测试结果中，可以发现 10 个请求中，有 2 个是访问的新版本 v2，其流量比确实符合期望的 8:2。&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;在真实业务场景中，新版本验证完毕后，就可以继续调大访问新版本的流量权重，期间注意对新版本扩容，按需对旧版本缩容。&lt;br/&gt;&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;&lt;br/&gt;&lt;/span&gt;&lt;/p&gt;&lt;h2 data-lake-id=&quot;6764cc140fa6990295b053abddb399c6&quot;&gt;&lt;span&gt;&lt;strong&gt;&lt;span&gt;3.服务发现方式：Nacos 注册中心&lt;/span&gt;&lt;/strong&gt;&lt;/span&gt;&lt;/h2&gt;&lt;p&gt;&lt;/p&gt;&lt;h3 data-lake-id=&quot;30d62b2cccc82bd143fefa1fa7cff49e&quot;/&gt;&lt;p&gt;&lt;span&gt;Kubernetes 平台为容器化应用带来了动态弹性，加快了应用交付进程，提高了底层资源的利用率，但在服务发现能力上，相比其他主流注册中心 Nacos、Consul 等，其功能完整性、可用性上略显不足。因此，即使大部分业务应用已经迁移至 Kubernetes 运维平台，但仍然选择为业务保留了原始的注册中心。&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;针对这种业务场景，我们额外举例当使用 Nacos 注册中心时，如何为服务进行蓝绿发布、A/B 测试和金丝雀发布。例子中的后端服务提供一个查询当前版本的接口/version，并且当前版本为 v1。云原生网关深度集成 MSE Nacos 注册中心，可以实时动态地从 Nacos 实例中获取服务信息，方便通过云原生网关将该后端服务暴露给外部用户。&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;业务架构如下图：&lt;img data-height=&quot;1px&quot; data-ratio=&quot;1&quot; data-src=&quot;https://mmbiz.qpic.cn/mmbiz_png/tMJtfgIIibWL1uI2nhcwI5BDO1look3CjFRwedic9nR73jK8Jb7277dhN36na7icYlvONGO7xfrXmkntfXGiaOYnNQ/640?wx_fmt=png&quot; data-type=&quot;png&quot; data-w=&quot;1&quot; title=&quot;image.gif&quot;/&gt;&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;&lt;br/&gt;&lt;/span&gt;&lt;/p&gt;&lt;h4 data-lake-id=&quot;9fced46ca842387a90c09fb4b4f1d5ac&quot;&gt;&lt;span&gt;&lt;img class=&quot;rich_pages wxw-img&quot; data-height=&quot;652px&quot; data-ratio=&quot;0.5158227848101266&quot; data-src=&quot;https://mmbiz.qpic.cn/mmbiz_png/tMJtfgIIibWL1uI2nhcwI5BDO1look3Cj0EwgMBQ0aGsbRn5kzb24NceiaiacKuHvNmibnD1ibPCP0Hp6dsYPAyfpCg/640?wx_fmt=png&quot; data-type=&quot;png&quot; data-w=&quot;1264&quot; title=&quot;21.png&quot;/&gt;&lt;/span&gt;&lt;/h4&gt;&lt;p&gt;&lt;/p&gt;&lt;h4 data-lake-id=&quot;8caf21c4d1fdb54076e7d55867295590&quot;&gt;&lt;span&gt;&lt;strong&gt;&lt;span&gt;1.部署&lt;/span&gt;&lt;/strong&gt;&lt;/span&gt;&lt;/h4&gt;&lt;p&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;将以下资源（Deployment）应用到 ACK 集群，完成后端服务的部署，并将服务发布到 Nacos 注册中心，当前应用版本为 v1。需要注意以下几点：&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;&lt;br/&gt;&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;1.该 yaml 资源中变量${NACOS_SERVER_ADDRESS}需要替换为你的 MSE Nacos 地址，如果和网关在一个 VPC，那么内网域名即可；否则，你需要配置公网域名。&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;&lt;br/&gt;&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;2.在 K8s Service 服务发现中，Pod 中 Labels 信息可看做是节点的元数据信息。而在 Nacos 注册中心中，节点的元数据信息取决于服务注册时携带的信息。在 Spring Cloud 框架中，通过环境变量 spring.cloud.nacos.discovery.metadata.xxx 无侵入式为节点添加元数据信息，在该例子中，我们以 version 作为版本标用来区分不同版本的节点。因此，需要为业务容器添加环境变量 spring.cloud.nacos.discovery.metadata.version=v1。&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;/p&gt;&lt;pre&gt;&lt;section&gt;&lt;pre&gt;&lt;p&gt;&lt;span&gt;&lt;span&gt;apiVersion: apps/v1&lt;/span&gt;&lt;br/&gt;&lt;span&gt;kind: Deployment&lt;/span&gt;&lt;br/&gt;&lt;span&gt;metadata:&lt;/span&gt;&lt;br/&gt;  name: httpbin-v1&lt;br/&gt;&lt;span&gt;spec:&lt;/span&gt;&lt;br/&gt;  replicas: 3&lt;br/&gt;  selector:&lt;br/&gt;    matchLabels:&lt;br/&gt;      app: httpbin&lt;br/&gt;  template:&lt;br/&gt;    metadata:&lt;br/&gt;      labels:&lt;br/&gt;        app: httpbin&lt;br/&gt;    spec:&lt;br/&gt;      containers:&lt;br/&gt;      - image: specialyang/spring-cloud-httpbin-nacos:v1&lt;br/&gt;        imagePullPolicy: Always&lt;br/&gt;        name: spring-cloud-httpbin-nacos&lt;br/&gt;        ports:&lt;br/&gt;        - containerPort: 8080&lt;br/&gt;        env:&lt;br/&gt;        - name: spring.cloud.nacos.discovery.server-addr&lt;br/&gt;          value: ${NACOS_SERVER_ADDRESS}&lt;br/&gt;        - name: spring.cloud.nacos.discovery.metadata.version&lt;br/&gt;          value: v1&lt;/span&gt;&lt;/p&gt;&lt;/pre&gt;&lt;/section&gt;&lt;/pre&gt;&lt;p&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;在云原生网关的服务管理-&amp;gt;来源管理中，添加目标 MSE Nacos 注册中心集群。&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;&lt;br/&gt;&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;&lt;img class=&quot;rich_pages wxw-img&quot; data-height=&quot;286px&quot; data-ratio=&quot;0.11626016260162601&quot; data-src=&quot;https://mmbiz.qpic.cn/mmbiz_png/tMJtfgIIibWL1uI2nhcwI5BDO1look3Cj5LEDQRj9laLSUtGQ8gicibficjghDuWLCl9Q3gmLHf34wBHs70wkPbZLQ/640?wx_fmt=png&quot; data-type=&quot;png&quot; data-w=&quot;2460&quot; title=&quot;22.png&quot;/&gt;&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;&lt;br/&gt;&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;在服务管理中导入要暴露给云原生网关的服务 httpbin，注意服务来源选择 MSE Nacos 注册中心。&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;&lt;br/&gt;&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;&lt;img class=&quot;rich_pages wxw-img&quot; data-height=&quot;248px&quot; data-ratio=&quot;0.1008130081300813&quot; data-src=&quot;https://mmbiz.qpic.cn/mmbiz_png/tMJtfgIIibWL1uI2nhcwI5BDO1look3CjQNPY25Zc7UXFj0fjOKjA1mVC3UPVc8Bn0X17pm4j3L01ykQuH6fficA/640?wx_fmt=png&quot; data-type=&quot;png&quot; data-w=&quot;2460&quot; title=&quot;23.png&quot;/&gt;&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;&lt;br/&gt;&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;与 K8s Service 服务发现的例子一样，在策略配置中添加服务版本 v1，标签名和标签值可以选择为我们在 httpbin 服务注册时添加的元数据信息 version=v1。之后配置路由匹配 path为/version 的请求转发至 httpbin 服务的 v1 版本。&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;执行以下脚本测试请求的响应结果。&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;/p&gt;&lt;pre&gt;&lt;section&gt;&lt;pre&gt;&lt;p&gt;&lt;span&gt;for i in {1..10}; do curl &lt;span&gt;&quot;${GATEWAY_EXTERNAL_IP}/version&quot;&lt;/span&gt;; echo &lt;span&gt;&quot;&quot;&lt;/span&gt;;  done&lt;br/&gt;&lt;span&gt;version: v1&lt;/span&gt;&lt;br/&gt;&lt;span&gt;version: v1&lt;/span&gt;&lt;br/&gt;&lt;span&gt;version: v1&lt;/span&gt;&lt;br/&gt;&lt;span&gt;version: v1&lt;/span&gt;&lt;br/&gt;&lt;span&gt;version: v1&lt;/span&gt;&lt;br/&gt;&lt;span&gt;version: v1&lt;/span&gt;&lt;br/&gt;&lt;span&gt;version: v1&lt;/span&gt;&lt;br/&gt;&lt;span&gt;version: v1&lt;/span&gt;&lt;br/&gt;&lt;span&gt;version: v1&lt;/span&gt;&lt;br/&gt;&lt;span&gt;version: v1&lt;/span&gt;&lt;br/&gt;&lt;/span&gt;&lt;/p&gt;&lt;/pre&gt;&lt;/section&gt;&lt;p&gt;&lt;/p&gt;&lt;/pre&gt;&lt;h4 data-lake-id=&quot;a3e5f3f8464e0570044bd7f0ade0f9d5&quot;&gt;&lt;span&gt;&lt;strong&gt;&lt;span&gt;2.蓝绿部署&lt;/span&gt;&lt;/strong&gt;&lt;/span&gt;&lt;/h4&gt;&lt;p&gt;&lt;/p&gt;&lt;h4 data-lake-id=&quot;711be72e34e90adbf28ee9aee4d5cd64&quot;/&gt;&lt;p&gt;&lt;span&gt;其发布策略如下图所示：&lt;img data-height=&quot;1px&quot; data-ratio=&quot;1&quot; data-src=&quot;https://mmbiz.qpic.cn/mmbiz_png/tMJtfgIIibWL1uI2nhcwI5BDO1look3CjFRwedic9nR73jK8Jb7277dhN36na7icYlvONGO7xfrXmkntfXGiaOYnNQ/640?wx_fmt=png&quot; data-type=&quot;png&quot; data-w=&quot;1&quot; title=&quot;image.gif&quot;/&gt;&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;&lt;br/&gt;&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;&lt;img class=&quot;rich_pages wxw-img&quot; data-height=&quot;652px&quot; data-ratio=&quot;0.5182829888712241&quot; data-src=&quot;https://mmbiz.qpic.cn/mmbiz_png/tMJtfgIIibWL1uI2nhcwI5BDO1look3Cjg48pzlNIYhcQ2hfFGNmYmGwNWkN0MJaLfeZiaCE7iay9cKdSbRUgV06w/640?wx_fmt=png&quot; data-type=&quot;png&quot; data-w=&quot;1258&quot; title=&quot;24.png&quot;/&gt;&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;&lt;br/&gt;&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;部署 httpbin 服务的新版本 v2，注意注册中心与上面保持一致，同时为业务容器增加环境变量 spring.cloud.nacos.discovery.metadata.version=v2，业务应用启动时会向指定 Nacos 注册服务，同时携带上用户自定义的元数据信息。云原生网关可以利用这些元数据信息来对节点区分不同的版本。&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;/p&gt;&lt;pre&gt;&lt;section&gt;&lt;pre&gt;&lt;p&gt;&lt;span&gt;&lt;span&gt;apiVersion: apps/v1&lt;/span&gt;&lt;br/&gt;&lt;span&gt;kind: Deployment&lt;/span&gt;&lt;br/&gt;&lt;span&gt;metadata:&lt;/span&gt;&lt;br/&gt;  name: httpbin-v2&lt;br/&gt;&lt;span&gt;spec:&lt;/span&gt;&lt;br/&gt;  replicas: 3&lt;br/&gt;  selector:&lt;br/&gt;    matchLabels:&lt;br/&gt;      app: httpbin&lt;br/&gt;  template:&lt;br/&gt;    metadata:&lt;br/&gt;      labels:&lt;br/&gt;        app: httpbin&lt;br/&gt;    spec:&lt;br/&gt;      containers:&lt;br/&gt;      - image: specialyang/spring-cloud-httpbin-nacos:v2&lt;br/&gt;        imagePullPolicy: Always&lt;br/&gt;        name: spring-cloud-httpbin-nacos&lt;br/&gt;        ports:&lt;br/&gt;        - containerPort: 8080&lt;br/&gt;        env:&lt;br/&gt;        - name: spring.cloud.nacos.discovery.server-addr&lt;br/&gt;          value: ${NACOS_SERVER_ADDRESS}&lt;br/&gt;        - name: spring.cloud.nacos.discovery.metadata.version&lt;br/&gt;          value: v2&lt;br/&gt;&lt;/span&gt;&lt;/p&gt;&lt;/pre&gt;&lt;/section&gt;&lt;p&gt;&lt;/p&gt;&lt;/pre&gt;&lt;p&gt;&lt;span&gt;与 K8s Service 的例子中蓝绿发布操作一样，在 httpbin 服务的策略配置中添加服务版本 v2，然后将路由规则中的目标服务 httpbin 的 v1 版本修改为 v2 版本，发布成功之后，查看请求结果全部为 version: v2。&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;/p&gt;&lt;h4 data-lake-id=&quot;f4f983c0fa52653cbbb6d78e4f19e653&quot;&gt;&lt;span&gt;&lt;strong&gt;&lt;span&gt;3.A/B 测试&lt;/span&gt;&lt;/strong&gt;&lt;/span&gt;&lt;/h4&gt;&lt;p&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;其发布策略如下图所示：&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;&lt;br/&gt;&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;&lt;img class=&quot;rich_pages wxw-img&quot; data-height=&quot;656px&quot; data-ratio=&quot;0.5222929936305732&quot; data-src=&quot;https://mmbiz.qpic.cn/mmbiz_png/tMJtfgIIibWL1uI2nhcwI5BDO1look3CjHmWCzQofKqvibyHJJ87HT0htHXaE3psoDc70v4ufZkWOznsgM6BBndA/640?wx_fmt=png&quot; data-type=&quot;png&quot; data-w=&quot;1256&quot; title=&quot;25.png&quot;/&gt;&lt;span&gt;‍&lt;/span&gt;&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;&lt;br/&gt;&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;‍&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;我们同样用之前的例子，User-Agent 的值为 Android 的请求 （来自安卓系统的请求）可以访问新版本，其他系统仍然访问旧版本。涉及的路由规则的操作、与验证方式与 K8s Service 的例子一致。&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;/p&gt;&lt;h4 data-lake-id=&quot;9138876741d4906d455bbff264946202&quot;&gt;&lt;span&gt;&lt;strong&gt;&lt;span&gt;4.金丝雀发布&lt;/span&gt;&lt;/strong&gt;&lt;/span&gt;&lt;/h4&gt;&lt;p&gt;&lt;span&gt;&lt;br/&gt;&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;其发布策略如下图所示：&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;&lt;br/&gt;&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;&lt;img class=&quot;rich_pages wxw-img&quot; data-height=&quot;648px&quot; data-ratio=&quot;0.5142857142857142&quot; data-src=&quot;https://mmbiz.qpic.cn/mmbiz_png/tMJtfgIIibWL1uI2nhcwI5BDO1look3CjZ0w57CeN5vPk8ibZU40rvRar592KTs5OAIY7nTPzMibiaFYR2sSxmmcCA/640?wx_fmt=png&quot; data-type=&quot;png&quot; data-w=&quot;1260&quot; title=&quot;26.png&quot;/&gt;&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;&lt;br/&gt;&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;同样，涉及的路由规则的操作、与验证方式与 K8s Service 的例子一致。&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;/p&gt;&lt;h1 data-lake-id=&quot;32c9a382c150d7bf28ee463d6d196f6f&quot;&gt;&lt;span&gt;&lt;strong&gt;总结&lt;/strong&gt;&lt;/span&gt;&lt;/h1&gt;&lt;p&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;本文对常见的发布策略进行了简单介绍和原理解析，并以图文并茂的方式对每个发布策略进行了详细探讨，总结如下：&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;&lt;br/&gt;&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;&lt;br/&gt;&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;云原生网关以托管的方式来作为您的流量入口，提供了丰富的流量治理能力，支持多种服务发现方式，如 K8s Service、Nacos、Eurake、ECS 和域名，并以统一的模型支持了服务版本以及灰度发布能力。在上面的实践中，可以发现两种服务发现方式仅仅是元数据信息所处的位置不同，但服务版本管理以及路由规则中的灰度发布模型都是一致的，您可以轻松学会为不同服务发现方式的服务进行灰度发布，确保版本升级过程中平滑无损。&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;&lt;strong&gt;&lt;span&gt;精&lt;/span&gt;&lt;/strong&gt;&lt;strong&gt;&lt;span&gt;彩推荐&lt;/span&gt;&lt;/strong&gt;&lt;strong/&gt;&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;&lt;strong&gt;&lt;span&gt;&lt;br/&gt;&lt;/span&gt;&lt;/strong&gt;&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;a target=&quot;_blank&quot; href=&quot;http://mp.weixin.qq.com/s?__biz=MzI0NTE4NjA0OQ==&amp;amp;mid=2658380199&amp;amp;idx=1&amp;amp;sn=2990d309df47e7309f23dcd48a245aa1&amp;amp;chksm=f2d562c9c5a2ebdf2b4a08207451bf8a06987149ff141855e773adc383308cb8745cc9f41cd8&amp;amp;scene=21#wechat_redirect&quot; textvalue=&quot;你已选中了添加链接的内容&quot; linktype=&quot;text&quot; imgurl=&quot;&quot; imgdata=&quot;null&quot; data-itemshowtype=&quot;11&quot; tab=&quot;innerlink&quot; data-linktype=&quot;1&quot;&gt;&lt;span&gt;&lt;span class=&quot;js_jump_icon h5_image_link&quot; data-positionback=&quot;static&quot;&gt;&lt;img class=&quot;rich_pages wxw-img&quot; data-galleryid=&quot;&quot; data-ratio=&quot;0.4255555555555556&quot; data-s=&quot;300,640&quot; data-src=&quot;https://mmbiz.qpic.cn/mmbiz_jpg/tMJtfgIIibWL9gaKlucCgIC9J7TJCDnibeVgqk42RYQwqX1PbqV3sOWBOzbC9Hflibgib2LicLvh8WXf3icJ5O3vXEVQ/640?wx_fmt=jpeg&quot; data-type=&quot;jpeg&quot; data-w=&quot;900&quot;/&gt;&lt;/span&gt;&lt;/span&gt;&lt;/a&gt;&lt;/p&gt;&lt;p&gt;&lt;/p&gt;&lt;p&gt;&lt;a target=&quot;_blank&quot; href=&quot;http://mp.weixin.qq.com/s?__biz=MzI0NTE4NjA0OQ==&amp;amp;mid=2658380190&amp;amp;idx=1&amp;amp;sn=88e730edc85038fec8105e0a1adfc66a&amp;amp;chksm=f2d562f0c5a2ebe66b6c71d50db53a1c79cc47390af2fe945cedf7bf9ca641527dc1713591b7&amp;amp;scene=21#wechat_redirect&quot; textvalue=&quot;你已选中了添加链接的内容&quot; linktype=&quot;text&quot; imgurl=&quot;&quot; imgdata=&quot;null&quot; data-itemshowtype=&quot;0&quot; tab=&quot;innerlink&quot; data-linktype=&quot;1&quot; wah-hotarea=&quot;click&quot; hasload=&quot;1&quot;&gt;&lt;span&gt;&lt;span class=&quot;js_jump_icon h5_image_link&quot; data-positionback=&quot;static&quot;&gt;&lt;img class=&quot;rich_pages wxw-img&quot; data-galleryid=&quot;&quot; data-ratio=&quot;0.4255555555555556&quot; data-s=&quot;300,640&quot; data-src=&quot;https://mmbiz.qpic.cn/mmbiz_jpg/tMJtfgIIibWKOZ4n2ia8n3daNicX7HyNcO3plkxsPiaDKtVOfANCCRN7s9xxAnlhk7u5PpDKibkcZCTMNzBJY0ox0kw/640?wx_fmt=jpeg&quot; data-type=&quot;jpeg&quot; data-w=&quot;900&quot;/&gt;&lt;/span&gt;&lt;/span&gt;&lt;/a&gt;&lt;/p&gt;&lt;section class=&quot;mp_profile_iframe_wrp&quot;&gt;&lt;mpprofile class=&quot;js_uneditable custom_select_card mp_profile_iframe&quot; data-pluginname=&quot;mpprofile&quot; data-id=&quot;MzI0NTE4NjA0OQ==&quot; data-headimg=&quot;http://mmbiz.qpic.cn/mmbiz_png/tMJtfgIIibWJZdQ8EicOpoDF9lteAE7gGBotfOe7nZWKicaoH7URJUKISmAkBp7SiakzBrEqib5ZeZYrmIUClJUt1vQ/0?wx_fmt=png&quot; data-nickname=&quot;阿里云云栖号&quot; data-alias=&quot;yunqiinsight&quot; data-signature=&quot;阿里云官网内容平台，汇聚阿里云优质内容（入门、文档、案例、最佳实践、直播等）。&quot; data-from=&quot;1&quot;/&gt;&lt;/section&gt;&lt;section&gt;&lt;span&gt;‍&lt;/span&gt;&lt;/section&gt;&lt;section&gt;&lt;span&gt;&lt;strong&gt;&lt;span&gt;点击上方  一键关注&lt;/span&gt;&lt;/strong&gt;&lt;br/&gt;&lt;/span&gt;&lt;/section&gt;&lt;section&gt;&lt;span&gt;&lt;strong&gt;&lt;span&gt;从现在开始 学习技术&lt;/span&gt;&lt;/strong&gt;&lt;br/&gt;&lt;/span&gt;&lt;/section&gt;&lt;section&gt;&lt;br/&gt;&lt;/section&gt;&lt;section&gt;&lt;br/&gt;&lt;/section&gt;&lt;section&gt;&lt;span&gt;&lt;strong&gt;↓ 新年来临 阿里云最新、最热、最全的活动已全面开启 🔔  &lt;/strong&gt;&lt;/span&gt;&lt;/section&gt;
                &lt;/div&gt;

                

                



                
                &lt;/div&gt;&lt;/div&gt;</content:encoded>
</item>
<item>
<guid>a98e0aaf092a03c63a41b61658a72ecf</guid>
<title>Python再获年度编程语言，微软或成最大赢家</title>
<link>https://toutiao.io/k/22vru46</link>
<content:encoded>&lt;div&gt;&lt;div&gt;&lt;div class=&quot;rich_media_content &quot; id=&quot;js_content&quot;&gt;
                    

                    
                    
                    
                    &lt;section data-mpa-powered-by=&quot;yiban.io&quot; data-darkmode-bgcolor-16095509242984=&quot;rgb(25, 25, 25)&quot; data-darkmode-original-bgcolor-16095509242984=&quot;rgb(255, 255, 255)&quot; data-style=&quot;white-space: normal; max-width: 100%; letter-spacing: 0.544px; text-size-adjust: auto; background-color: rgb(255, 255, 255); font-family: &amp;quot;Helvetica Neue&amp;quot;, Helvetica, &amp;quot;Hiragino Sans GB&amp;quot;, &amp;quot;Microsoft YaHei&amp;quot;, Arial, sans-serif; box-sizing: border-box !important; overflow-wrap: break-word !important;&quot; class=&quot;js_darkmode__0&quot;&gt;&lt;section data-darkmode-bgcolor-16095509242984=&quot;rgb(25, 25, 25)&quot; data-darkmode-original-bgcolor-16095509242984=&quot;rgb(255, 255, 255)&quot;&gt;&lt;section data-darkmode-bgcolor-16095509242984=&quot;rgb(25, 25, 25)&quot; data-darkmode-original-bgcolor-16095509242984=&quot;rgb(255, 255, 255)&quot;&gt;&lt;section data-id=&quot;85660&quot; data-custom=&quot;rgb(117, 117, 118)&quot; data-darkmode-bgcolor-16095509242984=&quot;rgb(25, 25, 25)&quot; data-darkmode-original-bgcolor-16095509242984=&quot;rgb(255, 255, 255)&quot;&gt;&lt;section data-darkmode-bgcolor-16095509242984=&quot;rgb(25, 25, 25)&quot; data-darkmode-original-bgcolor-16095509242984=&quot;rgb(255, 255, 255)&quot;&gt;&lt;section data-darkmode-bgcolor-16095509242984=&quot;rgb(25, 25, 25)&quot; data-darkmode-original-bgcolor-16095509242984=&quot;rgb(255, 255, 255)&quot;&gt;&lt;section data-darkmode-bgcolor-16095509242984=&quot;rgb(25, 25, 25)&quot; data-darkmode-original-bgcolor-16095509242984=&quot;rgb(255, 255, 255)&quot;&gt;&lt;section data-darkmode-bgcolor-16095509242984=&quot;rgb(25, 25, 25)&quot; data-darkmode-original-bgcolor-16095509242984=&quot;rgb(255, 255, 255)&quot;&gt;&lt;section data-darkmode-bgcolor-16095509242984=&quot;rgb(25, 25, 25)&quot; data-darkmode-original-bgcolor-16095509242984=&quot;rgb(255, 255, 255)&quot;&gt;&lt;section data-id=&quot;85660&quot; data-custom=&quot;rgb(117, 117, 118)&quot; data-darkmode-bgcolor-16095509242984=&quot;rgb(25, 25, 25)&quot; data-darkmode-original-bgcolor-16095509242984=&quot;rgb(255, 255, 255)&quot;&gt;&lt;section data-darkmode-bgcolor-16095509242984=&quot;rgb(25, 25, 25)&quot; data-darkmode-original-bgcolor-16095509242984=&quot;rgb(255, 255, 255)&quot; data-style=&quot;margin-top: 2em; padding-top: 0.5em; padding-bottom: 0.5em; max-width: 100%; border-style: solid none; text-decoration: inherit; border-top-color: rgb(204, 204, 204); border-bottom-color: rgb(204, 204, 204); border-top-width: 1px; border-bottom-width: 1px; box-sizing: border-box !important; overflow-wrap: break-word !important;&quot; class=&quot;js_darkmode__1&quot;&gt;&lt;section&gt;&lt;span&gt;机器之心报道&lt;/span&gt;&lt;/section&gt;&lt;section&gt;&lt;span&gt;&lt;strong&gt;编辑：蛋酱、小舟&lt;/strong&gt;&lt;/span&gt;&lt;/section&gt;&lt;/section&gt;&lt;/section&gt;&lt;/section&gt;&lt;/section&gt;&lt;/section&gt;&lt;/section&gt;&lt;/section&gt;&lt;/section&gt;&lt;/section&gt;&lt;/section&gt;&lt;/section&gt;&lt;blockquote data-type=&quot;2&quot; data-url=&quot;&quot; data-author-name=&quot;&quot; data-content-utf8-length=&quot;21&quot; data-source-title=&quot;&quot;&gt;&lt;section&gt;&lt;section&gt;&lt;p&gt;&lt;span&gt;&lt;span&gt;这已是 Python 第五次被评为 Tiobe 年度编程语言。&lt;/span&gt;&lt;/span&gt;&lt;/p&gt;&lt;/section&gt;&lt;/section&gt;&lt;/blockquote&gt;&lt;section&gt;&lt;br/&gt;&lt;/section&gt;&lt;section&gt;&lt;span&gt;成立于 2000 年的 Tiobe 公司，二十多年来一直以衡量编程语言流行度而闻名。由 Tiobe 推出的年度编程语言奖项 2021 年再度花落 Python，这是 Python 连续第二年被评为年度编程语言，也是第五次获得该奖项。&lt;/span&gt;&lt;/section&gt;&lt;section&gt;&lt;br/&gt;&lt;/section&gt;&lt;section&gt;&lt;span&gt;该奖项旨在颁发给一年内使用率增幅最大的编程语言。Tiobe 表示，C# 的增幅原本有望首次夺冠，然而 Python 在 2021 年最后一个月超过了 C#。Python 近年来的流行得益于机器学习、数据科学等领域的推动。&lt;/span&gt;&lt;/section&gt;&lt;section&gt;&lt;br/&gt;&lt;/section&gt;&lt;p&gt;&lt;img class=&quot;rich_pages wxw-img js_insertlocalimg&quot; data-ratio=&quot;0.471875&quot; data-s=&quot;300,640&quot; data-src=&quot;https://mmbiz.qpic.cn/mmbiz_png/KmXPKA19gWicHQ3ia1WuiaDmJseibjrfDn10zhxLz544Yhgr4rxc27zZJRzoZ4yRqO6qTsbWLoBFwYufxyR1bjEQjw/640?wx_fmt=png&quot; data-type=&quot;png&quot; data-w=&quot;1280&quot;/&gt;&lt;/p&gt;&lt;section&gt;&lt;br/&gt;&lt;/section&gt;&lt;section&gt;&lt;span&gt;Tiobe 的排名是基于搜索引擎统计的，根据开发人员搜索的编程语言关键词，按搜索份额划分。&lt;/span&gt;&lt;/section&gt;&lt;section&gt;&lt;br/&gt;&lt;/section&gt;&lt;section&gt;&lt;span&gt;Tiobe 的年度排名也反映出微软对于开发者的重要性。&lt;/span&gt;&lt;/section&gt;&lt;section&gt;&lt;br/&gt;&lt;/section&gt;&lt;section&gt;&lt;span&gt;微软在 2020 年聘请了 Python 之父 Guido van Rossum，旨在提高 Python 语言的效率。Python 在高端硬件上运行良好，在移动设备上运行滞后，但它为 Azure 等云平台上的开发创造了机会。&lt;/span&gt;&lt;/section&gt;&lt;section&gt;&lt;br/&gt;&lt;/section&gt;&lt;p&gt;&lt;img class=&quot;rich_pages wxw-img js_insertlocalimg&quot; data-ratio=&quot;1.2507122507122508&quot; data-s=&quot;300,640&quot; data-src=&quot;https://mmbiz.qpic.cn/mmbiz_png/KmXPKA19gWicHQ3ia1WuiaDmJseibjrfDn10UBerZAV6oZ6diaRzQpWtKbaZKYaUg8C6icthJdIN0vphvLIR9MruaDIg/640?wx_fmt=png&quot; data-type=&quot;png&quot; data-w=&quot;702&quot;/&gt;&lt;/p&gt;&lt;section&gt;&lt;span&gt;&lt;em&gt;&lt;span&gt;Python 之父 Guido van Rossum&lt;/span&gt;&lt;/em&gt;&lt;/span&gt;&lt;span&gt; &lt;/span&gt;&lt;/section&gt;&lt;section&gt;&lt;br/&gt;&lt;/section&gt;&lt;section&gt;&lt;span&gt;Tiobe 的年度排名中第二受欢迎的语言 C# 则是由微软技术研究员 Anders Hejlsberg 为 .NET Framework 和微软的开发者工具 Visual Studio 设计的语言。 &lt;/span&gt;&lt;/section&gt;&lt;section&gt;&lt;br/&gt;&lt;/section&gt;&lt;section&gt;&lt;span&gt;相比之下，尽管 Java 仍是开发者们学习的基本语言，但企业应用的标准已从 Java 变为 Python。&lt;/span&gt;&lt;/section&gt;&lt;section&gt;&lt;br/&gt;&lt;/section&gt;&lt;section&gt;&lt;span&gt;「虽然距离 Java 在 2001 年创下 26.49% 的历史记录还很遥远，但 Python 已经成为许多领域事实上的标准编程语言，而这种胜利并不会很快停止，」 Tiobe 主席 Paul Jensen 指出潜在的新竞争者的数量是有限的：「除了 Swift 和 Go 之外，我们预计不会很快有任何新语言进入前 5 名甚至前 3 名。」&lt;/span&gt;&lt;/section&gt;&lt;section&gt;&lt;br/&gt;&lt;/section&gt;&lt;section&gt;&lt;span&gt;今年的排行榜中出现了一些搅局者。Rust 是一种处理内存安全漏洞的系统编程语言，目前排名 26 位， 领先于 MIT 的 Julia 和 Kotlin，一种由谷歌认可的用于 Android 应用程序开发的语言。 &lt;/span&gt;&lt;/section&gt;&lt;section&gt;&lt;br/&gt;&lt;/section&gt;&lt;section&gt;&lt;span&gt;Rust 在 2021 年的表现很突出，得到了 Facebook、AWS、微软 Azure 和谷歌云的支持。 &lt;/span&gt;&lt;/section&gt;&lt;section&gt;&lt;br/&gt;&lt;/section&gt;&lt;section&gt;&lt;span&gt;Tiobe 称，苹果的 Swift（用于 iOS 和 macOS 应用程序开发）从第 13 位跃升至第 10 位，而谷歌的 Go 从第 14 位略微升至第 13 位，Kotlin 从第 40 位上升到第 29 位，谷歌的 Dart 从第 25 位跌至第 37 位，Julia 从第 23 位跌至第 28 位，而微软的 TypeScript 从第 42 位跌至第 49 位。&lt;/span&gt;&lt;/section&gt;&lt;section&gt;&lt;span&gt; &lt;/span&gt;&lt;/section&gt;&lt;section&gt;&lt;span&gt;Tiobe 2022 年 1 月榜单中，排名前 10 位的语言是 Python、C、Java、C++、C#、Visual Basic、JavaScript、汇编语言、SQL 和 Swift。&lt;/span&gt;&lt;/section&gt;&lt;section&gt;&lt;br/&gt;&lt;/section&gt;&lt;p&gt;&lt;img class=&quot;rich_pages wxw-img js_insertlocalimg&quot; data-ratio=&quot;0.61171875&quot; data-s=&quot;300,640&quot; data-src=&quot;https://mmbiz.qpic.cn/mmbiz_png/KmXPKA19gWicHQ3ia1WuiaDmJseibjrfDn10jIpnZlviazIMj0vgGdSDGSaxraE4iaibFqGLzKJuAuhfnQgr2MdBvNWaw/640?wx_fmt=png&quot; data-type=&quot;png&quot; data-w=&quot;1280&quot;/&gt;&lt;/p&gt;&lt;section&gt;&lt;span/&gt;&lt;/section&gt;&lt;section&gt;&lt;br/&gt;&lt;/section&gt;&lt;section&gt;&lt;span&gt;&lt;em&gt;&lt;span&gt;参考链接：https://www.zdnet.com/article/top-programming-languages-this-developer-favorite-shows-no-sign-of-slowing-down/&lt;/span&gt;&lt;/em&gt;&lt;/span&gt;&lt;/section&gt;&lt;section&gt;&lt;br/&gt;&lt;/section&gt;&lt;p&gt;&lt;img class=&quot;rich_pages wxw-img js_insertlocalimg&quot; data-cropselx1=&quot;0&quot; data-cropselx2=&quot;578&quot; data-cropsely1=&quot;0&quot; data-cropsely2=&quot;192&quot; data-ratio=&quot;1.77734375&quot; data-s=&quot;300,640&quot; data-src=&quot;https://mmbiz.qpic.cn/mmbiz_png/KmXPKA19gWicr7bCQicQzg3uKibL9p92bbJcWxMG82TQR0GyDrlMkjhleEev5IJQLx1gbdicjTsZ0daJftAia1krUFQ/640?wx_fmt=png&quot; data-type=&quot;png&quot; data-w=&quot;1280&quot;/&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;&lt;br/&gt;&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;© THE END &lt;/span&gt;&lt;span/&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;转载请联系本公众号获得授权&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;投稿或寻求报道：content@jiqizhixin.com&lt;/span&gt;&lt;/p&gt;
                &lt;/div&gt;

                

                



                
                &lt;/div&gt;&lt;/div&gt;</content:encoded>
</item>
<item>
<guid>1ba65cd5749e9f2d07a0291d3d8a3286</guid>
<title>Hbase构建二级索引的一些解决方案</title>
<link>https://toutiao.io/k/m6v0i1g</link>
<content:encoded>&lt;div&gt;&lt;div&gt;&lt;section data-tool=&quot;mdnice编辑器&quot; data-website=&quot;https://www.mdnice.com&quot; data-mpa-powered-by=&quot;yiban.io&quot;&gt;&lt;figure data-tool=&quot;mdnice编辑器&quot;&gt;&lt;img class=&quot;rich_pages wxw-img&quot; data-ratio=&quot;0.535931790499391&quot; data-src=&quot;https://mmbiz.qpic.cn/mmbiz_png/cAoClgx53Vs1Txw7dmxdKshDJdSN0icIHJqDKCe0K3IHeDU7R7QVRKcHDSsYY24OWibqLa6scEIHOSNjukXhDEIg/640?wx_fmt=png&quot; data-type=&quot;png&quot; data-w=&quot;821&quot;/&gt;&lt;figcaption&gt;hbase构建二级索引&lt;/figcaption&gt;&lt;/figure&gt;&lt;h2 data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span/&gt;1 为什么需要二级索引&lt;/h2&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;HBase的一级索引就是&lt;code&gt;rowkey&lt;/code&gt;，我们仅仅能通过&lt;code&gt;rowkey&lt;/code&gt;进行检索。假设我们相对&lt;code&gt;Hbase&lt;/code&gt;里面列族的列列进行一些组合查询，就只能全表扫描了。表如果较大的话，代价是不可接受的，所以要提出二级索引的方案。&lt;/p&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;strong&gt;二级索引的思想&lt;/strong&gt;：简单理解就是，根据列族的列的值，查出&lt;code&gt;rowkey&lt;/code&gt;，再按照&lt;code&gt;rowkey&lt;/code&gt;就能很快从&lt;code&gt;hbase&lt;/code&gt;查询出数据，我们需要构建出根据列族的列的值，很快查出&lt;code&gt;rowkey&lt;/code&gt;的方案。&lt;/p&gt;&lt;h2 data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span/&gt;2 常见的二级索引方案&lt;/h2&gt;&lt;ol data-tool=&quot;mdnice编辑器&quot; class=&quot;list-paddingleft-2&quot;&gt;&lt;li&gt;&lt;section&gt;&lt;code&gt;MapReduce&lt;/code&gt;方案；&lt;/section&gt;&lt;/li&gt;&lt;li&gt;&lt;section&gt;&lt;code&gt;Coprocessor&lt;/code&gt;方案；&lt;/section&gt;&lt;/li&gt;&lt;li&gt;&lt;section&gt;&lt;code&gt;elasticsearch+hbase&lt;/code&gt;方案；&lt;/section&gt;&lt;/li&gt;&lt;li&gt;&lt;section&gt;&lt;code&gt;Solr+hbase&lt;/code&gt;方案；&lt;/section&gt;&lt;/li&gt;&lt;/ol&gt;&lt;h3 data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span/&gt;2.1 MapReduce方案&lt;span/&gt;&lt;/h3&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;IndexBuilder：利用MR的方式构建Index
长处：并发批量构建Index
缺点：不能实时构建Index&lt;/p&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;strong&gt;举例：&lt;/strong&gt;原表：&lt;/p&gt;&lt;pre data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span/&gt;&lt;code&gt;row  1      f1:name  zhangsan&lt;br/&gt;row  2      f1:name  lisi&lt;br/&gt;row  3      f1:name  wangwu&lt;br/&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;索引表：&lt;/p&gt;&lt;pre data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span/&gt;&lt;code&gt;row     zhangsan    f1:id   1&lt;br/&gt;row     lisi        f1:id   2&lt;br/&gt;row     wangwu      f1:id   3&lt;br/&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;这种方式的思想是再构建一张&lt;code&gt;hbase&lt;/code&gt;表，列族的列这里的&lt;code&gt;name&lt;/code&gt;作为索引表的&lt;code&gt;rowkey&lt;/code&gt;，根据&lt;code&gt;rowkey&lt;/code&gt;查询出数据hbase是很快的，拿到&lt;code&gt;id&lt;/code&gt;后，也就拿到了原表的&lt;code&gt;rowkey&lt;/code&gt;了，因为源表的&lt;code&gt;rowkey&lt;/code&gt;就是&lt;code&gt;id&lt;/code&gt;，每次查询一共需要查询两张表。&lt;/p&gt;&lt;h3 data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span/&gt;2.2 Coprocessor方案&lt;span/&gt;&lt;/h3&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;有关协处理器的讲解，Hbase官方文档是最好的，这里大体说一下它的作用与使用方法。&lt;/p&gt;&lt;ol data-tool=&quot;mdnice编辑器&quot; class=&quot;list-paddingleft-2&quot;&gt;&lt;li&gt;&lt;section&gt;Coprocessor提供了一种机制可以让开发者直接在RegionServer上运行自定义代码来管理数据。通常我们使用get或者scan来从Hbase中获取数据，使用Filter过滤掉不需要的部分，最后在获得的数据上执行业务逻辑。但是当数据量非常大的时候，这样的方式就会在网络层面上遇到瓶颈。客户端也需要强大的计算能力和足够大的内存来处理这么多的数据，客户端的压力就会大大增加。但是如果使用Coprocessor，就可以将业务代码封装，并在RegionServer上运行，也就是数据在哪里，我们就在哪里跑代码，这样就节省了很大的数据传输的网络开销。&lt;/section&gt;&lt;/li&gt;&lt;li&gt;&lt;section&gt;Coprocessor有两种：Observer和Endpoint
EndPoint主要是做一些计算用的，比如计算一些平均值或者求和等等。而Observer的作用类似于传统关系型数据库的触发器，在一些特定的操作之前或者之后触发。学习过Spring的朋友肯定对AOP不陌生，想象一下AOP是怎么回事，就会很好的理解Observer了。Observer Coprocessor在一个特定的事件发生前或发生后触发。在事件发生前触发的Coprocessor需要重写以pre作为前缀的方法，比如prePut。在事件发生后触发的Coprocessor使用方法以post作为前缀，比如postPut。Observer Coprocessor的使用场景如下：&lt;strong&gt;2.1&lt;/strong&gt;. 安全性：在执行Get或Put操作前，通过preGet或prePut方法检查是否允许该操作；&lt;strong&gt;2.2&lt;/strong&gt;. 引用完整性约束：HBase并不直接支持关系型数据库中的引用完整性约束概念，即通常所说的外键。但是我们可以使用Coprocessor增强这种约束。比如根据业务需要，我们每次写入user表的同时也要向user_daily_attendance表中插入一条相应的记录，此时我们可以实现一个Coprocessor，在prePut方法中添加相应的代码实现这种业务需求。&lt;strong&gt;2.3&lt;/strong&gt;. 二级索引：可以使用Coprocessor来维持一个二级索引。正是我们需要的&lt;/section&gt;&lt;/li&gt;&lt;/ol&gt;&lt;h4 data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span/&gt;索引设计思想&lt;span/&gt;&lt;/h4&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;关键部分来了，既然Hbase并没有提供二级索引，那如何实现呢？先看下面这张图&lt;/p&gt;&lt;figure data-tool=&quot;mdnice编辑器&quot;&gt;&lt;img class=&quot;rich_pages wxw-img&quot; data-ratio=&quot;0.7004573170731707&quot; data-src=&quot;https://mmbiz.qpic.cn/mmbiz_jpg/cAoClgx53Vs1Txw7dmxdKshDJdSN0icIH6icmxEdHsUzFNHYXBg9wssiba0e0QbgjibUMGMTCIibfH2gMXoUtuYbictw/640?wx_fmt=jpeg&quot; data-type=&quot;jpeg&quot; data-w=&quot;1312&quot;/&gt;&lt;figcaption&gt;Coprocessor&lt;/figcaption&gt;&lt;/figure&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;我们的需求是找出满足cf1:col2=c22这条记录的cf1:col1的值，实现方法如图，首先根据cf1:col2=c22查找到该记录的行键，然后再通过行健找到对应的cf1:col1的值。其中第二步是很容易实现的，因为Hbase的行键是有索引的，那关键就是第一步，如何通过cf1:col2的值找到它对应的行键。很容易想到建立cf1:col2的映射关系，即将它们提取出来单独放在一张索引表中，原表的值作为索引表的行键，原表的行键作为索引表的值，这就是Hbase的倒排索引的思想。&lt;/p&gt;&lt;h3 data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span/&gt;2.3 elasticsearch+hbase方案&lt;span/&gt;&lt;/h3&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;比如说你现在有一行数据&lt;/p&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;id name age ….30 个字段&lt;/p&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;但是你现在搜索，只需要根据 id name age 三个字段来搜索&lt;/p&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;如果你傻乎乎的往 es 里写入一行数据所有的字段，就会导致说 70% 的数据是不用来搜索的，结果硬是占据了 es 机器上的 filesystem cache 的空间，单挑数据的数据量越大，就会导致 filesystem cahce 能缓存的数据就越少&lt;/p&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;仅仅只是写入 es 中要用来检索的少数几个字段就可以了，比如说，就写入 es id name age 三个字段就可以了，然后你可以把其他的字段数据存在 mysql 里面，我们一般是建议用 es + hbase 的这么一个架构。&lt;/p&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;hbase 的特点是适用于海量数据的在线存储，就是对 hbase 可以写入海量数据，不要做复杂的搜索，就是做很简单的一些根据 id 或者范围进行查询的这么一个操作就可以了&lt;/p&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;从 es 中根据 name 和 age 去搜索，拿到的结果可能就 20 个 doc id，然后根据 doc id 到 hbase 里去查询每个 doc id 对应的完整的数据，给查出来，再返回给前端。&lt;/p&gt;&lt;figure data-tool=&quot;mdnice编辑器&quot;&gt;&lt;img class=&quot;rich_pages wxw-img&quot; data-ratio=&quot;0.6362204724409449&quot; data-src=&quot;https://mmbiz.qpic.cn/mmbiz_png/cAoClgx53Vs1Txw7dmxdKshDJdSN0icIHS48mHKEY8f5CZicLwD6ux0pdAzkDicD43lDDujMrupEBibrS8yxicVfUWw/640?wx_fmt=png&quot; data-type=&quot;png&quot; data-w=&quot;635&quot;/&gt;&lt;figcaption&gt;img&lt;/figcaption&gt;&lt;/figure&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;你最好是写入 es 的数据小于等于，或者是略微大于 es 的 filesystem cache 的内存容量&lt;/p&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;然后你从 es 检索可能就花费 20ms，然后再根据 es 返回的 id 去 hbase 里查询，查 20 条数据，可能也就耗费个 30ms，可能你原来那么玩儿，1T 数据都放 es，会每次查询都是 5 ~ 10 秒，现在可能性能就会很高，每次查询就是 50ms。&lt;/p&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;四个字总结的话，我觉得就是“各司其职”，HBase 就用来存储，ES 就用来做索引，况且目前的实际情况跟文章中说的也很像，要查询的字段就几个，而其他的字段又很大又没用，没必要都丢到 ES 中，浪费查询效率&lt;/p&gt;&lt;h3 data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span/&gt;2.4 Solr+hbase方案&lt;span/&gt;&lt;/h3&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;Solr是一个独立的企业级搜索应用server，它对并提供相似干Web-service的API接口。用户能够通过http请求，向搜索引擎server提交一定格式的XML文件，生成索引。也能够通过Http Get操作提出查找请求，并得到XML格式的返回结果。&lt;/p&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;Solr是一个高性能。採用Java5开发。基干Lucene的全文搜索server。同一时候对其进行了扩展。提供了比Lucene更为丰富的查询语言，同一时候实现了可配置、可扩展并对查询性能进行了优化，而且提供了一个完好的功能节理界面。是一款非常优秀的全文搜索引擎。&lt;/p&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;HBase无可置疑拥有其优势，但其本身仅仅对rowkey支持毫秒级的高速检索，对于多字段的组合查询却无能为力。基于Solr的HBase多条件查询原理非常easy。将HBase表中涉及条件过滤的字段和rowkey在Solr中建立索引，通过Solr的多条件查询高速获得符合过滤条件的rowkey值，拿到这些rowkey之后在HBASE中通过指定rowkey进行查询。&lt;/p&gt;&lt;figure data-tool=&quot;mdnice编辑器&quot;&gt;&lt;img class=&quot;rich_pages wxw-img&quot; data-ratio=&quot;0.6335403726708074&quot; data-src=&quot;https://mmbiz.qpic.cn/mmbiz_png/cAoClgx53Vs1Txw7dmxdKshDJdSN0icIHoUq7RSYiazGY9T6heibM4eiaib7LWkibiaicw7SZOib5swmcg8QVMvRKEbcluQ/640?wx_fmt=png&quot; data-type=&quot;png&quot; data-w=&quot;644&quot;/&gt;&lt;/figure&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;网上其它还有根据&lt;code&gt;Phoenix&lt;/code&gt;构建的，&lt;code&gt;redis&lt;/code&gt;、&lt;code&gt;mysql&lt;/code&gt;等都是可以尝试的。&lt;/p&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;strong&gt;交流群&lt;/strong&gt;&lt;/p&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;加我微信：&lt;code&gt;ddxygq&lt;/code&gt;，回复“加群”，我拉你进群。&lt;/p&gt;&lt;p&gt;&lt;img class=&quot;rich_pages wxw-img&quot; data-galleryid=&quot;&quot; data-ratio=&quot;1&quot; data-s=&quot;300,640&quot; data-src=&quot;https://mmbiz.qpic.cn/mmbiz_jpg/cAoClgx53VuOLk27mia6b6EtsxvPbMn1XHs449DCUgFg6icHRCat74PztfEwkNj43ohA1wmZibSmLaOiczwS1jIk8w/640?wx_fmt=jpeg&quot; data-type=&quot;jpeg&quot; data-w=&quot;430&quot;/&gt;&lt;/p&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;strong&gt;猜你喜欢&lt;/strong&gt;&lt;br/&gt;&lt;a href=&quot;https://mp.weixin.qq.com/s?__biz=MzU5NzAwNDQ4NQ==&amp;amp;mid=2247489298&amp;amp;idx=1&amp;amp;sn=1037230492895fb4ca9387421debc8f4&amp;amp;scene=21#wechat_redirect&quot; data-linktype=&quot;2&quot;&gt;数仓建模—指标体系&lt;/a&gt;&lt;br/&gt;&lt;a href=&quot;https://mp.weixin.qq.com/s?__biz=MzU5NzAwNDQ4NQ==&amp;amp;mid=2247488928&amp;amp;idx=1&amp;amp;sn=543614dedfe7c84425b26e5adbddbd2b&amp;amp;scene=21#wechat_redirect&quot; data-linktype=&quot;2&quot;&gt;数仓建模—宽表的设计&lt;/a&gt;&lt;br/&gt;&lt;a href=&quot;https://mp.weixin.qq.com/s?__biz=MzU5NzAwNDQ4NQ==&amp;amp;mid=2247488836&amp;amp;idx=1&amp;amp;sn=b51d8d8b4a8f67d8cab7ea4bb91691bc&amp;amp;scene=21#wechat_redirect&quot; data-linktype=&quot;2&quot;&gt;Spark SQL知识点与实战&lt;/a&gt;&lt;br/&gt;&lt;a href=&quot;https://mp.weixin.qq.com/s?__biz=MzU5NzAwNDQ4NQ==&amp;amp;mid=2247488710&amp;amp;idx=1&amp;amp;sn=db25932a3374bc87e4310a6ff4bac1aa&amp;amp;scene=21#wechat_redirect&quot; data-linktype=&quot;2&quot;&gt;Hive计算最大连续登陆天数&lt;/a&gt;&lt;br/&gt;&lt;a href=&quot;https://mp.weixin.qq.com/s?__biz=MzU5NzAwNDQ4NQ==&amp;amp;mid=2247488619&amp;amp;idx=1&amp;amp;sn=2d1ff4b7c396a752882ddf8ba28a36e1&amp;amp;scene=21#wechat_redirect&quot; data-linktype=&quot;2&quot;&gt;Flink计算pv和uv的通用方法&lt;/a&gt;&lt;/p&gt;&lt;/section&gt;&lt;/div&gt;&lt;/div&gt;</content:encoded>
</item>
<item>
<guid>b341814e414d796614c7e2eb5d12101f</guid>
<title>池式结构-连接池</title>
<link>https://toutiao.io/k/j9wq5me</link>
<content:encoded>&lt;div&gt;&lt;div&gt;&lt;div class=&quot;rich_media_content &quot; id=&quot;js_content&quot;&gt;
                    

                    
                    
                    
                    &lt;section&gt;&lt;mpvoice class=&quot;js_editor_audio audio_iframe js_uneditable custom_select_card&quot; src=&quot;/cgi-bin/readtemplate?t=tmpl/audio_tmpl&amp;amp;name=%E6%B1%A0%E5%BC%8F%E7%BB%93%E6%9E%84-%E8%BF%9E%E6%8E%A5%E6%B1%A0&amp;amp;play_length=07:55&quot; isaac2=&quot;1&quot; low_size=&quot;931.69&quot; source_size=&quot;931.7&quot; high_size=&quot;3719.23&quot; name=&quot;池式结构-连接池&quot; play_length=&quot;475000&quot; voice_encode_fileid=&quot;MzUzNjAxODg4MV8yMjQ3NDg2NDE5&quot; data-topic_id=&quot;&quot; data-topic_name=&quot;&quot; data-pluginname=&quot;insertaudio&quot; data-trans_state=&quot;1&quot; data-verify_state=&quot;3&quot;/&gt;&lt;/section&gt;&lt;p&gt;分布式协调系统如zookeeper、etcd，客户端都是使用一个长连接。记得之前使用k8s客户端(核心是etcd)时候，需要自己实现close()接口，我在close接口里判断如果连接断了，就重新连接。zookeeper的客户端实现也是大同小异。&lt;/p&gt;&lt;p&gt;&lt;/p&gt;&lt;p&gt;但是像数据库连接、MQ连接这种，更常见的实现方式是连接池。本文采用&lt;a target=&quot;_blank&quot; href=&quot;http://mp.weixin.qq.com/s?__biz=MzUzNjAxODg4MQ==&amp;amp;mid=2247484931&amp;amp;idx=1&amp;amp;sn=756db99b2fa4ce9c5e9f168d8799d692&amp;amp;chksm=fafdecadcd8a65bb81a0e153e453c2d090c48c73fc7457ccf2b7255f497c441170b651e060e5&amp;amp;scene=21#wechat_redirect&quot; textvalue=&quot;【情境型】&quot; linktype=&quot;text&quot; imgurl=&quot;&quot; imgdata=&quot;null&quot; data-itemshowtype=&quot;0&quot; tab=&quot;innerlink&quot; data-linktype=&quot;2&quot;&gt;【&lt;span&gt;情境型&lt;/span&gt;】&lt;/a&gt;逻辑结构来介绍连接池的能力和使用注意事项。&lt;/p&gt;&lt;p&gt;&lt;img class=&quot;rich_pages wxw-img&quot; data-ratio=&quot;0.7868852459016393&quot; data-src=&quot;https://mmbiz.qpic.cn/mmbiz_png/2tk5ianItRl9kk52nUUuq3vpa9ftomT4FfwSKdcAUG2TNvedyKCR4KYrjmnmnVhcFE6WbmSrWomXoKCPtMEVpKg/640?wx_fmt=png&quot; data-type=&quot;png&quot; data-w=&quot;366&quot;/&gt;&lt;/p&gt;&lt;p&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;&lt;strong&gt;能力-为什么要使用连接池&lt;/strong&gt;&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;/p&gt;&lt;p&gt;本文开头提到zookeeper和etcd客户端使用的是单一长连接，而不是连接池。咱们举两个典型场景就能明白这些大牛设计者的苦心。&lt;/p&gt;&lt;p&gt;&lt;/p&gt;&lt;p&gt;zookeeper的典型使用场景是&lt;a target=&quot;_blank&quot; href=&quot;http://mp.weixin.qq.com/s?__biz=MzUzNjAxODg4MQ==&amp;amp;mid=2247485181&amp;amp;idx=1&amp;amp;sn=df4568317a038fcff3b77cd66d0b7bb6&amp;amp;chksm=fafdec53cd8a654573d4210e755fac7c95b5145aa8a5c76cb3df64478a44da0446945ef04c19&amp;amp;scene=21#wechat_redirect&quot; textvalue=&quot;服务治理&quot; linktype=&quot;text&quot; imgurl=&quot;&quot; imgdata=&quot;null&quot; data-itemshowtype=&quot;0&quot; tab=&quot;innerlink&quot; data-linktype=&quot;2&quot;&gt;服务治理&lt;/a&gt;。比如使用dubbo这种服务治理框架，全公司的服务都在向zookeeper读写数据。如果zookeeper的客户端是开放出来的连接池，那zookeeper服务端要维持的连接数就是：全公司的服务数*连接池大小。ulimit(linux系统命令用来查询文件句柄数)数很快就不够用了。&lt;/p&gt;&lt;p&gt;&lt;/p&gt;&lt;p&gt;etcd的典型使用场景是k8s。k8s一般用来管理整个公司的服务器集群。同理，全公司的服务器都在向etcd读写数据。如果etcd的客户端是开放出来的连接池，那etcd服务端要维持的连接数就是：全公司的服务器数*连接池大小。ulimit数会更快不够用的。&lt;/p&gt;&lt;p&gt;&lt;/p&gt;&lt;p&gt;zookeeper和etcd都是主备类服务，只有一个主服务在提供写能力，不可以横向扩容。所以这种情况下，客户端连接使用连接池，那简直就是连接上的灾难。而由于处理的发布订阅数据传输本身就很小，使用连接池简直是：琉璃瓦盖鸡窝——大材小用。&lt;/p&gt;&lt;p&gt;&lt;/p&gt;&lt;p&gt;但是像数据库实例这样，使用方是固定的，很多公司的生产环境一个数据库实例是一个团队单独使用的。使用方数量固定，连接的机器几千台顶天了。而且很多业务逻辑就是CURD，面向数据库编程，传输信息量很大，就不得不使用连接池了。&lt;/p&gt;&lt;p&gt;&lt;/p&gt;&lt;p&gt;数据库连接池是个相对复杂的处理，一些开源大牛也会很容易写出来bug。下面咱们通过具体情境来了解一下数据库连接池使用的要点。&lt;/p&gt;&lt;p&gt;&lt;/p&gt;&lt;p&gt;&lt;strong&gt;&lt;span&gt;情境1-druid 1.0.29版本连接失效bug&lt;/span&gt;&lt;/strong&gt;&lt;/p&gt;&lt;p&gt;&lt;/p&gt;&lt;p&gt;&lt;img class=&quot;rich_pages wxw-img&quot; data-ratio=&quot;0.5972222222222222&quot; data-src=&quot;https://mmbiz.qpic.cn/mmbiz_jpg/2tk5ianItRlicWibX5MLouKGRLWuOaFwHczB2TAG5IBXmWf7ibAh5xnHnL7Eib5Sy50usiboAUda7HQpQaWEzNgia5qibw/640?wx_fmt=jpeg&quot; data-type=&quot;jpeg&quot; data-w=&quot;1080&quot;/&gt;&lt;/p&gt;&lt;p&gt;上图展示了客户端通过连接池连接服务器的过程。咱们平时使用druid连接池要配置很多的参数，这些参数一部分是控制伸缩性的参数：最小连接数、最大连接数等。另外一部分是探活参数，如：空闲连接触发检查阈值&lt;/p&gt;&lt;h2&gt;timeBetweenEvictionRunsMillis&lt;/h2&gt;&lt;p&gt;&lt;/p&gt;&lt;p&gt;&lt;img class=&quot;rich_pages wxw-img&quot; data-galleryid=&quot;&quot; data-ratio=&quot;0.7836990595611285&quot; data-s=&quot;300,640&quot; data-src=&quot;https://mmbiz.qpic.cn/mmbiz_png/2tk5ianItRl8m4HlBNBDxfOTL2jO8WFIhzzkWjP0bBXdM6XwldAxI2nj0vtNhOgUbZvAsh6bgLpwKD4hE70qAAQ/640?wx_fmt=png&quot; data-type=&quot;png&quot; data-w=&quot;638&quot;/&gt;&lt;/p&gt;&lt;p&gt;连接池管理的复杂，从上图可以管中窥豹-可见一斑。一个线程专门用来创建和管理连接，一个专门负责取连接。druid 1.0.29版本连接失效bug就发生在图中红框的连接是否可用部分。&lt;/p&gt;&lt;p&gt;&lt;/p&gt;&lt;pre&gt;DruidDataSource中有个检查连接是否有效的方法：&lt;/pre&gt;&lt;section class=&quot;code-snippet__fix code-snippet__js&quot;&gt;&lt;pre class=&quot;code-snippet__js&quot; data-lang=&quot;java&quot;&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;public void validateConnection(Connection conn) throws SQLException {&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;    String query = this.getValidationQuery();&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;    if (conn.isClosed()) {&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;        throw new SQLException(&quot;validateConnection: connection closed&quot;);&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;    } else if (this.validConnectionChecker != null) {&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;        boolean result = true;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;        Exception error = null;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;br/&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;        try {&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;            result = this.validConnectionChecker.isValidConnection(conn, this.validationQuery, this.validationQueryTimeout);&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;        } catch (Exception var9) {&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;            error = var9;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;        }&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;br/&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;        if (!result) {&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;            SQLException sqlError = error != null ? new SQLException(&quot;validateConnection false&quot;, error) : new SQLException(&quot;validateConnection false&quot;);&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;            throw sqlError;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;        }&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;    } else {&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;        if (null != query) {&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;            Statement stmt = null;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;            ResultSet rs = null;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;br/&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;            try {&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;                stmt = conn.createStatement();&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;                if (this.getValidationQueryTimeout() &amp;gt; 0) {&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;                    stmt.setQueryTimeout(this.getValidationQueryTimeout());&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;                }&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;br/&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;                rs = stmt.executeQuery(query);&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;                if (!rs.next()) {&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;                    throw new SQLException(&quot;validationQuery didn&#x27;t return a row&quot;);&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;                }&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;            } finally {&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;                JdbcUtils.close(rs);&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;                JdbcUtils.close(stmt);&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;            }&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;        }&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;    }&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/section&gt;&lt;p&gt;注意上面代码第6行开始有个bug，result初始为true，检查连接是否异常，抛出异常直接捕获，result还是true，意思是校验没有问题。在服务端重启等场景下，这个检查会抛出socket相关异常。实际上服务端已经断开连接了。这时不会进行连接的销毁重建。造成使用了已经断开的连接来操作数据库，导致执行失败。&lt;/p&gt;&lt;p&gt;&lt;/p&gt;&lt;p&gt;这是生产环境真实发生过的案例。这个bug是个低级错误，后续版本已经修复了。建议不要用这个有坑版本。&lt;/p&gt;&lt;p&gt;&lt;/p&gt;&lt;p&gt;另外，建议常常做业务开发、使用数据库连接池的朋友结合下面常用参数参考看几遍DruidDataSource的源码。以便更好的了解参数的使用。&lt;/p&gt;&lt;p&gt;&lt;img class=&quot;rich_pages wxw-img&quot; data-galleryid=&quot;&quot; data-ratio=&quot;0.9477611940298507&quot; data-s=&quot;300,640&quot; data-src=&quot;https://mmbiz.qpic.cn/mmbiz_png/2tk5ianItRl8m4HlBNBDxfOTL2jO8WFIhnm2lcNIxdqXGCdLZGOAibca29Z3OFPYj372Tz9icvDHzl75b0XfibdR0Q/640?wx_fmt=png&quot; data-type=&quot;png&quot; data-w=&quot;670&quot;/&gt;&lt;/p&gt;&lt;p&gt;&lt;/p&gt;&lt;p&gt;&lt;strong&gt;&lt;span&gt;情境2-ActiveMQ未使用连接池连挂服务端&lt;/span&gt;&lt;/strong&gt;&lt;/p&gt;&lt;p&gt;&lt;strong&gt;&lt;span&gt;&lt;br/&gt;&lt;/span&gt;&lt;/strong&gt;&lt;/p&gt;&lt;p&gt;activeMQ有个是否使用连接池的配置：&lt;/p&gt;&lt;p&gt;spring.activemq.pool.enabled=false&lt;/p&gt;&lt;p&gt;这里false代表不使用连接池，不使用连接池在activeMQ里表达的意思是：&lt;span&gt;每发送一条数据创建一个连接&lt;/span&gt;。于是有个同学进行了这样的配置以后，服务端出现大量的&lt;a target=&quot;_blank&quot; href=&quot;http://mp.weixin.qq.com/s?__biz=MzUzNjAxODg4MQ==&amp;amp;mid=2247486403&amp;amp;idx=1&amp;amp;sn=9dbbda3df1deeb5f43c8b7f2cdd87b97&amp;amp;chksm=fafde16dcd8a687be735bf315fa50773cd61ac48f47cd1a1304c792bc1fafa31b4a3705dd9a3&amp;amp;scene=21#wechat_redirect&quot; textvalue=&quot;time_wait&quot; linktype=&quot;text&quot; imgurl=&quot;&quot; imgdata=&quot;null&quot; data-itemshowtype=&quot;0&quot; tab=&quot;innerlink&quot; data-linktype=&quot;2&quot;&gt;time_wait&lt;/a&gt;。time_wait表示服务端和客户端已经在进行四次挥手断开连接中了。&lt;/p&gt;&lt;p&gt;&lt;/p&gt;&lt;p&gt;keepalive探活会探测到连接不可用就会进行这个断开连接操作。断连操作有一步很耗时，就是time_wait，因为它有2MSL的等待时间。很多连接的最终释放都卡在这里了。&lt;/p&gt;&lt;p&gt;&lt;img class=&quot;rich_pages wxw-img&quot; data-ratio=&quot;0.6627027027027027&quot; data-src=&quot;https://mmbiz.qpic.cn/mmbiz_jpg/2tk5ianItRl9mx4E8rZzxHXAlN9gOAiaRzzcCYIdWKDIUzUUswb9yHJY5c8Z8FKjSEFGkFjtZ7V7DMXhX3dlgndg/640?wx_fmt=jpeg&quot; data-type=&quot;jpeg&quot; data-w=&quot;925&quot;/&gt;&lt;/p&gt;&lt;p&gt;&lt;/p&gt;&lt;p&gt;老连接不释放，服务器资源一直占用。新连接建立就会失败，表现出来就是服务器挂了。连接参数配置需谨慎：&lt;/p&gt;&lt;section class=&quot;code-snippet__fix code-snippet__js&quot;&gt;&lt;pre class=&quot;code-snippet__js&quot; data-lang=&quot;bash&quot;&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;#true表示使用连接池&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;spring.activemq.pool.enabled=true&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;#连接池最大连接数&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;spring.activemq.pool.max-connections=5&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;#空闲的连接过期时间，默认为30秒&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;spring.activemq.pool.idle-timeout=30000&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;#强制的连接过期时间，与idleTimeout的区别在于：idleTimeout是在连接空闲一段时间失效，而expiryTimeout不管当前连接的情况，只要达到指定时间就失效。默认为0，never &lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;spring.activemq.pool.expiry-timeout=0&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/section&gt;&lt;p&gt;&lt;/p&gt;&lt;p&gt;&lt;strong&gt;&lt;span&gt;MSL解释&lt;/span&gt;&lt;/strong&gt;&lt;/p&gt;&lt;p&gt;&lt;/p&gt;&lt;p&gt;最后解释一下time_wait的2MSL。MSL是什么：&lt;/p&gt;&lt;p&gt;MSL是Maximum Segment Lifetime英文的缩写，中文可以译为“报文最大生存时间”，它是任何报文在网络上存在的最长时间，超过这个时间报文将被丢弃。因为tcp报文（segment）是ip数据报（datagram）的数据部分，而ip头中有一个TTL域，TTL是time to live的缩写，中文可以译为“生存时间”，这个生存时间是由源主机设置初始值但不是存的具体时间，而是存储了一个ip数据报可以经过的最大路由数，每经过一个处理他的路由器此值就减1，当此值为0则数据报将被丢弃，同时发送ICMP报文通知源主机。RFC 793中规定MSL为2分钟，实际应用中常用的是30秒，1分钟和2分钟等。&lt;/p&gt;&lt;p&gt;&lt;/p&gt;&lt;p&gt;    TCP的TIME_WAIT状态也称为2MSL等待状态，当TCP的一端发起主动关闭，在发出最后一个ACK包后，即发送了第四次挥手的ACK包后就进入了TIME_WAIT状态，必须在此状态上停留两倍的MSL时间，等待2MSL时间主要目的是怕最后一个ACK包对方没收到，那么对方在超时后将重发第三次挥手的FIN包，主动关闭端接到重发的FIN包后可以再发一个ACK应答包。在TIME_WAIT状态时两端的端口不能使用，要等到2MSL时间结束才可继续使用。当连接处于2MSL等待阶段时任何迟到的报文段都将被丢弃。不过在实际应用中可以通过设置SO_REUSEADDR选项达到不必等待2MSL时间结束再使用此端口。&lt;/p&gt;&lt;p&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;参考文章：&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;https://blog.csdn.net/xiaofei0859/article/details/6044694&lt;/span&gt;&lt;/p&gt;
                &lt;/div&gt;

                

                



                
                &lt;/div&gt;&lt;/div&gt;</content:encoded>
</item>
</channel></rss>